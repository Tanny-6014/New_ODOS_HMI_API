name: Deploy ODOS Microservices to Windows Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, SAPHMIAPI]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Detect changed microservices
        id: detect
        run: |
          echo "Changed folders:"
          git diff --name-only HEAD~1 HEAD > changed_files.txt

          $microservices = @(
              "AdminService",
              "CABService",
              "CommonServices",
              "DetailingService",
              "DrainService",
              "InventoryService",
              "MasterDataService",
              "OrderService",
              "ParameterSetService",
              "ProductCodeMasterService",
              "ShapeCodeService",
              "UtilityService",
              "WBSService",
              "SAP_API"
          )
          $changed = @()

          foreach ($svc in $microservices) {
            if (Select-String -Path changed_files.txt -Pattern "Microservices/$svc/") {
              Write-Host "$svc has changes"
              $changed += $svc
            }
          }

          $changedList = $changed -join ","
          echo "changed_services=$changedList" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Build & Publish changed services
        if: steps.detect.outputs.changed_services != ''
        run: |
          $services = "${{ steps.detect.outputs.changed_services }}".Split(",")

          foreach ($svc in $services) {

          if ($svc -eq "SAP_API") {
              Write-Host "Running SAP_API build..."
             echo "Running SAP_API build..."
            dotnet restore "Microservices/$svc/$svc/$svc.csproj"
            dotnet build "Microservices/$svc/$svc/$svc.csproj" --configuration Release --no-restore
            dotnet publish "Microservices/$svc/$svc/$svc.csproj" -c Release -o "./publish/$svc"
          }
          else {
               echo "Running default build for $svc ..."
            dotnet restore "Microservices/$svc/$svc.csproj" 
            dotnet build "Microservices/$svc/$svc.csproj" --configuration Release --no-restore
            dotnet publish "Microservices/$svc/$svc.csproj" -c Release -o "./publish/$svc"
          }
           
          
          }
        shell: powershell

      - name: Deploy to IIS (per service)
        if: steps.detect.outputs.changed_services != ''
        run: |
          $services = "${{ steps.detect.outputs.changed_services }}".Split(",")

          # Mapping of services to IIS site names and destination paths
          $serviceMap = @{
            "AdminService"              = @{ iis = "ODOS_Admin";             path = "C:\inetpub\wwwroot\ODOSMicroServices\AdminService" }
            "CABService"                = @{ iis = "ODOS_CAB";               path = "C:\inetpub\wwwroot\ODOSMicroServices\CABService" }
            "CommonServices"           = @{ iis = "ODOS_CommonService";            path = "C:\inetpub\wwwroot\ODOSMicroServices\CommonMicroService" }
            "DetailingService"         = @{ iis = "ODOS_DetailingService";         path = "C:\inetpub\wwwroot\ODOSMicroServices\DetailingService" }
            "DrainService"             = @{ iis = "ODOS_DrainService";             path = "C:\inetpub\wwwroot\ODOSMicroServices\DrainService" }
            "MasterDataService"        = @{ iis = "ODOS_MasterDataService";        path = "C:\inetpub\wwwroot\ODOSMicroServices\MasterDataService" }
            "OrderService"             = @{ iis = "ODOS_OrderService";             path = "C:\inetpub\wwwroot\ODOSMicroServices\OrderService" }
            "ParameterSetService"      = @{ iis = "ODOS_ParameterSetService";      path = "C:\inetpub\wwwroot\ODOSMicroServices\ParameterSetService" }
            "ProductCodeMasterService" = @{ iis = "ODOS_ProductCodeService"; path = "C:\inetpub\wwwroot\ODOSMicroServices\ProductCodeMicroService" }
            "ShapeCodeService"         = @{ iis = "ODOS_ShapeService";         path = "C:\inetpub\wwwroot\ODOSMicroServices\ShapeMicroService" }
            "UtilityService"           = @{ iis = "ODOS_UtilityService";           path = "C:\inetpub\wwwroot\ODOSMicroServices\UtilityService" }
            "WBSService"               = @{ iis = "ODOS_WBSService";               path = "C:\inetpub\wwwroot\ODOSMicroServices\WBSMicroService" }
            "SAP_API"               = @{ iis = "ODOS_SAP_API";                     path = "C:\inetpub\wwwroot\SAP_API" }

          }

         
          Import-Module WebAdministration

          foreach ($svc in $services) {
            if ($serviceMap.ContainsKey($svc)) {
              $iisName = $serviceMap[$svc].iis
              $backupRoot = "D:\IIS_Backups\ODOS_API_Backup\$iisName"
              $destination = $serviceMap[$svc].path
              $source = "${{ github.workspace }}\publish\$svc"
              $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
              $backupFolder = Join-Path $backupRoot "$iisName-Backup_$timestamp"

              Write-Host "`n======== Deploying: $svc ========"
              Write-Host "IIS Site: $iisName"
              Write-Host "Source: $source"
              Write-Host "Destination: $destination"

              # Stop IIS
              Write-Host "Stopping IIS site and app pool"
              # Stop-Website -Name $iisName -ErrorAction SilentlyContinue
              # Stop-WebAppPool -Name $iisName -ErrorAction SilentlyContinue
              
              # Stop App Pool if it's running
              if ((Get-WebAppPoolState -Name $iisName).Value -ne "Stopped") {
                  Stop-WebAppPool -Name $iisName
              }

              # Stop Site if it's running
              if ((Get-Website -Name $iisName).State -ne "Stopped") {
                  Stop-Website -Name $iisName
              }
              Start-Sleep -Seconds 5

              # Ensure destination exists
              if (-not (Test-Path $destination)) {
                New-Item -ItemType Directory -Path $destination -Force | Out-Null
              }

              # Backup existing files
              Write-Host "Backing up existing files to $backupFolder"
              New-Item -ItemType Directory -Path $backupFolder -Force | Out-Null
              Copy-Item -Path "$destination\*" -Destination $backupFolder -Recurse -Force

              # Replace files (without deleting destination)
              Write-Host "Copying files from $source to $destination"
              Copy-Item "$source\*" "$destination" -Recurse -Force

              # Start IIS
              Write-Host "Starting IIS site and app pool"
              Start-WebAppPool -Name $iisName
              Start-Website -Name $iisName
            } else {
              Write-Host "Service mapping not found for: $svc"
            }
          }
        shell: powershell
