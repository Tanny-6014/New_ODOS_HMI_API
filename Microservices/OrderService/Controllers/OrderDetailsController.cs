using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Linq;
using System.Web;

//using AntiForgeryHeader.Helper;
using Microsoft.AspNet.Identity;

using System.IO;
using OrderService.Repositories;
using System.Globalization;
using System.Data.SqlClient;

using System.Text;
using System.Text.RegularExpressions;
using Oracle.ManagedDataAccess.Client;

//using OfficeOpenXml.Drawing;
//using OfficeOpenXml.Table;
using System.Threading.Tasks;
using OrderService.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using System.Net.Http.Headers;
using OfficeOpenXml.Style;
using iTextSharp.text.pdf;
using iTextSharp.text;
using OfficeOpenXml;
using OfficeOpenXml.Drawing;
using OrderService.Dtos;
using NCalc;
using System.Net;
using System.Web.Helpers;
using Microsoft.AspNetCore.Http;
using Amazon.Runtime;
using System.Drawing;
using System.IO;
using OfficeOpenXml;
using MongoDB.Driver.Core.Configuration;
using Microsoft.ProjectServer.Client;

namespace OrderService.Controllers
{
    //[Authorize]
    public class OrderDetailsController : Controller
    {
        public string gUserType = "";
        public string gGroupName = "";


        struct struOrderList
        {
            public string OrderNo;
            public string OrderDesc;
        };

        private DBContextModels db = new DBContextModels();

        //[ValidateAntiForgeryToken]
        //public ActionResult Index(string appCustomerCode, string appProjectCode, int appSelectedCount,
        //string appSelectedSE, string appSelectedProd, string appSelectedPostID, string appSelectedScheduled,
        //string appSelectedWBS1, string appSelectedWBS2, string appSelectedWBS3,
        //string appSelectedWT, string appSelectedQty,
        //string appWBS1S, string appWBS2S, string appWBS3S, string appOrderNoS,
        //string appStructureElement, string appProductType, string appScheduledProd, int appPostID,
        //string appOrderNo, string appWBS1, string appWBS2, string appWBS3)
        //{
        //    UserAccessController lUa = new UserAccessController();
        //    var lUserType = lUa.getUserType(User.Identity.GetUserName());
        //    var lGroupName = lUa.getGroupName(User.Identity.GetUserName());

        //    ViewBag.UserType = lUserType;

        //    string lUserName = User.Identity.GetUserName();

        //    //if (lUserName.IndexOf("@") > 0)
        //    //{
        //    //    lUserName = lUserName.Substring(0, lUserName.IndexOf("@"));
        //    //}

        //    ViewBag.UserName = lUserName;

        //    lUa = null;

        //    var lStransportMode = "";

        //    CustomerModels lCustomerModel = db.Customer.Find(appCustomerCode);

        //    ViewBag.CustomerSelection = new SelectList(new List<SelectListItem>
        //    { new SelectListItem
        //    {
        //        Value = appCustomerCode,
        //        Text = lCustomerModel == null? "":lCustomerModel.CustomerName
        //    }
        //    }, "Value", "Text");

        //    var lProjectModel = (from p in db.ProjectList
        //                         where p.ProjectCode == appProjectCode
        //                         select p).First();

        //    ViewBag.ProjectSelection = new SelectList(new List<SelectListItem>
        //    { new SelectListItem
        //    {
        //        Value = appProjectCode,
        //        Text = lProjectModel == null? "":lProjectModel.ProjectTitle
        //    }
        //    }, "Value", "Text");

        //    int lJobID = 0;
        //    string lOrderStatus = "New";
        //    string lPONumber = "";

        //    int lOrderNoT = 0;
        //    int.TryParse(appOrderNo, out lOrderNoT);

        //    var lSE = db.OrderProjectSE.Find(lOrderNoT, appStructureElement, appProductType, appScheduledProd);
        //    if (lSE != null)
        //    {
        //        lJobID = lSE.CABJobID;
        //        lOrderStatus = lSE.OrderStatus;
        //        lPONumber = lSE.PONumber;
        //        lStransportMode = lSE.TransportMode;
        //    }

        //    var lJobAdv = db.JobAdvice.Find(appCustomerCode, appProjectCode, lJobID);

        //    var lMain = db.OrderProject.Find(lOrderNoT);

        //    if (lOrderStatus == null || lOrderStatus == "Reserved")
        //    {
        //        lOrderStatus = "New";
        //    }

        //    if (lUserName.Split('@').Length == 2)
        //    {
        //        if (lOrderStatus == "Created*" && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
        //        {
        //            lOrderStatus = "Created";
        //        }
        //    }

        //    ViewBag.PONumber = lPONumber;
        //    ViewBag.StructureEle = appStructureElement;
        //    ViewBag.OrderNumber = lOrderNoT;
        //    ViewBag.JobID = lJobID;

        //    ViewBag.OrderStatus = lOrderStatus;

        //    ViewBag.SelectedCount = appSelectedCount;
        //    ViewBag.SelectedSE = appSelectedSE.Split(',');
        //    ViewBag.SelectedProd = appSelectedProd.Split(',');
        //    ViewBag.SelectedPostID = appSelectedPostID.Split(',');
        //    ViewBag.SelectedScheduled = appSelectedScheduled.Split(',');

        //    ViewBag.SelectedWT = appSelectedWT == null ? new string[] { } : appSelectedWT.Split(',');
        //    ViewBag.SelectedQty = appSelectedQty == null ? new string[] { } : appSelectedQty.Split(',');

        //    ViewBag.SelectedWBS1 = appSelectedWBS1.Split(',');
        //    ViewBag.SelectedWBS2 = appSelectedWBS2.Split(',');
        //    ViewBag.SelectedWBS3 = appSelectedWBS3.Split(',');

        //    ViewBag.WBS1 = appWBS1S.Split(',');
        //    ViewBag.WBS2 = appWBS2S.Split(',');
        //    ViewBag.WBS3 = appWBS3S.Split(',');

        //    ViewBag.WBS1T = appWBS1;
        //    ViewBag.WBS2T = appWBS2;
        //    ViewBag.WBS3T = appWBS3;
        //    ViewBag.OrderNo = appOrderNoS.Split(',');

        //    ViewBag.StandbyOrder = appScheduledProd;
        //    ViewBag.PostID = appPostID;

        //    ViewBag.TransportMode = lStransportMode;

        //    var lSubmission = "No";
        //    var lEditable = "No";

        //    //get Access right;
        //    if (lUserType == "CU" || lUserType == "CA" || lUserType == "CM")
        //    {
        //        var lAccess = db.UserAccess.Find(User.Identity.Name, appCustomerCode, appProjectCode);
        //        if (lAccess != null)
        //        {
        //            lSubmission = lAccess.OrderSubmission.Trim();
        //            lEditable = lAccess.OrderCreation.Trim();
        //        }
        //    }
        //    else
        //    {
        //        if (lUserType == "TE" || lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU")
        //        {
        //            lSubmission = "Yes";
        //            lEditable = "Yes";
        //        }
        //    }

        //    ViewBag.Submission = lSubmission;
        //    ViewBag.Editable = lEditable;

        //    ViewBag.AlertMessage = new List<string>();
        //    //var lSharedPrg = new SharedAPIController();
        //    //ViewBag.AlertMessage = lSharedPrg.getAlertMessage(appCustomerCode, appProjectCode, lUserName, lSubmission, lEditable);
        //    //lSharedPrg = null;


        //    return View();
        //}

        //// GET: Customer
        //[Route("Index")]
        //[HttpGet]
        //public ActionResult Index_old()
        //{
        //    UserAccessController lUa = new UserAccessController();
        //    var lUserType = lUa.getUserType(User.Identity.GetUserName());
        //    var lGroupName = lUa.getGroupName(User.Identity.GetUserName());
        //    gUserType = lUserType;
        //    gGroupName = lGroupName;

        //    ViewBag.UserType = lUserType;
        //    lUa = null;

        //    List<ProjectListModels> content = new List<ProjectListModels> {
        //        new ProjectListModels
        //        {
        //            CustomerCode = "",
        //            ProjectCode = "",
        //            ProjectTitle = ""
        //        } };

        //    if (lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU" || lUserType == "TE")
        //    {
        //        var content1 = (from p in db.Customer
        //                        where !p.CustomerName.StartsWith("(D)") &&
        //                        !p.CustomerName.Contains("DONOT USE") &&
        //                        !p.CustomerName.Contains("DONT USE") &&
        //                        !p.CustomerName.StartsWith("-CANCEL-") &&
        //                        !p.CustomerCode.Trim().Equals("") &&
        //                        !p.CustomerName.Trim().Equals("") &&
        //                        !p.CustomerName.Trim().Equals(".")
        //                        orderby p.CustomerName
        //                        select p
        //                       ).ToList();
        //        content1.Insert(0, new CustomerModels
        //        {
        //            CustomerCode = "",
        //            CustomerName = ""
        //        });

        //        ViewBag.CustomerSelection = new SelectList(new List<SelectListItem>(content1.Select(h => new SelectListItem
        //        {
        //            Value = h.CustomerCode.Trim(),
        //            Text = h.CustomerName.Trim() + (h.CustomerCode.Trim() == "" ? "" : (" (" + h.CustomerCode.Trim() + ")"))
        //        })), "Value", "Text");


        //        //var content1 = (from c in db.Customer
        //        //                where (from m in db.Project select m.CustomerCode).Contains(c.CustomerCode)
        //        //                orderby c.CustomerName
        //        //                select c).ToList();

        //        //ViewBag.CustomerSelection = new SelectList(new List<SelectListItem>(content1.Select(h => new SelectListItem
        //        //{
        //        //    Value = h.CustomerCode,
        //        //    //Text = h.CustomerName + "(" + h.CustomerCode + ")"
        //        //    Text = h.CustomerName
        //        //})), "Value", "Text");

        //        //if (content1.Count() > 0)
        //        //{
        //        //    var lCustomerCode = content1.First().CustomerCode;
        //        //    content = (from p in db.ProjectList
        //        //               where p.CustomerCode == lCustomerCode &&
        //        //               (from m in db.Project
        //        //                where m.CustomerCode == lCustomerCode
        //        //                select m.ProjectCode).Contains(p.ProjectCode)
        //        //               orderby p.ProjectTitle
        //        //               select p).ToList();
        //        //    content = content.OrderBy(o => o.ProjectTitle).ToList();

        //        //    if (content.Count() > 0)
        //        //    {
        //        //        content = RemoveNonCABProject(content);
        //        //    }
        //        //}


        //        if (content.Count() == 0)
        //        {
        //            content = new List<ProjectListModels> {
        //                new ProjectListModels
        //                {
        //                    CustomerCode = "",
        //                    ProjectCode = "",
        //                    ProjectTitle = ""
        //                }
        //            };
        //        }

        //        ViewBag.ProjectSelection = new SelectList(new List<SelectListItem>(content.Select(h => new SelectListItem
        //        {
        //            Value = h.ProjectCode.Trim(),
        //            //Text = h.ProjectTitle + "(" + h.ProjectCode + ")"
        //            Text = h.ProjectTitle.Trim()
        //        })), "Value", "Text");
        //    }
        //    else
        //    {
        //        var content2 = (from p in db.Customer
        //                        where (from u in db.UserAccess
        //                               where u.UserName == lGroupName &&
        //                               p.CustomerCode != "0000000000"
        //                               select u.CustomerCode).Contains(p.CustomerCode)
        //                        orderby p.CustomerName
        //                        select p).ToList();

        //        var content3 = new List<CustomerModels>(content2.Select(h => new CustomerModels
        //        {
        //            CustomerCode = h.CustomerCode.Trim(),
        //            CustomerName = h.CustomerName.Trim()
        //        }));

        //        content3 = content3.GroupBy(o => o.CustomerCode).Select(x => x.First()).ToList();

        //        ViewBag.CustomerSelection = new SelectList(new List<SelectListItem>(content3.Select(h => new SelectListItem
        //        {
        //            Value = h.CustomerCode,
        //            Text = h.CustomerName
        //        })), "Value", "Text");

        //        if (content2.Count() > 0)
        //        {
        //            var lCustomerCode = content2.First().CustomerCode.Substring(0, 10);

        //            content = (from p in db.ProjectList
        //                       where p.CustomerCode == lCustomerCode &&
        //                       (from u in db.UserAccess
        //                        where u.UserName == lGroupName &&
        //                        p.CustomerCode == lCustomerCode
        //                        select u.ProjectCode).Contains(p.ProjectCode)
        //                       orderby p.ProjectTitle
        //                       select p).ToList();

        //            if (content.Count() > 0)
        //            {
        //               // content = RemoveNonCABProject(content);
        //            }
        //        }

        //        if (content.Count() == 0)
        //        {
        //            content = new List<ProjectListModels> {
        //                new ProjectListModels
        //                {
        //                    CustomerCode = "",
        //                    ProjectCode = "",
        //                    ProjectTitle = ""
        //                }
        //            };
        //        }

        //        ViewBag.ProjectSelection = new SelectList(new List<SelectListItem>(content.Select(h => new SelectListItem
        //        {
        //            Value = h.ProjectCode,
        //            Text = h.ProjectTitle
        //        })), "Value", "Text");

        //    }

        //    string lCustomerCodeD = "";
        //    //var lCustomerCK = Request.Cookies["nsh_digios_cust"];
        //    //if (lCustomerCK != null)
        //    //{
        //    //    lCustomerCodeD = lCustomerCK.Value.ToString();
        //    //}
        //    //ViewBag.CustomerCodeCK = lCustomerCodeD;

        //    string lProjectCodeD = "";
        //    //var lProjectCK = Request.Cookies["nsh_digios_proj"];
        //    //if (lProjectCK != null)
        //    //{
        //    //    lProjectCodeD = lProjectCK.Value.ToString();
        //    //}
        //    //ViewBag.ProjectCodeCK = lProjectCodeD;

        //    return View(content.First());
        //}

        //get Pin Size Master from DB
        [HttpGet]
        [Route("/getPinMaster/{pinStandard}")]
        public ActionResult getPinMaster(string pinStandard)
        {
            var lReturn = new List<PinModels>();
            if (pinStandard == null || pinStandard.Trim() == "" || pinStandard.Trim() == "BS-8666")
            {
                lReturn = db.PinMaster.ToList();
            }
            else
            {
                lReturn = (from p in db.PinAdd
                           where p.std_code == pinStandard
                           orderby p.grade, p.type, p.dia
                           select new
                           {
                               grade = p.grade,
                               type = p.type,
                               dia = p.dia,
                               pin = p.pin,
                               bend_len_min = p.bend_len_min,
                               hook_len_min = p.hook_len_min,
                               hook_height_min = p.hook_height_min
                           }).ToList().Select(x => new PinModels
                           {
                               grade = x.grade,
                               type = x.type,
                               dia = x.dia,
                               pin = x.pin,
                               bend_len_min = x.bend_len_min,
                               hook_len_min = x.hook_len_min,
                               hook_height_min = x.hook_height_min
                           }).ToList();

            }

            return Ok(lReturn);

        }

        //get Coupler
        [HttpGet]
        [Route("/getCouplerType/{CustomerCode}/{ProjectCode}")]
        public ActionResult getCouplerType(string CustomerCode, string ProjectCode)
        {
            var lReturn = new List<string>();

            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            if (CustomerCode != null && ProjectCode != null)
            {
                if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
                {
                    lCmd.CommandText =
                    "SELECT isNull(EspliceN,0), isNull(EspliceS,0), isNull(Nsplice,0) " +
                    "from dbo.OESProject " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' ";

                    var lProcessObj = new ProcessController();
                    if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                    {
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lReturn = new List<string>();

                                lReturn.Add("No Coupler");

                                //if (lRst.GetBoolean(0) == true)
                                //{
                                //    lReturn.Add("E-Splice(N)");
                                //}
                                if (lRst.GetBoolean(1) == true)
                                {
                                    lReturn.Add("E-Splice(S)");
                                }
                                if (lRst.GetBoolean(2) == true)
                                {
                                    lReturn.Add("N-Splice");
                                }

                                //if (lReturn.Count == 0)
                                //{
                                //    lReturn.Add("No Coupler");
                                //}
                            }
                        }
                        lRst.Close();

                        lProcessObj.CloseNDSConnection(ref lNDSCon);
                    }
                    lProcessObj = null;
                }
            }
            lCmd = null;
            lNDSCon = null;
            lRst = null;

            //very slow get the coupler type from ESB
            //lReturn = getCouplerTypeFromESB(CustomerCode, ProjectCode);

            //slow response change to local
            //lReturn = getCouplerTypeFromSAP(CustomerCode, ProjectCode);
            return Ok(lReturn);
        }

        List<string> getCouplerTypeFromOES(string CustomerCode, string ProjectCode)
        {
            var lReturn = new List<string>();

            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            if (CustomerCode != null && ProjectCode != null)
            {
                if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
                {
                    lCmd.CommandText =
                    "SELECT isNull(EspliceN,0), isNull(EspliceS,0), isNull(Nsplice,0) " +
                    "from dbo.OESProject " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' ";

                    var lProcessObj = new ProcessController();
                    if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                    {
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lReturn = new List<string>();

                                lReturn.Add("No Coupler");

                                //if (lRst.GetBoolean(0) == true)
                                //{
                                //    lReturn.Add("E-Splice(N)");
                                //}
                                if (lRst.GetBoolean(1) == true)
                                {
                                    lReturn.Add("E-Splice(S)");
                                }
                                if (lRst.GetBoolean(2) == true)
                                {
                                    lReturn.Add("N-Splice");
                                }
                                //if (lReturn.Count == 0)
                                //{
                                //    lReturn.Add("No Coupler");
                                //}
                            }
                        }
                        lRst.Close();

                        lProcessObj.CloseNDSConnection(ref lNDSCon);
                    }
                    lProcessObj = null;
                }
            }
            lCmd = null;
            lNDSCon = null;
            lRst = null;

            return lReturn;
        }

        [HttpGet]
        [Route("/getCouplerTypeFromSAP/{CustomerCode}/{ProjectCode}")]
        public List<string> getCouplerTypeFromSAP(string CustomerCode, string ProjectCode)
        {
            var lReturn = new List<string>();

            GetContractlistDto getContractlistDto = new GetContractlistDto();
            getContractlistDto.CustomerCode = CustomerCode;
            getContractlistDto.ProjectCode = ProjectCode;
            getContractlistDto.ProdType = "Rebar";
            getContractlistDto.ProdTypeL2 = "CAB";
            getContractlistDto.OrderNumber = 0;
            getContractlistDto.StructureElement = "Beam";

            var lProcessObj = new ProcessController();
            List<string> lContracts = lProcessObj.getContractList(getContractlistDto);

            if (lContracts.Count == 0)
            {
                lReturn.Add("No Coupler");
            }
            else
            {
                getCouplerTypeFrSAP lSAPCouTyp = new getCouplerTypeFrSAP();

                for (int i = 0; i < lContracts.Count; i++)
                {
                    //var lCouplerType = lSAPCouTyp.getCouplerType(lContracts[i].Substring(0, 10));
                    var lCouplerType = getCouplerTypeHMI(lContracts[i].Substring(0, 10)); 
                    if (lCouplerType != null)
                    {
                        if (lCouplerType.Count > 0)
                        {
                            for (int j = 0; j < lCouplerType.Count; j++)
                            {
                                var lCoupler = "";
                                if (lCouplerType[j].Trim() == "ESPLICE(S)")
                                {
                                    lCoupler = "E-Splice(S)";
                                }
                                //if (lCouplerType[j].Trim() == "ESPLICE(N)")
                                //{
                                //    lCoupler = "E-Splice(N)";
                                //}
                                if (lCouplerType[j].Trim() == "NSPLICE")
                                {
                                    lCoupler = "N-Splice";
                                }
                                if (lCoupler != "")
                                {
                                    var lFound = 0;
                                    if (lReturn.Count > 0)
                                    {
                                        for (int k = 0; k < lReturn.Count; k++)
                                        {
                                            if (lReturn[k] == lCoupler)
                                            {
                                                lFound = 1;
                                            }
                                        }
                                    }
                                    if (lFound == 0)
                                    {
                                        lReturn.Add(lCoupler);
                                    }
                                }
                            }
                        }
                    }
                }

                lSAPCouTyp = null;

                if (lReturn.Count == 0)
                {
                    lReturn.Add("No Coupler");
                }

            }

            lProcessObj = null;

            return lReturn;
        }

        //public List<string> getCouplerTypeFromESB(string CustomerCode, string ProjectCode)
        //{
        //    var lReturn = new List<string>();


        //    var lProcessObj = new ProcessController();
        //    List<string> lContracts = lProcessObj.getContractList(CustomerCode, ProjectCode, "Rebar", "Rebar");

        //    if (lContracts.Count == 0)
        //    {
        //        lReturn.Add("No Coupler");
        //    }
        //    else
        //    {
        //        var lCouplerUserID = "MESSoapUser";
        //        var lCouplerPwd = "MESUser123";

        //        var lCouplerService = new CouplerType.NSH_OTS_SAP_SORwebServicesgetCouplerType();
        //        var lCredCashe = new System.Net.CredentialCache();
        //        lCredCashe.Add(new Uri(lCouplerService.Url), "BASIC", new System.Net.NetworkCredential(lCouplerUserID, lCouplerPwd));

        //        lCouplerService.PreAuthenticate = true;
        //        lCouplerService.Credentials = lCredCashe;

        //        for (int i = 0; i < lContracts.Count; i++)
        //        {
        //            var lCouplerType = lCouplerService.getCouplerTypeFromSAP(lContracts[i].Substring(0, 10));
        //            if (lCouplerType != null)
        //            {
        //                if (lCouplerType.Length > 0)
        //                {
        //                    for (int j = 0; j < lCouplerType.Length; j++)
        //                    {
        //                        var lCoupler = "";
        //                        if (lCouplerType[j].Trim() == "ESPLICE(S)")
        //                        {
        //                            lCoupler = "E-Splice(S)";
        //                        }
        //                        if (lCouplerType[j].Trim() == "ESPLICE(N)")
        //                        {
        //                            lCoupler = "E-Splice(N)";
        //                        }
        //                        if (lCouplerType[j].Trim() == "NSPLICE")
        //                        {
        //                            lCoupler = "N-Splice";
        //                        }
        //                        if (lCoupler != "")
        //                        {
        //                            var lFound = 0;
        //                            if (lReturn.Count > 0)
        //                            {
        //                                for (int k = 0; k < lReturn.Count; k++)
        //                                {
        //                                    if (lReturn[k] == lCoupler)
        //                                    {
        //                                        lFound = 1;
        //                                    }
        //                                }
        //                            }
        //                            if (lFound == 0)
        //                            {
        //                                lReturn.Add(lCoupler);
        //                            }
        //                        }
        //                    }
        //                }
        //            }
        //        }
        //        lCouplerService.Dispose();
        //        lCouplerService = null;
        //        lCredCashe = null;

        //        if (lReturn.Count == 0)
        //        {
        //            lReturn.Add("No Coupler");
        //        }

        //    }

        //    return lReturn;
        //}

        //[HttpPost]
        //[ValidateAntiForgeryHeader]
        //public ActionResult uploadPODocs()
        //{
        //    var lReturn = new CTSMESHPODocsFileModels();

        //    try
        //    {
        //        var lCustomerCode = Request.Form.Get("CustomerCode");
        //        var lProjectCode = Request.Form.Get("ProjectCode");
        //        int lJobID = 0;
        //        int lDocID = 0;
        //        int.TryParse(Request.Form.Get("JobID"), out lJobID);

        //        if (Request.Files.Count > 0)
        //        {
        //            HttpFileCollectionBase files = Request.Files;
        //            for (int i = 0; i < files.Count; i++)
        //            {
        //                HttpPostedFileBase file = files[i];

        //                var lFileName = file.FileName;
        //                if (lFileName.LastIndexOf("\\") >= 0)
        //                {
        //                    lFileName = lFileName.Substring(lFileName.LastIndexOf("\\") + 1);
        //                }
        //                if (lFileName.LastIndexOf("/") >= 0)
        //                {
        //                    lFileName = lFileName.Substring(lFileName.LastIndexOf("/") + 1);
        //                }

        //                byte[] pdfBytes = null;
        //                BinaryReader reader = new BinaryReader(file.InputStream);
        //                pdfBytes = reader.ReadBytes((int)file.ContentLength);

        //                lDocID = (from p in db.PODoc
        //                          where p.CustomerCode == lCustomerCode &&
        //                          p.ProjectCode == lProjectCode &&
        //                          p.JobID == lJobID
        //                          select p.PODocID).DefaultIfEmpty(0).Max();
        //                lDocID = lDocID + 1;

        //                var Content = new PODocsModels
        //                {
        //                    CustomerCode = lCustomerCode,
        //                    ProjectCode = lProjectCode,
        //                    JobID = lJobID,
        //                    PODocID = lDocID,
        //                    FileName = lFileName,
        //                    UpdatedDate = DateTime.Now,
        //                    UpdatedBy = User.Identity.Name,
        //                    PODoc = pdfBytes
        //                };
        //                db.PODoc.Add(Content);
        //                db.SaveChanges();

        //                var lPODocExists = db.PODoc.Where(
        //                                      p => p.CustomerCode == lCustomerCode &&
        //                                      p.ProjectCode == lProjectCode &&
        //                                      p.JobID == lJobID).Count();

        //                lReturn = new CTSMESHPODocsFileModels
        //                {
        //                    PODocID = lDocID,
        //                    FileName = lFileName,
        //                    UpdatedDate = DateTime.Now.ToString("yyyy-mm-dd hh:mm:ss"),
        //                    UpdatedBy = User.Identity.Name,
        //                    FileSize = (pdfBytes.Length / 1000).ToString(),
        //                    Exists = lPODocExists
        //                };
        //            }
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
        //    }
        //    return Ok(lReturn);
        //}

        //download PO doc 
        //[HttpPost]
        //[ValidateAntiForgeryHeader]
        //public ActionResult deletePODocs(string CustomerCode, string ProjectCode, int JobID, int PODocID)
        //{
        //    var lReturn = true;
        //    var lCmd = new SqlCommand();
        //    var lNDSCon = new SqlConnection();

        //    if (CustomerCode != null && ProjectCode != null)
        //    {
        //        if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //        {
        //            lCmd.CommandText =
        //            "DELETE FROM dbo.OESPODoc " +
        //            "WHERE CustomerCode = '" + CustomerCode + "' " +
        //            "AND ProjectCode = '" + ProjectCode + "' " +
        //            "AND JobID = " + JobID + " " +
        //            "AND PODocID = " + PODocID + " ";

        //            var lProcessObj = new ProcessController();
        //            try
        //            {
        //                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                {
        //                    lCmd.Connection = lNDSCon;
        //                    lCmd.CommandTimeout = 300;
        //                    lCmd.ExecuteNonQuery();

        //                    lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                }
        //            }
        //            catch (Exception ex)
        //            {
        //                ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
        //                lReturn = false;
        //            }
        //            lProcessObj = null;
        //        }
        //    }
        //    lCmd = null;
        //    lNDSCon = null;
        //    return Ok(lReturn);
        //}

        //download PO doc 
        //[HttpPost]
        //[ValidateAntiForgeryHeader]
        //public ActionResult downloadPODocs(string CustomerCode, string ProjectCode, int JobID, int PODocID)
        //{
        //    var content = db.PODoc.Find(CustomerCode, ProjectCode, JobID, PODocID);
        //    return Json(content, JsonRequestBehavior.AllowGet);
        //}

        //check PO doc 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult checkPODocs(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = new List<CTSMESHPODocsFileModels>();
        //           var lRecord = new CTSMESHPODocsFileModels();

        //           if (CustomerCode != null && ProjectCode != null)
        //           {
        //               if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT PODocID, " +
        //                   "FileName, " +
        //                   "Convert(varchar, UpdatedDate, 120), " +
        //                   "UpdatedBy, " +
        //                   "str(DataLength(PODoc)/1000) " +
        //                   "FROM dbo.OESPODoc " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID + " " +
        //                   "ORDER BY PODocID ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           while (lRst.Read())
        //                           {
        //                               lRecord = new CTSMESHPODocsFileModels
        //                               {
        //                                   PODocID = lRst.GetInt32(0),
        //                                   FileName = lRst.GetString(1).Trim(),
        //                                   UpdatedDate = lRst.GetString(2).Trim(),
        //                                   UpdatedBy = lRst.GetString(3).Trim(),
        //                                   FileSize = lRst.GetString(4).Trim(),
        //                               };
        //                               lReturn.Add(lRecord);
        //                           }
        //                       }
        //                       lRst.Close();

        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;
        //           return Ok(lReturn);
        //       }

        //       //check PO doc 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getFormerLimitation()
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = (new[]{ new
        //           {
        //               grade = "",
        //               type = "",
        //               dia = 0,
        //               pin = 0,
        //               bend_len_min = 0,
        //               hook_len_min = 0,
        //               hook_height_min = 0
        //           }}).ToList();

        //           lCmd.CommandText =
        //           "SELECT grade, type, dia, pin, bend_len_min, hook_len_min, hook_height_min " +
        //           "FROM dbo.OESPin " +
        //           "WHERE grade = 'H' " +
        //           "ORDER BY grade, type desc, dia ";



        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       lReturn.Add(new
        //                       {
        //                           grade = lRst.GetString(0).Trim(),
        //                           type = lRst.GetString(1).Trim() == "S" ? "Standard" : "Non-Standard",
        //                           dia = lRst.GetInt32(2),
        //                           pin = lRst.GetInt32(3),
        //                           bend_len_min = lRst.GetInt32(4),
        //                           hook_len_min = lRst.GetInt32(5),
        //                           hook_height_min = lRst.GetInt32(6)
        //                       });
        //                   }
        //               }
        //               lRst.Close();

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           return Ok(lReturn);
        //       }

        //       public int ValidTransport(OrderDetailsModels pItem, string pshapeTransportValidator)
        //       {
        //           // return 0 -- OK, 1 -- Low Bed, 2 -- Low Bed need police escort
        //           var lLowBedLimit = 2400;
        //           var lLowBedEscLimit = 3300;
        //           var lLowBed = 0;
        //           var lEscort = 0;
        //           var lLowBedAnd = 0;
        //           var lEscortAnd = 0;
        //           var lItem = pItem;
        //           var lF = pshapeTransportValidator;
        //           var lResult = 0;
        //           if (lF != null && lF != "")
        //           {
        //               var lOr = lF.Split(new string[] { "||" }, StringSplitOptions.None);
        //               for (var i = 0; i < lOr.Length; i++)
        //               {
        //                   var lAnd = lOr[i].Split(new string[] { "&&" }, StringSplitOptions.None);
        //                   lLowBedAnd = 1;
        //                   lEscortAnd = 1;
        //                   for (var j = 0; j < lAnd.Length; j++)
        //                   {
        //                       if (lAnd[j].IndexOf("A") >= 0) if (lItem.A != null) lAnd[j] = lAnd[j].Replace("A", getVarMaxValue(lItem.A.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("A", "0");
        //                       if (lAnd[j].IndexOf("B") >= 0) if (lItem.B != null) lAnd[j] = lAnd[j].Replace("B", getVarMaxValue(lItem.B.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("B", "0");
        //                       if (lAnd[j].IndexOf("C") >= 0) if (lItem.C != null) lAnd[j] = lAnd[j].Replace("C", getVarMaxValue(lItem.C.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("C", "0");
        //                       if (lAnd[j].IndexOf("D") >= 0) if (lItem.D != null) lAnd[j] = lAnd[j].Replace("D", getVarMaxValue(lItem.D.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("D", "0");
        //                       if (lAnd[j].IndexOf("E") >= 0) if (lItem.E != null) lAnd[j] = lAnd[j].Replace("E", getVarMaxValue(lItem.E.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("E", "0");
        //                       if (lAnd[j].IndexOf("F") >= 0) if (lItem.F != null) lAnd[j] = lAnd[j].Replace("F", getVarMaxValue(lItem.F.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("F", "0");
        //                       if (lAnd[j].IndexOf("G") >= 0) if (lItem.G != null) lAnd[j] = lAnd[j].Replace("G", getVarMaxValue(lItem.G.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("G", "0");
        //                       if (lAnd[j].IndexOf("H") >= 0) if (lItem.H != null) lAnd[j] = lAnd[j].Replace("H", getVarMaxValue(lItem.H.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("H", "0");
        //                       if (lAnd[j].IndexOf("I") >= 0) if (lItem.I != null) lAnd[j] = lAnd[j].Replace("I", getVarMaxValue(lItem.I.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("I", "0");
        //                       if (lAnd[j].IndexOf("J") >= 0) if (lItem.J != null) lAnd[j] = lAnd[j].Replace("J", getVarMaxValue(lItem.J.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("J", "0");
        //                       if (lAnd[j].IndexOf("K") >= 0) if (lItem.K != null) lAnd[j] = lAnd[j].Replace("K", getVarMaxValue(lItem.K.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("K", "0");
        //                       if (lAnd[j].IndexOf("L") >= 0) if (lItem.L != null) lAnd[j] = lAnd[j].Replace("L", getVarMaxValue(lItem.L.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("L", "0");
        //                       if (lAnd[j].IndexOf("M") >= 0) if (lItem.M != null) lAnd[j] = lAnd[j].Replace("M", getVarMaxValue(lItem.M.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("M", "0");
        //                       if (lAnd[j].IndexOf("N") >= 0) if (lItem.N != null) lAnd[j] = lAnd[j].Replace("N", getVarMaxValue(lItem.N.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("N", "0");
        //                       if (lAnd[j].IndexOf("O") >= 0) if (lItem.O != null) lAnd[j] = lAnd[j].Replace("O", getVarMaxValue(lItem.O.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("O", "0");
        //                       if (lAnd[j].IndexOf("P") >= 0) if (lItem.P != null) lAnd[j] = lAnd[j].Replace("P", getVarMaxValue(lItem.P.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("P", "0");
        //                       if (lAnd[j].IndexOf("Q") >= 0) if (lItem.Q != null) lAnd[j] = lAnd[j].Replace("Q", getVarMaxValue(lItem.Q.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Q", "0");
        //                       if (lAnd[j].IndexOf("R") >= 0) if (lItem.R != null) lAnd[j] = lAnd[j].Replace("R", getVarMaxValue(lItem.R.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("R", "0");
        //                       if (lAnd[j].IndexOf("S") >= 0) if (lItem.S != null) lAnd[j] = lAnd[j].Replace("S", getVarMaxValue(lItem.S.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("S", "0");
        //                       if (lAnd[j].IndexOf("T") >= 0) if (lItem.T != null) lAnd[j] = lAnd[j].Replace("T", getVarMaxValue(lItem.T.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("T", "0");
        //                       if (lAnd[j].IndexOf("U") >= 0) if (lItem.U != null) lAnd[j] = lAnd[j].Replace("U", getVarMaxValue(lItem.U.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("U", "0");
        //                       if (lAnd[j].IndexOf("V") >= 0) if (lItem.V != null) lAnd[j] = lAnd[j].Replace("V", getVarMaxValue(lItem.V.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("V", "0");
        //                       if (lAnd[j].IndexOf("W") >= 0) if (lItem.W != null) lAnd[j] = lAnd[j].Replace("W", getVarMaxValue(lItem.W.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("W", "0");
        //                       if (lAnd[j].IndexOf("X") >= 0) if (lItem.X != null) lAnd[j] = lAnd[j].Replace("X", getVarMaxValue(lItem.X.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("X", "0");
        //                       if (lAnd[j].IndexOf("Y") >= 0) if (lItem.Y != null) lAnd[j] = lAnd[j].Replace("Y", getVarMaxValue(lItem.Y.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Y", "0");
        //                       if (lAnd[j].IndexOf("Z") >= 0) if (lItem.Z != null) lAnd[j] = lAnd[j].Replace("Z", getVarMaxValue(lItem.Z.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Z", "0");

        //                       if (lAnd[j].IndexOf("math.") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("math.", "");
        //                       }
        //                       if (lAnd[j].IndexOf("pi") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("pi", "3.14159");
        //                       }
        //                       if (lAnd[j].IndexOf("PI") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("PI", "3.14159");
        //                       }
        //                       if (lAnd[j].IndexOf("Pi") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("Pi", "3.14159");
        //                       }
        //                       if (lAnd[j].IndexOf("pI") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("pI", "3.14159");
        //                       }

        //                       if (lAnd[j].IndexOf("sqrt") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("sqrt", "Sqrt");
        //                       }

        //                       if (lAnd[j].IndexOf("sin") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("sin", "Sin");
        //                       }

        //                       if (lAnd[j].IndexOf("cos") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("cos", "Cos");
        //                       }

        //                       if (lAnd[j].IndexOf("max") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("max", "Max");
        //                       }

        //                       if (lAnd[j].IndexOf("min") >= 0)
        //                       {
        //                           lAnd[j] = lAnd[j].Replace("min", "Min");
        //                       }

        //                       Expression lExp = new Expression(lAnd[j]);
        //                       //lExp.Parameters["A"] = (int)(lItem.A == null ? 0 : lItem.A);
        //                       //lExp.Parameters["B"] = (int)(lItem.B == null ? 0 : lItem.B);
        //                       //lExp.Parameters["C"] = (int)(lItem.C == null ? 0 : lItem.C);
        //                       //lExp.Parameters["D"] = (int)(lItem.D == null ? 0 : lItem.D);
        //                       //lExp.Parameters["E"] = (int)(lItem.E == null ? 0 : lItem.E);
        //                       //lExp.Parameters["F"] = (int)(lItem.F == null ? 0 : lItem.F);
        //                       //lExp.Parameters["G"] = (int)(lItem.G == null ? 0 : lItem.G);
        //                       //lExp.Parameters["H"] = (int)(lItem.H == null ? 0 : lItem.H);
        //                       //lExp.Parameters["I"] = (int)(lItem.I == null ? 0 : lItem.I);
        //                       //lExp.Parameters["J"] = (int)(lItem.J == null ? 0 : lItem.J);
        //                       //lExp.Parameters["K"] = (int)(lItem.K == null ? 0 : lItem.K);
        //                       //lExp.Parameters["L"] = (int)(lItem.L == null ? 0 : lItem.L);
        //                       //lExp.Parameters["M"] = (int)(lItem.M == null ? 0 : lItem.M);
        //                       //lExp.Parameters["N"] = (int)(lItem.N == null ? 0 : lItem.N);
        //                       //lExp.Parameters["O"] = (int)(lItem.O == null ? 0 : lItem.O);
        //                       //lExp.Parameters["P"] = (int)(lItem.P == null ? 0 : lItem.P);
        //                       //lExp.Parameters["Q"] = (int)(lItem.Q == null ? 0 : lItem.Q);
        //                       //lExp.Parameters["R"] = (int)(lItem.R == null ? 0 : lItem.R);
        //                       //lExp.Parameters["S"] = (int)(lItem.S == null ? 0 : lItem.S);
        //                       //lExp.Parameters["T"] = (int)(lItem.T == null ? 0 : lItem.T);
        //                       //lExp.Parameters["U"] = (int)(lItem.U == null ? 0 : lItem.U);
        //                       //lExp.Parameters["V"] = (int)(lItem.V == null ? 0 : lItem.V);
        //                       //lExp.Parameters["W"] = (int)(lItem.W == null ? 0 : lItem.W);
        //                       //lExp.Parameters["X"] = (int)(lItem.X == null ? 0 : lItem.X);
        //                       //lExp.Parameters["Y"] = (int)(lItem.Y == null ? 0 : lItem.Y);
        //                       //lExp.Parameters["Z"] = (int)(lItem.Z == null ? 0 : lItem.Z);

        //                       try
        //                       {
        //                           if (!lExp.HasErrors())
        //                           {
        //                               var lSResult = lExp.Evaluate().ToString();
        //                               if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
        //                               int.TryParse(lSResult, out lResult);
        //                           }

        //                           if (lResult == 0)
        //                           {
        //                               lLowBedAnd = 0;
        //                               lEscortAnd = 0;
        //                           }
        //                           else
        //                           {
        //                               if (lResult <= lLowBedLimit)
        //                               {
        //                                   lLowBedAnd = 0;
        //                               }
        //                               if (lResult <= lLowBedEscLimit)
        //                               {
        //                                   lEscortAnd = 0;
        //                               }
        //                           }
        //                       }
        //                       catch (Exception ex)
        //                       {
        //                           lLowBedAnd = 0;
        //                           lEscortAnd = 0;
        //                       }
        //                   }
        //                   if (lLowBedAnd == 1)
        //                   {
        //                       lLowBed = 1;
        //                   }
        //                   if (lEscortAnd == 1)
        //                   {
        //                       lEscort = 1;
        //                   }
        //               }
        //           }
        //           lResult = 0;
        //           if (lLowBed == 1) lResult = 1;
        //           if (lEscort == 1) lResult = 2;
        //           return lResult;
        //       }

        //       int getVarMaxValue(string pValue)
        //       {
        //           var rValue = 0;
        //           if (pValue != null)
        //           {
        //               if (!int.TryParse(pValue, out rValue))
        //               {
        //                   var lVarLen = pValue.Split('-');
        //                   if (lVarLen.Length == 2)
        //                   {
        //                       var lVar1 = 0;
        //                       var lVar2 = 0;
        //                       int.TryParse(lVarLen[0], out lVar1);
        //                       int.TryParse(lVarLen[1], out lVar2);
        //                       if (lVar1 > lVar2)
        //                       {
        //                           rValue = lVar1;
        //                       }
        //                       else
        //                       {
        //                           rValue = lVar2;
        //                       }
        //                   }
        //                   else
        //                   {
        //                       rValue = 0;
        //                   }
        //               }
        //           }
        //           return rValue;
        //       }

        //       int getVarMinValue(string pValue)
        //       {
        //           var rValue = 0;
        //           if (pValue != null)
        //           {
        //               if (!int.TryParse(pValue, out rValue))
        //               {
        //                   var lVarLen = pValue.Split('-');
        //                   if (lVarLen.Length == 2)
        //                   {
        //                       var lVar1 = 0;
        //                       var lVar2 = 0;
        //                       int.TryParse(lVarLen[0], out lVar1);
        //                       int.TryParse(lVarLen[1], out lVar2);
        //                       if (lVar1 > lVar2)
        //                       {
        //                           rValue = lVar2;
        //                       }
        //                       else
        //                       {
        //                           rValue = lVar1;
        //                       }
        //                   }
        //                   else
        //                   {
        //                       rValue = 0;
        //                   }
        //               }
        //           }
        //           return rValue;
        //       }

        //       public bool isValidValue(string pColumnName, string pParameters, string pValidator, int? pDia, string pValue, OrderDetailsModels pItem, out string msgRef)
        //       {
        //           var lReturn = true;
        //           var lErrorMsg = "";
        //           var lDiaAll = "0,6,8,10,13,16,20,25,28,32,40,50";
        //           var lMinLen = "0,60,60,90,100,120,150,200,200,220,280,450";
        //           var lMinLenHk = "0,60,60,90,100,130,150,200,200,220,280,460";
        //           var lMinHtHk = "0,45,45,65,80,110,135,180,180,220,280,540";

        //           if (pColumnName != null && pColumnName != "" &&
        //           pParameters != null && pParameters != "" &&
        //           pValidator != null && pValidator != "" &&
        //           pDia != null && pDia != 0 &&
        //           pValue != null && pValue != "0" && pValue != "")
        //           {
        //               var lValidator = 0;
        //               var lValidators = pValidator.Split(',');
        //               var lParas = pParameters.Split(',');
        //               var lDaiAR = lDiaAll.Split(',');
        //               var lMinLenAR = lMinLen.Split(',');
        //               var lMinLenHkAR = lMinLenHk.Split(',');
        //               var lMinHtHkAR = lMinHtHk.Split(',');
        //               if (lValidators.Length == lParas.Length)
        //               {
        //                   for (var i = 0; i < lValidators.Length; i++)
        //                   {
        //                       if (pColumnName == lParas[i])
        //                       {
        //                           var laValidators = lValidators[i].Split(';');
        //                           for (var j = 0; j < laValidators.Length; j++)
        //                           {
        //                               lValidator = 0;
        //                               int.TryParse(laValidators[j].Substring(0, 1), out lValidator);
        //                               if (lValidator == 1)
        //                               {
        //                                   //Min Len validation
        //                                   for (var k = 0; k < lDaiAR.Length; k++)
        //                                   {
        //                                       if (pDia == int.Parse(lDaiAR[k]))
        //                                       {
        //                                           if (getVarMinValue(pValue) < int.Parse(lMinLenAR[k]))
        //                                           {
        //                                               lErrorMsg = "Invalid data entered. The minimum bending length is " + lMinLenAR[k] + ". (输入数据无效, 折弯长度的最小值为" + lMinLenAR[k] + ")";
        //                                               lReturn = false;
        //                                           }
        //                                           break;
        //                                       }
        //                                   }
        //                               }
        //                               if (lValidator == 2)
        //                               {
        //                                   //Hook minimum length validation
        //                                   for (var k = 0; k < lDaiAR.Length; k++)
        //                                   {
        //                                       if (pDia == int.Parse(lDaiAR[k]))
        //                                       {
        //                                           if (getVarMinValue(pValue) < int.Parse(lMinLenHkAR[k]))
        //                                           {
        //                                               lErrorMsg = "Invalid data entered. The minimum hook length is " + lMinLenHkAR[k] + ". (输入数据无效, 铁钩长度的最小值为" + lMinLenHkAR[k] + ")";
        //                                               lReturn = false;
        //                                           }
        //                                           break;
        //                                       }
        //                                   }
        //                               }
        //                               if (lValidator == 3)
        //                               {
        //                                   //Hook limimum height validation
        //                                   for (var k = 0; k < lDaiAR.Length; k++)
        //                                   {
        //                                       if (pDia == int.Parse(lDaiAR[k]))
        //                                       {
        //                                           if (getVarMinValue(pValue) < int.Parse(lMinHtHkAR[k]))
        //                                           {
        //                                               lErrorMsg = "Invalid data entered. The minimum hook height is " + lMinHtHkAR[k] + ". (输入数据无效, 铁钩高度的最小值为" + lMinHtHkAR[k] + ")";
        //                                               lReturn = false;
        //                                           }
        //                                           break;
        //                                       }
        //                                   }
        //                               }
        //                               if (lValidator == 4)
        //                               {
        //                                   //Height validation
        //                                   if (getVarMinValue(pValue) < pDia + int.Parse(lDaiAR[1]))
        //                                   {
        //                                       // less than dia + 10 (first dia)
        //                                       lErrorMsg = "Invalid data entered. The minimum height is " + (pDia + int.Parse(lDaiAR[1])).ToString() + ". (输入数据无效, 高度的最小值为" + (pDia + int.Parse(lDaiAR[1])).ToString() + ")";
        //                                       lReturn = false;
        //                                       break;
        //                                   }
        //                               }
        //                               if (lValidator == 5)
        //                               {
        //                                   //Angle validation 1-89
        //                                   if (int.Parse(pValue) >= 90 || int.Parse(pValue) <= 0)
        //                                   {
        //                                       lErrorMsg = "Invalid data entered. The angle value should be between 1-89. (输入数据无效, 角度的数值应该在 1-89 之间)";
        //                                       lReturn = false;
        //                                       break;
        //                                   }
        //                               }
        //                               if (lValidator == 6)
        //                               {
        //                                   //Angle validaion 91-179
        //                                   if (int.Parse(pValue) >= 180 || int.Parse(pValue) <= 90)
        //                                   {
        //                                       lErrorMsg = "Invalid data entered. The angle value should be between 91-179. (输入数据无效, 角度的数值应该在 91-179 之间)";
        //                                       lReturn = false;
        //                                       break;
        //                                   }
        //                               }
        //                               if (lValidator == 7)
        //                               {
        //                                   //Angle validation 1-179
        //                                   if (int.Parse(pValue) >= 180 || int.Parse(pValue) <= 0)
        //                                   {
        //                                       lErrorMsg = "Invalid data entered. The angle value should be between 1-179. (输入数据无效, 角度的数值应该在 1-179 之间)";
        //                                       lReturn = false;
        //                                       break;
        //                                   }
        //                               }
        //                               if (lValidator == 8)
        //                               {
        //                                   //Segment length have to less than given segment
        //                                   if (laValidators[j].Length >= 2)
        //                                   {
        //                                       var lAPara = laValidators[j].Substring(1, 1);

        //                                       var lAValue = "0";
        //                                       if (lAPara == "A") lAValue = pItem.A.ToString();
        //                                       if (lAPara == "B") lAValue = pItem.B.ToString();
        //                                       if (lAPara == "C") lAValue = pItem.C.ToString();
        //                                       if (lAPara == "D") lAValue = pItem.D.ToString();
        //                                       if (lAPara == "E") lAValue = pItem.E.ToString();
        //                                       if (lAPara == "F") lAValue = pItem.F.ToString();
        //                                       if (lAPara == "G") lAValue = pItem.G.ToString();
        //                                       if (lAPara == "H") lAValue = pItem.H.ToString();
        //                                       if (lAPara == "I") lAValue = pItem.I.ToString();
        //                                       if (lAPara == "J") lAValue = pItem.J.ToString();
        //                                       if (lAPara == "K") lAValue = pItem.K.ToString();
        //                                       if (lAPara == "L") lAValue = pItem.L.ToString();
        //                                       if (lAPara == "M") lAValue = pItem.M.ToString();
        //                                       if (lAPara == "N") lAValue = pItem.N.ToString();
        //                                       if (lAPara == "O") lAValue = pItem.O.ToString();
        //                                       if (lAPara == "P") lAValue = pItem.P.ToString();
        //                                       if (lAPara == "Q") lAValue = pItem.Q.ToString();
        //                                       if (lAPara == "R") lAValue = pItem.R.ToString();
        //                                       if (lAPara == "S") lAValue = pItem.S.ToString();
        //                                       if (lAPara == "T") lAValue = pItem.T.ToString();
        //                                       if (lAPara == "U") lAValue = pItem.U.ToString();
        //                                       if (lAPara == "V") lAValue = pItem.V.ToString();
        //                                       if (lAPara == "W") lAValue = pItem.W.ToString();
        //                                       if (lAPara == "X") lAValue = pItem.X.ToString();
        //                                       if (lAPara == "Y") lAValue = pItem.Y.ToString();
        //                                       if (lAPara == "Z") lAValue = pItem.Z.ToString();
        //                                       if (getVarMinValue(pValue) >= getVarMinValue(lAValue))
        //                                       {
        //                                           lErrorMsg = "Invalid data entered. The height value should be less than parameter "
        //                                               + lAPara + " value " + getVarMinValue(lAValue) + ". (输入数据无效, 高度值应该小于参数"
        //                                               + lAPara + " 的数值 " + getVarMinValue(lAValue) + ")";
        //                                           lReturn = false;
        //                                           break;
        //                                       }
        //                                       else
        //                                       {
        //                                           if (getVarMaxValue(pValue) >= getVarMaxValue(lAValue))
        //                                           {
        //                                               lErrorMsg = "Invalid data entered. The height value should be less than parameter "
        //                                                   + lAPara + " value " + getVarMaxValue(lAValue) + ". (输入数据无效, 高度值应该小于参数"
        //                                                   + lAPara + " 的数值 " + getVarMaxValue(lAValue) + ")";
        //                                               lReturn = false;
        //                                               break;
        //                                           }
        //                                       }
        //                                   }
        //                               }
        //                           }
        //                       }
        //                   }
        //               }

        //           }
        //           msgRef = lErrorMsg;
        //           return lReturn;
        //       }

        //       bool isInvalidParameterCell(string pShapeCode, string pColumnName, string pParameters)
        //       {
        //           var lReturn = false;
        //           if (pShapeCode != null && pShapeCode != "" && pParameters != null)
        //           {
        //               if ((pColumnName == "A" && pParameters.IndexOf("A") < 0) ||
        //               (pColumnName == "B" && pParameters.IndexOf("B") < 0) ||
        //               (pColumnName == "C" && pParameters.IndexOf("C") < 0) ||
        //               (pColumnName == "D" && pParameters.IndexOf("D") < 0) ||
        //               (pColumnName == "E" && pParameters.IndexOf("E") < 0) ||
        //               (pColumnName == "F" && pParameters.IndexOf("F") < 0) ||
        //               (pColumnName == "G" && pParameters.IndexOf("G") < 0) ||
        //               (pColumnName == "H" && pParameters.IndexOf("H") < 0) ||
        //               (pColumnName == "I" && pParameters.IndexOf("I") < 0) ||
        //               (pColumnName == "J" && pParameters.IndexOf("J") < 0) ||
        //               (pColumnName == "K" && pParameters.IndexOf("K") < 0) ||
        //               (pColumnName == "L" && pParameters.IndexOf("L") < 0) ||
        //               (pColumnName == "M" && pParameters.IndexOf("M") < 0) ||
        //               (pColumnName == "N" && pParameters.IndexOf("N") < 0) ||
        //               (pColumnName == "O" && pParameters.IndexOf("O") < 0) ||
        //               (pColumnName == "P" && pParameters.IndexOf("P") < 0) ||
        //               (pColumnName == "Q" && pParameters.IndexOf("Q") < 0) ||
        //               (pColumnName == "R" && pParameters.IndexOf("R") < 0) ||
        //               (pColumnName == "S" && pParameters.IndexOf("S") < 0) ||
        //               (pColumnName == "T" && pParameters.IndexOf("T") < 0) ||
        //               (pColumnName == "U" && pParameters.IndexOf("U") < 0) ||
        //               (pColumnName == "V" && pParameters.IndexOf("V") < 0) ||
        //               (pColumnName == "W" && pParameters.IndexOf("W") < 0) ||
        //               (pColumnName == "X" && pParameters.IndexOf("X") < 0) ||
        //               (pColumnName == "Y" && pParameters.IndexOf("Y") < 0) ||
        //               (pColumnName == "Z" && pParameters.IndexOf("Z") < 0))
        //               {
        //                   lReturn = true;
        //               }
        //           }
        //           return lReturn;
        //       }

        //       string calTotalLen(OrderDetailsModels pItem, string pshapeLengthFormula)
        //       {
        //           var lItem = pItem;
        //           var lF = pshapeLengthFormula;
        //           var lResult = "0";
        //           var lVarMax = 0;
        //           var lVarMin = 0;
        //           if (lF != "")
        //           {
        //               if (lF.IndexOf("A") >= 0) if (lItem.A != null) lF = lF.Replace("A", getVarMaxValue(lItem.A.ToString()).ToString()); else lF = lF.Replace("A", "0");
        //               if (lF.IndexOf("B") >= 0) if (lItem.B != null) lF = lF.Replace("B", getVarMaxValue(lItem.B.ToString()).ToString()); else lF = lF.Replace("B", "0");
        //               if (lF.IndexOf("C") >= 0) if (lItem.C != null) lF = lF.Replace("C", getVarMaxValue(lItem.C.ToString()).ToString()); else lF = lF.Replace("C", "0");
        //               if (lF.IndexOf("D") >= 0) if (lItem.D != null) lF = lF.Replace("D", getVarMaxValue(lItem.D.ToString()).ToString()); else lF = lF.Replace("D", "0");
        //               if (lF.IndexOf("E") >= 0) if (lItem.E != null) lF = lF.Replace("E", getVarMaxValue(lItem.E.ToString()).ToString()); else lF = lF.Replace("E", "0");
        //               if (lF.IndexOf("F") >= 0) if (lItem.F != null) lF = lF.Replace("F", getVarMaxValue(lItem.F.ToString()).ToString()); else lF = lF.Replace("F", "0");
        //               if (lF.IndexOf("G") >= 0) if (lItem.G != null) lF = lF.Replace("G", getVarMaxValue(lItem.G.ToString()).ToString()); else lF = lF.Replace("G", "0");
        //               if (lF.IndexOf("H") >= 0) if (lItem.H != null) lF = lF.Replace("H", getVarMaxValue(lItem.H.ToString()).ToString()); else lF = lF.Replace("H", "0");
        //               if (lF.IndexOf("I") >= 0) if (lItem.I != null) lF = lF.Replace("I", getVarMaxValue(lItem.I.ToString()).ToString()); else lF = lF.Replace("I", "0");
        //               if (lF.IndexOf("J") >= 0) if (lItem.J != null) lF = lF.Replace("J", getVarMaxValue(lItem.J.ToString()).ToString()); else lF = lF.Replace("J", "0");
        //               if (lF.IndexOf("K") >= 0) if (lItem.K != null) lF = lF.Replace("K", getVarMaxValue(lItem.K.ToString()).ToString()); else lF = lF.Replace("K", "0");
        //               if (lF.IndexOf("L") >= 0) if (lItem.L != null) lF = lF.Replace("L", getVarMaxValue(lItem.L.ToString()).ToString()); else lF = lF.Replace("L", "0");
        //               if (lF.IndexOf("M") >= 0) if (lItem.M != null) lF = lF.Replace("M", getVarMaxValue(lItem.M.ToString()).ToString()); else lF = lF.Replace("M", "0");
        //               if (lF.IndexOf("N") >= 0) if (lItem.N != null) lF = lF.Replace("N", getVarMaxValue(lItem.N.ToString()).ToString()); else lF = lF.Replace("N", "0");
        //               if (lF.IndexOf("O") >= 0) if (lItem.O != null) lF = lF.Replace("O", getVarMaxValue(lItem.O.ToString()).ToString()); else lF = lF.Replace("O", "0");
        //               if (lF.IndexOf("P") >= 0) if (lItem.P != null) lF = lF.Replace("P", getVarMaxValue(lItem.P.ToString()).ToString()); else lF = lF.Replace("P", "0");
        //               if (lF.IndexOf("Q") >= 0) if (lItem.Q != null) lF = lF.Replace("Q", getVarMaxValue(lItem.Q.ToString()).ToString()); else lF = lF.Replace("Q", "0");
        //               if (lF.IndexOf("R") >= 0) if (lItem.R != null) lF = lF.Replace("R", getVarMaxValue(lItem.R.ToString()).ToString()); else lF = lF.Replace("R", "0");
        //               if (lF.IndexOf("S") >= 0) if (lItem.S != null) lF = lF.Replace("S", getVarMaxValue(lItem.S.ToString()).ToString()); else lF = lF.Replace("S", "0");
        //               if (lF.IndexOf("T") >= 0) if (lItem.T != null) lF = lF.Replace("T", getVarMaxValue(lItem.T.ToString()).ToString()); else lF = lF.Replace("T", "0");
        //               if (lF.IndexOf("U") >= 0) if (lItem.U != null) lF = lF.Replace("U", getVarMaxValue(lItem.U.ToString()).ToString()); else lF = lF.Replace("U", "0");
        //               if (lF.IndexOf("V") >= 0) if (lItem.V != null) lF = lF.Replace("V", getVarMaxValue(lItem.V.ToString()).ToString()); else lF = lF.Replace("V", "0");
        //               if (lF.IndexOf("W") >= 0) if (lItem.W != null) lF = lF.Replace("W", getVarMaxValue(lItem.W.ToString()).ToString()); else lF = lF.Replace("W", "0");
        //               if (lF.IndexOf("X") >= 0) if (lItem.X != null) lF = lF.Replace("X", getVarMaxValue(lItem.X.ToString()).ToString()); else lF = lF.Replace("X", "0");
        //               if (lF.IndexOf("Y") >= 0) if (lItem.Y != null) lF = lF.Replace("Y", getVarMaxValue(lItem.Y.ToString()).ToString()); else lF = lF.Replace("Y", "0");
        //               if (lF.IndexOf("Z") >= 0) if (lItem.Z != null) lF = lF.Replace("Z", getVarMaxValue(lItem.Z.ToString()).ToString()); else lF = lF.Replace("Z", "0");
        //               if (lF.IndexOf("math") >= 0)
        //               {
        //                   lF = lF.Replace("math.", "");
        //               }
        //               if (lF.IndexOf("PI") >= 0)
        //               {
        //                   lF = lF.Replace("PI", "3.14159");
        //               }
        //               if (lF.IndexOf("Pi") >= 0)
        //               {
        //                   lF = lF.Replace("Pi", "3.14159");
        //               }
        //               if (lF.IndexOf("pI") >= 0)
        //               {
        //                   lF = lF.Replace("pI", "3.14159");
        //               }
        //               if (lF.IndexOf("pi") >= 0)
        //               {
        //                   lF = lF.Replace("pi", "3.14159");
        //               }
        //               if (lF.IndexOf("sqrt") >= 0)
        //               {
        //                   lF = lF.Replace("sqrt", "Sqrt");
        //               }

        //               if (lF.IndexOf("sin") >= 0)
        //               {
        //                   lF = lF.Replace("sin", "Sin");
        //               }

        //               if (lF.IndexOf("cos") >= 0)
        //               {
        //                   lF = lF.Replace("cos", "Cos");
        //               }

        //               if (lF.IndexOf("max") >= 0)
        //               {
        //                   lF = lF.Replace("max", "Max");
        //               }

        //               if (lF.IndexOf("min") >= 0)
        //               {
        //                   lF = lF.Replace("min", "Min");
        //               }
        //               Expression lExp = new Expression(lF);

        //               if (!lExp.HasErrors())
        //               {
        //                   var lSResult = lExp.Evaluate().ToString();
        //                   if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
        //                   int.TryParse(lSResult, out lVarMax);
        //               }

        //               lF = pshapeLengthFormula;
        //               if (lF.IndexOf("A") >= 0) if (lItem.A2 != null && lItem.A2 > 0) lF = lF.Replace("A", getVarMinValue(lItem.A2.ToString()).ToString()); else if (lItem.A != null) lF = lF.Replace("A", getVarMinValue(lItem.A.ToString()).ToString()); else lF = lF.Replace("A", "0");
        //               if (lF.IndexOf("B") >= 0) if (lItem.B2 != null && lItem.B2 > 0) lF = lF.Replace("B", getVarMinValue(lItem.B2.ToString()).ToString()); else if (lItem.B != null) lF = lF.Replace("B", getVarMinValue(lItem.B.ToString()).ToString()); else lF = lF.Replace("B", "0");
        //               if (lF.IndexOf("C") >= 0) if (lItem.C2 != null && lItem.C2 > 0) lF = lF.Replace("C", getVarMinValue(lItem.C2.ToString()).ToString()); else if (lItem.C != null) lF = lF.Replace("C", getVarMinValue(lItem.C.ToString()).ToString()); else lF = lF.Replace("C", "0");
        //               if (lF.IndexOf("D") >= 0) if (lItem.D2 != null && lItem.D2 > 0) lF = lF.Replace("D", getVarMinValue(lItem.D2.ToString()).ToString()); else if (lItem.D != null) lF = lF.Replace("D", getVarMinValue(lItem.D.ToString()).ToString()); else lF = lF.Replace("D", "0");
        //               if (lF.IndexOf("E") >= 0) if (lItem.E2 != null && lItem.E2 > 0) lF = lF.Replace("E", getVarMinValue(lItem.E2.ToString()).ToString()); else if (lItem.E != null) lF = lF.Replace("E", getVarMinValue(lItem.E.ToString()).ToString()); else lF = lF.Replace("E", "0");
        //               if (lF.IndexOf("F") >= 0) if (lItem.F2 != null && lItem.F2 > 0) lF = lF.Replace("F", getVarMinValue(lItem.F2.ToString()).ToString()); else if (lItem.F != null) lF = lF.Replace("F", getVarMinValue(lItem.F.ToString()).ToString()); else lF = lF.Replace("F", "0");
        //               if (lF.IndexOf("G") >= 0) if (lItem.G2 != null && lItem.G2 > 0) lF = lF.Replace("G", getVarMinValue(lItem.G2.ToString()).ToString()); else if (lItem.G != null) lF = lF.Replace("G", getVarMinValue(lItem.G.ToString()).ToString()); else lF = lF.Replace("G", "0");
        //               if (lF.IndexOf("H") >= 0) if (lItem.H2 != null && lItem.H2 > 0) lF = lF.Replace("H", getVarMinValue(lItem.H2.ToString()).ToString()); else if (lItem.H != null) lF = lF.Replace("H", getVarMinValue(lItem.H.ToString()).ToString()); else lF = lF.Replace("H", "0");
        //               if (lF.IndexOf("I") >= 0) if (lItem.I2 != null && lItem.I2 > 0) lF = lF.Replace("I", getVarMinValue(lItem.I2.ToString()).ToString()); else if (lItem.I != null) lF = lF.Replace("I", getVarMinValue(lItem.I.ToString()).ToString()); else lF = lF.Replace("I", "0");
        //               if (lF.IndexOf("J") >= 0) if (lItem.J2 != null && lItem.J2 > 0) lF = lF.Replace("J", getVarMinValue(lItem.J2.ToString()).ToString()); else if (lItem.J != null) lF = lF.Replace("J", getVarMinValue(lItem.J.ToString()).ToString()); else lF = lF.Replace("J", "0");
        //               if (lF.IndexOf("K") >= 0) if (lItem.K2 != null && lItem.K2 > 0) lF = lF.Replace("K", getVarMinValue(lItem.K2.ToString()).ToString()); else if (lItem.K != null) lF = lF.Replace("K", getVarMinValue(lItem.K.ToString()).ToString()); else lF = lF.Replace("K", "0");
        //               if (lF.IndexOf("L") >= 0) if (lItem.L2 != null && lItem.L2 > 0) lF = lF.Replace("L", getVarMinValue(lItem.L2.ToString()).ToString()); else if (lItem.L != null) lF = lF.Replace("L", getVarMinValue(lItem.L.ToString()).ToString()); else lF = lF.Replace("L", "0");
        //               if (lF.IndexOf("M") >= 0) if (lItem.M2 != null && lItem.M2 > 0) lF = lF.Replace("M", getVarMinValue(lItem.M2.ToString()).ToString()); else if (lItem.M != null) lF = lF.Replace("M", getVarMinValue(lItem.M.ToString()).ToString()); else lF = lF.Replace("M", "0");
        //               if (lF.IndexOf("N") >= 0) if (lItem.N2 != null && lItem.N2 > 0) lF = lF.Replace("N", getVarMinValue(lItem.N2.ToString()).ToString()); else if (lItem.N != null) lF = lF.Replace("N", getVarMinValue(lItem.N.ToString()).ToString()); else lF = lF.Replace("N", "0");
        //               if (lF.IndexOf("O") >= 0) if (lItem.O2 != null && lItem.O2 > 0) lF = lF.Replace("O", getVarMinValue(lItem.O2.ToString()).ToString()); else if (lItem.O != null) lF = lF.Replace("O", getVarMinValue(lItem.O.ToString()).ToString()); else lF = lF.Replace("O", "0");
        //               if (lF.IndexOf("P") >= 0) if (lItem.P2 != null && lItem.P2 > 0) lF = lF.Replace("P", getVarMinValue(lItem.P2.ToString()).ToString()); else if (lItem.P != null) lF = lF.Replace("P", getVarMinValue(lItem.P.ToString()).ToString()); else lF = lF.Replace("P", "0");
        //               if (lF.IndexOf("Q") >= 0) if (lItem.Q2 != null && lItem.Q2 > 0) lF = lF.Replace("Q", getVarMinValue(lItem.Q2.ToString()).ToString()); else if (lItem.Q != null) lF = lF.Replace("Q", getVarMinValue(lItem.Q.ToString()).ToString()); else lF = lF.Replace("Q", "0");
        //               if (lF.IndexOf("R") >= 0) if (lItem.R2 != null && lItem.R2 > 0) lF = lF.Replace("R", getVarMinValue(lItem.R2.ToString()).ToString()); else if (lItem.R != null) lF = lF.Replace("R", getVarMinValue(lItem.R.ToString()).ToString()); else lF = lF.Replace("R", "0");
        //               if (lF.IndexOf("S") >= 0) if (lItem.S2 != null && lItem.S2 > 0) lF = lF.Replace("S", getVarMinValue(lItem.S2.ToString()).ToString()); else if (lItem.S != null) lF = lF.Replace("S", getVarMinValue(lItem.S.ToString()).ToString()); else lF = lF.Replace("S", "0");
        //               if (lF.IndexOf("T") >= 0) if (lItem.T2 != null && lItem.T2 > 0) lF = lF.Replace("T", getVarMinValue(lItem.T2.ToString()).ToString()); else if (lItem.T != null) lF = lF.Replace("T", getVarMinValue(lItem.T.ToString()).ToString()); else lF = lF.Replace("T", "0");
        //               if (lF.IndexOf("U") >= 0) if (lItem.U2 != null && lItem.U2 > 0) lF = lF.Replace("U", getVarMinValue(lItem.U2.ToString()).ToString()); else if (lItem.U != null) lF = lF.Replace("U", getVarMinValue(lItem.U.ToString()).ToString()); else lF = lF.Replace("U", "0");
        //               if (lF.IndexOf("V") >= 0) if (lItem.V2 != null && lItem.V2 > 0) lF = lF.Replace("V", getVarMinValue(lItem.V2.ToString()).ToString()); else if (lItem.V != null) lF = lF.Replace("V", getVarMinValue(lItem.V.ToString()).ToString()); else lF = lF.Replace("V", "0");
        //               if (lF.IndexOf("W") >= 0) if (lItem.W2 != null && lItem.W2 > 0) lF = lF.Replace("W", getVarMinValue(lItem.W2.ToString()).ToString()); else if (lItem.W != null) lF = lF.Replace("W", getVarMinValue(lItem.W.ToString()).ToString()); else lF = lF.Replace("W", "0");
        //               if (lF.IndexOf("X") >= 0) if (lItem.X2 != null && lItem.X2 > 0) lF = lF.Replace("X", getVarMinValue(lItem.X2.ToString()).ToString()); else if (lItem.X != null) lF = lF.Replace("X", getVarMinValue(lItem.X.ToString()).ToString()); else lF = lF.Replace("X", "0");
        //               if (lF.IndexOf("Y") >= 0) if (lItem.Y2 != null && lItem.Y2 > 0) lF = lF.Replace("Y", getVarMinValue(lItem.Y2.ToString()).ToString()); else if (lItem.Y != null) lF = lF.Replace("Y", getVarMinValue(lItem.Y.ToString()).ToString()); else lF = lF.Replace("Y", "0");
        //               if (lF.IndexOf("Z") >= 0) if (lItem.Z2 != null && lItem.Z2 > 0) lF = lF.Replace("Z", getVarMinValue(lItem.Z2.ToString()).ToString()); else if (lItem.Z != null) lF = lF.Replace("Z", getVarMinValue(lItem.Z.ToString()).ToString()); else lF = lF.Replace("Z", "0");

        //               if (lF.IndexOf("math") >= 0)
        //               {
        //                   lF = lF.Replace("math.", "");
        //               }
        //               if (lF.IndexOf("PI") >= 0)
        //               {
        //                   lF = lF.Replace("PI", "3.14159");
        //               }
        //               if (lF.IndexOf("Pi") >= 0)
        //               {
        //                   lF = lF.Replace("Pi", "3.14159");
        //               }
        //               if (lF.IndexOf("pI") >= 0)
        //               {
        //                   lF = lF.Replace("pI", "3.14159");
        //               }
        //               if (lF.IndexOf("pi") >= 0)
        //               {
        //                   lF = lF.Replace("pi", "3.14159");
        //               }
        //               if (lF.IndexOf("sqrt") >= 0)
        //               {
        //                   lF = lF.Replace("sqrt", "Sqrt");
        //               }

        //               if (lF.IndexOf("sin") >= 0)
        //               {
        //                   lF = lF.Replace("sin", "Sin");
        //               }

        //               if (lF.IndexOf("cos") >= 0)
        //               {
        //                   lF = lF.Replace("cos", "Cos");
        //               }

        //               if (lF.IndexOf("max") >= 0)
        //               {
        //                   lF = lF.Replace("max", "Max");
        //               }

        //               if (lF.IndexOf("min") >= 0)
        //               {
        //                   lF = lF.Replace("min", "Min");
        //               }

        //               lExp = new Expression(lF);
        //               if (!lExp.HasErrors())
        //               {
        //                   var lSResult = lExp.Evaluate().ToString();
        //                   if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
        //                   int.TryParse(lSResult, out lVarMin);
        //               }

        //               if (lVarMin == lVarMax)
        //               {
        //                   lResult = lVarMax.ToString();
        //               }
        //               else
        //               {
        //                   if (lVarMin == 0 && lVarMax > 0)
        //                   {
        //                       lResult = lVarMax.ToString();
        //                   }
        //                   else if (lVarMin > 0 && lVarMax == 0)
        //                   {
        //                       lResult = lVarMin.ToString();
        //                   }
        //                   else
        //                   {
        //                       if (lVarMin > lVarMax)
        //                       {
        //                           lResult = lVarMax.ToString() + "-" + lVarMin.ToString();
        //                       }
        //                       else
        //                       {
        //                           lResult = lVarMin.ToString() + "-" + lVarMax.ToString();
        //                       }
        //                   }
        //               }
        //           }
        //           return lResult;
        //       }

        //       double calWeight(OrderDetailsModels pItem)
        //       {
        //           int[] lDia = { 6, 8, 10, 12, 13, 16, 20, 24, 25, 28, 32, 36, 40, 50 };
        //           double[] lUnitWT = { 0.222, 0.395, 0.617, 0.888, 1.042, 1.579, 2.466, 3.699, 3.854, 4.834, 6.313, 7.769, 9.864, 15.413 };
        //           double lWeight = 0;
        //           double lKGM = 0;
        //           var lBarLength = pItem.BarLength;
        //           var lBarLength2 = pItem.BarLength2;

        //           if (pItem.BarTotalQty != null && pItem.BarSize != null && lBarLength != null)
        //           {
        //               for (var i = 0; i < lDia.Length; i++)
        //               {
        //                   if (pItem.BarSize == lDia[i])
        //                   {
        //                       lKGM = lUnitWT[i];
        //                       break;
        //                   }
        //               }
        //               if (lKGM > 0)
        //               {
        //                   if (lBarLength2 != null && lBarLength2 > 0 && lBarLength > 0)
        //                   {
        //                       lWeight = Math.Round(lKGM * (double)pItem.BarTotalQty * ((int)lBarLength + (int)lBarLength2) / 2) / 1000;
        //                   }
        //                   else
        //                   {
        //                       lWeight = Math.Round(lKGM * (int)pItem.BarTotalQty * (int)lBarLength) / 1000;
        //                   }
        //               }
        //           }

        //           return lWeight;
        //       }

        //       double calWeight(int? pBarLength, int? pBarSize, int? pBarTotalQty)
        //       {
        //           int[] lDia = { 6, 8, 10, 12, 13, 16, 20, 24, 25, 28, 32, 36, 40, 50 };
        //           double[] lUnitWT = { 0.222, 0.395, 0.617, 0.888, 1.042, 1.579, 2.466, 3.699, 3.854, 4.834, 6.313, 7.769, 9.864, 15.413 };
        //           double lWeight = 0;
        //           double lKGM = 0;

        //           if (pBarTotalQty != null && pBarSize != null && pBarLength != null && pBarTotalQty > 0 && pBarSize > 0 && pBarLength > 0)
        //           {
        //               for (var i = 0; i < lDia.Length; i++)
        //               {
        //                   if (pBarSize == lDia[i])
        //                   {
        //                       lKGM = lUnitWT[i];
        //                       break;
        //                   }
        //               }
        //               if (lKGM > 0)
        //               {
        //                   lWeight = Math.Round(lKGM * (int)pBarTotalQty * (int)pBarLength) / 1000;
        //               }
        //           }

        //           return lWeight;
        //       }

        //       public void calDependValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pPinSize, string pDia)
        //       {
        //           var lReturn = "";

        //           string[] lParameters = new string[] { };
        //           if (pShapeParam.shapeParameters != null)
        //           {
        //               lParameters = pShapeParam.shapeParameters.Split(',');
        //           }

        //           string[] lParType = new string[] { };
        //           if (pShapeParam.shapeParType != null)
        //           {
        //               lParType = pShapeParam.shapeParType.Split(',');
        //           }

        //           string[] lPardefvalue = new string[] { };
        //           if (pShapeParam.shapeDefaultValue != null)
        //           {
        //               lPardefvalue = pShapeParam.shapeDefaultValue.Split(',');
        //           }

        //           string[] lFormula1 = new string[] { };
        //           if (pShapeParam.shapeAutoCalcFormula1 != null)
        //           {
        //               lFormula1 = pShapeParam.shapeAutoCalcFormula1.Split(',');
        //           }

        //           string[] lFormula2 = new string[] { };
        //           if (pShapeParam.shapeAutoCalcFormula2 != null)
        //           {
        //               lFormula2 = pShapeParam.shapeAutoCalcFormula2.Split(',');
        //           }

        //           string[] lFormula3 = new string[] { };
        //           if (pShapeParam.shapeAutoCalcFormula3 != null)
        //           {
        //               lFormula3 = pShapeParam.shapeAutoCalcFormula3.Split(',');
        //           }

        //           if (lParameters.Length > 0)
        //           {
        //               for (int i = 0; i < lParameters.Length; i++)
        //               {
        //                   if (lParameters[i] == "A" && (pItem.A == null || pItem.A <= 0)
        //                       || lParameters[i] == "B" && (pItem.B == null || pItem.B <= 0)
        //                       || lParameters[i] == "C" && (pItem.C == null || pItem.C <= 0)
        //                       || lParameters[i] == "D" && (pItem.D == null || pItem.D <= 0)
        //                       || lParameters[i] == "E" && (pItem.E == null || pItem.E <= 0)
        //                       || lParameters[i] == "F" && (pItem.F == null || pItem.F <= 0)
        //                       || lParameters[i] == "G" && (pItem.G == null || pItem.G <= 0)
        //                       || lParameters[i] == "H" && (pItem.H == null || pItem.H <= 0)
        //                       || lParameters[i] == "I" && (pItem.I == null || pItem.I <= 0)
        //                       || lParameters[i] == "J" && (pItem.J == null || pItem.J <= 0)
        //                       || lParameters[i] == "K" && (pItem.K == null || pItem.K <= 0)
        //                       || lParameters[i] == "L" && (pItem.L == null || pItem.L <= 0)
        //                       || lParameters[i] == "M" && (pItem.M == null || pItem.M <= 0)
        //                       || lParameters[i] == "N" && (pItem.N == null || pItem.N <= 0)
        //                       || lParameters[i] == "O" && (pItem.O == null || pItem.O <= 0)
        //                       || lParameters[i] == "P" && (pItem.P == null || pItem.P <= 0)
        //                       || lParameters[i] == "Q" && (pItem.Q == null || pItem.Q <= 0)
        //                       || lParameters[i] == "R" && (pItem.R == null || pItem.R <= 0)
        //                       || lParameters[i] == "S" && (pItem.S == null || pItem.S <= 0)
        //                       || lParameters[i] == "T" && (pItem.T == null || pItem.T <= 0)
        //                       || lParameters[i] == "U" && (pItem.U == null || pItem.U <= 0)
        //                       || lParameters[i] == "V" && (pItem.V == null || pItem.V <= 0)
        //                       || lParameters[i] == "X" && (pItem.W == null || pItem.W <= 0)
        //                       || lParameters[i] == "X" && (pItem.X == null || pItem.X <= 0)
        //                       || lParameters[i] == "Y" && (pItem.Y == null || pItem.Y <= 0)
        //                       || lParameters[i] == "Z" && (pItem.Z == null || pItem.Z <= 0)
        //                       )
        //                   {
        //                       lReturn = calParamValue(ref pItem, pShapeParam, lParType[i], lPardefvalue[i], pPinSize, pDia, lFormula1[i], lFormula2[i], lFormula3[i], lParameters[i]);
        //                   }
        //               }
        //           }

        //       }
        public void testDependValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pPinSize, string pDia)
        {
            var lReturn = "";

            string[] lParameters = new string[] { };
            if (pShapeParam.shapeParameters != null)
            {
                lParameters = pShapeParam.shapeParameters.Split(',');
            }

            string[] lParType = new string[] { };
            if (pShapeParam.shapeParType != null)
            {
                lParType = pShapeParam.shapeParType.Split(',');
            }

            string[] lPardefvalue = new string[] { };
            if (pShapeParam.shapeDefaultValue != null)
            {
                lPardefvalue = pShapeParam.shapeDefaultValue.Split(',');
            }

            string[] lFormula1 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula1 != null)
            {
                lFormula1 = pShapeParam.shapeAutoCalcFormula1.Split(',');
            }

            string[] lFormula2 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula2 != null)
            {
                lFormula2 = pShapeParam.shapeAutoCalcFormula2.Split(',');
            }

            string[] lFormula3 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula3 != null)
            {
                lFormula3 = pShapeParam.shapeAutoCalcFormula3.Split(',');
            }

            if (lParameters.Length > 0)
            {
                for (int i = 0; i < lParameters.Length; i++)
                {
                    if (i < lParType.Length && i < lPardefvalue.Length && i < lFormula1.Length && i < lFormula2.Length && i < lFormula3.Length)
                    {
                        lReturn = testParamValue(ref pItem, pShapeParam, lParType[i], lPardefvalue[i], pPinSize, pDia, lFormula1[i], lFormula2[i], lFormula3[i], lParameters[i]);
                    }
                }
            }

        }

        string testParamValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pParamType, string pDefaultValue, string pPinSize, string pDia, string pFormula1, string pFormula2, string pFormula3, string pParameter)
        {
            string lReturn = "";

            if (pParamType == "H")
            {
                return lReturn;
            }

            if (pFormula1.Length > 0)
            {
                lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula1);
            }
            if (lReturn.Length == 0)
            {
                if (pFormula2.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula2);
                }

            }
            if (lReturn.Length == 0)
            {
                if (pFormula3.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula3);
                }

            }
            if (lReturn.Length > 0)
            {
                int? lMinVal = getParaValue(lReturn, 1);
                int? lMaxVal = getParaValue(lReturn, 2);
                if (lMinVal > 0)
                {
                    if (pParameter == "A") pItem.A = lMinVal;
                    if (pParameter == "B") pItem.B = lMinVal;
                    if (pParameter == "C") pItem.C = lMinVal;
                    if (pParameter == "D") pItem.D = lMinVal;
                    if (pParameter == "E") pItem.E = lMinVal;
                    if (pParameter == "F") pItem.F = lMinVal;
                    if (pParameter == "G") pItem.G = lMinVal;
                    if (pParameter == "H") pItem.H = lMinVal;
                    if (pParameter == "I") pItem.I = lMinVal;
                    if (pParameter == "J") pItem.J = lMinVal;
                    if (pParameter == "K") pItem.K = lMinVal;
                    if (pParameter == "L") pItem.L = lMinVal;
                    if (pParameter == "M") pItem.M = lMinVal;
                    if (pParameter == "N") pItem.N = lMinVal;
                    if (pParameter == "O") pItem.O = lMinVal;
                    if (pParameter == "P") pItem.P = lMinVal;
                    if (pParameter == "Q") pItem.Q = lMinVal;
                    if (pParameter == "R") pItem.R = lMinVal;
                    if (pParameter == "S") pItem.S = lMinVal;
                    if (pParameter == "T") pItem.T = lMinVal;
                    if (pParameter == "U") pItem.U = lMinVal;
                    if (pParameter == "V") pItem.V = lMinVal;
                    if (pParameter == "W") pItem.W = lMinVal;
                    if (pParameter == "X") pItem.X = lMinVal;
                    if (pParameter == "Y") pItem.Y = lMinVal;
                    if (pParameter == "Z") pItem.Z = lMinVal;
                }
                if (lMaxVal > 0)
                {
                    if (pParameter == "A") pItem.A2 = lMaxVal;
                    if (pParameter == "B") pItem.B2 = lMaxVal;
                    if (pParameter == "C") pItem.C2 = lMaxVal;
                    if (pParameter == "D") pItem.D2 = lMaxVal;
                    if (pParameter == "E") pItem.E2 = lMaxVal;
                    if (pParameter == "F") pItem.F2 = lMaxVal;
                    if (pParameter == "G") pItem.G2 = lMaxVal;
                    if (pParameter == "H") pItem.H2 = lMaxVal;
                    if (pParameter == "I") pItem.I2 = lMaxVal;
                    if (pParameter == "J") pItem.J2 = lMaxVal;
                    if (pParameter == "K") pItem.K2 = lMaxVal;
                    if (pParameter == "L") pItem.L2 = lMaxVal;
                    if (pParameter == "M") pItem.M2 = lMaxVal;
                    if (pParameter == "N") pItem.N2 = lMaxVal;
                    if (pParameter == "O") pItem.O2 = lMaxVal;
                    if (pParameter == "P") pItem.P2 = lMaxVal;
                    if (pParameter == "Q") pItem.Q2 = lMaxVal;
                    if (pParameter == "R") pItem.R2 = lMaxVal;
                    if (pParameter == "S") pItem.S2 = lMaxVal;
                    if (pParameter == "T") pItem.T2 = lMaxVal;
                    if (pParameter == "U") pItem.U2 = lMaxVal;
                    if (pParameter == "V") pItem.V2 = lMaxVal;
                    if (pParameter == "W") pItem.W2 = lMaxVal;
                    if (pParameter == "X") pItem.X2 = lMaxVal;
                    if (pParameter == "Y") pItem.Y2 = lMaxVal;
                    if (pParameter == "Z") pItem.Z2 = lMaxVal;
                }
            }

            return lReturn;
        }

        public void testDependValueHeight(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pPinSize, string pDia)
        {
            var lReturn = "";

            string[] lParameters = new string[] { };
            if (pShapeParam.shapeParameters != null)
            {
                lParameters = pShapeParam.shapeParameters.Split(',');
            }

            string[] lParType = new string[] { };
            if (pShapeParam.shapeParType != null)
            {
                lParType = pShapeParam.shapeParType.Split(',');
            }

            string[] lPardefvalue = new string[] { };
            if (pShapeParam.shapeDefaultValue != null)
            {
                lPardefvalue = pShapeParam.shapeDefaultValue.Split(',');
            }

            string[] lFormula1 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula1 != null)
            {
                lFormula1 = pShapeParam.shapeAutoCalcFormula1.Split(',');
            }

            string[] lFormula2 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula2 != null)
            {
                lFormula2 = pShapeParam.shapeAutoCalcFormula2.Split(',');
            }

            string[] lFormula3 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula3 != null)
            {
                lFormula3 = pShapeParam.shapeAutoCalcFormula3.Split(',');
            }

            if (lParameters.Length > 0)
            {
                for (int i = 0; i < lParameters.Length; i++)
                {
                    lReturn = testParamValueHeight(ref pItem, pShapeParam, lParType[i], lPardefvalue[i], pPinSize, pDia, lFormula1[i], lFormula2[i], lFormula3[i], lParameters[i]);
                }
            }

        }

        string testParamValueHeight(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pParamType, string pDefaultValue, string pPinSize, string pDia, string pFormula1, string pFormula2, string pFormula3, string pParameter)
        {
            string lReturn = "";

            if (pParamType == "V")
            {
                return lReturn;
            }

            if (pFormula1.Length > 0)
            {
                lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula1);
            }
            if (lReturn.Length == 0)
            {
                if (pFormula2.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula2);
                }

            }
            if (lReturn.Length == 0)
            {
                if (pFormula3.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula3);
                }

            }
            if (lReturn.Length > 0)
            {
                int? lMinVal = getParaValue(lReturn, 1);
                int? lMaxVal = getParaValue(lReturn, 2);
                if (lMinVal > 0)
                {
                    if (pParameter == "A") pItem.A = lMinVal;
                    if (pParameter == "B") pItem.B = lMinVal;
                    if (pParameter == "C") pItem.C = lMinVal;
                    if (pParameter == "D") pItem.D = lMinVal;
                    if (pParameter == "E") pItem.E = lMinVal;
                    if (pParameter == "F") pItem.F = lMinVal;
                    if (pParameter == "G") pItem.G = lMinVal;
                    if (pParameter == "H") pItem.H = lMinVal;
                    if (pParameter == "I") pItem.I = lMinVal;
                    if (pParameter == "J") pItem.J = lMinVal;
                    if (pParameter == "K") pItem.K = lMinVal;
                    if (pParameter == "L") pItem.L = lMinVal;
                    if (pParameter == "M") pItem.M = lMinVal;
                    if (pParameter == "N") pItem.N = lMinVal;
                    if (pParameter == "O") pItem.O = lMinVal;
                    if (pParameter == "P") pItem.P = lMinVal;
                    if (pParameter == "Q") pItem.Q = lMinVal;
                    if (pParameter == "R") pItem.R = lMinVal;
                    if (pParameter == "S") pItem.S = lMinVal;
                    if (pParameter == "T") pItem.T = lMinVal;
                    if (pParameter == "U") pItem.U = lMinVal;
                    if (pParameter == "V") pItem.V = lMinVal;
                    if (pParameter == "W") pItem.W = lMinVal;
                    if (pParameter == "X") pItem.X = lMinVal;
                    if (pParameter == "Y") pItem.Y = lMinVal;
                    if (pParameter == "Z") pItem.Z = lMinVal;
                }
                if (lMaxVal > 0)
                {
                    if (pParameter == "A") pItem.A2 = lMaxVal;
                    if (pParameter == "B") pItem.B2 = lMaxVal;
                    if (pParameter == "C") pItem.C2 = lMaxVal;
                    if (pParameter == "D") pItem.D2 = lMaxVal;
                    if (pParameter == "E") pItem.E2 = lMaxVal;
                    if (pParameter == "F") pItem.F2 = lMaxVal;
                    if (pParameter == "G") pItem.G2 = lMaxVal;
                    if (pParameter == "H") pItem.H2 = lMaxVal;
                    if (pParameter == "I") pItem.I2 = lMaxVal;
                    if (pParameter == "J") pItem.J2 = lMaxVal;
                    if (pParameter == "K") pItem.K2 = lMaxVal;
                    if (pParameter == "L") pItem.L2 = lMaxVal;
                    if (pParameter == "M") pItem.M2 = lMaxVal;
                    if (pParameter == "N") pItem.N2 = lMaxVal;
                    if (pParameter == "O") pItem.O2 = lMaxVal;
                    if (pParameter == "P") pItem.P2 = lMaxVal;
                    if (pParameter == "Q") pItem.Q2 = lMaxVal;
                    if (pParameter == "R") pItem.R2 = lMaxVal;
                    if (pParameter == "S") pItem.S2 = lMaxVal;
                    if (pParameter == "T") pItem.T2 = lMaxVal;
                    if (pParameter == "U") pItem.U2 = lMaxVal;
                    if (pParameter == "V") pItem.V2 = lMaxVal;
                    if (pParameter == "W") pItem.W2 = lMaxVal;
                    if (pParameter == "X") pItem.X2 = lMaxVal;
                    if (pParameter == "Y") pItem.Y2 = lMaxVal;
                    if (pParameter == "Z") pItem.Z2 = lMaxVal;
                }
            }

            return lReturn;
        }

        //       string calParamValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pParamType, string pDefaultValue, string pPinSize, string pDia, string pFormula1, string pFormula2, string pFormula3, string pParameter)
        //       {
        //           string lReturn = "";
        //           if (pFormula1.Length > 0)
        //           {
        //               lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula1);
        //           }
        //           if (lReturn.Length == 0)
        //           {
        //               if (pFormula2.Length > 0)
        //               {
        //                   lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula2);
        //               }

        //           }
        //           if (lReturn.Length == 0)
        //           {
        //               if (pFormula3.Length > 0)
        //               {
        //                   lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula3);
        //               }

        //           }
        //           if (lReturn.Length > 0)
        //           {
        //               int? lMinVal = getParaValue(lReturn, 1);
        //               int? lMaxVal = getParaValue(lReturn, 2);
        //               if (lMinVal > 0)
        //               {
        //                   if (pParameter == "A") pItem.A = lMinVal;
        //                   if (pParameter == "B") pItem.B = lMinVal;
        //                   if (pParameter == "C") pItem.C = lMinVal;
        //                   if (pParameter == "D") pItem.D = lMinVal;
        //                   if (pParameter == "E") pItem.E = lMinVal;
        //                   if (pParameter == "F") pItem.F = lMinVal;
        //                   if (pParameter == "G") pItem.G = lMinVal;
        //                   if (pParameter == "H") pItem.H = lMinVal;
        //                   if (pParameter == "I") pItem.I = lMinVal;
        //                   if (pParameter == "J") pItem.J = lMinVal;
        //                   if (pParameter == "K") pItem.K = lMinVal;
        //                   if (pParameter == "L") pItem.L = lMinVal;
        //                   if (pParameter == "M") pItem.M = lMinVal;
        //                   if (pParameter == "N") pItem.N = lMinVal;
        //                   if (pParameter == "O") pItem.O = lMinVal;
        //                   if (pParameter == "P") pItem.P = lMinVal;
        //                   if (pParameter == "Q") pItem.Q = lMinVal;
        //                   if (pParameter == "R") pItem.R = lMinVal;
        //                   if (pParameter == "S") pItem.S = lMinVal;
        //                   if (pParameter == "T") pItem.T = lMinVal;
        //                   if (pParameter == "U") pItem.U = lMinVal;
        //                   if (pParameter == "V") pItem.V = lMinVal;
        //                   if (pParameter == "W") pItem.W = lMinVal;
        //                   if (pParameter == "X") pItem.X = lMinVal;
        //                   if (pParameter == "Y") pItem.Y = lMinVal;
        //                   if (pParameter == "Z") pItem.Z = lMinVal;
        //               }
        //               if (lMaxVal > 0)
        //               {
        //                   if (pParameter == "A") pItem.A2 = lMaxVal;
        //                   if (pParameter == "B") pItem.B2 = lMaxVal;
        //                   if (pParameter == "C") pItem.C2 = lMaxVal;
        //                   if (pParameter == "D") pItem.D2 = lMaxVal;
        //                   if (pParameter == "E") pItem.E2 = lMaxVal;
        //                   if (pParameter == "F") pItem.F2 = lMaxVal;
        //                   if (pParameter == "G") pItem.G2 = lMaxVal;
        //                   if (pParameter == "H") pItem.H2 = lMaxVal;
        //                   if (pParameter == "I") pItem.I2 = lMaxVal;
        //                   if (pParameter == "J") pItem.J2 = lMaxVal;
        //                   if (pParameter == "K") pItem.K2 = lMaxVal;
        //                   if (pParameter == "L") pItem.L2 = lMaxVal;
        //                   if (pParameter == "M") pItem.M2 = lMaxVal;
        //                   if (pParameter == "N") pItem.N2 = lMaxVal;
        //                   if (pParameter == "O") pItem.O2 = lMaxVal;
        //                   if (pParameter == "P") pItem.P2 = lMaxVal;
        //                   if (pParameter == "Q") pItem.Q2 = lMaxVal;
        //                   if (pParameter == "R") pItem.R2 = lMaxVal;
        //                   if (pParameter == "S") pItem.S2 = lMaxVal;
        //                   if (pParameter == "T") pItem.T2 = lMaxVal;
        //                   if (pParameter == "U") pItem.U2 = lMaxVal;
        //                   if (pParameter == "V") pItem.V2 = lMaxVal;
        //                   if (pParameter == "W") pItem.W2 = lMaxVal;
        //                   if (pParameter == "X") pItem.X2 = lMaxVal;
        //                   if (pParameter == "Y") pItem.Y2 = lMaxVal;
        //                   if (pParameter == "Z") pItem.Z2 = lMaxVal;
        //               }
        //           }

        //           return lReturn;
        //       }

        string calFormula(OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pParamType, string pDefaultValue, string pPinSize, string pDia, string pFormula)
        {
            var lF = pFormula;
            var lResult = "";
            var lVarMax = 0;
            var lVarMin = 0;
            var lDefaultValue = 0;

            if (lF != null)
            {
                if (lF != "")
                {
                    int.TryParse(pDefaultValue, out lDefaultValue);

                    //Dia
                    if (lF.IndexOf("$") >= 0) lF = lF.Replace("$", pDia);
                    //Pin
                    int lPin = 0;
                    int.TryParse(pPinSize, out lPin);
                    lPin = lPin / 2;

                    if (lF.IndexOf("@") >= 0) lF = lF.Replace("@", lPin.ToString());

                    if (lF.IndexOf("A") >= 0) if (isNumber(pItem.A.ToString())) lF = lF.Replace("A", pItem.A.ToString()); else lF = lF.Replace("A", "0");
                    if (lF.IndexOf("B") >= 0) if (isNumber(pItem.B.ToString())) lF = lF.Replace("B", pItem.B.ToString()); else lF = lF.Replace("B", "0");
                    if (lF.IndexOf("C") >= 0) if (isNumber(pItem.C.ToString())) lF = lF.Replace("C", pItem.C.ToString()); else lF = lF.Replace("C", "0");
                    if (lF.IndexOf("D") >= 0) if (isNumber(pItem.D.ToString())) lF = lF.Replace("D", pItem.D.ToString()); else lF = lF.Replace("D", "0");
                    if (lF.IndexOf("E") >= 0) if (isNumber(pItem.E.ToString())) lF = lF.Replace("E", pItem.E.ToString()); else lF = lF.Replace("E", "0");
                    if (lF.IndexOf("F") >= 0) if (isNumber(pItem.F.ToString())) lF = lF.Replace("F", pItem.F.ToString()); else lF = lF.Replace("F", "0");
                    if (lF.IndexOf("G") >= 0) if (isNumber(pItem.G.ToString())) lF = lF.Replace("G", pItem.G.ToString()); else lF = lF.Replace("G", "0");
                    if (lF.IndexOf("H") >= 0) if (isNumber(pItem.H.ToString())) lF = lF.Replace("H", pItem.H.ToString()); else lF = lF.Replace("H", "0");
                    if (lF.IndexOf("I") >= 0) if (isNumber(pItem.I.ToString())) lF = lF.Replace("I", pItem.I.ToString()); else lF = lF.Replace("I", "0");
                    if (lF.IndexOf("J") >= 0) if (isNumber(pItem.J.ToString())) lF = lF.Replace("J", pItem.J.ToString()); else lF = lF.Replace("J", "0");
                    if (lF.IndexOf("K") >= 0) if (isNumber(pItem.K.ToString())) lF = lF.Replace("K", pItem.K.ToString()); else lF = lF.Replace("K", "0");
                    if (lF.IndexOf("L") >= 0) if (isNumber(pItem.L.ToString())) lF = lF.Replace("L", pItem.L.ToString()); else lF = lF.Replace("L", "0");
                    if (lF.IndexOf("M") >= 0) if (isNumber(pItem.M.ToString())) lF = lF.Replace("M", pItem.M.ToString()); else lF = lF.Replace("M", "0");
                    if (lF.IndexOf("N") >= 0) if (isNumber(pItem.N.ToString())) lF = lF.Replace("N", pItem.N.ToString()); else lF = lF.Replace("N", "0");
                    if (lF.IndexOf("O") >= 0) if (isNumber(pItem.O.ToString())) lF = lF.Replace("O", pItem.O.ToString()); else lF = lF.Replace("O", "0");
                    if (lF.IndexOf("P") >= 0) if (isNumber(pItem.P.ToString())) lF = lF.Replace("P", pItem.P.ToString()); else lF = lF.Replace("P", "0");
                    if (lF.IndexOf("Q") >= 0) if (isNumber(pItem.Q.ToString())) lF = lF.Replace("Q", pItem.Q.ToString()); else lF = lF.Replace("Q", "0");
                    if (lF.IndexOf("R") >= 0) if (isNumber(pItem.R.ToString())) lF = lF.Replace("R", pItem.R.ToString()); else lF = lF.Replace("R", "0");
                    if (lF.IndexOf("S") >= 0) if (isNumber(pItem.S.ToString())) lF = lF.Replace("S", pItem.S.ToString()); else lF = lF.Replace("S", "0");
                    if (lF.IndexOf("T") >= 0) if (isNumber(pItem.T.ToString())) lF = lF.Replace("T", pItem.T.ToString()); else lF = lF.Replace("T", "0");
                    if (lF.IndexOf("U") >= 0) if (isNumber(pItem.U.ToString())) lF = lF.Replace("U", pItem.U.ToString()); else lF = lF.Replace("U", "0");
                    if (lF.IndexOf("V") >= 0) if (isNumber(pItem.V.ToString())) lF = lF.Replace("V", pItem.V.ToString()); else lF = lF.Replace("V", "0");
                    if (lF.IndexOf("W") >= 0) if (isNumber(pItem.W.ToString())) lF = lF.Replace("W", pItem.W.ToString()); else lF = lF.Replace("W", "0");
                    if (lF.IndexOf("X") >= 0) if (isNumber(pItem.X.ToString())) lF = lF.Replace("X", pItem.X.ToString()); else lF = lF.Replace("X", "0");
                    if (lF.IndexOf("Y") >= 0) if (isNumber(pItem.Y.ToString())) lF = lF.Replace("Y", pItem.Y.ToString()); else lF = lF.Replace("Y", "0");
                    if (lF.IndexOf("Z") >= 0) if (isNumber(pItem.Z.ToString())) lF = lF.Replace("Z", pItem.Z.ToString()); else lF = lF.Replace("Z", "0");

                    if (lF.IndexOf("math.") >= 0)
                    {
                        lF = lF.Replace("math.", "");
                    }
                    //if (lF.IndexOf("pi") >= 0)
                    //{
                    //    lF = lF.Replace("pi", "3.1415926");
                    //}

                    //lF = lF.Replace("asin", "As~in");
                    //lF = lF.Replace("acos", "Ac~os");
                    //lF = lF.Replace("atan", "At~an");
                    //lF = lF.Replace("atan2", "At~an2");

                    //lF = lF.Replace("sin", "Sin");
                    //lF = lF.Replace("cos", "Cos");
                    //lF = lF.Replace("tan", "Tan");
                    //lF = lF.Replace("sqrt", "Sqrt");
                    //lF = lF.Replace("max", "Max");
                    //lF = lF.Replace("min", "Min");
                    //lF = lF.Replace("pow", "Pow");

                    //lF = lF.Replace("As~in", "Asin");
                    //lF = lF.Replace("Ac~os", "Acos");
                    //lF = lF.Replace("At~an", "Atan");
                    //lF = lF.Replace("At~an2", "Atan2");

                    //var lExp = new Expression(lF);
                    //if (!lExp.HasErrors())
                    //{
                    //    var lSResult = lExp.Evaluate().ToString();
                    //    if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                    //    int.TryParse(lSResult, out lVarMin);
                    //}

                    //lF = lF.Replace("(180/pi)*", "");
                    //lF = lF.Replace("180/pi*", "");
                    //lF = lF.Replace("(pi/180)*", "");
                    //lF = lF.Replace("pi/180*", "");


                    // MathParser parserObj = new MathParser();
                    bool isRadians = true;
                    try
                    {
                        //lVarMin = (int)Math.Round(parserObj.Parse(lF, isRadians), 0);
                    }
                    catch { }

                    if (pParamType == "V")
                    {
                        if (lDefaultValue > 90 && lVarMin < 90)
                        {
                            lVarMin = lVarMin + 90;
                        }
                    }

                    lF = pFormula;
                    //Dia
                    if (lF.IndexOf("$") >= 0) lF = lF.Replace("$", pDia);
                    //Pin
                    lPin = 0;
                    int.TryParse(pPinSize, out lPin);
                    lPin = lPin / 2;

                    if (lF.IndexOf("@") >= 0) lF = lF.Replace("@", lPin.ToString());

                    if (lF.IndexOf("A") >= 0) if (isNumber(pItem.A2.ToString())) lF = lF.Replace("A", pItem.A2.ToString()); else if (isNumber(pItem.A.ToString())) lF = lF.Replace("A", pItem.A.ToString()); else lF = lF.Replace("A", "0");
                    if (lF.IndexOf("B") >= 0) if (isNumber(pItem.B2.ToString())) lF = lF.Replace("B", pItem.B2.ToString()); else if (isNumber(pItem.B.ToString())) lF = lF.Replace("B", pItem.B.ToString()); else lF = lF.Replace("B", "0");
                    if (lF.IndexOf("C") >= 0) if (isNumber(pItem.C2.ToString())) lF = lF.Replace("C", pItem.C2.ToString()); else if (isNumber(pItem.C.ToString())) lF = lF.Replace("C", pItem.C.ToString()); else lF = lF.Replace("C", "0");
                    if (lF.IndexOf("D") >= 0) if (isNumber(pItem.D2.ToString())) lF = lF.Replace("D", pItem.D2.ToString()); else if (isNumber(pItem.D.ToString())) lF = lF.Replace("D", pItem.D.ToString()); else lF = lF.Replace("D", "0");
                    if (lF.IndexOf("E") >= 0) if (isNumber(pItem.E2.ToString())) lF = lF.Replace("E", pItem.E2.ToString()); else if (isNumber(pItem.E.ToString())) lF = lF.Replace("E", pItem.E.ToString()); else lF = lF.Replace("E", "0");
                    if (lF.IndexOf("F") >= 0) if (isNumber(pItem.F2.ToString())) lF = lF.Replace("F", pItem.F2.ToString()); else if (isNumber(pItem.F.ToString())) lF = lF.Replace("F", pItem.F.ToString()); else lF = lF.Replace("F", "0");
                    if (lF.IndexOf("G") >= 0) if (isNumber(pItem.G2.ToString())) lF = lF.Replace("G", pItem.G2.ToString()); else if (isNumber(pItem.G.ToString())) lF = lF.Replace("G", pItem.G.ToString()); else lF = lF.Replace("G", "0");
                    if (lF.IndexOf("H") >= 0) if (isNumber(pItem.H2.ToString())) lF = lF.Replace("H", pItem.H2.ToString()); else if (isNumber(pItem.H.ToString())) lF = lF.Replace("H", pItem.H.ToString()); else lF = lF.Replace("H", "0");
                    if (lF.IndexOf("I") >= 0) if (isNumber(pItem.I2.ToString())) lF = lF.Replace("I", pItem.I2.ToString()); else if (isNumber(pItem.I.ToString())) lF = lF.Replace("I", pItem.I.ToString()); else lF = lF.Replace("I", "0");
                    if (lF.IndexOf("J") >= 0) if (isNumber(pItem.J2.ToString())) lF = lF.Replace("J", pItem.J2.ToString()); else if (isNumber(pItem.J.ToString())) lF = lF.Replace("J", pItem.J.ToString()); else lF = lF.Replace("J", "0");
                    if (lF.IndexOf("K") >= 0) if (isNumber(pItem.K2.ToString())) lF = lF.Replace("K", pItem.K2.ToString()); else if (isNumber(pItem.K.ToString())) lF = lF.Replace("K", pItem.K.ToString()); else lF = lF.Replace("K", "0");
                    if (lF.IndexOf("L") >= 0) if (isNumber(pItem.L2.ToString())) lF = lF.Replace("L", pItem.L2.ToString()); else if (isNumber(pItem.L.ToString())) lF = lF.Replace("L", pItem.L.ToString()); else lF = lF.Replace("L", "0");
                    if (lF.IndexOf("M") >= 0) if (isNumber(pItem.M2.ToString())) lF = lF.Replace("M", pItem.M2.ToString()); else if (isNumber(pItem.M.ToString())) lF = lF.Replace("M", pItem.M.ToString()); else lF = lF.Replace("M", "0");
                    if (lF.IndexOf("N") >= 0) if (isNumber(pItem.N2.ToString())) lF = lF.Replace("N", pItem.N2.ToString()); else if (isNumber(pItem.N.ToString())) lF = lF.Replace("N", pItem.N.ToString()); else lF = lF.Replace("N", "0");
                    if (lF.IndexOf("O") >= 0) if (isNumber(pItem.O2.ToString())) lF = lF.Replace("O", pItem.O2.ToString()); else if (isNumber(pItem.O.ToString())) lF = lF.Replace("O", pItem.O.ToString()); else lF = lF.Replace("O", "0");
                    if (lF.IndexOf("P") >= 0) if (isNumber(pItem.P2.ToString())) lF = lF.Replace("P", pItem.P2.ToString()); else if (isNumber(pItem.P.ToString())) lF = lF.Replace("P", pItem.P.ToString()); else lF = lF.Replace("P", "0");
                    if (lF.IndexOf("Q") >= 0) if (isNumber(pItem.Q2.ToString())) lF = lF.Replace("Q", pItem.Q2.ToString()); else if (isNumber(pItem.Q.ToString())) lF = lF.Replace("Q", pItem.Q.ToString()); else lF = lF.Replace("Q", "0");
                    if (lF.IndexOf("R") >= 0) if (isNumber(pItem.R2.ToString())) lF = lF.Replace("R", pItem.R2.ToString()); else if (isNumber(pItem.R.ToString())) lF = lF.Replace("R", pItem.R.ToString()); else lF = lF.Replace("R", "0");
                    if (lF.IndexOf("S") >= 0) if (isNumber(pItem.S2.ToString())) lF = lF.Replace("S", pItem.S2.ToString()); else if (isNumber(pItem.S.ToString())) lF = lF.Replace("S", pItem.S.ToString()); else lF = lF.Replace("S", "0");
                    if (lF.IndexOf("T") >= 0) if (isNumber(pItem.T2.ToString())) lF = lF.Replace("T", pItem.T2.ToString()); else if (isNumber(pItem.T.ToString())) lF = lF.Replace("T", pItem.T.ToString()); else lF = lF.Replace("T", "0");
                    if (lF.IndexOf("U") >= 0) if (isNumber(pItem.U2.ToString())) lF = lF.Replace("U", pItem.U2.ToString()); else if (isNumber(pItem.U.ToString())) lF = lF.Replace("U", pItem.U.ToString()); else lF = lF.Replace("U", "0");
                    if (lF.IndexOf("V") >= 0) if (isNumber(pItem.V2.ToString())) lF = lF.Replace("V", pItem.V2.ToString()); else if (isNumber(pItem.V.ToString())) lF = lF.Replace("V", pItem.V.ToString()); else lF = lF.Replace("V", "0");
                    if (lF.IndexOf("W") >= 0) if (isNumber(pItem.W2.ToString())) lF = lF.Replace("W", pItem.W2.ToString()); else if (isNumber(pItem.W.ToString())) lF = lF.Replace("W", pItem.W.ToString()); else lF = lF.Replace("W", "0");
                    if (lF.IndexOf("X") >= 0) if (isNumber(pItem.X2.ToString())) lF = lF.Replace("X", pItem.X2.ToString()); else if (isNumber(pItem.X.ToString())) lF = lF.Replace("X", pItem.X.ToString()); else lF = lF.Replace("X", "0");
                    if (lF.IndexOf("Y") >= 0) if (isNumber(pItem.Y2.ToString())) lF = lF.Replace("Y", pItem.Y2.ToString()); else if (isNumber(pItem.Y.ToString())) lF = lF.Replace("Y", pItem.Y.ToString()); else lF = lF.Replace("Y", "0");
                    if (lF.IndexOf("Z") >= 0) if (isNumber(pItem.Z2.ToString())) lF = lF.Replace("Z", pItem.Z2.ToString()); else if (isNumber(pItem.Z.ToString())) lF = lF.Replace("Z", pItem.Z.ToString()); else lF = lF.Replace("Z", "0");

                    if (lF.IndexOf("math.") >= 0)
                    {
                        lF = lF.Replace("math.", "");
                    }

                    //if (lF.IndexOf("pi") >= 0)
                    //{
                    //    lF = lF.Replace("pi", "3.1415926");
                    //}

                    //lF = lF.Replace("asin", "As~in");
                    //lF = lF.Replace("acos", "Ac~os");
                    //lF = lF.Replace("atan", "At~an");
                    //lF = lF.Replace("atan2", "At~an2");

                    //lF = lF.Replace("sin", "Sin");
                    //lF = lF.Replace("cos", "Cos");
                    //lF = lF.Replace("tan", "Tan");
                    //lF = lF.Replace("sqrt", "Sqrt");
                    //lF = lF.Replace("max", "Max");
                    //lF = lF.Replace("min", "Min");
                    //lF = lF.Replace("pow", "Pow");

                    //lF = lF.Replace("As~in", "Asin");
                    //lF = lF.Replace("Ac~os", "Acos");
                    //lF = lF.Replace("At~an", "Atan");
                    //lF = lF.Replace("At~an2", "Atan2");

                    //lExp = new Expression(lF);
                    //if (!lExp.HasErrors())
                    //{
                    //    var lSResult = lExp.Evaluate().ToString();
                    //    if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                    //    int.TryParse(lSResult, out lVarMax);
                    //}

                    //lF = lF.Replace("(180/pi)*", "");
                    //lF = lF.Replace("180/pi*", "");


                    //parserObj = new MathParser();
                    isRadians = true;
                    //var lSResult = parserObj.Parse(lF, isRadians).ToString();
                    //if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                    //int.TryParse(lSResult, out lVarMin);
                    try
                    {
                        // lVarMax = (int)Math.Round(parserObj.Parse(lF, isRadians), 0);
                    }
                    catch { }

                    // parserObj = null;

                    if (pParamType == "V")
                    {
                        if (lDefaultValue > 90 && lVarMax < 90)
                        {
                            lVarMax = lVarMax + 90;
                        }
                    }

                    if (lVarMin == lVarMax && lVarMin == 0)
                    {
                        lResult = "";
                    }
                    else if (lVarMin == lVarMax && lVarMin > 0)
                    {
                        lResult = lVarMax.ToString();
                    }
                    else if (lVarMax == 0)
                    {
                        lResult = lVarMin.ToString();
                    }
                    else
                    {
                        lResult = lVarMin.ToString() + "-" + lVarMax.ToString();
                    }
                }
            }
            return lResult;
        }

        bool isNumber(string pInput)
        {
            int lValue = 0;
            bool lReturn = int.TryParse(pInput, out lValue);
            return lReturn;
        }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult checkOrderStatus(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lCheckBar = (from p in db.OrderDetails
        //                            where p.CustomerCode == CustomerCode &&
        //                            p.ProjectCode == ProjectCode &&
        //                            p.JobID == JobID &&
        //                            p.BarShapeCode != null &&
        //                            p.BarShapeCode != "" &&
        //                            p.UpdateBy != User.Identity.Name
        //                            select p).ToList();

        //           var lCheckBBS = (from p in db.BBS
        //                            where p.CustomerCode == CustomerCode &&
        //                            p.ProjectCode == ProjectCode &&
        //                            p.JobID == JobID &&
        //                            p.BBSNo != null &&
        //                            p.BBSNo != "" &&
        //                            p.UpdateBy != User.Identity.Name
        //                            select p).ToList();

        //           var lCheckJob = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

        //           if (lCheckJob == null || (lCheckJob.OrderStatus != "New" && lCheckJob.OrderStatus != "Created") ||
        //               lCheckBar.Count > 0 ||
        //               lCheckBBS.Count > 0 ||
        //               (((lCheckJob.TotalWeight != null && lCheckJob.TotalWeight > 0) ||
        //               (lCheckJob.PONumber != null && lCheckJob.PONumber != ""))
        //               && lCheckJob.UpdateBy != User.Identity.GetUserName()))
        //           {
        //               string lUserNameCur = User.Identity.GetUserName();
        //               string lSubmissionCur = "No";
        //               string lEditableCur = "No";
        //               string lUserTypeCur = "PL";

        //               string lUserNamePre = lCheckJob.UpdateBy;
        //               string lSubmissionPre = "No";
        //               string lEditablePre = "No";
        //               string lUserTypePre = "PL";

        //               var lAccess = db.UserAccess.Find(lUserNameCur, "0000000000", "0000000000");
        //               if (lAccess != null)
        //               {
        //                   lUserTypeCur = (lAccess.UserType == null ? "CU" : lAccess.UserType.Trim());
        //               }

        //               lAccess = db.UserAccess.Find(lUserNamePre, "0000000000", "0000000000");
        //               if (lAccess != null)
        //               {
        //                   lUserTypePre = (lAccess.UserType == null ? "CU" : lAccess.UserType.Trim());
        //               }

        //               lAccess = db.UserAccess.Find(lUserNameCur, CustomerCode, ProjectCode);
        //               if (lAccess != null)
        //               {
        //                   lSubmissionCur = (lAccess.OrderSubmission == null ? "No" : lAccess.OrderSubmission.Trim());

        //                   lEditableCur = (lAccess.OrderCreation == null ? "No" : lAccess.OrderCreation.Trim());
        //               }
        //               lAccess = db.UserAccess.Find(lUserNamePre, CustomerCode, ProjectCode);
        //               if (lAccess != null)
        //               {
        //                   lSubmissionPre = (lAccess.OrderSubmission == null ? "No" : lAccess.OrderSubmission.Trim());

        //                   lEditablePre = (lAccess.OrderCreation == null ? "No" : lAccess.OrderCreation.Trim());
        //               }

        //               if ((lUserTypeCur == "CU" || lUserTypeCur == "CM" || lUserTypeCur == "CA") &&
        //               ((lUserTypePre == "CU" || lUserTypePre == "CM" || lUserTypePre == "CA") &&
        //               (lSubmissionPre != "Yes" && lSubmissionCur == "Yes") ||
        //               lEditableCur != "Yes" || lEditablePre != "Yes"))
        //               {
        //                   return Json(new { success = true, error = false, message = lCheckJob.UpdateBy }, JsonRequestBehavior.AllowGet);
        //               }
        //               else
        //               {
        //                   return Json(new
        //                   {
        //                       success = false,
        //                       error = true,
        //                       message = "The order has been processed by another person. Please click <New Order> button to create a new order."
        //                   }, JsonRequestBehavior.AllowGet);
        //               }

        //           }
        //           else
        //           {
        //               return Json(new { success = true, error = false, message = lCheckJob.UpdateBy }, JsonRequestBehavior.AllowGet);
        //           }
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public async Task<ActionResult> OrderExcelImport(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           try
        //           {
        //               string[] lStruEleList = { "BEAM", "COLUMN", "SLAB", "DWALL", "DRAIN", "PILE", "WALL", "MISC", "SLAB-B", "SLAB-T", "FDN1" };
        //               string lUserType = "";
        //               string lTotalWt = "0";

        //               string lDigiOSPONo = "";
        //               string lExcelPONo = "";
        //               string lRetPONo = "";

        //               var lDigiOSBBSNos = new List<string>();
        //               var lExcelBBSNos = new List<string>();
        //               var lRetBBSNo = "";

        //               if (gUserType != null && gUserType != "")
        //               {
        //                   lUserType = gUserType;
        //               }
        //               else
        //               {
        //                   UserAccessController lUa = new UserAccessController();
        //                   lUserType = lUa.getUserType(User.Identity.GetUserName());
        //                   ViewBag.UserType = lUserType;
        //                   lUa = null;
        //               }

        //               HttpPostedFileBase file = Request.Files["OrderExcelImport"];

        //               if (file.ContentLength > 0 && (Path.GetExtension(file.FileName).ToLower() == ".xlsx" || Path.GetExtension(file.FileName).ToLower() == ".xlsm"))
        //               {
        //                   MemoryStream lStream = new MemoryStream();
        //                   file.InputStream.CopyTo(lStream);
        //                   ExcelPackage package = new ExcelPackage(lStream);

        //                   ExcelWorksheet workSheet;
        //                   // = package.Workbook.Worksheets.FirstOrDefault(f => f.View.TabSelected);
        //                   DataTable lDataTable = new DataTable();

        //                   if (Path.GetExtension(file.FileName).ToLower() == ".xlsx" || Path.GetExtension(file.FileName).ToLower() == ".xlsm")
        //                   {
        //                       if (package.Workbook.Worksheets.Count > 1)
        //                       {

        //                           for (int i = 1; i <= package.Workbook.Worksheets.Count; i++)
        //                           {
        //                               if (package.Workbook.Worksheets[i].Name == "OrderSummary")
        //                               {

        //                                   //delete order
        //                                   var lOrderDet = (from p in db.OrderDetails
        //                                                    where p.CustomerCode == CustomerCode &&
        //                                                    p.ProjectCode == ProjectCode &&
        //                                                    p.JobID == JobID
        //                                                    select p);
        //                                   db.OrderDetails.RemoveRange(lOrderDet);

        //                                   var lBBSDet = (from p in db.BBS
        //                                                  where p.CustomerCode == CustomerCode &&
        //                                                  p.ProjectCode == ProjectCode &&
        //                                                  p.JobID == JobID
        //                                                  select p);
        //                                   if (lBBSDet != null)
        //                                   {
        //                                       foreach (var lBBSRec in lBBSDet)
        //                                       {
        //                                           if (lBBSRec.BBSNo != null)
        //                                           {
        //                                               lDigiOSBBSNos.Add(lBBSRec.BBSNo);
        //                                           }
        //                                       }
        //                                   }
        //                                   db.BBS.RemoveRange(lBBSDet);
        //                                   db.SaveChanges();

        //                                   string lPONo = package.Workbook.Worksheets[i].Cells[8, 3].Text == null ? "" : package.Workbook.Worksheets[i].Cells[8, 3].Text.ToString();
        //                                   if (lPONo == null)
        //                                   {
        //                                       lPONo = "";
        //                                   }
        //                                   lExcelPONo = lPONo;
        //                                   if (lPONo.Length > 35)
        //                                   {
        //                                       lPONo = lPONo.Substring(0, 35);
        //                                   }

        //                                   string lPODate = package.Workbook.Worksheets[i].Cells[9, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[9, 3].Value.ToString();
        //                                   string lReqDate = package.Workbook.Worksheets[i].Cells[10, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[10, 3].Value.ToString();
        //                                   DateTime lPODateDT = DateTime.Now;
        //                                   DateTime lReqDateDT = DateTime.Now;

        //                                   DateTime.TryParse(lPODate, out lPODateDT);
        //                                   DateTime.TryParse(lReqDate, out lReqDateDT);

        //                                   DateTime? lReqDateDTLast = lReqDateDT;

        //                                   if (lPODateDT < new DateTime(2000, 1, 1))
        //                                   {
        //                                       lPODateDT = DateTime.Now;
        //                                   }

        //                                   if (lReqDateDT < new DateTime(2000, 1, 1))
        //                                   {
        //                                       lReqDateDTLast = null;
        //                                   }

        //                                   lTotalWt = package.Workbook.Worksheets[i].Cells[8, 10].Value == null ? "0" : package.Workbook.Worksheets[i].Cells[8, 10].Value.ToString();

        //                                   //string lWBS1 = package.Workbook.Worksheets[i].Cells[15, 2].Text.ToString();
        //                                   //string lWBS2 = package.Workbook.Worksheets[i].Cells[15, 3].Text.ToString();
        //                                   //string lWBS3 = package.Workbook.Worksheets[i].Cells[15, 4].Text.ToString();

        //                                   string lWBS1 = "";
        //                                   string lWBS2 = "";
        //                                   string lWBS3 = "";

        //                                   //string lStage = package.Workbook.Worksheets[i].Cells[15, 6].Value.ToString();
        //                                   string lStage = "TYP";

        //                                   var oldJobAdvice = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //                                   if (oldJobAdvice != null)
        //                                   {
        //                                       var lNewJob = oldJobAdvice;
        //                                       //lNewJob.PONumber = lPONo;
        //                                       //lNewJob.PODate = lPODateDT;
        //                                       //lNewJob.RequiredDate = lReqDateDTLast;
        //                                       //lNewJob.WBS1 = lWBS1;
        //                                       //lNewJob.WBS2 = lWBS2;
        //                                       //lNewJob.WBS3 = lWBS3;
        //                                       lNewJob.ProjectStage = lStage;
        //                                       //lNewJob.Scheduler_Name = package.Workbook.Worksheets[i].Cells[6, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString();
        //                                       //lNewJob.Scheduler_HP = package.Workbook.Worksheets[i].Cells[6, 5].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString();
        //                                       //lNewJob.Scheduler_Tel = package.Workbook.Worksheets[i].Cells[6, 8].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString();
        //                                       //lNewJob.SiteEngr_Name = package.Workbook.Worksheets[i].Cells[5, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString();
        //                                       //lNewJob.SiteEngr_HP = package.Workbook.Worksheets[i].Cells[5, 5].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString();
        //                                       //lNewJob.SiteEngr_Tel = package.Workbook.Worksheets[i].Cells[5, 8].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString();
        //                                       lNewJob.UpdateDate = DateTime.Now;
        //                                       lNewJob.UpdateBy = User.Identity.GetUserName();
        //                                       lNewJob.OrderSource = "UXE";

        //                                       db.Entry(oldJobAdvice).CurrentValues.SetValues(lNewJob);

        //                                       db.SaveChanges();
        //                                   }

        //                                   //update header and SE
        //                                   var lOrderSE = (from p in db.OrderProjectSE
        //                                                   join m in db.OrderProject
        //                                                  on p.OrderNumber equals m.OrderNumber
        //                                                   where m.CustomerCode == CustomerCode &&
        //                                                   m.ProjectCode == ProjectCode &&
        //                                                   p.CABJobID == JobID
        //                                                   select new
        //                                                   {
        //                                                       p.OrderNumber,
        //                                                       p.StructureElement,
        //                                                       p.ProductType,
        //                                                       p.PONumber,
        //                                                       p.RequiredDate,
        //                                                       p.ScheduledProd
        //                                                   }
        //                                                   ).ToList();

        //                                   if (lOrderSE == null || lOrderSE.Count == 0)
        //                                   {
        //                                       return Json(new
        //                                       {
        //                                           success = false,
        //                                           error = true,
        //                                           message = "Import Error: Cannot find order number"
        //                                       }, JsonRequestBehavior.AllowGet);

        //                                   }

        //                                   var lOrderno = lOrderSE[0].OrderNumber;
        //                                   var lStrucEle = lOrderSE[0].StructureElement;
        //                                   var lProdType = lOrderSE[0].ProductType;
        //                                   string lScheduled = lOrderSE[0].ScheduledProd;

        //                                   if (lScheduled == null || lScheduled == "")
        //                                   {
        //                                       lScheduled = "N";
        //                                   }

        //                                   lDigiOSPONo = lOrderSE[0].PONumber;

        //                                   if (lDigiOSPONo == null || lDigiOSPONo == "")
        //                                   {
        //                                       lDigiOSPONo = "";
        //                                   }

        //                                   var lOrderHeader = db.OrderProject.Find(lOrderno);
        //                                   var lNewHeader = lOrderHeader;

        //                                   //var lOrderHeaderSE = db.OrderProjectSE.Find(lOrderno, lStrucEle, lProdType, lScheduled);
        //                                   //var lNewSE = lOrderHeaderSE;

        //                                   lNewHeader.OrderSource = "UXE";
        //                                   lNewHeader.UpdateDate = DateTime.Now;
        //                                   lNewHeader.UpdateBy = User.Identity.GetUserName();

        //                                   //if ((lNewHeader.PONumber == null || lNewHeader.PONumber == "")
        //                                   //    && lPONo != null && lPONo != "")
        //                                   //{
        //                                   //    lNewHeader.PONumber = lPONo;
        //                                   //    lNewSE.PONumber = lPONo;
        //                                   //}

        //                                   //if (lNewHeader.PODate == null && lPONo != null)
        //                                   //{
        //                                   //    lNewHeader.PODate = lPODateDT;
        //                                   //    lNewSE.PODate = lPODateDT;
        //                                   //}

        //                                   //if (lNewHeader.RequiredDate == null && lReqDateDT != null)
        //                                   //{
        //                                   //    lNewHeader.RequiredDate = lReqDateDTLast;
        //                                   //    lNewSE.RequiredDate = lReqDateDTLast;
        //                                   //}

        //                                   //if ((lNewHeader.Scheduler_Name == null || lNewHeader.Scheduler_Name == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 3].Text != null 
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString() != "")
        //                                   //{
        //                                   //    lNewHeader.Scheduler_Name = package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString();
        //                                   //}
        //                                   //if ((lNewHeader.Scheduler_HP == null || lNewHeader.Scheduler_HP == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 5].Text != null
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString() != "")
        //                                   //{
        //                                   //    lNewHeader.Scheduler_HP = package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString();
        //                                   //}
        //                                   //if ((lNewHeader.Scheduler_Email == null || lNewHeader.Scheduler_Email == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 8].Text != null
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString() != ""
        //                                   //    && package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString().IndexOf("@") > 0)
        //                                   //{
        //                                   //    lNewHeader.Scheduler_Email = package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString();
        //                                   //}
        //                                   //if ((lNewHeader.SiteEngr_Name == null || lNewHeader.SiteEngr_Name == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 3].Text != null
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString() != "")
        //                                   //{
        //                                   //    lNewHeader.SiteEngr_Name = package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString();
        //                                   //}
        //                                   //if ((lNewHeader.SiteEngr_HP == null || lNewHeader.SiteEngr_HP == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 5].Text != null
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString() != "")
        //                                   //{
        //                                   //    lNewHeader.SiteEngr_HP = package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString();
        //                                   //}
        //                                   //if ((lNewHeader.SiteEngr_Email == null || lNewHeader.SiteEngr_Email == "")
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 8].Text != null
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString() != "" 
        //                                   //    && package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString().IndexOf("@") > 0)
        //                                   //{
        //                                   //    lNewHeader.SiteEngr_Email = package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString();
        //                                   //}

        //                                   db.Entry(lOrderHeader).CurrentValues.SetValues(lNewHeader);

        //                                   //db.Entry(lOrderHeaderSE).CurrentValues.SetValues(lNewSE);

        //                                   db.SaveChanges();

        //                                   int lBBSID = 1;
        //                                   int lSpace = 0;

        //                                   for (int j = 1; j < package.Workbook.Worksheets.Count; j++)
        //                                   {
        //                                       string lBBS = "";
        //                                       string lBBSOri = "";
        //                                       if (package.Workbook.Worksheets[i].Dimension.End.Row >= 18 + j
        //                                           && package.Workbook.Worksheets[i].Dimension.End.Column >= 2
        //                                           && package.Workbook.Worksheets[i].Cells[18 + j, 2].Value != null)
        //                                       {
        //                                           lBBS = package.Workbook.Worksheets[i].Cells[18 + j, 2].Value.ToString();
        //                                           if (lBBS == null)
        //                                           {
        //                                               lBBS = "";
        //                                           }
        //                                           lBBSOri = lBBS;

        //                                           lBBS = lBBS.Replace(";", "");
        //                                           lBBS = lBBS.Replace("~", "");
        //                                           lBBS = lBBS.Replace("!", "");
        //                                           lBBS = lBBS.Replace("@", "");
        //                                           lBBS = lBBS.Replace("?", "");
        //                                           lBBS = lBBS.Replace("'", "");
        //                                           lBBS = lBBS.Replace("^", "");
        //                                           lBBS = lBBS.Replace("\\", "");
        //                                           lBBS = lBBS.Replace("\"", "");
        //                                           lBBS = lBBS.Replace("|", "");
        //                                           lBBS = lBBS.Replace(":", "");
        //                                           lBBS = lBBS.Replace(">", "");
        //                                           lBBS = lBBS.Replace("<", "");
        //                                           lBBS = lBBS.Replace("=", "");
        //                                           lBBS = lBBS.Replace("#", "");
        //                                           lBBS = lBBS.Replace("+", "");
        //                                           lBBS = lBBS.Replace("$", "");
        //                                           lBBS = lBBS.Replace("`", "");
        //                                           lBBS = lBBS.Replace("%", "");

        //                                           if (lBBS.Length > 14)
        //                                           {
        //                                               lBBS = lBBS.Substring(0, 14);
        //                                           }
        //                                           var lBBSDesc = "";
        //                                           if (package.Workbook.Worksheets[i].Cells[18 + j, 3].Value != null)
        //                                           {
        //                                               lBBSDesc = package.Workbook.Worksheets[i].Cells[18 + j, 3].Value.ToString();
        //                                           }

        //                                           if (lBBSDesc == null)
        //                                           {
        //                                               lBBSDesc = "";
        //                                           }
        //                                           lBBSDesc = lBBSDesc.Replace(";", "");
        //                                           lBBSDesc = lBBSDesc.Replace("~", "");
        //                                           lBBSDesc = lBBSDesc.Replace("!", "");
        //                                           lBBSDesc = lBBSDesc.Replace("@", "");
        //                                           lBBSDesc = lBBSDesc.Replace("?", "");
        //                                           lBBSDesc = lBBSDesc.Replace("'", "");
        //                                           lBBSDesc = lBBSDesc.Replace("^", "");
        //                                           lBBSDesc = lBBSDesc.Replace("\\", "");
        //                                           lBBSDesc = lBBSDesc.Replace("\"", "");
        //                                           lBBSDesc = lBBSDesc.Replace("|", "");
        //                                           lBBSDesc = lBBSDesc.Replace(":", "");
        //                                           lBBSDesc = lBBSDesc.Replace(">", "");
        //                                           lBBSDesc = lBBSDesc.Replace("<", "");
        //                                           lBBSDesc = lBBSDesc.Replace("=", "");
        //                                           lBBSDesc = lBBSDesc.Replace("#", "");
        //                                           lBBSDesc = lBBSDesc.Replace("+", "");
        //                                           lBBSDesc = lBBSDesc.Replace("$", "");
        //                                           lBBSDesc = lBBSDesc.Replace("`", "");
        //                                           lBBSDesc = lBBSDesc.Replace("%", "");

        //                                           if (lBBSDesc.Length > 30)
        //                                           {
        //                                               lBBSDesc = lBBSDesc.Substring(0, 30);
        //                                           }

        //                                           var lStrEle = lStrucEle;

        //                                           //if (package.Workbook.Worksheets[i].Cells[18 + j, 8].Value != null)
        //                                           //{
        //                                           //    lStrEle = package.Workbook.Worksheets[i].Cells[18 + j, 8].Value.ToString();
        //                                           //}

        //                                           //if (!lStruEleList.Contains(lStrEle))
        //                                           //{
        //                                           //    lStrEle = "BEAM";
        //                                           //}

        //                                           if (lBBSOri != null && lBBSOri != "" && package.Workbook.Worksheets["OrderDetail-" + lBBSOri] != null)
        //                                           {
        //                                               workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBSOri];

        //                                               var lNewBBS = new BBSModels();

        //                                               var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
        //                                               if (oldBBS == null)
        //                                               {
        //                                                   lNewBBS.CustomerCode = CustomerCode;
        //                                                   lNewBBS.ProjectCode = ProjectCode;
        //                                                   lNewBBS.JobID = JobID;
        //                                                   lNewBBS.BBSID = lBBSID;
        //                                                   lNewBBS.BBSNo = lBBS;
        //                                                   lNewBBS.BBSDesc = lBBSDesc;
        //                                                   lNewBBS.BBSStrucElem = lStrEle;
        //                                                   lNewBBS.UpdateDate = DateTime.Now;
        //                                                   lNewBBS.UpdateBy = User.Identity.GetUserName();

        //                                                   db.BBS.Add(lNewBBS);
        //                                               }
        //                                               else
        //                                               {
        //                                                   lNewBBS = oldBBS;
        //                                                   lNewBBS.BBSNo = lBBS;
        //                                                   lNewBBS.BBSDesc = lBBSDesc;
        //                                                   lNewBBS.BBSStrucElem = lStrEle;
        //                                                   lNewBBS.UpdateDate = DateTime.Now;
        //                                                   lNewBBS.UpdateBy = User.Identity.GetUserName();

        //                                                   db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
        //                                               }
        //                                               db.SaveChanges();

        //                                               lExcelBBSNos.Add(lBBSOri);

        //                                               var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, lBBSID, workSheet);
        //                                               lBBSID = lBBSID + 1;

        //                                           }
        //                                       }
        //                                       else
        //                                       {
        //                                           lSpace = lSpace + 1;
        //                                           if (lSpace > 5)
        //                                           {
        //                                               break;
        //                                           }
        //                                       }
        //                                       if (j >= 100)
        //                                       {
        //                                           break;
        //                                       }
        //                                   }

        //                                   if (lBBSID <= 1)
        //                                   {
        //                                       lBBSID = 1;
        //                                       lSpace = 0;

        //                                       for (int j = 1; j <= package.Workbook.Worksheets.Count; j++)
        //                                       {
        //                                           string lBBS = "";
        //                                           string lBBSOri = "";
        //                                           if (package.Workbook.Worksheets[j].Name != null
        //                                               && package.Workbook.Worksheets[j].Name.Length >= 12
        //                                               && package.Workbook.Worksheets[j].Name.ToUpper().Trim().Substring(0, 11) == "ORDERDETAIL")
        //                                           {
        //                                               lBBS = package.Workbook.Worksheets[j].Name.ToUpper().Substring(12);
        //                                               if (lBBS == null)
        //                                               {
        //                                                   lBBS = "";
        //                                               }
        //                                               lBBSOri = lBBS;
        //                                               if (lBBS.Length > 14)
        //                                               {
        //                                                   lBBS = lBBS.Substring(0, 14);
        //                                               }
        //                                               var lBBSDesc = "";

        //                                               var lStrEle = lStrucEle;

        //                                               //if (package.Workbook.Worksheets[i].Cells[18 + j, 8].Value != null)
        //                                               //{
        //                                               //    lStrEle = package.Workbook.Worksheets[i].Cells[18 + j, 8].Value.ToString();
        //                                               //}

        //                                               //if (!lStruEleList.Contains(lStrEle))
        //                                               //{
        //                                               //    lStrEle = "BEAM";
        //                                               //}

        //                                               workSheet = package.Workbook.Worksheets[j];

        //                                               var lNewBBS = new BBSModels();

        //                                               var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
        //                                               if (oldBBS == null)
        //                                               {
        //                                                   lNewBBS.CustomerCode = CustomerCode;
        //                                                   lNewBBS.ProjectCode = ProjectCode;
        //                                                   lNewBBS.JobID = JobID;
        //                                                   lNewBBS.BBSID = lBBSID;
        //                                                   lNewBBS.BBSNo = lBBS;
        //                                                   lNewBBS.BBSDesc = lBBSDesc;
        //                                                   lNewBBS.BBSStrucElem = lStrEle;
        //                                                   lNewBBS.UpdateDate = DateTime.Now;
        //                                                   lNewBBS.UpdateBy = User.Identity.GetUserName();

        //                                                   db.BBS.Add(lNewBBS);
        //                                               }
        //                                               else
        //                                               {
        //                                                   lNewBBS = oldBBS;
        //                                                   lNewBBS.BBSNo = lBBS;
        //                                                   lNewBBS.BBSDesc = lBBSDesc;
        //                                                   lNewBBS.BBSStrucElem = lStrEle;
        //                                                   lNewBBS.UpdateDate = DateTime.Now;
        //                                                   lNewBBS.UpdateBy = User.Identity.GetUserName();

        //                                                   db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
        //                                               }
        //                                               db.SaveChanges();

        //                                               lExcelBBSNos.Add(lBBSOri);

        //                                               var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, lBBSID, workSheet);
        //                                               lBBSID = lBBSID + 1;

        //                                           }
        //                                           else
        //                                           {
        //                                               lSpace = lSpace + 1;
        //                                               if (lSpace > 30)
        //                                               {
        //                                                   break;
        //                                               }
        //                                           }
        //                                           if (j >= 100)
        //                                           {
        //                                               break;
        //                                           }
        //                                       }

        //                                   }

        //                                   checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);

        //                                   break;
        //                               }

        //                           }
        //                       }
        //                   }
        //               }

        //               if (lDigiOSPONo != "" && lExcelPONo != "" && lDigiOSPONo.ToUpper().Trim() != lExcelPONo.ToUpper().Trim())
        //               {
        //                   lRetPONo = lDigiOSPONo + ", " + lExcelPONo;
        //               }

        //               if (lDigiOSBBSNos.Count > 0 && lExcelBBSNos.Count > 0)
        //               {
        //                   for (int i = 0; i < lExcelBBSNos.Count; i++)
        //                   {
        //                       if (i < lDigiOSBBSNos.Count)
        //                       {
        //                           if (lDigiOSBBSNos[i] != "" && lExcelBBSNos[i] != "")
        //                           {
        //                               if (lDigiOSBBSNos[i].ToUpper().Trim() != lExcelBBSNos[i].ToUpper().Trim() && lDigiOSBBSNos[i] != ("BBS" + JobID.ToString()))
        //                               {
        //                                   if (lRetBBSNo == "")
        //                                   {
        //                                       lRetBBSNo = "(" + lDigiOSBBSNos[i].ToUpper().Trim() + "," + lExcelBBSNos[i].ToUpper().Trim() + ")";
        //                                   }
        //                                   else
        //                                   {
        //                                       lRetBBSNo = lRetBBSNo + "<br> (" + lDigiOSBBSNos[i].ToUpper().Trim() + "," + lExcelBBSNos[i].ToUpper().Trim() + ")";
        //                                   }
        //                               }
        //                           }
        //                       }
        //                   }
        //               }

        //               return Json(new
        //               {
        //                   success = true,
        //                   error = true,
        //                   message = lTotalWt,
        //                   pono = lRetPONo,
        //                   bbsno = lRetBBSNo
        //               }, JsonRequestBehavior.AllowGet);
        //           }
        //           catch (Exception ex)
        //           {
        //               return Json(new
        //               {
        //                   success = false,
        //                   error = true,
        //                   message = "Import Error: " + ex.Message + ex.StackTrace,
        //                   pono = "",
        //                   bbsno = ""
        //               }, JsonRequestBehavior.AllowGet);
        //           }
        //       }

        //       async Task<bool> ImportOrderBBS(string CustomerCode, string ProjectCode, int JobID, int BBSID, ExcelWorksheet workSheet)
        //       {

        //           bool lReturn = true;
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lProcessObj = new ProcessController();
        //           int lFound = 0;

        //           DataTable lDataTable = new DataTable();

        //           //create columns
        //           var lColNo = 1;
        //           try
        //           {
        //               lProcessObj.OpenNDSConnection(ref lNDSCon);

        //               foreach (var firstRowCell in workSheet.Cells[1, 1, 1, workSheet.Dimension.End.Column])
        //               {
        //                   var lTitle = lColNo.ToString() + firstRowCell.Text;
        //                   if (lTitle == null) { lTitle = lColNo.ToString() + "(No Title)"; }
        //                   lDataTable.Columns.Add(lTitle, typeof(string));
        //                   lColNo++;
        //               }

        //               //extend column
        //               lColNo = 1;

        //               int lRowCount = workSheet.Dimension.End.Row;
        //               if (lRowCount > 500)
        //               {
        //                   lRowCount = 500;
        //               }

        //               for (var rowNumber = 1; rowNumber <= lRowCount; rowNumber++)
        //               {
        //                   int lColumnCount = workSheet.Dimension.End.Column;
        //                   if (lColumnCount > 26)
        //                   {
        //                       lColumnCount = 26;
        //                   }
        //                   var row = workSheet.Cells[rowNumber, 1, rowNumber, lColumnCount];
        //                   while (row.Count() > lDataTable.Columns.Count)
        //                   {
        //                       lDataTable.Columns.Add(lColNo.ToString() + "(No Title)", typeof(string));
        //                       lColNo++;
        //                   }
        //                   var newRow = lDataTable.NewRow();
        //                   foreach (var cell in row)
        //                   {
        //                       try
        //                       {
        //                           newRow[cell.Start.Column - 1] = cell.Text;
        //                       }
        //                       catch (Exception lE)
        //                       {
        //                           //                            newRow[cell.Start.Column - 1] = cell.Text;
        //                       }

        //                   }
        //                   lDataTable.Rows.Add(newRow);
        //               }

        //               // Delete last white rows
        //               if (lDataTable.Rows.Count > 0)
        //               {
        //                   for (int i = lDataTable.Rows.Count - 1; i >= 0; i--)
        //                   {
        //                       lFound = 0;
        //                       var lColumnCT = lDataTable.Columns.Count;
        //                       if (lColumnCT > 36)
        //                       {
        //                           lColumnCT = 36;
        //                       }
        //                       for (int j = 0; j < lColumnCT; j++)
        //                       {
        //                           if (lDataTable.Rows[i].ItemArray[j] != null)
        //                           {
        //                               if (lDataTable.Rows[i].ItemArray[j].ToString().Trim() != "" && lDataTable.Rows[i].ItemArray[j].ToString().Trim() != "0")
        //                               {
        //                                   lFound = 1;
        //                                   break;
        //                               }
        //                           }
        //                       }
        //                       if (lFound == 0)
        //                       {
        //                           lDataTable.Rows.RemoveAt(i);
        //                       }
        //                       else
        //                       {
        //                           break;
        //                       }
        //                   }
        //               }


        //               if (lDataTable.Rows.Count > 0)
        //               {
        //                   // clear null
        //                   for (int i = 0; i < lDataTable.Rows.Count; i++)
        //                   {
        //                       for (int j = 0; j < lDataTable.Columns.Count; j++)
        //                       {
        //                           if (lDataTable.Rows[i].ItemArray[j] == null)
        //                           {
        //                               lDataTable.Rows[i].ItemArray[j] = "";
        //                           }
        //                       }
        //                   }
        //                   //find the header row if it has
        //                   var lColStart = 0;
        //                   var lRowStart = 0;
        //                   var lHeaderRows = 0;
        //                   if (lDataTable.Rows.Count >= 2 && lDataTable.Columns.Count > 7)
        //                   {
        //                       for (int i = 0; i < lDataTable.Rows.Count; i++)
        //                       {
        //                           for (int j = 0; j < lDataTable.Columns.Count - 1; j++)
        //                           {
        //                               if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().ToUpper() == "A" && lDataTable.Rows[i].ItemArray[j + 1].ToString().Trim().ToUpper() == "B")
        //                               {
        //                                   lRowStart = i + 1;
        //                                   lColStart = j;
        //                                   lHeaderRows = i;
        //                                   break;
        //                               }
        //                           }

        //                           if (lHeaderRows == 0)
        //                           {
        //                               for (int j = 0; j < lDataTable.Columns.Count - 1; j++)
        //                               {
        //                                   if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().ToUpper() == "A" && lDataTable.Rows[i].ItemArray[j + 1].ToString().Trim().ToUpper() == "BAR LENGTH")
        //                                   {
        //                                       lRowStart = i + 1;
        //                                       lColStart = j;
        //                                       lHeaderRows = i;
        //                                       break;
        //                                   }
        //                               }
        //                           }
        //                           if (lHeaderRows > 0)
        //                           {
        //                               break;
        //                           }
        //                       }
        //                   }

        //                   // Checking the Imgage and taken out 
        //                   if (lDataTable.Columns.Count > 9)
        //                   {
        //                       lFound = 0;
        //                       for (int i = lRowStart; i < lDataTable.Rows.Count; i++)
        //                       {
        //                           var liVar = 0;
        //                           if (lDataTable.Rows[i].ItemArray[8] != null &&
        //                           lDataTable.Rows[i].ItemArray[8].ToString().Trim() != "" &&
        //                           int.TryParse(lDataTable.Rows[i].ItemArray[8].ToString(), out liVar))
        //                           {
        //                               lFound = 1;
        //                               break;
        //                           }
        //                       }

        //                       if (lFound == 0)
        //                       {
        //                           lDataTable.Columns.RemoveAt(8);
        //                           if (lColStart > 8)
        //                           {
        //                               lColStart = lColStart - 1;
        //                           }
        //                       }
        //                   }

        //                   //check barmark

        //                   //prepare to insert record
        //                   //1. get barID
        //                   int? lBarID = 0;
        //                   lBarID = await db.OrderDetails.Where(z => z.CustomerCode == CustomerCode &&
        //                       z.ProjectCode == ProjectCode && z.JobID == JobID &&
        //                       z.BBSID == BBSID).MaxAsync(z => (int?)z.BarID);
        //                   if (lBarID == null)
        //                   {
        //                       lBarID = 0;
        //                   }

        //                   if (lDataTable.Rows.Count > 1)
        //                   {
        //                       lDataTable = checkBarMark(lRowStart, lDataTable);
        //                   }

        //                   //2. get count of rows in the BBS
        //                   int lRows = 0;
        //                   lRows = await db.OrderDetails.CountAsync(z => z.CustomerCode == CustomerCode &&
        //                       z.ProjectCode == ProjectCode && z.JobID == JobID &&
        //                       z.BBSID == BBSID);

        //                   //3. get Jobadvice
        //                   var lJobAdv = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

        //                   for (int i = lRowStart; i < lDataTable.Rows.Count; i++)
        //                   {
        //                       var lDia = ",8,10,12,13,16,20,24,25,28,32,36,40,50";
        //                       var lRDia = ",6,8,10,13,16,20";

        //                       lBarID = lBarID + 1;
        //                       lRows = lRows + 1;
        //                       int lSort = lRows * 1000;
        //                       string lBarType = lDataTable.Rows[i].ItemArray[2].ToString();
        //                       if (lBarType != null)
        //                       {
        //                           lBarType = lBarType.Trim();
        //                           if (lBarType != "" && lBarType != "T" && lBarType != "R" && lBarType != "H" && lBarType != "X" && lBarType != "E" && lBarType != "N" && lBarType != "C") lBarType = "H";
        //                       }
        //                       else
        //                       {
        //                           lBarType = "";
        //                       }
        //                       var lBarDia = lDataTable.Rows[i].ItemArray[3].ToString();
        //                       lBarDia = lBarDia.Trim();

        //                       if (lBarType == "R")
        //                       {
        //                           if (lRDia.IndexOf(lBarDia) < 0) lBarDia = null;
        //                       }
        //                       else
        //                       {
        //                           if (lDia.IndexOf(lBarDia) < 0) lBarDia = null;
        //                       }

        //                       short lBarDiaInt = 0;
        //                       short.TryParse(lBarDia, out lBarDiaInt);

        //                       if (lBarDiaInt > 50)
        //                       {
        //                           lBarDiaInt = 0;
        //                       }
        //                       int lMQty = 0;
        //                       int.TryParse(lDataTable.Rows[i].ItemArray[4].ToString(), out lMQty);

        //                       if (lMQty > 15000)
        //                       {
        //                           lMQty = 1;
        //                       }

        //                       int lEQty = 0;
        //                       int.TryParse(lDataTable.Rows[i].ItemArray[5].ToString(), out lEQty);

        //                       if (lEQty > 15000)
        //                       {
        //                           lEQty = 1;
        //                       }
        //                       int lTQty = lMQty * lEQty;

        //                       var lBarTypePin = lBarType;
        //                       //if (lBarType == "E" || lBarType == "N")
        //                       //{
        //                       //    lBarTypePin = "T";
        //                       //}
        //                       if (lBarType == "C")
        //                       {
        //                           lBarTypePin = "H";
        //                       }

        //                       var lStandardPin = db.PinMaster.Find(lBarTypePin, "S", lBarDiaInt);
        //                       var lNonStandardPin = db.PinMaster.Find(lBarTypePin, "N", lBarDiaInt);

        //                       //Check Standard and take other standard
        //                       if (lJobAdv != null)
        //                       {
        //                           var lBBSStd = lJobAdv.BBSStandard;
        //                           if (lBBSStd != null && lBBSStd.Trim() != "" && lBBSStd.Trim() != "BS-8666")
        //                           {
        //                               var lS = db.PinAdd.Find(lBBSStd, lBarTypePin, "S", lBarDiaInt);

        //                               if (lS != null && lS.dia > 0)
        //                               {
        //                                   lStandardPin = new PinModels
        //                                   {
        //                                       grade = lS.grade,
        //                                       type = lS.type,
        //                                       dia = lS.dia,
        //                                       pin = lS.pin,
        //                                       bend_len_min = lS.bend_len_min,
        //                                       hook_len_min = lS.hook_len_min,
        //                                       hook_height_min = lS.hook_height_min
        //                                   };
        //                               }

        //                               var lN = db.PinAdd.Find(lBBSStd, lBarTypePin, "N", lBarDiaInt);

        //                               if (lN != null && lN.dia > 0)
        //                               {
        //                                   lNonStandardPin = new PinModels
        //                                   {
        //                                       grade = lN.grade,
        //                                       type = lN.type,
        //                                       dia = lN.dia,
        //                                       pin = lN.pin,
        //                                       bend_len_min = lN.bend_len_min,
        //                                       hook_len_min = lN.hook_len_min,
        //                                       hook_height_min = lN.hook_height_min
        //                                   };
        //                               }
        //                           }
        //                       }

        //                       var lShapeCode = lDataTable.Rows[i].ItemArray[7].ToString();
        //                       if (lShapeCode == null)
        //                       {
        //                           lShapeCode = "";
        //                       }
        //                       lShapeCode = lShapeCode.Trim();

        //                       if (lShapeCode.Length > 3)
        //                       {
        //                           lShapeCode = lShapeCode.Substring(0, 3);
        //                       }

        //                       var lShapeCheck = lShapeCode;
        //                       while (lShapeCheck.Length < 3)
        //                       {
        //                           lShapeCheck = "0" + lShapeCheck;
        //                       }

        //                       lFound = 0;
        //                       lCmd = new SqlCommand();
        //                       lCmd.CommandText =
        //                       "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, CSM_CRT_ON " +
        //                       "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                       "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                       "AND CSM_SHAPE_ID = '" + lShapeCheck + "' " +
        //                       "AND CSM_ACT_INACTIVE = 1 ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           if (lRst.Read())
        //                           {
        //                               lFound = 1;
        //                           }
        //                       }
        //                       lRst.Close();

        //                       if (lFound == 0)
        //                       {
        //                           lShapeCode = "";
        //                       }

        //                       var lshapeParameters = "";
        //                       var lshapeLengthFormula = "";
        //                       var lshapeParaValidator = "";
        //                       var lshapeTransportValidator = "";
        //                       ShapeConfViewModels lFormulas = new ShapeConfViewModels();

        //                       int? lPinSize = 0;

        //                       if (lShapeCode != null && lShapeCode.Trim() != "" && lBarDiaInt != 0)
        //                       {
        //                           lShapeCode = lShapeCode.Trim();
        //                           lShapeCode = lShapeCode.ToUpper();
        //                           if (lShapeCode.Length == 2) lShapeCode = "0" + lShapeCode;
        //                           if (lShapeCode == "083") lShapeCode = "D83";
        //                           if (lShapeCode == "065") lShapeCode = "R65";

        //                           var lShapes = (from p in db.Shape where p.shapeCode == lShapeCode select p).ToList();
        //                           if (lShapes.Count == 0)
        //                           {
        //                               //lShapeCode = "";
        //                           }
        //                           else
        //                           {
        //                               lshapeParameters = lShapes[0].shapeParameters;
        //                               lshapeLengthFormula = lShapes[0].shapeLengthFormula;
        //                               lshapeParaValidator = lShapes[0].shapeParaValidator;
        //                               lshapeTransportValidator = lShapes[0].shapeTransportValidator;
        //                           }

        //                           if (lStandardPin != null && lShapeCode != "020" && lShapeCode != "20" & lshapeParameters != "A")
        //                           {
        //                               lPinSize = lStandardPin.pin;
        //                           }

        //                           lFormulas = await getShapeInfoFunDB(CustomerCode, ProjectCode, JobID, lShapeCode, 0);
        //                           lshapeParameters = lFormulas.shapeParameters;
        //                           lshapeLengthFormula = lFormulas.shapeLengthFormula;
        //                       }


        //                       var orderDetailsModels = new OrderDetailsModels
        //                       {
        //                           CustomerCode = CustomerCode,
        //                           ProjectCode = ProjectCode,
        //                           JobID = JobID,
        //                           BBSID = BBSID,
        //                           BarID = (int)lBarID,
        //                           BarSort = lSort,
        //                           Cancelled = null,
        //                           BarCAB = true,
        //                           BarSTD = null,
        //                           ElementMark = lDataTable.Rows[i].ItemArray[0].ToString().Trim().Length > 20 ? lDataTable.Rows[i].ItemArray[0].ToString().Trim().Substring(0, 19) : lDataTable.Rows[i].ItemArray[0].ToString().Trim(),
        //                           BarMark = lDataTable.Rows[i].ItemArray[1].ToString().Trim().Length > 8 ? lDataTable.Rows[i].ItemArray[1].ToString().Trim().Substring(0, 8) : lDataTable.Rows[i].ItemArray[1].ToString().Trim(),
        //                           BarType = lBarType,
        //                           BarSize = lBarDiaInt == 0 ? (short?)null : lBarDiaInt,
        //                           BarMemberQty = lMQty == 0 ? (int?)null : lMQty,
        //                           BarEachQty = lEQty == 0 ? (int?)null : lEQty,
        //                           BarTotalQty = lTQty == 0 ? (int?)null : lTQty,
        //                           BarShapeCode = lShapeCode,
        //                           A = null,
        //                           B = null,
        //                           C = null,
        //                           D = null,
        //                           E = null,
        //                           F = null,
        //                           G = null,
        //                           H = null,
        //                           I = null,
        //                           J = null,
        //                           K = null,
        //                           L = null,
        //                           M = null,
        //                           N = null,
        //                           O = null,
        //                           P = null,
        //                           Q = null,
        //                           R = null,
        //                           S = null,
        //                           T = null,
        //                           U = null,
        //                           V = null,
        //                           W = null,
        //                           X = null,
        //                           Y = null,
        //                           Z = null,
        //                           A2 = null,
        //                           B2 = null,
        //                           C2 = null,
        //                           D2 = null,
        //                           E2 = null,
        //                           F2 = null,
        //                           G2 = null,
        //                           H2 = null,
        //                           I2 = null,
        //                           J2 = null,
        //                           K2 = null,
        //                           L2 = null,
        //                           M2 = null,
        //                           N2 = null,
        //                           O2 = null,
        //                           P2 = null,
        //                           Q2 = null,
        //                           R2 = null,
        //                           S2 = null,
        //                           T2 = null,
        //                           U2 = null,
        //                           V2 = null,
        //                           W2 = null,
        //                           X2 = null,
        //                           Y2 = null,
        //                           Z2 = null,
        //                           BarLength = null,
        //                           BarLength2 = null,
        //                           BarWeight = null,
        //                           Remarks = "",
        //                           shapeTransport = 0,
        //                           PinSize = lPinSize == 0 ? (int?)null : lPinSize,
        //                           TeklaGUID = "",
        //                           UpdateDate = DateTime.Now,
        //                           UpdateBy = User.Identity.GetUserName(),
        //                           CreateDate = DateTime.Now,
        //                           CreateBy = User.Identity.GetUserName()
        //                       };

        //                       if (lShapeCode.Trim() != "" || lBarDiaInt != 0 || lTQty > 0)
        //                       {
        //                           if (lRowStart > 0 && lColStart > 0)
        //                           {
        //                               //HAVE HEADER ROW
        //                               for (int j = lColStart; j < lDataTable.Columns.Count; j++)
        //                               {
        //                                   string lValue = lDataTable.Rows[i].ItemArray[j].ToString();

        //                                   if (isInvalidParameterCell(lShapeCode,
        //                                       lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().Trim(),
        //                                       lshapeParameters) == true)
        //                                   {
        //                                       lValue = null;
        //                                   }

        //                                   //var lErrorMsg = "";
        //                                   //if (isValidValue(lDataTable.Rows[lHeaderRows].ItemArray[j].ToString(),
        //                                   //lshapeParameters,
        //                                   //lshapeParaValidator,
        //                                   //lBarDiaInt,
        //                                   //lValue,
        //                                   //orderDetailsModels,
        //                                   //out lErrorMsg) == false)
        //                                   //{
        //                                   //    lValue = null;
        //                                   //}

        //                                   //var lTotalLength = calTotalLen(
        //                                   //    orderDetailsModels,
        //                                   //    lshapeLengthFormula,
        //                                   //    lValue);

        //                                   // validate the Total Length

        //                                   //var lMaxLength = getVarMaxValue(lTotalLength);
        //                                   //if (lMaxLength > 12000)
        //                                   //{
        //                                   //    lValue = null;
        //                                   //}
        //                                   //else
        //                                   //{
        //                                   //orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
        //                                   //orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);
        //                                   //}

        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "A") orderDetailsModels.A = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "B") orderDetailsModels.B = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "C") orderDetailsModels.C = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "D") orderDetailsModels.D = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "E") orderDetailsModels.E = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "F") orderDetailsModels.F = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "G") orderDetailsModels.G = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "H") orderDetailsModels.H = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "I") orderDetailsModels.I = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "J") orderDetailsModels.J = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "K") orderDetailsModels.K = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "L") orderDetailsModels.L = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "M") orderDetailsModels.M = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "N") orderDetailsModels.N = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "O") orderDetailsModels.O = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "P") orderDetailsModels.P = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Q") orderDetailsModels.Q = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "R") orderDetailsModels.R = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "S") orderDetailsModels.S = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "T") orderDetailsModels.T = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "U") orderDetailsModels.U = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "V") orderDetailsModels.V = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "W") orderDetailsModels.W = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "X") orderDetailsModels.X = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Y") orderDetailsModels.Y = getParaValue(lValue, 1);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Z") orderDetailsModels.Z = getParaValue(lValue, 1);

        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "A") orderDetailsModels.A2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "B") orderDetailsModels.B2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "C") orderDetailsModels.C2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "D") orderDetailsModels.D2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "E") orderDetailsModels.E2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "F") orderDetailsModels.F2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "G") orderDetailsModels.G2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "H") orderDetailsModels.H2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "I") orderDetailsModels.I2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "J") orderDetailsModels.J2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "K") orderDetailsModels.K2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "L") orderDetailsModels.L2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "M") orderDetailsModels.M2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "N") orderDetailsModels.N2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "O") orderDetailsModels.O2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "P") orderDetailsModels.P2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Q") orderDetailsModels.Q2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "R") orderDetailsModels.R2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "S") orderDetailsModels.S2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "T") orderDetailsModels.T2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "U") orderDetailsModels.U2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "V") orderDetailsModels.V2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "W") orderDetailsModels.W2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "X") orderDetailsModels.X2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Y") orderDetailsModels.Y2 = getParaValue(lValue, 2);
        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Z") orderDetailsModels.Z2 = getParaValue(lValue, 2);

        //                                   if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "GUID")
        //                                   {
        //                                       if (lValue != null && lValue.Length > 1000)
        //                                       {
        //                                           lValue = lValue.Substring(0, 1000);
        //                                       }
        //                                       orderDetailsModels.TeklaGUID = lValue;
        //                                   }
        //                               }
        //                           }
        //                           else
        //                           {
        //                               //WITHOUT HEADER ROW PARAMETER a STARTFROM 8
        //                               for (int j = 8; j < lDataTable.Columns.Count; j++)
        //                               {
        //                                   var lValue = lDataTable.Rows[i].ItemArray[j].ToString();

        //                                   if (isInvalidParameterCell(lShapeCode,
        //                                       ((char)(Encoding.ASCII.GetBytes("A")[0] + j - 8)).ToString(),
        //                                       lshapeParameters) == true)
        //                                   {
        //                                       lValue = null;
        //                                   }

        //                                   //var lErrorMsg = "";
        //                                   //if (isValidValue(
        //                                   //    ((char)(Encoding.ASCII.GetBytes("A")[0] + j - 8)).ToString(),
        //                                   //    lshapeParameters,
        //                                   //    lshapeParaValidator,
        //                                   //    lBarDiaInt,
        //                                   //    lValue,
        //                                   //    orderDetailsModels,
        //                                   //    out lErrorMsg) == false)
        //                                   //{
        //                                   //    lValue = null;
        //                                   //}

        //                                   //var lTotalLength = calTotalLen(
        //                                   //    orderDetailsModels,
        //                                   //    lshapeLengthFormula,
        //                                   //    lValue);

        //                                   // validate the Total Length

        //                                   //var lMaxLength = getVarMaxValue(lTotalLength);

        //                                   //if (lMaxLength > 12000)
        //                                   //{
        //                                   //    lValue = null;
        //                                   //}
        //                                   //else
        //                                   //{
        //                                   //orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
        //                                   //orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);
        //                                   //}

        //                                   if (j == 8 && lshapeParameters.IndexOf("A") >= 0) orderDetailsModels.A = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 9 && lshapeParameters.IndexOf("B") >= 0) orderDetailsModels.B = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 10 && lshapeParameters.IndexOf("C") >= 0) orderDetailsModels.C = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 11 && lshapeParameters.IndexOf("D") >= 0) orderDetailsModels.D = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 12 && lshapeParameters.IndexOf("E") >= 0) orderDetailsModels.E = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 13 && lshapeParameters.IndexOf("F") >= 0) orderDetailsModels.F = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 14 && lshapeParameters.IndexOf("G") >= 0) orderDetailsModels.G = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 15 && lshapeParameters.IndexOf("H") >= 0) orderDetailsModels.H = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 16 && lshapeParameters.IndexOf("I") >= 0) orderDetailsModels.I = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 17 && lshapeParameters.IndexOf("J") >= 0) orderDetailsModels.J = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 18 && lshapeParameters.IndexOf("K") >= 0) orderDetailsModels.K = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 19 && lshapeParameters.IndexOf("L") >= 0) orderDetailsModels.L = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 20 && lshapeParameters.IndexOf("M") >= 0) orderDetailsModels.M = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 21 && lshapeParameters.IndexOf("N") >= 0) orderDetailsModels.N = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 22 && lshapeParameters.IndexOf("O") >= 0) orderDetailsModels.O = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 23 && lshapeParameters.IndexOf("P") >= 0) orderDetailsModels.P = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 24 && lshapeParameters.IndexOf("Q") >= 0) orderDetailsModels.Q = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 25 && lshapeParameters.IndexOf("R") >= 0) orderDetailsModels.R = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 26 && lshapeParameters.IndexOf("S") >= 0) orderDetailsModels.S = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 27 && lshapeParameters.IndexOf("T") >= 0) orderDetailsModels.T = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 28 && lshapeParameters.IndexOf("U") >= 0) orderDetailsModels.U = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 29 && lshapeParameters.IndexOf("V") >= 0) orderDetailsModels.V = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 30 && lshapeParameters.IndexOf("W") >= 0) orderDetailsModels.W = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 31 && lshapeParameters.IndexOf("X") >= 0) orderDetailsModels.X = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 32 && lshapeParameters.IndexOf("Y") >= 0) orderDetailsModels.Y = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
        //                                   if (j == 33 && lshapeParameters.IndexOf("Z") >= 0) orderDetailsModels.Z = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);

        //                                   if (j == 8 && lshapeParameters.IndexOf("A") >= 0) orderDetailsModels.A2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 9 && lshapeParameters.IndexOf("B") >= 0) orderDetailsModels.B2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 10 && lshapeParameters.IndexOf("C") >= 0) orderDetailsModels.C2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 11 && lshapeParameters.IndexOf("D") >= 0) orderDetailsModels.D2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 12 && lshapeParameters.IndexOf("E") >= 0) orderDetailsModels.E2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 13 && lshapeParameters.IndexOf("F") >= 0) orderDetailsModels.F2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 14 && lshapeParameters.IndexOf("G") >= 0) orderDetailsModels.G2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 15 && lshapeParameters.IndexOf("H") >= 0) orderDetailsModels.H2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 16 && lshapeParameters.IndexOf("I") >= 0) orderDetailsModels.I2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 17 && lshapeParameters.IndexOf("J") >= 0) orderDetailsModels.J2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 18 && lshapeParameters.IndexOf("K") >= 0) orderDetailsModels.K2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 19 && lshapeParameters.IndexOf("L") >= 0) orderDetailsModels.L2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 20 && lshapeParameters.IndexOf("M") >= 0) orderDetailsModels.M2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 21 && lshapeParameters.IndexOf("N") >= 0) orderDetailsModels.N2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 22 && lshapeParameters.IndexOf("O") >= 0) orderDetailsModels.O2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 23 && lshapeParameters.IndexOf("P") >= 0) orderDetailsModels.P2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 24 && lshapeParameters.IndexOf("Q") >= 0) orderDetailsModels.Q2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 25 && lshapeParameters.IndexOf("R") >= 0) orderDetailsModels.R2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 26 && lshapeParameters.IndexOf("S") >= 0) orderDetailsModels.S2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 27 && lshapeParameters.IndexOf("T") >= 0) orderDetailsModels.T2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 28 && lshapeParameters.IndexOf("U") >= 0) orderDetailsModels.U2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 29 && lshapeParameters.IndexOf("V") >= 0) orderDetailsModels.V2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 30 && lshapeParameters.IndexOf("W") >= 0) orderDetailsModels.W2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 31 && lshapeParameters.IndexOf("X") >= 0) orderDetailsModels.X2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 32 && lshapeParameters.IndexOf("Y") >= 0) orderDetailsModels.Y2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
        //                                   if (j == 33 && lshapeParameters.IndexOf("Z") >= 0) orderDetailsModels.Z2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);

        //                                   if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().Length >= 36 && lDataTable.Rows[i].ItemArray[j].ToString().Split('-').Length >= 5)
        //                                   {
        //                                       lValue = lDataTable.Rows[i].ItemArray[j].ToString().Trim();
        //                                       if (lValue != null && lValue.Length > 1000)
        //                                       {
        //                                           lValue = lValue.Substring(0, 1000);
        //                                       }

        //                                       orderDetailsModels.TeklaGUID = lValue;
        //                                   }
        //                               }
        //                           }

        //                           if (orderDetailsModels.A != null && orderDetailsModels.A > 50000)
        //                           {
        //                               orderDetailsModels.A = null;
        //                           }
        //                           if (orderDetailsModels.B != null && orderDetailsModels.B > 50000)
        //                           {
        //                               orderDetailsModels.B = null;
        //                           }
        //                           if (orderDetailsModels.C != null && orderDetailsModels.C > 50000)
        //                           {
        //                               orderDetailsModels.C = null;
        //                           }
        //                           if (orderDetailsModels.D != null && orderDetailsModels.D > 50000)
        //                           {
        //                               orderDetailsModels.D = null;
        //                           }
        //                           if (orderDetailsModels.E != null && orderDetailsModels.E > 50000)
        //                           {
        //                               orderDetailsModels.E = null;
        //                           }
        //                           if (orderDetailsModels.F != null && orderDetailsModels.F > 50000)
        //                           {
        //                               orderDetailsModels.F = null;
        //                           }
        //                           if (orderDetailsModels.G != null && orderDetailsModels.G > 50000)
        //                           {
        //                               orderDetailsModels.G = null;
        //                           }
        //                           if (orderDetailsModels.H != null && orderDetailsModels.H > 50000)
        //                           {
        //                               orderDetailsModels.H = null;
        //                           }
        //                           if (orderDetailsModels.I != null && orderDetailsModels.I > 50000)
        //                           {
        //                               orderDetailsModels.I = null;
        //                           }
        //                           if (orderDetailsModels.J != null && orderDetailsModels.J > 50000)
        //                           {
        //                               orderDetailsModels.J = null;
        //                           }
        //                           if (orderDetailsModels.K != null && orderDetailsModels.K > 50000)
        //                           {
        //                               orderDetailsModels.K = null;
        //                           }
        //                           if (orderDetailsModels.L != null && orderDetailsModels.L > 50000)
        //                           {
        //                               orderDetailsModels.L = null;
        //                           }
        //                           if (orderDetailsModels.M != null && orderDetailsModels.M > 50000)
        //                           {
        //                               orderDetailsModels.M = null;
        //                           }
        //                           if (orderDetailsModels.N != null && orderDetailsModels.N > 50000)
        //                           {
        //                               orderDetailsModels.N = null;
        //                           }
        //                           if (orderDetailsModels.O != null && orderDetailsModels.O > 50000)
        //                           {
        //                               orderDetailsModels.O = null;
        //                           }
        //                           if (orderDetailsModels.P != null && orderDetailsModels.P > 50000)
        //                           {
        //                               orderDetailsModels.P = null;
        //                           }
        //                           if (orderDetailsModels.Q != null && orderDetailsModels.Q > 50000)
        //                           {
        //                               orderDetailsModels.Q = null;
        //                           }
        //                           if (orderDetailsModels.R != null && orderDetailsModels.R > 50000)
        //                           {
        //                               orderDetailsModels.R = null;
        //                           }
        //                           if (orderDetailsModels.S != null && orderDetailsModels.S > 50000)
        //                           {
        //                               orderDetailsModels.S = null;
        //                           }
        //                           if (orderDetailsModels.T != null && orderDetailsModels.T > 50000)
        //                           {
        //                               orderDetailsModels.T = null;
        //                           }
        //                           if (orderDetailsModels.U != null && orderDetailsModels.U > 50000)
        //                           {
        //                               orderDetailsModels.U = null;
        //                           }
        //                           if (orderDetailsModels.V != null && orderDetailsModels.V > 50000)
        //                           {
        //                               orderDetailsModels.V = null;
        //                           }
        //                           if (orderDetailsModels.W != null && orderDetailsModels.W > 50000)
        //                           {
        //                               orderDetailsModels.W = null;
        //                           }
        //                           if (orderDetailsModels.X != null && orderDetailsModels.X > 50000)
        //                           {
        //                               orderDetailsModels.X = null;
        //                           }
        //                           if (orderDetailsModels.Y != null && orderDetailsModels.Y > 50000)
        //                           {
        //                               orderDetailsModels.Y = null;
        //                           }
        //                           if (orderDetailsModels.Z != null && orderDetailsModels.Z > 50000)
        //                           {
        //                               orderDetailsModels.Z = null;
        //                           }

        //                           if (lShapeCode.Trim() != "" && lBarDiaInt != 0)
        //                           {
        //                               if (lShapeCode != "020" && lStandardPin != null && lNonStandardPin != null)
        //                               {
        //                                   //Calculate depend
        //                                   calDependValue(ref orderDetailsModels, lFormulas, lPinSize.ToString(), lBarDiaInt.ToString());

        //                                   //Calculate depend
        //                                   CheckPinSize(ref orderDetailsModels, lFormulas, lStandardPin, lNonStandardPin, lBarDiaInt);
        //                               }

        //                               var lTotalLength = calTotalLen(orderDetailsModels, lshapeLengthFormula);

        //                               orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
        //                               orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);

        //                               double lWT = calWeight(orderDetailsModels);
        //                               if (lWT > 0)
        //                               {
        //                                   orderDetailsModels.BarWeight = (decimal?)lWT;
        //                               }

        //                               orderDetailsModels.shapeTransport = (byte)ValidTransport(orderDetailsModels, lshapeTransportValidator);

        //                               //Assign default paremeter value fro some shape
        //                               if (lShapeCode == "061" || lShapeCode == "079")
        //                               {
        //                                   if (lBarDiaInt > 0 && (orderDetailsModels.C == null || orderDetailsModels.C == 0))
        //                                   {
        //                                       if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
        //                                       {
        //                                           orderDetailsModels.C = 13 * lBarDiaInt;
        //                                       }
        //                                       else
        //                                       {
        //                                           orderDetailsModels.C = 12 * lBarDiaInt;
        //                                       }
        //                                   }
        //                                   if (lBarDiaInt > 0 && (orderDetailsModels.D == null || orderDetailsModels.D == 0))
        //                                   {
        //                                       if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
        //                                       {
        //                                           orderDetailsModels.D = 13 * lBarDiaInt;
        //                                       }
        //                                       else
        //                                       {
        //                                           orderDetailsModels.D = 12 * lBarDiaInt;
        //                                       }
        //                                   }
        //                               }
        //                               if (lShapeCode == "79A" && lBarDiaInt > 0)
        //                               {
        //                                   if (orderDetailsModels.C == null || orderDetailsModels.C == 0)
        //                                   {
        //                                       if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
        //                                       {
        //                                           orderDetailsModels.C = 13 * lBarDiaInt;
        //                                       }
        //                                       else
        //                                       {
        //                                           orderDetailsModels.C = 12 * lBarDiaInt;
        //                                       }
        //                                   }
        //                               }
        //                               if (lShapeCode == "61C")
        //                               {
        //                                   if (lBarDiaInt > 0 && (orderDetailsModels.A == null || orderDetailsModels.A == 0))
        //                                   {
        //                                       if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
        //                                       {
        //                                           orderDetailsModels.A = 13 * lBarDiaInt;
        //                                       }
        //                                       else
        //                                       {
        //                                           orderDetailsModels.A = 12 * lBarDiaInt;
        //                                       }
        //                                   }
        //                                   if (lBarDiaInt > 0 && (orderDetailsModels.D == null || orderDetailsModels.D == 0))
        //                                   {
        //                                       if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
        //                                       {
        //                                           orderDetailsModels.D = 13 * lBarDiaInt;
        //                                       }
        //                                       else
        //                                       {
        //                                           orderDetailsModels.D = 12 * lBarDiaInt;
        //                                       }
        //                                   }
        //                                   if (orderDetailsModels.E == null || orderDetailsModels.E == 0)
        //                                   {
        //                                       orderDetailsModels.E = 135;
        //                                   }
        //                               }


        //                           }

        //                       }
        //                       db.OrderDetails.Add(orderDetailsModels);

        //                   }
        //                   int lRtn = await db.SaveChangesAsync();
        //               }

        //           }
        //           catch (Exception e)
        //           {
        //               var lErrorMsg = e.Message;
        //               lReturn = false;
        //           }
        //           lProcessObj.CloseNDSConnection(ref lNDSCon);

        //           //2. get count of rows in the BBS
        //           if (lReturn == true)
        //           {
        //               int lCount = 0;
        //               lCount = db.OrderDetails.Count(z => z.CustomerCode == CustomerCode &&
        //                   z.ProjectCode == ProjectCode && z.JobID == JobID &&
        //                   z.BBSID == BBSID);
        //               if (lCount == 0)
        //               {
        //                   lReturn = false;
        //               }
        //           }

        //           return lReturn;
        //       }

        //       public DataTable checkBarMark(int pRowStart, DataTable pDataTable)
        //       {
        //           int lNumber = 1;
        //           int lFound = 0;

        //           DataTable lRetTable = pDataTable;

        //           if (lRetTable.Rows.Count >= pRowStart)
        //           {
        //               // check null marking
        //               for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
        //               {
        //                   //check Shape Code
        //                   var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
        //                   if (lShapeCode == null) lShapeCode = "";
        //                   if (lShapeCode.Length > 0)
        //                   {
        //                       if (lRetTable.Rows[i].ItemArray[1] == null)
        //                       {
        //                           lRetTable.Rows[i][1] = "";
        //                       }

        //                       lRetTable.Rows[i].ItemArray[1] = lRetTable.Rows[i].ItemArray[1].ToString().Trim();
        //                       if (lRetTable.Rows[i].ItemArray[1].ToString().IndexOf(",") >= 0)
        //                       {
        //                           lRetTable.Rows[i][1] = lRetTable.Rows[i].ItemArray[1].ToString().Replace(",", "");
        //                       }

        //                       if (lRetTable.Rows[i].ItemArray[1].ToString().Length > 8)
        //                       {
        //                           lRetTable.Rows[i][1] = lRetTable.Rows[i].ItemArray[1].ToString().Substring(0, 8);
        //                       }
        //                   }
        //               }

        //               //check duplicated mark
        //               if (lRetTable.Rows.Count > pRowStart)
        //               {
        //                   for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
        //                   {
        //                       //check Shape Code
        //                       var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
        //                       if (lShapeCode == null) lShapeCode = "";
        //                       if (lShapeCode.Length > 0)
        //                       {
        //                           var lMark = lRetTable.Rows[i].ItemArray[1].ToString();

        //                           if (lMark.Length > 0)
        //                           {
        //                               for (int j = pRowStart; j < i; j++)
        //                               {
        //                                   if (lMark == lRetTable.Rows[j].ItemArray[1].ToString())
        //                                   {
        //                                       lNumber = 1;
        //                                       //verify lNumber if existing in list
        //                                       lFound = 1;
        //                                       if (lMark.Length > 4)
        //                                       {
        //                                           lMark = lMark.Substring(0, 4);
        //                                       }
        //                                       while (lFound == 1)
        //                                       {
        //                                           lFound = 0;
        //                                           for (int k = pRowStart; k < i; k++)
        //                                           {
        //                                               if (lRetTable.Rows[k].ItemArray[1].ToString() == lMark + "-" + lNumber.ToString())
        //                                               {
        //                                                   lFound = 1;
        //                                                   break;
        //                                               }
        //                                           }
        //                                           if (lFound == 1)
        //                                           {
        //                                               lNumber++;
        //                                           }
        //                                           if (lNumber > 9 && lMark.Length > 3)
        //                                           {
        //                                               lMark = lMark.Substring(0, 3);
        //                                           }
        //                                       }
        //                                       lRetTable.Rows[i][1] = lMark + "-" + lNumber.ToString();
        //                                       break;
        //                                   }
        //                               }
        //                           }
        //                       }
        //                   }
        //               }

        //               // Check non-marking
        //               lNumber = 1;
        //               for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
        //               {
        //                   //check Shape Code
        //                   var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
        //                   if (lShapeCode == null) lShapeCode = "";
        //                   if (lShapeCode.Length > 0)
        //                   {
        //                       if (lRetTable.Rows[i].ItemArray[1].ToString().Length == 0)
        //                       {
        //                           //verify lNumber if existing in list
        //                           lFound = 1;
        //                           while (lFound == 1)
        //                           {
        //                               lFound = 0;
        //                               for (int j = pRowStart; j < lRetTable.Rows.Count; j++)
        //                               {
        //                                   if (lRetTable.Rows[j].ItemArray[1].ToString() == lNumber.ToString())
        //                                   {
        //                                       lFound = 1;
        //                                       break;
        //                                   }
        //                               }
        //                               if (lFound == 1)
        //                               {
        //                                   lNumber++;
        //                               }
        //                           }

        //                           lRetTable.Rows[i][1] = lNumber.ToString();
        //                           lNumber++;
        //                       }
        //                   }
        //               }
        //           }

        //           return lRetTable;
        //       }

        //       void CheckPinSize(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, PinModels pStandardPin, PinModels pNonStandardPin, int pBarDia)
        //       {
        //           var lParameters = new string[] { };
        //           if (pShapeParam.shapeParameters != null)
        //           {
        //               lParameters = pShapeParam.shapeParameters.Split(',');
        //           }

        //           var lParType = new string[] { };
        //           if (pShapeParam.shapeParameters != null)
        //           {
        //               lParType = pShapeParam.shapeParameters.Split(',');
        //           }

        //           if (lParameters.Length > 0 && pShapeParam.shapeParameters != "A")
        //           {
        //               for (int i = 0; i < lParameters.Length; i++)
        //               {
        //                   if (lParameters[i] == "A" && lParType[i] == "S" && pItem.A != null && pItem.A < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "B" && lParType[i] == "S" && pItem.B != null && pItem.B < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "C" && lParType[i] == "S" && pItem.C != null && pItem.C < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "D" && lParType[i] == "S" && pItem.D != null && pItem.D < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "E" && lParType[i] == "S" && pItem.E != null && pItem.E < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "F" && lParType[i] == "S" && pItem.F != null && pItem.F < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "G" && lParType[i] == "S" && pItem.G != null && pItem.G < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "H" && lParType[i] == "S" && pItem.H != null && pItem.H < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "I" && lParType[i] == "S" && pItem.I != null && pItem.I < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "J" && lParType[i] == "S" && pItem.J != null && pItem.J < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "K" && lParType[i] == "S" && pItem.K != null && pItem.K < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "L" && lParType[i] == "S" && pItem.L != null && pItem.L < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "M" && lParType[i] == "S" && pItem.M != null && pItem.M < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "N" && lParType[i] == "S" && pItem.N != null && pItem.N < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "O" && lParType[i] == "S" && pItem.O != null && pItem.O < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "P" && lParType[i] == "S" && pItem.P != null && pItem.P < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Q" && lParType[i] == "S" && pItem.Q != null && pItem.Q < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "R" && lParType[i] == "S" && pItem.R != null && pItem.R < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "S" && lParType[i] == "S" && pItem.S != null && pItem.S < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "T" && lParType[i] == "S" && pItem.T != null && pItem.T < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "U" && lParType[i] == "S" && pItem.U != null && pItem.U < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "V" && lParType[i] == "S" && pItem.V != null && pItem.V < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "W" && lParType[i] == "S" && pItem.W != null && pItem.W < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "X" && lParType[i] == "S" && pItem.X != null && pItem.X < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Y" && lParType[i] == "S" && pItem.Y != null && pItem.Y < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Z" && lParType[i] == "S" && pItem.Z != null && pItem.Z < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;

        //                   if (lParameters[i] == "A" && lParType[i] == "R" && pItem.A != null && pItem.A < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "B" && lParType[i] == "R" && pItem.B != null && pItem.B < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "C" && lParType[i] == "R" && pItem.C != null && pItem.C < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "D" && lParType[i] == "R" && pItem.D != null && pItem.D < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "E" && lParType[i] == "R" && pItem.E != null && pItem.E < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "F" && lParType[i] == "R" && pItem.F != null && pItem.F < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "G" && lParType[i] == "R" && pItem.G != null && pItem.G < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "H" && lParType[i] == "R" && pItem.H != null && pItem.H < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "I" && lParType[i] == "R" && pItem.I != null && pItem.I < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "J" && lParType[i] == "R" && pItem.J != null && pItem.J < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "K" && lParType[i] == "R" && pItem.K != null && pItem.K < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "L" && lParType[i] == "R" && pItem.L != null && pItem.L < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "M" && lParType[i] == "R" && pItem.M != null && pItem.M < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "N" && lParType[i] == "R" && pItem.N != null && pItem.N < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "O" && lParType[i] == "R" && pItem.O != null && pItem.O < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "P" && lParType[i] == "R" && pItem.P != null && pItem.P < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Q" && lParType[i] == "R" && pItem.Q != null && pItem.Q < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "R" && lParType[i] == "R" && pItem.R != null && pItem.R < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "S" && lParType[i] == "R" && pItem.S != null && pItem.S < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "T" && lParType[i] == "R" && pItem.T != null && pItem.T < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "U" && lParType[i] == "R" && pItem.U != null && pItem.U < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "V" && lParType[i] == "R" && pItem.V != null && pItem.V < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "W" && lParType[i] == "R" && pItem.W != null && pItem.W < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "X" && lParType[i] == "R" && pItem.X != null && pItem.X < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Y" && lParType[i] == "R" && pItem.Y != null && pItem.Y < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
        //                   if (lParameters[i] == "Z" && lParType[i] == "R" && pItem.Z != null && pItem.Z < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;

        //                   //Check first hook length
        //                   if (i == 0 && lParameters.Length > 1)
        //                   {
        //                       if (lParameters[i] == "A" && lParType[i] == "S" && lParType[i + 1] == "R" && pItem.A != null && pItem.A < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   }

        //                   //Check last hook length
        //                   if (lParType[i] == "S" && i > 0 && lParType[i - 1] == "R")
        //                   {
        //                       var lFound = 0;
        //                       if (i + 1 < lParameters.Length)
        //                       {
        //                           for (int j = i + 1; j < lParameters.Length; j++)
        //                           {
        //                               if (lParType[j] == "S")
        //                               {
        //                                   lFound = 1;
        //                                   break;
        //                               }
        //                           }
        //                       }
        //                       if (lFound == 0 && lParameters[i] == "A" && pItem.A != null && pItem.A < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "B" && pItem.B != null && pItem.B < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "C" && pItem.C != null && pItem.C < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "D" && pItem.D != null && pItem.D < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "E" && pItem.E != null && pItem.E < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "F" && pItem.F != null && pItem.F < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "G" && pItem.G != null && pItem.G < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "H" && pItem.H != null && pItem.H < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "I" && pItem.I != null && pItem.I < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "J" && pItem.J != null && pItem.J < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "K" && pItem.K != null && pItem.K < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "L" && pItem.L != null && pItem.L < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "M" && pItem.M != null && pItem.M < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "N" && pItem.N != null && pItem.N < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "O" && pItem.O != null && pItem.O < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "P" && pItem.P != null && pItem.P < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "Q" && pItem.Q != null && pItem.Q < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "R" && pItem.R != null && pItem.R < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "S" && pItem.S != null && pItem.S < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "T" && pItem.T != null && pItem.T < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "U" && pItem.U != null && pItem.U < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "V" && pItem.V != null && pItem.V < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "W" && pItem.W != null && pItem.W < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "X" && pItem.X != null && pItem.X < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "Y" && pItem.Y != null && pItem.Y < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                       if (lFound == 0 && lParameters[i] == "Z" && pItem.Z != null && pItem.Z < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
        //                   }
        //               }
        //           }
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public async Task<ActionResult> ExcelImport(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        //       {
        //           try
        //           {
        //               string lUserType = "";
        //               if (gUserType != null && gUserType != "")
        //               {
        //                   lUserType = gUserType;
        //               }
        //               else
        //               {
        //                   UserAccessController lUa = new UserAccessController();
        //                   lUserType = lUa.getUserType(User.Identity.GetUserName());
        //                   ViewBag.UserType = lUserType;
        //                   lUa = null;
        //               }

        //               HttpPostedFileBase file = Request.Files["ExcelImport"];

        //               if (file.ContentLength > 0 && (Path.GetExtension(file.FileName) == ".xlsx" || Path.GetExtension(file.FileName) == ".xlsm"))
        //               {
        //                   MemoryStream lStream = new MemoryStream();
        //                   file.InputStream.CopyTo(lStream);
        //                   ExcelPackage package = new ExcelPackage(lStream);

        //                   ExcelWorksheet workSheet = package.Workbook.Worksheets.FirstOrDefault(f => f.View.TabSelected);
        //                   DataTable lDataTable = new DataTable();

        //                   if (Path.GetExtension(file.FileName) == ".xlsx" || Path.GetExtension(file.FileName) == ".xlsm")
        //                   {
        //                       if (package.Workbook.Worksheets.Count > 1)
        //                       {
        //                           int lFound = 0;
        //                           int lCount = 0;

        //                           for (int i = 1; i <= package.Workbook.Worksheets.Count; i++)
        //                           {
        //                               if (package.Workbook.Worksheets[i].Name == "OrderSummary")
        //                               {
        //                                   for (int j = 1; j < package.Workbook.Worksheets.Count; j++)
        //                                   {
        //                                       string lBBS = "";
        //                                       if (package.Workbook.Worksheets[i].Dimension.End.Row >= 18 + j
        //                                           && package.Workbook.Worksheets[i].Dimension.End.Column >= 2
        //                                           && package.Workbook.Worksheets[i].Cells[18 + j, 2].Value != null)
        //                                       {
        //                                           lBBS = package.Workbook.Worksheets[i].Cells[18 + j, 2].Value.ToString();
        //                                       }
        //                                       if (lBBS != null && lBBS != "" && package.Workbook.Worksheets["OrderDetail-" + lBBS] != null)
        //                                       {
        //                                           workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBS];
        //                                           lCount = lCount + 1;
        //                                           lFound = 1;
        //                                       }

        //                                   }
        //                                   break;
        //                               }

        //                           }
        //                           if (lCount > 1)
        //                           {
        //                               lFound = 0;
        //                               var lBBSCon = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
        //                               if (lBBSCon != null)
        //                               {
        //                                   if (package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()] != null)
        //                                   {
        //                                       workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()];
        //                                       lFound = 1;
        //                                   }
        //                               }

        //                               if (lFound == 0)
        //                               {
        //                                   return Json(new { success = false, error = true, message = "Cannot find the BBS " + lBBSCon.BBSNo.Trim() }, JsonRequestBehavior.AllowGet);
        //                               }
        //                           }
        //                           if (lFound == 1)
        //                           {
        //                               workSheet.DeleteRow(1, 6);
        //                               if (workSheet.Dimension.End.Column >= 27)
        //                               {
        //                                   workSheet.DeleteColumn(27, 1);
        //                               }
        //                           }
        //                       }
        //                   }

        //                   var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, BBSID, workSheet);

        //                   if (lRtn == true)
        //                   {
        //                       var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
        //                       if (oldBBS != null)
        //                       {
        //                           var lNewBBS = oldBBS;

        //                           lNewBBS.BBSCopiedFrom = "IMPORTED";

        //                           db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
        //                           db.SaveChanges();

        //                           checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);
        //                       }
        //                   }
        //                   return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        //               }
        //               else
        //               {
        //                   return Json(new { success = false, error = true, message = "Invalid Excel file." }, JsonRequestBehavior.AllowGet);
        //               }
        //           }
        //           catch (Exception ex)
        //           {
        //               ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
        //               return Json(new { success = false, error = true, message = "Import Error: " + ex.Message }, JsonRequestBehavior.AllowGet);
        //           }
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getWBS1(string ProjectCode)
        //       {
        //           var content = (from p in db.WBSList
        //                          where p.ProjectCode == ProjectCode && p.ProductType == "CAB"
        //                          select p.WBS1)
        //                          .Distinct()
        //                          .OrderBy(x => x)
        //                          .ToList();
        //           content.Insert(0, " ");
        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getWBS2(string ProjectCode, string WBS1)
        //       {
        //           //var content = (from p in db.WBSList
        //           //               where p.ProjectCode == ProjectCode
        //           //               && p.WBS1 == WBS1
        //           //               && p.ProductType == "CAB"
        //           //               select p.WBS2)
        //           //               .Distinct()
        //           //               .OrderBy(x => x).ToList();

        //           //content.Insert(0, " ");

        //           //return Json(content, JsonRequestBehavior.AllowGet);
        //           var lReturn = new List<string>();
        //           var lCmd = new SqlCommand();
        //           var lNDSCon = new SqlConnection();
        //           SqlDataReader lRst;

        //           try
        //           {
        //               lCmd.CommandText =
        //               "SELECT WBS2 " +
        //               "FROM dbo.OESWBSList " +
        //               "WHERE ProjectCode = '" + ProjectCode + "' " +
        //               "AND WBS1 = '" + WBS1 + "' " +
        //               "AND ProductType = 'CAB' " +
        //               "GROUP BY WBS2 " +
        //               "Order By " +
        //               "(case when PATINDEX('B[0-9]%', WBS2) > 0 then cast(left(substring(WBS2, (PATINDEX('%[0-9]%',WBS2)),len(WBS2)), " +
        //               "PATINDEX('%[^0-9]%', substring(WBS2 + 'z', (PATINDEX('%[0-9]%', WBS2)), " +
        //               "len(WBS2)) + 'z') ) as int)    " +
        //               "else (case when PATINDEX('FDN[0-9]%', WBS2) > 0 then cast(left(substring(WBS2, (PATINDEX('%[0-9]%',WBS2)),len(WBS2)), " +
        //               "PATINDEX('%[^0-9]%', substring(WBS2, (PATINDEX('%[0-9]%', WBS2)), " +
        //               "len(WBS2)) + 'z') ) as int) else  " +
        //               "case when(PATINDEX('B%', WBS2) > 0 OR PATINDEX('FDN%', WBS2) > 0) then 98  else 99 end " +
        //               "end) end), " +
        //               " " +
        //               "(case when PATINDEX('[^0-9]%',WBS2) > 0 then WBS2 " +
        //               "else '' end), " +
        //               " " +
        //               "(CASE WHEN PATINDEX('%[0-9]%',WBS2) > 0 THEN cast(left(substring(WBS2, (PATINDEX('%[0-9]%',WBS2)),len(WBS2)), " +
        //               "PATINDEX('%[^0-9]%', substring(WBS2, (PATINDEX('%[0-9]%', WBS2) + 1), " +
        //               "len(WBS2)) + 'z') ) as int) " +
        //               "ELSE " +
        //               "cast(left(substring(WBS2, (PATINDEX('%[0-9]%', WBS2)), len(WBS2)), " +
        //               "PATINDEX('%[^0-9]%', substring(WBS2, (PATINDEX('%[0-9]%', WBS2)), " +
        //               "len(WBS2)) + 'z') - 1) as int) " +
        //               "END),  " +
        //               "WBS2 ";

        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //               {
        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       while (lRst.Read())
        //                       {
        //                           var lWBS2 = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
        //                           if (lWBS2.Length > 0)
        //                           {
        //                               lReturn.Add(lWBS2);
        //                           }
        //                       }
        //                   }
        //                   lRst.Close();

        //                   lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               }

        //               lProcessObj = null;

        //           }
        //           catch (Exception ex)
        //           {
        //               ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
        //           }

        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           return Ok(lReturn);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getWBS3(string ProjectCode, string WBS1, string WBS2)
        //       {
        //           var content = (from p in db.WBSList
        //                          where p.ProjectCode == ProjectCode
        //                          && p.WBS1 == WBS1
        //                          && p.WBS2 == WBS2
        //                          && p.ProductType == "CAB"
        //                          select p.WBS3)
        //                          .Distinct()
        //                          .OrderBy(x => x)
        //                          .ToList();

        //           content.Insert(0, " ");

        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getStrucElem(string ProjectCode, string pWBS1, string pWBS2, string pWBS3)
        //       {
        //           var content1 = new List<string>();
        //           //if (pWBS2.Trim().Length > 0 && pWBS3.Trim().Length > 0)
        //           //{
        //           var content = (from p in db.WBSList
        //                          where p.ProjectCode == ProjectCode
        //                          && p.WBS1 == pWBS1
        //                          && p.WBS2 == pWBS2
        //                          && p.WBS3 == pWBS3
        //                          && p.ProductType == "CAB"
        //                          orderby p.StructureElem
        //                          select p.StructureElem).Distinct().ToList();

        //           content.Insert(0, " ");

        //           return Json(content, JsonRequestBehavior.AllowGet);
        //           //}
        //           //else if (pWBS2.Trim().Length > 0 && pWBS3.Trim().Length == 0)
        //           //{
        //           //    var content = (from p in db.WBSList
        //           //                   where p.ProjectCode == ProjectCode
        //           //                   && p.WBS1 == pWBS1
        //           //                   && p.WBS2 == pWBS2
        //           //                   && p.ProductType == "CAB"
        //           //                   orderby p.StructureElem
        //           //                   select p.StructureElem).Distinct().ToList();
        //           //    content.Insert(0, " ");
        //           //    return Json(content, JsonRequestBehavior.AllowGet);
        //           //}
        //           //else if (pWBS2.Trim().Length == 0 && pWBS3.Trim().Length == 0)
        //           //{
        //           //    var content = (from p in db.WBSList
        //           //                   where p.ProjectCode == ProjectCode
        //           //                   && p.WBS1 == pWBS1
        //           //                   && p.ProductType == "CAB"
        //           //                   orderby p.StructureElem
        //           //                   select p.StructureElem).Distinct().ToList();
        //           //    content.Insert(0, " ");
        //           //    return Json(content, JsonRequestBehavior.AllowGet);
        //           //}

        //           //content1.Add(" ");
        //           //return Json(content1, JsonRequestBehavior.AllowGet);
        //       }


        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult sendOrderSubmittedEmail(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lEmailContent = "";
        //           var lEmailFrom = "";
        //           var lEmailTo = "";
        //           var lEmailCc = "";
        //           var lEmailSubject = "";
        //           string lVar1 = "";

        //           var JobContent = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //           if (JobContent != null)
        //           {
        //               if (JobContent.CustomerCode == null) JobContent.CustomerCode = "";
        //               else JobContent.CustomerCode = JobContent.CustomerCode.Trim();

        //               if (JobContent.OrderStatus == null) JobContent.OrderStatus = "";
        //               else JobContent.OrderStatus = JobContent.OrderStatus.Trim();

        //               if (JobContent.PONumber == null) JobContent.PONumber = "";
        //               else JobContent.PONumber = JobContent.PONumber.Trim();

        //               if (JobContent.ProjectCode == null) JobContent.ProjectCode = "";
        //               else JobContent.ProjectCode = JobContent.ProjectCode.Trim();

        //               if (JobContent.ProjectStage == null) JobContent.ProjectStage = "";
        //               else JobContent.ProjectStage = JobContent.ProjectStage.Trim();

        //               if (JobContent.DeliveryAddress == null) JobContent.DeliveryAddress = "";
        //               else JobContent.DeliveryAddress = JobContent.DeliveryAddress.Trim();

        //               if (JobContent.Remarks == null) JobContent.Remarks = "";
        //               else JobContent.Remarks = JobContent.Remarks.Trim();

        //               if (JobContent.Scheduler_HP == null) JobContent.Scheduler_HP = "";
        //               else JobContent.Scheduler_HP = JobContent.Scheduler_HP.Trim();

        //               if (JobContent.Scheduler_Name == null) JobContent.Scheduler_Name = "";
        //               else JobContent.Scheduler_Name = JobContent.Scheduler_Name.Trim();

        //               if (JobContent.Scheduler_Tel == null) JobContent.Scheduler_Tel = "";
        //               else JobContent.Scheduler_Tel = JobContent.Scheduler_Tel.Trim();

        //               if (JobContent.SiteEngr_HP == null) JobContent.SiteEngr_HP = "";
        //               else JobContent.SiteEngr_HP = JobContent.SiteEngr_HP.Trim();

        //               if (JobContent.SiteEngr_Name == null) JobContent.SiteEngr_Name = "";
        //               else JobContent.SiteEngr_Name = JobContent.SiteEngr_Name.Trim();

        //               if (JobContent.SiteEngr_Tel == null) JobContent.SiteEngr_Tel = "";
        //               else JobContent.SiteEngr_Tel = JobContent.SiteEngr_Tel.Trim();

        //               if (JobContent.TransportLimit == null) JobContent.TransportLimit = "";
        //               else JobContent.TransportLimit = JobContent.TransportLimit.Trim();

        //               if (JobContent.TransportMode == null) JobContent.TransportMode = "";
        //               else JobContent.TransportMode = JobContent.TransportMode.Trim();

        //               if (JobContent.WBS1 == null) JobContent.WBS1 = "";
        //               else JobContent.WBS1 = JobContent.WBS1.Trim();

        //               if (JobContent.WBS2 == null) JobContent.WBS2 = "";
        //               else JobContent.WBS2 = JobContent.WBS2.Trim();

        //               if (JobContent.WBS3 == null) JobContent.WBS3 = "";
        //               else JobContent.WBS3 = JobContent.WBS3.Trim();
        //           }

        //           lEmailContent = "<p align='center'>JOB ADVICE - CAB/SB (工作通知 - 加工铁与标准直铁料表)</p>";

        //           lEmailContent = lEmailContent + "<p align='left' style='font-size:15px'><a target='_top' href='https://oes.natsteel.com.sg/process?ccode=" + JobContent.CustomerCode
        //               + "&jcode=" + JobContent.ProjectCode + "&prodtype=Rebar" + "&jobid=" + JobContent.JobID.ToString()
        //               + "'>Click here to redirect to Digital Ordering System to process it</a></p>";

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //           lEmailContent = lEmailContent + "<td width=20%>" + "Customer (客户名称)" + "</td>";

        //           CustomerModels lCustomer = db.Customer.Find(JobContent.CustomerCode);
        //           string lVar = "";
        //           if (lCustomer != null) lVar = lCustomer.CustomerName.Trim() + " (" + JobContent.CustomerCode.Trim() + ")";
        //           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr>";

        //           lEmailContent = lEmailContent + "<tr><td>" + "Project (工程项目)" + "</td>";

        //           var lProject = (from p in db.ProjectList
        //                           where p.ProjectCode == ProjectCode
        //                           select p).First();
        //           lVar = "";
        //           if (lProject != null) lVar = lProject.ProjectTitle.Trim() + " (" + JobContent.ProjectCode.Trim() + ")";
        //           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //           lEmailContent = lEmailContent + "<td width=20%>" + "PO No.\n(订单号码)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=27%>" + JobContent.PONumber.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width=26%>" + "Order Date\n(订单日期)" + "</td>";
        //           lEmailContent = lEmailContent + "<td>" + String.Format("{0:yyyy-MM-dd}", JobContent.PODate) + "</td></tr>";

        //           lEmailContent = lEmailContent + "</tr><td width=20%>" + "Required Date\n(交货日期)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=27%>" + String.Format("{0:yyyy-MM-dd}", JobContent.RequiredDate) + "</td>";
        //           lEmailContent = lEmailContent + "<td width=26%>" + "Order Weight\n(订单重量)" + "</td>";

        //           lEmailContent = lEmailContent + "<td>" + ((decimal)JobContent.TotalWeight).ToString("F3") + " KG" + "</td></tr>";

        //           lEmailContent = lEmailContent + "</tr><td width=20%>" + "CAB Bars Weight\n(加工铁重量)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=27%>" + ((decimal)JobContent.TotalCABWeight).ToString("F3") + " KG" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=26%>" + "SB Weight\n(标准直铁重量)" + "</td>";
        //           lEmailContent = lEmailContent + "<td>" + ((decimal)JobContent.TotalSTDWeight).ToString("F3") + " KG" + "</td></tr>";

        //           lEmailContent = lEmailContent + "</tr><td width=20%>" + "Transport Limit\n(运输限制)" + "</td>";


        //           lEmailContent = lEmailContent + "<td width=27%>" + JobContent.TransportLimit + "</td>";

        //           lEmailContent = lEmailContent + "<td width=26%>" + "Transport Mode\n(运输工具)" + "</td>";

        //           //get transport mode
        //           lVar = "";
        //           var lProcessObj = new ProcessController();
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {

        //               lCmd.CommandText = "select vchTransportDescription " +
        //               "from dbo.TransportMaster " +
        //               "where vchTransportMode = '" + JobContent.TransportMode + "' ";

        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   if (lRst.Read())
        //                   {
        //                       lVar = lRst.GetString(0).Trim();
        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //               }
        //               lRst.Close();
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //           lEmailContent = lEmailContent + "<td width='20%'>" + "Block (WBS1)\n(座号/大牌)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=15%>" + JobContent.WBS1.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width='17%'>" + "Storey (WBS2)\n(楼层)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width=14%>" + JobContent.WBS2.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width=16%>" + "Part (WBS3)\n(分部)" + "</td>";
        //           lEmailContent = lEmailContent + "<td>" + JobContent.WBS3.Trim() + "</td></tr></table>";

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //           lEmailContent = lEmailContent + "<td width=20%>" + "Delivery Address (送货地址)" + "</td>";

        //           lVar = "&nbsp;";
        //           if (JobContent.DeliveryAddress != null) lVar = JobContent.DeliveryAddress.Trim();
        //           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr>";

        //           lEmailContent = lEmailContent + "<tr><td>" + "Remarks (备注)" + "</td>";

        //           lVar = "&nbsp;";
        //           if (JobContent.Remarks != null) lVar = JobContent.Remarks.Trim();
        //           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //           if (JobContent.TotalCABWeight > 0)
        //           {
        //               lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //               lEmailContent = lEmailContent + "<td width='20%'>" + "BBS No.\n(钢筋加工表)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='15%'>" + "BBS Description\n(具体描述)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='17%'>" + "Structure Element\n(构件)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='14%'>" + "CAB Weight\n(加工铁重量)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='16%'>" + "SB Weight\n(标准直铁重量)" + "</td>";
        //               lEmailContent = lEmailContent + "<td>" + "Total Weight\n(总重量)" + "</td></tr>";


        //               var lBBSContent = (from p in db.BBS
        //                                  where p.CustomerCode == CustomerCode &&
        //                                  p.ProjectCode == ProjectCode &&
        //                                  p.JobID == JobID &&
        //                                  p.BBSOrderCABWT + p.BBSOrderSTDWT > 0
        //                                  orderby p.BBSID
        //                                  select p).ToList();

        //               if (lBBSContent.Count > 0)
        //               {
        //                   for (int i = 0; i < lBBSContent.Count; i++)
        //                   {
        //                       lEmailContent = lEmailContent + "<tr><td> <font color='blue'>" + lBBSContent[i].BBSNo + "</font></td>";
        //                       lEmailContent = lEmailContent + "<td>" + lBBSContent[i].BBSDesc + "</td>";
        //                       lEmailContent = lEmailContent + "<td>" + lBBSContent[i].BBSStrucElem + "</td>";
        //                       if (lBBSContent[i].BBSOrderCABWT == 0) lVar = ""; else lVar = lBBSContent[i].BBSOrderCABWT.ToString("F3");
        //                       lEmailContent = lEmailContent + "<td align='left'>" + lVar + "</td>";
        //                       if (lBBSContent[i].BBSOrderSTDWT == 0) lVar = ""; else lVar = lBBSContent[i].BBSOrderSTDWT.ToString("F3");
        //                       lEmailContent = lEmailContent + "<td align='left'>" + lVar + "</td>";
        //                       lEmailContent = lEmailContent + "<td align='left'>" + (lBBSContent[i].BBSOrderCABWT + lBBSContent[i].BBSOrderSTDWT).ToString("F3") + "</td></tr>";
        //                   }
        //               }
        //               lEmailContent = lEmailContent + "</table>";
        //           }
        //           else
        //           {
        //               lEmailContent = lEmailContent + "<table border='1' width=100%>";
        //               lEmailContent = lEmailContent + "<tr><td width='5%'>" + "S/N\n序号" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='20%' align='ceneter'>" + "Bar Type\n(钢筋型号)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='20%' align='ceneter'>" + "Size\n(直径)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='20%' align='ceneter'>" + "Bar Length\n(长度)" + "</td>";
        //               lEmailContent = lEmailContent + "<td width='20%' align='ceneter'>" + "No. of Bundles\n(捆数)" + "</td>";
        //               lEmailContent = lEmailContent + "<td  align='ceneter'>" + "Total Weight\n(总重量)" + "</td></tr>";


        //               var lBBSContent = (from p in db.OrderDetails
        //                                  where p.CustomerCode == CustomerCode &&
        //                                  p.ProjectCode == ProjectCode &&
        //                                  p.JobID == JobID &&
        //                                  p.BarSTD == true
        //                                  orderby p.BBSID
        //                                  select p).ToList();

        //               if (lBBSContent.Count > 0)
        //               {
        //                   for (int i = 0; i < lBBSContent.Count; i++)
        //                   {
        //                       lEmailContent = lEmailContent + "<tr><td align='ceneter'>" + (i + 1).ToString() + "</td>";
        //                       lEmailContent = lEmailContent + "<td  align='ceneter'>" + lBBSContent[i].BarType + "</td>";
        //                       lEmailContent = lEmailContent + "<td  align='ceneter'>" + lBBSContent[i].BarSize + "</td>";
        //                       lEmailContent = lEmailContent + "<td  align='ceneter'>" + lBBSContent[i].BarLength + "</td>";
        //                       lEmailContent = lEmailContent + "<td  align='ceneter'>" + lBBSContent[i].BarMemberQty + "</td>";
        //                       lEmailContent = lEmailContent + "<td  align='ceneter'>" + ((decimal)lBBSContent[i].BarWeight).ToString("F0") + "</td></tr>";
        //                   }
        //               }
        //               lEmailContent = lEmailContent + "</table>";

        //           }

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //           lEmailContent = lEmailContent + "<td colspan='6'>" + "Site Contact (工地联系人)" + "</td></tr>";

        //           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Goods Receiver\n(收货人)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width='15%'>" + JobContent.SiteEngr_Name.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width='13%'>" + "H / P\n(手机号码)" + " </td>";
        //           lEmailContent = lEmailContent + "<td width='16%'>" + JobContent.SiteEngr_HP.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width='13%'>" + "Email\n(电邮地址)" + "</td>";
        //           lEmailContent = lEmailContent + "<td>" + JobContent.SiteEngr_Tel.Trim() + "</td></tr>";

        //           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Site Contact\n(联系人)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width='15%'>" + JobContent.Scheduler_Name.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width='13%'>" + "H / P\n(手机号码)" + " </td>";
        //           lEmailContent = lEmailContent + "<td width='16%'>" + JobContent.Scheduler_HP.Trim() + "</td>";
        //           lEmailContent = lEmailContent + "<td width='13%'>" + "Email\n(电邮地址)" + "</td>";
        //           lEmailContent = lEmailContent + "<td>" + JobContent.Scheduler_Tel.Trim() + "</td></tr></table>";

        //           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //           lEmailContent = lEmailContent + "<td colspan='3'>" + "NatSteel Contacts (大众钢铁联系人) (Fax:62619133)" + "</td></tr>";

        //           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Name (姓名)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width='15%'>" + "Contact Numbers (联系电话)" + "</td>";
        //           lEmailContent = lEmailContent + "<td width='13%'>" + "Email Address (电邮地址)" + " </td></tr>";


        //           var lProjContent = db.Project.Find(CustomerCode, ProjectCode);

        //           if (lProjContent.Contact1 != null)
        //           {
        //               if (lProjContent.Contact1.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact1.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel1 != null) if (lProjContent.Tel1.Trim().Length > 0) lVar1 = lProjContent.Tel1.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email1 != null) if (lProjContent.Email1.Trim().Length > 0) lVar1 = lProjContent.Email1.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }

        //           if (lProjContent.Contact2 != null)
        //           {
        //               if (lProjContent.Contact2.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact2.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel2 != null) if (lProjContent.Tel2.Trim().Length > 0) lVar1 = lProjContent.Tel2.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email2 != null) if (lProjContent.Email2.Trim().Length > 0) lVar1 = lProjContent.Email2.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }

        //           if (lProjContent.Contact3 != null)
        //           {
        //               if (lProjContent.Contact3.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact3.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel3 != null) if (lProjContent.Tel3.Trim().Length > 0) lVar1 = lProjContent.Tel3.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email3 != null) if (lProjContent.Email3.Trim().Length > 0) lVar1 = lProjContent.Email3.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }

        //           if (lProjContent.Contact4 != null)
        //           {
        //               if (lProjContent.Contact4.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact4.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel4 != null) if (lProjContent.Tel4.Trim().Length > 0) lVar1 = lProjContent.Tel4.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email4 != null) if (lProjContent.Email4.Trim().Length > 0) lVar1 = lProjContent.Email4.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }

        //           if (lProjContent.Contact5 != null)
        //           {
        //               if (lProjContent.Contact5.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact5.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel5 != null) if (lProjContent.Tel5.Trim().Length > 0) lVar1 = lProjContent.Tel5.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email5 != null) if (lProjContent.Email5.Trim().Length > 0) lVar1 = lProjContent.Email5.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }

        //           if (lProjContent.Contact6 != null)
        //           {
        //               if (lProjContent.Contact6.Trim().Length > 0)
        //               {
        //                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact6.Trim() + "</td>";
        //                   lVar1 = "";
        //                   if (lProjContent.Tel6 != null) if (lProjContent.Tel6.Trim().Length > 0) lVar1 = lProjContent.Tel6.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                   lVar1 = "";
        //                   if (lProjContent.Email6 != null) if (lProjContent.Email6.Trim().Length > 0) lVar1 = lProjContent.Email6.Trim();
        //                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //               }
        //           }
        //           lEmailContent = lEmailContent + "</table>";

        //           // Scheduler email
        //           if (JobContent != null)
        //           {
        //               lVar1 = JobContent.Scheduler_Tel.Trim();
        //               if (lVar1.Length > 0)
        //               {
        //                   if (lEmailCc == "")
        //                   {
        //                       lEmailCc = lVar1;
        //                   }
        //                   else
        //                   {
        //                       lEmailCc = lEmailCc + ";" + lVar1;
        //                   }
        //               }

        //               lVar1 = JobContent.SiteEngr_Tel.Trim();
        //               if (lVar1.Length > 0 && lEmailCc.IndexOf(lVar1) < 0)
        //               {
        //                   if (lEmailCc == "")
        //                   {
        //                       lEmailCc = lVar1;
        //                   }
        //                   else
        //                   {
        //                       lEmailCc = lEmailCc + ";" + lVar1;
        //                   }
        //               }

        //               if (JobContent.UpdateBy != null)
        //               {
        //                   lVar1 = JobContent.UpdateBy.Trim();
        //                   if (lVar1 != "" && lEmailCc.IndexOf(lVar1) < 0)
        //                   {
        //                       if (lEmailCc == "") { lEmailCc = lVar1; }
        //                       else { lEmailCc = lEmailCc + ";" + lVar1; }
        //                   }
        //               }
        //           }

        //           if (lProjContent.EmailDistribution != null)
        //           {
        //               lVar1 = lProjContent.EmailDistribution.Trim();
        //               if (lVar1.Length > 0 && lEmailCc.IndexOf(lVar1) < 0)
        //               {
        //                   if (lEmailCc == "")
        //                   {
        //                       lEmailCc = lVar1;
        //                   }
        //                   else
        //                   {
        //                       lEmailCc = lEmailCc + ";" + lVar1;
        //                   }
        //               }

        //           }


        //           lVar = "";
        //           if (lCustomer != null) lVar = lCustomer.CustomerName.Trim();

        //           lEmailSubject = lVar + " - " + JobContent.PONumber.Trim() + " - CAB/SB No. " + JobID.ToString();

        //           var lOESEmail = new SendGridEmail();

        //           string lEmailFromAddress = "eprompt@natsteel.com.sg";
        //           string lEmailFromName = "Digital Ordering Email Services";

        //           //dynamic response = lOESEmail.Execute(lEmailFromAddress, lEmailFromName, lEmailTo, lEmailCc, lEmailSubject, "text/html", lEmailContent);
        //           lOESEmail.Execute(lEmailFromAddress, lEmailFromName, lEmailTo, lEmailCc, lEmailSubject, "text/html", lEmailContent).Wait();
        //           lOESEmail = null;
        //           return Json(true);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getProject(string CustomerCode)
        //       {
        //           string lUserType = "";
        //           string lGroupName = "";

        //           OracleDataReader lRst;
        //           var lCmd = new OracleCommand();
        //           var lcisCon = new OracleConnection();



        //           if (gUserType != null && gUserType != "" && gGroupName != null && gGroupName != "")
        //           {
        //               lUserType = gUserType;
        //               lGroupName = gGroupName;
        //           }
        //           else
        //           {
        //               UserAccessController lUa = new UserAccessController();
        //               lUserType = lUa.getUserType(User.Identity.GetUserName());
        //               lGroupName = lUa.getGroupName(User.Identity.GetUserName());
        //               gUserType = lUserType;
        //               gGroupName = lGroupName;
        //               lUa = null;
        //           }

        //           List<ProjectListModels> content = new List<ProjectListModels> {
        //               new ProjectListModels
        //               {
        //                   CustomerCode = "",
        //                   ProjectCode = "",
        //                   ProjectTitle = ""
        //               } };

        //           if (lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU" || lUserType == "TE")
        //           {
        //               //content = (from p in db.ProjectList
        //               //           where p.CustomerCode == CustomerCode &&
        //               //           (from m in db.Project
        //               //            where m.CustomerCode == CustomerCode
        //               //            select m.ProjectCode).Contains(p.ProjectCode)
        //               //           orderby p.ProjectTitle
        //               //           select p).ToList();

        //               // try the sql.
        //               //content = db.Database.SqlQuery<ProjectListModels>(
        //               //    "SELECT * FROM OESProjectList P " +
        //               //    "WHERE P.CustomerCode = @cust " +
        //               //    "ORDER BY ProjectTitle ", new SqlParameter("cust", CustomerCode)).ToList();

        //               //if (content.Count() > 0)
        //               //{
        //               //    content = RemoveNonCABProject_Oracle(content);
        //               //}

        //               content = new List<ProjectListModels>();

        //               if (lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU" || lUserType == "TE")
        //               {
        //                   #region Get from SAP
        //                   var lDa = new OracleDataAdapter();
        //                   var lOCmd = new OracleCommand();
        //                   var lDs = new DataSet();
        //                   var lDStatus = new DataSet();
        //                   var lOcisCon = new OracleConnection();
        //                   var lProcess = new ProcessController();

        //                   lOCmd.CommandText = "SELECT (NAME1 || NAME2) AS SHIP_TO_NAME,KUNNR AS SHIP_TO_PARTY FROM SAPSR3.KNA1 " +
        //                   "WHERE KTOKD = 'Y001' AND MANDT ='" + lProcess.strClient + "' " +
        //                   "AND KUNNR IN (SELECT KUNNR FROM SAPSR3.VBPA WHERE MANDT='" + lProcess.strClient + "' " +
        //                   "AND VBELN IN (SELECT VBELN FROM SAPSR3.VBAK WHERE MANDT ='" + lProcess.strClient + "' " +
        //                   "AND (VBELN like '102%' OR VBELN like '_102%') " +
        //                   "AND (ytot_cab > 0 " +
        //                   "OR ytot_rebar > 0) " +
        //                   "AND KUNNR ='" + CustomerCode + "' AND TRVOG ='4' " +
        //                   "AND to_date(GUEEN, 'yyyymmdd') >=  (SYSDATE - 180) )) " +
        //                   "ORDER BY 1 ";

        //                   if (lProcess.OpenCISConnection(ref lOcisCon) == true)
        //                   {
        //                       lOCmd.Connection = lOcisCon;
        //                       lDa.SelectCommand = lOCmd;
        //                       lDs.Clear();
        //                       lDa.Fill(lDs);
        //                       if (lDs.Tables[0].Rows.Count > 0)
        //                           for (int i = 0; i < lDs.Tables[0].Rows.Count; i++)
        //                           {
        //                               string lName = ((string)lDs.Tables[0].Rows[i].ItemArray[0]).Trim();
        //                               string lCode = ((string)lDs.Tables[0].Rows[i].ItemArray[1]).Trim();
        //                               content.Add(new ProjectListModels
        //                               {
        //                                   CustomerCode = CustomerCode,
        //                                   ProjectCode = lCode,
        //                                   ProjectTitle = lName
        //                               });
        //                           }
        //                       lProcess.CloseCISConnection(ref lOcisCon);
        //                   }
        //                   lDa = null;
        //                   lOCmd = null;
        //                   lDs = null;
        //                   lDStatus = null;
        //                   lOcisCon = null;
        //                   lProcess = null;
        //                   #endregion
        //               }
        //               else
        //               {
        //                   #region Get from NDS
        //                   var lDa = new SqlDataAdapter();
        //                   var lOCmd = new SqlCommand();
        //                   var lDs = new DataSet();
        //                   var lDStatus = new DataSet();
        //                   var lOcisCon = new SqlConnection();
        //                   var lProcess = new ProcessController();

        //                   lOCmd.CommandText = "SELECT P.vchProjectCode, P.vchProjectName " +
        //                   "FROM dbo.ProjectMaster P, " +
        //                   "dbo.ContractMaster C, " +
        //                   "dbo.CustomerMaster A, " +
        //                   "dbo.ContractProductMapping M " +
        //                   "WHERE P.intContractID = C.intContractID " +
        //                   "AND A.intCustomerCode = C.intCustomerCode " +
        //                   "AND C.vchContractNumber = M.VBELN " +
        //                   "AND M.mandt = '" + lProcess.strClient + "' " +
        //                   "AND(ytot_cab > 0 " +
        //                   "OR ytot_rebar > 0) " +
        //                   "AND datEndDate > DATEADD(dd, -180, getDate()) " +
        //                   "AND vchCustomerNo = '" + CustomerCode + "' " +
        //                   "GROUP BY P.vchProjectCode, P.vchProjectName " +
        //                   "ORDER BY P.vchProjectName ";

        //                   if (lProcess.OpenNDSConnection(ref lOcisCon) == true)
        //                   {
        //                       lOCmd.Connection = lOcisCon;
        //                       lDa.SelectCommand = lOCmd;
        //                       lDs.Clear();
        //                       lDa.Fill(lDs);
        //                       if (lDs.Tables[0].Rows.Count > 0)
        //                           for (int i = 0; i < lDs.Tables[0].Rows.Count; i++)
        //                           {
        //                               string lCode = ((string)lDs.Tables[0].Rows[i].ItemArray[0]).Trim();
        //                               string lName = ((string)lDs.Tables[0].Rows[i].ItemArray[1]).Trim();
        //                               content.Add(new ProjectListModels
        //                               {
        //                                   CustomerCode = CustomerCode,
        //                                   ProjectCode = lCode,
        //                                   ProjectTitle = lName
        //                               });
        //                           }
        //                       lProcess.CloseNDSConnection(ref lOcisCon);
        //                   }
        //                   lDa = null;
        //                   lOCmd = null;
        //                   lDs = null;
        //                   lDStatus = null;
        //                   lOcisCon = null;
        //                   lProcess = null;
        //                   #endregion
        //               }
        //           }
        //           else
        //           {
        //               content = (from p in db.ProjectList
        //                          where p.CustomerCode == CustomerCode &&
        //                          (from u in db.UserAccess
        //                           where u.UserName == lGroupName &&
        //                           u.CustomerCode == CustomerCode
        //                           select u.ProjectCode).Contains(p.ProjectCode)
        //                          orderby p.ProjectTitle
        //                          select p).ToList();

        //               if (content.Count() > 0)
        //               {
        //                   content = RemoveNonCABProject(content);
        //               }

        //           }


        //           if (content.Count() == 0)
        //           {
        //               content = new List<ProjectListModels> {
        //                       new ProjectListModels
        //                       {
        //                           CustomerCode = "",
        //                           ProjectCode = "",
        //                           ProjectTitle = ""
        //                       }
        //                   };
        //           }

        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        //       List<ProjectListModels> RemoveNonCABProject_Oracle(List<ProjectListModels> pInputProj)
        //       {
        //           List<ProjectListModels> lReturn = new List<ProjectListModels>();
        //           string lProjectCode = "";

        //           OracleDataReader lRst;
        //           var lCmd = new OracleCommand();
        //           var lcisCon = new OracleConnection();

        //           if (pInputProj.Count() > 0)
        //           {
        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenCISConnection(ref lcisCon) == true)
        //               {
        //                   var lSQL = "";
        //                   for (int i = 0; i < pInputProj.Count(); i++)
        //                   {
        //                       if (lSQL == "")
        //                       {
        //                           lSQL = " P.KUNNR = '" + pInputProj[i].ProjectCode + "' ";
        //                       }
        //                       else
        //                       {
        //                           lSQL = lSQL + " OR " + "P.KUNNR = '" + pInputProj[i].ProjectCode + "' ";
        //                       }
        //                   }


        //                   lCmd.CommandText = "SELECT distinct P.KUNNR " +
        //                   "FROM SAPSR3.VBAK K, SAPSR3.VBPA P " +
        //                   "WHERE K.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND (K.VBELN like '102%' OR K.VBELN like '_102%') " +
        //                   "AND P.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND K.VKORG = '" + lProcessObj.strSalesOrg + "' " +
        //                   "AND K.KUNNR = '" + pInputProj[0].CustomerCode + "' " +
        //                   "AND K.TRVOG = '4' " +
        //                   "AND (K.ytot_cab > 0 " +
        //                   "OR K.ytot_rebar > 0) " +
        //                   "AND k.VBELN = P.VBELN " +
        //                   "AND ( " + lSQL + " ) ";

        //                   lCmd.Connection = lcisCon;
        //                   lCmd.CommandTimeout = 1200;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       while (lRst.Read())
        //                       {
        //                           lProjectCode = lRst.GetString(0);

        //                           for (int i = 0; i < pInputProj.Count(); i++)
        //                           {
        //                               if (pInputProj[i].ProjectCode.Trim() == lProjectCode.Trim())
        //                               {
        //                                   lReturn.Add(pInputProj[i]);
        //                               }
        //                           }

        //                       }
        //                   }
        //                   lRst.Close();


        //                   lProcessObj.CloseCISConnection(ref lcisCon);
        //               }
        //               lCmd = null;
        //               lRst = null;
        //               lProcessObj = null;
        //           }

        //           return lReturn;
        //       }

        //       List<ProjectListModels> RemoveNonCABProject(List<ProjectListModels> pInputProj)
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           if (pInputProj.Count() > 0)
        //           {
        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //               {
        //                   for (int i = pInputProj.Count() - 1; i >= 0; i--)
        //                   {
        //                       lCmd.CommandText =
        //                       "SELECT isNull(ProjectCAB,0) " +
        //                       "from dbo.OESProject " +
        //                       "WHERE CustomerCode = '" + pInputProj[i].CustomerCode + "' " +
        //                       "AND ProjectCode = '" + pInputProj[i].ProjectCode + "' " +
        //                       "AND ProjectCAB = 1 ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 1200;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (!lRst.HasRows)
        //                       {
        //                           pInputProj.RemoveAt(i);
        //                       }
        //                       lRst.Close();
        //                   }
        //               }

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               lCmd = null;
        //               lRst = null;
        //               lProcessObj = null;
        //           }

        //           return pInputProj;
        //       }

        //       //get shape List 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getAllShapeCodeList(string CustomerCode, string ProjectCode)
        //       {
        //           var lUserName = User.Identity.GetUserName();
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lReturn = (new[]{ new
        //           {
        //               shapeCode = "",
        //               shapeCategory = "",
        //               shapeCommon = 0,
        //               ProdLenFormula = "",
        //               ShapeParas = "",
        //               ShapeParaType = "",
        //               ShapeParaInputType = "",
        //               ShapeParaValue = ""
        //           }}).ToList();



        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               var lProjectCode = "0000000000";
        //               if (ProjectCode != null && ProjectCode != "")
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT COUNT(*) " +
        //                   "FROM dbo.OESTopShape " +
        //                   "WHERE ProjectCode = '" + ProjectCode + "' ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       if (lRst.Read())
        //                       {
        //                           if (lRst.GetInt32(0) > 0)
        //                           {
        //                               lProjectCode = ProjectCode;
        //                           }
        //                       }
        //                   }
        //                   lRst.Close();
        //               }

        //               if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, " +
        //                   "( CASE WHEN  " +
        //                   "(SELECT COUNT(*) " +
        //                   "FROM dbo.OESTopShape " +
        //                   "WHERE ProjectCode = '" + lProjectCode + "'" +
        //                   "AND ShapeCode = S.CSM_SHAPE_ID) > 0 then 1 else 0 END) as CommomShape, " +

        //                   "(SELECT ISNULL(VCHPRODLENGTHFORMULA, '') " +
        //                   "FROM dbo.shapemaster_cube " +
        //                   "WHERE chrShapeCode = S.CSM_SHAPE_ID) as ProdLenFormula, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_MATCH_PAR1,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_MATCH_PAR1 " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParas, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_TYPE,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_TYPE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaType, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_INPUT_TYPE,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_INPUT_TYPE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaInputType, " +

        //                   "isNull(STUFF((SELECT  ',' + CASE WHEN CSD_VISIBLE = 'Visible' THEN '0' " +
        //                   "ELSE CAST(isNull(CSD_PAR2,0) as varchar(10) ) END " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_PAR2, CSD_VISIBLE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaValue " +

        //                   "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                   "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                   "AND CSM_ACT_INACTIVE = 1 " +
        //                   "AND CSM_SHAPE_ID IS NOT NULL " +
        //                   "AND CSM_SHAPE_ID <> '' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                   "ORDER BY CSM_SHAPE_ID ";
        //               }
        //               else
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, " +
        //                   "( CASE WHEN  " +
        //                   "(SELECT COUNT(*) " +
        //                   "FROM dbo.OESTopShape " +
        //                   "WHERE ProjectCode = '" + lProjectCode + "'" +
        //                   "AND ShapeCode = S.CSM_SHAPE_ID) > 0 then 1 else 0 END) as CommomShape, " +

        //                   "(SELECT ISNULL(VCHPRODLENGTHFORMULA, '') " +
        //                   "FROM dbo.shapemaster_cube " +
        //                   "WHERE chrShapeCode = S.CSM_SHAPE_ID) as ProdLenFormula, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_MATCH_PAR1,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_MATCH_PAR1 " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParas, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_TYPE,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_TYPE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaType, " +

        //                   "isNull(STUFF((SELECT  ',' + isNull(CSD_INPUT_TYPE,'') " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_INPUT_TYPE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaInputType, " +

        //                   "isNull(STUFF((SELECT  ',' + CASE WHEN CSD_VISIBLE = 'Visible' THEN '0' " +
        //                   "ELSE CAST(isNull(CSD_PAR2,0) as varchar(10) ) END " +
        //                   "FROM dbo.T_CAB_SHAPE_DTLS C " +
        //                   "WHERE C.CSD_SHAPE_ID = S.CSM_SHAPE_ID " +
        //                   "AND CSD_SEQ_NO > 0 " +
        //                   "GROUP BY CSD_SEQ_NO, CSD_PAR2, CSD_VISIBLE " +
        //                   "ORDER BY CSD_SEQ_NO " +
        //                   "FOR XML PATH('')), 1, 1, ''),'') as ShapeParaValue " +

        //                   "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                   "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                   "AND CSM_ACT_INACTIVE = 1 " +
        //                   "AND CSM_SHAPE_ID IS NOT NULL " +
        //                   "AND CSM_SHAPE_ID <> '' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                   "ORDER BY CSM_SHAPE_ID ";
        //               }

        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       string lShapeCode = lRst.GetString(0);
        //                       if (lShapeCode == null)
        //                       {
        //                           lShapeCode = "";
        //                       }
        //                       if (lShapeCode.Length > 0)
        //                       {
        //                           lShapeCode = lShapeCode.StartsWith("0") == true ? lShapeCode.Substring(1) : lShapeCode;
        //                       }

        //                       var lCalcFormula1 = lRst.GetString(3);
        //                       if (lCalcFormula1.Length > 0)
        //                       {
        //                           lCalcFormula1 = lCalcFormula1.ToUpper();
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "TG", "TAN", RegexOptions.IgnoreCase);

        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "ASIN", "(180/pi)*math.as~in", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "ACOS", "(180/pi)*math.ac~os", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "ATAN", "(180/pi)*math.at~an", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "ATAN2", "math.at~an2", RegexOptions.IgnoreCase);

        //                           var lIndx = 0;
        //                           while (lCalcFormula1.ToUpper().IndexOf("SIN(", lIndx) >= 0)
        //                           {
        //                               lIndx = lCalcFormula1.ToUpper().IndexOf("SIN(", lIndx);

        //                               //find the closing bracket
        //                               var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
        //                               var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
        //                               while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
        //                               {
        //                                   lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
        //                                   lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
        //                               }

        //                               if (lIndx1 > 0)
        //                               {
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
        //                               }
        //                               lIndx = lIndx + 4;
        //                           }

        //                           lIndx = 0;
        //                           while (lCalcFormula1.ToUpper().IndexOf("COS(", lIndx) >= 0)
        //                           {
        //                               lIndx = lCalcFormula1.ToUpper().IndexOf("COS(", lIndx);

        //                               //find the closing bracket
        //                               var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
        //                               var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
        //                               while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
        //                               {
        //                                   lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
        //                                   lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
        //                               }

        //                               if (lIndx1 > 0)
        //                               {
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
        //                               }
        //                               lIndx = lIndx + 4;
        //                           }

        //                           lIndx = 0;
        //                           while (lCalcFormula1.ToUpper().IndexOf("TAN(", lIndx) >= 0)
        //                           {
        //                               lIndx = lCalcFormula1.ToUpper().IndexOf("TAN(", lIndx);

        //                               //find the closing bracket
        //                               var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
        //                               var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
        //                               while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
        //                               {
        //                                   lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
        //                                   lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
        //                               }

        //                               if (lIndx1 > 0)
        //                               {
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
        //                                   lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
        //                               }
        //                               lIndx = lIndx + 4;
        //                           }

        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "PI", "math.pi", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\[", "(", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\]", ")", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\{", "(", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\}", ")", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "SIN\\(", "math.sin(math.pi/180*");
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "COS\\(", "math.cos(math.pi/180*");
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "TAN\\(", "math.tan(math.pi/180*");
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "SQRT", "math.sqrt", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "MAX", "math.max", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "MIN", "math.min", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "POW", "math.pow", RegexOptions.IgnoreCase);
        //                           lCalcFormula1 = Regex.Replace(lCalcFormula1, "~", "", RegexOptions.IgnoreCase);
        //                       }

        //                       lReturn.Add(new
        //                       {
        //                           shapeCode = lShapeCode,
        //                           shapeCategory = lRst.GetString(1),
        //                           shapeCommon = lRst.GetInt32(2),
        //                           ProdLenFormula = lCalcFormula1,
        //                           ShapeParas = lRst.GetString(4),
        //                           ShapeParaType = lRst.GetString(5),
        //                           ShapeParaInputType = lRst.GetString(6),
        //                           ShapeParaValue = lRst.GetString(7)
        //                       });
        //                   }
        //               }
        //               lRst.Close();

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;

        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

        //           return Ok(lReturn);
        //       }

        //       //get customer  
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getCopyCustomer()
        //       {
        //           UserAccessController lUa = new UserAccessController();
        //           var lUserType = lUa.getUserType(User.Identity.GetUserName());
        //           var lGroupName = lUa.getGroupName(User.Identity.GetUserName());

        //           SharedAPIController lBackEnd = new SharedAPIController();
        //           var lCustomerList = lBackEnd.getCustomer(lUserType, lGroupName);

        //           lBackEnd = null;
        //           return Json(lCustomerList, JsonRequestBehavior.AllowGet);
        //       }

        [HttpGet]
        //[ValidateAntiForgeryHeader]
        [Route("/getProjectStageCAB")]
        public ActionResult getProjectStage()
        {
            var content = (from p in db.ProjectStage
                           orderby p.prj_level_desc
                           select new
                           {
                               prj_level_cat = p.prj_level_cat.Trim(),
                               prj_level_desc = p.prj_level_desc.Trim()
                           }).ToList();
            return Ok(content);
        }

        [HttpGet]
        [Route("/getProjectDetails/{CustomerCode}/{ProjectCode}/{UserName}")]
        public ActionResult getProjectDetails(string CustomerCode, string ProjectCode, string UserName)
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            string lUserType = "";

            UserAccessController lUa = new UserAccessController();
            lUserType = lUa.getUserType(UserName);
            gUserType = lUserType;
            lUa = null;

            var content1 = new ProjectAccessModels();

            if (lUserType == "CU" || lUserType == "CA" || lUserType == "CM")
            {
                lCmd.CommandText = "SELECT " +
                "P.CustomerCode, " +
                "P.ProjectCode, " +
                "P.ProjectTitle, " +
                "SiteEngr_Name, " +
                "SiteEngr_HP, " +
                "SiteEngr_Tel, " +
                "Scheduler_Name, " +
                "Scheduler_HP, " +
                "Scheduler_Tel, " +
                "Contact1, " +
                "Contact2, " +
                "Contact3, " +
                "Contact4, " +
                "Contact5, " +
                "Contact6, " +
                "Tel1, " +
                "Tel2, " +
                "Tel3, " +
                "Tel4, " +
                "Tel5, " +
                "Tel6, " +
                "Email1, " +
                "Email2, " +
                "Email3, " +
                "Email4, " +
                "Email5, " +
                "Email6, " +
                "MaxBarLength, " +
                "OrderSubmission, " +
                "OrderCreation, " +
                "CustomerBar, " +
                "SkipBendCheck, " +
                "BBSStandard, " +
                "VarianceBarSplit " +
                "FROM dbo.OESProject P, dbo.OESUserAccess U " +
                "WHERE P.CustomerCode = U.CustomerCode " +
                "AND P.ProjectCode = U.ProjectCode " +
                "AND U.UserName = '" + UserName + "' " +
                "AND U.CustomerCode = '" + CustomerCode + "' " +
                "AND U.ProjectCode = '" + ProjectCode + "' ";
            }
            else if (lUserType == "TE" || lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU")
            {
                lCmd.CommandText = "SELECT " +
                "CustomerCode, " +
                "ProjectCode, " +
                "ProjectTitle, " +
                "SiteEngr_Name, " +
                "SiteEngr_HP, " +
                "SiteEngr_Tel, " +
                "Scheduler_Name, " +
                "Scheduler_HP, " +
                "Scheduler_Tel, " +
                "Contact1, " +
                "Contact2, " +
                "Contact3, " +
                "Contact4, " +
                "Contact5, " +
                "Contact6, " +
                "Tel1, " +
                "Tel2, " +
                "Tel3, " +
                "Tel4, " +
                "Tel5, " +
                "Tel6, " +
                "Email1, " +
                "Email2, " +
                "Email3, " +
                "Email4, " +
                "Email5, " +
                "Email6, " +
                "MaxBarLength, " +
                "'Yes' as OrderSubmission, " +
                "'Yes' as OrderCreation, " +
                "CustomerBar, " +
                "SkipBendCheck, " +
                "BBSStandard, " +
                "VarianceBarSplit " +
                "FROM dbo.OESProject P " +
                "WHERE P.CustomerCode = '" + CustomerCode + "' " +
                "AND P.ProjectCode = '" + ProjectCode + "' ";
            }
            else
            {
                lCmd.CommandText = "SELECT " +
                "CustomerCode, " +
                "ProjectCode, " +
                "ProjectTitle, " +
                "SiteEngr_Name, " +
                "SiteEngr_HP, " +
                "SiteEngr_Tel, " +
                "Scheduler_Name, " +
                "Scheduler_HP, " +
                "Scheduler_Tel, " +
                "Contact1, " +
                "Contact2, " +
                "Contact3, " +
                "Contact4, " +
                "Contact5, " +
                "Contact6, " +
                "Tel1, " +
                "Tel2, " +
                "Tel3, " +
                "Tel4, " +
                "Tel5, " +
                "Tel6, " +
                "Email1, " +
                "Email2, " +
                "Email3, " +
                "Email4, " +
                "Email5, " +
                "Email6, " +
                "MaxBarLength, " +
                "'No' as OrderSubmission, " +
                "'No' as OrderCreation, " +
                "CustomerBar, " +
                "SkipBendCheck, " +
                "BBSStandard, " +
                "VarianceBarSplit " +
                "FROM dbo.OESProject P " +
                "WHERE P.CustomerCode = '" + CustomerCode + "' " +
                "AND P.ProjectCode = '" + ProjectCode + "' ";
            }

            var lProcessObj = new ProcessController();
            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    if (lRst.Read())
                    {
                        content1 = new ProjectAccessModels
                        {
                            CustomerCode = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim(),
                            ProjectCode = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim(),
                            ProjectTitle = lRst.GetValue(2) == DBNull.Value ? "" : lRst.GetString(2).Trim(),
                            SiteEngr_Name = lRst.GetValue(3) == DBNull.Value ? "" : lRst.GetString(3).Trim(),
                            SiteEngr_HP = lRst.GetValue(4) == DBNull.Value ? "" : lRst.GetString(4).Trim(),
                            SiteEngr_Tel = lRst.GetValue(5) == DBNull.Value ? "" : lRst.GetString(5).Trim(),
                            Scheduler_Name = lRst.GetValue(6) == DBNull.Value ? "" : lRst.GetString(6).Trim(),
                            Scheduler_HP = lRst.GetValue(7) == DBNull.Value ? "" : lRst.GetString(7).Trim(),
                            Scheduler_Tel = lRst.GetValue(8) == DBNull.Value ? "" : lRst.GetString(8).Trim(),
                            Contact1 = lRst.GetValue(9) == DBNull.Value ? "" : lRst.GetString(9).Trim(),
                            Contact2 = lRst.GetValue(10) == DBNull.Value ? "" : lRst.GetString(10).Trim(),
                            Contact3 = lRst.GetValue(11) == DBNull.Value ? "" : lRst.GetString(11).Trim(),
                            Contact4 = lRst.GetValue(12) == DBNull.Value ? "" : lRst.GetString(12).Trim(),
                            Contact5 = lRst.GetValue(13) == DBNull.Value ? "" : lRst.GetString(13).Trim(),
                            Contact6 = lRst.GetValue(14) == DBNull.Value ? "" : lRst.GetString(14).Trim(),
                            Tel1 = lRst.GetValue(15) == DBNull.Value ? "" : lRst.GetString(15).Trim(),
                            Tel2 = lRst.GetValue(16) == DBNull.Value ? "" : lRst.GetString(16).Trim(),
                            Tel3 = lRst.GetValue(17) == DBNull.Value ? "" : lRst.GetString(17).Trim(),
                            Tel4 = lRst.GetValue(18) == DBNull.Value ? "" : lRst.GetString(18).Trim(),
                            Tel5 = lRst.GetValue(19) == DBNull.Value ? "" : lRst.GetString(19).Trim(),
                            Tel6 = lRst.GetValue(20) == DBNull.Value ? "" : lRst.GetString(20).Trim(),
                            Email1 = lRst.GetValue(21) == DBNull.Value ? "" : lRst.GetString(21).Trim(),
                            Email2 = lRst.GetValue(22) == DBNull.Value ? "" : lRst.GetString(22).Trim(),
                            Email3 = lRst.GetValue(23) == DBNull.Value ? "" : lRst.GetString(23).Trim(),
                            Email4 = lRst.GetValue(24) == DBNull.Value ? "" : lRst.GetString(24).Trim(),
                            Email5 = lRst.GetValue(25) == DBNull.Value ? "" : lRst.GetString(25).Trim(),
                            Email6 = lRst.GetValue(26) == DBNull.Value ? "" : lRst.GetString(26).Trim(),
                            MaxBarLength = lRst.GetValue(27) == DBNull.Value ? 12000 : lRst.GetInt32(27),
                            OrderSubmission = lRst.GetValue(28) == DBNull.Value ? "No" : lRst.GetString(28).Trim(),
                            OrderCreation = lRst.GetValue(29) == DBNull.Value ? "No" : lRst.GetString(29).Trim(),
                            CustomerBar = lRst.GetValue(30) == DBNull.Value ? "" : lRst.GetString(30).Trim(),
                            SkipBendCheck = lRst.GetValue(31) == DBNull.Value ? "N" : (lRst.GetBoolean(31) == true ? "Y" : "N"),
                            BBSStandard = lRst.GetValue(32) == DBNull.Value ? "" : lRst.GetString(32),
                            VarianceBarSplit = lRst.GetValue(33) == DBNull.Value ? "N" : (lRst.GetBoolean(33) == true ? "Y" : "N")
                        };
                    }
                }
                lRst.Close();

                if ((content1.CustomerCode == null || content1.ProjectCode == null) & CustomerCode != null && ProjectCode != null)
                {
                    if (CustomerCode.Trim().Length > 0 && ProjectCode.Trim().Length > 0)
                    {
                        createProject(CustomerCode, ProjectCode);

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                content1 = new ProjectAccessModels
                                {
                                    CustomerCode = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim(),
                                    ProjectCode = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim(),
                                    ProjectTitle = lRst.GetValue(2) == DBNull.Value ? "" : lRst.GetString(2).Trim(),
                                    SiteEngr_Name = lRst.GetValue(3) == DBNull.Value ? "" : lRst.GetString(3).Trim(),
                                    SiteEngr_HP = lRst.GetValue(4) == DBNull.Value ? "" : lRst.GetString(4).Trim(),
                                    SiteEngr_Tel = lRst.GetValue(5) == DBNull.Value ? "" : lRst.GetString(5).Trim(),
                                    Scheduler_Name = lRst.GetValue(6) == DBNull.Value ? "" : lRst.GetString(6).Trim(),
                                    Scheduler_HP = lRst.GetValue(7) == DBNull.Value ? "" : lRst.GetString(7).Trim(),
                                    Scheduler_Tel = lRst.GetValue(8) == DBNull.Value ? "" : lRst.GetString(8).Trim(),
                                    Contact1 = lRst.GetValue(9) == DBNull.Value ? "" : lRst.GetString(9).Trim(),
                                    Contact2 = lRst.GetValue(10) == DBNull.Value ? "" : lRst.GetString(10).Trim(),
                                    Contact3 = lRst.GetValue(11) == DBNull.Value ? "" : lRst.GetString(11).Trim(),
                                    Contact4 = lRst.GetValue(12) == DBNull.Value ? "" : lRst.GetString(12).Trim(),
                                    Contact5 = lRst.GetValue(13) == DBNull.Value ? "" : lRst.GetString(13).Trim(),
                                    Contact6 = lRst.GetValue(14) == DBNull.Value ? "" : lRst.GetString(14).Trim(),
                                    Tel1 = lRst.GetValue(15) == DBNull.Value ? "" : lRst.GetString(15).Trim(),
                                    Tel2 = lRst.GetValue(16) == DBNull.Value ? "" : lRst.GetString(16).Trim(),
                                    Tel3 = lRst.GetValue(17) == DBNull.Value ? "" : lRst.GetString(17).Trim(),
                                    Tel4 = lRst.GetValue(18) == DBNull.Value ? "" : lRst.GetString(18).Trim(),
                                    Tel5 = lRst.GetValue(19) == DBNull.Value ? "" : lRst.GetString(19).Trim(),
                                    Tel6 = lRst.GetValue(20) == DBNull.Value ? "" : lRst.GetString(20).Trim(),
                                    Email1 = lRst.GetValue(21) == DBNull.Value ? "" : lRst.GetString(21).Trim(),
                                    Email2 = lRst.GetValue(22) == DBNull.Value ? "" : lRst.GetString(22).Trim(),
                                    Email3 = lRst.GetValue(23) == DBNull.Value ? "" : lRst.GetString(23).Trim(),
                                    Email4 = lRst.GetValue(24) == DBNull.Value ? "" : lRst.GetString(24).Trim(),
                                    Email5 = lRst.GetValue(25) == DBNull.Value ? "" : lRst.GetString(25).Trim(),
                                    Email6 = lRst.GetValue(26) == DBNull.Value ? "" : lRst.GetString(26).Trim(),
                                    MaxBarLength = lRst.GetValue(27) == DBNull.Value ? 12000 : lRst.GetInt32(27),
                                    OrderSubmission = lRst.GetValue(28) == DBNull.Value ? "No" : lRst.GetString(28).Trim(),
                                    OrderCreation = lRst.GetValue(29) == DBNull.Value ? "No" : lRst.GetString(29).Trim(),
                                    CustomerBar = lRst.GetValue(30) == DBNull.Value ? "" : lRst.GetString(30).Trim(),
                                    SkipBendCheck = lRst.GetValue(31) == DBNull.Value ? "N" : (lRst.GetBoolean(31) == true ? "Y" : "N"),
                                    BBSStandard = lRst.GetValue(32) == DBNull.Value ? "" : lRst.GetString(32).Trim()
                                };
                            }
                        }
                        lRst.Close();

                    }
                }

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }

            lProcessObj = null;

            return Ok(content1);
        }



        [HttpGet]
        [Route("/createProjectTEST/{CustomerCode}/{ProjectCode}")]
        public void createProject(string CustomerCode, string ProjectCode)
        {
            //var lCISCon = new OracleConnection();
            //var lOraCmd = new OracleCommand();
            //OracleDataReader lOraRst;

            var lNDSCon = new SqlConnection();
            var lSqlCmd = new SqlCommand();
            SqlDataReader lSqlRst;


            var projectModels = new ProjectModels();
            projectModels.CustomerCode = CustomerCode;
            projectModels.ProjectCode = ProjectCode;
            projectModels.MaxBarLength = 12000;
            projectModels.ProjectCAB = false;
            projectModels.ProjectMESH = false;
            projectModels.ProjectBPC = false;
            projectModels.ProjectCage = false;

            projectModels.EspliceN = false;
            projectModels.EspliceS = false;
            projectModels.Nsplice = false;

            var lProjType = getProjectType(projectModels.CustomerCode, projectModels.ProjectCode);
            var lProjTypeArr = lProjType.Split(',');
            if (lProjTypeArr.Length >= 4)
            {
                if (lProjTypeArr[0] != "0")
                {
                    projectModels.ProjectCAB = true;

                }
                if (lProjTypeArr[1] != "0")
                {
                    projectModels.ProjectMESH = true;

                }
                if (lProjTypeArr[2] != "0")
                {
                    projectModels.ProjectBPC = true;

                }
                if (lProjTypeArr[3] != "0")
                {
                    projectModels.ProjectCage = true;

                }
            }
            if (projectModels.ProjectCAB == true)
            {
                var lCouplerType = getCouplerTypeFromSAP(projectModels.CustomerCode, projectModels.ProjectCode);
                if (lCouplerType.Count > 0)
                {
                    for (int i = 0; i < lCouplerType.Count; i++)
                    {
                        if (lCouplerType[i] == "E-Splice(S)")
                        {
                            projectModels.EspliceS = true;
                        }
                        //if (lCouplerType[i] == "E-Splice(N)")
                        //{
                        //    projectModels.EspliceN = true;
                        //}
                        if (lCouplerType[i] == "N-Splice")
                        {
                            projectModels.Nsplice = true;
                        }
                    }
                }
            }

            string lSegment = "";

            var lProcess = new ProcessController();
            if (lProcess.OpenNDSConnection(ref lNDSCon) == true)
            {
                //lOraCmd.CommandText = "select NAME1, TELF1, SMTP_ADDR AS EMAIL " +
                //"FROM SAPSR3.KNA1 left join SAPSR3.ADR6 ON SAPSR3.KNA1.MANDT = SAPSR3.ADR6.CLIENT " +
                //"AND SAPSR3.KNA1.ADRNR = SAPSR3.ADR6.ADDRNUMBER " +
                //"WHERE SAPSR3.KNA1.AUFSD <> '01' AND " +
                //"(MANDT, KUNNR) in  " +
                //"(SELECT MANDT, KUNNR FROM SAPSR3.VBPA WHERE MANDT = '600' " +
                //"AND PARVW = 'Z3' AND VBELN = " +
                //"(SELECT VBELN FROM " +
                //"(SELECT NVL(VBELN,' ') as VBELN FROM SAPSR3.VBPA WHERE MANDT = '600' AND VBELN like '103%' and " +
                //"KUNNR = '" + ProjectCode + "' " +
                //"ORDER BY VBELN DESC)  " +
                //"WHERE ROWNUM = 1 " +
                //")) ";



                //lOraCmd.CommandText  = "select TOP 1 project_name,'', ''  from HMIProjectMaster WHERE project_code='" + ProjectCode + "'"

                //lOraCmd.Connection = lCISCon;
                //lOraCmd.CommandType = CommandType.Text;
                //lOraCmd.CommandTimeout = 1200;
                //lOraRst = lOraCmd.ExecuteReader();
                //if (lOraRst.HasRows)
                //{
                //    lOraRst.Read();
                //    projectModels.ProjectTitle = lOraRst.GetString(2);
                //    lSegment = lOraRst.GetString(1);
                //}

                //lOraRst.Close();

                //if (lSegment != "")
                //{
                //    var lUser = db.UserAccess.Find(lSegment, "0000000000", "0000000000");
                //    if (lUser != null)
                //    {
                //        lSegment = lUser.UserType;
                //        if (lSegment == "P1")
                //        {
                //            lSegment = "S1";
                //        }
                //        else if (lSegment == "P2")
                //        {
                //            lSegment = "S2";
                //        }
                //        else
                //        {
                //            lSegment = "";
                //        }
                //    }
                //    else
                //    {
                //        lSegment = "";
                //    }
                //}


                //lSqlCmd.CommandText = "SELECT (NAME1 || NAME2) AS SHIP_TO_NAME,KUNNR AS Name, BRAN2 " +
                //    "FROM SAPSR3.KNA1 " +
                //    "WHERE KTOKD = 'Y001' AND MANDT = '600' " +
                //    "AND KUNNR = '" + ProjectCode + "' ";

                lSqlCmd.CommandText = "SELECT TOP 1 (project_name+project_name2) AS SHIP_TO_NAME,project_segment, '' FROM HMIProjectMaster WHERE project_code='" + ProjectCode + "'";
                lSqlCmd.Connection = lNDSCon;
                lSqlCmd.CommandType = CommandType.Text;
                lSqlCmd.CommandTimeout = 1200;
                lSqlRst = lSqlCmd.ExecuteReader();
                if (lSqlRst.HasRows)
                {
                    lSqlRst.Read();
                    projectModels.ProjectTitle = lSqlRst.GetString(0);
                    lSegment = lSqlRst.GetString(1);
                    if (lSegment != "" && lSegment != null)
                    {
                        lSegment = lSegment.Substring(0, 2);
                    }
                }

                lSqlRst.Close();
                lProcess.CloseNDSConnection(ref lNDSCon);

            }

            lProcess = null;

            if (lSegment.Trim() == "S2")
            {
                projectModels.Contact1 = "Customer Support Group 3";
                projectModels.Email1 = "csd3@natsteel.com.sg";
            }
            else
            {
                projectModels.Contact1 = "Customer Support Group 1";
                projectModels.Email1 = "csd1@natsteel.com.sg";
            }
            projectModels.EmailDistribution = "";
            projectModels.AdvancedOrder = false;
            projectModels.UpdateDate = DateTime.Now;
            db.Project.Add(projectModels);
            db.SaveChanges();
        }

        string getProjectType(string pCustomerCode, string pProjectCode)
        {
            //OracleDataReader lRst;
            //var lCmd = new OracleCommand();
            //var lcisCon = new OracleConnection();


            SqlDataReader lNDSRst;
            var lNDSCmd = new SqlCommand();
            var lNDSCon = new SqlConnection();

            string lReturn = "0,0,0,0";

            var cabQty = 0;
            var meshQty = 0;
            var bpcQty = 0;
            var prcQty = 0;

            var lProcessObj = new ProcessController();
            //if (lProcessObj.OpenCISConnection(ref lcisCon) == true)
            //{
            //    lCmd.CommandText = "SELECT NVL(SUM(K.ytot_cab + K.ytot_rebar),0), NVL(SUM(K.ytot_mesh),0), NVL(SUM(K.ytot_bpc),0), NVL(SUM(K.ytot_precage),0) " +
            //            "FROM SAPSR3.VBAK K, SAPSR3.VBPA P " +
            //            "WHERE K.MANDT = '" + lProcessObj.strClient + "' " +
            //            "AND (K.VBELN like '102%' OR K.VBELN like '_102%') " +
            //            "AND K.VKORG = '" + lProcessObj.strSalesOrg + "' " +
            //            "AND K.KUNNR = '" + pCustomerCode + "' " +
            //            "AND K.TRVOG = '4' " +
            //            "AND K.MANDT = P.MANDT " +
            //            "AND K.VBELN = P.VBELN " +
            //            "AND P.KUNNR = '" + pProjectCode + "' " +
            //            "AND to_date(K.GUEEN,'YYYYMMDD') >= (SYSDATE - 365) ";


            //    lCmd.Connection = lcisCon;
            //    lCmd.CommandTimeout = 1200;
            //    lRst = lCmd.ExecuteReader();
            //    if (lRst.HasRows)
            //    {
            //        if (lRst.Read())
            //        {
            //            lReturn = lRst.GetDecimal(0).ToString() + ","
            //            + lRst.GetDecimal(1).ToString() + ","
            //            + lRst.GetDecimal(2).ToString() + ","
            //            + lRst.GetDecimal(3).ToString();
            //        }
            //    }
            //    lRst.Close();

            //}

            if(lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                List<string> productcodes = new List<string>();
                List<double> productQty = new List<double>();

                lNDSCmd.CommandText = @"
                     SELECT 
                         PROD_CLASS_CODE, 
                         SUM(CAST(PROD_QTY AS FLOAT)) AS TOTAL_QTY 
                     FROM 
                         HMIContractItem 
                     WHERE 
                         CONTRACT_NO IN (
                             SELECT 
                                 CM.CONTRACT_NO 
                             FROM 
                                 HMIContractMaster CM 
                             INNER JOIN 
                                 HMIContractProject CP 
                                 ON CM.CONTRACT_NO = CP.CONTRACT_NO 
                             WHERE 
                                 CM.CUST_ID = @CustId 
                                 AND CP.PROJECT_CODE = @ProjectCode
                         ) 
                     GROUP BY 
                         PROD_CLASS_CODE";
                lNDSCmd.Parameters.AddWithValue("@CustId", pCustomerCode);
                lNDSCmd.Parameters.AddWithValue("@ProjectCode", pProjectCode);

                lNDSCmd.Connection = lNDSCon;
                lNDSCmd.CommandTimeout = 1200;
                lNDSRst = lNDSCmd.ExecuteReader();
                if (lNDSRst.HasRows)
                {
                    while (lNDSRst.Read())
                    {
                        var productCode = lNDSRst.GetValue(0) == DBNull.Value ? "" : lNDSRst.GetString(0).Trim();
                        var prdQty = lNDSRst.GetValue(1) == DBNull.Value ? 0 : Convert.ToDouble(lNDSRst.GetValue(1));
                        if (productCode == "BAR")
                        {
                            cabQty = (int)(cabQty + prdQty);
                        }else if (productCode == "CAB")
                        {
                            cabQty = (int)(cabQty + prdQty);
                        }
                        else if (productCode == "BPC")
                        {
                            bpcQty = (int)(bpcQty + prdQty);
                        }
                        else if (productCode == "MSH")
                        {
                            meshQty = (int)(meshQty + prdQty);
                        }
                        else if (productCode == "PRC")
                        {
                            prcQty = (int)(prcQty + prdQty);
                        }
                        //productcodes.Add(lNDSRst.GetValue(0) == DBNull.Value ? "" : lNDSRst.GetString(0).Trim());
                        //productQty.Add(lNDSRst.GetValue(1) == DBNull.Value ? 0 : Convert.ToDouble(lNDSRst.GetValue(1)));
                    }

                    lReturn = cabQty.ToString() + "," + meshQty.ToString() + "," + bpcQty.ToString() + "," + prcQty.ToString();
                }
                lNDSRst.Close();
            }

            //lProcessObj.CloseCISConnection(ref lcisCon);
            lProcessObj.CloseNDSConnection(ref lNDSCon);
            //lCmd = null;
            //lRst = null;

            lNDSCmd = null;
            lNDSRst = null;
            lProcessObj = null;

            return lReturn;
        }


        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getOrderList(string CustomerCode, string ProjectCode)
        //       {
        //           //var content = (from p in db.JobAdvice
        //           //               where p.CustomerCode == CustomerCode &&
        //           //               p.ProjectCode == ProjectCode
        //           //               orderby p.JobID descending
        //           //               select p).Take(50).ToList();

        //           createJobAdvice(CustomerCode, ProjectCode, false);
        //           updateOrderStatus(CustomerCode, ProjectCode);

        //           var content = (from p in db.JobAdvice
        //                          let s = db.PODoc.Where(s2 => p.CustomerCode == s2.CustomerCode &&
        //                          p.ProjectCode == s2.ProjectCode &&
        //                          p.JobID == s2.JobID).FirstOrDefault()
        //                          where p.CustomerCode == CustomerCode &&
        //                          p.ProjectCode == ProjectCode
        //                          orderby p.JobID descending
        //                          select new
        //                          {
        //                              JobID = p.JobID,
        //                              PONumber = p.PONumber,
        //                              RequiredDate = p.RequiredDate,
        //                              OrderStatus = p.OrderStatus,
        //                              FileName = s.FileName
        //                          }
        //                          ).Take(50).ToList();

        //           var content1 = new List<struOrderList>(content.Select(h => new struOrderList
        //           {
        //               OrderNo = h.JobID.ToString(),
        //               OrderDesc = h.JobID.ToString() + " PO:" + (h.PONumber == null ? "" : h.PONumber.Trim()) + " RD:"
        //               + (h.RequiredDate == null ? "" : ((DateTime)h.RequiredDate).ToString("yyyy-MM-dd"))
        //               + " Status:" + (h.OrderStatus == null ? "" : h.OrderStatus.Trim()
        //               + (h.FileName == null ? "" : " PO Attached"))
        //           }));

        //           return Json(content1, JsonRequestBehavior.AllowGet);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getCopyPO(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lBBSNo = "";
        //           var lBBSDesc = "";
        //           var lCouplerType = "";
        //           var lTransport = "";
        //           var cBBS = (from p in db.BBS
        //                       where p.CustomerCode == CustomerCode &&
        //                       p.ProjectCode == ProjectCode &&
        //                       p.JobID == JobID
        //                       orderby p.BBSID
        //                       select p).ToList();
        //           if (cBBS != null && cBBS.Count > 0)
        //           {
        //               for (int i = 0; i < cBBS.Count; i++)
        //               {
        //                   if (cBBS[i].BBSNo != null && cBBS[i].BBSNo != "")
        //                   {
        //                       if (lBBSNo == "")
        //                       {
        //                           lBBSNo = cBBS[i].BBSNo;
        //                       }
        //                       else
        //                       {
        //                           lBBSNo = lBBSNo + "," + cBBS[i].BBSNo;
        //                       }
        //                   }
        //                   if (cBBS[i].BBSDesc != null && cBBS[i].BBSDesc != "")
        //                   {
        //                       if (lBBSDesc == "")
        //                       {
        //                           lBBSDesc = cBBS[i].BBSDesc;
        //                       }
        //                       else
        //                       {
        //                           lBBSDesc = lBBSDesc + "," + cBBS[i].BBSDesc;
        //                       }
        //                   }
        //               }
        //           }

        //           var cAdv = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //           if (cAdv != null && cAdv.JobID > 0)
        //           {
        //               lCouplerType = cAdv.CouplerType;
        //               lTransport = cAdv.TransportLimit;
        //           }

        //           var content = (from p in db.OrderProject
        //                          join s in db.OrderProjectSE
        //                          on p.OrderNumber equals s.OrderNumber
        //                          where p.CustomerCode == CustomerCode &&
        //                          p.ProjectCode == ProjectCode &&
        //                          s.CABJobID == JobID
        //                          select new
        //                          {
        //                              OrderNumber = p.OrderNumber,
        //                              PONumber = s.PONumber,
        //                              StructureElement = s.StructureElement,
        //                              Remarks = p.Remarks,
        //                              TotalWeight = s.TotalWeight,
        //                              TotalPCs = s.TotalPCs,
        //                              BBSNo = lBBSNo,
        //                              BBSDesc = lBBSDesc,
        //                              CouplerType = lCouplerType,
        //                              Transport = lTransport
        //                          }
        //                          ).ToList();

        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        [HttpGet]
        [Route("/getCopyBBSOrderList/{CustomerCode}/{ProjectCode}")]
        public ActionResult getCopyBBSOrderList(string CustomerCode, string ProjectCode)
        {

            //var content = (from p in db.JobAdvice
            //               let s = db.PODoc.Where(s2 => p.CustomerCode == s2.CustomerCode &&
            //               p.ProjectCode == s2.ProjectCode &&
            //               p.JobID == s2.JobID).FirstOrDefault()
            //               where p.CustomerCode == CustomerCode &&
            //               p.ProjectCode == ProjectCode
            //               orderby p.JobID descending
            //               select new
            //               {
            //                   JobID = p.JobID,
            //                   PONumber = p.PONumber,
            //                   RequiredDate = p.RequiredDate,
            //                   OrderStatus = p.OrderStatus,
            //                   FileName = s.FileName
            //               }
            //               ).Take(50).ToList();

            var content = (from p in db.OrderProject
                           join s in db.OrderProjectSE
 on p.OrderNumber equals s.OrderNumber
                           where p.CustomerCode == CustomerCode &&
                           p.ProjectCode == ProjectCode &&
                           s.CABJobID > 0 &&
                           p.OrderStatus != "Deleted" &&
                           p.OrderStatus != "Created" &&
                           p.OrderStatus != "Cancelled" &&
                           p.OrderStatus != "New"
                           orderby s.PONumber descending
                           select new
                           {
                               OrderNumber = p.OrderNumber,
                               JobID = s.CABJobID,
                               PONumber = s.PONumber,
                               RequiredDate = s.RequiredDate,
                               OrderStatus = p.OrderStatus,
                               StructureElement = s.StructureElement
                           }
                           ).ToList();

            var content1 = new List<struOrderList>(content.Select(h => new struOrderList
            {
                OrderNo = h.JobID.ToString(),
                OrderDesc = (h.PONumber == null ? "" : h.PONumber.Trim()) +
                " (" + h.StructureElement + " - " + h.OrderNumber.ToString() + ")"
            }));

            return Ok(content);//added by ajit content1
        }

        //int updateOrderStatus(string pCustomerCode, string pProjectCode)
        //{
        //    var lCmd = new SqlCommand();
        //    var lCmdUpdate = new SqlCommand();

        //    SqlDataReader lRst;
        //    var lNDSCon = new SqlConnection();

        //    var lCISCon = new OracleConnection();
        //    var lOraCmd = new OracleCommand();
        //    OracleDataReader lOraRst;
        //    int lReturn = 0;
        //    string lCABSOR = "";
        //    string lCOSOR = "";
        //    string lSAPSO = "";
        //    int lJOBID = 0;
        //    int lBBSID = 0;
        //    string lSQL = "";
        //    string lOutTime = "";

        //    try
        //    {
        //        var lProcessObj = new ProcessController();
        //        if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //        {
        //            lCmd.CommandText = "SELECT B.BBSSOR, B.BBSSORCoupler, B.BBSSAPSO, B.JobID, B.BBSID " +
        //            "FROM dbo.OESBBS B, dbo.OESJobAdvice A " +
        //            "WHERE A.CustomerCode = '" + pCustomerCode + "' " +
        //            "AND A.ProjectCode = '" + pProjectCode + "' " +
        //            "AND A.CustomerCode = B.CustomerCode " +
        //            "AND A.ProjectCode = B.ProjectCode " +
        //            "AND A.JobID = B.JobID " +
        //            "AND (B.BBSSOR > '' " +
        //            "OR B.BBSSORCoupler > '' " +
        //            "OR B.BBSSAPSO > '') " +
        //            "AND A.OrderStatus = 'Processed' ";

        //            lCmd.Connection = lNDSCon;
        //            lCmd.CommandTimeout = 300;
        //            lRst = lCmd.ExecuteReader();
        //            if (lRst.HasRows)
        //            {
        //                if (lProcessObj.OpenCISConnection(ref lCISCon) == true)
        //                {
        //                    while (lRst.Read())
        //                    {
        //                        lCABSOR = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
        //                        lCOSOR = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim();
        //                        lSAPSO = lRst.GetValue(2) == DBNull.Value ? "" : lRst.GetString(2).Trim();
        //                        lJOBID = lRst.GetValue(3) == DBNull.Value ? 0 : lRst.GetInt32(3);
        //                        lBBSID = lRst.GetValue(4) == DBNull.Value ? 0 : lRst.GetInt32(4);

        //                        lSQL = "SELECT  " +
        //                        "NVL(MAX(WEIGH_OUT_TIME), ' ') " +
        //                        "FROM SAPSR3.YMPPT_LOAD_VEHIC V, " +
        //                        "SAPSR3.YMSDT_ORDER_HDR O " +
        //                        "WHERE O.MANDT = V.MANDT " +
        //                        "AND O.SALES_ORDER = V.VBELN " +
        //                        "AND O.MANDT = '" + lProcessObj.strClient + "' " +
        //                        "AND (O.ORDER_REQUEST_NO = '" + lCABSOR + "' " +
        //                        "OR O.ORDER_REQUEST_NO = '" + lCOSOR + "') " +
        //                        "UNION " +
        //                        "SELECT  " +
        //                        "NVL(MAX(WEIGH_OUT_TIME), ' ') " +
        //                        "FROM SAPSR3.YMPPT_LOAD_VEHIC " +
        //                        "WHERE MANDT = '" + lProcessObj.strClient + "' " +
        //                        "AND VBELN = '" + lSAPSO + "' " +
        //                        "ORDER BY 1 DESC ";

        //                        lOraCmd.CommandText = lSQL;
        //                        lOraCmd.Connection = lCISCon;
        //                        lOraCmd.CommandTimeout = 300;
        //                        lOraRst = lOraCmd.ExecuteReader();
        //                        if (lOraRst.HasRows)
        //                        {
        //                            if (lOraRst.Read())
        //                            {
        //                                lOutTime = lOraRst.GetString(0).Trim();

        //                                if (lOutTime != "")
        //                                {
        //                                    lCmdUpdate.CommandText = "Update dbo.OESJobAdvice " +
        //                                    "SET OrderStatus = 'Delivered' " +
        //                                    "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                    "AND ProjectCode = '" + pProjectCode + "' " +
        //                                    "AND JobID = " + lJOBID.ToString() + " ";

        //                                    lCmdUpdate.Connection = lNDSCon;
        //                                    lCmdUpdate.CommandTimeout = 300;
        //                                    lCmdUpdate.ExecuteNonQuery();
        //                                }
        //                            }
        //                        }
        //                        lOraRst.Close();
        //                    }
        //                    lProcessObj.CloseCISConnection(ref lCISCon);
        //                }
        //            }
        //            lProcessObj.CloseNDSConnection(ref lNDSCon);
        //        }
        //        lProcessObj = null;
        //    }
        //    catch (Exception e)
        //    { }

        //    return lReturn;
        //}

        //       /// <summary>
        //       ///  25.4.2019
        //       ///  To implement export to excel functionality
        //       /// </summary>
        //       /// <param name="CustomerCode"></param>
        //       /// <param name="ProjectCode"></param>
        //       /// <param name="JobID"></param>
        //       /// <returns></returns>
        [HttpGet]
        [Route("/exportOrderDetailsToExcel/{CustomerCode}/{ProjectCode}/{JobID}")]
        public ActionResult exportOrderDetailsToExcel(string CustomerCode, string ProjectCode, int JobID)
        {
            int lPODocExists = 0;


            var content = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
            if (content != null)
            {
                if (content.CustomerCode == null) content.CustomerCode = "";
                else content.CustomerCode = content.CustomerCode.Trim();

                if (content.CouplerType == null) content.CouplerType = "";
                else content.CouplerType = content.CouplerType.Trim();

                if (content.OrderStatus == null) content.OrderStatus = "";
                else content.OrderStatus = content.OrderStatus.Trim();

                if (content.PONumber == null) content.PONumber = "";
                else content.PONumber = content.PONumber.Trim();

                if (content.ProjectCode == null) content.ProjectCode = "";
                else content.ProjectCode = content.ProjectCode.Trim();

                if (content.CouplerType == null) content.CouplerType = "";
                else content.CouplerType = content.CouplerType.Trim();

                if (content.ProjectStage == null) content.ProjectStage = "";
                else content.ProjectStage = content.ProjectStage.Trim();

                if (content.DeliveryAddress == null) content.DeliveryAddress = "";
                else content.DeliveryAddress = content.DeliveryAddress.Trim();

                if (content.Remarks == null) content.Remarks = "";
                else content.Remarks = content.Remarks.Trim();

                if (content.Scheduler_HP == null) content.Scheduler_HP = "";
                else content.Scheduler_HP = content.Scheduler_HP.Trim();

                if (content.Scheduler_Name == null) content.Scheduler_Name = "";
                else content.Scheduler_Name = content.Scheduler_Name.Trim();

                if (content.Scheduler_Tel == null) content.Scheduler_Tel = "";
                else content.Scheduler_Tel = content.Scheduler_Tel.Trim();

                if (content.SiteEngr_HP == null) content.SiteEngr_HP = "";
                else content.SiteEngr_HP = content.SiteEngr_HP.Trim();

                if (content.SiteEngr_Name == null) content.SiteEngr_Name = "";
                else content.SiteEngr_Name = content.SiteEngr_Name.Trim();

                if (content.SiteEngr_Tel == null) content.SiteEngr_Tel = "";
                else content.SiteEngr_Tel = content.SiteEngr_Tel.Trim();

                if (content.TransportLimit == null) content.TransportLimit = "";
                else content.TransportLimit = content.TransportLimit.Trim();

                if (content.TransportMode == null) content.TransportMode = "";
                else content.TransportMode = content.TransportMode.Trim();

                if (content.WBS1 == null) content.WBS1 = "";
                else content.WBS1 = content.WBS1.Trim();

                if (content.WBS2 == null) content.WBS2 = "";
                else content.WBS2 = content.WBS2.Trim();

                if (content.WBS3 == null) content.WBS3 = "";
                else content.WBS3 = content.WBS3.Trim();
            }

            BaseFont baseFont;

            if (System.IO.File.Exists("C:\\WINDOWS\\FONTS\\simfang.ttf"))
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\simfang.ttf",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }
            else if (System.IO.File.Exists("C:\\WINDOWS\\FONTS\\simsun.ttc"))
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\simsun.ttc, 1",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }
            else
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\msyhl.ttc, 1",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }

            var titleFont = new iTextSharp.text.Font(baseFont, 16, iTextSharp.text.Font.BOLD);
            var subTitleFont = FontFactory.GetFont("Arial", 14, iTextSharp.text.Font.BOLD);
            var boldTableFont = new iTextSharp.text.Font(baseFont, 12, iTextSharp.text.Font.BOLD);
            var TableFont = new iTextSharp.text.Font(baseFont, 12, iTextSharp.text.Font.NORMAL);
            var endingMessageFont = FontFactory.GetFont("Arial", 10, iTextSharp.text.Font.ITALIC);
            var DateFont = FontFactory.GetFont("Arial", 10, iTextSharp.text.Font.NORMAL);
            var boldBBSFont = new iTextSharp.text.Font(baseFont, 10, iTextSharp.text.Font.BOLD);
            var BBSFont = new iTextSharp.text.Font(baseFont, 10, iTextSharp.text.Font.NORMAL);

            int rowindex = 0;
            int lColNo = 10;
            string lColLetter = Convert.ToChar(60 + lColNo).ToString(); // A Ascii -- 65


            ExcelPackage package = new ExcelPackage();
            ExcelWorksheet ws = package.Workbook.Worksheets.Add("OrderSummary");
            System.Drawing.Image img = System.Drawing.Image.FromFile("D:\\images\\NatSteelLogo.gif");
            ExcelPicture pic = ws.Drawings.AddPicture("Picture_Name", "D:\\images\\NatSteelLogo.gif");
            pic.SetPosition(rowindex, 2, 0, 0);

            ws.Row(1).Height = 30;
            ws.Row(4).Height = 5;
            ws.Row(7).Height = 5;
            ws.Row(12).Height = 5;
            ws.Row(16).Height = 5;
            ws.Column(1).Width = 18;
            ws.Column(2).Width = 40;
            ws.Column(3).Width = 30;
            ws.Column(4).Width = 18;
            ws.Column(5).Width = 18;
            ws.Column(6).Width = 18;


            rowindex = 2;
            ws.Cells["A" + rowindex + ":F" + rowindex].Merge = true;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            ws.Cells[rowindex, 1].Style.Font.Bold = true;

            ws.Cells[rowindex, 1].Style.Font.Size = 12;
            ws.Cells[rowindex, 1].Style.WrapText = false;
            ws.Cells[rowindex, 1].Value = "JOB ADVICE - CAB/SB (工作通知 - 加工铁与标准直铁料表)";

            rowindex = 3;
            ws.Cells[rowindex, 1].StyleName = BBSFont.ToString();
            ws.Cells[rowindex, 1].Value = "Serial No. (序号): ";
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

            ws.Cells["B" + rowindex + ":" + lColLetter + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 2].StyleName = BBSFont.ToString();
            ws.Cells[rowindex, 2].Value = JobID.ToString("D4");

            rowindex = 5;
            ws.Cells["B" + rowindex + ":" + lColLetter + rowindex].Merge = true;
            ws.Cells["A5:F6"].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells["A5:F6"].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells["A5:F6"].Style.Border.Right.Style = ExcelBorderStyle.Thin;
            ws.Cells["A5:F6"].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Customer\n(客户名称)";
            //  ws.Cells["D6:" + lColLetr + "6"].Merge = true;
            CustomerModels lCustomer = db.Customer.Find(content.CustomerCode);
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            if (lCustomer != null) ws.Cells[rowindex, 2].Value = (lCustomer.CustomerName.Trim() + " (" + lCustomer.CustomerCode.Trim() + ")");

            rowindex = 6;
            var lProject = (from p in db.ProjectList
                            where p.ProjectCode == ProjectCode
                            select p).First();
            ws.Cells["B" + rowindex + ":" + lColLetter + rowindex].Merge = true;
            ws.Cells[rowindex, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Project\n(客户名称)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            if (lProject != null) ws.Cells[rowindex, 2].Value = (lProject.ProjectTitle.Trim() + " (" + lProject.ProjectCode.Trim() + ")");


            rowindex = 8;

            ws.Cells["A8:F11"].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells["A8:F11"].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells["A8:F11"].Style.Border.Right.Style = ExcelBorderStyle.Thin;
            ws.Cells["A8:F11"].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "PO No.\n(订单号码)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = content.PONumber.Trim();
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "Order Date\n(订单日期)";
            ws.Cells[rowindex, 4].Style.Font.Bold = true;
            ws.Cells[rowindex, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 4].Value = content.PODate == null ? "" : ((DateTime)content.PODate).ToString("yyyy-MM-dd");

            rowindex = 9;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Required Date\n(交货日期)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = String.Format("{0:yyyy-MM-dd}", content.RequiredDate);
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "Order Weight\n(订单重量)";
            ws.Cells[rowindex, 4].Style.Font.Bold = true;
            ws.Cells[rowindex, 4].Value = ((decimal)content.TotalWeight).ToString("F3") + " KG";

            rowindex = 10;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "CAB Bars Weight\n(加工铁重量)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = ((decimal)content.TotalCABWeight).ToString("F3") + " KG";
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "SB Weight\n(标准直铁重量)";
            ws.Cells[rowindex, 4].Style.Font.Bold = true;
            ws.Cells[rowindex, 4].Value = ((decimal)content.TotalSTDWeight).ToString("F3") + " KG";

            rowindex = 11;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Transport Limit\n(运输限制)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = content.TransportLimit;
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "Transport Mode\n(运输工具)";
            ws.Cells[rowindex, 4].Style.Font.Bold = true;
            ws.Cells[rowindex, 4].Value = content.TransportMode;
            rowindex = 13;
            ws.Cells["A12:F12"].Merge = true;
            ws.Cells["A13:F15"].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells["A13:F15"].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells["A13:F15"].Style.Border.Right.Style = ExcelBorderStyle.Thin;
            ws.Cells["A13:F15"].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Block (WBS1)\n(座号/大牌)";
            ws.Cells[rowindex, 2].Value = content.WBS1;
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "Storey (WBS2)\n(楼层)";
            ws.Cells[rowindex, 4].Value = content.WBS2;
            ws.Cells[rowindex, 5].Style.WrapText = true;
            ws.Cells[rowindex, 5].Value = "Part (WBS3)\n(分部)";
            ws.Cells[rowindex, 6].Value = content.WBS3;
            rowindex = 14;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Remarks/Delivery Address\n(备注/送货地址))";
            ws.Cells[rowindex, 2].Value = content.Remarks;
            rowindex = 15;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "BBS Description (BBS说明)";
            ws.Cells[rowindex, 2].Value = content.DeliveryAddress;

            rowindex = 17;
            ws.Cells[rowindex, 1].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 3].Style.Font.Bold = true;
            ws.Cells[rowindex, 4].Style.Font.Bold = true;
            ws.Cells[rowindex, 5].Style.Font.Bold = true;
            ws.Cells[rowindex, 6].Style.Font.Bold = true;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 2].Style.WrapText = true;
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 4].Style.WrapText = true;
            ws.Cells[rowindex, 5].Style.WrapText = true;
            ws.Cells[rowindex, 6].Style.WrapText = true;
            ExcelRange lrg4 = ws.Cells["A" + rowindex + ":F19"];
            lrg4.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            lrg4.Style.Border.Top.Style = ExcelBorderStyle.Thin;
            lrg4.Style.Border.Left.Style = ExcelBorderStyle.Thin;
            lrg4.Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells[rowindex, 1].Value = "BBS No.\n(钢筋加工表)";
            ws.Cells[rowindex, 2].Value = "BBS Description\n(具体描述)";
            ws.Cells[rowindex, 3].Value = "Structure Element\n(构件)";
            ws.Cells[rowindex, 4].Value = "CAB Weight\n(加工铁重量)";
            ws.Cells[rowindex, 5].Value = "SB Weight\n(标准直铁重量)";
            ws.Cells[rowindex, 6].Value = "Total Weight\n(总重量)";
            rowindex = 18;
            var lBBSContent = (from p in db.BBS
                               where p.CustomerCode == CustomerCode &&
                               p.ProjectCode == ProjectCode &&
                               p.JobID == JobID
                               orderby p.BBSID
                               select p).ToList();
            if (lBBSContent.Count > 0)
            {
                for (int i = 0; i < lBBSContent.Count; i++)
                {
                    ws.Cells[rowindex, 1].Value = lBBSContent[i].BBSNo;
                    ws.Cells[rowindex, 2].Value = lBBSContent[i].BBSDesc;
                    ws.Cells[rowindex, 3].Value = lBBSContent[i].BBSStrucElem;

                    ws.Cells[rowindex, 4].Value = lBBSContent[i].BBSOrderCABWT.ToString("F3");

                    ws.Cells[rowindex, 5].Value = lBBSContent[i].BBSOrderSTDWT.ToString("F3");
                    ws.Cells[rowindex, 6].Value = lBBSContent[i].BBSTotalWT.ToString("F3");
                    rowindex += 1;
                }
            }
            ws.Row(rowindex += 1).Height = 5;

            ExcelRange lrg5 = ws.Cells["A21:F23"];
            lrg5.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            lrg5.Style.Border.Top.Style = ExcelBorderStyle.Thin;
            lrg5.Style.Border.Left.Style = ExcelBorderStyle.Thin;
            lrg5.Style.Border.Right.Style = ExcelBorderStyle.Thin;
            rowindex += 1;
            ws.Cells[rowindex, 1].Style.Font.Bold = true;
            ws.Cells[rowindex, 1].Value = "Site Contact (工地联系人)";
            rowindex += 1;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Goods Receiver\n(收货人)";

            ws.Cells[rowindex, 2].Value = content.SiteEngr_Name.Trim();
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "H/P\n(手机号码)";
            ws.Cells[rowindex, 4].Value = content.SiteEngr_HP.Trim();
            ws.Cells[rowindex, 5].Style.WrapText = true;
            ws.Cells[rowindex, 5].Value = "Email\n(电邮地址)";
            ws.Cells[rowindex, 6].Value = content.SiteEngr_Tel.Trim();
            rowindex += 1;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Site Contact\n(联系人)";
            ws.Cells[rowindex, 2].Value = content.Scheduler_Name.Trim();
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Value = "H/P\n(手机号码)";
            ws.Cells[rowindex, 4].Value = content.Scheduler_HP.Trim();
            ws.Cells[rowindex, 5].Style.WrapText = true;
            ws.Cells[rowindex, 5].Value = "Email\n(电邮地址)";
            ws.Cells[rowindex, 6].Value = content.Scheduler_Tel.Trim();
            ws.Row(rowindex += 1).Height = 5;
            rowindex += 1;
            ExcelRange lrg6 = ws.Cells["A25:F37"];
            lrg6.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            lrg6.Style.Border.Top.Style = ExcelBorderStyle.Thin;
            lrg6.Style.Border.Left.Style = ExcelBorderStyle.Thin;
            lrg6.Style.Border.Right.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Font.Bold = true;
            ws.Cells[rowindex, 1].Value = "NatSteel Contacts(大众钢铁联系人) (Fax: 62619133)";

            rowindex += 1;
            ws.Cells[rowindex, 1].Style.Font.Bold = true;
            ws.Cells[rowindex, 1].Value = "Name (姓名)";
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = "Contact Numbers (联系电话)";
            ws.Cells[rowindex, 3].Style.Font.Bold = true;
            ws.Cells[rowindex, 3].Value = "Email\n(电邮地址)";
            //rowindex += 1;
            //ws.Cells[rowindex, 1].Value = content.Scheduler_Name.Trim();
            //ws.Cells[rowindex, 2].Value = content.Scheduler_HP.Trim();
            //ws.Cells[rowindex, 3].Value = content.Scheduler_Tel.Trim();


            var lProjContent = db.Project.Find(CustomerCode, ProjectCode);

            if (lProjContent.Contact1 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact1.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact1.Trim();


                    if (lProjContent.Tel1 != null)
                    {
                        if (lProjContent.Tel1.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel1.Trim();
                        }
                    }



                    if (lProjContent.Email1 != null)
                    {
                        if (lProjContent.Email1.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email1.Trim();
                        }
                    }
                }
            }

            if (lProjContent.Contact2 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact2.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact2.Trim();

                    if (lProjContent.Tel2 != null)
                    {
                        if (lProjContent.Tel2.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel2.Trim();
                        }
                    }


                    if (lProjContent.Email2 != null)
                    {
                        if (lProjContent.Email2.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email2.Trim();
                        }
                    }
                }
            }

            if (lProjContent.Contact3 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact3.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact3.Trim();

                    if (lProjContent.Tel3 != null)
                    {
                        if (lProjContent.Tel3.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel3.Trim();
                        }
                    }


                    if (lProjContent.Email3 != null)
                    {
                        if (lProjContent.Email3.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email3.Trim();

                        }
                    }
                }
            }

            if (lProjContent.Contact4 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact4.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact4.Trim();

                    if (lProjContent.Tel4 != null)
                    {
                        if (lProjContent.Tel4.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel4.Trim();
                        }
                    }
                    if (lProjContent.Email4 != null)
                    {
                        if (lProjContent.Email4.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email4.Trim();
                        }
                    }
                }
            }

            if (lProjContent.Contact5 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact5.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact5.Trim();

                    if (lProjContent.Tel5 != null)
                    {
                        if (lProjContent.Tel5.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel5.Trim();
                        }
                    }

                    if (lProjContent.Email5 != null)
                    {
                        if (lProjContent.Email5.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email5.Trim();
                        }
                    }
                }
            }

            if (lProjContent.Contact6 != null)
            {
                rowindex += 1;
                if (lProjContent.Contact6.Trim().Length > 0)
                {
                    ws.Cells[rowindex, 1].Value = lProjContent.Contact6.Trim();


                    if (lProjContent.Tel6 != null)
                    {
                        if (lProjContent.Tel6.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 2].Value = lProjContent.Tel6.Trim();
                        }
                    }

                    if (lProjContent.Email6 != null)
                    {
                        if (lProjContent.Email6.Trim().Length > 0)
                        {
                            ws.Cells[rowindex, 3].Value = lProjContent.Email6.Trim();
                        }
                    }

                }
            }
            var lProcessObj = new ProcessController();
            var lNDSCon = new SqlConnection();
            var lCmd = new SqlCommand();
            SqlDataReader lRst;

            string ProcessInd = "Y";
            //Bar Bending Schedule
            lProcessObj = new ProcessController();
            lProcessObj.OpenNDSConnection(ref lNDSCon);

            if (lBBSContent.Count > 0)
            {
                for (int i = 0; i < lBBSContent.Count; i++)
                {
                    var lOrderDetails = new System.Collections.Generic.List<OrderDetailsModels>();
                    var lBBSID = lBBSContent[i].BBSID;
                    if (ProcessInd == "Y")
                    {
                        lOrderDetails = (from p in db.OrderDetails
                                         where p.CustomerCode == CustomerCode &&
                                         p.ProjectCode == ProjectCode &&
                                         p.JobID == JobID &&
                                         p.BBSID == lBBSID &&
                                         (p.Cancelled == null ||
                                         p.Cancelled != true)
                                         orderby p.BarSort
                                         select p).ToList();

                    }
                    else
                    {
                        lOrderDetails = (from p in db.OrderDetails
                                         where p.CustomerCode == CustomerCode &&
                                         p.ProjectCode == ProjectCode &&
                                         p.JobID == JobID &&
                                         p.BBSID == lBBSID
                                         orderby p.BarSort
                                         select p).ToList();
                    }
                    if (lOrderDetails.Count > 0)
                    {
                        var lPara = new System.Collections.Generic.List<string>();
                        lPara.Add("A");
                        lPara.Add("B");
                        lPara.Add("C");
                        lPara.Add("D");
                        for (int j = 0; j < lOrderDetails.Count; j++)
                        {
                            AddParamaters("E", lOrderDetails[j].E, ref lPara);
                            AddParamaters("F", lOrderDetails[j].F, ref lPara);
                            AddParamaters("G", lOrderDetails[j].G, ref lPara);
                            AddParamaters("H", lOrderDetails[j].H, ref lPara);
                            AddParamaters("I", lOrderDetails[j].I, ref lPara);
                            AddParamaters("J", lOrderDetails[j].J, ref lPara);
                            AddParamaters("K", lOrderDetails[j].K, ref lPara);
                            AddParamaters("L", lOrderDetails[j].L, ref lPara);
                            AddParamaters("M", lOrderDetails[j].M, ref lPara);
                            AddParamaters("N", lOrderDetails[j].N, ref lPara);
                            AddParamaters("O", lOrderDetails[j].O, ref lPara);
                            AddParamaters("P", lOrderDetails[j].P, ref lPara);
                            AddParamaters("Q", lOrderDetails[j].Q, ref lPara);
                            AddParamaters("R", lOrderDetails[j].R, ref lPara);
                            AddParamaters("S", lOrderDetails[j].S, ref lPara);
                            AddParamaters("T", lOrderDetails[j].T, ref lPara);
                            AddParamaters("U", lOrderDetails[j].U, ref lPara);
                            AddParamaters("V", lOrderDetails[j].V, ref lPara);
                            AddParamaters("W", lOrderDetails[j].W, ref lPara);
                            AddParamaters("X", lOrderDetails[j].X, ref lPara);
                            AddParamaters("Y", lOrderDetails[j].Y, ref lPara);
                            AddParamaters("Z", lOrderDetails[j].Z, ref lPara);
                        }
                        lPara.Sort();

                        ExcelWorksheet bbsws = package.Workbook.Worksheets.Add("ORDERDETAIL-" + lBBSContent[i].BBSNo);

                        System.Drawing.Image imginbbs = System.Drawing.Image.FromFile("D:\\images\\NatSteelLogo.gif");

                        ExcelPicture picinbbs = bbsws.Drawings.AddPicture("Picture_Name", "D:\\images\\NatSteelLogo.gif");
                        picinbbs.SetPosition(0, 3, 0, 0);

                        int bbsrowindex = 2;
                        bbsws.Row(1).Height = 30;
                        bbsws.Cells["A2:J2"].Merge = true;
                        bbsws.Cells[bbsrowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                        bbsws.Cells[bbsrowindex, 1].Style.Font.Bold = true;
                        bbsws.Cells[bbsrowindex, 1].Style.Font.Size = 12;
                        bbsws.Cells[bbsrowindex, 1].Style.WrapText = false;
                        bbsws.Cells[bbsrowindex, 1].Value = "BAR BENDING SCHEDULLE (钢筋加工表)";
                        bbsrowindex += 1;
                        ExcelRange bbsrng = bbsws.Cells["A" + bbsrowindex + ":k4"];
                        bbsrng.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                        bbsrng.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                        bbsrng.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                        bbsrng.Style.Border.Right.Style = ExcelBorderStyle.Thin;
                        bbsws.Cells["A3:B3"].Merge = true;
                        bbsws.Cells["C3:D3"].Merge = true;
                        bbsws.Cells["E3:F3"].Merge = true;
                        bbsws.Cells["G3:H3"].Merge = true;
                        bbsws.Cells[bbsrowindex, 1].Value = "BBS No(加工表号)";
                        bbsws.Cells[bbsrowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 1].Style.Font.Bold = true;
                        //  ws.Cells["D4:" + lColLetter + "4"].Merge = true;
                        bbsws.Cells[bbsrowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                        bbsws.Cells[bbsrowindex, 3].Value = lBBSContent[i].BBSNo;

                        bbsws.Cells[bbsrowindex, 5].Value = "BBS Weight(重量)";
                        bbsws.Cells[bbsrowindex, 5].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 5].Style.Font.Bold = true;
                        //  ws.Cells["D4:" + lColLetter + "4"].Merge = true;
                        bbsws.Cells[bbsrowindex, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                        bbsws.Cells[bbsrowindex, 7].Value = (lBBSContent[i].BBSOrderCABWT + lBBSContent[i].BBSOrderSTDWT).ToString("F3");

                        bbsws.Cells[bbsrowindex, 9].Value = "Required Date(交货日)";
                        bbsws.Cells[bbsrowindex, 9].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 9].Style.Font.Bold = true;
                        //  ws.Cells["D4:" + lColLetter + "4"].Merge = true;
                        bbsws.Cells[bbsrowindex, 11].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;

                        bbsws.Cells[bbsrowindex, 11].Value = String.Format("{0:yyyy-MM-dd}", content.RequiredDate);
                        bbsrowindex = 4;
                        bbsws.Cells["A4:B4"].Merge = true;
                        bbsws.Cells["C4:D4"].Merge = true;
                        bbsws.Cells["E4:F4"].Merge = true;
                        bbsws.Cells["G4:H4"].Merge = true;

                        bbsws.Cells[bbsrowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 1].Style.Font.Bold = true;
                        bbsws.Cells[bbsrowindex, 1].Value = "Block(大牌)";
                        //  ws.Cells["D6:" + lColLetter + "6"].Merge = true;
                        ws.Cells[bbsrowindex, 3].Value = content.WBS1;
                        ws.Cells[bbsrowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;


                        bbsws.Cells[bbsrowindex, 5].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 5].Style.Font.Bold = true;
                        bbsws.Cells[bbsrowindex, 5].Value = "Storey(楼层)";
                        //  ws.Cells["D6:" + lColLetter + "6"].Merge = true;
                        ws.Cells[bbsrowindex, 7].Value = content.WBS2;
                        ws.Cells[bbsrowindex, 7].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;


                        bbsws.Cells[bbsrowindex, 9].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                        bbsws.Cells[bbsrowindex, 9].Style.Font.Bold = true;
                        bbsws.Cells[bbsrowindex, 9].Value = "Part(分部)";
                        //  ws.Cells["D6:" + lColLetter + "6"].Merge = true;
                        ws.Cells[bbsrowindex, 11].Value = content.WBS3;
                        ws.Cells[bbsrowindex, 11].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;



                        bbsws.Column(1).Width = 12;
                        bbsws.Column(2).Width = 12;
                        bbsws.Column(3).Width = 9;
                        bbsws.Column(4).Width = 8;
                        bbsws.Column(5).Width = 11;

                        bbsws.Column(6).Width = 9;
                        bbsws.Column(7).Width = 10;
                        bbsws.Column(8).Width = 13;
                        bbsws.Column(9).Width = 12;


                        for (int j = 0; j < lPara.Count; j++)
                        {
                            bbsws.Column(10 + j).Width = 11;
                        }
                        int cl = 10 + lPara.Count;
                        bbsws.Column(cl).Width = 10;
                        bbsws.Column(cl + 1).Width = 12;
                        bbsws.Column(cl + 2).Width = 13;
                        bbsws.Column(cl + 3).Width = 25;
                        int RowNo = 7;

                        //    ExcelRange lrg = ws.Cells["A7:" + lColLetter + (lRowNo - 1).ToString()];

                        int lColNoI = lPara.Count + 12;
                        lColLetter = Convert.ToChar(65 + lColNoI).ToString();
                        if (lColNoI > 26)
                        {
                            lColNoI = lColNoI - 26;
                            lColLetter = "A" + Convert.ToChar(65 + lColNoI).ToString();
                        }

                        ExcelRange lrg3 = bbsws.Cells["A7:" + lColLetter + (7 + lOrderDetails.Count + 1).ToString() + ""];
                        //ExcelRange lrg3 = bbsws.Cells["A7:Q11"];


                        lrg3.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                        lrg3.Style.Border.Top.Style = ExcelBorderStyle.Thin;
                        lrg3.Style.Border.Left.Style = ExcelBorderStyle.Thin;
                        lrg3.Style.Border.Right.Style = ExcelBorderStyle.Thin;

                        bbsws.Cells[RowNo, 1].Value = "Element Mark\n结构名称";
                        bbsws.Cells[RowNo, 1].Style.WrapText = true;
                        bbsws.Cells[RowNo, 1].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 2].Value = "Bar Mark\n铁代号";
                        bbsws.Cells[RowNo, 2].Style.WrapText = true;
                        bbsws.Cells[RowNo, 2].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 3].Value = "Type\n型号";
                        bbsws.Cells[RowNo, 3].Style.WrapText = true;
                        bbsws.Cells[RowNo, 3].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 4].Value = "Size\n直径";
                        bbsws.Cells[RowNo, 4].Style.WrapText = true;
                        bbsws.Cells[RowNo, 4].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 5].Value = "Member Qty\n构件数量";
                        bbsws.Cells[RowNo, 5].Style.WrapText = true;
                        bbsws.Cells[RowNo, 5].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 6].Value = "Each Qty\n单件数量";
                        bbsws.Cells[RowNo, 6].Style.WrapText = true;
                        bbsws.Cells[RowNo, 6].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 7].Value = "Total Qty\n总数";
                        bbsws.Cells[RowNo, 7].Style.WrapText = true;
                        bbsws.Cells[RowNo, 7].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 8].Value = "Shape Code\n图形代码";
                        bbsws.Cells[RowNo, 8].Style.WrapText = true;
                        bbsws.Cells[RowNo, 8].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, 9].Value = "Shape\n图形";
                        bbsws.Cells[RowNo, 9].Style.WrapText = true;
                        bbsws.Cells[RowNo, 9].Style.Font.Bold = true;


                        if (lPara.Count > 0)
                        {
                            for (int j = 0; j < lPara.Count; j++)
                            {
                                bbsws.Cells[RowNo, 9 + (j + 1)].Value = lPara[j].Trim();
                                bbsws.Cells[RowNo, 9 + (j + 1)].Style.Font.Bold = true;
                            }
                        }
                        int col = 9 + lPara.Count + 1;
                        bbsws.Cells[RowNo, col].Value = "Pin Size\n弯模";
                        bbsws.Cells[RowNo, col].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, col].Style.WrapText = true;
                        bbsws.Cells[RowNo, col + 1].Value = "Bar Length\n长度";
                        bbsws.Cells[RowNo, col + 1].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, col + 1].Style.WrapText = true;
                        bbsws.Cells[RowNo, col + 2].Value = "Weight\n重量";
                        bbsws.Cells[RowNo, col + 2].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, col + 2].Style.WrapText = true;
                        bbsws.Cells[RowNo, col + 3].Value = "Remarks\n备注";
                        bbsws.Cells[RowNo, col + 3].Style.Font.Bold = true;
                        bbsws.Cells[RowNo, col + 3].Style.WrapText = true;
                        RowNo = 8;
                        string lVar;
                        for (int j = 0; j < lOrderDetails.Count; j++)
                        {
                            if ((lOrderDetails[j].BarShapeCode == null ||
                                lOrderDetails[j].BarShapeCode.ToString().Trim().Length == 0) &&
                                (lOrderDetails[j].ElementMark == null ||
                                lOrderDetails[j].ElementMark.ToString().Trim().Length == 0) &&
                                (lOrderDetails[j].BarMark == null ||
                                lOrderDetails[j].BarMark.ToString().Trim().Length == 0)) continue;

                            lVar = "";
                            if (lOrderDetails[j].ElementMark != null) lVar = lOrderDetails[j].ElementMark.Trim(); ;

                            if (lOrderDetails[j].BarSTD == true) lVar = "SB";
                            bbsws.Cells[RowNo, 1].Value = lVar;

                            //                    if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);


                            lVar = lOrderDetails[j].BarMark;
                            if (lVar == null) lVar = "";
                            bbsws.Cells[RowNo, 2].Value = lVar.Trim();
                            //       if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);


                            lVar = lOrderDetails[j].BarType;
                            if (lVar == null) lVar = "";
                            bbsws.Cells[RowNo, 3].Value = lVar.Trim();
                            //  if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);

                            bbsws.Cells[RowNo, 4].Value = lOrderDetails[j].BarSize.ToString();

                            //if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);

                            bbsws.Cells[RowNo, 5].Value = lOrderDetails[j].BarMemberQty;

                            //if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);
                            //if (lOrderDetails[j].BarSTD == true) bbsws.Cells[RowNo, 1].Value = "";
                            //else bbsws.Cells[RowNo, 6].Value = lOrderDetails[j].BarEachQty;

                            ////        if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);


                            //if (lOrderDetails[j].BarSTD == true) bbsws.Cells[RowNo, 7].Value = "";
                            //else bbsws.Cells[RowNo, 7].Value = lOrderDetails[j].BarTotalQty;
                            bbsws.Cells[RowNo, 6].Value = lOrderDetails[j].BarEachQty;

                            // Always show BarTotalQty (no condition)
                            bbsws.Cells[RowNo, 7].Value = lOrderDetails[j].BarTotalQty;
                            //       if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);

                            lVar = lOrderDetails[j].BarShapeCode;
                            if (lVar == null) lVar = "";
                            bbsws.Cells[RowNo, 8].Value = lVar.Trim();
                            //   if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);


                            byte[] lShapeImage = null;
                            lCmd.CommandText =
                                "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                                "FROM dbo.T_CAB_SHAPE_MAST " +
                                "WHERE CSM_SHAPE_ID = '" + lOrderDetails[j].BarShapeCode + "' ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                if (lRst.Read())
                                {
                                    lShapeImage = (byte[])lRst.GetValue(1);
                                }
                            }
                            lRst.Close();

                            if (lShapeImage != null)
                            {

                                System.Drawing.Image image = System.Drawing.Image.FromStream(new MemoryStream(lShapeImage));
                                System.Drawing.Bitmap bmp = ConvertToRGB((System.Drawing.Bitmap)image);

                                lCmd.CommandText =
                                "SELECT INTPARAMSEQ, " +
                                "LTRIM(RTRIM(CHRPARAMNAME)), " +
                                "CASE " +
                                "WHEN INTXCOORD IS NULL THEN 0 " +
                                "ELSE INTXCOORD " +
                                "END AS INTXCOORD, " +
                                "CASE " +
                                "WHEN INTYCOORD IS NULL THEN 0 " +
                                "ELSE INTYCOORD " +
                                "END AS INTYCOORD, " +
                                "CASE " +
                                "WHEN INTZCOORD IS NULL THEN 0 " +
                                "ELSE INTZCOORD " +
                                "END AS INTZCOORD " +
                                "FROM dbo.T_CAB_SHAPE_DTLS C, " +
                                "dbo.shapeparamdetails_cube P, " +
                                "dbo.shapemaster_cube M " +
                                "WHERE C.CSD_SHAPE_ID = M.chrShapeCode " +
                                "AND M.intShapeID = P.intShapeID " +
                                "AND C.CSD_SEQ_NO = P.intParamSeq " +
                                "AND CSD_SHAPE_ID = '" + lOrderDetails[j].BarShapeCode + "' " +
                                "AND bitVISIBLE = 1 " +
                                "AND chrAngleType <> 'E' " +
                                //"AND chrAngleType <> 'D' " +
                                "AND chrAngleType <> 'N' " +
                                "AND chrAngleType <> 'EL' " +
                                "ORDER BY CHRPARAMNAME ";
                                lRst = lCmd.ExecuteReader();
                                if (lRst.HasRows)
                                {
                                    while (lRst.Read())
                                    {
                                        int lSeq = lRst.GetInt32(0);
                                        string lParam = lRst.GetString(1).Trim();
                                        int lTextX = lRst.GetInt32(2);
                                        int lTextY = lRst.GetInt32(3);

                                        string lP = "";

                                        switch (lParam)
                                        {
                                            case "A":
                                                if (lOrderDetails[j].A != null) lP = lOrderDetails[j].A.ToString();
                                                if (lOrderDetails[j].A2 != null) lP = lP + "-" + lOrderDetails[j].A2.ToString();
                                                break;
                                            case "B":
                                                if (lOrderDetails[j].B != null) lP = lOrderDetails[j].B.ToString();
                                                if (lOrderDetails[j].B2 != null) lP = lP + "-" + lOrderDetails[j].B2.ToString();
                                                break;
                                            case "C":
                                                if (lOrderDetails[j].C != null) lP = lOrderDetails[j].C.ToString();
                                                if (lOrderDetails[j].C2 != null) lP = lP + "-" + lOrderDetails[j].C2.ToString();
                                                break;
                                            case "D":
                                                if (lOrderDetails[j].D != null) lP = lOrderDetails[j].D.ToString();
                                                if (lOrderDetails[j].D2 != null) lP = lP + "-" + lOrderDetails[j].D2.ToString();
                                                break;
                                            case "E":
                                                if (lOrderDetails[j].E != null) lP = lOrderDetails[j].E.ToString();
                                                if (lOrderDetails[j].E2 != null) lP = lP + "-" + lOrderDetails[j].E2.ToString();
                                                break;
                                            case "F":
                                                if (lOrderDetails[j].F != null) lP = lOrderDetails[j].F.ToString();
                                                if (lOrderDetails[j].F2 != null) lP = lP + "-" + lOrderDetails[j].F2.ToString();
                                                break;
                                            case "G":
                                                if (lOrderDetails[j].G != null) lP = lOrderDetails[j].G.ToString();
                                                if (lOrderDetails[j].G2 != null) lP = lP + "-" + lOrderDetails[j].G2.ToString();
                                                break;
                                            case "H":
                                                if (lOrderDetails[j].H != null) lP = lOrderDetails[j].H.ToString();
                                                if (lOrderDetails[j].H2 != null) lP = lP + "-" + lOrderDetails[j].H2.ToString();
                                                break;
                                            case "I":
                                                if (lOrderDetails[j].I != null) lP = lOrderDetails[j].I.ToString();
                                                if (lOrderDetails[j].I2 != null) lP = lP + "-" + lOrderDetails[j].I2.ToString();
                                                break;
                                            case "J":
                                                if (lOrderDetails[j].J != null) lP = lOrderDetails[j].J.ToString();
                                                if (lOrderDetails[j].J2 != null) lP = lP + "-" + lOrderDetails[j].J2.ToString();
                                                break;
                                            case "K":
                                                if (lOrderDetails[j].K != null) lP = lOrderDetails[j].K.ToString();
                                                if (lOrderDetails[j].K2 != null) lP = lP + "-" + lOrderDetails[j].K2.ToString();
                                                break;
                                            case "L":
                                                if (lOrderDetails[j].L != null) lP = lOrderDetails[j].L.ToString();
                                                if (lOrderDetails[j].L2 != null) lP = lP + "-" + lOrderDetails[j].L2.ToString();
                                                break;
                                            case "M":
                                                if (lOrderDetails[j].M != null) lP = lOrderDetails[j].M.ToString();
                                                if (lOrderDetails[j].M2 != null) lP = lP + "-" + lOrderDetails[j].M2.ToString();
                                                break;
                                            case "N":
                                                if (lOrderDetails[j].N != null) lP = lOrderDetails[j].N.ToString();
                                                if (lOrderDetails[j].N2 != null) lP = lP + "-" + lOrderDetails[j].N2.ToString();
                                                break;
                                            case "O":
                                                if (lOrderDetails[j].O != null) lP = lOrderDetails[j].O.ToString();
                                                if (lOrderDetails[j].O2 != null) lP = lP + "-" + lOrderDetails[j].O2.ToString();
                                                break;
                                            case "P":
                                                if (lOrderDetails[j].P != null) lP = lOrderDetails[j].P.ToString();
                                                if (lOrderDetails[j].P2 != null) lP = lP + "-" + lOrderDetails[j].P2.ToString();
                                                break;
                                            case "Q":
                                                if (lOrderDetails[j].Q != null) lP = lOrderDetails[j].Q.ToString();
                                                if (lOrderDetails[j].Q2 != null) lP = lP + "-" + lOrderDetails[j].Q2.ToString();
                                                break;
                                            case "R":
                                                if (lOrderDetails[j].R != null) lP = lOrderDetails[j].R.ToString();
                                                if (lOrderDetails[j].R2 != null) lP = lP + "-" + lOrderDetails[j].R2.ToString();
                                                break;
                                            case "S":
                                                if (lOrderDetails[j].S != null) lP = lOrderDetails[j].S.ToString();
                                                if (lOrderDetails[j].S2 != null) lP = lP + "-" + lOrderDetails[j].S2.ToString();
                                                break;
                                            case "T":
                                                if (lOrderDetails[j].T != null) lP = lOrderDetails[j].T.ToString();
                                                if (lOrderDetails[j].T2 != null) lP = lP + "-" + lOrderDetails[j].T2.ToString();
                                                break;
                                            case "U":
                                                if (lOrderDetails[j].U != null) lP = lOrderDetails[j].U.ToString();
                                                if (lOrderDetails[j].U2 != null) lP = lP + "-" + lOrderDetails[j].U2.ToString();
                                                break;
                                            case "V":
                                                if (lOrderDetails[j].V != null) lP = lOrderDetails[j].V.ToString();
                                                if (lOrderDetails[j].V2 != null) lP = lP + "-" + lOrderDetails[j].V2.ToString();
                                                break;
                                            case "W":
                                                if (lOrderDetails[j].W != null) lP = lOrderDetails[j].W.ToString();
                                                if (lOrderDetails[j].W2 != null) lP = lP + "-" + lOrderDetails[j].W2.ToString();
                                                break;
                                            case "X":
                                                if (lOrderDetails[j].X != null) lP = lOrderDetails[j].X.ToString();
                                                if (lOrderDetails[j].X2 != null) lP = lP + "-" + lOrderDetails[j].X2.ToString();
                                                break;
                                            case "Y":
                                                if (lOrderDetails[j].Y != null) lP = lOrderDetails[j].Y.ToString();
                                                if (lOrderDetails[j].Y2 != null) lP = lP + "-" + lOrderDetails[j].Y2.ToString();
                                                break;
                                            case "Z":
                                                if (lOrderDetails[j].Z != null) lP = lOrderDetails[j].Z.ToString();
                                                if (lOrderDetails[j].Z2 != null) lP = lP + "-" + lOrderDetails[j].Z2.ToString();
                                                break;
                                        }

                                        //  System.Windows.Forms.Clipboard.SetDataObject(image);
                                        System.Drawing.Graphics g = System.Drawing.Graphics.FromImage(bmp);
                                        g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                                        g.DrawString(lP, new System.Drawing.Font("Areal Black", 12f, System.Drawing.FontStyle.Bold), System.Drawing.Brushes.Black, new System.Drawing.Point(lTextX + 4, lTextY + 4));
                                        g.Save();
                                        g.Dispose();
                                    }
                                }
                                lRst.Close();
                                //MemoryStream lMS = new MemoryStream();

                                //bmp.Save(lMS, System.Drawing.Imaging.ImageFormat.Png);
                                //bbsws.Row(RowNo).Height = 60;
                                //int picrow = RowNo - 1;
                                //System.Drawing.Image bbsimg = System.Drawing.Image.FromStream(lMS);
                                //ExcelPicture bbspic = bbsws.Drawings.AddPicture("bbs_Shape_" + lBBSContent[i].BBSNo + "_" + RowNo, bbsimg);
                                //bbspic.SetPosition(picrow, 2, 8, 2);
                                //bbspic.SetSize(76, 76);
                                MemoryStream lMS = new MemoryStream();
                                bmp.Save(lMS, System.Drawing.Imaging.ImageFormat.Png);
                                bbsws.Row(RowNo).Height = 60;
                                int picrow = RowNo - 1;
                                lMS.Position = 0; // Reset stream position before creating the image
                                System.Drawing.Image bbsimg = System.Drawing.Image.FromStream(lMS);
                                ExcelPicture bbspic = bbsws.Drawings.AddPicture("bbs_Shape_" + lBBSContent[i].BBSNo + "_" + RowNo, lMS);
                                bbspic.SetPosition(picrow, 2, 8, 2);
                                bbspic.SetSize(76, 76);

                            }
                            else
                            {
                                var lCustomerImage = db.CustomerShape.Find(CustomerCode, ProjectCode, lOrderDetails[j].BarShapeCode);
                                if (lCustomerImage != null)
                                {
                                    int picrow = RowNo - 1;
                                    System.Drawing.Image bbsimg = System.Drawing.Image.FromStream(new MemoryStream(lCustomerImage.shapeImage));
                                    ExcelPicture bbspic = bbsws.Drawings.AddPicture("bbs_Shape_" + lBBSContent[i].BBSNo + "_" + RowNo, "D:\\images\\NatSteelLogo.gif");
                                    bbspic.SetPosition(picrow, 2, 8, 2);
                                    bbspic.SetSize(76, 76);

                                }
                                else
                                {
                                    bbsws.Cells[RowNo, 9].Value = "";
                                }
                            }

                            for (int k = 0; k < lPara.Count; k++)
                            {
                                string lP = "";
                                switch (lPara[k])
                                {
                                    case "A":
                                        if (lOrderDetails[j].A != null) lP = lOrderDetails[j].A.ToString();
                                        if (lOrderDetails[j].A2 != null) lP = lP + "-" + lOrderDetails[j].A2.ToString();
                                        break;
                                    case "B":
                                        if (lOrderDetails[j].B != null) lP = lOrderDetails[j].B.ToString();
                                        if (lOrderDetails[j].B2 != null) lP = lP + "-" + lOrderDetails[j].B2.ToString();
                                        break;
                                    case "C":
                                        if (lOrderDetails[j].C != null) lP = lOrderDetails[j].C.ToString();
                                        if (lOrderDetails[j].C2 != null) lP = lP + "-" + lOrderDetails[j].C2.ToString();
                                        break;
                                    case "D":
                                        if (lOrderDetails[j].D != null) lP = lOrderDetails[j].D.ToString();
                                        if (lOrderDetails[j].D2 != null) lP = lP + "-" + lOrderDetails[j].D2.ToString();
                                        break;
                                    case "E":
                                        if (lOrderDetails[j].E != null) lP = lOrderDetails[j].E.ToString();
                                        if (lOrderDetails[j].E2 != null) lP = lP + "-" + lOrderDetails[j].E2.ToString();
                                        break;
                                    case "F":
                                        if (lOrderDetails[j].F != null) lP = lOrderDetails[j].F.ToString();
                                        if (lOrderDetails[j].F2 != null) lP = lP + "-" + lOrderDetails[j].F2.ToString();
                                        break;
                                    case "G":
                                        if (lOrderDetails[j].G != null) lP = lOrderDetails[j].G.ToString();
                                        if (lOrderDetails[j].G2 != null) lP = lP + "-" + lOrderDetails[j].G2.ToString();
                                        break;
                                    case "H":
                                        if (lOrderDetails[j].H != null) lP = lOrderDetails[j].H.ToString();
                                        if (lOrderDetails[j].H2 != null) lP = lP + "-" + lOrderDetails[j].H2.ToString();
                                        break;
                                    case "I":
                                        if (lOrderDetails[j].I != null) lP = lOrderDetails[j].I.ToString();
                                        if (lOrderDetails[j].I2 != null) lP = lP + "-" + lOrderDetails[j].I2.ToString();
                                        break;
                                    case "J":
                                        if (lOrderDetails[j].J != null) lP = lOrderDetails[j].J.ToString();
                                        if (lOrderDetails[j].J2 != null) lP = lP + "-" + lOrderDetails[j].J2.ToString();
                                        break;
                                    case "K":
                                        if (lOrderDetails[j].K != null) lP = lOrderDetails[j].K.ToString();
                                        if (lOrderDetails[j].K2 != null) lP = lP + "-" + lOrderDetails[j].K2.ToString();
                                        break;
                                    case "L":
                                        if (lOrderDetails[j].L != null) lP = lOrderDetails[j].L.ToString();
                                        if (lOrderDetails[j].L2 != null) lP = lP + "-" + lOrderDetails[j].L2.ToString();
                                        break;
                                    case "M":
                                        if (lOrderDetails[j].M != null) lP = lOrderDetails[j].M.ToString();
                                        if (lOrderDetails[j].M2 != null) lP = lP + "-" + lOrderDetails[j].M2.ToString();
                                        break;
                                    case "N":
                                        if (lOrderDetails[j].N != null) lP = lOrderDetails[j].N.ToString();
                                        if (lOrderDetails[j].N2 != null) lP = lP + "-" + lOrderDetails[j].N2.ToString();
                                        break;
                                    case "O":
                                        if (lOrderDetails[j].O != null) lP = lOrderDetails[j].O.ToString();
                                        if (lOrderDetails[j].O2 != null) lP = lP + "-" + lOrderDetails[j].O2.ToString();
                                        break;
                                    case "P":
                                        if (lOrderDetails[j].P != null) lP = lOrderDetails[j].P.ToString();
                                        if (lOrderDetails[j].P2 != null) lP = lP + "-" + lOrderDetails[j].P2.ToString();
                                        break;
                                    case "Q":
                                        if (lOrderDetails[j].Q != null) lP = lOrderDetails[j].Q.ToString();
                                        if (lOrderDetails[j].Q2 != null) lP = lP + "-" + lOrderDetails[j].Q2.ToString();
                                        break;
                                    case "R":
                                        if (lOrderDetails[j].R != null) lP = lOrderDetails[j].R.ToString();
                                        if (lOrderDetails[j].R2 != null) lP = lP + "-" + lOrderDetails[j].R2.ToString();
                                        break;
                                    case "S":
                                        if (lOrderDetails[j].S != null) lP = lOrderDetails[j].S.ToString();
                                        if (lOrderDetails[j].S2 != null) lP = lP + "-" + lOrderDetails[j].S2.ToString();
                                        break;
                                    case "T":
                                        if (lOrderDetails[j].T != null) lP = lOrderDetails[j].T.ToString();
                                        if (lOrderDetails[j].T2 != null) lP = lP + "-" + lOrderDetails[j].T2.ToString();
                                        break;
                                    case "U":
                                        if (lOrderDetails[j].U != null) lP = lOrderDetails[j].U.ToString();
                                        if (lOrderDetails[j].U2 != null) lP = lP + "-" + lOrderDetails[j].U2.ToString();
                                        break;
                                    case "V":
                                        if (lOrderDetails[j].V != null) lP = lOrderDetails[j].V.ToString();
                                        if (lOrderDetails[j].V2 != null) lP = lP + "-" + lOrderDetails[j].V2.ToString();
                                        break;
                                    case "W":
                                        if (lOrderDetails[j].W != null) lP = lOrderDetails[j].W.ToString();
                                        if (lOrderDetails[j].W2 != null) lP = lP + "-" + lOrderDetails[j].W2.ToString();
                                        break;
                                    case "X":
                                        if (lOrderDetails[j].X != null) lP = lOrderDetails[j].X.ToString();
                                        if (lOrderDetails[j].X2 != null) lP = lP + "-" + lOrderDetails[j].X2.ToString();
                                        break;
                                    case "Y":
                                        if (lOrderDetails[j].Y != null) lP = lOrderDetails[j].Y.ToString();
                                        if (lOrderDetails[j].Y2 != null) lP = lP + "-" + lOrderDetails[j].Y2.ToString();
                                        break;
                                    case "Z":
                                        if (lOrderDetails[j].Z != null) lP = lOrderDetails[j].Z.ToString();
                                        if (lOrderDetails[j].Z2 != null) lP = lP + "-" + lOrderDetails[j].Z2.ToString();
                                        break;
                                }

                                if (lP.Length > 0) bbsws.Cells[RowNo, 9 + (k + 1)].Value = lP.ToString();
                                else bbsws.Cells[RowNo, 9 + (k + 1)].Value = "";

                                // if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);

                            }
                            int cols = 9 + lPara.Count + 1;

                            bbsws.Cells[RowNo, cols].Value = lOrderDetails[j].PinSize == null || lOrderDetails[j].PinSize == 0 ? "" : lOrderDetails[j].PinSize.ToString();

                            var lLen = "";
                            if (lOrderDetails[j].BarLength != null) lLen = lOrderDetails[j].BarLength.ToString();
                            if (lOrderDetails[j].BarLength2 != null) lLen = lLen + "-" + lOrderDetails[j].BarLength2.ToString();

                            bbsws.Cells[RowNo, cols + 1].Value = lLen;

                            //         if (lOrderDetails[j].BarSTD == true) bbsws.Cells[RowNo, cols].Style.Font.Color = new BaseColor(240, 240, 240);


                            if (lOrderDetails[j].BarWeight == null)
                            {
                                bbsws.Cells[RowNo, cols + 2].Value = "";
                            }
                            else
                            {
                                bbsws.Cells[RowNo, cols + 2].Value = (decimal)lOrderDetails[j].BarWeight;
                            }

                            //   if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);

                            bbsws.Cells[RowNo, cols + 3].Value = lOrderDetails[j].Remarks == null ? "" : lOrderDetails[j].Remarks.Trim();
                            //  if (lOrderDetails[j].BarSTD == true) orderCell.BackgroundColor = new BaseColor(240, 240, 240);
                            RowNo = RowNo + 1;
                        }

                    }
                }
            }

            MemoryStream ms = new MemoryStream();
            package.SaveAs(ms);

            var bExcel = new byte[ms.Length];
            ms.Position = 0;
            ms.Read(bExcel, 0, bExcel.Length);

            //bPDF = ms.GetBuffer();
            ms.Flush();
            ms.Dispose();
            var fileName = "abc";
            using (MemoryStream memoryStream = new MemoryStream(bExcel)) // Replace bExcelData with your Excel data byte array
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                // Set content disposition with the appropriate file name and extension for Excel
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName + ".xlsx"; // Change the file extension to .xlsx for Excel
                                                                                           // Set the content type to Excel
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"); // Use the appropriate MIME type for Excel
                return File(response.Content.ReadAsByteArrayAsync().Result, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"); // Use the appropriate MIME type for Excel
            }
            // return Json(bExcel);

        }

        [HttpGet]
        [Route("/exportDiaSummaryToExcel/{CustomerCode}/{ProjectCode}/{OrderNumber}/{JobID}")]
        public ActionResult exportDiaSummaryToExcel(string CustomerCode, string ProjectCode, int OrderNumber, int JobID)
        {
            int lPODocExists = 0;

            var lHeader = db.OrderProject.Find(OrderNumber);
            iTextSharp.text.pdf.BaseFont baseFont;

            if (System.IO.File.Exists("C:\\WINDOWS\\FONTS\\simfang.ttf"))
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\simfang.ttf",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }
            else if (System.IO.File.Exists("C:\\WINDOWS\\FONTS\\simsun.ttc"))
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\simsun.ttc, 1",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }
            else
            {
                baseFont = BaseFont.CreateFont(
                "C:\\WINDOWS\\FONTS\\msyhl.ttc, 1",
                BaseFont.IDENTITY_H,
                BaseFont.EMBEDDED);
            }

            var titleFont = new iTextSharp.text.Font(baseFont, 16, iTextSharp.text.Font.BOLD);
            var subTitleFont = FontFactory.GetFont("Arial", 14, iTextSharp.text.Font.BOLD);
            var boldTableFont = new iTextSharp.text.Font(baseFont, 12, iTextSharp.text.Font.BOLD);
            var TableFont = new iTextSharp.text.Font(baseFont, 12, iTextSharp.text.Font.NORMAL);
            var endingMessageFont = FontFactory.GetFont("Arial", 10, iTextSharp.text.Font.ITALIC);
            var DateFont = FontFactory.GetFont("Arial", 10, iTextSharp.text.Font.NORMAL);
            var boldBBSFont = new iTextSharp.text.Font(baseFont, 10, iTextSharp.text.Font.BOLD);
            var BBSFont = new iTextSharp.text.Font(baseFont, 10, iTextSharp.text.Font.NORMAL);

            int rowindex = 0;
            int lColNo = 10;
            string lColLetter = Convert.ToChar(60 + lColNo).ToString(); // A Ascii -- 65


            ExcelPackage package = new ExcelPackage();
            ExcelWorksheet ws = package.Workbook.Worksheets.Add("Rebar Diameter Summary");
            //System.Drawing.Image img = System.Drawing.Image.FromFile(System.Web.HttpContext.Current.Server.MapPath("~/Content/images/NatSteelLogo.gif"));
            //ExcelPicture pic = ws.Drawings.AddPicture("Picture_Name", img);
            //pic.SetPosition(rowindex, 2, 0, 0);

            ws.Column(1).Width = 40;
            ws.Column(2).Width = 40;
            ws.Column(3).Width = 40;


            rowindex = 1;
            ws.Cells[rowindex, 1].StyleName = BBSFont.ToString();
            ws.Cells[rowindex, 1].Value = "Serial No. (序号): ";
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 2].Value = OrderNumber.ToString("D4");
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 2;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Customer(客户名称):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            CustomerModels lCustomer = db.Customer.Find(lHeader.CustomerCode);
            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            if (lCustomer != null) ws.Cells[rowindex, 2].Value = (lCustomer.CustomerName.Trim() + " (" + lCustomer.CustomerCode.Trim() + ")");
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 3;
            var lProject = (from p in db.ProjectList
                            where p.ProjectCode == ProjectCode
                            select p).First();
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Project (项目名称):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            if (lProject != null) ws.Cells[rowindex, 2].Value = (lProject.ProjectTitle.Trim() + " (" + lProject.ProjectCode.Trim() + ")");
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;


            rowindex = 4;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Value = "Block (WBS1) (座号/大牌):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = lHeader.WBS1;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 5;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Value = "Storey (WBS2) (楼层):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = lHeader.WBS2;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 6;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Value = "Part (WBS3) (分部):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = lHeader.WBS3;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 7;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "PO No. (订单号码):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = (lHeader.PONumber == null ? "" : lHeader.PONumber.Trim());
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 8;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Order Date (订单日期):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
            ws.Cells[rowindex, 2].Value = lHeader.PODate == null ? "" : ((DateTime)lHeader.PODate).ToString("yyyy-MM-dd");
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 9;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Required Date (交货日期):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = (lHeader.RequiredDate == null ? "" : String.Format("{0:yyyy-MM-dd}", lHeader.RequiredDate));
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 10;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Value = "Order Weight (订单重量):";
            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
            ws.Cells[rowindex, 2].Style.Font.Bold = true;
            ws.Cells[rowindex, 2].Value = (Math.Round((decimal)lHeader.TotalWeight / 1000, 3)).ToString("F3") + " MT";
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            rowindex = 11;
            ws.Cells[rowindex, 1].Style.WrapText = true;
            ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            ws.Cells[rowindex, 1].Style.Fill.PatternType = ExcelFillStyle.Solid;
            ws.Cells[rowindex, 1].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
            ws.Cells[rowindex, 1].Value = "Bar Diameter\n钢筋直径";
            ws.Cells[rowindex, 2].Style.WrapText = true;
            ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            ws.Cells[rowindex, 2].Style.Fill.PatternType = ExcelFillStyle.Solid;
            ws.Cells[rowindex, 2].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
            ws.Cells[rowindex, 2].Value = "Total Bar Length (MM)\n钢筋长度(毫米) ";
            ws.Cells[rowindex, 3].Style.WrapText = true;
            ws.Cells[rowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
            ws.Cells[rowindex, 3].Style.Fill.PatternType = ExcelFillStyle.Solid;
            ws.Cells[rowindex, 3].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
            ws.Cells[rowindex, 3].Value = "Total Weight (KG)\n总重量(公斤)";

            ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells[rowindex, 2].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 2].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            ws.Cells[rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
            ws.Cells[rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

            var lProcessObj = new ProcessController();
            var lNDSCon = new SqlConnection();
            var lCmd = new SqlCommand();
            SqlDataReader lRst;

            lProcessObj = new ProcessController();
            lProcessObj.OpenNDSConnection(ref lNDSCon);

            lCmd.CommandText =
            "SELECT " +
            "BarType, BarSize, " +
            "SUM(isNull(BarWeight, 0)) as TotalWT, " +
            "MIN(isNull(case when BarLength2 < BarLength AND BarLength2 > 0 " +
            "then BarLength2 else BarLength end, 0)) as TotalLenMin, " +
            "MAX(isNull(case when BarLength2 > 0 AND BarLength2 > BarLength " +
            "then BarLength2 else BarLength end, 0)) as TotalLenMax " +
            "FROM dbo.OESOrderDetails " +
            "WHERE CustomerCode = '" + CustomerCode + "' " +
            "AND ProjectCode = '" + ProjectCode + "' " +
            "AND JobID =  " + JobID + " " +
            "AND (Cancelled is null " +
            "OR Cancelled <> 1) " +
            "AND BarTotalQty > 0 " +
            "AND BarType IS NOT Null " +
            "AND BarType <> '' " +
            "AND BarSize IS NOT Null " +
            "AND BarSize > 0 " +
            "GROUP BY " +
            "BarType, BarSize " +
            "ORDER BY " +
            "BarSize, " +
            "BarType ";

            lCmd.Connection = lNDSCon;
            lCmd.CommandTimeout = 300;
            lRst = lCmd.ExecuteReader();
            if (lRst.HasRows)
            {
                rowindex = 12;

                while (lRst.Read())
                {
                    ws.Row(rowindex).Height = 30;
                    ws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    ws.Cells[rowindex, 1].Style.Font.Bold = true;
                    ws.Cells[rowindex, 1].Style.Font.Size = 12;
                    ws.Cells[rowindex, 1].Style.WrapText = false;
                    ws.Cells[rowindex, 1].Value = (string)lRst.GetValue(0) + lRst.GetValue(1).ToString();
                    ws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    ws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    ws.Cells[rowindex, 2].Style.Font.Bold = true;
                    ws.Cells[rowindex, 2].Style.Font.Size = 12;
                    ws.Cells[rowindex, 2].Style.WrapText = false;
                    ws.Cells[rowindex, 2].Value = ((int)lRst.GetValue(3)) > 0 && (int)lRst.GetValue(3) != (int)lRst.GetValue(4) ? lRst.GetValue(3).ToString() + " - " + lRst.GetValue(4).ToString() : lRst.GetValue(4).ToString();
                    ws.Cells[rowindex, 2].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 2].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 2].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 2].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    ws.Cells[rowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                    ws.Cells[rowindex, 3].Style.Font.Bold = true;
                    ws.Cells[rowindex, 3].Style.Font.Size = 12;
                    ws.Cells[rowindex, 3].Style.WrapText = false;
                    ws.Cells[rowindex, 3].Value = ((decimal)lRst.GetValue(2)).ToString("F0");
                    ws.Cells[rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    ws.Cells[rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;
                    rowindex = rowindex + 1;
                }
            }
            lRst.Close();

            var lBBSContent = (from p in db.BBS
                               where p.CustomerCode == CustomerCode &&
                               p.ProjectCode == ProjectCode &&
                               p.JobID == JobID
                               orderby p.BBSID
                               select p).ToList();
            if (lBBSContent.Count > 0)
            {
                for (int i = 0; i < lBBSContent.Count; i++)
                {
                    ExcelWorksheet bbsws = package.Workbook.Worksheets.Add(lBBSContent[i].BBSNo);

                    bbsws.Column(1).Width = 40;
                    bbsws.Column(2).Width = 40;
                    bbsws.Column(3).Width = 40;


                    rowindex = 1;
                    bbsws.Cells[rowindex, 1].StyleName = BBSFont.ToString();
                    bbsws.Cells[rowindex, 1].Value = "BBS No. (加工表号码): ";
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 2].Value = lBBSContent[i].BBSNo;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 2;
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 1].Style.WrapText = true;
                    bbsws.Cells[rowindex, 1].Value = "BBS　Description　(加工表描述):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = lBBSContent[i].BBSDesc;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 3;
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 1].Value = "Block (WBS1) (座号/大牌):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = lHeader.WBS1;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 4;
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 1].Value = "Storey (WBS2) (楼层):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = lHeader.WBS2;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 5;
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
                    bbsws.Cells[rowindex, 1].Value = "Part (WBS3) (分部):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = lHeader.WBS3;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 6;
                    bbsws.Cells[rowindex, 1].Style.WrapText = true;
                    bbsws.Cells[rowindex, 1].Value = "Required Date (交货日期):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = String.Format("{0:yyyy-MM-dd}", lHeader.RequiredDate);
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 7;
                    bbsws.Cells[rowindex, 1].Style.WrapText = true;
                    bbsws.Cells[rowindex, 1].Value = "BBS Weight (加工表重量):";
                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells["B" + rowindex + ":" + "C" + rowindex].Merge = true;
                    bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                    bbsws.Cells[rowindex, 2].Value = (Math.Round((decimal)lBBSContent[i].BBSTotalWT / 1000, 3)).ToString("F3") + " MT";
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2, rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    rowindex = 8;
                    bbsws.Cells[rowindex, 1].Style.WrapText = true;
                    bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    bbsws.Cells[rowindex, 1].Style.Fill.PatternType = ExcelFillStyle.Solid;
                    bbsws.Cells[rowindex, 1].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
                    bbsws.Cells[rowindex, 1].Value = "Bar Diameter\n钢筋直径";
                    bbsws.Cells[rowindex, 2].Style.WrapText = true;
                    bbsws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    bbsws.Cells[rowindex, 2].Style.Fill.PatternType = ExcelFillStyle.Solid;
                    bbsws.Cells[rowindex, 2].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
                    bbsws.Cells[rowindex, 2].Value = "Total Bar Length (MM)\n钢筋长度(毫米) ";
                    bbsws.Cells[rowindex, 3].Style.WrapText = true;
                    bbsws.Cells[rowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                    bbsws.Cells[rowindex, 3].Style.Fill.PatternType = ExcelFillStyle.Solid;
                    bbsws.Cells[rowindex, 3].Style.Fill.BackgroundColor.SetColor(System.Drawing.ColorTranslator.FromHtml("#eeeeee"));
                    bbsws.Cells[rowindex, 3].Value = "Total Weight (KG)\n总重量(公斤)";

                    bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells[rowindex, 2].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 2].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    bbsws.Cells[rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                    bbsws.Cells[rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                    lCmd.CommandText =
                    "SELECT " +
                    "BarType, BarSize, " +
                    "SUM(isNull(BarWeight, 0)) as TotalWT, " +
                    "MIN(isNull(case when BarLength2 < BarLength AND BarLength2 > 0 " +
                    "then BarLength2 else BarLength end, 0)) as TotalLenMin, " +
                    "MAX(isNull(case when BarLength2 > 0 AND BarLength2 > BarLength " +
                    "then BarLength2 else BarLength end, 0)) as TotalLenMax " +
                    "FROM dbo.OESOrderDetails " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID =  " + JobID + " " +
                    "AND BBSID = " + lBBSContent[i].BBSID.ToString() + " " +
                    "AND (Cancelled is null " +
                    "OR Cancelled <> 1) " +
                    "AND BarTotalQty > 0 " +
                    "AND BarType IS NOT Null " +
                    "AND BarType <> '' " +
                    "AND BarSize IS NOT Null " +
                    "AND BarSize > 0 " +
                    "GROUP BY " +
                    "BarType, BarSize " +
                    "ORDER BY " +
                    "BarSize, " +
                    "BarType ";

                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        rowindex = 9;

                        while (lRst.Read())
                        {
                            bbsws.Row(rowindex).Height = 30;
                            bbsws.Cells[rowindex, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                            bbsws.Cells[rowindex, 1].Style.Font.Bold = true;
                            bbsws.Cells[rowindex, 1].Style.Font.Size = 12;
                            bbsws.Cells[rowindex, 1].Style.WrapText = false;
                            bbsws.Cells[rowindex, 1].Value = (string)lRst.GetValue(0) + lRst.GetValue(1).ToString();
                            bbsws.Cells[rowindex, 1].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 1].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 1].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 1].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                            bbsws.Cells[rowindex, 2].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            bbsws.Cells[rowindex, 2].Style.Font.Bold = true;
                            bbsws.Cells[rowindex, 2].Style.Font.Size = 12;
                            bbsws.Cells[rowindex, 2].Style.WrapText = false;
                            bbsws.Cells[rowindex, 2].Value = ((int)lRst.GetValue(3)) > 0 && (int)lRst.GetValue(3) != (int)lRst.GetValue(4) ? lRst.GetValue(3).ToString() + " - " + lRst.GetValue(4).ToString() : lRst.GetValue(4).ToString();
                            bbsws.Cells[rowindex, 2].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 2].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 2].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 2].Style.Border.Right.Style = ExcelBorderStyle.Thin;

                            bbsws.Cells[rowindex, 3].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
                            bbsws.Cells[rowindex, 3].Style.Font.Bold = true;
                            bbsws.Cells[rowindex, 3].Style.Font.Size = 12;
                            bbsws.Cells[rowindex, 3].Style.WrapText = false;
                            bbsws.Cells[rowindex, 3].Value = ((decimal)lRst.GetValue(2)).ToString("F0");
                            bbsws.Cells[rowindex, 3].Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 3].Style.Border.Top.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 3].Style.Border.Left.Style = ExcelBorderStyle.Thin;
                            bbsws.Cells[rowindex, 3].Style.Border.Right.Style = ExcelBorderStyle.Thin;
                            rowindex = rowindex + 1;
                        }
                    }
                    lRst.Close();

                }
            }

            lProcessObj.CloseNDSConnection(ref lNDSCon);

            MemoryStream ms = new MemoryStream();
            package.SaveAs(ms);

            var bExcel = new byte[ms.Length];
            ms.Position = 0;
            ms.Read(bExcel, 0, bExcel.Length);

            //bPDF = ms.GetBuffer();
            ms.Flush();
            ms.Dispose();
            var fileName = "abc";
            using (MemoryStream memoryStream = new MemoryStream(bExcel)) // Replace bExcelData with your Excel data byte array
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                // Set content disposition with the appropriate file name and extension for Excel
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName + ".xlsx"; // Change the file extension to .xlsx for Excel
                                                                                           // Set the content type to Excel
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"); // Use the appropriate MIME type for Excel
                return File(response.Content.ReadAsByteArrayAsync().Result, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"); // Use the appropriate MIME type for Excel
            }
            //return Json(bExcel, System.Web.Mvc.JsonRequestBehavior.AllowGet);

        }


        public void AddParamaters(string pName, int? pValue, ref System.Collections.Generic.List<string> lList)
        {
            int lP = 0;
            int lFound = 0;
            if (pValue != null) lP = (int)pValue;
            if (lP > 0)
            {
                lFound = 0;
                if (lList.Count > 4)
                {
                    for (int k = 4; k < lList.Count; k++)
                    {
                        if (lList[k] == pName)
                        {
                            lFound = 1;
                            break;
                        }
                    }
                }
                if (lFound == 0)
                {
                    lList.Add(pName);
                }
            }

        }



        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult createNewOrder(string CustomerCode, string ProjectCode)
        //       {
        //           bool lSuccess = true;
        //           if (createJobAdvice(CustomerCode, ProjectCode, false) < 0)
        //           {
        //               lSuccess = false;
        //           }

        //           return Json(new { success = lSuccess }, JsonRequestBehavior.AllowGet);
        //       }

        //       public int createJobAdvice(string pCustomerCode, string pProjectCode, bool pClone)
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lErrorMsg = "";
        //           int lFound = 0;
        //           int? lJobID = 0;
        //           try
        //           {
        //               if (pCustomerCode == null)
        //               {
        //                   pCustomerCode = "";
        //               }
        //               if (pProjectCode == null)
        //               {
        //                   pProjectCode = "";
        //               }
        //               pCustomerCode = pCustomerCode.Trim();
        //               pProjectCode = pProjectCode.Trim();
        //               if (pCustomerCode.Length > 0 && pProjectCode.Length > 0)
        //               {
        //                   var lSubmission = "No";
        //                   var lEditable = "No";

        //                   string lUserType = "";
        //                   if (gUserType != null && gUserType != "")
        //                   {
        //                       lUserType = gUserType;
        //                   }
        //                   else
        //                   {
        //                       UserAccessController lUa = new UserAccessController();
        //                       lUserType = lUa.getUserType(User.Identity.GetUserName());
        //                       gUserType = lUserType;
        //                       lUa = null;
        //                   }
        //                   if (lUserType == "CU" || lUserType == "CA" || lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU")
        //                   {
        //                       var lAccess = db.UserAccess.Find(User.Identity.Name, pCustomerCode, pProjectCode);
        //                       if (lAccess != null)
        //                       {
        //                           lSubmission = lAccess.OrderSubmission.Trim();
        //                           lEditable = lAccess.OrderCreation.Trim();
        //                       }
        //                       if (lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU")
        //                       {
        //                           lEditable = "Yes";
        //                       }

        //                       if (lEditable == "Yes")
        //                       {
        //                           lFound = 0;
        //                           lJobID = db.JobAdvice.Where(z => z.CustomerCode == pCustomerCode &&
        //                           z.ProjectCode == pProjectCode).Max(z => (int?)z.JobID);

        //                           if (lJobID != null)
        //                           {
        //                               lFound = 1;

        //                               var lCheckBar = (from p in db.OrderDetails
        //                                                where p.CustomerCode == pCustomerCode &&
        //                                                p.ProjectCode == pProjectCode &&
        //                                                p.JobID == lJobID &&
        //                                                p.BarShapeCode != null &&
        //                                                p.BarShapeCode != "" &&
        //                                                p.UpdateBy != User.Identity.Name
        //                                                select p).ToList();

        //                               var lCheckBBS = (from p in db.BBS
        //                                                where p.CustomerCode == pCustomerCode &&
        //                                                p.ProjectCode == pProjectCode &&
        //                                                p.JobID == lJobID &&
        //                                                p.BBSNo != null &&
        //                                                p.BBSNo != "" &&
        //                                                p.UpdateBy != User.Identity.Name
        //                                                select p).ToList();

        //                               var lCheckJob = db.JobAdvice.Find(pCustomerCode, pProjectCode, lJobID);

        //                               if (lCheckJob == null || (lCheckJob.OrderStatus != "New" && lCheckJob.OrderStatus != "Created") ||
        //                                   lCheckBar.Count > 0 ||
        //                                   lCheckBBS.Count > 0 ||
        //                                   (lCheckJob.PONumber != null && lCheckJob.PONumber != "") ||
        //                                   ((lCheckJob.TotalWeight != null && lCheckJob.TotalWeight > 0) &&
        //                                   (lCheckJob.UpdateBy != User.Identity.GetUserName() ||
        //                                   pClone == true)))
        //                               {
        //                                   lFound = 0;
        //                               }

        //                               //    var lEmptyOrder = (from p in db.JobAdvice
        //                               //                   where p.CustomerCode == pCustomerCode &&
        //                               //                   p.ProjectCode == pProjectCode &&
        //                               //                   p.JobID == lJobID &&
        //                               //                   (p.PONumber == null ||
        //                               //                   p.PONumber == "") &&
        //                               //                   p.UpdateBy == User.Identity.Name
        //                               //                   select p).ToList();

        //                               //if (lEmptyOrder.Count > 0)
        //                               //{
        //                               //    if (lEmptyOrder[0].JobID == lJobID)
        //                               //    {
        //                               //        lFound = 1;
        //                               //    }
        //                               //}
        //                           }

        //                           if (lFound == 0)
        //                           {
        //                               var lJobAdv = new JobAdviceModels();
        //                               lJobAdv.CustomerCode = pCustomerCode;
        //                               lJobAdv.ProjectCode = pProjectCode;

        //                               if (lJobID == null)
        //                               {
        //                                   lJobAdv.JobID = 1;
        //                               }
        //                               else
        //                               {
        //                                   lJobAdv.JobID = (int)lJobID + 1;
        //                               }

        //                               lJobAdv.PODate = DateTime.Now;
        //                               lJobAdv.RequiredDate = DateTime.Now.AddDays(5);
        //                               lJobAdv.TotalCABWeight = 0;
        //                               lJobAdv.TotalSTDWeight = 0;
        //                               lJobAdv.TotalWeight = 0;

        //                               lJobAdv.OrderStatus = "New";
        //                               lJobAdv.DeliveryAddress = "";
        //                               lJobAdv.Remarks = "";
        //                               lJobAdv.ProjectStage = "TYP";
        //                               lJobAdv.WBS1 = "";
        //                               lJobAdv.WBS2 = "";
        //                               lJobAdv.WBS3 = "";

        //                               var lProj = db.Project.Find(pCustomerCode, pProjectCode);
        //                               if (lProj != null)
        //                               {
        //                                   var lProcessObj = new ProcessController();
        //                                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                                   {
        //                                       lCmd.CommandText =
        //                                       "SELECT isNull(MAX(JobID), 0) FROM dbo.OESJobAdvice " +
        //                                       "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                       "AND ProjectCode = '" + pProjectCode + "' " +
        //                                       "AND OrderStatus <> 'New' " +
        //                                       "AND OrderStatus <> 'Created' " +
        //                                       "AND OrderStatus is not NULL " +
        //                                       "AND OrderStatus <> '' " +
        //                                       "AND (SiteEngr_Name > '' " +
        //                                       "OR Scheduler_Name > '' " +
        //                                       "OR DeliveryAddress > '' ) ";

        //                                       int LastJobID = 0;

        //                                       lCmd.Connection = lNDSCon;
        //                                       lCmd.CommandTimeout = 300;
        //                                       lRst = lCmd.ExecuteReader();
        //                                       if (lRst.HasRows)
        //                                       {
        //                                           if (lRst.Read())
        //                                           {
        //                                               LastJobID = lRst.GetInt32(0);
        //                                           }
        //                                       }
        //                                       lRst.Close();

        //                                       if (LastJobID > 0)
        //                                       {
        //                                           if (lUserType == "CU" || lUserType == "CA")
        //                                           {
        //                                               lCmd.CommandText =
        //                                               "SELECT isNull(MAX(JobID), 0) FROM dbo.OESJobAdvice " +
        //                                               "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                               "AND ProjectCode = '" + pProjectCode + "' " +
        //                                               "AND OrderStatus <> 'New' " +
        //                                               "AND OrderStatus <> 'Created' " +
        //                                               "AND OrderStatus is not NULL " +
        //                                               "AND OrderStatus <> '' " +
        //                                               "AND UpdateBy = '" + User.Identity.GetUserName() + "' " +
        //                                               "AND (SiteEngr_Name > '' " +
        //                                               "OR Scheduler_Name > '' " +
        //                                               "OR DeliveryAddress > '' ) ";

        //                                               int LastMyJobID = 0;

        //                                               lCmd.Connection = lNDSCon;
        //                                               lCmd.CommandTimeout = 300;
        //                                               lRst = lCmd.ExecuteReader();
        //                                               if (lRst.HasRows)
        //                                               {
        //                                                   if (lRst.Read())
        //                                                   {
        //                                                       LastMyJobID = lRst.GetInt32(0);
        //                                                   }
        //                                               }
        //                                               lRst.Close();


        //                                               lCmd.CommandText =
        //                                               "SELECT isNull(SiteEngr_Name, ''), " +
        //                                               "isNull(SiteEngr_HP, ''), " +
        //                                               "isNull(SiteEngr_Tel, ''), " +
        //                                               "isNull(Scheduler_Name, ''), " +
        //                                               "isNull(Scheduler_HP, ''), " +
        //                                               "isNull(Scheduler_Tel, ''), " +
        //                                               "isNull(DeliveryAddress, '') " +
        //                                               "FROM dbo.OESJobAdvice " +
        //                                               "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                               "AND ProjectCode = '" + pProjectCode + "' " +
        //                                               "AND JobID = " + LastMyJobID.ToString() + " " +
        //                                               "AND UpdateBy = '" + User.Identity.GetUserName() + "' " +
        //                                               "UNION " +
        //                                               "SELECT isNull(SiteEngr_Name, ''), " +
        //                                               "isNull(SiteEngr_HP, ''), " +
        //                                               "isNull(SiteEngr_Tel, ''), " +
        //                                               "isNull(Scheduler_Name, ''), " +
        //                                               "isNull(Scheduler_HP, ''), " +
        //                                               "isNull(Scheduler_Tel, ''), " +
        //                                               "isNull(DeliveryAddress, '') " +
        //                                               "FROM dbo.OESJobAdvice " +
        //                                               "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                               "AND ProjectCode = '" + pProjectCode + "' " +
        //                                               "AND JobID = " + LastJobID.ToString() + " ";
        //                                           }
        //                                           else
        //                                           {
        //                                               lCmd.CommandText =
        //                                               "SELECT isNull(SiteEngr_Name,''), " +
        //                                               "isNull(SiteEngr_HP,''), " +
        //                                               "isNull(SiteEngr_Tel,''), " +
        //                                               "isNull(Scheduler_Name,''), " +
        //                                               "isNull(Scheduler_HP,''), " +
        //                                               "isNull(Scheduler_Tel,''), " +
        //                                               "isNull(DeliveryAddress, '') " +
        //                                               "FROM dbo.OESJobAdvice " +
        //                                               "WHERE CustomerCode = '" + pCustomerCode + "' " +
        //                                               "AND ProjectCode = '" + pProjectCode + "' " +
        //                                               "AND JobID = " + LastJobID.ToString() + " ";
        //                                           }

        //                                           lCmd.Connection = lNDSCon;
        //                                           lCmd.CommandTimeout = 300;
        //                                           lRst = lCmd.ExecuteReader();
        //                                           if (lRst.HasRows)
        //                                           {
        //                                               if (lRst.Read())
        //                                               {
        //                                                   lJobAdv.SiteEngr_Name = lRst.GetString(0);
        //                                                   lJobAdv.SiteEngr_HP = lRst.GetString(1);
        //                                                   lJobAdv.SiteEngr_Tel = lRst.GetString(2);
        //                                                   lJobAdv.Scheduler_Name = lRst.GetString(3);
        //                                                   lJobAdv.Scheduler_HP = lRst.GetString(4);
        //                                                   lJobAdv.Scheduler_Tel = lRst.GetString(5);
        //                                                   lJobAdv.DeliveryAddress = lRst.GetString(6);
        //                                               }
        //                                           }
        //                                           else
        //                                           {
        //                                               lJobAdv.Scheduler_Name = lProj.Scheduler_Name;
        //                                               lJobAdv.Scheduler_HP = lProj.Scheduler_HP;
        //                                               lJobAdv.Scheduler_Tel = lProj.Scheduler_Tel;
        //                                               lJobAdv.SiteEngr_Name = lProj.SiteEngr_Name;
        //                                               lJobAdv.SiteEngr_HP = lProj.SiteEngr_HP;
        //                                               lJobAdv.SiteEngr_Tel = lProj.SiteEngr_Tel;
        //                                               lJobAdv.DeliveryAddress = "";
        //                                           }
        //                                           lRst.Close();
        //                                       }
        //                                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                                   }

        //                                   lCmd = null;
        //                                   lRst = null;
        //                                   lProcessObj = null;
        //                               }

        //                               lJobAdv.TransportLimit = "";
        //                               lJobAdv.TransportMode = "TR40/24";
        //                               lJobAdv.PONumber = "";
        //                               lJobAdv.UpdateDate = DateTime.Now;
        //                               lJobAdv.UpdateBy = User.Identity.GetUserName();

        //                               lJobAdv.CouplerType = "No Coupler";
        //                               //var lCoupler = getCouplerTypeFromESB(pCustomerCode, pProjectCode);
        //                               //var lCoupler = getCouplerTypeFromSAP(pCustomerCode, pProjectCode);
        //                               var lCoupler = getCouplerTypeFromOES(pCustomerCode, pProjectCode);
        //                               if (lCoupler != null)
        //                               {
        //                                   if (lCoupler.Count > 0 && lCoupler[0] != null && lCoupler[0] != "")
        //                                   {
        //                                       lJobAdv.CouplerType = lCoupler[0];
        //                                   }
        //                               }

        //                               var oldJobAdvice = db.JobAdvice.Find(lJobAdv.CustomerCode, lJobAdv.ProjectCode, lJobAdv.JobID);
        //                               if (oldJobAdvice == null)
        //                               {
        //                                   lJobAdv.OrderStatus = "New";
        //                                   lJobAdv.OrderSource = "UX";
        //                                   db.JobAdvice.Add(lJobAdv);
        //                               }
        //                               else
        //                               {
        //                                   db.Entry(oldJobAdvice).CurrentValues.SetValues(lJobAdv);
        //                               }

        //                               var lBBS = new BBSModels();
        //                               lBBS.UpdateDate = DateTime.Now;
        //                               lBBS.UpdateBy = User.Identity.GetUserName();
        //                               lBBS.CustomerCode = pCustomerCode;
        //                               lBBS.ProjectCode = pProjectCode;
        //                               lBBS.JobID = lJobAdv.JobID;
        //                               lBBS.BBSCancelledWT = 0;
        //                               lBBS.BBSCopiedFrom = "";
        //                               lBBS.BBSDesc = "";
        //                               lBBS.BBSID = 1;
        //                               lBBS.BBSNo = "";
        //                               lBBS.BBSNoNDS = "";
        //                               lBBS.BBSNoNDSCoupler = "";
        //                               lBBS.BBSOrderCABWT = 0;
        //                               lBBS.BBSOrderSTDWT = 0;
        //                               lBBS.BBSSAPSO = "";
        //                               lBBS.BBSSOR = "";
        //                               lBBS.BBSSORCoupler = "";
        //                               lBBS.BBSStrucElem = "";
        //                               lBBS.BBSTotalWT = 0;

        //                               var oldBBS = db.BBS.Find(pCustomerCode, pProjectCode, lJobAdv.JobID, 1);
        //                               if (oldBBS == null)
        //                               {
        //                                   db.BBS.Add(lBBS);
        //                               }

        //                               db.SaveChanges();
        //                           }
        //                       }
        //                   }
        //               }

        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               return -1;
        //           }
        //           return 0;
        //       }


        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getOrderListSearch(string CustomerCode, string ProjectCode, string RequiredDateFrom, string RequiredDateTo, string PONo, string BBSNo, string Block, string Storey, string Part)
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = new List<struOrderList>();

        //           if (RequiredDateFrom == null) RequiredDateFrom = "";
        //           if (RequiredDateFrom.Trim().Length == 0)
        //           {
        //               RequiredDateFrom = "2000-01-01";
        //           }
        //           if (RequiredDateTo == null) RequiredDateTo = "";
        //           if (RequiredDateTo.Trim().Length == 0)
        //           {
        //               RequiredDateTo = "2100-01-01";
        //           }
        //           if (PONo == null) PONo = "";
        //           if (BBSNo == null) BBSNo = "";
        //           if (Block == null) Block = "";
        //           if (Storey == null) Storey = "";
        //           if (Part == null) Part = "";
        //           PONo = PONo.Trim();
        //           BBSNo = BBSNo.Trim();
        //           Block = Block.Trim();
        //           Storey = Storey.Trim();
        //           Part = Part.Trim();
        //           //DateTime lRequiredDateFrom = DateTime.ParseExact(RequiredDateFrom, "yyyy-MM-dd",CultureInfo.InvariantCulture);
        //           //DateTime lRequiredDateTo = DateTime.ParseExact(RequiredDateTo, "yyyy-MM-dd", CultureInfo.InvariantCulture);

        //           //var content = new List<JobAdviceModels>();
        //           //var content = (from p in db.JobAdvice
        //           //           join s in db.PODoc
        //           //           on new { a = p.CustomerCode, b = p.ProjectCode, c = p.JobID } equals
        //           //           new { a = s.CustomerCode, b = s.ProjectCode, c = s.JobID } 
        //           //           where p.CustomerCode == "" &&
        //           //           p.ProjectCode == "" 
        //           //           select new
        //           //           {
        //           //               p.JobID,
        //           //               p.PONumber,
        //           //               p.RequiredDate,
        //           //               p.OrderStatus,
        //           //               s.FileName
        //           //           }
        //           //           ).ToList();

        //           //if (BBSNo == null || BBSNo == "" || BBSNo.Trim().Length == 0)
        //           //{
        //           //content = (from p in db.JobAdvice
        //           //           where p.CustomerCode == CustomerCode &&
        //           //           p.ProjectCode == ProjectCode &&
        //           //           p.RequiredDate >= lRequiredDateFrom &&
        //           //           p.RequiredDate <= lRequiredDateTo &&
        //           //           p.PONumber.Contains(PONo)
        //           //           orderby p.JobID descending
        //           //           select p).Take(50).ToList();

        //           //var content = (from p in db.JobAdvice
        //           //               join s in db.PODoc
        //           //               on new { a = p.CustomerCode, b = p.ProjectCode, c = p.JobID } equals
        //           //               new { a = s.CustomerCode, b = s.ProjectCode, c = s.JobID } into s1
        //           //               from d in s1.DefaultIfEmpty()
        //           //               where p.CustomerCode == CustomerCode &&
        //           //               p.ProjectCode == ProjectCode &&
        //           //               p.RequiredDate >= lRequiredDateFrom &&
        //           //               p.RequiredDate <= lRequiredDateTo &&
        //           //               (p.PONumber.Contains(PONo) ||
        //           //               PONo == "") &&
        //           //               (p.WBS1 == Block ||
        //           //               Block == "") &&
        //           //               (p.WBS2 == Storey ||
        //           //               Storey == "") &&
        //           //               (p.WBS3 == Part ||
        //           //               Part == "")
        //           //               orderby p.JobID descending
        //           //               select new
        //           //               {
        //           //                   p.JobID,
        //           //                   p.PONumber,
        //           //                   p.RequiredDate,
        //           //                   p.OrderStatus,
        //           //                   d.FileName
        //           //               }
        //           //               ).Take(50).ToList();

        //           //var content1 = new List<struOrderList>(content.Select(h => new struOrderList
        //           //{
        //           //    OrderNo = h.JobID.ToString(),
        //           //    OrderDesc = h.JobID.ToString() + " PO:" + h.PONumber.Trim()
        //           //    + " RD:" + h.RequiredDate.ToString("yyyy-MM-dd")
        //           //    + " Status:" + h.OrderStatus.Trim()
        //           //    + (h.FileName == null ? "" : " PO Attached")
        //           //}));



        //           //return Json(content1, JsonRequestBehavior.AllowGet);
        //           //}
        //           //else
        //           //{
        //           //    var contentBBS = (from p in db.JobAdvice
        //           //               join bbs in db.BBS on p.JobID equals bbs.JobID
        //           //               where p.CustomerCode == CustomerCode &&
        //           //               p.ProjectCode == ProjectCode &&
        //           //               bbs.CustomerCode == CustomerCode &&
        //           //               bbs.ProjectCode == ProjectCode &&
        //           //               p.RequiredDate >= lRequiredDateFrom &&
        //           //               p.RequiredDate <= lRequiredDateTo &&
        //           //               (p.PONumber.Contains(PONo) ||
        //           //               PONo == "") &&
        //           //               (p.WBS1 == Block ||
        //           //               Block == "") &&
        //           //               (p.WBS2 == Storey ||
        //           //               Storey == "") &&
        //           //               (p.WBS3 == Part ||
        //           //               Part == "") &&
        //           //               bbs.BBSNo.Contains(BBSNo)
        //           //               orderby p.JobID descending
        //           //               select p).Distinct().Take(50).ToList();

        //           //    var content = (from p in contentBBS
        //           //               join s in db.PODoc
        //           //               on new { a = p.CustomerCode, b = p.ProjectCode, c = p.JobID } equals
        //           //               new { a = s.CustomerCode, b = s.ProjectCode, c = s.JobID } into s1
        //           //               from d in s1.DefaultIfEmpty()
        //           //               where p.CustomerCode == CustomerCode &&
        //           //               p.ProjectCode == ProjectCode &&
        //           //               p.RequiredDate >= lRequiredDateFrom &&
        //           //               p.RequiredDate <= lRequiredDateTo &&
        //           //               (p.PONumber.Contains(PONo) ||
        //           //               PONo == "") &&
        //           //               (p.WBS1 == Block ||
        //           //               Block == "") &&
        //           //               (p.WBS2 == Storey ||
        //           //               Storey == "") &&
        //           //               (p.WBS3 == Part ||
        //           //               Part == "")
        //           //               orderby p.JobID descending
        //           //               select new
        //           //               {
        //           //                   p.JobID,
        //           //                   p.PONumber,
        //           //                   p.RequiredDate,
        //           //                   p.OrderStatus,
        //           //                   d.FileName
        //           //               }
        //           //               ).Take(50).ToList();

        //           //    var content1 = new List<struOrderList>(content.Select(h => new struOrderList
        //           //    {
        //           //        OrderNo = h.JobID.ToString(),
        //           //        OrderDesc = h.JobID.ToString() + " PO:" + h.PONumber.Trim()
        //           //        + " RD:" + h.RequiredDate.ToString("yyyy-MM-dd")
        //           //        + " Status:" + h.OrderStatus.Trim()
        //           //        + (h.FileName == null ? "" : " PO Attached")
        //           //    }));

        //           //    return Json(content1, JsonRequestBehavior.AllowGet);
        //           //}

        //           if (BBSNo == null || BBSNo == "" || BBSNo.Trim().Length == 0)
        //           {
        //               lCmd.CommandText = " SELECT p.JobID, " +
        //               "isNull(p.PONumber,''), " +
        //               "p.RequiredDate, " +
        //               "isNull(p.OrderStatus,''), " +
        //               "isNull((SELECT Max(s.FileName) " +
        //               "FROM dbo.OESPODoc s " +
        //               "WHERE s.CustomerCode = p.CustomerCode " +
        //               "AND s.ProjectCode = p.ProjectCode " +
        //               "AND s.JobID = p.JobID),'') " +
        //               "FROM dbo.OESJobAdvice p " +
        //               "WHERE p.CustomerCode = '" + CustomerCode + "' " +
        //               "AND p.ProjectCode = '" + ProjectCode + "' " +
        //               "AND p.RequiredDate >= '" + RequiredDateFrom + "' " +
        //               "AND p.RequiredDate <= '" + RequiredDateTo + "' " +
        //               "AND (p.PONumber like '%" + PONo + "%' " +
        //               "OR '" + PONo + "' = '') " +
        //               "AND (p.WBS1 = '" + Block + "' " +
        //               "OR '" + Block + "' = '' ) " +
        //               "AND (p.WBS2 = '" + Storey + "' " +
        //               "OR '" + Storey + "' = '') " +
        //               "AND (p.WBS3 = '" + Part + "' " +
        //               "OR '" + Part + "' = '') " +
        //               "ORDER BY p.JobID DESC ";
        //           }
        //           else
        //           {
        //               lCmd.CommandText = " SELECT p.JobID, " +
        //               "isNull(p.PONumber,''), " +
        //               "p.RequiredDate, " +
        //               "isNull(p.OrderStatus,''), " +
        //               "isNull((SELECT Max(s.FileName) " +
        //               "FROM dbo.OESPODoc s " +
        //               "WHERE s.CustomerCode = p.CustomerCode " +
        //               "AND s.ProjectCode = p.ProjectCode " +
        //               "AND s.JobID = p.JobID),'') " +
        //               "FROM dbo.OESJobAdvice p " +
        //               "WHERE p.CustomerCode = '" + CustomerCode + "' " +
        //               "AND p.ProjectCode = '" + ProjectCode + "' " +
        //               "AND p.RequiredDate >= '" + RequiredDateFrom + "' " +
        //               "AND p.RequiredDate <= '" + RequiredDateTo + "' " +
        //               "AND EXISTS (SELECT b.JobID " +
        //               "FROM dbo.OESBBS b " +
        //               "WHERE b.CustomerCode = p.CustomerCode " +
        //               "AND b.ProjectCode = p.ProjectCode " +
        //               "AND b.JobID = p.JobID " +
        //               "AND b.BBSNo like '%" + BBSNo + "%') " +
        //               "AND (p.PONumber like '%" + PONo + "%' " +
        //               "OR '" + PONo + "' = '') " +
        //               "AND (p.WBS1 = '" + Block + "' " +
        //               "OR '" + Block + "' = '' ) " +
        //               "AND (p.WBS2 = '" + Storey + "' " +
        //               "OR '" + Storey + "' = '') " +
        //               "AND (p.WBS3 = '" + Part + "' " +
        //               "OR '" + Part + "' = '') " +
        //               "ORDER BY p.JobID DESC ";
        //           }

        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       lReturn.Add(new struOrderList()
        //                       {
        //                           OrderNo = lRst.GetInt32(0).ToString(),
        //                           OrderDesc = lRst.GetInt32(0).ToString() + " PO:" + lRst.GetString(1).Trim()
        //                           + " RD:" + lRst.GetDateTime(2).ToString("yyyy-MM-dd")
        //                           + " Status:" + lRst.GetString(3).Trim()
        //                           + (lRst.GetString(4) == null || lRst.GetString(4).Trim() == "" ? "" : " PO Attached")
        //                       });
        //                   }
        //               }
        //               lRst.Close();

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }

        //           lProcessObj = null;
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;
        //           return Ok(lReturn);

        //       }

        //       //get Rebar details
        [HttpGet]
        [Route("/getSBDetails/{CustomerCode}/{ProjectCode}")]
        public ActionResult getSBDetails(string CustomerCode, string ProjectCode)
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lSQL = "";
            int lCustProd = 0;
            var lReturn = new List<ProdCodeModels>();

            var lProcessObj = new ProcessController();
            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                lSQL = "SELECT " +
                "BarType " +
                ",BarSize " +
                ",BarLength " +
                ",BundlePcs_fr " +
                ",BundlePcs " +
                ",BundleWT " +
                ",ProdCodeSAP " +
                "FROM dbo.OESProdCodeCustomer " +
                "WHERE CustomerCode = '" + CustomerCode + "' " +
                "AND ProjectCode = '" + ProjectCode + "' ";

                lCmd.Connection = lNDSCon;
                lCmd.CommandText = lSQL;
                lCmd.CommandTimeout = 1200;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        lReturn.Add(
                            new ProdCodeModels
                            {
                                BarType = lRst.GetString(0),
                                BarSize = lRst.GetInt16(1),
                                BarLength = lRst.GetInt32(2),
                                BundlePcs_fr = lRst.GetInt32(3),
                                BundlePcs = lRst.GetInt32(4),
                                BundleWT = lRst.GetInt32(5),
                                ProdCodeSAP = lRst.GetString(6)
                            });
                        lCustProd = lCustProd + 1;
                    }
                }
                lRst.Close();

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }

            if (lCustProd == 0)
            {
                lReturn = (from p in db.ProdCode
                           where p.BarSize != 6
                           orderby p.BarType, p.BarSize, p.BarLength
                           select p).ToList();
            }

            return Ok(lReturn);
        }

        //get addional parameter type bending limit
        [HttpGet]
        [Route("/getAddlParLimmit")]
        public ActionResult getAddlParLimmit()
        {
            var content = (from p in db.BBSAddnParLimit
                           orderby p.par_type, p.dia
                           select p).ToList();

            return Ok(content);
        }

        //get addional bending limit
        [HttpGet]
        [Route("/getAddlLimmit")]
        public ActionResult getAddlLimmit()
        {
            var content = (from p in db.BBSAddnLimit
                           orderby p.dia
                           select p).ToList();

            return Ok(content);
        }

        //get addional bending limit shape list
        [HttpGet]
        [Route("/getAddlLimmitShape")]
        public ActionResult getAddlLimmitShape()
        {
            var content = (from p in db.BBSAddnLimitShape
                           orderby p.shape_code, p.shape_paras
                           select p).ToList();

            return Ok(content);
        }

        //       //get order more info

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult CreateNewShape()
        //       {
        //           try
        //           {
        //               var lCustomerCode = Request.Form.Get("CustomerCode");
        //               var lProjectCode = Request.Form.Get("ProjectCode");
        //               int lJobID = 0;
        //               int.TryParse(Request.Form.Get("JobID"), out lJobID);
        //               var lShapeCode = Request.Form.Get("shapeCode");
        //               var lShapeCategory = Request.Form.Get("shapeCategory");
        //               var lShapeParameters = Request.Form.Get("shapeParameters");
        //               var lShapeLengthFormula = Request.Form.Get("shapeLengthFormula");

        //               if (Request.Files.Count > 0)
        //               {
        //                   HttpFileCollectionBase files = Request.Files;
        //                   for (int i = 0; i < files.Count; i++)
        //                   {
        //                       HttpPostedFileBase file = files[i];

        //                       byte[] imageBytes = null;
        //                       BinaryReader reader = new BinaryReader(file.InputStream);
        //                       imageBytes = reader.ReadBytes((int)file.ContentLength);

        //                       if (GetImageFormat(imageBytes) == false)
        //                       {
        //                           ModelState.AddModelError(string.Empty, "Invalid image file.");
        //                           return Json(new { success = false, responseText = "Error: Invalid image file (无效的图象文件)" }, JsonRequestBehavior.AllowGet);
        //                       }

        //                       var Content1 = db.CustomerShape.Find(lCustomerCode, lProjectCode, lShapeCode);
        //                       if (Content1 != null)
        //                       {
        //                           if (Content1.ShapeStatus == "Inactive")
        //                           {
        //                               return Json(new { success = false, responseText = "Error: Shape Code " + lShapeCode + " already be used and disabled as it is replaced by normal shape " + Content1.ReplacedBy + ". (图形码" + lShapeCode + "已使用并且被禁止因为它已被一般图形码" + Content1.ReplacedBy + "取代)" }, JsonRequestBehavior.AllowGet);
        //                           }
        //                           else
        //                           {
        //                               return Json(new { success = false, responseText = "Error: Shape Code " + lShapeCode + " already be used. (图形码" + lShapeCode + "已使用)" }, JsonRequestBehavior.AllowGet);
        //                           }
        //                       }
        //                       var Content = new CustomerShapeModels
        //                       {
        //                           CustomerCode = lCustomerCode,
        //                           ProjectCode = lProjectCode,
        //                           shapeCode = lShapeCode,
        //                           shapeCategory = lShapeCategory,
        //                           shapeParameters = lShapeParameters,
        //                           shapeLengthFormula = lShapeLengthFormula,
        //                           shapeImage = imageBytes,
        //                           shapeCreated = DateTime.Now,
        //                           CreatedBy = User.Identity.Name,
        //                           ShapeStatus = "Active"
        //                       };
        //                       db.CustomerShape.Add(Content);
        //                       db.SaveChanges();
        //                   }
        //               }
        //           }
        //           catch (Exception ex)
        //           {
        //               ModelState.AddModelError(string.Empty, "Error: " + ex.Message);
        //               return Json(new { success = false, responseText = "Error:" + ex.Message }, JsonRequestBehavior.AllowGet);
        //           }
        //           return Json(new { success = true }, JsonRequestBehavior.AllowGet);
        //       }

        //       public bool GetImageFormat(byte[] bytes)
        //       {
        //           // see http://www.mikekunz.com/image_file_header.html  
        //           var bmp = Encoding.ASCII.GetBytes("BM");     // BMP
        //           var gif = Encoding.ASCII.GetBytes("GIF");    // GIF
        //           var png = new byte[] { 137, 80, 78, 71 };    // PNG
        //           var tiff = new byte[] { 73, 73, 42 };         // TIFF
        //           var tiff2 = new byte[] { 77, 77, 42 };         // TIFF
        //           var jpeg = new byte[] { 255, 216, 255, 224 }; // jpeg
        //           var jpeg2 = new byte[] { 255, 216, 255, 225 }; // jpeg canon

        //           if (bmp.SequenceEqual(bytes.Take(bmp.Length)))
        //               //return ImageFormat.bm;
        //               return false;

        //           if (gif.SequenceEqual(bytes.Take(gif.Length)))
        //               //return ImageFormat.gif;
        //               return true;

        //           if (png.SequenceEqual(bytes.Take(png.Length)))
        //               //return ImageFormat.png;
        //               return true;

        //           if (tiff.SequenceEqual(bytes.Take(tiff.Length)))
        //               //return ImageFormat.tiff;
        //               return true;

        //           if (tiff2.SequenceEqual(bytes.Take(tiff2.Length)))
        //               //return ImageFormat.tiff;
        //               return true;

        //           if (jpeg.SequenceEqual(bytes.Take(jpeg.Length)))
        //               //return ImageFormat.jpeg;
        //               return true;

        //           if (jpeg2.SequenceEqual(bytes.Take(jpeg2.Length)))
        //               //return ImageFormat.jpeg;
        //               return true;

        //           return false;
        //           //            return ImageFormat.unknown;
        //       }

        //       // POST: OrderDetails/SaveJobAdvice
        //       // To protect from overposting attacks, please enable the specific properties you want to bind to, for 
        //       // more details see http://go.microsoft.com/fwlink/?LinkId=317598.
        [HttpPost]
        [Route("/SaveJobAdvice")]
        public ActionResult SaveJobAdvice([FromBody] JobAdviceModels jobAdviceModels)
        {
            var lErrorMsg = "";
            int? lJobID = 0;
            try
            {
                jobAdviceModels.UpdateDate = DateTime.Now;
                //jobAdviceModels.UpdateBy = User.Identity.GetUserName();
                if (jobAdviceModels.PODate == null || jobAdviceModels.PODate < DateTime.Now.AddDays(-30))
                {
                    jobAdviceModels.PODate = DateTime.Now;
                }

                if (jobAdviceModels.OrderSource == null || jobAdviceModels.OrderSource == "")
                {
                    jobAdviceModels.OrderSource = "UX";
                }

                if (jobAdviceModels.CustomerCode == null)
                {
                    jobAdviceModels.CustomerCode = "";
                }
                if (jobAdviceModels.CustomerCode.Length > 0)
                {
                    if (jobAdviceModels.JobID == 0)
                    {
                        lJobID = db.JobAdvice.Where(z => z.CustomerCode == jobAdviceModels.CustomerCode &&
                        z.ProjectCode == jobAdviceModels.ProjectCode).Max(z => (int?)z.JobID);
                        if (lJobID == null)
                        {
                            jobAdviceModels.JobID = 1;
                        }
                        else
                        {
                            jobAdviceModels.JobID = (int)lJobID + 1;
                        }
                    }
                    if (jobAdviceModels.RequiredDate == null)
                    {
                        jobAdviceModels.RequiredDate = DateTime.Now.AddDays(5);
                    }
                    if (jobAdviceModels.RequiredDate < DateTime.Now.AddDays(-365))
                    {
                        jobAdviceModels.RequiredDate = DateTime.Now.AddDays(5);
                    }
                    if (jobAdviceModels.TotalCABWeight == null)
                    {
                        jobAdviceModels.TotalCABWeight = 0;
                    }
                    if (jobAdviceModels.TotalSTDWeight == null)
                    {
                        jobAdviceModels.TotalSTDWeight = 0;
                    }
                    if (jobAdviceModels.TotalWeight == null)
                    {
                        jobAdviceModels.TotalWeight = 0;
                    }
                    if (jobAdviceModels.TransportLimit == null || jobAdviceModels.TransportLimit == "")
                    {
                        jobAdviceModels.TransportLimit = "Normal";
                    }
                    jobAdviceModels.OrderStatus = "Created";
                    if (jobAdviceModels.OrderSource == null || jobAdviceModels.OrderSource == "")
                    {
                        jobAdviceModels.OrderSource = "UX";
                    }

                    var oldJobAdvice = db.JobAdvice.Find(jobAdviceModels.CustomerCode, jobAdviceModels.ProjectCode, jobAdviceModels.JobID);
                    if (oldJobAdvice == null)
                    {
                        db.JobAdvice.Add(jobAdviceModels);
                        db.SaveChanges();
                    }
                    else
                    {
                        if (oldJobAdvice.OrderStatus == null || oldJobAdvice.OrderStatus == "New" || oldJobAdvice.OrderStatus == "Sent" || oldJobAdvice.OrderStatus == "Reserved" || oldJobAdvice.OrderStatus == "Created")
                        {
                            var lNewJobAdv = oldJobAdvice;

                            if (lNewJobAdv.OrderSource == null || lNewJobAdv.OrderSource == "" || lNewJobAdv.OrderSource == "WEB")
                            {
                                lNewJobAdv.OrderSource = "UX";
                            }
                            lNewJobAdv.CouplerType = jobAdviceModels.CouplerType;
                            lNewJobAdv.TotalCABWeight = jobAdviceModels.TotalCABWeight;
                            lNewJobAdv.TotalSTDWeight = jobAdviceModels.TotalSTDWeight;
                            lNewJobAdv.TotalWeight = jobAdviceModels.TotalWeight;
                            lNewJobAdv.TransportLimit = jobAdviceModels.TransportLimit;
                            lNewJobAdv.BBSStandard = jobAdviceModels.BBSStandard;

                            db.Entry(oldJobAdvice).CurrentValues.SetValues(lNewJobAdv);
                            db.SaveChanges();
                        }
                    }

                    return Ok(jobAdviceModels.JobID);
                }

            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
                return Ok(false);
            }
            return Ok(0);
        }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult checkDoubleEntry(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lErrorMsg = "";
        //           bool lReturn = true;
        //           try
        //           {
        //               var lUserName = User.Identity.GetUserName();
        //               UserAccessController lUa = new UserAccessController();
        //               var lUserType = lUa.getUserType(User.Identity.GetUserName());
        //               int lPMDOnly = 1;
        //               var lUserEnterType = "";

        //               var lJobAdv = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

        //               var lBBS = (from p in db.BBS
        //                           where p.CustomerCode == CustomerCode &&
        //                           p.ProjectCode == ProjectCode &&
        //                           p.JobID == JobID
        //                           orderby p.BBSID
        //                           select p).ToList();
        //               if (lBBS != null && lBBS.Count > 0)
        //               {
        //                   for (int j = 0; j < lBBS.Count; j++)
        //                   {
        //                       int BBSID = lBBS[j].BBSID;
        //                       var lUpdatedBy = (from p in db.OrderDetails
        //                                         where p.CustomerCode == CustomerCode &&
        //                                         p.ProjectCode == ProjectCode &&
        //                                         p.JobID == JobID &&
        //                                         p.BBSID == BBSID &&
        //                                         p.Cancelled == null &&
        //                                         ((p.BarShapeCode != null &&
        //                                         p.BarShapeCode != "") ||
        //                                         (p.BarSize != null &&
        //                                         p.BarSize > 0) ||
        //                                         (p.BarEachQty != null &&
        //                                         p.BarEachQty > 0) ||
        //                                         (p.BarMemberQty != null &&
        //                                         p.BarMemberQty > 0))
        //                                         select p.UpdateBy).Distinct().ToList();

        //                       if (lUpdatedBy.Count > 0)
        //                       {
        //                           for (int k = 0; k < lUpdatedBy.Count; k++)
        //                           {
        //                               lUserEnterType = lUa.getUserType(lUpdatedBy[k]);

        //                               if (lUserEnterType != "AD" && lUserEnterType != "PM"
        //                               && lUserEnterType != "PA" && lUserEnterType != "P1"
        //                               && lUserEnterType != "P2" && lUserEnterType != "PU"
        //                               && lUserEnterType != "CU" && lUserEnterType != "TE")
        //                               {
        //                                   lPMDOnly = 0;
        //                                   break;
        //                               }

        //                           }
        //                       }

        //                       if (lPMDOnly == 0)
        //                       {
        //                           break;
        //                       }
        //                   }

        //                   if (lUserName != null && lUserName.IndexOf("@") > 0
        //                   && lUserName.Split('@')[1].ToUpper() == "NATSTEEL.COM.SG"
        //                   && lJobAdv != null && lJobAdv.OrderSource != "UXE"
        //                   && lPMDOnly == 0)
        //                   {
        //                       for (int j = 0; j < lBBS.Count; j++)
        //                       {
        //                           int lBBSID = lBBS[j].BBSID;
        //                           var lOrderDetails = (from p in db.OrderDetails
        //                                                where p.CustomerCode == CustomerCode &&
        //                                                p.ProjectCode == ProjectCode &&
        //                                                p.JobID == JobID &&
        //                                                p.BBSID == lBBSID &&
        //                                                p.Cancelled == null &&
        //                                                ((p.BarShapeCode != null &&
        //                                                p.BarShapeCode != "") ||
        //                                                (p.BarType != null &&
        //                                                p.BarType != "") ||
        //                                                (p.BarSize != null &&
        //                                                p.BarSize > 0) ||
        //                                                (p.BarEachQty != null &&
        //                                                p.BarEachQty > 0) ||
        //                                                (p.BarMemberQty != null &&
        //                                                p.BarMemberQty > 0))
        //                                                orderby p.BarShapeCode, p.A, p.B, p.C, p.D, p.E, p.F, p.G, p.H, p.I, p.J, p.K, p.L, p.M, p.N, p.O, p.P, p.Q, p.R, p.S, p.T, p.U, p.V, p.W, p.X, p.Y, p.Z, p.BarLength, p.BarType, p.BarSize, p.BarMemberQty, p.BarEachQty, p.BarWeight
        //                                                select p).ToList();

        //                           var lOrderDetailsDBL = (from p in db.OrderDetailsDouble
        //                                                   where p.CustomerCode == CustomerCode &&
        //                                                   p.ProjectCode == ProjectCode &&
        //                                                   p.JobID == JobID &&
        //                                                   p.BBSID == lBBSID &&
        //                                                   p.Cancelled == null &&
        //                                                   ((p.BarShapeCode != null &&
        //                                                   p.BarShapeCode != "") ||
        //                                                   (p.BarType != null &&
        //                                                   p.BarType != "") ||
        //                                                   (p.BarSize != null &&
        //                                                   p.BarSize > 0) ||
        //                                                   (p.BarEachQty != null &&
        //                                                   p.BarEachQty > 0) ||
        //                                                   (p.BarMemberQty != null &&
        //                                                   p.BarMemberQty > 0))
        //                                                   orderby p.BarShapeCode, p.A, p.B, p.C, p.D, p.E, p.F, p.G, p.H, p.I, p.J, p.K, p.L, p.M, p.N, p.O, p.P, p.Q, p.R, p.S, p.T, p.U, p.V, p.W, p.X, p.Y, p.Z, p.BarLength, p.BarType, p.BarSize, p.BarMemberQty, p.BarEachQty, p.BarWeight
        //                                                   select p).ToList();

        //                           if (lOrderDetails.Count > 0 && lOrderDetailsDBL.Count > 0 && lOrderDetails.Count == lOrderDetailsDBL.Count)
        //                           {
        //                               var lReport = new Reports();
        //                               // check if the double capture empty 
        //                               int lFound = 0;

        //                               for (int i = 0; i < lOrderDetailsDBL.Count; i++)
        //                               {
        //                                   if ((lOrderDetailsDBL[i].BarEachQty != null && lOrderDetailsDBL[i].BarEachQty > 0) ||
        //                                       (lOrderDetailsDBL[i].BarMemberQty != null && lOrderDetailsDBL[i].BarMemberQty > 0) ||
        //                                       (lOrderDetailsDBL[i].BarShapeCode != null && lOrderDetailsDBL[i].BarShapeCode != "") ||
        //                                       (lOrderDetailsDBL[i].BarType != null && lOrderDetailsDBL[i].BarType != "") ||
        //                                       (lOrderDetailsDBL[i].BarSize != null && lOrderDetailsDBL[i].BarSize > 0))
        //                                   {
        //                                       lFound = 1;
        //                                       break;
        //                                   }

        //                               }

        //                               var lPara = new System.Collections.Generic.List<string>();
        //                               lPara.Add("A");
        //                               lPara.Add("B");
        //                               lPara.Add("C");
        //                               lPara.Add("D");
        //                               for (int i = 0; i < lOrderDetails.Count; i++)
        //                               {
        //                                   AddParamaters("E", lOrderDetails[i].E, ref lPara);
        //                                   AddParamaters("F", lOrderDetails[i].F, ref lPara);
        //                                   AddParamaters("G", lOrderDetails[i].G, ref lPara);
        //                                   AddParamaters("H", lOrderDetails[i].H, ref lPara);
        //                                   AddParamaters("I", lOrderDetails[i].I, ref lPara);
        //                                   AddParamaters("J", lOrderDetails[i].J, ref lPara);
        //                                   AddParamaters("K", lOrderDetails[i].K, ref lPara);
        //                                   AddParamaters("L", lOrderDetails[i].L, ref lPara);
        //                                   AddParamaters("M", lOrderDetails[i].M, ref lPara);
        //                                   AddParamaters("N", lOrderDetails[i].N, ref lPara);
        //                                   AddParamaters("O", lOrderDetails[i].O, ref lPara);
        //                                   AddParamaters("P", lOrderDetails[i].P, ref lPara);
        //                                   AddParamaters("Q", lOrderDetails[i].Q, ref lPara);
        //                                   AddParamaters("R", lOrderDetails[i].R, ref lPara);
        //                                   AddParamaters("S", lOrderDetails[i].S, ref lPara);
        //                                   AddParamaters("T", lOrderDetails[i].T, ref lPara);
        //                                   AddParamaters("U", lOrderDetails[i].U, ref lPara);
        //                                   AddParamaters("V", lOrderDetails[i].V, ref lPara);
        //                                   AddParamaters("W", lOrderDetails[i].W, ref lPara);
        //                                   AddParamaters("X", lOrderDetails[i].X, ref lPara);
        //                                   AddParamaters("Y", lOrderDetails[i].Y, ref lPara);
        //                                   AddParamaters("Z", lOrderDetails[i].Z, ref lPara);
        //                               }
        //                               lPara.Sort();

        //                               var lParaDBL = new System.Collections.Generic.List<string>();
        //                               lParaDBL.Add("A");
        //                               lParaDBL.Add("B");
        //                               lParaDBL.Add("C");
        //                               lParaDBL.Add("D");
        //                               for (int i = 0; i < lOrderDetailsDBL.Count; i++)
        //                               {
        //                                   AddParamaters("E", lOrderDetailsDBL[i].E, ref lParaDBL);
        //                                   AddParamaters("F", lOrderDetailsDBL[i].F, ref lParaDBL);
        //                                   AddParamaters("G", lOrderDetailsDBL[i].G, ref lParaDBL);
        //                                   AddParamaters("H", lOrderDetailsDBL[i].H, ref lParaDBL);
        //                                   AddParamaters("I", lOrderDetailsDBL[i].I, ref lParaDBL);
        //                                   AddParamaters("J", lOrderDetailsDBL[i].J, ref lParaDBL);
        //                                   AddParamaters("K", lOrderDetailsDBL[i].K, ref lParaDBL);
        //                                   AddParamaters("L", lOrderDetailsDBL[i].L, ref lParaDBL);
        //                                   AddParamaters("M", lOrderDetailsDBL[i].M, ref lParaDBL);
        //                                   AddParamaters("N", lOrderDetailsDBL[i].N, ref lParaDBL);
        //                                   AddParamaters("O", lOrderDetailsDBL[i].O, ref lParaDBL);
        //                                   AddParamaters("P", lOrderDetailsDBL[i].P, ref lParaDBL);
        //                                   AddParamaters("Q", lOrderDetailsDBL[i].Q, ref lParaDBL);
        //                                   AddParamaters("R", lOrderDetailsDBL[i].R, ref lParaDBL);
        //                                   AddParamaters("S", lOrderDetailsDBL[i].S, ref lParaDBL);
        //                                   AddParamaters("T", lOrderDetailsDBL[i].T, ref lParaDBL);
        //                                   AddParamaters("U", lOrderDetailsDBL[i].U, ref lParaDBL);
        //                                   AddParamaters("V", lOrderDetailsDBL[i].V, ref lParaDBL);
        //                                   AddParamaters("W", lOrderDetailsDBL[i].W, ref lParaDBL);
        //                                   AddParamaters("X", lOrderDetailsDBL[i].X, ref lParaDBL);
        //                                   AddParamaters("Y", lOrderDetailsDBL[i].Y, ref lParaDBL);
        //                                   AddParamaters("Z", lOrderDetailsDBL[i].Z, ref lParaDBL);
        //                               }
        //                               lParaDBL.Sort();

        //                               for (int i = 0; i < lOrderDetails.Count; i++)
        //                               {
        //                                   lFound = lReport.checkDiscrepancy(lPara, lOrderDetails[i], lParaDBL, lOrderDetailsDBL[i]);
        //                                   if (lFound > 0)
        //                                   {
        //                                       lReturn = false;
        //                                       break;
        //                                   }
        //                               }
        //                               lReport = null;
        //                           }
        //                           else if (lOrderDetails.Count > 0 && lOrderDetailsDBL.Count > 0 && lOrderDetails.Count != lOrderDetailsDBL.Count)
        //                           {
        //                               lReturn = false;
        //                               lErrorMsg = "Found double capture discrepancy. Please correct the error before Submission. \n\n" +
        //                                   "(发现双重输入的数据差异, 请更正此错误再提交此订单.)";
        //                               break;
        //                           }
        //                           else if ((lOrderDetails.Count > 0 && lOrderDetailsDBL.Count == 0) || (lOrderDetails.Count == 0 && lOrderDetailsDBL.Count > 0))
        //                           {
        //                               lReturn = false;
        //                               lErrorMsg = "Double capture is compulsory for natSteel users. Please complete the double capture validation. \n\n" +
        //                                   "(对大众钢铁的用户,双重输入验证是强制的, 请完成双重输入验证再提交此订单.)";
        //                               break;
        //                           }

        //                           if (lReturn == false)
        //                           {
        //                               break;
        //                           }
        //                       }
        //                   }
        //               }
        //               lUa = null;
        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               return Json(new { success = lReturn, error = true, message = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //           }
        //           return Json(new { success = lReturn, error = false, message = "" }, JsonRequestBehavior.AllowGet);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult UpdateSUM(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lErrorMsg = "";
        //           int? lJobID = 0;
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = 0;
        //           string lSQL = "";

        //           try
        //           {
        //               //update Master
        //               var lProjSE = (from p in db.OrderProjectSE
        //                              join m in db.OrderProject
        //                              on p.OrderNumber equals m.OrderNumber
        //                              where p.CABJobID == JobID &&
        //                               m.CustomerCode == CustomerCode &&
        //                               m.ProjectCode == ProjectCode
        //                              select p).ToList();
        //               if (lProjSE != null && lProjSE.Count > 0)
        //               {
        //                   int lOrderNo = lProjSE[0].OrderNumber;
        //                   string lStrEle = lProjSE[0].StructureElement;
        //                   string lProd = lProjSE[0].ProductType;
        //                   string lScheduled = lProjSE[0].ScheduledProd;
        //                   string lStatus = lProjSE[0].OrderStatus;

        //                   if (lScheduled == null || lScheduled == "")
        //                   {
        //                       lScheduled = "N";
        //                   }

        //                   if (lStatus == "" || lStatus == "New" || lStatus == "Created" || lStatus == "Created*")
        //                   {
        //                       decimal lBBSTTWT = 0;
        //                       decimal lBBSCABWT = 0;
        //                       decimal lBBSSTDWT = 0;
        //                       int lBBSTTPCs = 0;
        //                       int lBBSID = 0;

        //                       decimal lTTWT = 0;
        //                       decimal lCABWT = 0;
        //                       decimal lSTDWT = 0;
        //                       int lTTPCs = 0;

        //                       var lProcessObj = new ProcessController();
        //                       if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                       {
        //                           lSQL = "SELECT BBSID, " +
        //                           "0.000 as TotalWT, " +
        //                           "(SELECT isNULL(SUM(BarWeight), 0) " +
        //                           "FROM dbo.OESOrderDetails " +
        //                           "WHERE CustomerCode = A.CustomerCode " +
        //                           "AND ProjectCode = A.ProjectCode " +
        //                           "AND JobID = A.JobID " +
        //                           "AND BBSID = A.BBSID " +
        //                           "AND BarCAB = 1 " +
        //                           "AND BarShapeCode > '' " +
        //                           "AND Cancelled is null " +
        //                           "AND BarTotalQty > 0) as TotalCABWT, " +
        //                           "(SELECT isNULL(SUM(BarWeight), 0) " +
        //                           "FROM dbo.OESOrderDetails " +
        //                           "WHERE CustomerCode = A.CustomerCode " +
        //                           "AND ProjectCode = A.ProjectCode " +
        //                           "AND JobID = A.JobID " +
        //                           "AND BBSID = A.BBSID " +
        //                           "AND BarSTD = 1 " +
        //                           "AND BarShapeCode > '' " +
        //                           "AND Cancelled is null " +
        //                           "AND BarTotalQty > 0) as TotalSTDWT, " +
        //                           "(SELECT isNULL(SUM(BarTotalQty), 0) " +
        //                           "FROM dbo.OESOrderDetails " +
        //                           "WHERE CustomerCode = A.CustomerCode " +
        //                           "AND ProjectCode = A.ProjectCode " +
        //                           "AND JobID = A.JobID " +
        //                           "AND BBSID = A.BBSID " +
        //                           "AND BarShapeCode > '' " +
        //                           "AND Cancelled is null " +
        //                           "AND BarTotalQty > 0) as TotalPCs " +
        //                           "FROM dbo.OESOrderDetails A " +
        //                           "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                           "AND ProjectCode = '" + ProjectCode + "' " +
        //                           "and JobID = " + JobID.ToString() + " " +
        //                           "AND NOT EXISTS (SELECT BBSID FROM dbo.OESBBS " +
        //                           "WHERE CustomerCode = A.CustomerCode " +
        //                           "AND ProjectCode = A.ProjectCode " +
        //                           "AND JobID = A.JobID " +
        //                           "AND BBSID = A.BBSID " +
        //                           "AND BBSNo LIKE '%Cancelled%' ) " +
        //                           "group by CustomerCode, ProjectCode, JobID, BBSID ";

        //                           lCmd.CommandText = lSQL;
        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandTimeout = 300;
        //                           lRst = lCmd.ExecuteReader();
        //                           if (lRst.HasRows)
        //                           {
        //                               while (lRst.Read())
        //                               {
        //                                   lBBSID = lRst.GetValue(0) == DBNull.Value ? 0 : lRst.GetInt32(0);
        //                                   lBBSTTWT = lRst.GetValue(1) == DBNull.Value ? 0 : lRst.GetDecimal(1);
        //                                   lBBSCABWT = lRst.GetValue(2) == DBNull.Value ? 0 : lRst.GetDecimal(2);
        //                                   lBBSSTDWT = lRst.GetValue(3) == DBNull.Value ? 0 : lRst.GetDecimal(3);
        //                                   lBBSTTPCs = lRst.GetValue(4) == DBNull.Value ? 0 : lRst.GetInt32(4);

        //                                   lBBSTTWT = lBBSCABWT + lBBSSTDWT;

        //                                   var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
        //                                   var lNewBBS = oldBBS;

        //                                   lNewBBS.BBSTotalWT = (decimal)(lBBSTTWT);
        //                                   lNewBBS.BBSOrderCABWT = (decimal)(lBBSCABWT);
        //                                   lNewBBS.BBSOrderSTDWT = (decimal)(lBBSSTDWT);

        //                                   db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);

        //                                   lTTWT = lTTWT + lBBSTTWT;
        //                                   lCABWT = lCABWT + lBBSCABWT;
        //                                   lSTDWT = lSTDWT + lBBSSTDWT;
        //                                   lTTPCs = lTTPCs + lBBSTTPCs;
        //                               }
        //                           }
        //                           lRst.Close();

        //                           lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                       }

        //                       var oldJobAdvice = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

        //                       var lNewJobAdv = oldJobAdvice;

        //                       lNewJobAdv.TotalCABWeight = (decimal)(lCABWT);
        //                       lNewJobAdv.TotalSTDWeight = (decimal)(lSTDWT);
        //                       lNewJobAdv.TotalWeight = (decimal)(lTTWT);

        //                       db.Entry(oldJobAdvice).CurrentValues.SetValues(lNewJobAdv);

        //                       var lOldSE = db.OrderProjectSE.Find(lOrderNo, lStrEle, lProd, lScheduled);
        //                       if (lOldSE != null)
        //                       {
        //                           var lNewSE = lOldSE;

        //                           lNewSE.TotalWeight = (decimal)(lTTWT);
        //                           lNewSE.TotalPCs = (int)(lTTPCs);

        //                           db.Entry(lOldSE).CurrentValues.SetValues(lNewSE);
        //                       }

        //                       db.SaveChanges();

        //                       decimal lWT = (decimal)(from p in db.OrderProjectSE
        //                                               where p.OrderNumber == lOrderNo &&
        //                                               p.OrderStatus != "Cancelled"
        //                                               select p.TotalWeight)
        //                                  .DefaultIfEmpty(0)
        //                                  .Sum();


        //                       var lOldOrder = db.OrderProject.Find(lOrderNo);

        //                       if (lOldOrder != null)
        //                       {
        //                           var lNewOrder = lOldOrder;

        //                           lNewOrder.TotalWeight = lWT;
        //                           db.Entry(lOldOrder).CurrentValues.SetValues(lNewOrder);
        //                           db.SaveChanges();
        //                       }
        //                   }
        //               }
        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               lReturn = -1;
        //           }
        //           return Json(lReturn);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult OrderWithdraw(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lErrorMsg = "";
        //           try
        //           {
        //               if (CustomerCode == null)
        //               {
        //                   CustomerCode = "";
        //               }
        //               if (CustomerCode.Length > 0)
        //               {
        //                   var oldJobAdvice = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //                   if (oldJobAdvice != null)
        //                   {
        //                       if (oldJobAdvice.OrderStatus.Trim() == "Submitted")
        //                       {
        //                           var newJobAdvice = oldJobAdvice;
        //                           newJobAdvice.OrderStatus = "New";
        //                           newJobAdvice.UpdateDate = DateTime.Now;
        //                           newJobAdvice.UpdateBy = User.Identity.GetUserName();

        //                           db.Entry(oldJobAdvice).CurrentValues.SetValues(newJobAdvice);

        //                           var lBBSOld = (from p in db.BBS
        //                                          where p.CustomerCode == CustomerCode &&
        //                                          p.ProjectCode == ProjectCode &&
        //                                          p.JobID == JobID &&
        //                                          p.UpdateBy != User.Identity.Name
        //                                          select p).ToList();

        //                           if (lBBSOld != null && lBBSOld.Count > 0)
        //                           {
        //                               for (int i = 0; i < lBBSOld.Count; i++)
        //                               {
        //                                   var lNewBBS = lBBSOld[i];
        //                                   lNewBBS.UpdateBy = User.Identity.GetUserName();

        //                                   db.Entry(lBBSOld[i]).CurrentValues.SetValues(lNewBBS);

        //                               }
        //                           }

        //                           var lDetOld = (from p in db.OrderDetails
        //                                          where p.CustomerCode == CustomerCode &&
        //                                          p.ProjectCode == ProjectCode &&
        //                                          p.JobID == JobID &&
        //                                          p.UpdateBy != User.Identity.Name
        //                                          select p).ToList();

        //                           if (lDetOld != null && lDetOld.Count > 0)
        //                           {
        //                               for (int i = 0; i < lDetOld.Count; i++)
        //                               {
        //                                   var lNewDet = lDetOld[i];
        //                                   lNewDet.UpdateBy = User.Identity.GetUserName();

        //                                   db.Entry(lDetOld[i]).CurrentValues.SetValues(lNewDet);

        //                               }
        //                           }

        //                           db.SaveChanges();

        //                           var lEmailContent = "";
        //                           var lEmailFrom = "";
        //                           var lEmailTo = "";
        //                           var lEmailCc = "";
        //                           var lEmailSubject = "";
        //                           string lVar1 = "";

        //                           var JobContent = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //                           if (JobContent != null)
        //                           {
        //                               if (JobContent.CustomerCode == null) JobContent.CustomerCode = "";
        //                               else JobContent.CustomerCode = JobContent.CustomerCode.Trim();

        //                               if (JobContent.OrderStatus == null) JobContent.OrderStatus = "";
        //                               else JobContent.OrderStatus = JobContent.OrderStatus.Trim();

        //                               if (JobContent.PONumber == null) JobContent.PONumber = "";
        //                               else JobContent.PONumber = JobContent.PONumber.Trim();

        //                               if (JobContent.ProjectCode == null) JobContent.ProjectCode = "";
        //                               else JobContent.ProjectCode = JobContent.ProjectCode.Trim();

        //                               if (JobContent.ProjectStage == null) JobContent.ProjectStage = "";
        //                               else JobContent.ProjectStage = JobContent.ProjectStage.Trim();

        //                               if (JobContent.DeliveryAddress == null) JobContent.DeliveryAddress = "";
        //                               else JobContent.DeliveryAddress = JobContent.DeliveryAddress.Trim();

        //                               if (JobContent.Remarks == null) JobContent.Remarks = "";
        //                               else JobContent.Remarks = JobContent.Remarks.Trim();

        //                               if (JobContent.Scheduler_HP == null) JobContent.Scheduler_HP = "";
        //                               else JobContent.Scheduler_HP = JobContent.Scheduler_HP.Trim();

        //                               if (JobContent.Scheduler_Name == null) JobContent.Scheduler_Name = "";
        //                               else JobContent.Scheduler_Name = JobContent.Scheduler_Name.Trim();

        //                               if (JobContent.Scheduler_Tel == null) JobContent.Scheduler_Tel = "";
        //                               else JobContent.Scheduler_Tel = JobContent.Scheduler_Tel.Trim();

        //                               if (JobContent.SiteEngr_HP == null) JobContent.SiteEngr_HP = "";
        //                               else JobContent.SiteEngr_HP = JobContent.SiteEngr_HP.Trim();

        //                               if (JobContent.SiteEngr_Name == null) JobContent.SiteEngr_Name = "";
        //                               else JobContent.SiteEngr_Name = JobContent.SiteEngr_Name.Trim();

        //                               if (JobContent.SiteEngr_Tel == null) JobContent.SiteEngr_Tel = "";
        //                               else JobContent.SiteEngr_Tel = JobContent.SiteEngr_Tel.Trim();

        //                               if (JobContent.TransportLimit == null) JobContent.TransportLimit = "";
        //                               else JobContent.TransportLimit = JobContent.TransportLimit.Trim();

        //                               if (JobContent.TransportMode == null) JobContent.TransportMode = "";
        //                               else JobContent.TransportMode = JobContent.TransportMode.Trim();

        //                               if (JobContent.WBS1 == null) JobContent.WBS1 = "";
        //                               else JobContent.WBS1 = JobContent.WBS1.Trim();

        //                               if (JobContent.WBS2 == null) JobContent.WBS2 = "";
        //                               else JobContent.WBS2 = JobContent.WBS2.Trim();

        //                               if (JobContent.WBS3 == null) JobContent.WBS3 = "";
        //                               else JobContent.WBS3 = JobContent.WBS3.Trim();
        //                           }

        //                           lEmailContent = "<p align='center'>CANCEL JOB ADVICE (撤消工作通知 / 加工铁与标准直铁料表)</p>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //                           lEmailContent = lEmailContent + "<td width=20%>" + "Customer (客户名称)" + "</td>";

        //                           CustomerModels lCustomer = db.Customer.Find(JobContent.CustomerCode);
        //                           string lVar = "";
        //                           if (lCustomer != null) lVar = lCustomer.CustomerName.Trim() + " (" + JobContent.CustomerCode.Trim() + ")";
        //                           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr>";

        //                           lEmailContent = lEmailContent + "<tr><td>" + "Project (工程项目)" + "</td>";

        //                           var lProject = (from p in db.ProjectList
        //                                           where p.ProjectCode == ProjectCode
        //                                           select p).First();
        //                           lVar = "";
        //                           if (lProject != null) lVar = lProject.ProjectTitle.Trim() + " (" + JobContent.ProjectCode.Trim() + ")";
        //                           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //                           lEmailContent = lEmailContent + "<td width=20%>" + "PO No.\n(订单号码)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=27%>" + JobContent.PONumber.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=26%>" + "Order Date\n(订单日期)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + String.Format("{0:yyyy-MM-dd}", JobContent.PODate) + "</td></tr>";

        //                           lEmailContent = lEmailContent + "</tr><td width=20%>" + "Required Date\n(交货日期)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=27%>" + String.Format("{0:yyyy-MM-dd}", JobContent.RequiredDate) + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=26%>" + "Order Weight\n(订单重量)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + ((decimal)JobContent.TotalWeight).ToString("F3") + " KG" + "</td></tr>";

        //                           lEmailContent = lEmailContent + "</tr><td width=20%>" + "CAB Bars Weight\n(加工铁重量)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=27%>" + ((decimal)JobContent.TotalCABWeight).ToString("F3") + " KG" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=26%>" + "SB Weight\n(标准直铁重量)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + ((decimal)JobContent.TotalSTDWeight).ToString("F3") + " KG" + "</td></tr>";

        //                           lEmailContent = lEmailContent + "</tr><td width=20%>" + "Transport Limit\n(运输限制)" + "</td>";

        //                           lEmailContent = lEmailContent + "<td width=27%>" + JobContent.TransportLimit + "</td>";

        //                           lEmailContent = lEmailContent + "<td width=26%>" + "Transport Mode\n(运输工具)" + "</td>";

        //                           //get transport mode
        //                           lVar = "";
        //                           var lProcessObj = new ProcessController();
        //                           var lCmd = new SqlCommand();
        //                           SqlDataReader lRst;
        //                           var lNDSCon = new SqlConnection();

        //                           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                           {

        //                               lCmd.CommandText = "select vchTransportDescription " +
        //                               "from dbo.TransportMaster " +
        //                               "where vchTransportMode = '" + JobContent.TransportMode + "' ";

        //                               lCmd.Connection = lNDSCon;
        //                               lCmd.CommandTimeout = 300;
        //                               lRst = lCmd.ExecuteReader();
        //                               if (lRst.HasRows)
        //                               {
        //                                   if (lRst.Read())
        //                                   {
        //                                       lVar = lRst.GetString(0).Trim();
        //                                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                                   }
        //                               }
        //                               lRst.Close();
        //                           }
        //                           lCmd = null;
        //                           lNDSCon = null;
        //                           lRst = null;

        //                           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //                           lEmailContent = lEmailContent + "<td width='20%'>" + "Block (WBS1)\n(座号/大牌)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=15%>" + JobContent.WBS1.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='17%'>" + "Storey (WBS2)\n(楼层)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=14%>" + JobContent.WBS2.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width=16%>" + "Part (WBS3)\n(分部)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + JobContent.WBS3.Trim() + "</td></tr></table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //                           lEmailContent = lEmailContent + "<td width=20%>" + "Customer (客户名称)" + "</td>";

        //                           lVar = "&nbsp;";
        //                           if (JobContent.DeliveryAddress != null) lVar = JobContent.DeliveryAddress.Trim();
        //                           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr>";

        //                           lEmailContent = lEmailContent + "<tr><td>" + "Remarks (备注)" + "</td>";

        //                           lVar = "&nbsp;";
        //                           if (JobContent.Remarks != null) lVar = JobContent.Remarks.Trim();
        //                           lEmailContent = lEmailContent + "<td>" + lVar + "</td></tr></table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";
        //                           lEmailContent = lEmailContent + "<td width='20%'>" + "BBS No.\n(钢筋加工表)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='15%'>" + "BBS Description\n(具体描述)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='17%'>" + "Structure Element\n(构件)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='14%'>" + "CAB Weight\n(加工铁重量)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='16%'>" + "SB Weight\n(标准直铁重量)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + "Total Weight\n(总重量)" + "</td></tr>";


        //                           var lBBSContent = (from p in db.BBS
        //                                              where p.CustomerCode == CustomerCode &&
        //                                              p.ProjectCode == ProjectCode &&
        //                                              p.JobID == JobID &&
        //                                              p.BBSOrderCABWT + p.BBSOrderSTDWT > 0
        //                                              orderby p.BBSID
        //                                              select p).ToList();

        //                           if (lBBSContent.Count > 0)
        //                           {
        //                               for (int i = 0; i < lBBSContent.Count; i++)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td><font color='blue'>" + lBBSContent[i].BBSNo + "</font></td>";
        //                                   lEmailContent = lEmailContent + "<td>" + lBBSContent[i].BBSDesc + "</td>";
        //                                   lEmailContent = lEmailContent + "<td>" + lBBSContent[i].BBSStrucElem + "</td>";
        //                                   if (lBBSContent[i].BBSOrderCABWT == 0) lVar = ""; else lVar = lBBSContent[i].BBSOrderCABWT.ToString("F3");
        //                                   lEmailContent = lEmailContent + "<td align='left'>" + lVar + "</td>";
        //                                   if (lBBSContent[i].BBSOrderSTDWT == 0) lVar = ""; else lVar = lBBSContent[i].BBSOrderSTDWT.ToString("F3");
        //                                   lEmailContent = lEmailContent + "<td align='left'>" + lVar + "</td>";
        //                                   lEmailContent = lEmailContent + "<td align='left'>" + (lBBSContent[i].BBSOrderCABWT + lBBSContent[i].BBSOrderSTDWT).ToString("F3") + "</td></tr>";
        //                               }
        //                           }
        //                           lEmailContent = lEmailContent + "</table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //                           lEmailContent = lEmailContent + "<td colspan='6'>" + "Site Contact (工地联系人)" + "</td></tr>";

        //                           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Goods Receiver\n(收货人)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='15%'>" + JobContent.SiteEngr_Name.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='13%'>" + "H / P\n(手机号码)" + " </td>";
        //                           lEmailContent = lEmailContent + "<td width='16%'>" + JobContent.SiteEngr_HP.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='13%'>" + "Email\n(电邮地址)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + JobContent.SiteEngr_Tel.Trim() + "</td></tr>";

        //                           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Site Contact\n(联系人)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='15%'>" + JobContent.Scheduler_Name.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='13%'>" + "H / P\n(手机号码)" + " </td>";
        //                           lEmailContent = lEmailContent + "<td width='16%'>" + JobContent.Scheduler_HP.Trim() + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='13%'>" + "Email\n(电邮地址)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td>" + JobContent.Scheduler_Tel.Trim() + "</td></tr></table>";

        //                           lEmailContent = lEmailContent + "<table border='1' width=100%><tr>";

        //                           lEmailContent = lEmailContent + "<td colspan='3'>" + "NatSteel Contacts (大众钢铁联系人) (Fax:62619133)" + "</td></tr>";

        //                           lEmailContent = lEmailContent + "<tr><td width='20%'>" + "Name (姓名)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='15%'>" + "Contact Numbers (联系电话)" + "</td>";
        //                           lEmailContent = lEmailContent + "<td width='13%'>" + "Email Address (电邮地址)" + " </td></tr>";


        //                           var lProjContent = db.Project.Find(CustomerCode, ProjectCode);

        //                           if (lProjContent.Contact1 != null)
        //                           {
        //                               if (lProjContent.Contact1.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact1.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel1 != null) if (lProjContent.Tel1.Trim().Length > 0) lVar1 = lProjContent.Tel1.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email1 != null) if (lProjContent.Email1.Trim().Length > 0) lVar1 = lProjContent.Email1.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }

        //                           if (lProjContent.Contact2 != null)
        //                           {
        //                               if (lProjContent.Contact2.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact2.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel2 != null) if (lProjContent.Tel2.Trim().Length > 0) lVar1 = lProjContent.Tel2.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email2 != null) if (lProjContent.Email2.Trim().Length > 0) lVar1 = lProjContent.Email2.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }

        //                           if (lProjContent.Contact3 != null)
        //                           {
        //                               if (lProjContent.Contact3.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact3.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel3 != null) if (lProjContent.Tel3.Trim().Length > 0) lVar1 = lProjContent.Tel3.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email3 != null) if (lProjContent.Email3.Trim().Length > 0) lVar1 = lProjContent.Email3.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }

        //                           if (lProjContent.Contact4 != null)
        //                           {
        //                               if (lProjContent.Contact4.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact4.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel4 != null) if (lProjContent.Tel4.Trim().Length > 0) lVar1 = lProjContent.Tel4.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email4 != null) if (lProjContent.Email4.Trim().Length > 0) lVar1 = lProjContent.Email4.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }

        //                           if (lProjContent.Contact5 != null)
        //                           {
        //                               if (lProjContent.Contact5.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact5.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel5 != null) if (lProjContent.Tel5.Trim().Length > 0) lVar1 = lProjContent.Tel5.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email5 != null) if (lProjContent.Email5.Trim().Length > 0) lVar1 = lProjContent.Email5.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }

        //                           if (lProjContent.Contact6 != null)
        //                           {
        //                               if (lProjContent.Contact6.Trim().Length > 0)
        //                               {
        //                                   lEmailContent = lEmailContent + "<tr><td>" + lProjContent.Contact6.Trim() + "</td>";
        //                                   lVar1 = "";
        //                                   if (lProjContent.Tel6 != null) if (lProjContent.Tel6.Trim().Length > 0) lVar1 = lProjContent.Tel6.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + "</td>";

        //                                   lVar1 = "";
        //                                   if (lProjContent.Email6 != null) if (lProjContent.Email6.Trim().Length > 0) lVar1 = lProjContent.Email6.Trim();
        //                                   lEmailContent = lEmailContent + "<td>" + lVar1 + " </td></tr>";
        //                                   if (lVar1 != "") if (lEmailTo == "") lEmailTo = lVar1; else lEmailTo = lEmailTo + ";" + lVar1;
        //                               }
        //                           }
        //                           lEmailContent = lEmailContent + "</table>";

        //                           lVar1 = JobContent.Scheduler_Tel.Trim();
        //                           if (lVar1 != "")
        //                           {
        //                               if (lEmailCc == "") { lEmailCc = lVar1; }
        //                               else { lEmailCc = lEmailCc + ";" + lVar1; }
        //                           }

        //                           lVar1 = JobContent.SiteEngr_Tel.Trim();
        //                           if (lVar1 != "" && lEmailCc.IndexOf(lVar1) < 0)
        //                           {
        //                               if (lEmailCc == "") { lEmailCc = lVar1; }
        //                               else { lEmailCc = lEmailCc + ";" + lVar1; }
        //                           }

        //                           if (lProjContent.EmailDistribution != null)
        //                           {
        //                               lVar1 = lProjContent.EmailDistribution.Trim();
        //                               if (lVar1 != "" && lEmailCc.IndexOf(lVar1) < 0)
        //                               {
        //                                   if (lEmailCc == "") { lEmailCc = lVar1; }
        //                                   else { lEmailCc = lEmailCc + ";" + lVar1; }
        //                               }
        //                           }

        //                           if (JobContent.UpdateBy != null)
        //                           {
        //                               lVar1 = JobContent.UpdateBy.Trim();
        //                               if (lVar1 != "" && lEmailCc.IndexOf(lVar1) < 0)
        //                               {
        //                                   if (lEmailCc == "") { lEmailCc = lVar1; }
        //                                   else { lEmailCc = lEmailCc + ";" + lVar1; }
        //                               }
        //                           }

        //                           lVar = "";
        //                           if (lCustomer != null) lVar = lCustomer.CustomerName.Trim();

        //                           lEmailSubject = lVar + " - " + JobContent.PONumber.Trim() + " - CAB/SB No. " + JobID.ToString();

        //                           var lOESEmail = new SendGridEmail();

        //                           string lEmailFromAddress = "eprompt@natsteel.com.sg";
        //                           string lEmailFromName = "Digital Ordering Email Services";

        //                           //dynamic response = lOESEmail.Execute(lEmailFromAddress, lEmailFromName, lEmailTo, lEmailCc, lEmailSubject, "text/html", lEmailContent);
        //                           lOESEmail.Execute(lEmailFromAddress, lEmailFromName, lEmailTo, lEmailCc, lEmailSubject, "text/html", lEmailContent).Wait();
        //                           lOESEmail = null;

        //                           return Json(true);
        //                       }
        //                   }
        //               }
        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               return Json(false);
        //           }
        //           return Json(false);
        //       }

        //       //List of Used BBS No
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult ExportPONoToExcel(string CustomerCode, string ProjectCode)
        //       {
        //           decimal lCABDelTotal = 0;
        //           decimal lSBDelTotal = 0;
        //           decimal lMESHDelTotal = 0;
        //           decimal lCAGEDelTotal = 0;
        //           decimal lCABOrderTotal = 0;
        //           decimal lSBOrderTotal = 0;
        //           decimal lMESHOrderTotal = 0;
        //           decimal lCAGEOrderTotal = 0;

        //           var lCompanyName = db.Customer.Find(CustomerCode).CustomerName;
        //           var lProjectTitle = db.Project.Find(CustomerCode, ProjectCode).ProjectTitle;

        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = new List<POSumModels>();
        //           if (CustomerCode != null && ProjectCode != null)
        //           {
        //               if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT B.PONo, " +
        //                   "B.WBS1, " +
        //                   "B.WBS2, " +
        //                   "B.WBS3, " +
        //                   "B.PODate, " +
        //                   "B.RequiredDate, " +
        //                   "B.DeliveryDate, " +
        //                   "SUM(B.CABOrderWT), " +
        //                   "SUM(B.CABDeliveryWT), " +
        //                   "SUM(B.SBOrderWT), " +
        //                   "SUM(B.SBDeliveryWT), " +
        //                   "SUM(B.MESHOrderWT), " +
        //                   "SUM(B.MESHDeliveryWT), " +
        //                   "SUM(B.CAGEOrderWT), " +
        //                   "SUM(B.CAGEDeliveryWT), " +
        //                   "A.OrderStatus, " +
        //                   "A.Remarks, " +
        //                   "MIN(B.SSNNo) " +
        //                   "FROM dbo.OESBBSSum B left outer join dbo.OESJobAdvice A " +
        //                   "ON B.CustomerCode = A.CustomerCode " +
        //                   "AND B.ProjectCode = A.ProjectCode " +
        //                   "AND B.JobID = A.JobID " +
        //                   "WHERE B.CustomerCode = '" + CustomerCode + "' " +
        //                   "AND B.ProjectCode = '" + ProjectCode + "' " +
        //                   "GROUP BY " +
        //                   "B.PONo, " +
        //                   "B.WBS1, " +
        //                   "B.WBS2, " +
        //                   "B.WBS3, " +
        //                   "B.PODate, " +
        //                   "B.RequiredDate, " +
        //                   "B.DeliveryDate, " +
        //                   "A.OrderStatus, " +
        //                   "A.Remarks " +
        //                   "ORDER BY 18 ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           var lSNo = 0;
        //                           while (lRst.Read())
        //                           {
        //                               lSNo = lSNo + 1;
        //                               var lStatus = (lRst.GetValue(15) == DBNull.Value ? "" : lRst.GetString(15));
        //                               if (lRst.GetValue(6) != DBNull.Value)
        //                               {
        //                                   lStatus = "Delivered";
        //                               }
        //                               lReturn.Add(new POSumModels()
        //                               {
        //                                   SSNNo = lSNo,
        //                                   PONo = lRst.GetString(0),
        //                                   WBS1 = lRst.GetString(1),
        //                                   WBS2 = lRst.GetString(2),
        //                                   WBS3 = lRst.GetString(3),
        //                                   PODate = (lRst.GetValue(4) == DBNull.Value ? "" : lRst.GetDateTime(4).ToString("yyyy-MM-dd")),
        //                                   RequiredDate = (lRst.GetValue(5) == DBNull.Value ? "" : lRst.GetDateTime(5).ToString("yyyy-MM-dd")),
        //                                   DeliveryDate = (lRst.GetValue(6) == DBNull.Value ? "" : lRst.GetDateTime(6).ToString("yyyy-MM-dd")),
        //                                   CABOrderWT = lRst.GetDecimal(7),
        //                                   CABDelWT = lRst.GetDecimal(8),
        //                                   SBOrderWT = lRst.GetDecimal(9),
        //                                   SBDelWT = lRst.GetDecimal(10),
        //                                   MESHOrderWT = lRst.GetDecimal(11),
        //                                   MESHDelWT = lRst.GetDecimal(12),
        //                                   CAGEOrderWT = lRst.GetDecimal(13),
        //                                   CAGEDelWT = lRst.GetDecimal(14),
        //                                   POStatus = lStatus,
        //                                   PORemarks = (lRst.GetValue(16) == DBNull.Value ? "" : lRst.GetString(16).Trim())
        //                               });

        //                               lCABOrderTotal = lCABOrderTotal + lRst.GetDecimal(7);
        //                               lCABDelTotal = lCABDelTotal + lRst.GetDecimal(8);
        //                               lSBOrderTotal = lSBOrderTotal + lRst.GetDecimal(9);
        //                               lSBDelTotal = lSBDelTotal + lRst.GetDecimal(10);
        //                               lMESHOrderTotal = lMESHOrderTotal + lRst.GetDecimal(11);
        //                               lMESHDelTotal = lMESHDelTotal + lRst.GetDecimal(12);
        //                               lCAGEOrderTotal = lCAGEOrderTotal + lRst.GetDecimal(13);
        //                               lCAGEDelTotal = lCAGEDelTotal + lRst.GetDecimal(14);
        //                           }
        //                       }
        //                       lRst.Close();

        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           ExcelPackage package = new ExcelPackage();
        //           ExcelWorksheet ws = package.Workbook.Worksheets.Add("CAB");

        //           ExcelSheetGenerationPO("CAB",
        //               ref ws,
        //               ref lReturn,
        //               lCABDelTotal,
        //               lSBDelTotal,
        //               lMESHDelTotal,
        //               lCAGEDelTotal,
        //               lCABOrderTotal,
        //               lSBOrderTotal,
        //               lMESHOrderTotal,
        //               lCAGEOrderTotal,
        //               lCompanyName,
        //               lProjectTitle);

        //           if (lSBOrderTotal > 0 || lSBDelTotal > 0)
        //           {
        //               ExcelWorksheet wsSB = package.Workbook.Worksheets.Add("SB");

        //               ExcelSheetGenerationPO("SB",
        //                   ref wsSB,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           if (lMESHOrderTotal > 0 || lMESHDelTotal > 0)
        //           {
        //               ExcelWorksheet wsMESH = package.Workbook.Worksheets.Add("MESH");

        //               ExcelSheetGenerationPO("MESH",
        //                   ref wsMESH,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           if (lCAGEOrderTotal > 0 || lCAGEDelTotal > 0)
        //           {
        //               ExcelWorksheet wsCAGE = package.Workbook.Worksheets.Add("CAGE");

        //               ExcelSheetGenerationPO("CAGE",
        //                   ref wsCAGE,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           MemoryStream ms = new MemoryStream();
        //           package.SaveAs(ms);

        //           var bExcel = new byte[ms.Length];
        //           ms.Position = 0;
        //           ms.Read(bExcel, 0, bExcel.Length);

        //           //bPDF = ms.GetBuffer();
        //           ms.Flush();
        //           ms.Dispose();

        //           return Json(bExcel, JsonRequestBehavior.AllowGet);
        //       }

        //       private void ExcelSheetGenerationPO(string ProdType,
        //           ref ExcelWorksheet ws,
        //           ref List<POSumModels> lReturn,
        //           decimal lCABDelTotal,
        //           decimal lSBDelTotal,
        //           decimal lMESHDelTotal,
        //           decimal lCAGEDelTotal,
        //           decimal lCABOrderTotal,
        //           decimal lSBOrderTotal,
        //           decimal lMESHOrderTotal,
        //           decimal lCAGEOrderTotal,
        //           string lCompanyName,
        //           string lProjectTitle
        //       )
        //       {
        //           int lColNo = 0;
        //           int lRowNo = 0;
        //           ws.Column(1).Width = 5;         //"SNo\n序号";
        //           ws.Column(2).Width = 12;        //"PO No\n加工表号";
        //           ws.Column(3).Width = 15;       //"Status\nStatus"
        //           ws.Column(4).Width = 10;        //"WBS1\n楼座";
        //           ws.Column(5).Width = 10;        //"WBS2\n楼座";
        //           ws.Column(6).Width = 7;         //"WBS3\n楼座";
        //           ws.Column(7).Width = 11;        //"PO Date\n订货日期";
        //           ws.Column(8).Width = 15;        //"Required Date\n到场日期";
        //           ws.Column(9).Width = 15;       //"Date Delivered\n实际到场日期"

        //           lColNo = 10;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Column(lColNo).Width = 16;       //"CAB PO WT\n加工铁料单重量";
        //               ws.Column(lColNo + 1).Width = 16;       //"CAB Delivery WT\n加工铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "SB")
        //           {
        //               ws.Column(lColNo).Width = 16;       //"SB Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 16;       //"SB Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "MESH")
        //           {
        //               ws.Column(lColNo).Width = 15;       //"MESH Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 15;       //"MESH Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "CAGE")
        //           {
        //               ws.Column(lColNo).Width = 15;       //"CAGE Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 15;       //"CAGE Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           ws.Column(lColNo).Width = 20;       //"Remarks\n备注"

        //           string lColLetter = Convert.ToChar(64 + lColNo).ToString(); // A Ascii -- 65

        //           ws.Cells["A1:" + lColLetter + "1"].Merge = true;
        //           ws.Cells[1, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
        //           ws.Cells[1, 1].Style.Font.Bold = true;
        //           ws.Cells[1, 1].Style.Font.Size = 12;
        //           ws.Cells[1, 1].Style.WrapText = true;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Cells[1, 1].Value = "PO List for Cut and Bend Bars\n加工铁订单列表";
        //           }
        //           else if (ProdType == "SB")
        //           {
        //               ws.Cells[1, 1].Value = "PO List for Standard Length Bars\n标准直铁订单列表";
        //           }
        //           else if (ProdType == "MESH")
        //           {
        //               ws.Cells[1, 1].Value = "PO List for MESH\n铁网订单列表";
        //           }
        //           else if (ProdType == "CAGE")
        //           {
        //               ws.Cells[1, 1].Value = "PO List for Cages\n铁笼铁订单列表";
        //           }



        //           ws.Row(1).Height = 30;

        //           ws.Cells["A2:C2"].Merge = true;
        //           ws.Cells[2, 1].Value = "Company Name (公司名称):";
        //           ws.Cells[2, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //           ws.Cells[2, 1].Style.Font.Bold = true;
        //           ws.Cells["D2:" + lColLetter + "2"].Merge = true;
        //           ws.Cells[2, 4].Value = lCompanyName;
        //           ws.Cells[2, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
        //           ws.Cells[2, 4].Style.Font.Bold = true;

        //           ws.Cells["A3:C3"].Merge = true;
        //           ws.Cells[3, 1].Value = "Project Title (工程项目名称):";
        //           ws.Cells[3, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //           ws.Cells[3, 1].Style.Font.Bold = true;

        //           ws.Cells["D3:" + lColLetter + "3"].Merge = true;
        //           ws.Cells[3, 4].Value = lProjectTitle;
        //           ws.Cells[3, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
        //           ws.Cells[3, 4].Style.Font.Bold = true;

        //           lRowNo = 4;

        //           if (ProdType == "CAB" && (lCABOrderTotal > 0 || lCABDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Cut & Bend Total (加工铁汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCABDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;

        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "SB") && (lSBOrderTotal > 0 || lSBDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Standard Length Bars Total (标准直铁汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lSBDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "MESH") && (lMESHOrderTotal > 0 || lMESHDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "MESH Total (铁网汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lMESHDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "CAGE") && (lCAGEOrderTotal > 0 || lCAGEDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Cage Total (铁笼汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCAGEDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if (lRowNo > 5)
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Grand Total (总计):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCABDelTotal + lSBDelTotal + lMESHDelTotal + lCAGEDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           ws.Cells["F4" + ":" + lColLetter + (lRowNo - 1).ToString()].Merge = true;

        //           ExcelRange lrg = ws.Cells["A1:" + lColLetter + (lRowNo - 1).ToString()];
        //           lrg.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Top.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Left.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Right.Style = ExcelBorderStyle.Thin;

        //           ExcelRange lrg4 = ws.Cells["A" + lRowNo.ToString() + ":" + lColLetter + lRowNo.ToString() + ""];
        //           lrg4.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Top.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Left.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Right.Style = ExcelBorderStyle.Thin;

        //           lrg4.Style.Fill.PatternType = ExcelFillStyle.Solid;
        //           lrg4.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

        //           lrg4.Style.WrapText = true;

        //           ws.Cells[lRowNo, 1].Value = "SNo\n序号";
        //           ws.Cells[lRowNo, 2].Value = "PO No\n订单号码";
        //           ws.Cells[lRowNo, 3].Value = "PO Status\n订单状态";
        //           ws.Cells[lRowNo, 4].Value = "WBS1\n楼座";
        //           ws.Cells[lRowNo, 5].Value = "WBS2\n楼层";
        //           ws.Cells[lRowNo, 6].Value = "WBS3\n分部";
        //           ws.Cells[lRowNo, 7].Value = "PO Date\n订货日期";
        //           ws.Cells[lRowNo, 8].Value = "Required Date\n到场日期";
        //           ws.Cells[lRowNo, 9].Value = "Date Delivered\n实际到场日期";

        //           lColNo = 10;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "CAB PO Weight\n加工铁料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "CAB Delivery Weight\n加工铁来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "SB")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "Standard Bars PO Weight\n标直铁料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "Standard Bars Delivery Weight\n标直铁来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "MESH")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "MESH PO Weight\n铁网料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "MESH Delivery Weight\n铁网来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "CAGE")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "Cage PO Weight\n铁笼料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "Cage Delivery Weight\n铁笼来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           ws.Cells[lRowNo, lColNo].Value = "Remarks\n备注";

        //           lRowNo = lRowNo + 1;

        //           if (lReturn.Count > 0)
        //           {
        //               var j = 0;
        //               for (int i = 0; i < lReturn.Count; i++)
        //               {
        //                   if ((ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       || (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       || (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       || (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       )
        //                   {
        //                       ws.Cells[j + lRowNo, 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 2].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 4].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 5].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 6].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 7].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 8].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 9].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       lColNo = 10;
        //                       if (ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }
        //                       ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, lColNo].Style.WrapText = true;

        //                       ws.Cells[j + lRowNo, 1].Value = j + 1;
        //                       ws.Cells[j + lRowNo, 2].Value = lReturn[i].PONo; //"PO No\n加工表号";
        //                       ws.Cells[j + lRowNo, 3].Value = lReturn[i].POStatus;
        //                       ws.Cells[j + lRowNo, 4].Value = lReturn[i].WBS1; //"WBS1\n楼座";
        //                       ws.Cells[j + lRowNo, 5].Value = lReturn[i].WBS2; //"WBS2\n楼层";
        //                       ws.Cells[j + lRowNo, 6].Value = lReturn[i].WBS3; //"WBS3\n分部";
        //                       ws.Cells[j + lRowNo, 7].Value = lReturn[i].PODate; //"PO Date\n订货日期";
        //                       ws.Cells[j + lRowNo, 8].Value = lReturn[i].RequiredDate; //"Required Date\n到场日期";
        //                       ws.Cells[j + lRowNo, 9].Value = lReturn[i].DeliveryDate; //"Date Delivered\n实际到场日期";
        //                       lColNo = 10;
        //                       if (ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].CABOrderWT; //"CAB PO WT\n加工铁料单重量";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].CABDelWT; //"CAB Delivery WT\n加工铁来货重量";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].SBOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].SBDelWT;
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].MESHOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].MESHDelWT;
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].CAGEOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].CAGEDelWT;
        //                           lColNo = lColNo + 2;
        //                       }
        //                       ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].PORemarks; //"Remarks\n备注";
        //                       j = j + 1;
        //                   }
        //               }
        //           }


        //       }


        //       //List of raised PO
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult usedPONoList(string CustomerCode, string ProjectCode)
        //       {
        //           BBSSumProcess(CustomerCode, ProjectCode);

        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = (new[]{ new
        //           {
        //               SSNNo = 0,
        //               PONo = "",
        //               POStatus = "",
        //               WBS1 = "",
        //               WBS2 = "",
        //               WBS3 = "",
        //               PODate = "",
        //               RequiredDate = "",
        //               DeliveryDate = "",
        //               CABOrderWT = "",
        //               CABDelWT = "",
        //               SBOrderWT = "",
        //               SBDelWT = "",
        //               MESHOrderWT = "",
        //               MESHDelWT = "",
        //               CAGEOrderWT = "",
        //               CAGEDelWT = "",
        //               PORemarks = "",
        //           }}).ToList();
        //           if (CustomerCode != null && ProjectCode != null)
        //           {
        //               if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT B.PONo, " +
        //                   "B.WBS1, " +
        //                   "B.WBS2, " +
        //                   "B.WBS3, " +
        //                   "B.PODate, " +
        //                   "B.RequiredDate, " +
        //                   "B.DeliveryDate, " +
        //                   "SUM(B.CABOrderWT), " +
        //                   "SUM(B.CABDeliveryWT), " +
        //                   "SUM(B.SBOrderWT), " +
        //                   "SUM(B.SBDeliveryWT), " +
        //                   "SUM(B.MESHOrderWT), " +
        //                   "SUM(B.MESHDeliveryWT), " +
        //                   "SUM(B.CAGEOrderWT), " +
        //                   "SUM(B.CAGEDeliveryWT), " +
        //                   "A.OrderStatus, " +
        //                   "A.Remarks, " +
        //                   "MIN(B.SSNNo) " +
        //                   "FROM dbo.OESBBSSum B left outer join dbo.OESJobAdvice A " +
        //                   "ON B.CustomerCode = A.CustomerCode " +
        //                   "AND B.ProjectCode = A.ProjectCode " +
        //                   "AND B.JobID = A.JobID " +
        //                   "WHERE B.CustomerCode = '" + CustomerCode + "' " +
        //                   "AND B.ProjectCode = '" + ProjectCode + "' " +
        //                   "GROUP BY " +
        //                   "B.PONo, " +
        //                   "B.WBS1, " +
        //                   "B.WBS2, " +
        //                   "B.WBS3, " +
        //                   "B.PODate, " +
        //                   "B.RequiredDate, " +
        //                   "B.DeliveryDate, " +
        //                   "A.OrderStatus, " +
        //                   "A.Remarks " +
        //                   "ORDER BY B.DeliveryDate DESC, B.PONo ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           var lSNo = 0;
        //                           while (lRst.Read())
        //                           {
        //                               lSNo = lSNo + 1;
        //                               var lStatus = (lRst.GetValue(15) == DBNull.Value ? "" : lRst.GetString(15));
        //                               if (lRst.GetValue(6) != DBNull.Value)
        //                               {
        //                                   lStatus = "Delivered";
        //                               }
        //                               lReturn.Add(new
        //                               {
        //                                   SSNNo = lSNo,
        //                                   PONo = lRst.GetString(0),
        //                                   POStatus = lStatus,
        //                                   WBS1 = lRst.GetString(1),
        //                                   WBS2 = lRst.GetString(2),
        //                                   WBS3 = lRst.GetString(3),
        //                                   PODate = (lRst.GetValue(4) == DBNull.Value ? "" : lRst.GetDateTime(4).ToString("yyyy-MM-dd")),
        //                                   RequiredDate = (lRst.GetValue(5) == DBNull.Value ? "" : lRst.GetDateTime(5).ToString("yyyy-MM-dd")),
        //                                   DeliveryDate = (lRst.GetValue(6) == DBNull.Value ? "" : lRst.GetDateTime(6).ToString("yyyy-MM-dd")),
        //                                   CABOrderWT = lRst.GetDecimal(7).ToString("###,###,###.000;(###,###.000); "),
        //                                   CABDelWT = lRst.GetDecimal(8).ToString("###,###,###.000;(###,###.000); "),
        //                                   SBOrderWT = lRst.GetDecimal(9).ToString("###,###,###.000;(###,###.000); "),
        //                                   SBDelWT = lRst.GetDecimal(10).ToString("###,###,###.000;(###,###.000); "),
        //                                   MESHOrderWT = lRst.GetDecimal(11).ToString("###,###,###.000;(###,###.000); "),
        //                                   MESHDelWT = lRst.GetDecimal(12).ToString("###,###,###.000;(###,###.000); "),
        //                                   CAGEOrderWT = lRst.GetDecimal(14).ToString("###,###,###.000;(###,###.000); "),
        //                                   CAGEDelWT = lRst.GetDecimal(14).ToString("###,###,###.000;(###,###.000); "),
        //                                   PORemarks = (lRst.GetValue(16) == DBNull.Value ? "" : lRst.GetString(16).Trim())
        //                               });
        //                           }
        //                       }
        //                       lRst.Close();

        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           return Ok(lReturn);
        //       }

        //       //Check duplicated BBS No
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult SaveBBSSum(string CustomerCode, string ProjectCode, string PONo, string BBSNo, string Remarks)
        //       {
        //           var lCmd = new SqlCommand();
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = "";
        //           if (BBSNo != null && ProjectCode != null)
        //           {
        //               if (BBSNo.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   var lRemarks = Remarks.Replace("'", "''");
        //                   lCmd.CommandText =
        //                       "UPDATE dbo.OESBBSSum " +
        //                       "SET Remarks = '" + lRemarks + "' " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND PONo = '" + PONo + "' " +
        //                       "AND BBSNo = '" + BBSNo + "' ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lCmd.ExecuteNonQuery();
        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;

        //           return Ok(lReturn);
        //       }


        //       //List of Used BBS No
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult ExportBBSNoToExcel(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           decimal lCABDelTotal = 0;
        //           decimal lSBDelTotal = 0;
        //           decimal lMESHDelTotal = 0;
        //           decimal lCAGEDelTotal = 0;
        //           decimal lCABOrderTotal = 0;
        //           decimal lSBOrderTotal = 0;
        //           decimal lMESHOrderTotal = 0;
        //           decimal lCAGEOrderTotal = 0;
        //           int lColNo = 0;
        //           int lRowNo = 0;

        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           var lCompanyName = db.Customer.Find(CustomerCode).CustomerName;
        //           var lProjectTitle = db.Project.Find(CustomerCode, ProjectCode).ProjectTitle;
        //           var lProjectCodeMESH = db.Project.Find(CustomerCode, ProjectCode).ProjectCodeMESH;
        //           var lProjectCodeCage = db.Project.Find(CustomerCode, ProjectCode).ProjectCodeCage;

        //           if (lProjectCodeMESH == null) lProjectCodeMESH = "";
        //           if (lProjectCodeCage == null) lProjectCodeCage = "";
        //           lProjectCodeMESH = lProjectCodeMESH.Trim();
        //           lProjectCodeCage = lProjectCodeCage.Trim();

        //           var lReturn = new List<BBSSumModels>();
        //           if (CustomerCode != null && ProjectCode != null)
        //           {
        //               if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   lCmd.CommandText =
        //                       "SELECT * FROM dbo.OESBBSSum " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "order by SSNNo ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           while (lRst.Read())
        //                           {
        //                               lReturn.Add(new BBSSumModels()
        //                               {
        //                                   SSNNo = lRst.GetInt32(2),
        //                                   PONo = lRst.GetString(5),
        //                                   BBSNo = lRst.GetString(6),
        //                                   BBSDesc = lRst.GetString(7),
        //                                   WBS1 = lRst.GetString(8),
        //                                   WBS2 = lRst.GetString(9),
        //                                   WBS3 = lRst.GetString(10),
        //                                   StrucEle = lRst.GetString(11),
        //                                   PODate = (lRst.GetValue(12) == DBNull.Value ? "" : lRst.GetDateTime(12).ToString("yyyy-MM-dd")),
        //                                   RequiredDate = (lRst.GetValue(13) == DBNull.Value ? "" : lRst.GetDateTime(13).ToString("yyyy-MM-dd")),
        //                                   DeliveryDate = (lRst.GetValue(14) == DBNull.Value ? "" : lRst.GetDateTime(14).ToString("yyyy-MM-dd")),
        //                                   CABOrderWT = lRst.GetDecimal(15),
        //                                   CABDelWT = lRst.GetDecimal(16),
        //                                   SBOrderWT = lRst.GetDecimal(17),
        //                                   SBDelWT = lRst.GetDecimal(18),
        //                                   MESHOrderWT = lRst.GetDecimal(19),
        //                                   MESHDelWT = lRst.GetDecimal(20),
        //                                   CAGEOrderWT = lRst.GetDecimal(21),
        //                                   CAGEDelWT = lRst.GetDecimal(22),
        //                                   Remarks = lRst.GetString(24)
        //                               });
        //                               lCABOrderTotal = lCABOrderTotal + lRst.GetDecimal(15);
        //                               lCABDelTotal = lCABDelTotal + lRst.GetDecimal(16);
        //                               lSBOrderTotal = lSBOrderTotal + lRst.GetDecimal(17);
        //                               lSBDelTotal = lSBDelTotal + lRst.GetDecimal(18);
        //                               lMESHOrderTotal = lMESHOrderTotal + lRst.GetDecimal(19);
        //                               lMESHDelTotal = lMESHDelTotal + lRst.GetDecimal(20);
        //                               lCAGEOrderTotal = lCAGEOrderTotal + lRst.GetDecimal(21);
        //                               lCAGEDelTotal = lCAGEDelTotal + lRst.GetDecimal(22);
        //                           }
        //                       }
        //                       lRst.Close();

        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           ExcelPackage package = new ExcelPackage();
        //           ExcelWorksheet ws = package.Workbook.Worksheets.Add("CAB");

        //           ExcelSheetGeneration("CAB",
        //               ref ws,
        //               ref lReturn,
        //               lCABDelTotal,
        //               lSBDelTotal,
        //               lMESHDelTotal,
        //               lCAGEDelTotal,
        //               lCABOrderTotal,
        //               lSBOrderTotal,
        //               lMESHOrderTotal,
        //               lCAGEOrderTotal,
        //               lCompanyName,
        //               lProjectTitle);

        //           if (lSBOrderTotal > 0 || lSBDelTotal > 0)
        //           {
        //               ExcelWorksheet wsSB = package.Workbook.Worksheets.Add("SB");

        //               ExcelSheetGeneration("SB",
        //                   ref wsSB,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           if (lMESHOrderTotal > 0 || lMESHDelTotal > 0)
        //           {
        //               ExcelWorksheet wsMESH = package.Workbook.Worksheets.Add("MESH");

        //               ExcelSheetGeneration("MESH",
        //                   ref wsMESH,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           if (lCAGEOrderTotal > 0 || lCAGEDelTotal > 0)
        //           {
        //               ExcelWorksheet wsCAGE = package.Workbook.Worksheets.Add("CAGE");

        //               ExcelSheetGeneration("CAGE",
        //                   ref wsCAGE,
        //                   ref lReturn,
        //                   lCABDelTotal,
        //                   lSBDelTotal,
        //                   lMESHDelTotal,
        //                   lCAGEDelTotal,
        //                   lCABOrderTotal,
        //                   lSBOrderTotal,
        //                   lMESHOrderTotal,
        //                   lCAGEOrderTotal,
        //                   lCompanyName,
        //                   lProjectTitle);
        //           }

        //           MemoryStream ms = new MemoryStream();
        //           package.SaveAs(ms);

        //           var bExcel = new byte[ms.Length];
        //           ms.Position = 0;
        //           ms.Read(bExcel, 0, bExcel.Length);

        //           //bPDF = ms.GetBuffer();
        //           ms.Flush();
        //           ms.Dispose();

        //           return Json(bExcel, JsonRequestBehavior.AllowGet);
        //       }

        //       private void ExcelSheetGeneration(string ProdType,
        //           ref ExcelWorksheet ws,
        //           ref List<BBSSumModels> lReturn,
        //           decimal lCABDelTotal,
        //           decimal lSBDelTotal,
        //           decimal lMESHDelTotal,
        //           decimal lCAGEDelTotal,
        //           decimal lCABOrderTotal,
        //           decimal lSBOrderTotal,
        //           decimal lMESHOrderTotal,
        //           decimal lCAGEOrderTotal,
        //           string lCompanyName,
        //           string lProjectTitle
        //       )
        //       {
        //           int lColNo = 0;
        //           int lRowNo = 0;
        //           ws.Column(1).Width = 5;         //"SNo\n序号";
        //           ws.Column(2).Width = 15;        //"BBS No\n加工表号";
        //           ws.Column(3).Width = 37;        // "BBS Description\n施工部位";
        //           ws.Column(4).Width = 8;        //"WBS1\n楼座";
        //           ws.Column(5).Width = 8;        //"WBS2\n楼座";
        //           ws.Column(6).Width = 7;         //"WBS3\n楼座";
        //           ws.Column(7).Width = 10;        //"Structure Element\n构件"
        //           ws.Column(8).Width = 11;        //"PO Date\n订货日期";
        //           ws.Column(9).Width = 11;        //"Required Date\n到场日期";
        //           ws.Column(10).Width = 15;       //"Date Delivered\n实际到场日期"
        //           lColNo = 11;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Column(lColNo).Width = 16;       //"CAB PO WT\n加工铁料单重量";
        //               ws.Column(lColNo + 1).Width = 16;       //"CAB Delivery WT\n加工铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "SB")
        //           {
        //               ws.Column(lColNo).Width = 16;       //"SB Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 16;       //"SB Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "MESH")
        //           {
        //               ws.Column(lColNo).Width = 15;       //"MESH Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 15;       //"MESH Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           if (ProdType == "CAGE")
        //           {
        //               ws.Column(lColNo).Width = 15;       //"CAGE Delivery WT\n标直铁来货重量"
        //               ws.Column(lColNo + 1).Width = 15;       //"CAGE Delivery WT\n标直铁来货重量"
        //               lColNo = lColNo + 2;
        //           }

        //           ws.Column(lColNo).Width = 20;       //"Remarks\n备注"

        //           string lColLetter = Convert.ToChar(64 + lColNo).ToString(); // A Ascii -- 65

        //           ws.Cells["A1:" + lColLetter + "1"].Merge = true;
        //           ws.Cells[1, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
        //           ws.Cells[1, 1].Style.Font.Bold = true;
        //           ws.Cells[1, 1].Style.Font.Size = 12;
        //           ws.Cells[1, 1].Style.WrapText = true;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Cells[1, 1].Value = "BBS List for Cut and Bend Bars\n加工铁订单详细列表";
        //           }
        //           else if (ProdType == "SB")
        //           {
        //               ws.Cells[1, 1].Value = "BBS List for Standard Length Bars\n标准直铁订单详细列表";
        //           }
        //           else if (ProdType == "MESH")
        //           {
        //               ws.Cells[1, 1].Value = "BBS List for MESH\n铁网订单详细列表";
        //           }
        //           else if (ProdType == "CAGE")
        //           {
        //               ws.Cells[1, 1].Value = "BBS List for Cages\n铁笼铁订单详细列表";
        //           }



        //           ws.Row(1).Height = 30;

        //           ws.Cells["A2:C2"].Merge = true;
        //           ws.Cells[2, 1].Value = "Company Name (公司名称):";
        //           ws.Cells[2, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //           ws.Cells[2, 1].Style.Font.Bold = true;
        //           ws.Cells["D2:" + lColLetter + "2"].Merge = true;
        //           ws.Cells[2, 4].Value = lCompanyName;
        //           ws.Cells[2, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
        //           ws.Cells[2, 4].Style.Font.Bold = true;

        //           ws.Cells["A3:C3"].Merge = true;
        //           ws.Cells[3, 1].Value = "Project Title (工程项目名称):";
        //           ws.Cells[3, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //           ws.Cells[3, 1].Style.Font.Bold = true;

        //           ws.Cells["D3:" + lColLetter + "3"].Merge = true;
        //           ws.Cells[3, 4].Value = lProjectTitle;
        //           ws.Cells[3, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Left;
        //           ws.Cells[3, 4].Style.Font.Bold = true;

        //           lRowNo = 4;

        //           if (ProdType == "CAB" && (lCABOrderTotal > 0 || lCABDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Cut & Bend Total (加工铁汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCABDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;

        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "SB") && (lSBOrderTotal > 0 || lSBDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Standard Length Bars Total (标准直铁汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lSBDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "MESH") && (lMESHOrderTotal > 0 || lMESHDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "MESH Total (铁网汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lMESHDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if ((ProdType == "CAB" || ProdType == "CAGE") && (lCAGEOrderTotal > 0 || lCAGEDelTotal > 0))
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Cage Total (铁笼汇总):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCAGEDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           if (lRowNo > 5)
        //           {
        //               ws.Cells["A" + lRowNo.ToString() + ":C" + lRowNo.ToString() + ""].Merge = true;
        //               ws.Cells[lRowNo, 1].Value = "Grand Total (总计):";
        //               ws.Cells[lRowNo, 1].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 1].Style.Font.Bold = true;

        //               ws.Cells["D" + lRowNo.ToString() + ":E" + lRowNo.ToString()].Merge = true;
        //               ws.Cells[lRowNo, 4].Value = lCABDelTotal + lSBDelTotal + lMESHDelTotal + lCAGEDelTotal;
        //               ws.Cells[lRowNo, 4].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;
        //               ws.Cells[lRowNo, 4].Style.Numberformat.Format = "###,###,###.000;(###,###,###.000); ";
        //               ws.Cells[lRowNo, 4].Style.Font.Bold = true;
        //               lRowNo = lRowNo + 1;
        //           }

        //           ws.Cells["F4" + ":" + lColLetter + (lRowNo - 1).ToString()].Merge = true;

        //           ExcelRange lrg = ws.Cells["A1:" + lColLetter + (lRowNo - 1).ToString()];
        //           lrg.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Top.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Left.Style = ExcelBorderStyle.Thin;
        //           lrg.Style.Border.Right.Style = ExcelBorderStyle.Thin;

        //           ExcelRange lrg4 = ws.Cells["A" + lRowNo.ToString() + ":" + lColLetter + lRowNo.ToString() + ""];
        //           lrg4.Style.Border.Bottom.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Top.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Left.Style = ExcelBorderStyle.Thin;
        //           lrg4.Style.Border.Right.Style = ExcelBorderStyle.Thin;

        //           lrg4.Style.Fill.PatternType = ExcelFillStyle.Solid;
        //           lrg4.Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

        //           lrg4.Style.WrapText = true;

        //           ws.Cells[lRowNo, 1].Value = "SNo\n序号";
        //           ws.Cells[lRowNo, 2].Value = "BBS No\n加工表号";
        //           ws.Cells[lRowNo, 3].Value = "BBS Description\n施工部位";
        //           ws.Cells[lRowNo, 4].Value = "WBS1\n楼座";
        //           ws.Cells[lRowNo, 5].Value = "WBS2\n楼层";
        //           ws.Cells[lRowNo, 6].Value = "WBS3\n分部";
        //           ws.Cells[lRowNo, 7].Value = "Structure Element\n构件";
        //           ws.Cells[lRowNo, 8].Value = "PO Date\n订货日期";
        //           ws.Cells[lRowNo, 9].Value = "Required Date\n到场日期";
        //           ws.Cells[lRowNo, 10].Value = "Date Delivered\n实际到场日期";

        //           lColNo = 11;
        //           if (ProdType == "CAB")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "CAB PO Weight\n加工铁料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "CAB Delivery Weight\n加工铁来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "SB")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "Standard Bars PO Weight\n标直铁料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "Standard Bars Delivery Weight\n标直铁来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "MESH")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "MESH PO Weight\n铁网料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "MESH Delivery Weight\n铁网来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           if (ProdType == "CAGE")
        //           {
        //               ws.Cells[lRowNo, lColNo].Value = "Cage PO Weight\n铁笼料单重量";
        //               ws.Cells[lRowNo, lColNo + 1].Value = "Cage Delivery Weight\n铁笼来货重量";
        //               lColNo = lColNo + 2;
        //           }
        //           ws.Cells[lRowNo, lColNo].Value = "Remarks\n备注";

        //           lRowNo = lRowNo + 1;

        //           if (lReturn.Count > 0)
        //           {
        //               var j = 0;
        //               for (int i = 0; i < lReturn.Count; i++)
        //               {
        //                   if ((ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       || (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       || (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       || (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       )
        //                   {
        //                       ws.Cells[j + lRowNo, 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 2].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 3].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 3].Style.WrapText = true;
        //                       ws.Cells[j + lRowNo, 4].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 5].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 6].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 7].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 8].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 9].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, 10].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       lColNo = 11;
        //                       if (ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                           ws.Cells[j + lRowNo, lColNo].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Style.Numberformat.Format = "###,###.000;(###,###.000); ";
        //                           lColNo = lColNo + 2;
        //                       }
        //                       ws.Cells[j + lRowNo, lColNo].Style.Border.BorderAround(ExcelBorderStyle.Thin);
        //                       ws.Cells[j + lRowNo, lColNo].Style.WrapText = true;


        //                       var lBBSDesc = lReturn[i].BBSDesc;
        //                       if (lReturn[i].SBDelWT > 0 || (lReturn[i].SBOrderWT > 0 || lReturn[i].MESHDelWT > 0 || lReturn[i].MESHOrderWT > 0))
        //                       {
        //                           lBBSDesc = lBBSDesc.Replace(", ", "\n");
        //                           lBBSDesc = lBBSDesc.Replace(",", "\n");
        //                       }
        //                       ws.Cells[j + lRowNo, 1].Value = j + 1;
        //                       ws.Cells[j + lRowNo, 2].Value = lReturn[i].BBSNo; //"BBS No\n加工表号";
        //                       ws.Cells[j + lRowNo, 3].Value = lBBSDesc; //"BBS Description\n施工部位";
        //                       ws.Cells[j + lRowNo, 4].Value = lReturn[i].WBS1; //"WBS1\n楼座";
        //                       ws.Cells[j + lRowNo, 5].Value = lReturn[i].WBS2; //"WBS2\n楼层";
        //                       ws.Cells[j + lRowNo, 6].Value = lReturn[i].WBS3; //"WBS3\n分部";
        //                       ws.Cells[j + lRowNo, 7].Value = lReturn[i].StrucEle; //"Structure Element\n构件";
        //                       ws.Cells[j + lRowNo, 8].Value = lReturn[i].PODate; //"PO Date\n订货日期";
        //                       ws.Cells[j + lRowNo, 9].Value = lReturn[i].RequiredDate; //"Required Date\n到场日期";
        //                       ws.Cells[j + lRowNo, 10].Value = lReturn[i].DeliveryDate; //"Date Delivered\n实际到场日期";
        //                       lColNo = 11;
        //                       if (ProdType == "CAB" && (lReturn[i].CABOrderWT > 0 || lReturn[i].CABDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].CABOrderWT; //"CAB PO WT\n加工铁料单重量";
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].CABDelWT; //"CAB Delivery WT\n加工铁来货重量";
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "SB" && (lReturn[i].SBOrderWT > 0 || lReturn[i].SBDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].SBOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].SBDelWT;
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "MESH" && (lReturn[i].MESHOrderWT > 0 || lReturn[i].MESHDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].MESHOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].MESHDelWT;
        //                           lColNo = lColNo + 2;
        //                       }

        //                       if (ProdType == "CAGE" && (lReturn[i].CAGEOrderWT > 0 || lReturn[i].CAGEDelWT > 0))
        //                       {
        //                           ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].CAGEOrderWT;
        //                           ws.Cells[j + lRowNo, lColNo + 1].Value = lReturn[i].CAGEDelWT;
        //                           lColNo = lColNo + 2;
        //                       }
        //                       ws.Cells[j + lRowNo, lColNo].Value = lReturn[i].Remarks; //"Remarks\n备注";
        //                       j = j + 1;
        //                   }
        //               }
        //           }


        //       }

        //       //List of Used BBS No
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult usedBBSNoList(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           BBSSumProcess(CustomerCode, ProjectCode);
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           int lSNo = 0;
        //           var lNDSCon = new SqlConnection();
        //           var lReturn = (new[]{ new
        //           {
        //               SSNNo = 0,
        //               PONo = "",
        //               BBSNo = "",
        //               BBSDesc = "",
        //               WBS1 = "",
        //               WBS2 = "",
        //               WBS3 = "",
        //               StrucEle = "",
        //               PODate = "",
        //               RequiredDate= "",
        //               DeliveryDate= "",
        //               CABOrderWT = "",
        //               CABDelWT = "",
        //               SBOrderWT = "",
        //               SBDelWT = "",
        //               MESHOrderWT = "",
        //               MESHDelWT = "",
        //               CAGEOrderWT = "",
        //               CAGEDelWT = "",
        //               Remarks = ""
        //           }}).ToList();
        //           if (CustomerCode != null && ProjectCode != null)
        //           {
        //               if (CustomerCode.Length > 0 && ProjectCode.Length > 0)
        //               {
        //                   lCmd.CommandText =
        //                       "SELECT * FROM dbo.OESBBSSum " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "order by DeliveryDate DESC, BBSNo ";

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           while (lRst.Read())
        //                           {
        //                               lSNo = lSNo + 1;
        //                               lReturn.Add(new
        //                               {
        //                                   SSNNo = lSNo,
        //                                   PONo = lRst.GetString(5),
        //                                   BBSNo = lRst.GetString(6),
        //                                   BBSDesc = lRst.GetString(7),
        //                                   WBS1 = lRst.GetString(8),
        //                                   WBS2 = lRst.GetString(9),
        //                                   WBS3 = lRst.GetString(10),
        //                                   StrucEle = lRst.GetString(11),
        //                                   PODate = (lRst.GetValue(12) == DBNull.Value ? "" : lRst.GetDateTime(12).ToString("yyyy-MM-dd")),
        //                                   RequiredDate = (lRst.GetValue(13) == DBNull.Value ? "" : lRst.GetDateTime(13).ToString("yyyy-MM-dd")),
        //                                   DeliveryDate = (lRst.GetValue(14) == DBNull.Value ? "" : lRst.GetDateTime(14).ToString("yyyy-MM-dd")),
        //                                   CABOrderWT = lRst.GetDecimal(15).ToString("###,###.000;(###,###.000); "),
        //                                   CABDelWT = lRst.GetDecimal(16).ToString("###,###.000;(###,###.000); "),
        //                                   SBOrderWT = lRst.GetDecimal(17).ToString("###,###.000;(###,###.000); "),
        //                                   SBDelWT = lRst.GetDecimal(18).ToString("###,###.000;(###,###.000); "),
        //                                   MESHOrderWT = lRst.GetDecimal(19).ToString("###,###.000;(###,###.000); "),
        //                                   MESHDelWT = lRst.GetDecimal(20).ToString("###,###.000;(###,###.000); "),
        //                                   CAGEOrderWT = lRst.GetDecimal(21).ToString("###,###.000;(###,###.000); "),
        //                                   CAGEDelWT = lRst.GetDecimal(22).ToString("###,###.000;(###,###.000); "),
        //                                   Remarks = lRst.GetString(24)
        //                               });
        //                           }
        //                       }
        //                       lRst.Close();

        //                       lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                   }
        //                   lProcessObj = null;
        //               }
        //           }
        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           return Ok(lReturn);
        //       }

        //       private int BBSSumInsert(string CustomerCode, string ProjectCode, SqlConnection lNDSCon, OracleDataReader lOraRst, DataTable lDTOrder, DataTable lDTBackup, int lSSNNo)
        //       {
        //           int lReturn = 0;
        //           string lSQL = "";

        //           string lPONo = "";
        //           string lPODate = "";
        //           string lWBS1 = "";
        //           string lWBS2 = "";
        //           string lWBS3 = "";
        //           string lStEle = "";
        //           string lProdType = "";
        //           string lBBSNo = "";
        //           string lBBSDesc = "";
        //           string lReqDate = "";
        //           string lLoadDate = "";
        //           string lSONo = "";
        //           decimal lDelQty = 0;

        //           decimal lCABDelQty = 0;
        //           decimal lSBDelQty = 0;
        //           decimal lMESHDelQty = 0;
        //           decimal lCAGEDelQty = 0;

        //           decimal lCABPOQty = 0;
        //           decimal lSBPOQty = 0;
        //           decimal lMESHPOQty = 0;
        //           decimal lCAGEPOQty = 0;

        //           string lRemarks = "";

        //           int lJobID = 0;
        //           int lBBSID = 0;

        //           var lCmd = new SqlCommand();

        //           lPONo = (lOraRst.GetString(0) == null ? "" : lOraRst.GetString(0).Trim());
        //           lPODate = (lOraRst.GetString(1) == null ? "20000101" : lOraRst.GetString(1).Trim());
        //           lWBS1 = (lOraRst.GetString(2) == null ? "" : lOraRst.GetString(2).Trim());
        //           lWBS2 = (lOraRst.GetString(3) == null ? "" : lOraRst.GetString(3).Trim());
        //           lWBS3 = (lOraRst.GetString(4) == null ? "" : lOraRst.GetString(4).Trim());
        //           lStEle = (lOraRst.GetString(5) == null ? "" : lOraRst.GetString(5).Trim());
        //           lProdType = (lOraRst.GetString(6) == null ? "" : lOraRst.GetString(6).Trim());
        //           lBBSNo = (lOraRst.GetString(7) == null ? "" : lOraRst.GetString(7).Trim());
        //           lBBSDesc = (lOraRst.GetString(8) == null ? "" : lOraRst.GetString(8).Trim());
        //           lReqDate = (lOraRst.GetString(9) == null ? "20000101" : lOraRst.GetString(9).Trim());
        //           lLoadDate = (lOraRst.GetString(10) == null ? "20000101" : lOraRst.GetString(10).Trim());
        //           lDelQty = lOraRst.GetDecimal(11);
        //           lSONo = (lOraRst.GetString(12) == null ? "" : lOraRst.GetString(12).Trim());

        //           if (lPODate == "") { lPODate = "20000101"; }
        //           if (lReqDate == "") { lReqDate = "20000101"; }
        //           if (lLoadDate == "") { lLoadDate = "20000101"; }

        //           lCABDelQty = 0;
        //           lSBDelQty = 0;
        //           lMESHDelQty = 0;
        //           lCAGEDelQty = 0;

        //           lCABPOQty = 0;
        //           lSBPOQty = 0;
        //           lMESHPOQty = 0;
        //           lCAGEPOQty = 0;

        //           if (lProdType == "CAB")
        //           {
        //               lCABDelQty = lDelQty;
        //           }
        //           if (lProdType == "SB")
        //           {
        //               lSBDelQty = lDelQty;
        //           }
        //           if (lProdType == "MSH")
        //           {
        //               lMESHDelQty = lDelQty;
        //           }
        //           if (lProdType == "PRC")
        //           {
        //               lCAGEDelQty = lDelQty;
        //           }


        //           DataRow[] lOrder = lDTOrder.Select("PONumber='" + lPONo + "' AND BBSNoNDS='" + lBBSNo + "'");
        //           if (lOrder == null || lOrder.Length == 0)
        //           {
        //               lOrder = lDTOrder.Select("PONumber='" + lPONo + "' AND BBSNo='" + lBBSNo + "'");
        //           }

        //           lJobID = 0;
        //           lBBSID = 0;
        //           if (lOrder != null && lOrder.Length > 0)
        //           {
        //               lJobID = (int)lOrder[0].ItemArray[2];
        //               lBBSID = (int)lOrder[0].ItemArray[11];
        //               lCABPOQty = (decimal)lOrder[0].ItemArray[15];
        //               lSBPOQty = (decimal)lOrder[0].ItemArray[16];
        //               if (lWBS1.Length == 0 && lOrder[0].ItemArray[8] != DBNull.Value)
        //               {
        //                   lWBS1 = (string)lOrder[0].ItemArray[8];
        //               }
        //               if (lWBS2.Length == 0 && lOrder[0].ItemArray[9] != DBNull.Value)
        //               {
        //                   lWBS2 = (string)lOrder[0].ItemArray[9];
        //               }
        //               if (lWBS3.Length == 0 && lOrder[0].ItemArray[10] != DBNull.Value)
        //               {
        //                   lWBS3 = (string)lOrder[0].ItemArray[10];
        //               }
        //               if (lStEle.Length == 0 && lOrder[0].ItemArray[14] != DBNull.Value)
        //               {
        //                   lStEle = (string)lOrder[0].ItemArray[14];
        //               }
        //           }

        //           if (lCABDelQty > 0 && lCABPOQty == 0)
        //           {
        //               lCABPOQty = lCABDelQty;
        //           }
        //           if (lSBDelQty > 0 && lSBPOQty == 0)
        //           {
        //               lSBPOQty = lSBDelQty;
        //           }
        //           if (lMESHDelQty > 0 && lMESHPOQty == 0)
        //           {
        //               lMESHPOQty = lMESHDelQty;
        //           }
        //           if (lCAGEDelQty > 0 && lCAGEPOQty == 0)
        //           {
        //               lCAGEPOQty = lCAGEDelQty;
        //           }

        //           lOrder = lDTBackup.Select("PONo='" + lPONo + "' AND BBSNo='" + lBBSNo + "'");
        //           if (lOrder != null && lOrder.Length > 0)
        //           {
        //               lRemarks = (string)lOrder[0].ItemArray[24];
        //               lRemarks = lRemarks.Replace("'", "''");
        //           }

        //           lBBSDesc = lBBSDesc.Replace("'", "''");
        //           if (lBBSDesc.Length > 500)
        //           {
        //               lBBSDesc = lBBSDesc.Substring(0, 500);
        //           }

        //           lSQL = "INSERT INTO dbo.OESBBSSum " +
        //           "(CustomerCode " +
        //           ", ProjectCode " +
        //           ", SSNNo " +
        //           ", JobID " +
        //           ", BBSID " +
        //           ", PONo " +
        //           ", BBSNo " +
        //           ", BBSDesc " +
        //           ", WBS1 " +
        //           ", WBS2 " +
        //           ", WBS3 " +
        //           ", STElement " +
        //           ", PODate " +
        //           ", RequiredDate " +
        //           ", DeliveryDate " +
        //           ", CABOrderWT " +
        //           ", CABDeliveryWT " +
        //           ", SBOrderWT " +
        //           ", SBDeliveryWT " +
        //           ", MESHOrderWT " +
        //           ", MESHDeliveryWT " +
        //           ", CAGEOrderWT " +
        //           ", CAGEDeliveryWT " +
        //           ", SONo " +
        //           ", Remarks) " +
        //           "VALUES " +
        //           "('" + CustomerCode + "' " +
        //           ",'" + ProjectCode + "' " +
        //           "," + lSSNNo.ToString() + " " +
        //           "," + lJobID.ToString() + " " +
        //           "," + lBBSID.ToString() + " " +
        //           ",'" + lPONo + "' " +
        //           ",'" + lBBSNo + "' " +
        //           ",'" + lBBSDesc + "' " +
        //           ",'" + lWBS1 + "' " +
        //           ",'" + lWBS2 + "' " +
        //           ",'" + lWBS3 + "' " +
        //           ",'" + lStEle + "' " +
        //           ",'" + DateTime.ParseExact(lPODate, "yyyyMMdd", CultureInfo.InvariantCulture).ToString("yyyy-MM-dd") + "' " +
        //           ",'" + DateTime.ParseExact(lReqDate, "yyyyMMdd", CultureInfo.InvariantCulture).ToString("yyyy-MM-dd") + "' " +
        //           ",'" + DateTime.ParseExact(lLoadDate, "yyyyMMdd", CultureInfo.InvariantCulture).ToString("yyyy-MM-dd") + "' " +
        //           "," + lCABPOQty.ToString() + " " +
        //           "," + lCABDelQty.ToString() + " " +
        //           "," + lSBPOQty.ToString() + " " +
        //           "," + lSBDelQty.ToString() + " " +
        //           "," + lMESHPOQty.ToString() + " " +
        //           "," + lMESHDelQty.ToString() + " " +
        //           "," + lCAGEPOQty.ToString() + " " +
        //           "," + lCAGEDelQty.ToString() + " " +
        //           ",'" + lSONo + "' " +
        //           ",'" + lRemarks + "') ";

        //           lCmd = new SqlCommand();
        //           lCmd.CommandText = lSQL;
        //           lCmd.Connection = lNDSCon;
        //           lCmd.CommandTimeout = 300;
        //           lCmd.ExecuteNonQuery();


        //           return lReturn;

        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public int BBSSumProcess(string CustomerCode, string ProjectCode)
        //       {
        //           int lReturn = 0;
        //           int lSSNNo = 0;
        //           string lSQL = "";

        //           string lPONo = "";
        //           string lPODate = "";
        //           string lWBS1 = "";
        //           string lWBS2 = "";
        //           string lWBS3 = "";
        //           string lStEle = "";
        //           string lProdType = "";
        //           string lBBSNo = "";
        //           string lBBSDesc = "";
        //           string lReqDate = "";
        //           string lLoadDate = "";
        //           string lSONo = "";
        //           decimal lDelQty = 0;

        //           decimal lCABDelQty = 0;
        //           decimal lSBDelQty = 0;
        //           decimal lMESHDelQty = 0;
        //           decimal lCAGEDelQty = 0;

        //           decimal lCABPOQty = 0;
        //           decimal lSBPOQty = 0;
        //           decimal lMESHPOQty = 0;
        //           decimal lCAGEPOQty = 0;

        //           string lRemarks = "";

        //           int lJobID = 0;
        //           int lBBSID = 0;

        //           var lProjectContent = db.Project.Find(CustomerCode, ProjectCode);
        //           string lProjectCodeMESH = lProjectContent.ProjectCodeMESH;
        //           string lProjectCodeCage = lProjectContent.ProjectCodeCage;
        //           if (lProjectCodeMESH == null) lProjectCodeMESH = "";
        //           if (lProjectCodeCage == null) lProjectCodeCage = "";
        //           lProjectCodeMESH = lProjectCodeMESH.Trim();
        //           lProjectCodeCage = lProjectCodeCage.Trim();

        //           DataTable lDTBackup = new DataTable();
        //           DataTable lDTOrder = new DataTable();

        //           DateTime lDeliveryDate = new DateTime();
        //           DateTime lRequiredDate = new DateTime();
        //           DateTime lSumUpdatedDate = new DateTime();

        //           var lCmd = new SqlCommand();
        //           var lDA = new SqlDataAdapter();

        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lCISCon = new OracleConnection();
        //           var lOraCmd = new OracleCommand();
        //           OracleDataReader lOraRst;

        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               //Chech process time
        //               lCmd.CommandText = "SELECT SumUpdatedDate FROM dbo.OESProject " +
        //               "WHERE CustomerCode = '" + CustomerCode + "' " +
        //               "AND ProjectCode = '" + ProjectCode + "' ";

        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   if (lRst.Read())
        //                   {
        //                       lSumUpdatedDate = lRst.GetDateTime(0);
        //                   }
        //               }
        //               lRst.Close();

        //               if (lSumUpdatedDate < DateTime.Today)
        //               {

        //                   //get last delevery datetime
        //                   lCmd.CommandText = "SELECT isNull(Max(DeliveryDate),DateAdd(yyyy,-10,getDate())) FROM dbo.OESBBSSum " +
        //               "WHERE CustomerCode = '" + CustomerCode + "' " +
        //               "AND ProjectCode = '" + ProjectCode + "' ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       if (lRst.Read())
        //                       {
        //                           lDeliveryDate = lRst.GetDateTime(0);
        //                       }
        //                   }
        //                   lRst.Close();

        //                   //Backup the data 
        //                   lCmd.CommandText = "SELECT * FROM dbo.OESBBSSum " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND (DeliveryDate  >= '" + lDeliveryDate.ToString("yyyy-MM-dd") + "' " +
        //                   "OR DeliveryDate is null) ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lDA = new SqlDataAdapter();
        //                   lDA.SelectCommand = lCmd;
        //                   lDTBackup = new DataTable();
        //                   lDA.Fill(lDTBackup);

        //                   //Delete
        //                   lCmd.CommandText = "DELETE FROM dbo.OESBBSSum " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND (DeliveryDate  >= '" + lDeliveryDate.ToString("yyyy-MM-dd") + "' " +
        //                   "OR DeliveryDate is null) ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lCmd.ExecuteNonQuery();


        //                   //get last required date
        //                   lCmd.CommandText = "SELECT isNull(Max(RequiredDate),DateAdd(yyyy,-10,getDate())) FROM dbo.OESBBSSum " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       if (lRst.Read())
        //                       {
        //                           lRequiredDate = lRst.GetDateTime(0);
        //                       }
        //                   }
        //                   lRst.Close();

        //                   // get Record from Order
        //                   lCmd.CommandText = "SELECT A.CustomerCode, " +
        //                   "A.ProjectCode, " +
        //                   "A.JobID, " +
        //                   "PONumber, " +
        //                   "PODate, " +
        //                   "RequiredDate, " +
        //                   "TotalCABWeight, " +
        //                   "TotalSTDWeight, " +
        //                   "WBS1, " +
        //                   "WBS2, " +
        //                   "WBS3, " +
        //                   "BBSID, " +
        //                   "BBSNo, " +
        //                   "BBSDesc, " +
        //                   "BBSStrucElem, " +
        //                   "BBSOrderCABWT, " +
        //                   "BBSOrderSTDWT, " +
        //                   "BBSSOR, " +
        //                   "BBSNoNDS " +
        //                   "FROM dbo.OESJobAdvice A, dbo.OESBBS B " +
        //                   "WHERE A.CustomerCode = B.CustomerCode " +
        //                   "AND A.ProjectCode = B.ProjectCode " +
        //                   "AND A.JobID = B.JobID " +
        //                   "AND A.CustomerCode = '" + CustomerCode + "' " +
        //                   "AND A.ProjectCode = '" + ProjectCode + "' " +
        //                   "AND A.RequiredDate >= '" + lRequiredDate.ToString("yyyy-MM-dd") + "' ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lDA = new SqlDataAdapter();
        //                   lDA.SelectCommand = lCmd;
        //                   lDTOrder = new DataTable();
        //                   lDA.Fill(lDTOrder);


        //                   //get last SSNNo
        //                   lCmd.CommandText = "SELECT isNull(Max(SSNNo),0) FROM dbo.OESBBSSum " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       if (lRst.Read())
        //                       {
        //                           lSSNNo = lRst.GetInt32(0);
        //                       }
        //                   }
        //                   lRst.Close();

        //                   lProcessObj.OpenCISConnection(ref lCISCon);

        //                   //CAB 
        //                   //lSQL = "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(D) */ " +
        //                   lSQL = "SELECT /*+ INDEX_SS(S) INDEX_SS(D) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "P.WADAT, " +
        //                   "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                   "SUM(S.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                   "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.lips S, " +
        //                   "SAPSR3.likp P " +
        //                   "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                   "AND S.VGBEL = H.SALES_ORDER " +
        //                   "AND P.VBELN = S.VBELN " +
        //                   "AND to_date(P.WADAT_IST,'yyyymmdd') >= to_date(H.CUST_ORDER_DATE,'yyyymmdd')-100 " +
        //                   "AND SUBSTR(P.WADAT_IST,5,2) > 0 " +
        //                   "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "AND D.STATUS <> 'X' " +
        //                   "AND P.WADAT_IST >= '" + lDeliveryDate.ToString("yyyyMMdd") + "' " +
        //                   "GROUP BY " +
        //                   "S.VBELN, " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "P.WADAT " +
        //                    "ORDER BY " +
        //                    "11, " +
        //                    "8 ";

        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   lSQL = " " +
        //                   "SELECT /*+ INDEX_SS(S) INDEX_SS(P) INDEX_SS(K) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "'SB', " +
        //                   "K.BSTNK, " +
        //                   "listagg(to_char(Round(S.NTGEW/2000)) || ' X ' ||S.ARKTX, ', ') within group (order by S.ARKTX), " +
        //                   "P.WADAT, " +
        //                   "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                   "SUM(S.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.vbak K, " +
        //                   "SAPSR3.lips S, " +
        //                   "SAPSR3.likp P " +
        //                   "WHERE S.VGBEL = H.SALES_ORDER " +
        //                   "AND P.VBELN = S.VBELN " +
        //                   "AND K.VBELN = H.SALES_ORDER " +
        //                   "AND to_date(P.WADAT_IST,'yyyymmdd') >= to_date(H.CUST_ORDER_DATE,'yyyymmdd')-100 " +
        //                   "AND SUBSTR(P.WADAT_IST,5,2) > 0 " +
        //                   "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND S.NTGEW > 0 " +
        //                   "AND NOT EXISTS (SELECT ORDER_REQUEST_NO " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL " +
        //                   "WHERE ORDER_REQUEST_NO = H.ORDER_REQUEST_NO) " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "AND P.WADAT_IST >= '" + lDeliveryDate.ToString("yyyyMMdd") + "' " +
        //                   "GROUP BY " +
        //                   "S.VBELN, " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "K.BSTNK, " +
        //                   "P.WADAT " +
        //                   "ORDER BY " +
        //                   "11, " +
        //                   "8 ";

        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   if (lProjectCodeMESH != "")
        //                   {
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(S) INDEX_SS(D) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "H.PO_NUMBER, " +
        //                       "' ', " +
        //                       "P.WADAT, " +
        //                       "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                       "SUM(S.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.lips S, " +
        //                       "SAPSR3.likp P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND S.VGBEL = H.SALES_ORDER " +
        //                       "AND P.VBELN = S.VBELN " +
        //                       "AND to_date(P.WADAT_IST,'yyyymmdd') >= to_date(H.CUST_ORDER_DATE,'yyyymmdd')-100 " +
        //                       "AND SUBSTR(P.WADAT_IST,5,2) > 0 " +
        //                       "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeMESH + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "AND P.WADAT_IST >= '" + lDeliveryDate.ToString("yyyyMMdd") + "' " +
        //                       "GROUP BY " +
        //                       "S.VBELN, " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "P.WADAT " +
        //                       "ORDER BY " +
        //                       "11, " +
        //                       "8 ";

        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();

        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(S) INDEX_SS(P) INDEX_SS(K) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "' ', " +
        //                       "' ', " +
        //                       "' ', " +
        //                       "' ', " +
        //                       "'MSH', " +
        //                       "K.BSTNK, " +
        //                       "listagg(to_char(S.LFIMG) || ' X ' ||S.ARKTX, ', ') within group (order by S.ARKTX), " +
        //                       "P.WADAT, " +
        //                       "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                       "SUM(S.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.vbak K, " +
        //                       "SAPSR3.lips S, " +
        //                       "SAPSR3.likp P " +
        //                       "WHERE S.VGBEL = H.SALES_ORDER " +
        //                       "AND P.VBELN = S.VBELN " +
        //                       "AND K.VBELN = H.SALES_ORDER " +
        //                       "AND to_date(P.WADAT_IST,'yyyymmdd') >= to_date(H.CUST_ORDER_DATE,'yyyymmdd')-100 " +
        //                       "AND SUBSTR(P.WADAT_IST,5,2) > 0 " +
        //                       "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeMESH + "' " +
        //                       "AND S.NTGEW > 0 " +
        //                       "AND NOT EXISTS (SELECT ORDER_REQUEST_NO " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL " +
        //                       "WHERE ORDER_REQUEST_NO = H.ORDER_REQUEST_NO) " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND P.WADAT_IST >= '" + lDeliveryDate.ToString("yyyyMMdd") + "' " +
        //                       "GROUP BY " +
        //                       "S.VBELN, " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "K.BSTNK, " +
        //                       "P.WADAT " +
        //                       "ORDER BY " +
        //                       "11, " +
        //                       "8 ";

        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();
        //                   }

        //                   if (lProjectCodeCage != "")
        //                   {
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(S) INDEX_SS(D) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "P.WADAT, " +
        //                       "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                       "SUM(S.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.lips S, " +
        //                       "SAPSR3.likp P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND S.VGBEL = H.SALES_ORDER " +
        //                       "AND P.VBELN = S.VBELN " +
        //                       "AND to_date(P.WADAT_IST,'yyyymmdd') >= to_date(H.CUST_ORDER_DATE,'yyyymmdd')-100 " +
        //                       "AND SUBSTR(P.WADAT_IST,5,2) > 0 " +
        //                       "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeCage + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "AND P.WADAT_IST >= '" + lDeliveryDate.ToString("yyyyMMdd") + "' " +
        //                       "GROUP BY " +
        //                       "S.VBELN, " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "P.WADAT " +
        //                       "ORDER BY " +
        //                       "11, " +
        //                       "8 ";

        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();
        //                   }

        //                   //get have not scheduled order

        //                   lSQL = "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(D) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "H.REQD_DEL_DATE, " +
        //                   "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                   "SUM(S.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                   "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.lips S, " +
        //                   "SAPSR3.likp P " +
        //                   "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                   "AND S.VGBEL = H.SALES_ORDER " +
        //                   "AND S.VGBEL > ' ' " +
        //                   "AND P.VBELN = S.VBELN " +
        //                   "AND P.WADAT_IST <= to_char(to_date(H.CUST_ORDER_DATE,'yyyymmdd')-300,'yyyymmdd') " +
        //                   "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "AND D.STATUS <> 'X' " +
        //                   "GROUP BY " +
        //                   "S.VBELN, " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "H.REQD_DEL_DATE " +
        //                   "ORDER BY " +
        //                   "10, " +
        //                   "8 ";
        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   lSQL = " " +
        //                   "SELECT /*+ INDEX_SS(D) INDEX_SS(P) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "H.REQD_DEL_DATE, " +
        //                   "' ', " +
        //                   "SUM(P.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                   "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.vbak K, SAPSR3.vbap P " +
        //                   "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                   "AND K.VBELN = H.SALES_ORDER " +
        //                   "AND P.VBELN = K.VBELN " +
        //                   "AND NOT EXISTS (SELECT /*+ INDEX_SS(S \"LIPS~Y01\") */ S.VGBEL FROM SAPSR3.lips S WHERE S.VGBEL = H.SALES_ORDER) " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "AND D.STATUS <> 'X' " +
        //                   "GROUP BY " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "D.WBS1, " +
        //                   "D.WBS2, " +
        //                   "D.WBS3, " +
        //                   "D.ST_ELEMENT_TYPE, " +
        //                   "D.PRODUCT_TYPE, " +
        //                   "D.BBS_NO, " +
        //                   "D.BBS_DESC, " +
        //                   "H.REQD_DEL_DATE " +
        //                   "ORDER BY " +
        //                   "10, " +
        //                   "8 ";
        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   lSQL = " " +
        //                   "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(P) INDEX_SS(K) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "'SB', " +
        //                   "K.BSTNK, " +
        //                   "listagg(to_char(Round(S.NTGEW/2000)) || ' X ' ||S.ARKTX, ', ') within group (order by S.ARKTX), " +
        //                   "H.REQD_DEL_DATE, " +
        //                   "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                   "SUM(S.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.vbak K, " +
        //                   "SAPSR3.lips S, " +
        //                   "SAPSR3.likp P " +
        //                   "WHERE S.VGBEL = H.SALES_ORDER " +
        //                   "AND P.VBELN = S.VBELN " +
        //                   "AND S.VGBEL > ' ' " +
        //                   "AND K.VBELN = H.SALES_ORDER " +
        //                   "AND P.WADAT_IST <= to_char(to_date(H.CUST_ORDER_DATE,'yyyymmdd')-300,'yyyymmdd') " +
        //                   "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND S.NTGEW > 0 " +
        //                   "AND NOT EXISTS (SELECT ORDER_REQUEST_NO " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL " +
        //                   "WHERE ORDER_REQUEST_NO = H.ORDER_REQUEST_NO) " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "GROUP BY " +
        //                   "S.VBELN, " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "K.BSTNK, " +
        //                   "H.REQD_DEL_DATE " +
        //                   "ORDER BY " +
        //                   "10, " +
        //                   "8 ";
        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   lSQL = " " +
        //                   "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(K) */ " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "' ', " +
        //                   "'SB', " +
        //                   "K.BSTNK, " +
        //                   "listagg(to_char(Round(P.NTGEW/2000)) || ' X ' ||P.ARKTX, ', ') within group (order by P.ARKTX), " +
        //                   "H.REQD_DEL_DATE, " +
        //                   "' ' as LOAD_DATE, " +
        //                   "SUM(P.NTGEW) as DEL_QTY, " +
        //                   "H.SALES_ORDER " +
        //                   "FROM SAPSR3.YMSDT_ORDER_HDR H, " +
        //                   "SAPSR3.vbak K, SAPSR3.vbap P " +
        //                   "WHERE K.VBELN = H.SALES_ORDER " +
        //                   "AND K.VBELN = P.VBELN " +
        //                   "AND NOT EXISTS (SELECT /*+ INDEX_SS(S \"LIPS~Y01\") */ S.VGBEL FROM SAPSR3.lips S WHERE S.VGBEL = H.SALES_ORDER) " +
        //                   "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                   "AND H.PROJECT = '" + ProjectCode + "' " +
        //                   "AND NOT EXISTS (SELECT ORDER_REQUEST_NO " +
        //                   "FROM SAPSR3.YMSDT_REQ_DETAIL " +
        //                   "WHERE ORDER_REQUEST_NO = H.ORDER_REQUEST_NO) " +
        //                   "AND H.STATUS <> 'X' " +
        //                   "GROUP BY " +
        //                   "K.VBELN, " +
        //                   "H.SALES_ORDER, " +
        //                   "H.PO_NUMBER, " +
        //                   "H.CUST_ORDER_DATE, " +
        //                   "K.BSTNK, " +
        //                   "H.REQD_DEL_DATE " +
        //                   "ORDER BY " +
        //                   "10, " +
        //                   "8 ";
        //                   lOraCmd.CommandText = lSQL;
        //                   lOraCmd.Connection = lCISCon;
        //                   lOraCmd.CommandTimeout = 300;
        //                   lOraRst = lOraCmd.ExecuteReader();
        //                   if (lOraRst.HasRows)
        //                   {
        //                       while (lOraRst.Read())
        //                       {
        //                           lSSNNo = lSSNNo + 1;
        //                           BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                       }
        //                   }
        //                   lOraRst.Close();

        //                   if (lProjectCodeMESH != "")
        //                   {
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(D) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "H.PO_NUMBER, " +
        //                       "' ', " +
        //                       "H.REQD_DEL_DATE, " +
        //                       "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                       "SUM(S.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.lips S, " +
        //                       "SAPSR3.likp P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND S.VGBEL = H.SALES_ORDER " +
        //                       "AND S.VGBEL > ' ' " +
        //                       "AND P.VBELN = S.VBELN " +
        //                       "AND P.WADAT_IST <= to_char(to_date(H.CUST_ORDER_DATE,'yyyymmdd')-300,'yyyymmdd') " +
        //                       "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeMESH + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "GROUP BY " +
        //                       "S.VBELN, " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "H.REQD_DEL_DATE " +
        //                       "ORDER BY " +
        //                       "10, " +
        //                       "8 ";
        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();

        //                       //have not scheduled for delivery
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(D) INDEX_SS(P) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "H.PO_NUMBER, " +
        //                       "' ', " +
        //                       "H.REQD_DEL_DATE, " +
        //                       "' ' as LOAD_DATE, " +
        //                       "SUM(P.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.vbak K, " +
        //                       "SAPSR3.vbap P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND K.VBELN = H.SALES_ORDER " +
        //                       "AND P.VBELN = K.VBELN " +
        //                       "AND NOT EXISTS (SELECT /*+ INDEX_SS(S \"LIPS~Y01\") */ S.VGBEL FROM SAPSR3.lips S WHERE S.VGBEL = H.SALES_ORDER) " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeMESH + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "GROUP BY " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "H.REQD_DEL_DATE " +
        //                       "ORDER BY " +
        //                       "10, " +
        //                       "8 ";
        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();
        //                   }

        //                   if (lProjectCodeCage != "")
        //                   {
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(S \"LIPS~Y01\") INDEX_SS(D) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "H.REQD_DEL_DATE, " +
        //                       "MIN(P.WADAT_IST) as LOAD_DATE, " +
        //                       "SUM(S.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.lips S, " +
        //                       "SAPSR3.likp P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND S.VGBEL = H.SALES_ORDER " +
        //                       "AND S.VGBEL > ' ' " +
        //                       "AND P.VBELN = S.VBELN " +
        //                       "AND P.WADAT_IST <= to_char(to_date(H.CUST_ORDER_DATE,'yyyymmdd')-300,'yyyymmdd') " +
        //                       "AND SUBSTR(H.CUST_ORDER_DATE,5,2) > 0 " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeCage + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "GROUP BY " +
        //                       "S.VBELN, " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "H.REQD_DEL_DATE " +
        //                       "ORDER BY " +
        //                       "10, " +
        //                       "8 ";
        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();

        //                       //have not scheduled for delivery
        //                       lSQL = " " +
        //                       "SELECT /*+ INDEX_SS(D) INDEX_SS(P) */ " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "H.REQD_DEL_DATE, " +
        //                       "' ', " +
        //                       "SUM(P.NTGEW) as DEL_QTY, " +
        //                       "H.SALES_ORDER " +
        //                       "FROM SAPSR3.YMSDT_REQ_DETAIL D, " +
        //                       "SAPSR3.YMSDT_ORDER_HDR H, " +
        //                       "SAPSR3.vbak K, " +
        //                       "SAPSR3.vbap P " +
        //                       "WHERE H.ORDER_REQUEST_NO = D.ORDER_REQUEST_NO " +
        //                       "AND K.VBELN = H.SALES_ORDER " +
        //                       "AND P.VBELN = K.VBELN " +
        //                       "AND NOT EXISTS (SELECT /*+ INDEX_SS(S \"LIPS~Y01\") */ S.VGBEL FROM SAPSR3.lips S WHERE S.VGBEL = H.SALES_ORDER) " +
        //                       "AND H.MANDT = '" + lProcessObj.strClient + "' " +
        //                       "AND H.PROJECT = '" + lProjectCodeCage + "' " +
        //                       "AND H.STATUS <> 'X' " +
        //                       "AND D.STATUS <> 'X' " +
        //                       "GROUP BY " +
        //                       "H.SALES_ORDER, " +
        //                       "H.PO_NUMBER, " +
        //                       "H.CUST_ORDER_DATE, " +
        //                       "D.WBS1, " +
        //                       "D.WBS2, " +
        //                       "D.WBS3, " +
        //                       "D.ST_ELEMENT_TYPE, " +
        //                       "D.PRODUCT_TYPE, " +
        //                       "D.BBS_NO, " +
        //                       "D.BBS_DESC, " +
        //                       "H.REQD_DEL_DATE " +
        //                       "ORDER BY " +
        //                       "10, " +
        //                       "8 ";

        //                       lOraCmd.CommandText = lSQL;
        //                       lOraCmd.Connection = lCISCon;
        //                       lOraCmd.CommandTimeout = 300;
        //                       lOraRst = lOraCmd.ExecuteReader();
        //                       if (lOraRst.HasRows)
        //                       {
        //                           while (lOraRst.Read())
        //                           {
        //                               lSSNNo = lSSNNo + 1;
        //                               BBSSumInsert(CustomerCode, ProjectCode, lNDSCon, lOraRst, lDTOrder, lDTBackup, lSSNNo);
        //                           }
        //                       }
        //                       lOraRst.Close();
        //                   }

        //                   // get Record from Order
        //                   lCmd.CommandText = "SELECT A.CustomerCode, " +
        //                   "A.ProjectCode, " +
        //                   "A.JobID, " +
        //                   "PONumber, " +
        //                   "PODate, " +
        //                   "RequiredDate, " +
        //                   "TotalCABWeight, " +
        //                   "TotalSTDWeight, " +
        //                   "WBS1, " +
        //                   "WBS2, " +
        //                   "WBS3, " +
        //                   "BBSID, " +
        //                   "BBSNo, " +
        //                   "BBSDesc, " +
        //                   "BBSStrucElem, " +
        //                   "BBSOrderCABWT, " +
        //                   "BBSOrderSTDWT, " +
        //                   "BBSSOR, " +
        //                   "BBSNoNDS " +
        //                   "FROM dbo.OESJobAdvice A, dbo.OESBBS B " +
        //                   "WHERE A.CustomerCode = B.CustomerCode " +
        //                   "AND A.ProjectCode = B.ProjectCode " +
        //                   "AND A.JobID = B.JobID " +
        //                   "AND A.CustomerCode = '" + CustomerCode + "' " +
        //                   "AND A.ProjectCode = '" + ProjectCode + "' " +
        //                   "AND Requireddate > ' ' " +
        //                   "AND PONumber > ' ' " +
        //                   "AND NOT EXISTS (SELECT BBSNO FROM dbo.OESBBSSum " +
        //                   "WHERE PONo = A.PONumber " +
        //                   "AND BBSNo = B.BBSNo)  ";


        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lDA = new SqlDataAdapter();
        //                   lDA.SelectCommand = lCmd;
        //                   lDTOrder = new DataTable();
        //                   lDA.Fill(lDTOrder);

        //                   if (lDTOrder.Rows.Count > 0)
        //                   {
        //                       for (int i = 0; i < lDTOrder.Rows.Count; i++)
        //                       {
        //                           lPONo = (lDTOrder.Rows[i].ItemArray[3] == null ? "" : lDTOrder.Rows[i].ItemArray[3].ToString().Trim());
        //                           lPODate = (lDTOrder.Rows[i].ItemArray[4] == null ? "2000-01-01" : ((DateTime)lDTOrder.Rows[i].ItemArray[4]).ToString("yyyy-MM-dd"));
        //                           lWBS1 = (lDTOrder.Rows[i].ItemArray[8] == null ? "" : lDTOrder.Rows[i].ItemArray[8].ToString().Trim());
        //                           lWBS2 = (lDTOrder.Rows[i].ItemArray[9] == null ? "" : lDTOrder.Rows[i].ItemArray[9].ToString().Trim());
        //                           lWBS3 = (lDTOrder.Rows[i].ItemArray[10] == null ? "" : lDTOrder.Rows[i].ItemArray[10].ToString().Trim());
        //                           lStEle = (lDTOrder.Rows[i].ItemArray[14] == null ? "" : lDTOrder.Rows[i].ItemArray[14].ToString().Trim());
        //                           lBBSNo = (lDTOrder.Rows[i].ItemArray[12] == null ? "" : lDTOrder.Rows[i].ItemArray[12].ToString().Trim());
        //                           lBBSDesc = (lDTOrder.Rows[i].ItemArray[13] == null ? "" : lDTOrder.Rows[i].ItemArray[13].ToString().Trim());
        //                           lReqDate = (lDTOrder.Rows[i].ItemArray[5] == null ? "2000-01-01" : ((DateTime)lDTOrder.Rows[i].ItemArray[5]).ToString("yyyy-MM-dd"));
        //                           lLoadDate = null;

        //                           lJobID = (int)lDTOrder.Rows[i].ItemArray[2];
        //                           lBBSID = (int)lDTOrder.Rows[i].ItemArray[11];
        //                           lCABPOQty = (decimal)lDTOrder.Rows[i].ItemArray[15];
        //                           lSBPOQty = (decimal)lDTOrder.Rows[i].ItemArray[16];

        //                           lDelQty = 0;
        //                           lSONo = "";

        //                           lCABDelQty = 0;
        //                           lSBDelQty = 0;
        //                           lMESHDelQty = 0;
        //                           if (lCABPOQty > 0 && lSBPOQty > 0)
        //                           {
        //                               lProdType = "CAB/SB";
        //                           }
        //                           else if (lCABPOQty > 0)
        //                           {
        //                               lProdType = "CAB";
        //                           }
        //                           else if (lSBPOQty > 0)
        //                           {
        //                               lProdType = "SB";
        //                           }

        //                           lSSNNo = lSSNNo + 1;

        //                           DataRow[] lOrder = lDTBackup.Select("PONo='" + lPONo + "' AND BBSNo='" + lBBSNo + "'");
        //                           if (lOrder != null && lOrder.Length > 0)
        //                           {
        //                               lRemarks = (string)lOrder[0].ItemArray[24];
        //                               lRemarks = lRemarks.Replace("'", "''");
        //                           }

        //                           lBBSDesc = lBBSDesc.Replace("'", "''");

        //                           lSQL = "INSERT INTO dbo.OESBBSSum " +
        //                           "(CustomerCode " +
        //                           ", ProjectCode " +
        //                           ", SSNNo " +
        //                           ", JobID " +
        //                           ", BBSID " +
        //                           ", PONo " +
        //                           ", BBSNo " +
        //                           ", BBSDesc " +
        //                           ", WBS1 " +
        //                           ", WBS2 " +
        //                           ", WBS3 " +
        //                           ", STElement " +
        //                           ", PODate " +
        //                           ", RequiredDate " +
        //                           ", DeliveryDate " +
        //                           ", CABOrderWT " +
        //                           ", CABDeliveryWT " +
        //                           ", SBOrderWT " +
        //                           ", SBDeliveryWT " +
        //                           ", MESHOrderWT " +
        //                           ", MESHDeliveryWT " +
        //                           ", CAGEOrderWT " +
        //                           ", CAGEDeliveryWT " +
        //                           ", SONo " +
        //                           ", Remarks) " +
        //                           "VALUES " +
        //                           "('" + CustomerCode + "' " +
        //                           ",'" + ProjectCode + "' " +
        //                           "," + lSSNNo.ToString() + " " +
        //                           "," + lJobID.ToString() + " " +
        //                           "," + lBBSID.ToString() + " " +
        //                           ",'" + lPONo + "' " +
        //                           ",'" + lBBSNo + "' " +
        //                           ",'" + lBBSDesc + "' " +
        //                           ",'" + lWBS1 + "' " +
        //                           ",'" + lWBS2 + "' " +
        //                           ",'" + lWBS3 + "' " +
        //                           ",'" + lStEle + "' " +
        //                           ",'" + lPODate + "' " +
        //                           ",'" + lReqDate + "' " +
        //                           ",null " +
        //                           "," + lCABPOQty.ToString() + " " +
        //                           "," + lCABDelQty.ToString() + " " +
        //                           "," + lSBPOQty.ToString() + " " +
        //                           "," + lSBDelQty.ToString() + " " +
        //                           ",0" +
        //                           ",0 " +
        //                           ",0" +
        //                           ",0 " +
        //                           ",'" + lSONo + "' " +
        //                           ",'" + lRemarks + "') ";

        //                           lCmd = new SqlCommand();
        //                           lCmd.CommandText = lSQL;
        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandTimeout = 300;
        //                           lCmd.ExecuteNonQuery();
        //                       }
        //                   }
        //                   lSQL = "UPDATE dbo.OESProject SET SumUpdatedDate = getDate() " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' ";

        //                   lCmd = new SqlCommand();
        //                   lCmd.CommandText = lSQL;
        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lCmd.ExecuteNonQuery();
        //               }

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               lProcessObj.CloseCISConnection(ref lCISCon);
        //           }

        //           lProcessObj = null;
        //           lCmd = null;
        //           lRst = null;
        //           lNDSCon = null;

        //           lOraCmd = null;
        //           lOraRst = null;
        //           lCISCon = null;
        //           return lReturn;
        //       }

        //       //Check duplicated BBS No
        [HttpPost]
        [Route("/checkBBSNo")]
        public ActionResult checkBBSNo([FromBody]CheckBBSNoDto checkBBSNoDto)
        {
            string CustomerCode = checkBBSNoDto.CustomerCode;
            string ProjectCode = checkBBSNoDto.ProjectCode;
            int JobID = checkBBSNoDto.JobID;
            string BBSNo = checkBBSNoDto.BBSNo;
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            var lReturn = "";
            var lBBSNoVar = "";
            if (BBSNo != null && ProjectCode != null)
            {
                if (BBSNo.Length > 0 && ProjectCode.Length > 0)
                {
                    var lBBSNo = "'" + BBSNo.Replace(",", "','") + "'";
                    //lCmd.CommandText =
                    //    "select vchGroupMarkingName from dbo.GroupMarkingDetails G , " +
                    //    "dbo.SELevelDetails S, " +
                    //    "dbo.ProjectMaster P, " +
                    //    "dbo.ProductTypeMaster T " +
                    //    "WHERE G.intGroupMarkId = S.intGroupMarkId " +
                    //    "AND S.sitProductTypeId = T.sitProductTypeID " +
                    //    "AND G.intProjectId = P.intProjectId " +
                    //    "AND vchProductType = 'CAB' " +
                    //    "AND vchProjectCode = '" + ProjectCode + "' " +
                    //    "AND vchGroupMarkingName in (" + lBBSNo + ") ";

                    lCmd.CommandText = "SELECT BBS_NO " +
                    "FROM dbo.SAP_REQUEST_DETAILS D, dbo.SAP_REQUEST_HDR H " +
                    "WHERE D.ORD_REQ_NO = H.ORD_REQ_NO " +
                    "AND H.PROJ_ID = '" + ProjectCode + "' " +
                    "AND BBS_NO in (" + lBBSNo + ") " +
                    "AND D.PROD_TYPE = 'CAB' " +
                    "AND D.STATUS <> 'X' " +
                    "AND H.STATUS <> 'X' ";

                    var lProcessObj = new ProcessController();
                    if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                    {
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            while (lRst.Read())
                            {
                                lBBSNoVar = lRst.GetString(0);
                                lBBSNoVar = lBBSNoVar.Trim();
                                if (lReturn == "") lReturn = lBBSNoVar;
                                else lReturn = lReturn + "," + lBBSNoVar;
                            }
                        }
                        lRst.Close();

                        if (lReturn == "")
                        {
                            lCmd = new SqlCommand();
                            lCmd.CommandText =
                                "SELECT BBSNo " +
                                "FROM dbo.OESBBS B, dbo.OESJobAdvice J " +
                                "WHERE B.CustomerCode = '" + CustomerCode + "' " +
                                "AND B.ProjectCode = '" + ProjectCode + "' " +
                                "AND J.CustomerCode = '" + CustomerCode + "' " +
                                "AND J.ProjectCode = '" + ProjectCode + "' " +
                                "AND B.JobID = J.JobID " +
                                "AND J.OrderStatus = 'Submitted' " +
                                "AND B.JobID <> " + JobID + " " +
                                "AND B.BBSNo in (" + lBBSNo + ") " +
                                "AND B.BBSNo is not null ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                while (lRst.Read())
                                {
                                    lBBSNoVar = lRst.GetString(0);
                                    lBBSNoVar = lBBSNoVar.Trim();
                                    if (lReturn == "") lReturn = lBBSNoVar;
                                    else lReturn = lReturn + "," + lBBSNoVar;
                                }
                            }
                            lRst.Close();
                        }

                        if (lReturn == "")
                        {
                            int lOrderNumber = 0;

                            lCmd = new SqlCommand();
                            lCmd.CommandText =
                                "SELECT J.OrderNumber " +
                                "FROM  dbo.OESBBS B, dbo.OESProjOrder J, dbo.OESProjOrdersSE S " +
                                "WHERE B.CustomerCode = '" + CustomerCode + "' " +
                                "AND B.ProjectCode = '" + ProjectCode + "' " +
                                "AND J.CustomerCode = '" + CustomerCode + "' " +
                                "AND J.ProjectCode = '" + ProjectCode + "' " +
                                "AND J.OrderNumber = S.OrderNumber " +
                                "AND B.JobID = S.CABJobID " +
                                "AND B.JobID = " + JobID + " " +
                                "AND B.BBSNo in (" + lBBSNo + ") " +
                                "AND B.BBSNo is not null ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                if (lRst.Read())
                                {
                                    lOrderNumber = lRst.GetInt32(0);
                                }
                            }
                            lRst.Close();

                            lCmd = new SqlCommand();

                            lCmd.CommandText =
                                "SELECT B.BBSNo " +
                                "FROM  dbo.OESBBS B, dbo.OESProjOrder J, dbo.OESProjOrdersSE S " +
                                "WHERE B.CustomerCode = '" + CustomerCode + "' " +
                                "AND B.ProjectCode = '" + ProjectCode + "' " +
                                "AND J.CustomerCode = '" + CustomerCode + "' " +
                                "AND J.ProjectCode = '" + ProjectCode + "' " +
                                "AND J.OrderNumber = S.OrderNumber " +
                                "AND J.OrderNumber = " + lOrderNumber.ToString() + " " +
                                "AND B.JobID = S.CABJobID " +
                                "AND B.JobID <> " + JobID + " " +
                                "AND B.BBSNo in (" + lBBSNo + ") " +
                                "AND B.BBSNo is not null ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                while (lRst.Read())
                                {
                                    lBBSNoVar = lRst.GetString(0);
                                    lBBSNoVar = lBBSNoVar.Trim();
                                    if (lReturn == "") lReturn = lBBSNoVar;
                                    else lReturn = lReturn + "," + lBBSNoVar;
                                }
                            }
                            lRst.Close();
                        }
                        lProcessObj.CloseNDSConnection(ref lNDSCon);
                    }
                    lProcessObj = null;
                }

                if (lReturn == "")
                {
                    var laBBSNo = BBSNo.Split(',');
                    if (laBBSNo.Length > 1)
                    {
                        for (int i = 0; i < laBBSNo.Length - 1; i++)
                        {
                            for (int j = i + 1; j < laBBSNo.Length; j++)
                            {
                                if (laBBSNo[i] == laBBSNo[j])
                                {
                                    if (lReturn == "") lReturn = laBBSNo[i];
                                    else lReturn = lReturn + "," + laBBSNo[i];
                                }
                            }
                        }
                    }

                }

            }
            lCmd = null;
            lNDSCon = null;
            lRst = null;

            return Json(new { value = lReturn });
        }


        //       //generate BBS ID
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult setDoubleCapture(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        //       {
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           int lSeccess = 0;
        //           var lErrorMsg = "";
        //           var lSQL = "";

        //           lSeccess = 1;

        //           try
        //           {

        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //               {
        //                   int lFound = 0;
        //                   lSQL = "SELECT COUNT(*) " +
        //                   "FROM dbo.OESOrderDetailsDouble " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID.ToString() + " " +
        //                   "AND BBSID = " + BBSID.ToString() + " ";

        //                   lCmd = new SqlCommand(lSQL, lNDSCon);
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       while (lRst.Read())
        //                       {
        //                           lFound = lRst.GetInt32(0);
        //                       }
        //                   }
        //                   lRst.Close();

        //                   if (lFound > 0)
        //                   {
        //                       lSQL = "SELECT * INTO #OESOrderTemp " +
        //                       "FROM dbo.OESOrderDetailsDouble " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " ";

        //                       lCmd = new SqlCommand(lSQL, lNDSCon);
        //                       lCmd.CommandTimeout = 300;
        //                       lCmd.ExecuteNonQuery();

        //                       lSQL = "DELETE " +
        //                       "FROM dbo.OESOrderDetailsDouble " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " ";

        //                       lCmd = new SqlCommand(lSQL, lNDSCon);
        //                       lCmd.CommandTimeout = 300;
        //                       lCmd.ExecuteNonQuery();

        //                   }

        //                   lSQL = "INSERT INTO dbo.OESOrderDetailsDouble " +
        //                   "(CustomerCode " +
        //                   ", ProjectCode " +
        //                   ", JobID " +
        //                   ", BBSID " +
        //                   ", BarID " +
        //                   ", BarSort " +
        //                   ", Cancelled " +
        //                   ", BarCAB " +
        //                   ", BarSTD " +
        //                   ", ElementMark " +
        //                   ", BarMark " +
        //                   ", BarType " +
        //                   ", BarSize " +
        //                   ", BarMemberQty " +
        //                   ", BarEachQty " +
        //                   ", BarTotalQty " +
        //                   ", BarShapeCode " +
        //                   ", A " +
        //                   ", B " +
        //                   ", C " +
        //                   ", D " +
        //                   ", E " +
        //                   ", F " +
        //                   ", G " +
        //                   ", H " +
        //                   ", I " +
        //                   ", J " +
        //                   ", K " +
        //                   ", L " +
        //                   ", M " +
        //                   ", N " +
        //                   ", O " +
        //                   ", P " +
        //                   ", Q " +
        //                   ", R " +
        //                   ", S " +
        //                   ", T " +
        //                   ", U " +
        //                   ", V " +
        //                   ", W " +
        //                   ", X " +
        //                   ", Y " +
        //                   ", Z " +
        //                   ", A2 " +
        //                   ", B2 " +
        //                   ", C2 " +
        //                   ", D2 " +
        //                   ", E2 " +
        //                   ", F2 " +
        //                   ", G2 " +
        //                   ", H2 " +
        //                   ", I2 " +
        //                   ", J2 " +
        //                   ", K2 " +
        //                   ", L2 " +
        //                   ", M2 " +
        //                   ", N2 " +
        //                   ", O2 " +
        //                   ", P2 " +
        //                   ", Q2 " +
        //                   ", R2 " +
        //                   ", S2 " +
        //                   ", T2 " +
        //                   ", U2 " +
        //                   ", V2 " +
        //                   ", W2 " +
        //                   ", X2 " +
        //                   ", Y2 " +
        //                   ", Z2 " +
        //                   ", BarLength " +
        //                   ", BarLength2 " +
        //                   ", BarWeight " +
        //                   ", Remarks " +
        //                   ", shapeTransport " +
        //                   ", PinSize " +
        //                   ", TeklaGUID " +
        //                   ", PartGUID " +
        //                   ", UpdateDate " +
        //                   ", UpdateBy " +
        //                   ", CreateDate " +
        //                   ", CreateBy ) " +
        //                   "SELECT CustomerCode " +
        //                   ", ProjectCode " +
        //                   ", JobID " +
        //                   ", BBSID " +
        //                   ", BarID " +
        //                   ", BarSort " +
        //                   ", Cancelled " +
        //                   ", BarCAB " +
        //                   ", BarSTD " +
        //                   ", ElementMark " +
        //                   ", BarMark " +
        //                   ", BarType " +
        //                   ", BarSize " +
        //                   ", BarMemberQty " +
        //                   ", BarEachQty " +
        //                   ", BarTotalQty " +
        //                   ", BarShapeCode " +
        //                   ", A " +
        //                   ", B " +
        //                   ", C " +
        //                   ", D " +
        //                   ", E " +
        //                   ", F " +
        //                   ", G " +
        //                   ", H " +
        //                   ", I " +
        //                   ", J " +
        //                   ", K " +
        //                   ", L " +
        //                   ", M " +
        //                   ", N " +
        //                   ", O " +
        //                   ", P " +
        //                   ", Q " +
        //                   ", R " +
        //                   ", S " +
        //                   ", T " +
        //                   ", U " +
        //                   ", V " +
        //                   ", W " +
        //                   ", X " +
        //                   ", Y " +
        //                   ", Z " +
        //                   ", A2 " +
        //                   ", B2 " +
        //                   ", C2 " +
        //                   ", D2 " +
        //                   ", E2 " +
        //                   ", F2 " +
        //                   ", G2 " +
        //                   ", H2 " +
        //                   ", I2 " +
        //                   ", J2 " +
        //                   ", K2 " +
        //                   ", L2 " +
        //                   ", M2 " +
        //                   ", N2 " +
        //                   ", O2 " +
        //                   ", P2 " +
        //                   ", Q2 " +
        //                   ", R2 " +
        //                   ", S2 " +
        //                   ", T2 " +
        //                   ", U2 " +
        //                   ", V2 " +
        //                   ", W2 " +
        //                   ", X2 " +
        //                   ", Y2 " +
        //                   ", Z2 " +
        //                   ", BarLength " +
        //                   ", BarLength2 " +
        //                   ", BarWeight " +
        //                   ", Remarks " +
        //                   ", shapeTransport " +
        //                   ", PinSize " +
        //                   ", TeklaGUID " +
        //                   ", PartGUID " +
        //                   ", UpdateDate " +
        //                   ", UpdateBy " +
        //                   ", CreateDate " +
        //                   ", CreateBy " +
        //                   "FROM dbo.OESOrderDetails " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID.ToString() + " " +
        //                   "AND BBSID = " + BBSID.ToString() + " ";

        //                   lCmd = new SqlCommand(lSQL, lNDSCon);
        //                   lCmd.CommandTimeout = 600;
        //                   lCmd.ExecuteNonQuery();

        //                   lSQL = "DELETE " +
        //                   "FROM dbo.OESOrderDetails " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID.ToString() + " " +
        //                   "AND BBSID = " + BBSID.ToString() + " ";

        //                   lCmd = new SqlCommand(lSQL, lNDSCon);
        //                   lCmd.CommandTimeout = 600;
        //                   lCmd.ExecuteNonQuery();

        //                   if (lFound > 0)
        //                   {
        //                       lSQL = "INSERT INTO dbo.OESOrderDetails " +
        //                       "(CustomerCode " +
        //                       ", ProjectCode " +
        //                       ", JobID " +
        //                       ", BBSID " +
        //                       ", BarID " +
        //                       ", BarSort " +
        //                       ", Cancelled " +
        //                       ", BarCAB " +
        //                       ", BarSTD " +
        //                       ", ElementMark " +
        //                       ", BarMark " +
        //                       ", BarType " +
        //                       ", BarSize " +
        //                       ", BarMemberQty " +
        //                       ", BarEachQty " +
        //                       ", BarTotalQty " +
        //                       ", BarShapeCode " +
        //                       ", A " +
        //                       ", B " +
        //                       ", C " +
        //                       ", D " +
        //                       ", E " +
        //                       ", F " +
        //                       ", G " +
        //                       ", H " +
        //                       ", I " +
        //                       ", J " +
        //                       ", K " +
        //                       ", L " +
        //                       ", M " +
        //                       ", N " +
        //                       ", O " +
        //                       ", P " +
        //                       ", Q " +
        //                       ", R " +
        //                       ", S " +
        //                       ", T " +
        //                       ", U " +
        //                       ", V " +
        //                       ", W " +
        //                       ", X " +
        //                       ", Y " +
        //                       ", Z " +
        //                       ", A2 " +
        //                       ", B2 " +
        //                       ", C2 " +
        //                       ", D2 " +
        //                       ", E2 " +
        //                       ", F2 " +
        //                       ", G2 " +
        //                       ", H2 " +
        //                       ", I2 " +
        //                       ", J2 " +
        //                       ", K2 " +
        //                       ", L2 " +
        //                       ", M2 " +
        //                       ", N2 " +
        //                       ", O2 " +
        //                       ", P2 " +
        //                       ", Q2 " +
        //                       ", R2 " +
        //                       ", S2 " +
        //                       ", T2 " +
        //                       ", U2 " +
        //                       ", V2 " +
        //                       ", W2 " +
        //                       ", X2 " +
        //                       ", Y2 " +
        //                       ", Z2 " +
        //                       ", BarLength " +
        //                       ", BarLength2 " +
        //                       ", BarWeight " +
        //                       ", Remarks " +
        //                       ", shapeTransport " +
        //                       ", PinSize " +
        //                       ", TeklaGUID " +
        //                       ", PartGUID " +
        //                       ", UpdateDate " +
        //                       ", UpdateBy " +
        //                       ", CreateDate " +
        //                       ", CreateBy ) " +
        //                       "SELECT CustomerCode " +
        //                       ", ProjectCode " +
        //                       ", JobID " +
        //                       ", BBSID " +
        //                       ", BarID " +
        //                       ", BarSort " +
        //                       ", Cancelled " +
        //                       ", BarCAB " +
        //                       ", BarSTD " +
        //                       ", ElementMark " +
        //                       ", BarMark " +
        //                       ", BarType " +
        //                       ", BarSize " +
        //                       ", BarMemberQty " +
        //                       ", BarEachQty " +
        //                       ", BarTotalQty " +
        //                       ", BarShapeCode " +
        //                       ", A " +
        //                       ", B " +
        //                       ", C " +
        //                       ", D " +
        //                       ", E " +
        //                       ", F " +
        //                       ", G " +
        //                       ", H " +
        //                       ", I " +
        //                       ", J " +
        //                       ", K " +
        //                       ", L " +
        //                       ", M " +
        //                       ", N " +
        //                       ", O " +
        //                       ", P " +
        //                       ", Q " +
        //                       ", R " +
        //                       ", S " +
        //                       ", T " +
        //                       ", U " +
        //                       ", V " +
        //                       ", W " +
        //                       ", X " +
        //                       ", Y " +
        //                       ", Z " +
        //                       ", A2 " +
        //                       ", B2 " +
        //                       ", C2 " +
        //                       ", D2 " +
        //                       ", E2 " +
        //                       ", F2 " +
        //                       ", G2 " +
        //                       ", H2 " +
        //                       ", I2 " +
        //                       ", J2 " +
        //                       ", K2 " +
        //                       ", L2 " +
        //                       ", M2 " +
        //                       ", N2 " +
        //                       ", O2 " +
        //                       ", P2 " +
        //                       ", Q2 " +
        //                       ", R2 " +
        //                       ", S2 " +
        //                       ", T2 " +
        //                       ", U2 " +
        //                       ", V2 " +
        //                       ", W2 " +
        //                       ", X2 " +
        //                       ", Y2 " +
        //                       ", Z2 " +
        //                       ", BarLength " +
        //                       ", BarLength2 " +
        //                       ", BarWeight " +
        //                       ", Remarks " +
        //                       ", shapeTransport " +
        //                       ", PinSize " +
        //                       ", TeklaGUID " +
        //                       ", PartGUID " +
        //                       ", UpdateDate " +
        //                       ", UpdateBy " +
        //                       ", CreateDate " +
        //                       ", CreateBy " +
        //                       "FROM #OESOrderTemp " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " ";

        //                       lCmd = new SqlCommand(lSQL, lNDSCon);
        //                       lCmd.CommandTimeout = 600;
        //                       lCmd.ExecuteNonQuery();
        //                   }

        //                   lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               }


        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               lSeccess = -1;
        //           }
        //           return Json(lSeccess, JsonRequestBehavior.AllowGet);
        //       }

        //       //generate BBS ID
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult genBBSID(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           var lErrorMsg = "";
        //           int? lBBSID = 1;

        //           try
        //           {
        //               lBBSID = (from p in db.BBS
        //                         where p.CustomerCode == CustomerCode &&
        //                         p.ProjectCode == ProjectCode &&
        //                         p.JobID == JobID
        //                         select p.BBSID).DefaultIfEmpty(0).Max();
        //               if (lBBSID == null)
        //               {
        //                   lBBSID = 1;
        //               }
        //               else
        //               {
        //                   lBBSID = lBBSID + 1;
        //               }

        //               var lBBS = new BBSModels
        //               {
        //                   CustomerCode = CustomerCode,
        //                   ProjectCode = ProjectCode,
        //                   JobID = JobID,
        //                   BBSID = (int)lBBSID,
        //                   BBSNo = "",
        //                   BBSDesc = "",
        //                   BBSCopiedFrom = "",
        //                   BBSStrucElem = "",
        //                   BBSOrderCABWT = 0,
        //                   BBSOrderSTDWT = 0,
        //                   BBSCancelledWT = 0,
        //                   BBSTotalWT = 0,
        //                   BBSSOR = "",
        //                   BBSNoNDS = "",
        //                   UpdateDate = DateTime.Now,
        //                   UpdateBy = User.Identity.GetUserName()
        //               };
        //               db.BBS.Add(lBBS);
        //               db.SaveChanges();

        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //           }
        //           return Json(lBBSID, JsonRequestBehavior.AllowGet);
        //       }

        //       private int checkUpdateBBSWT(string CustomerCode, string ProjectCode, int JobID)
        //       {
        //           int lReturn = 0;
        //           decimal lTotalCABWT = 0;
        //           decimal lTotalSTDWT = 0;
        //           var lBBS = (from p in db.BBS
        //                       where p.CustomerCode == CustomerCode &&
        //                       p.ProjectCode == ProjectCode &&
        //                       p.JobID == JobID
        //                       select p).ToList();

        //           if (lBBS.Count > 0)
        //           {
        //               for (int i = 0; i < lBBS.Count; i++)
        //               {
        //                   int lBBSID = lBBS[i].BBSID;
        //                   var lBBSCABSum = (from p in db.OrderDetails
        //                                     where p.CustomerCode == CustomerCode &&
        //                                     p.ProjectCode == ProjectCode &&
        //                                     p.JobID == JobID &&
        //                                     p.BBSID == lBBSID &&
        //                                     p.BarSTD == null &&
        //                                     p.Cancelled == null
        //                                     select p.BarWeight).Sum();

        //                   lBBSCABSum = lBBSCABSum == null ? 0 : lBBSCABSum;

        //                   var lBBSSBSum = (from p in db.OrderDetails
        //                                    where p.CustomerCode == CustomerCode &&
        //                                    p.ProjectCode == ProjectCode &&
        //                                    p.JobID == JobID &&
        //                                    p.BBSID == lBBSID &&
        //                                    p.BarSTD == true &&
        //                                    p.Cancelled == null
        //                                    select p.BarWeight).Sum();

        //                   lBBSSBSum = lBBSSBSum == null ? 0 : lBBSSBSum;

        //                   lTotalCABWT = lTotalCABWT + (decimal)lBBSCABSum;
        //                   lTotalSTDWT = lTotalSTDWT + (decimal)lBBSSBSum;



        //                   if (lBBSCABSum != lBBS[i].BBSOrderCABWT || lBBSSBSum != lBBS[i].BBSOrderSTDWT)
        //                   {
        //                       var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
        //                       if (oldBBS != null)
        //                       {
        //                           BBSModels lUpdateBBS = oldBBS;
        //                           lUpdateBBS.BBSOrderCABWT = (decimal)lBBSCABSum;
        //                           lUpdateBBS.BBSOrderSTDWT = (decimal)lBBSSBSum;
        //                           lUpdateBBS.BBSTotalWT = (decimal)lBBSCABSum + (decimal)lBBSSBSum;
        //                           lUpdateBBS.BBSCancelledWT = 0;
        //                           db.Entry(oldBBS).CurrentValues.SetValues(lUpdateBBS);
        //                       }
        //                   }
        //               }

        //               var oldJob = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //               if (oldJob != null)
        //               {
        //                   if (lTotalCABWT != oldJob.TotalCABWeight || lTotalSTDWT != oldJob.TotalSTDWeight)
        //                   {
        //                       JobAdviceModels lUpdateJob = oldJob;
        //                       lUpdateJob.TotalCABWeight = lTotalCABWT;
        //                       lUpdateJob.TotalSTDWeight = lTotalSTDWT;
        //                       lUpdateJob.TotalWeight = lTotalCABWT + lTotalSTDWT;
        //                       db.Entry(oldJob).CurrentValues.SetValues(lUpdateJob);
        //                   }
        //               }

        //               db.SaveChanges();

        //           }
        //           return lReturn;
        //       }



        //save BBS
        [HttpPost]
        [Route("/saveBBS_OrderDetails")]

        public ActionResult saveBBS([FromBody] BBSModels bbsModels)
        {
            var lErrorMsg = "";
            bbsModels.UpdateDate = DateTime.Now;
            bbsModels.UpdateBy = bbsModels.UpdateBy;//User.Identity.GetUserName();
                                                    //if (ModelState.IsValid)
                                                    //{
            try
            {
                if (bbsModels.CustomerCode == null)
                {
                    bbsModels.CustomerCode = "";
                }
                if (bbsModels.BBSNo == null)
                {
                    bbsModels.BBSNo = "";
                }
                if (bbsModels.BBSDesc == null)
                {
                    bbsModels.BBSDesc = "";
                }
                bbsModels.BBSNo = bbsModels.BBSNo.ToUpper();
                bbsModels.BBSDesc = bbsModels.BBSDesc.ToUpper();

                var lJobAdv = db.JobAdvice.Find(bbsModels.CustomerCode, bbsModels.ProjectCode, bbsModels.JobID);

                if (bbsModels.CustomerCode.Length > 0 && lJobAdv != null && (lJobAdv.OrderStatus == "Created" || lJobAdv.OrderStatus == "Created*" || lJobAdv.OrderStatus == "Reserved" || lJobAdv.OrderStatus == "New" || lJobAdv.OrderStatus == "Sent" || lJobAdv.OrderStatus == "" || lJobAdv.OrderStatus == null))
                {
                    var oldBBS = db.BBS.Find(bbsModels.CustomerCode, bbsModels.ProjectCode, bbsModels.JobID, bbsModels.BBSID);
                    if (oldBBS == null)
                    {
                        db.BBS.Add(bbsModels);
                    }
                    else
                    {
                        bbsModels.BBSCopiedFrom = oldBBS.BBSCopiedFrom;
                        db.Entry(oldBBS).CurrentValues.SetValues(bbsModels);
                    }
                    db.SaveChanges();

                    return Json(bbsModels);
                }
            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
                return Json(new { success = false, message = lErrorMsg });
            }
            //}
            return View(bbsModels);
        }

        //       //ValidatePONumber
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult ValidatePONumber(string CustomerCode, string ProjectCode, int JobID, string PONumber)
        //       {
        //           var lErrorMsg = "";
        //           try
        //           {
        //               var lListOrder = "";
        //               var lJobAdvice = (from p in db.JobAdvice
        //                                 where p.CustomerCode == CustomerCode &&
        //                                 p.ProjectCode == ProjectCode &&
        //                                 p.JobID != JobID &&
        //                                 p.PONumber == PONumber
        //                                 select p
        //                                      ).ToList();

        //               if (lJobAdvice.Count > 0)
        //               {
        //                   for (int i = 0; i < lJobAdvice.Count; i++)
        //                   {
        //                       if (lListOrder.Length == 0)
        //                       {
        //                           lListOrder = "JobAdvice ID : " + lJobAdvice[i].JobID.ToString();
        //                       }
        //                       else
        //                       {
        //                           lListOrder = lListOrder + ", " + lJobAdvice[i].JobID.ToString();
        //                       }
        //                   }
        //               }

        //               return Json(new { success = true, responseText = lListOrder }, JsonRequestBehavior.AllowGet);
        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               return Json(new { success = false, responseText = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //           }

        //       }

        // Convert CAB products to SB product in the order
        [HttpGet]
        [Route("/setCAB2SB/{CustomerCode}/{ProjectCode}/{JobID}/{UserName}")]
        public ActionResult setCAB2SB(string CustomerCode, string ProjectCode, int JobID, string UserName)
        {
            var lNDSCon = new SqlConnection();
            var lProcessObj = new ProcessController();
            var lErrorMsg = "";
            var lTotalPC = 0;
            Int16[] lDia = { 6, 8, 10, 12, 13, 16, 20, 24, 25, 28, 32, 36, 40, 50 };
            double[] lUnitWT = { 0.222, 0.395, 0.617, 0.888, 1.042, 1.579, 2.466, 3.699, 3.854, 4.834, 6.313, 7.769, 9.864, 15.413 };
            try
            {
                //12m
                var lTypeList = new List<string>();
                var lWTList = new List<double>();
                List<setCAB2Dto> lType = new List<setCAB2Dto>();

                //var lType = (from p in db.OrderDetails
                //             where p.CustomerCode == CustomerCode &&
                //             p.ProjectCode == ProjectCode &&
                //             p.JobID == JobID &&
                //             p.BarShapeCode == "020" &&
                //             p.A == 12000 &&
                //             p.BarSTD == null &&
                //             p.Cancelled == null
                //             group p.BarWeight
                //             by new { p.BarType, p.BarSize }
                //                      into g
                //             where g.Sum() >= 2000
                //             select new
                //             {
                //                 BarType = g.Key,
                //                 SumWeight = g.Sum()
                //             }).ToList();


                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    // Fixed the SQL query - your original was selecting ContractNo but comparing with CONTRACT_NO
                    // Also you were selecting EPD_VALUE but trying to read from two tables
                    //var lSQL =
                        //"select od.BarSize as BarSize, od.BarType as BarType, BarWeight as SumWeight from OESOrderDetails od inner " +
                        //"join OESProdCode pc on od.BarType = pc.BarType and od.BarSize = pc.BarSize " +
                        //"inner join OESStdProdCode spc on pc.ProdCodeSAP = spc.ProdCode " +
                        //"where prodtype like 'BAR12%' and CustomerCode = '" + CustomerCode + "' and ProjectCode = '" + ProjectCode + "' " +
                        //"and JobID = " + JobID + " and BarShapeCode = '020' and(BarWeight >= 2000 OR BarTotalQty >= BundlePcs_fr) GROUP BY  OD.BarType, OD.BarSize";

                    var lSQL = "SELECT OD.BarType, OD.BarSize, SUM(OD.BarWeight) AS SumWeight FROM   OESOrderDetails OD   " +
                        "WHERE  OD.CustomerCode  = '" + CustomerCode + "' AND  OD.ProjectCode = '" + ProjectCode + "'  AND " +
                        "OD.JobID =  " + JobID + "   AND OD.BarShapeCode = '020' AND    OD.A = 12000 AND   OD.BarSTD IS NULL AND " +
                        "OD.Cancelled IS NULL GROUP BY   OD.BarType, OD.BarSize " +
                        "Having SUM(OD.BarWeight)>=2000 or SUM(OD.BarTotalQty)>=(select BundlePcs_fr from OESProdCode " +
                        "where OESProdCode.BarType=od.BarType and OESProdCode.BarSize=od.BarSize and OESProdCode.BarLength=12000);";

                    // Somewhere in your method
                    // List<setCAB2Dto> lType = new List<setCAB2Dto>();

                    using (var lCmd = new SqlCommand(lSQL, lNDSCon))
                    {
                        using (var reader = lCmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                string barType = reader["BarType"].ToString().Trim();
                                string sumWeight = reader["SumWeight"].ToString().Trim();
                                int BarSize = Convert.ToInt32(reader["BarSize"]); // Fix here

                                setSubBarType newobj = new setSubBarType();
                                newobj.BarType = barType;
                                newobj.BarSize = BarSize;

                                setCAB2Dto setCAB2Dto = new setCAB2Dto();
                                setCAB2Dto.BarType = newobj;
                                setCAB2Dto.SumWeight = float.Parse(sumWeight);

                                lType.Add(setCAB2Dto);
                            }
                        }
                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }

                var lBBSContent = (from p in db.BBS
                                   where p.CustomerCode == CustomerCode &&
                                   p.ProjectCode == ProjectCode &&
                                   p.JobID == JobID
                                   select p).ToList();

                if (lType.Count > 0 && lBBSContent.Count > 0)
                {
                    var lBarType = "";
                    Int16 lBarSize = 0;
                    double lWeight = 0;
                    int lSBBundle = 0;
                    int lSBWeight = 0;


                    double lKGM = 0;
                    double lWeightPerPc = 0;

                    //ini for no of new item for BBSs
                    var lNewItemBBS = new int[lBBSContent.Count];
                    // get the records count for all BBS
                    var lCountBBS = new int[lBBSContent.Count];

                    for (int i = 0; i < lNewItemBBS.Length; i++)
                    {
                        lNewItemBBS[i] = 0;
                        var lBBSID = lBBSContent[i].BBSID;

                        int lCount = (from p in db.OrderDetails
                                      where p.CustomerCode == CustomerCode &&
                                      p.ProjectCode == ProjectCode &&
                                      p.JobID == JobID &&
                                      p.BBSID == lBBSID
                                      select p).Count();
                        lCountBBS[i] = lCount;

                        int? lBarIDMax = db.OrderDetails.Where(
                        z => z.CustomerCode == CustomerCode &&
                        z.ProjectCode == ProjectCode &&
                        z.JobID == JobID &&
                        z.BBSID == lBBSID).Max(z => z.BarID);

                        if (lBarIDMax == null)
                        {
                            lBarIDMax = 1;
                        }
                        lNewItemBBS[i] = (int)lBarIDMax + 1;
                    }

                    for (int i = 0; i < lType.Count; i++)
                    {
                        lBarType = lType[i].BarType.BarType;
                        lBarSize = (Int16)lType[i].BarType.BarSize;
                        lWeight = (double)lType[i].SumWeight;

                        var lPCsPB = 0;
                        var lWTPB = 0;

                        var lProdCode = (from p in db.ProdCode
                                         where p.BarType == lBarType &&
                                         p.BarSize == lBarSize &&
                                         p.BarLength == 12000
                                         select p).ToList();
                        if (lProdCode != null && lProdCode.Count > 0)
                        {
                            //lPCsPB = (int)Math.Floor((decimal)(lProdCode[0].BundlePcs + lProdCode[0].BundlePcs_fr)/2);
                            lPCsPB = lProdCode[0].BundlePcs_fr;
                            lWTPB = lProdCode[0].BundleWT;
                        }

                        if (lPCsPB == 0 || lWTPB == 0)
                        {
                            continue;
                        }

                        lTotalPC = 0;


                        // get KG per meter by dia
                        //for (int j = 0; j < lDia.Length; j++)
                        //{
                        //    if (lBarSize == lDia[j])
                        //    {
                        //        lKGM = lUnitWT[j];
                        //        break;
                        //    }
                        //}

                        //get KG per pc
                        //lWeightPerPc = lKGM * 12;

                        lWeightPerPc = (double)lWTPB / lPCsPB;

                        lSBBundle = (int)Math.Floor(lWeight / lWTPB);
                        lSBWeight = lSBBundle * lWTPB;
                        double lSBOffset = 0;
                        int lLastBBSID = 0;
                        int lLastBBSSN = 0;

                        for (int j = 0; j < lBBSContent.Count; j++)
                        {
                            var lBBSID = lBBSContent[j].BBSID;

                            var lBBSDetails = (from p in db.OrderDetails
                                               where p.CustomerCode == CustomerCode &&
                                               p.ProjectCode == ProjectCode &&
                                               p.JobID == JobID &&
                                               p.BBSID == lBBSID &&
                                               p.BarType == lBarType &&
                                               p.BarSize == lBarSize &&
                                               p.BarShapeCode == "020" &&
                                               p.A == 12000 &&
                                               p.BarSTD == null &&
                                               p.Cancelled == null
                                               select p).ToList();
                            if (lBBSDetails.Count > 0)
                            {

                                lLastBBSID = lBBSID;

                                for (int k = 0; k < lBBSDetails.Count; k++)
                                {
                                    if (lSBOffset + (double)lBBSDetails[k].BarWeight <= lSBWeight)
                                    {
                                        //whole item convert to SB
                                        lSBOffset = lSBOffset + (double)lBBSDetails[k].BarWeight;
                                        lTotalPC = lTotalPC + (int)(lBBSDetails[k].BarTotalQty == null ? 0 : lBBSDetails[k].BarTotalQty);

                                        OrderDetailsModels lDetailUpdate = lBBSDetails[k];
                                        //lDetailUpdate.BarSTD = true;
                                        lDetailUpdate.Cancelled = true;
                                        db.Entry(lBBSDetails[k]).CurrentValues.SetValues(lDetailUpdate);

                                        lLastBBSID = lBBSID;
                                        lLastBBSSN = j;
                                    }
                                    else
                                    {
                                        //Partial convert to SB
                                        //split the item
                                        if (lSBOffset + lWeightPerPc <= lSBWeight)
                                        {
                                            int lBBSBundle = (int)Math.Floor((lSBOffset + (double)lBBSDetails[k].BarWeight) / lWTPB);
                                            int lBBSWeight = lBBSBundle * lWTPB;
                                            //int lPieces = (lTotalPC + (int)lBBSDetails[k].BarTotalQty - lBBSBundle * (int)Math.Round(lWTPB / lWeightPerPc));
                                            int lPieces = (lTotalPC + (int)lBBSDetails[k].BarTotalQty - lBBSBundle * lPCsPB);
                                            if (lPieces >= 0)
                                            {
                                                //original -- change qty, wt
                                                OrderDetailsModels lDetailUpdate = lBBSDetails[k];
                                                //lDetailUpdate.BarSTD = true;
                                                lDetailUpdate.Cancelled = true;
                                                db.Entry(lBBSDetails[k]).CurrentValues.SetValues(lDetailUpdate);

                                                lLastBBSID = lBBSID;
                                                lLastBBSSN = j;

                                                if (lPieces > 0)
                                                {
                                                    //new added SB sort number is same as above
                                                    var lBarSort = lBBSDetails[k].BarSort;
                                                    double? lNextSortNo = (from p in db.OrderDetails
                                                                           where p.CustomerCode == CustomerCode &&
                                                                           p.ProjectCode == ProjectCode &&
                                                                           p.JobID == JobID &&
                                                                           p.BBSID == lBBSID &&
                                                                           p.BarSort > lBarSort
                                                                           select p.BarSort).DefaultIfEmpty(0).Min();
                                                    if (lNextSortNo == null)
                                                    {
                                                        lNextSortNo = 0;
                                                    }
                                                    if (lNextSortNo == 0)
                                                    {
                                                        lNextSortNo = lBBSDetails[k].BarSort + 1000;
                                                    }
                                                    else
                                                    {
                                                        lNextSortNo = (lBBSDetails[k].BarSort + lNextSortNo) / 2;
                                                    }

                                                    var lDetailAdd = new OrderDetailsModels
                                                    {
                                                        CustomerCode = CustomerCode,
                                                        ProjectCode = ProjectCode,
                                                        JobID = JobID,
                                                        BBSID = lBBSID,
                                                        BarID = lNewItemBBS[j],
                                                        BarSort = (double)lNextSortNo,
                                                        Cancelled = null,
                                                        BarCAB = lDetailUpdate.BarCAB,
                                                        BarSTD = lDetailUpdate.BarSTD,
                                                        ElementMark = lDetailUpdate.ElementMark,
                                                        BarMark = lDetailUpdate.BarMark,
                                                        BarType = lBarType,
                                                        BarSize = lBarSize,
                                                        BarMemberQty = lPieces,
                                                        BarEachQty = 1,
                                                        BarTotalQty = lPieces,
                                                        BarShapeCode = "020",
                                                        A = 12000,
                                                        BarLength = 12000,
                                                        BarWeight = (decimal?)Math.Round(lPieces * lWeightPerPc, 3),
                                                        shapeTransport = lDetailUpdate.shapeTransport,
                                                        UpdateDate = DateTime.Now,
                                                        UpdateBy = UserName,//User.Identity.GetUserName(),
                                                        CreateDate = DateTime.Now,
                                                        CreateBy = UserName//User.Identity.GetUserName()
                                                    };
                                                    db.OrderDetails.Add(lDetailAdd);

                                                    lLastBBSID = lBBSID;
                                                    lLastBBSSN = j;
                                                }

                                                lSBOffset = lSBOffset + (int)lBBSDetails[k].BarWeight - lPieces * lWeightPerPc;
                                                //No of New Item added for the BBS
                                                lNewItemBBS[j] = lNewItemBBS[j] + 1;
                                            }
                                        }
                                    }
                                }

                            }
                        }

                        //add the SB to 
                        //if (lSBOffset >= (lWTPB - lWeightPerPc))
                        if (lSBOffset > 0)
                        {
                            if (lLastBBSID == 0)
                            {
                                lLastBBSID = 1;
                            }

                            int lBBSBundle = (int)Math.Round(lSBOffset / lWTPB);
                            int lBBSWeight = lBBSBundle * lWTPB;

                            lSBOffset = lSBOffset - lBBSWeight;
                            lSBWeight = lSBWeight - lBBSWeight;
                            lSBBundle = lSBBundle - lBBSBundle;

                            var lBBSSBNew = new OrderDetailsModels
                            {
                                CustomerCode = CustomerCode,
                                ProjectCode = ProjectCode,
                                JobID = JobID,
                                BBSID = lLastBBSID,
                                BarID = lNewItemBBS[lLastBBSSN],
                                BarSort = (lCountBBS[lLastBBSSN] + lNewItemBBS[lLastBBSSN] + 1) * 1000,
                                Cancelled = null,
                                BarCAB = null,
                                BarSTD = true,
                                ElementMark = null,
                                BarMark = "SB-" + lBarSize.ToString(),
                                BarType = lBarType,
                                BarSize = lBarSize,
                                BarMemberQty = lBBSBundle,
                                BarEachQty = (int)Math.Round(lWTPB / lWeightPerPc),
                                BarTotalQty = lBBSBundle * (int)Math.Round(lWTPB / lWeightPerPc),
                                BarShapeCode = "020",
                                A = 12000,
                                BarLength = 12000,
                                //BarWeight = lBBSWeight,
                                BarWeight = lBBSBundle * 2000,
                                shapeTransport = 0,
                                UpdateDate = DateTime.Now,
                                UpdateBy = UserName,//User.Identity.GetUserName(),
                                CreateDate = DateTime.Now,
                                CreateBy = UserName//User.Identity.GetUserName()
                            };

                            db.OrderDetails.Add(lBBSSBNew);
                            //No of New Item added for the BBS
                            lNewItemBBS[lLastBBSSN] = lNewItemBBS[lLastBBSSN] + 1;
                        }

                    }
                    db.SaveChanges();
                }

                //14m
                lTypeList = new List<string>();
                lWTList = new List<double>();


                //lType = (from p in db.OrderDetails
                //         where p.CustomerCode == CustomerCode &&
                //         p.ProjectCode == ProjectCode &&
                //         p.JobID == JobID &&
                //         p.BarShapeCode == "020" &&
                //         p.A == 14000 &&
                //         p.BarSTD == null &&
                //         p.Cancelled == null
                //         group p.BarWeight
                //         by new { p.BarType, p.BarSize }
                //                      into g
                //         where g.Sum() >= 2000
                //         select new
                //         {
                //             BarType = g.Key,
                //             SumWeight = g.Sum()
                //         }).ToList();


                string BarType = "";
                int SumWeight = 0;


                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    // Fixed the SQL query - your original was selecting ContractNo but comparing with CONTRACT_NO
                    // Also you were selecting EPD_VALUE but trying to read from two tables
                    //var lSQL =

                        //"select od.BarSize as BarSize, od.BarType as BarType, BarWeight as SumWeight from OESOrderDetails od inner " +
                        // "join OESProdCode pc on od.BarType = pc.BarType and od.BarSize = pc.BarSize " +
                        // "inner join OESStdProdCode spc on pc.ProdCodeSAP = spc.ProdCode " +
                        // "where prodtype like 'BAR12%' and CustomerCode = '" + CustomerCode + "' and ProjectCode = '" + ProjectCode + "' " +
                        // "and JobID = " + JobID + " and BarShapeCode = '020' and(BarWeight >= 2000 OR BarTotalQty >= BundlePcs_fr) GROUP BY  OD.BarType, OD.BarSize";

                    var lSQL = "SELECT OD.BarType, OD.BarSize, SUM(OD.BarWeight) AS SumWeight FROM   OESOrderDetails OD   " +
             "WHERE  OD.CustomerCode  = '" + CustomerCode + "' AND  OD.ProjectCode = '" + ProjectCode + "'  AND " +
             "OD.JobID =  " + JobID + "   AND OD.BarShapeCode = '020' AND    OD.A = 14000 AND   OD.BarSTD IS NULL AND " +
             "OD.Cancelled IS NULL GROUP BY   OD.BarType, OD.BarSize " +
             "Having SUM(OD.BarWeight)>=2000 or SUM(OD.BarTotalQty)>=(select BundlePcs_fr from OESProdCode " +
             "where OESProdCode.BarType=od.BarType and OESProdCode.BarSize=od.BarSize and OESProdCode.BarLength=14000);";

                    // Somewhere in your method
                    // List<setCAB2Dto> lType = new List<setCAB2Dto>();
                    lType.Clear();
                    using (var lCmd = new SqlCommand(lSQL, lNDSCon))
                    {
                        using (var reader = lCmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                string barType = reader["BarType"].ToString().Trim();
                                string sumWeight = reader["SumWeight"].ToString().Trim();
                                int BarSize = Convert.ToInt32(reader["BarSize"]); // Fix here

                                setSubBarType newobj = new setSubBarType();
                                newobj.BarType = barType;
                                newobj.BarSize = BarSize;

                                setCAB2Dto setCAB2Dto = new setCAB2Dto();
                                setCAB2Dto.BarType = newobj;
                                setCAB2Dto.SumWeight = float.Parse(sumWeight);

                                lType.Add(setCAB2Dto);
                            }
                        }
                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);

                }



                lBBSContent = (from p in db.BBS
                               where p.CustomerCode == CustomerCode &&
                               p.ProjectCode == ProjectCode &&
                               p.JobID == JobID
                               select p).ToList();

                if (lType.Count > 0 && lBBSContent.Count > 0)
                {
                    var lBarType = "";
                    Int16 lBarSize = 0;
                    double lWeight = 0;
                    int lSBBundle = 0;
                    int lSBWeight = 0;


                    double lKGM = 0;
                    double lWeightPerPc = 0;

                    //ini for no of new item for BBSs
                    var lNewItemBBS = new int[lBBSContent.Count];
                    // get the records count for all BBS
                    var lCountBBS = new int[lBBSContent.Count];

                    for (int i = 0; i < lNewItemBBS.Length; i++)
                    {
                        lNewItemBBS[i] = 0;
                        var lBBSID = lBBSContent[i].BBSID;

                        int lCount = (from p in db.OrderDetails
                                      where p.CustomerCode == CustomerCode &&
                                      p.ProjectCode == ProjectCode &&
                                      p.JobID == JobID &&
                                      p.BBSID == lBBSID
                                      select p).Count();
                        lCountBBS[i] = lCount;

                        int? lBarIDMax = db.OrderDetails.Where(
                        z => z.CustomerCode == CustomerCode &&
                        z.ProjectCode == ProjectCode &&
                        z.JobID == JobID &&
                        z.BBSID == lBBSID).Max(z => z.BarID);

                        if (lBarIDMax == null)
                        {
                            lBarIDMax = 1;
                        }
                        lNewItemBBS[i] = (int)lBarIDMax + 1;
                    }

                    for (int i = 0; i < lType.Count; i++)
                    {
                        lBarType = lType[i].BarType.BarType;
                        lBarSize = (Int16)lType[i].BarType.BarSize;
                        lWeight = (double)lType[i].SumWeight;

                        var lPCsPB = 0;
                        var lWTPB = 0;

                        var lProdCode = (from p in db.ProdCode
                                         where p.BarType == lBarType &&
                                         p.BarSize == lBarSize &&
                                         p.BarLength == 14000
                                         select p).ToList();
                        if (lProdCode != null && lProdCode.Count > 0)
                        {
                            //lPCsPB = (int)Math.Floor((decimal)(lProdCode[0].BundlePcs + lProdCode[0].BundlePcs_fr)/2);
                            lPCsPB = lProdCode[0].BundlePcs_fr;
                            lWTPB = lProdCode[0].BundleWT;
                        }

                        if (lPCsPB == 0 || lWTPB == 0)
                        {
                            continue;
                        }

                        lTotalPC = 0;


                        // get KG per meter by dia
                        //for (int j = 0; j < lDia.Length; j++)
                        //{
                        //    if (lBarSize == lDia[j])
                        //    {
                        //        lKGM = lUnitWT[j];
                        //        break;
                        //    }
                        //}

                        //get KG per pc
                        //lWeightPerPc = lKGM * 12;

                        lWeightPerPc = (double)lWTPB / lPCsPB;

                        lSBBundle = (int)Math.Floor(lWeight / lWTPB);
                        lSBWeight = lSBBundle * lWTPB;
                        double lSBOffset = 0;

                        for (int j = 0; j < lBBSContent.Count; j++)
                        {
                            var lBBSID = lBBSContent[j].BBSID;


                            var lBBSDetails = (from p in db.OrderDetails
                                               where p.CustomerCode == CustomerCode &&
                                               p.ProjectCode == ProjectCode &&
                                               p.JobID == JobID &&
                                               p.BBSID == lBBSID &&
                                               p.BarType == lBarType &&
                                               p.BarSize == lBarSize &&
                                               p.BarShapeCode == "020" &&
                                               p.A == 14000 &&
                                               p.BarSTD == null &&
                                               p.Cancelled == null
                                               select p).ToList();
                            if (lBBSDetails.Count > 0)
                            {
                                for (int k = 0; k < lBBSDetails.Count; k++)
                                {
                                    if (lSBOffset + (double)lBBSDetails[k].BarWeight <= lSBWeight)
                                    {
                                        //whole item convert to SB
                                        lSBOffset = lSBOffset + (double)lBBSDetails[k].BarWeight;
                                        lTotalPC = lTotalPC + (int)(lBBSDetails[k].BarTotalQty == null ? 0 : lBBSDetails[k].BarTotalQty);

                                        OrderDetailsModels lDetailUpdate = lBBSDetails[k];
                                        //lDetailUpdate.BarSTD = true;
                                        lDetailUpdate.Cancelled = true;
                                        db.Entry(lBBSDetails[k]).CurrentValues.SetValues(lDetailUpdate);
                                    }
                                    else
                                    {
                                        //Partial convert to SB
                                        //split the item
                                        if (lSBOffset + lWeightPerPc <= lSBWeight)
                                        {
                                            int lBBSBundle = (int)Math.Floor((lSBOffset + (double)lBBSDetails[k].BarWeight) / lWTPB);
                                            int lBBSWeight = lBBSBundle * lWTPB;
                                            //int lPieces = (lTotalPC + (int)lBBSDetails[k].BarTotalQty - lBBSBundle * (int)Math.Round(lWTPB / lWeightPerPc));
                                            int lPieces = (lTotalPC + (int)lBBSDetails[k].BarTotalQty - lBBSBundle * lPCsPB);
                                            if (lPieces >= 0)
                                            {
                                                //original -- change qty, wt
                                                OrderDetailsModels lDetailUpdate = lBBSDetails[k];
                                                //lDetailUpdate.BarSTD = true;
                                                lDetailUpdate.Cancelled = true;
                                                db.Entry(lBBSDetails[k]).CurrentValues.SetValues(lDetailUpdate);

                                                if (lPieces > 0)
                                                {
                                                    //new added SB sort number is same as above
                                                    var lBarSort = lBBSDetails[k].BarSort;
                                                    double? lNextSortNo = (from p in db.OrderDetails
                                                                           where p.CustomerCode == CustomerCode &&
                                                                           p.ProjectCode == ProjectCode &&
                                                                           p.JobID == JobID &&
                                                                           p.BBSID == lBBSID &&
                                                                           p.BarSort > lBarSort
                                                                           select p.BarSort).DefaultIfEmpty(0).Min();
                                                    if (lNextSortNo == null)
                                                    {
                                                        lNextSortNo = 0;
                                                    }
                                                    if (lNextSortNo == 0)
                                                    {
                                                        lNextSortNo = lBBSDetails[k].BarSort + 1000;
                                                    }
                                                    else
                                                    {
                                                        lNextSortNo = (lBBSDetails[k].BarSort + lNextSortNo) / 2;

                                                    }

                                                    var lDetailAdd = new OrderDetailsModels
                                                    {
                                                        CustomerCode = CustomerCode,
                                                        ProjectCode = ProjectCode,
                                                        JobID = JobID,
                                                        BBSID = lBBSID,
                                                        BarID = lNewItemBBS[j],
                                                        BarSort = (double)lNextSortNo,
                                                        Cancelled = null,
                                                        BarCAB = lDetailUpdate.BarCAB,
                                                        BarSTD = lDetailUpdate.BarSTD,
                                                        ElementMark = lDetailUpdate.ElementMark,
                                                        BarMark = lDetailUpdate.BarMark,
                                                        BarType = lBarType,
                                                        BarSize = lBarSize,
                                                        BarMemberQty = lPieces,
                                                        BarEachQty = 1,
                                                        BarTotalQty = lPieces,
                                                        BarShapeCode = "020",
                                                        A = 14000,
                                                        BarLength = 14000,
                                                        BarWeight = (decimal?)Math.Round(lPieces * lWeightPerPc, 3),
                                                        shapeTransport = lDetailUpdate.shapeTransport,
                                                        UpdateDate = DateTime.Now,
                                                        UpdateBy = UserName,//User.Identity.GetUserName(),
                                                        CreateDate = DateTime.Now,
                                                        CreateBy = UserName//User.Identity.GetUserName()
                                                    };
                                                    db.OrderDetails.Add(lDetailAdd);
                                                }

                                                lSBOffset = lSBOffset + (int)lBBSDetails[k].BarWeight - lPieces * lWeightPerPc;
                                                //No of New Item added for the BBS
                                                lNewItemBBS[j] = lNewItemBBS[j] + 1;
                                            }
                                        }
                                    }
                                }

                                //add the SB to 
                                //if (lSBOffset >= (lWTPB - lWeightPerPc))
                                if (lSBOffset >= lWTPB || lSBOffset >= 2000)
                                {
                                    int lBBSBundle = (int)Math.Round(lSBOffset / lWTPB);
                                    int lBBSWeight = lBBSBundle * lWTPB;

                                    lSBOffset = lSBOffset - lBBSWeight;
                                    lSBWeight = lSBWeight - lBBSWeight;
                                    lSBBundle = lSBBundle - lBBSBundle;

                                    var lBBSSBNew = new OrderDetailsModels
                                    {
                                        CustomerCode = CustomerCode,
                                        ProjectCode = ProjectCode,
                                        JobID = JobID,
                                        BBSID = lBBSID,
                                        BarID = lNewItemBBS[j],
                                        BarSort = (lCountBBS[j] + lNewItemBBS[j] + 1) * 1000,
                                        Cancelled = null,
                                        BarCAB = null,
                                        BarSTD = true,
                                        ElementMark = null,
                                        BarMark = "SB-" + lBarSize.ToString(),
                                        BarType = lBarType,
                                        BarSize = lBarSize,
                                        BarMemberQty = lBBSBundle,
                                        BarEachQty = (int)Math.Round(lWTPB / lWeightPerPc),
                                        BarTotalQty = lBBSBundle * (int)Math.Round(lWTPB / lWeightPerPc),
                                        BarShapeCode = "020",
                                        A = 14000,
                                        BarLength = 14000,
                                        //BarWeight = lBBSWeight,
                                        BarWeight = lBBSBundle * 2000,
                                        shapeTransport = 0,
                                        UpdateDate = DateTime.Now,
                                        UpdateBy = UserName,//User.Identity.GetUserName(),
                                        CreateDate = DateTime.Now,
                                        CreateBy = UserName//User.Identity.GetUserName()
                                    };

                                    db.OrderDetails.Add(lBBSSBNew);
                                    //No of New Item added for the BBS
                                    lNewItemBBS[j] = lNewItemBBS[j] + 1;
                                }
                            }
                        }
                    }
                    db.SaveChanges();
                }
                return Ok(true);
            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
            }
            return Ok(false);

        }



        //       // POST: Customer/deleteBBS/
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult deleteBBS(string CustomerCode, string ProjectCode, int JobID, int BBSID, int BarsCount)
        //       {
        //           bool lSuccess = true;
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           string lErrorMsg = "";
        //           string lSQL = "";

        //           try
        //           {
        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //               {
        //                   var lStatus = "";

        //                   lSQL = "SELECT isNull(OrderStatus,'') " +
        //                   "FROM dbo.OESJobAdvice " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID.ToString() + " ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandText = lSQL;
        //                   lCmd.CommandTimeout = 1200;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       lRst.Read();
        //                       lStatus = lRst.GetString(0);
        //                   }
        //                   lRst.Close();

        //                   if (lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
        //                   {
        //                       string lUpdatedBy = "";
        //                       lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
        //                       "FROM dbo.OESOrderDetails " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " " +
        //                       "AND UpdateDate >= DateAdd(ss,-60,getDate()) " +
        //                       "AND UpdateBy <> '" + User.Identity.GetUserName() + "' ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandText = lSQL;
        //                       lCmd.CommandTimeout = 1200;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           lRst.Read();
        //                           lUpdatedBy = lRst.GetString(0).Trim();
        //                       }
        //                       lRst.Close();

        //                       if (lUpdatedBy != "")
        //                       {
        //                           lSuccess = false;
        //                           lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
        //                           return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //                       }

        //                       var oldOrderDetails = from p in db.OrderDetails
        //                                             where p.CustomerCode == CustomerCode &&
        //                                             p.ProjectCode == ProjectCode &&
        //                                             p.JobID == JobID &&
        //                                             p.BBSID == BBSID
        //                                             select p;

        //                       if (oldOrderDetails != null)
        //                       {
        //                           db.OrderDetails.RemoveRange(oldOrderDetails);
        //                       }
        //                       var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
        //                       if (oldBBS != null)
        //                       {
        //                           db.BBS.Remove(oldBBS);
        //                       }
        //                       db.SaveChanges();

        //                   }
        //                   lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               }
        //               lProcessObj = null;

        //           }
        //           catch (Exception ex)
        //           {
        //               lSuccess = false;
        //               lErrorMsg = ex.Message;
        //           }
        //           return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);

        //       }

        //       // POST: Customer/deleteBBS/
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult copyBBS(string SourceCustomerCode,
        //               string SourceProjectCode,
        //               int SourceOrderNo,
        //               int SourceBBSID,
        //               string DesCustomerCode,
        //               string DesProjectCode,
        //               int DesOrderNo,
        //               int DesBBSID,
        //               int DesBarCount)
        //       {
        //           try
        //           {
        //               //Delete destination record
        //               for (var i = 1; i <= DesBarCount; i++)
        //               {
        //                   var oldOrderDetails = db.OrderDetails.Find(DesCustomerCode, DesProjectCode, DesOrderNo, DesBBSID, i);
        //                   if (oldOrderDetails != null)
        //                   {
        //                       db.OrderDetails.Remove(oldOrderDetails);
        //                   }
        //               }
        //               db.SaveChanges();

        //               // update BBS
        //               var lBBSSource = db.BBS.Find(SourceCustomerCode, SourceProjectCode, SourceOrderNo, SourceBBSID);

        //               var lBBSContent = db.BBS.Find(DesCustomerCode, DesProjectCode, DesOrderNo, DesBBSID);
        //               var BBSContentNew = lBBSContent;
        //               BBSContentNew.BBSCopiedFrom = SourceCustomerCode + "," + SourceProjectCode + "," + SourceOrderNo + "," + lBBSSource.BBSNo;
        //               BBSContentNew.BBSOrderCABWT = lBBSSource.BBSOrderCABWT;
        //               BBSContentNew.BBSOrderSTDWT = lBBSSource.BBSOrderSTDWT;
        //               BBSContentNew.BBSCancelledWT = lBBSSource.BBSCancelledWT;
        //               BBSContentNew.BBSTotalWT = lBBSSource.BBSTotalWT;
        //               BBSContentNew.UpdateDate = DateTime.Now;
        //               BBSContentNew.UpdateBy = User.Identity.GetUserName();

        //               db.Entry(lBBSContent).CurrentValues.SetValues(BBSContentNew);

        //               //copy bars details;
        //               var lBarsSource = (from p in db.OrderDetails
        //                                  where p.CustomerCode == SourceCustomerCode &&
        //                                  p.ProjectCode == SourceProjectCode &&
        //                                  p.JobID == SourceOrderNo &&
        //                                  p.BBSID == SourceBBSID
        //                                  select p).ToList();

        //               lBarsSource = new List<OrderDetailsModels>
        //                   (lBarsSource.Select(h => new OrderDetailsModels
        //                   {
        //                       CustomerCode = DesCustomerCode,
        //                       ProjectCode = DesProjectCode,
        //                       JobID = DesOrderNo,
        //                       BBSID = DesBBSID,
        //                       BarID = h.BarID,
        //                       BarSort = h.BarSort,
        //                       Cancelled = h.Cancelled,
        //                       BarCAB = h.BarCAB,
        //                       BarSTD = h.BarSTD,
        //                       ElementMark = h.ElementMark,
        //                       BarMark = h.BarMark,
        //                       BarType = h.BarType,
        //                       BarSize = h.BarSize,
        //                       BarMemberQty = h.BarMemberQty,
        //                       BarEachQty = h.BarEachQty,
        //                       BarTotalQty = h.BarTotalQty,
        //                       BarShapeCode = h.BarShapeCode,
        //                       A = h.A,
        //                       B = h.B,
        //                       C = h.C,
        //                       D = h.D,
        //                       E = h.E,
        //                       F = h.F,
        //                       G = h.G,
        //                       H = h.H,
        //                       I = h.I,
        //                       J = h.J,
        //                       K = h.K,
        //                       L = h.L,
        //                       M = h.M,
        //                       N = h.N,
        //                       O = h.O,
        //                       P = h.P,
        //                       Q = h.Q,
        //                       R = h.R,
        //                       S = h.S,
        //                       T = h.T,
        //                       U = h.U,
        //                       V = h.V,
        //                       W = h.W,
        //                       X = h.X,
        //                       Y = h.Y,
        //                       Z = h.Z,
        //                       A2 = h.A2,
        //                       B2 = h.B2,
        //                       C2 = h.C2,
        //                       D2 = h.D2,
        //                       E2 = h.E2,
        //                       F2 = h.F2,
        //                       G2 = h.G2,
        //                       H2 = h.H2,
        //                       I2 = h.I2,
        //                       J2 = h.J2,
        //                       K2 = h.K2,
        //                       L2 = h.L2,
        //                       M2 = h.M2,
        //                       N2 = h.N2,
        //                       O2 = h.O2,
        //                       P2 = h.P2,
        //                       Q2 = h.Q2,
        //                       R2 = h.R2,
        //                       S2 = h.S2,
        //                       T2 = h.T2,
        //                       U2 = h.U2,
        //                       V2 = h.V2,
        //                       W2 = h.W2,
        //                       X2 = h.X2,
        //                       Y2 = h.Y2,
        //                       Z2 = h.Z2,
        //                       BarLength = h.BarLength,
        //                       BarLength2 = h.BarLength2,
        //                       BarWeight = h.BarWeight,
        //                       Remarks = h.Remarks,
        //                       shapeTransport = h.shapeTransport,
        //                       PinSize = h.PinSize,
        //                       UpdateDate = DateTime.Now,
        //                       UpdateBy = User.Identity.GetUserName(),
        //                       CreateDate = DateTime.Now,
        //                       CreateBy = User.Identity.GetUserName()
        //                   })).ToList();

        //               if (lBarsSource.Count() > 0)
        //               {
        //                   foreach (OrderDetailsModels fNewItem in lBarsSource)
        //                   {
        //                       db.OrderDetails.Add(fNewItem);
        //                   }
        //               }
        //               db.SaveChanges();
        //           }
        //           catch (Exception e)
        //           {
        //               var lError = e.Message;
        //               return Json(false);
        //           }
        //           return Json(true);
        //       }



        //       //get various BBS param Length
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getVarBarDetails(OrderDetailsListModels orderDetailsListModels)
        //       {
        //           var lBarsDetailsList = new List<OrderDetailsListModels>();
        //           OrderDetailsModels orderDetailsModels = new OrderDetailsModels();
        //           if (ModelState.IsValid)
        //           {
        //               string lShapeCode = orderDetailsListModels.BarShapeCode;
        //               if (lShapeCode == null)
        //               {
        //                   lShapeCode = "";
        //               }
        //               if (lShapeCode != "")
        //               {
        //                   while (lShapeCode.Length < 3)
        //                   {
        //                       lShapeCode = "0" + lShapeCode;
        //                   }

        //                   orderDetailsListModels.BarShapeCode = lShapeCode;
        //               }

        //               if (orderDetailsListModels.CustomerCode == null)
        //               {
        //                   orderDetailsListModels.CustomerCode = "";
        //               }
        //               if (orderDetailsListModels.CustomerCode.Length > 0)
        //               {
        //                   orderDetailsModels = new OrderDetailsModels
        //                   {
        //                       CustomerCode = orderDetailsListModels.CustomerCode,
        //                       ProjectCode = orderDetailsListModels.ProjectCode,
        //                       JobID = orderDetailsListModels.JobID,
        //                       BBSID = orderDetailsListModels.BBSID,
        //                       BarID = orderDetailsListModels.BarID,
        //                       BarSort = orderDetailsListModels.BarSort,
        //                       Cancelled = orderDetailsListModels.Cancelled,
        //                       BarCAB = orderDetailsListModels.BarSTD == true ? false : true,
        //                       BarSTD = orderDetailsListModels.BarSTD,
        //                       ElementMark = orderDetailsListModels.ElementMark,
        //                       BarMark = orderDetailsListModels.BarMark == null ? "" : orderDetailsListModels.BarMark,
        //                       BarType = orderDetailsListModels.BarType,
        //                       BarSize = orderDetailsListModels.BarSize == 0 ? null : orderDetailsListModels.BarSize,
        //                       BarMemberQty = orderDetailsListModels.BarMemberQty == 0 ? null : orderDetailsListModels.BarMemberQty,
        //                       BarEachQty = orderDetailsListModels.BarEachQty == 0 ? null : orderDetailsListModels.BarEachQty,
        //                       BarTotalQty = orderDetailsListModels.BarTotalQty == 0 ? null : orderDetailsListModels.BarTotalQty,
        //                       BarShapeCode = orderDetailsListModels.BarShapeCode,
        //                       A = getParaValue(orderDetailsListModels.A, 1),
        //                       B = getParaValue(orderDetailsListModels.B, 1),
        //                       C = getParaValue(orderDetailsListModels.C, 1),
        //                       D = getParaValue(orderDetailsListModels.D, 1),
        //                       E = getParaValue(orderDetailsListModels.E, 1),
        //                       F = getParaValue(orderDetailsListModels.F, 1),
        //                       G = getParaValue(orderDetailsListModels.G, 1),
        //                       H = getParaValue(orderDetailsListModels.H, 1),
        //                       I = getParaValue(orderDetailsListModels.I, 1),
        //                       J = getParaValue(orderDetailsListModels.J, 1),
        //                       K = getParaValue(orderDetailsListModels.K, 1),
        //                       L = getParaValue(orderDetailsListModels.L, 1),
        //                       M = getParaValue(orderDetailsListModels.M, 1),
        //                       N = getParaValue(orderDetailsListModels.N, 1),
        //                       O = getParaValue(orderDetailsListModels.O, 1),
        //                       P = getParaValue(orderDetailsListModels.P, 1),
        //                       Q = getParaValue(orderDetailsListModels.Q, 1),
        //                       R = getParaValue(orderDetailsListModels.R, 1),
        //                       S = getParaValue(orderDetailsListModels.S, 1),
        //                       T = getParaValue(orderDetailsListModels.T, 1),
        //                       U = getParaValue(orderDetailsListModels.U, 1),
        //                       V = getParaValue(orderDetailsListModels.V, 1),
        //                       W = getParaValue(orderDetailsListModels.W, 1),
        //                       X = getParaValue(orderDetailsListModels.X, 1),
        //                       Y = getParaValue(orderDetailsListModels.Y, 1),
        //                       Z = getParaValue(orderDetailsListModels.Z, 1),
        //                       A2 = getParaValue(orderDetailsListModels.A, 2),
        //                       B2 = getParaValue(orderDetailsListModels.B, 2),
        //                       C2 = getParaValue(orderDetailsListModels.C, 2),
        //                       D2 = getParaValue(orderDetailsListModels.D, 2),
        //                       E2 = getParaValue(orderDetailsListModels.E, 2),
        //                       F2 = getParaValue(orderDetailsListModels.F, 2),
        //                       G2 = getParaValue(orderDetailsListModels.G, 2),
        //                       H2 = getParaValue(orderDetailsListModels.H, 2),
        //                       I2 = getParaValue(orderDetailsListModels.I, 2),
        //                       J2 = getParaValue(orderDetailsListModels.J, 2),
        //                       K2 = getParaValue(orderDetailsListModels.K, 2),
        //                       L2 = getParaValue(orderDetailsListModels.L, 2),
        //                       M2 = getParaValue(orderDetailsListModels.M, 2),
        //                       N2 = getParaValue(orderDetailsListModels.N, 2),
        //                       O2 = getParaValue(orderDetailsListModels.O, 2),
        //                       P2 = getParaValue(orderDetailsListModels.P, 2),
        //                       Q2 = getParaValue(orderDetailsListModels.Q, 2),
        //                       R2 = getParaValue(orderDetailsListModels.R, 2),
        //                       S2 = getParaValue(orderDetailsListModels.S, 2),
        //                       T2 = getParaValue(orderDetailsListModels.T, 2),
        //                       U2 = getParaValue(orderDetailsListModels.U, 2),
        //                       V2 = getParaValue(orderDetailsListModels.V, 2),
        //                       W2 = getParaValue(orderDetailsListModels.W, 2),
        //                       X2 = getParaValue(orderDetailsListModels.X, 2),
        //                       Y2 = getParaValue(orderDetailsListModels.Y, 2),
        //                       Z2 = getParaValue(orderDetailsListModels.Z, 2),
        //                       BarLength = getParaValue(orderDetailsListModels.BarLength, 1),
        //                       BarLength2 = getParaValue(orderDetailsListModels.BarLength, 2),
        //                       BarWeight = orderDetailsListModels.BarWeight == 0 ? null : orderDetailsListModels.BarWeight,
        //                       Remarks = orderDetailsListModels.Remarks,
        //                       shapeTransport = orderDetailsListModels.shapeTransport == 0 ? null : orderDetailsListModels.shapeTransport,
        //                       PinSize = orderDetailsListModels.PinSize == 0 ? null : orderDetailsListModels.PinSize,
        //                       UpdateDate = DateTime.Now,
        //                       UpdateBy = User.Identity.GetUserName()
        //                   };

        //                   var lBarIn = new List<OrderDetailsModels>();
        //                   lBarIn.Add(orderDetailsModels);

        //                   var lProcessObj = new ProcessController();
        //                   var lVariantLenBars = lProcessObj.VariantLenProcess(lBarIn);
        //                   lProcessObj = null;

        //                   lBarsDetailsList = new List<OrderDetailsListModels>(
        //                       lVariantLenBars.Select(h => new OrderDetailsListModels
        //                       {
        //                           CustomerCode = h.CustomerCode,
        //                           ProjectCode = h.ProjectCode,
        //                           JobID = h.JobID,
        //                           BBSID = h.BBSID,
        //                           BarID = h.BarID,
        //                           BarSort = h.BarSort,
        //                           Cancelled = h.Cancelled,
        //                           ElementMark = h.ElementMark,
        //                           BarMark = h.BarMark,
        //                           BarType = h.BarType,
        //                           BarSize = h.BarSize,
        //                           BarCAB = h.BarCAB,
        //                           BarSTD = h.BarSTD == false ? null : h.BarSTD,
        //                           BarMemberQty = h.BarMemberQty,
        //                           BarEachQty = h.BarEachQty,
        //                           BarTotalQty = h.BarTotalQty,
        //                           BarShapeCode = h.BarShapeCode,
        //                           A = ((h.A == null) ? null : (h.A > 0 && h.A2 > 0) ? h.A.ToString() + '-' + h.A2.ToString() : h.A.ToString()),
        //                           B = ((h.B == null) ? null : (h.B > 0 && h.B2 > 0) ? h.B.ToString() + '-' + h.B2.ToString() : h.B.ToString()),
        //                           C = ((h.C == null) ? null : (h.C > 0 && h.C2 > 0) ? h.C.ToString() + '-' + h.C2.ToString() : h.C.ToString()),
        //                           D = ((h.D == null) ? null : (h.D > 0 && h.D2 > 0) ? h.D.ToString() + '-' + h.D2.ToString() : h.D.ToString()),
        //                           E = ((h.E == null) ? null : (h.E > 0 && h.E2 > 0) ? h.E.ToString() + '-' + h.E2.ToString() : h.E.ToString()),
        //                           F = ((h.F == null) ? null : (h.F > 0 && h.F2 > 0) ? h.F.ToString() + '-' + h.F2.ToString() : h.F.ToString()),
        //                           G = ((h.G == null) ? null : (h.G > 0 && h.G2 > 0) ? h.G.ToString() + '-' + h.G2.ToString() : h.G.ToString()),
        //                           H = ((h.H == null) ? null : (h.H > 0 && h.H2 > 0) ? h.H.ToString() + '-' + h.H2.ToString() : h.H.ToString()),
        //                           I = ((h.I == null) ? null : (h.I > 0 && h.I2 > 0) ? h.I.ToString() + '-' + h.I2.ToString() : h.I.ToString()),
        //                           J = ((h.J == null) ? null : (h.J > 0 && h.J2 > 0) ? h.J.ToString() + '-' + h.J2.ToString() : h.J.ToString()),
        //                           K = ((h.K == null) ? null : (h.K > 0 && h.K2 > 0) ? h.K.ToString() + '-' + h.K2.ToString() : h.K.ToString()),
        //                           L = ((h.L == null) ? null : (h.L > 0 && h.L2 > 0) ? h.L.ToString() + '-' + h.L2.ToString() : h.L.ToString()),
        //                           M = ((h.M == null) ? null : (h.M > 0 && h.M2 > 0) ? h.M.ToString() + '-' + h.M2.ToString() : h.M.ToString()),
        //                           N = ((h.N == null) ? null : (h.N > 0 && h.N2 > 0) ? h.N.ToString() + '-' + h.N2.ToString() : h.N.ToString()),
        //                           O = ((h.O == null) ? null : (h.O > 0 && h.O2 > 0) ? h.O.ToString() + '-' + h.O2.ToString() : h.O.ToString()),
        //                           P = ((h.P == null) ? null : (h.P > 0 && h.P2 > 0) ? h.P.ToString() + '-' + h.P2.ToString() : h.P.ToString()),
        //                           Q = ((h.Q == null) ? null : (h.Q > 0 && h.Q2 > 0) ? h.Q.ToString() + '-' + h.Q2.ToString() : h.Q.ToString()),
        //                           R = ((h.R == null) ? null : (h.R > 0 && h.R2 > 0) ? h.R.ToString() + '-' + h.R2.ToString() : h.R.ToString()),
        //                           S = ((h.S == null) ? null : (h.S > 0 && h.S2 > 0) ? h.S.ToString() + '-' + h.S2.ToString() : h.S.ToString()),
        //                           T = ((h.T == null) ? null : (h.T > 0 && h.T2 > 0) ? h.T.ToString() + '-' + h.T2.ToString() : h.T.ToString()),
        //                           U = ((h.U == null) ? null : (h.U > 0 && h.U2 > 0) ? h.U.ToString() + '-' + h.U2.ToString() : h.U.ToString()),
        //                           V = ((h.V == null) ? null : (h.V > 0 && h.V2 > 0) ? h.V.ToString() + '-' + h.V2.ToString() : h.V.ToString()),
        //                           W = ((h.W == null) ? null : (h.W > 0 && h.W2 > 0) ? h.W.ToString() + '-' + h.W2.ToString() : h.W.ToString()),
        //                           X = ((h.X == null) ? null : (h.X > 0 && h.X2 > 0) ? h.X.ToString() + '-' + h.X2.ToString() : h.X.ToString()),
        //                           Y = ((h.Y == null) ? null : (h.Y > 0 && h.Y2 > 0) ? h.Y.ToString() + '-' + h.Y2.ToString() : h.Y.ToString()),
        //                           Z = ((h.Z == null) ? null : (h.Z > 0 && h.Z2 > 0) ? h.Z.ToString() + '-' + h.Z2.ToString() : h.Z.ToString()),
        //                           BarLength = ((h.BarLength == null) ? null : (h.BarLength > 0 && h.BarLength2 > 0) ? h.BarLength.ToString() + '-' + h.BarLength2.ToString() : h.BarLength.ToString()),
        //                           BarWeight = h.BarWeight,
        //                           Remarks = h.Remarks,
        //                           shapeTransport = h.shapeTransport,
        //                           PinSize = h.PinSize,
        //                           UpdateDate = h.UpdateDate
        //                       })
        //                       );
        //               }
        //           }
        //           return Json(lBarsDetailsList);
        //       }

        //       //save BBS
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult saveBarDetails(OrderDetailsListModels orderDetailsListModels)
        //       {
        //           bool lSuccess = true;
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           string lErrorMsg = "";
        //           string lSQL = "";
        //           string lOldShape = "";

        //           OrderDetailsModels orderDetailsModels = new OrderDetailsModels();
        //           try
        //           {
        //               string lShapeCode = orderDetailsListModels.BarShapeCode;
        //               if (lShapeCode == null)
        //               {
        //                   lShapeCode = "";
        //               }
        //               if (lShapeCode != "")
        //               {
        //                   while (lShapeCode.Length < 3)
        //                   {
        //                       lShapeCode = "0" + lShapeCode;
        //                   }

        //                   orderDetailsListModels.BarShapeCode = lShapeCode;
        //               }

        //               if (orderDetailsListModels.BarMark == null)
        //               {
        //                   orderDetailsListModels.BarMark = "";
        //               }
        //               if (orderDetailsListModels.BarMark.IndexOf(",") >= 0)
        //               {
        //                   orderDetailsListModels.BarMark = orderDetailsListModels.BarMark.Replace(",", "");
        //               }

        //               if (orderDetailsListModels.CustomerCode == null)
        //               {
        //                   orderDetailsListModels.CustomerCode = "";
        //               }
        //               if (orderDetailsListModels.CustomerCode.Length > 0)
        //               {
        //                   //orderDetailsModels = new OrderDetailsModels
        //                   //{
        //                   //    CustomerCode = orderDetailsListModels.CustomerCode,
        //                   //    ProjectCode = orderDetailsListModels.ProjectCode,
        //                   //    JobID = orderDetailsListModels.JobID,
        //                   //    BBSID = orderDetailsListModels.BBSID,
        //                   //    BarID = orderDetailsListModels.BarID,
        //                   //    BarSort = orderDetailsListModels.BarSort,
        //                   //    Cancelled = orderDetailsListModels.Cancelled,
        //                   //    BarCAB = orderDetailsListModels.BarSTD == true ? false : true,
        //                   //    BarSTD = orderDetailsListModels.BarSTD,
        //                   //    ElementMark = orderDetailsListModels.ElementMark,
        //                   //    BarMark = orderDetailsListModels.BarMark,
        //                   //    BarType = orderDetailsListModels.BarType,
        //                   //    BarSize = orderDetailsListModels.BarSize == 0 ? null : orderDetailsListModels.BarSize,
        //                   //    BarMemberQty = orderDetailsListModels.BarMemberQty == 0 ? null : orderDetailsListModels.BarMemberQty,
        //                   //    BarEachQty = orderDetailsListModels.BarEachQty == 0 ? null : orderDetailsListModels.BarEachQty,
        //                   //    BarTotalQty = orderDetailsListModels.BarTotalQty == 0 ? null : orderDetailsListModels.BarTotalQty,
        //                   //    BarShapeCode = orderDetailsListModels.BarShapeCode,
        //                   //    A = getParaValue(orderDetailsListModels.A, 1),
        //                   //    B = getParaValue(orderDetailsListModels.B, 1),
        //                   //    C = getParaValue(orderDetailsListModels.C, 1),
        //                   //    D = getParaValue(orderDetailsListModels.D, 1),
        //                   //    E = getParaValue(orderDetailsListModels.E, 1),
        //                   //    F = getParaValue(orderDetailsListModels.F, 1),
        //                   //    G = getParaValue(orderDetailsListModels.G, 1),
        //                   //    H = getParaValue(orderDetailsListModels.H, 1),
        //                   //    I = getParaValue(orderDetailsListModels.I, 1),
        //                   //    J = getParaValue(orderDetailsListModels.J, 1),
        //                   //    K = getParaValue(orderDetailsListModels.K, 1),
        //                   //    L = getParaValue(orderDetailsListModels.L, 1),
        //                   //    M = getParaValue(orderDetailsListModels.M, 1),
        //                   //    N = getParaValue(orderDetailsListModels.N, 1),
        //                   //    O = getParaValue(orderDetailsListModels.O, 1),
        //                   //    P = getParaValue(orderDetailsListModels.P, 1),
        //                   //    Q = getParaValue(orderDetailsListModels.Q, 1),
        //                   //    R = getParaValue(orderDetailsListModels.R, 1),
        //                   //    S = getParaValue(orderDetailsListModels.S, 1),
        //                   //    T = getParaValue(orderDetailsListModels.T, 1),
        //                   //    U = getParaValue(orderDetailsListModels.U, 1),
        //                   //    V = getParaValue(orderDetailsListModels.V, 1),
        //                   //    W = getParaValue(orderDetailsListModels.W, 1),
        //                   //    X = getParaValue(orderDetailsListModels.X, 1),
        //                   //    Y = getParaValue(orderDetailsListModels.Y, 1),
        //                   //    Z = getParaValue(orderDetailsListModels.Z, 1),
        //                   //    A2 = getParaValue(orderDetailsListModels.A, 2),
        //                   //    B2 = getParaValue(orderDetailsListModels.B, 2),
        //                   //    C2 = getParaValue(orderDetailsListModels.C, 2),
        //                   //    D2 = getParaValue(orderDetailsListModels.D, 2),
        //                   //    E2 = getParaValue(orderDetailsListModels.E, 2),
        //                   //    F2 = getParaValue(orderDetailsListModels.F, 2),
        //                   //    G2 = getParaValue(orderDetailsListModels.G, 2),
        //                   //    H2 = getParaValue(orderDetailsListModels.H, 2),
        //                   //    I2 = getParaValue(orderDetailsListModels.I, 2),
        //                   //    J2 = getParaValue(orderDetailsListModels.J, 2),
        //                   //    K2 = getParaValue(orderDetailsListModels.K, 2),
        //                   //    L2 = getParaValue(orderDetailsListModels.L, 2),
        //                   //    M2 = getParaValue(orderDetailsListModels.M, 2),
        //                   //    N2 = getParaValue(orderDetailsListModels.N, 2),
        //                   //    O2 = getParaValue(orderDetailsListModels.O, 2),
        //                   //    P2 = getParaValue(orderDetailsListModels.P, 2),
        //                   //    Q2 = getParaValue(orderDetailsListModels.Q, 2),
        //                   //    R2 = getParaValue(orderDetailsListModels.R, 2),
        //                   //    S2 = getParaValue(orderDetailsListModels.S, 2),
        //                   //    T2 = getParaValue(orderDetailsListModels.T, 2),
        //                   //    U2 = getParaValue(orderDetailsListModels.U, 2),
        //                   //    V2 = getParaValue(orderDetailsListModels.V, 2),
        //                   //    W2 = getParaValue(orderDetailsListModels.W, 2),
        //                   //    X2 = getParaValue(orderDetailsListModels.X, 2),
        //                   //    Y2 = getParaValue(orderDetailsListModels.Y, 2),
        //                   //    Z2 = getParaValue(orderDetailsListModels.Z, 2),
        //                   //    BarLength = getParaValue(orderDetailsListModels.BarLength, 1),
        //                   //    BarLength2 = getParaValue(orderDetailsListModels.BarLength, 2),
        //                   //    BarWeight = orderDetailsListModels.BarWeight == 0 ? null : orderDetailsListModels.BarWeight,
        //                   //    Remarks = orderDetailsListModels.Remarks,
        //                   //    shapeTransport = orderDetailsListModels.shapeTransport == 0 ? null : orderDetailsListModels.shapeTransport,
        //                   //    PinSize = orderDetailsListModels.PinSize == 0 ? null : orderDetailsListModels.PinSize,
        //                   //    UpdateDate = DateTime.Now,
        //                   //    UpdateBy = User.Identity.GetUserName()
        //                   //};

        //                   //var oldBar = db.OrderDetails.Find(orderDetailsModels.CustomerCode, orderDetailsModels.ProjectCode, orderDetailsModels.JobID, orderDetailsModels.BBSID, orderDetailsModels.BarID);
        //                   //if (oldBar == null)
        //                   //{
        //                   //    db.OrderDetails.Add(orderDetailsModels);
        //                   //}
        //                   //else
        //                   //{
        //                   //    db.Entry(oldBar).CurrentValues.SetValues(orderDetailsModels);
        //                   //}
        //                   //int lRtn = await db.SaveChangesAsync();

        //                   string lCustomerCode = orderDetailsListModels.CustomerCode;
        //                   string lProjectCode = orderDetailsListModels.ProjectCode;
        //                   int lJobID = orderDetailsListModels.JobID;
        //                   int lBBSID = orderDetailsListModels.BBSID;
        //                   int lBarID = orderDetailsListModels.BarID;

        //                   long lSNID = 0;

        //                   var lProcessObj = new ProcessController();
        //                   if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //                   {
        //                       var lStatus = "";

        //                       lSQL = "SELECT isNull(OrderStatus,'') " +
        //                       "FROM dbo.OESJobAdvice WITH (NOLOCK) " +
        //                       "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                       "AND ProjectCode = '" + lProjectCode + "' " +
        //                       "AND JobID = " + lJobID.ToString() + " ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandText = lSQL;
        //                       lCmd.CommandTimeout = 1200;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           lRst.Read();
        //                           lStatus = lRst.GetString(0);
        //                       }
        //                       lRst.Close();

        //                       if (lStatus == "" || lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
        //                       {
        //                           string lUpdatedBy = "";
        //                           lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
        //                           "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
        //                           "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                           "AND ProjectCode = '" + lProjectCode + "' " +
        //                           "AND JobID = " + lJobID.ToString() + " " +
        //                           "AND BBSID = " + lBBSID.ToString() + " " +
        //                           "AND UpdateDate >= DateAdd(ss,-300,getDate()) " +
        //                           "AND UpdateBy <> '" + User.Identity.GetUserName() + "' ";

        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandText = lSQL;
        //                           lCmd.CommandTimeout = 1200;
        //                           lRst = lCmd.ExecuteReader();
        //                           if (lRst.HasRows)
        //                           {
        //                               lRst.Read();
        //                               lUpdatedBy = lRst.GetString(0).Trim();
        //                           }
        //                           lRst.Close();

        //                           if (lUpdatedBy != "")
        //                           {
        //                               lSuccess = false;
        //                               lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
        //                               return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //                           }

        //                           int lFound = 0;
        //                           lSQL = "SELECT BarID, BarShapeCode " +
        //                           "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
        //                           "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                           "AND ProjectCode = '" + lProjectCode + "' " +
        //                           "AND JobID = " + lJobID.ToString() + " " +
        //                           "AND BBSID = " + lBBSID.ToString() + " " +
        //                           "AND BarID = " + lBarID.ToString() + " ";

        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandText = lSQL;
        //                           lCmd.CommandTimeout = 1200;
        //                           lRst = lCmd.ExecuteReader();
        //                           if (lRst.HasRows)
        //                           {
        //                               lRst.Read();
        //                               lOldShape = lRst.GetString(1);
        //                               lFound = 1;
        //                           }
        //                           lRst.Close();

        //                           if (orderDetailsListModels.Remarks != null)
        //                           {
        //                               orderDetailsListModels.Remarks = orderDetailsListModels.Remarks.Replace("'", "''");
        //                           }
        //                           if (orderDetailsListModels.ElementMark != null)
        //                           {
        //                               orderDetailsListModels.ElementMark = orderDetailsListModels.ElementMark.Replace("'", "''");
        //                           }
        //                           if (orderDetailsListModels.BarMark != null)
        //                           {
        //                               orderDetailsListModels.BarMark = orderDetailsListModels.BarMark.Replace("'", "''");
        //                           }

        //                           if (lFound == 0)
        //                           {
        //                               lSQL = "" +
        //                               "INSERT INTO dbo.OESOrderDetails " +
        //                               "(CustomerCode " +
        //                               ", ProjectCode " +
        //                               ", JobID " +
        //                               ", BBSID " +
        //                               ", BarID " +
        //                               ", BarSort " +
        //                               ", Cancelled " +
        //                               ", BarCAB " +
        //                               ", BarSTD " +
        //                               ", ElementMark " +
        //                               ", BarMark " +
        //                               ", BarType " +
        //                               ", BarSize " +
        //                               ", BarMemberQty " +
        //                               ", BarEachQty " +
        //                               ", BarTotalQty " +
        //                               ", BarShapeCode " +
        //                               ", A " +
        //                               ", B " +
        //                               ", C " +
        //                               ", D " +
        //                               ", E " +
        //                               ", F " +
        //                               ", G " +
        //                               ", H " +
        //                               ", I " +
        //                               ", J " +
        //                               ", K " +
        //                               ", L " +
        //                               ", M " +
        //                               ", N " +
        //                               ", O " +
        //                               ", P " +
        //                               ", Q " +
        //                               ", R " +
        //                               ", S " +
        //                               ", T " +
        //                               ", U " +
        //                               ", V " +
        //                               ", W " +
        //                               ", X " +
        //                               ", Y " +
        //                               ", Z " +
        //                               ", A2 " +
        //                               ", B2 " +
        //                               ", C2 " +
        //                               ", D2 " +
        //                               ", E2 " +
        //                               ", F2 " +
        //                               ", G2 " +
        //                               ", H2 " +
        //                               ", I2 " +
        //                               ", J2 " +
        //                               ", K2 " +
        //                               ", L2 " +
        //                               ", M2 " +
        //                               ", N2 " +
        //                               ", O2 " +
        //                               ", P2 " +
        //                               ", Q2 " +
        //                               ", R2 " +
        //                               ", S2 " +
        //                               ", T2 " +
        //                               ", U2 " +
        //                               ", V2 " +
        //                               ", W2 " +
        //                               ", X2 " +
        //                               ", Y2 " +
        //                               ", Z2 " +
        //                               ", BarLength " +
        //                               ", BarLength2 " +
        //                               ", BarWeight " +
        //                               ", Remarks " +
        //                               ", shapeTransport " +
        //                               ", PinSize " +
        //                               ", TeklaGUID " +
        //                               ", PartGUID " +
        //                               ", UpdateDate " +
        //                               ", UpdateBy " +
        //                               ", CreateDate " +
        //                               ", CreateBy) " +
        //                               "VALUES " +
        //                               "( " +
        //                               "'" + orderDetailsListModels.CustomerCode + "' " +
        //                               ", '" + orderDetailsListModels.ProjectCode + "' " +
        //                               ", " + orderDetailsListModels.JobID + " " +
        //                               ", " + orderDetailsListModels.BBSID + " " +
        //                               ", " + orderDetailsListModels.BarID + " " +
        //                               ", " + orderDetailsListModels.BarSort + " " +
        //                               ", " + (orderDetailsListModels.Cancelled == true ? "1" : "null") + " " +
        //                               ", " + (orderDetailsListModels.BarSTD == true ? 0 : 1) + " " +
        //                               ", " + (orderDetailsListModels.BarSTD == true ? "1" : "null") + " " +
        //                               ", '" + orderDetailsListModels.ElementMark + "' " +
        //                               ", '" + orderDetailsListModels.BarMark + "' " +
        //                               ", '" + orderDetailsListModels.BarType + "' " +
        //                               ", " + (orderDetailsListModels.BarSize == 0 || orderDetailsListModels.BarSize == null ? "null" : orderDetailsListModels.BarSize.ToString()) + " " +
        //                               ", " + (orderDetailsListModels.BarMemberQty == 0 || orderDetailsListModels.BarMemberQty == null ? "null" : orderDetailsListModels.BarMemberQty.ToString()) + " " +
        //                               ", " + (orderDetailsListModels.BarEachQty == 0 || orderDetailsListModels.BarEachQty == null ? "null" : orderDetailsListModels.BarEachQty.ToString()) + " " +
        //                               ", " + (orderDetailsListModels.BarTotalQty == 0 || orderDetailsListModels.BarTotalQty == null ? "null" : orderDetailsListModels.BarTotalQty.ToString()) + " " +
        //                               ", '" + orderDetailsListModels.BarShapeCode + "' " +
        //                               ", " + getParaStringValue(orderDetailsListModels.A, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.B, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.C, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.D, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.E, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.F, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.G, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.H, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.I, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.J, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.K, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.L, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.M, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.N, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.O, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.P, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Q, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.R, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.S, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.T, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.U, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.V, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.W, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.X, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Y, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Z, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.A, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.B, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.C, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.D, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.E, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.F, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.G, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.H, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.I, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.J, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.K, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.L, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.M, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.N, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.O, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.P, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Q, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.R, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.S, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.T, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.U, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.V, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.W, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.X, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Y, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.Z, 2) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.BarLength, 1) + " " +
        //                               ", " + getParaStringValue(orderDetailsListModels.BarLength, 2) + " " +
        //                               ", " + (orderDetailsListModels.BarWeight == 0 || orderDetailsListModels.BarWeight == null ? "null" : orderDetailsListModels.BarWeight.ToString()) + " " +
        //                               ", '" + orderDetailsListModels.Remarks + "' " +
        //                               ", " + (orderDetailsListModels.shapeTransport == 0 || orderDetailsListModels.shapeTransport == null ? "null" : orderDetailsListModels.shapeTransport.ToString()) + " " +
        //                               ", " + (orderDetailsListModels.PinSize == 0 || orderDetailsListModels.PinSize == null ? "null" : orderDetailsListModels.PinSize.ToString()) + " " +
        //                               ", '' " +
        //                               ", '' " +
        //                               ", getDate() " +
        //                               ", '" + User.Identity.GetUserName() + "' " +
        //                               ", getDate() " +
        //                               ", '" + User.Identity.GetUserName() + "' ) ";

        //                           }
        //                           else
        //                           {
        //                               int lOldShapeInt = 0;
        //                               int lNewShapeInt = 0;
        //                               Int32.TryParse(orderDetailsListModels.BarShapeCode, out lNewShapeInt);

        //                               if (Int32.TryParse(lOldShape, out lOldShapeInt))
        //                               {
        //                                   if (lOldShapeInt >= 950 && (lNewShapeInt < 950 || lNewShapeInt == 0) &&
        //                                       User.Identity.GetUserName().IndexOf("@") > 0 &&
        //                                       User.Identity.GetUserName().Split('@')[1].ToUpper() == "NATSTEEL.COM.SG")
        //                                   {
        //                                       lSQL = "" +
        //                                       "UPDATE dbo.OESCustomShapes " +
        //                                       "SET ShapeStatus = 'Inactive', " +
        //                                       "ReplacedBy = '" + orderDetailsListModels.BarShapeCode + "' " +
        //                                       "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                                       "AND ProjectCode = '" + lProjectCode + "' " +
        //                                       "AND shapeCode = '" + lOldShapeInt.ToString() + "' ";

        //                                       lCmd.Connection = lNDSCon;
        //                                       lCmd.CommandText = lSQL;
        //                                       lCmd.CommandTimeout = 1200;
        //                                       lCmd.ExecuteNonQuery();
        //                                   }
        //                               }

        //                               lSQL = "" +
        //                               "UPDATE dbo.OESOrderDetails SET " +
        //                               "BarSort = " + orderDetailsListModels.BarSort + " " +
        //                               ", Cancelled = " + (orderDetailsListModels.Cancelled == true ? "1" : "null") + " " +
        //                               ", BarCAB = " + (orderDetailsListModels.BarSTD == true ? 0 : 1) + " " +
        //                               ", BarSTD = " + (orderDetailsListModels.BarSTD == true ? "1" : "null") + " " +
        //                               ", ElementMark = '" + orderDetailsListModels.ElementMark + "' " +
        //                               ", BarMark = '" + orderDetailsListModels.BarMark + "' " +
        //                               ", BarType = '" + orderDetailsListModels.BarType + "' " +
        //                               ", BarSize = " + (orderDetailsListModels.BarSize == 0 || orderDetailsListModels.BarSize == null ? "null" : orderDetailsListModels.BarSize.ToString()) + " " +
        //                               ", BarMemberQty = " + (orderDetailsListModels.BarMemberQty == 0 || orderDetailsListModels.BarMemberQty == null ? "null" : orderDetailsListModels.BarMemberQty.ToString()) + " " +
        //                               ", BarEachQty = " + (orderDetailsListModels.BarEachQty == 0 || orderDetailsListModels.BarEachQty == null ? "null" : orderDetailsListModels.BarEachQty.ToString()) + " " +
        //                               ", BarTotalQty = " + (orderDetailsListModels.BarTotalQty == 0 || orderDetailsListModels.BarTotalQty == null ? "null" : orderDetailsListModels.BarTotalQty.ToString()) + " " +
        //                               ", BarShapeCode = '" + orderDetailsListModels.BarShapeCode + "' " +
        //                               ", A = " + getParaStringValue(orderDetailsListModels.A, 1) + " " +
        //                               ", B = " + getParaStringValue(orderDetailsListModels.B, 1) + " " +
        //                               ", C = " + getParaStringValue(orderDetailsListModels.C, 1) + " " +
        //                               ", D = " + getParaStringValue(orderDetailsListModels.D, 1) + " " +
        //                               ", E = " + getParaStringValue(orderDetailsListModels.E, 1) + " " +
        //                               ", F = " + getParaStringValue(orderDetailsListModels.F, 1) + " " +
        //                               ", G = " + getParaStringValue(orderDetailsListModels.G, 1) + " " +
        //                               ", H = " + getParaStringValue(orderDetailsListModels.H, 1) + " " +
        //                               ", I = " + getParaStringValue(orderDetailsListModels.I, 1) + " " +
        //                               ", J = " + getParaStringValue(orderDetailsListModels.J, 1) + " " +
        //                               ", K = " + getParaStringValue(orderDetailsListModels.K, 1) + " " +
        //                               ", L = " + getParaStringValue(orderDetailsListModels.L, 1) + " " +
        //                               ", M = " + getParaStringValue(orderDetailsListModels.M, 1) + " " +
        //                               ", N = " + getParaStringValue(orderDetailsListModels.N, 1) + " " +
        //                               ", O = " + getParaStringValue(orderDetailsListModels.O, 1) + " " +
        //                               ", P = " + getParaStringValue(orderDetailsListModels.P, 1) + " " +
        //                               ", Q = " + getParaStringValue(orderDetailsListModels.Q, 1) + " " +
        //                               ", R = " + getParaStringValue(orderDetailsListModels.R, 1) + " " +
        //                               ", S = " + getParaStringValue(orderDetailsListModels.S, 1) + " " +
        //                               ", T = " + getParaStringValue(orderDetailsListModels.T, 1) + " " +
        //                               ", U = " + getParaStringValue(orderDetailsListModels.U, 1) + " " +
        //                               ", V = " + getParaStringValue(orderDetailsListModels.V, 1) + " " +
        //                               ", W = " + getParaStringValue(orderDetailsListModels.W, 1) + " " +
        //                               ", X = " + getParaStringValue(orderDetailsListModels.X, 1) + " " +
        //                               ", Y = " + getParaStringValue(orderDetailsListModels.Y, 1) + " " +
        //                               ", Z = " + getParaStringValue(orderDetailsListModels.Z, 1) + " " +
        //                               ", A2 = " + getParaStringValue(orderDetailsListModels.A, 2) + " " +
        //                               ", B2 = " + getParaStringValue(orderDetailsListModels.B, 2) + " " +
        //                               ", C2 = " + getParaStringValue(orderDetailsListModels.C, 2) + " " +
        //                               ", D2 = " + getParaStringValue(orderDetailsListModels.D, 2) + " " +
        //                               ", E2 = " + getParaStringValue(orderDetailsListModels.E, 2) + " " +
        //                               ", F2 = " + getParaStringValue(orderDetailsListModels.F, 2) + " " +
        //                               ", G2 = " + getParaStringValue(orderDetailsListModels.G, 2) + " " +
        //                               ", H2 = " + getParaStringValue(orderDetailsListModels.H, 2) + " " +
        //                               ", I2 = " + getParaStringValue(orderDetailsListModels.I, 2) + " " +
        //                               ", J2 = " + getParaStringValue(orderDetailsListModels.J, 2) + " " +
        //                               ", K2 = " + getParaStringValue(orderDetailsListModels.K, 2) + " " +
        //                               ", L2 = " + getParaStringValue(orderDetailsListModels.L, 2) + " " +
        //                               ", M2 = " + getParaStringValue(orderDetailsListModels.M, 2) + " " +
        //                               ", N2 = " + getParaStringValue(orderDetailsListModels.N, 2) + " " +
        //                               ", O2 = " + getParaStringValue(orderDetailsListModels.O, 2) + " " +
        //                               ", P2 = " + getParaStringValue(orderDetailsListModels.P, 2) + " " +
        //                               ", Q2 = " + getParaStringValue(orderDetailsListModels.Q, 2) + " " +
        //                               ", R2 = " + getParaStringValue(orderDetailsListModels.R, 2) + " " +
        //                               ", S2 = " + getParaStringValue(orderDetailsListModels.S, 2) + " " +
        //                               ", T2 = " + getParaStringValue(orderDetailsListModels.T, 2) + " " +
        //                               ", U2 = " + getParaStringValue(orderDetailsListModels.U, 2) + " " +
        //                               ", V2 = " + getParaStringValue(orderDetailsListModels.V, 2) + " " +
        //                               ", W2 = " + getParaStringValue(orderDetailsListModels.W, 2) + " " +
        //                               ", X2 = " + getParaStringValue(orderDetailsListModels.X, 2) + " " +
        //                               ", Y2 = " + getParaStringValue(orderDetailsListModels.Y, 2) + " " +
        //                               ", Z2 = " + getParaStringValue(orderDetailsListModels.Z, 2) + " " +
        //                               ", BarLength = " + getParaStringValue(orderDetailsListModels.BarLength, 1) + " " +
        //                               ", BarLength2 = " + getParaStringValue(orderDetailsListModels.BarLength, 2) + " " +
        //                               ", BarWeight = " + (orderDetailsListModels.BarWeight == 0 || orderDetailsListModels.BarWeight == null ? "null" : orderDetailsListModels.BarWeight.ToString()) + " " +
        //                               ", Remarks = '" + orderDetailsListModels.Remarks + "' " +
        //                               ", shapeTransport = " + (orderDetailsListModels.shapeTransport == 0 || orderDetailsListModels.shapeTransport == null ? "null" : orderDetailsListModels.shapeTransport.ToString()) + " " +
        //                               ", PinSize = " + (orderDetailsListModels.PinSize == 0 || orderDetailsListModels.PinSize == null ? "null" : orderDetailsListModels.PinSize.ToString()) + " " +
        //                               ", UpdateDate = getDate() " +
        //                               ", UpdateBy = '" + User.Identity.GetUserName() + "' " +
        //                               "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                               "AND ProjectCode = '" + lProjectCode + "' " +
        //                               "AND JobID = " + lJobID.ToString() + " " +
        //                               "AND BBSID = " + lBBSID.ToString() + " " +
        //                               "AND BarID = " + lBarID.ToString() + " ";

        //                           }

        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandText = lSQL;
        //                           lCmd.CommandTimeout = 1200;
        //                           lCmd.ExecuteNonQuery();

        //                           lCmd.CommandText =
        //                           "SELECT RowNum FROM ( " +
        //                           "SELECT Row_Number() over(order by BarSort) as RowNum, barID " +
        //                           "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
        //                           "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                           "AND ProjectCode = '" + lProjectCode + "' " +
        //                           "AND JobID = " + lJobID.ToString() + " " +
        //                           "AND BBSID = " + lBBSID.ToString() + " " +
        //                           ") t2 " +
        //                           "WHERE barID = " + lBarID.ToString() + " ";

        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandTimeout = 1200;
        //                           lRst = lCmd.ExecuteReader();
        //                           if (lRst.HasRows)
        //                           {
        //                               lRst.Read();
        //                               lSNID = lRst.GetInt64(0);
        //                           }
        //                           lRst.Close();

        //                           lCmd.CommandText =
        //                           "SELECT barID FROM ( " +
        //                           "SELECT Row_Number() over (order by BarSort) as RowNum, barID " +
        //                           "FROM dbo.OESOrderDetailsDouble WITH (NOLOCK) " +
        //                           "WHERE CustomerCode = '" + lCustomerCode + "' " +
        //                           "AND ProjectCode = '" + lProjectCode + "' " +
        //                           "AND JobID = " + lJobID.ToString() + " " +
        //                           "AND BBSID = " + lBBSID.ToString() + " " +
        //                           ") t2 " +
        //                           "WHERE RowNum = " + lSNID.ToString() + " ";

        //                           lCmd.Connection = lNDSCon;
        //                           lCmd.CommandTimeout = 1200;
        //                           lRst = lCmd.ExecuteReader();
        //                           if (lRst.HasRows)
        //                           {
        //                               lRst.Read();
        //                               lBarID = lRst.GetInt32(0);
        //                           }
        //                           lRst.Close();
        //                       }
        //                   }
        //                   lProcessObj.CloseNDSConnection(ref lNDSCon);

        //                   var lOrderDetailsDBL = (from p in db.OrderDetailsDouble
        //                                           where p.CustomerCode == lCustomerCode &&
        //                                           p.ProjectCode == lProjectCode &&
        //                                           p.JobID == lJobID &&
        //                                           p.BBSID == lBBSID &&
        //                                           p.BarID == lBarID
        //                                           select p).ToList();
        //                   //return Json(true);
        //                   var lDBLReturn = new OrderDetailsListModels();

        //                   var lBarsDetailsDBLList = new List<OrderDetailsListModels>();
        //                   if (lOrderDetailsDBL != null && lOrderDetailsDBL.Count > 0)
        //                   {
        //                       lBarsDetailsDBLList = new List<OrderDetailsListModels>(
        //                           lOrderDetailsDBL.Select(h => new OrderDetailsListModels
        //                           {
        //                               CustomerCode = h.CustomerCode,
        //                               ProjectCode = h.ProjectCode,
        //                               JobID = h.JobID,
        //                               BBSID = h.BBSID,
        //                               BarID = h.BarID,
        //                               BarSort = h.BarSort,
        //                               Cancelled = h.Cancelled,
        //                               ElementMark = h.ElementMark,
        //                               BarMark = h.BarMark,
        //                               BarType = h.BarType,
        //                               BarSize = h.BarSize,
        //                               BarCAB = h.BarCAB,
        //                               BarSTD = h.BarSTD == false ? null : h.BarSTD,
        //                               BarMemberQty = h.BarMemberQty,
        //                               BarEachQty = h.BarEachQty,
        //                               BarTotalQty = h.BarTotalQty,
        //                               BarShapeCode = h.BarShapeCode,
        //                               A = ((h.A == null) ? null : (h.A > 0 && h.A2 > 0) ? h.A.ToString() + '-' + h.A2.ToString() : h.A.ToString()),
        //                               B = ((h.B == null) ? null : (h.B > 0 && h.B2 > 0) ? h.B.ToString() + '-' + h.B2.ToString() : h.B.ToString()),
        //                               C = ((h.C == null) ? null : (h.C > 0 && h.C2 > 0) ? h.C.ToString() + '-' + h.C2.ToString() : h.C.ToString()),
        //                               D = ((h.D == null) ? null : (h.D > 0 && h.D2 > 0) ? h.D.ToString() + '-' + h.D2.ToString() : h.D.ToString()),
        //                               E = ((h.E == null) ? null : (h.E > 0 && h.E2 > 0) ? h.E.ToString() + '-' + h.E2.ToString() : h.E.ToString()),
        //                               F = ((h.F == null) ? null : (h.F > 0 && h.F2 > 0) ? h.F.ToString() + '-' + h.F2.ToString() : h.F.ToString()),
        //                               G = ((h.G == null) ? null : (h.G > 0 && h.G2 > 0) ? h.G.ToString() + '-' + h.G2.ToString() : h.G.ToString()),
        //                               H = ((h.H == null) ? null : (h.H > 0 && h.H2 > 0) ? h.H.ToString() + '-' + h.H2.ToString() : h.H.ToString()),
        //                               I = ((h.I == null) ? null : (h.I > 0 && h.I2 > 0) ? h.I.ToString() + '-' + h.I2.ToString() : h.I.ToString()),
        //                               J = ((h.J == null) ? null : (h.J > 0 && h.J2 > 0) ? h.J.ToString() + '-' + h.J2.ToString() : h.J.ToString()),
        //                               K = ((h.K == null) ? null : (h.K > 0 && h.K2 > 0) ? h.K.ToString() + '-' + h.K2.ToString() : h.K.ToString()),
        //                               L = ((h.L == null) ? null : (h.L > 0 && h.L2 > 0) ? h.L.ToString() + '-' + h.L2.ToString() : h.L.ToString()),
        //                               M = ((h.M == null) ? null : (h.M > 0 && h.M2 > 0) ? h.M.ToString() + '-' + h.M2.ToString() : h.M.ToString()),
        //                               N = ((h.N == null) ? null : (h.N > 0 && h.N2 > 0) ? h.N.ToString() + '-' + h.N2.ToString() : h.N.ToString()),
        //                               O = ((h.O == null) ? null : (h.O > 0 && h.O2 > 0) ? h.O.ToString() + '-' + h.O2.ToString() : h.O.ToString()),
        //                               P = ((h.P == null) ? null : (h.P > 0 && h.P2 > 0) ? h.P.ToString() + '-' + h.P2.ToString() : h.P.ToString()),
        //                               Q = ((h.Q == null) ? null : (h.Q > 0 && h.Q2 > 0) ? h.Q.ToString() + '-' + h.Q2.ToString() : h.Q.ToString()),
        //                               R = ((h.R == null) ? null : (h.R > 0 && h.R2 > 0) ? h.R.ToString() + '-' + h.R2.ToString() : h.R.ToString()),
        //                               S = ((h.S == null) ? null : (h.S > 0 && h.S2 > 0) ? h.S.ToString() + '-' + h.S2.ToString() : h.S.ToString()),
        //                               T = ((h.T == null) ? null : (h.T > 0 && h.T2 > 0) ? h.T.ToString() + '-' + h.T2.ToString() : h.T.ToString()),
        //                               U = ((h.U == null) ? null : (h.U > 0 && h.U2 > 0) ? h.U.ToString() + '-' + h.U2.ToString() : h.U.ToString()),
        //                               V = ((h.V == null) ? null : (h.V > 0 && h.V2 > 0) ? h.V.ToString() + '-' + h.V2.ToString() : h.V.ToString()),
        //                               W = ((h.W == null) ? null : (h.W > 0 && h.W2 > 0) ? h.W.ToString() + '-' + h.W2.ToString() : h.W.ToString()),
        //                               X = ((h.X == null) ? null : (h.X > 0 && h.X2 > 0) ? h.X.ToString() + '-' + h.X2.ToString() : h.X.ToString()),
        //                               Y = ((h.Y == null) ? null : (h.Y > 0 && h.Y2 > 0) ? h.Y.ToString() + '-' + h.Y2.ToString() : h.Y.ToString()),
        //                               Z = ((h.Z == null) ? null : (h.Z > 0 && h.Z2 > 0) ? h.Z.ToString() + '-' + h.Z2.ToString() : h.Z.ToString()),
        //                               BarLength = ((h.BarLength == null) ? null : (h.BarLength > 0 && h.BarLength2 > 0) ? h.BarLength.ToString() + '-' + h.BarLength2.ToString() : h.BarLength.ToString()),
        //                               BarWeight = h.BarWeight,
        //                               Remarks = h.Remarks,
        //                               shapeTransport = h.shapeTransport,
        //                               PinSize = h.PinSize,
        //                               UpdateDate = h.UpdateDate
        //                           })
        //                       );

        //                   }

        //                   if (lBarsDetailsDBLList != null && lBarsDetailsDBLList.Count > 0)
        //                   {
        //                       if (orderDetailsListModels.BarType == lBarsDetailsDBLList[0].BarType) lDBLReturn.BarType = "1"; else lDBLReturn.BarType = "0";
        //                       if (orderDetailsListModels.BarSize == lBarsDetailsDBLList[0].BarSize) lDBLReturn.BarSize = 1; else lDBLReturn.BarSize = 0;
        //                       if (orderDetailsListModels.BarMemberQty == lBarsDetailsDBLList[0].BarMemberQty) lDBLReturn.BarMemberQty = 1; else lDBLReturn.BarMemberQty = 0;
        //                       if (orderDetailsListModels.BarEachQty == lBarsDetailsDBLList[0].BarEachQty) lDBLReturn.BarEachQty = 1; else lDBLReturn.BarEachQty = 0;
        //                       if (orderDetailsListModels.BarShapeCode == lBarsDetailsDBLList[0].BarShapeCode) lDBLReturn.BarShapeCode = "1"; else lDBLReturn.BarShapeCode = "0";
        //                       if (orderDetailsListModels.A != null && lBarsDetailsDBLList[0].A != null) { if (orderDetailsListModels.A == lBarsDetailsDBLList[0].A) lDBLReturn.A = "1"; else lDBLReturn.A = "0"; }
        //                       if (orderDetailsListModels.B != null && lBarsDetailsDBLList[0].B != null) { if (orderDetailsListModels.B == lBarsDetailsDBLList[0].B) lDBLReturn.B = "1"; else lDBLReturn.B = "0"; }
        //                       if (orderDetailsListModels.C != null && lBarsDetailsDBLList[0].C != null) { if (orderDetailsListModels.C == lBarsDetailsDBLList[0].C) lDBLReturn.C = "1"; else lDBLReturn.C = "0"; }
        //                       if (orderDetailsListModels.D != null && lBarsDetailsDBLList[0].D != null) { if (orderDetailsListModels.D == lBarsDetailsDBLList[0].D) lDBLReturn.D = "1"; else lDBLReturn.D = "0"; }
        //                       if (orderDetailsListModels.E != null && lBarsDetailsDBLList[0].E != null) { if (orderDetailsListModels.E == lBarsDetailsDBLList[0].E) lDBLReturn.E = "1"; else lDBLReturn.E = "0"; }
        //                       if (orderDetailsListModels.F != null && lBarsDetailsDBLList[0].F != null) { if (orderDetailsListModels.F == lBarsDetailsDBLList[0].F) lDBLReturn.F = "1"; else lDBLReturn.F = "0"; }
        //                       if (orderDetailsListModels.G != null && lBarsDetailsDBLList[0].G != null) { if (orderDetailsListModels.G == lBarsDetailsDBLList[0].G) lDBLReturn.G = "1"; else lDBLReturn.G = "0"; }
        //                       if (orderDetailsListModels.H != null && lBarsDetailsDBLList[0].H != null) { if (orderDetailsListModels.H == lBarsDetailsDBLList[0].H) lDBLReturn.H = "1"; else lDBLReturn.H = "0"; }
        //                       if (orderDetailsListModels.I != null && lBarsDetailsDBLList[0].I != null) { if (orderDetailsListModels.I == lBarsDetailsDBLList[0].I) lDBLReturn.I = "1"; else lDBLReturn.I = "0"; }
        //                       if (orderDetailsListModels.J != null && lBarsDetailsDBLList[0].J != null) { if (orderDetailsListModels.J == lBarsDetailsDBLList[0].J) lDBLReturn.J = "1"; else lDBLReturn.J = "0"; }
        //                       if (orderDetailsListModels.K != null && lBarsDetailsDBLList[0].K != null) { if (orderDetailsListModels.K == lBarsDetailsDBLList[0].K) lDBLReturn.K = "1"; else lDBLReturn.K = "0"; }
        //                       if (orderDetailsListModels.L != null && lBarsDetailsDBLList[0].L != null) { if (orderDetailsListModels.L == lBarsDetailsDBLList[0].L) lDBLReturn.L = "1"; else lDBLReturn.L = "0"; }
        //                       if (orderDetailsListModels.M != null && lBarsDetailsDBLList[0].M != null) { if (orderDetailsListModels.M == lBarsDetailsDBLList[0].M) lDBLReturn.M = "1"; else lDBLReturn.M = "0"; }
        //                       if (orderDetailsListModels.N != null && lBarsDetailsDBLList[0].N != null) { if (orderDetailsListModels.N == lBarsDetailsDBLList[0].N) lDBLReturn.N = "1"; else lDBLReturn.N = "0"; }
        //                       if (orderDetailsListModels.O != null && lBarsDetailsDBLList[0].O != null) { if (orderDetailsListModels.O == lBarsDetailsDBLList[0].O) lDBLReturn.O = "1"; else lDBLReturn.O = "0"; }
        //                       if (orderDetailsListModels.P != null && lBarsDetailsDBLList[0].P != null) { if (orderDetailsListModels.P == lBarsDetailsDBLList[0].P) lDBLReturn.P = "1"; else lDBLReturn.P = "0"; }
        //                       if (orderDetailsListModels.Q != null && lBarsDetailsDBLList[0].Q != null) { if (orderDetailsListModels.Q == lBarsDetailsDBLList[0].Q) lDBLReturn.Q = "1"; else lDBLReturn.Q = "0"; }
        //                       if (orderDetailsListModels.R != null && lBarsDetailsDBLList[0].R != null) { if (orderDetailsListModels.R == lBarsDetailsDBLList[0].R) lDBLReturn.R = "1"; else lDBLReturn.R = "0"; }
        //                       if (orderDetailsListModels.S != null && lBarsDetailsDBLList[0].S != null) { if (orderDetailsListModels.S == lBarsDetailsDBLList[0].S) lDBLReturn.S = "1"; else lDBLReturn.S = "0"; }
        //                       if (orderDetailsListModels.T != null && lBarsDetailsDBLList[0].T != null) { if (orderDetailsListModels.T == lBarsDetailsDBLList[0].T) lDBLReturn.T = "1"; else lDBLReturn.T = "0"; }
        //                       if (orderDetailsListModels.U != null && lBarsDetailsDBLList[0].U != null) { if (orderDetailsListModels.U == lBarsDetailsDBLList[0].U) lDBLReturn.U = "1"; else lDBLReturn.U = "0"; }
        //                       if (orderDetailsListModels.V != null && lBarsDetailsDBLList[0].V != null) { if (orderDetailsListModels.V == lBarsDetailsDBLList[0].V) lDBLReturn.V = "1"; else lDBLReturn.V = "0"; }
        //                       if (orderDetailsListModels.W != null && lBarsDetailsDBLList[0].W != null) { if (orderDetailsListModels.W == lBarsDetailsDBLList[0].W) lDBLReturn.W = "1"; else lDBLReturn.W = "0"; }
        //                       if (orderDetailsListModels.X != null && lBarsDetailsDBLList[0].X != null) { if (orderDetailsListModels.X == lBarsDetailsDBLList[0].X) lDBLReturn.X = "1"; else lDBLReturn.X = "0"; }
        //                       if (orderDetailsListModels.Y != null && lBarsDetailsDBLList[0].Y != null) { if (orderDetailsListModels.Y == lBarsDetailsDBLList[0].Y) lDBLReturn.Y = "1"; else lDBLReturn.Y = "0"; }
        //                       if (orderDetailsListModels.Z != null && lBarsDetailsDBLList[0].Z != null) { if (orderDetailsListModels.Z == lBarsDetailsDBLList[0].Z) lDBLReturn.Z = "1"; else lDBLReturn.Z = "0"; }
        //                   }

        //                   return Json(new { success = lSuccess, respDoubleCapture = lDBLReturn }, JsonRequestBehavior.AllowGet);
        //               }
        //               else
        //               {
        //                   lErrorMsg = "Invalid Customer Code";
        //                   lSuccess = false;
        //               }

        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //               lSuccess = false;
        //           }
        //           return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //       }

        private int? getParaValue(string pParameter, byte pPos)
        {
            int? lReturn = null;
            if (pParameter != null)
            {
                if (pParameter.Trim().Length > 0)
                {
                    int lVar = 0;
                    if (int.TryParse(pParameter, out lVar) == true && pPos == 1)
                    {
                        if (lVar > 0) lReturn = lVar;
                    }
                    else
                    {
                        var lArray = pParameter.Split(new[] { '-', '~' });
                        if (lArray != null)
                        {
                            if (lArray.Length >= 2)
                            {
                                lVar = 0;
                                if (pPos == 1)
                                {
                                    if (int.TryParse(lArray[0], out lVar) == true)
                                    {
                                        if (lVar > 0) lReturn = lVar;
                                    }
                                }
                                if (pPos == 2)
                                {
                                    if (int.TryParse(lArray[1], out lVar) == true)
                                    {
                                        if (lVar > 0) lReturn = lVar;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return lReturn;
        }

        //       private string getParaStringValue(string pParameter, byte pPos)
        //       {
        //           string lReturn = "null";
        //           if (pParameter != null)
        //           {
        //               if (pParameter.Trim().Length > 0)
        //               {
        //                   int lVar = 0;
        //                   if (int.TryParse(pParameter, out lVar) == true && pPos == 1)
        //                   {
        //                       if (lVar > 0) lReturn = lVar.ToString();
        //                   }
        //                   else
        //                   {
        //                       var lArray = pParameter.Split(new[] { '-', '~' });
        //                       if (lArray != null)
        //                       {
        //                           if (lArray.Length >= 2)
        //                           {
        //                               lVar = 0;
        //                               if (pPos == 1)
        //                               {
        //                                   if (int.TryParse(lArray[0], out lVar) == true)
        //                                   {
        //                                       if (lVar > 0) lReturn = lVar.ToString();
        //                                   }
        //                               }
        //                               if (pPos == 2)
        //                               {
        //                                   if (int.TryParse(lArray[1], out lVar) == true)
        //                                   {
        //                                       if (lVar > 0) lReturn = lVar.ToString();
        //                                   }
        //                               }
        //                           }
        //                       }
        //                   }
        //               }
        //           }

        //           return lReturn;
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult setCloneOrder(string CustomerCode, string ProjectCode, int JobID, int CloneNo)
        //       {
        //           var lErrorMsg = "";
        //           int? lJobID = 0;
        //           try
        //           {
        //               if (CloneNo > 0)
        //               {
        //                   for (int i = 0; i < CloneNo; i++)
        //                   {
        //                       createJobAdvice(CustomerCode, ProjectCode, true);

        //                       lJobID = db.JobAdvice.Where(z => z.CustomerCode == CustomerCode &&
        //                       z.ProjectCode == ProjectCode).Max(z => (int?)z.JobID);

        //                       //create JobAdvice
        //                       var lJobNewOr = db.JobAdvice.Find(CustomerCode, ProjectCode, lJobID);
        //                       var lJobNew = lJobNewOr;
        //                       var lJobOld = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
        //                       if (lJobOld != null && lJobNew != null)
        //                       {
        //                           lJobNew.OrderStatus = "New";
        //                           //lJobNew.PODate = lJobOld.PODate;
        //                           lJobNew.PODate = DateTime.Now;
        //                           lJobNew.PONumber = lJobOld.PONumber;
        //                           lJobNew.DeliveryAddress = lJobOld.DeliveryAddress;
        //                           lJobNew.Remarks = lJobOld.Remarks;
        //                           lJobNew.RequiredDate = lJobOld.RequiredDate;
        //                           lJobNew.Scheduler_HP = lJobOld.Scheduler_HP;
        //                           lJobNew.Scheduler_Name = lJobOld.Scheduler_Name;
        //                           lJobNew.Scheduler_Tel = lJobOld.Scheduler_Tel;
        //                           lJobNew.SiteEngr_HP = lJobOld.SiteEngr_HP;
        //                           lJobNew.SiteEngr_Name = lJobOld.SiteEngr_Name;
        //                           lJobNew.SiteEngr_Tel = lJobOld.SiteEngr_Tel;
        //                           lJobNew.TotalWeight = lJobOld.TotalWeight;
        //                           lJobNew.TransportLimit = lJobOld.TransportLimit;
        //                           lJobNew.TransportMode = lJobOld.TransportMode;
        //                           lJobNew.OrderSource = lJobOld.OrderSource;
        //                           lJobNew.ProjectStage = lJobOld.ProjectStage;
        //                           lJobNew.TotalCABWeight = lJobOld.TotalCABWeight;
        //                           lJobNew.TotalSTDWeight = lJobOld.TotalSTDWeight;
        //                           lJobNew.TotalWeight = lJobOld.TotalWeight;
        //                           lJobNew.WBS1 = lJobOld.WBS1;
        //                           lJobNew.WBS2 = lJobOld.WBS2;
        //                           lJobNew.WBS3 = lJobOld.WBS3;
        //                           lJobNew.UpdateBy = User.Identity.GetUserName();
        //                           lJobNew.UpdateDate = DateTime.Now;
        //                           db.Entry(lJobNewOr).CurrentValues.SetValues(lJobNew);
        //                       }

        //                       //Create BBS

        //                       var lBBSDel = (from p in db.BBS
        //                                      where p.CustomerCode == CustomerCode &&
        //                                      p.ProjectCode == ProjectCode &&
        //                                      p.JobID == lJobID
        //                                      select p).ToList();
        //                       if (lBBSDel != null && lBBSDel.Count > 0)
        //                       {
        //                           db.BBS.RemoveRange(lBBSDel);
        //                       }

        //                       var lBBSOld = (from p in db.BBS
        //                                      where p.CustomerCode == CustomerCode &&
        //                                      p.ProjectCode == ProjectCode &&
        //                                      p.JobID == JobID
        //                                      select p).ToList();
        //                       if (lBBSOld != null && lBBSOld.Count > 0)
        //                       {
        //                           var lBBSNew = new List<BBSModels>();
        //                           for (int j = 0; j < lBBSOld.Count; j++)
        //                           {

        //                               lBBSNew.Add(new BBSModels
        //                               {
        //                                   CustomerCode = lBBSOld[j].CustomerCode,
        //                                   ProjectCode = lBBSOld[j].ProjectCode,
        //                                   JobID = (int)lJobID,
        //                                   BBSID = lBBSOld[j].BBSID,
        //                                   BBSNo = lBBSOld[j].BBSNo,
        //                                   BBSDesc = lBBSOld[j].BBSDesc,
        //                                   BBSCopiedFrom = lBBSOld[j].BBSCopiedFrom,
        //                                   BBSStrucElem = lBBSOld[j].BBSStrucElem,
        //                                   BBSOrderCABWT = lBBSOld[j].BBSOrderCABWT,
        //                                   BBSOrderSTDWT = lBBSOld[j].BBSOrderSTDWT,
        //                                   BBSCancelledWT = lBBSOld[j].BBSCancelledWT,
        //                                   BBSTotalWT = lBBSOld[j].BBSTotalWT,
        //                                   BBSSOR = lBBSOld[j].BBSSOR,
        //                                   BBSNoNDS = lBBSOld[j].BBSNoNDS,
        //                                   BBSSAPSO = lBBSOld[j].BBSSAPSO,
        //                                   BBSSORCoupler = lBBSOld[j].BBSSORCoupler,
        //                                   BBSNoNDSCoupler = lBBSOld[j].BBSNoNDSCoupler,
        //                                   UpdateDate = DateTime.Now,
        //                                   UpdateBy = User.Identity.GetUserName()
        //                               });
        //                           }
        //                           db.BBS.AddRange(lBBSNew);
        //                       }


        //                       //Create Bar Details
        //                       var lDetDel = (from p in db.OrderDetails
        //                                      where p.CustomerCode == CustomerCode &&
        //                                      p.ProjectCode == ProjectCode &&
        //                                      p.JobID == lJobID
        //                                      select p).ToList();
        //                       if (lDetDel != null && lDetDel.Count > 0)
        //                       {
        //                           db.OrderDetails.RemoveRange(lDetDel);
        //                       }

        //                       var lOldDet = (from p in db.OrderDetails
        //                                      where p.CustomerCode == CustomerCode &&
        //                                      p.ProjectCode == ProjectCode &&
        //                                      p.JobID == JobID
        //                                      select p).ToList();
        //                       if (lOldDet != null && lOldDet.Count > 0)
        //                       {
        //                           var lNewDet = new List<OrderDetailsModels>();
        //                           for (int j = 0; j < lOldDet.Count; j++)
        //                           {
        //                               lNewDet.Add(new OrderDetailsModels
        //                               {
        //                                   CustomerCode = lOldDet[j].CustomerCode,
        //                                   ProjectCode = lOldDet[j].ProjectCode,
        //                                   JobID = (int)lJobID,
        //                                   BBSID = lOldDet[j].BBSID,
        //                                   BarID = lOldDet[j].BarID,
        //                                   BarSort = lOldDet[j].BarSort,
        //                                   Cancelled = lOldDet[j].Cancelled,
        //                                   BarCAB = lOldDet[j].BarCAB,
        //                                   BarSTD = lOldDet[j].BarSTD,
        //                                   ElementMark = lOldDet[j].ElementMark,
        //                                   BarMark = lOldDet[j].BarMark,
        //                                   BarType = lOldDet[j].BarType,
        //                                   BarSize = lOldDet[j].BarSize,
        //                                   BarMemberQty = lOldDet[j].BarMemberQty,
        //                                   BarEachQty = lOldDet[j].BarEachQty,
        //                                   BarTotalQty = lOldDet[j].BarTotalQty,
        //                                   BarShapeCode = lOldDet[j].BarShapeCode,
        //                                   A = lOldDet[j].A,
        //                                   B = lOldDet[j].B,
        //                                   C = lOldDet[j].C,
        //                                   D = lOldDet[j].D,
        //                                   E = lOldDet[j].E,
        //                                   F = lOldDet[j].F,
        //                                   G = lOldDet[j].G,
        //                                   H = lOldDet[j].H,
        //                                   I = lOldDet[j].I,
        //                                   J = lOldDet[j].J,
        //                                   K = lOldDet[j].K,
        //                                   L = lOldDet[j].L,
        //                                   M = lOldDet[j].M,
        //                                   N = lOldDet[j].N,
        //                                   O = lOldDet[j].O,
        //                                   P = lOldDet[j].P,
        //                                   Q = lOldDet[j].Q,
        //                                   R = lOldDet[j].R,
        //                                   S = lOldDet[j].S,
        //                                   T = lOldDet[j].T,
        //                                   U = lOldDet[j].U,
        //                                   V = lOldDet[j].V,
        //                                   W = lOldDet[j].W,
        //                                   X = lOldDet[j].X,
        //                                   Y = lOldDet[j].Y,
        //                                   Z = lOldDet[j].Z,
        //                                   A2 = lOldDet[j].A2,
        //                                   B2 = lOldDet[j].B2,
        //                                   C2 = lOldDet[j].C2,
        //                                   D2 = lOldDet[j].D2,
        //                                   E2 = lOldDet[j].E2,
        //                                   F2 = lOldDet[j].F2,
        //                                   G2 = lOldDet[j].G2,
        //                                   H2 = lOldDet[j].H2,
        //                                   I2 = lOldDet[j].I2,
        //                                   J2 = lOldDet[j].J2,
        //                                   K2 = lOldDet[j].K2,
        //                                   L2 = lOldDet[j].L2,
        //                                   M2 = lOldDet[j].M2,
        //                                   N2 = lOldDet[j].N2,
        //                                   O2 = lOldDet[j].O2,
        //                                   P2 = lOldDet[j].P2,
        //                                   Q2 = lOldDet[j].Q2,
        //                                   R2 = lOldDet[j].R2,
        //                                   S2 = lOldDet[j].S2,
        //                                   T2 = lOldDet[j].T2,
        //                                   U2 = lOldDet[j].U2,
        //                                   V2 = lOldDet[j].Y2,
        //                                   W2 = lOldDet[j].W2,
        //                                   X2 = lOldDet[j].X2,
        //                                   Y2 = lOldDet[j].Y2,
        //                                   Z2 = lOldDet[j].Z2,
        //                                   BarLength = lOldDet[j].BarLength,
        //                                   BarLength2 = lOldDet[j].BarLength2,
        //                                   BarWeight = lOldDet[j].BarWeight,
        //                                   Remarks = lOldDet[j].Remarks,
        //                                   shapeTransport = lOldDet[j].shapeTransport,
        //                                   PinSize = lOldDet[j].PinSize,
        //                                   UpdateDate = DateTime.Now,
        //                                   UpdateBy = User.Identity.GetUserName(),
        //                                   CreateDate = DateTime.Now,
        //                                   CreateBy = User.Identity.GetUserName()
        //                               });
        //                           }
        //                           db.OrderDetails.AddRange(lNewDet);
        //                       }
        //                       db.SaveChanges();
        //                   }
        //               }
        //               return Json(new { success = true, responseText = "Successfully saved." }, JsonRequestBehavior.AllowGet);
        //           }
        //           catch (Exception ex)
        //           {
        //               lErrorMsg = ex.Message;
        //           }
        //           return Json(new { success = false, responseText = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //       }


        //       // POST: Customer/deleteBBS/
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult deleteBarDetails(string CustomerCode, string ProjectCode, int JobID, int BBSID, int BarID)
        //       {
        //           bool lSuccess = true;
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();
        //           string lErrorMsg = "";
        //           string lSQL = "";

        //           try
        //           {
        //               var lProcessObj = new ProcessController();
        //               if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //               {
        //                   var lStatus = "";

        //                   lSQL = "SELECT isNull(OrderStatus,'') " +
        //                   "FROM dbo.OESJobAdvice " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND JobID = " + JobID.ToString() + " ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandText = lSQL;
        //                   lCmd.CommandTimeout = 1200;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       lRst.Read();
        //                       lStatus = lRst.GetString(0);
        //                   }
        //                   lRst.Close();

        //                   if (lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
        //                   {
        //                       string lUpdatedBy = "";
        //                       lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
        //                       "FROM dbo.OESOrderDetails " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " " +
        //                       "AND UpdateDate >= DateAdd(ss,-60,getDate()) " +
        //                       "AND UpdateBy <> '" + User.Identity.GetUserName() + "' ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandText = lSQL;
        //                       lCmd.CommandTimeout = 1200;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           lRst.Read();
        //                           lUpdatedBy = lRst.GetString(0).Trim();
        //                       }
        //                       lRst.Close();

        //                       if (lUpdatedBy != "")
        //                       {
        //                           lProcessObj.CloseNDSConnection(ref lNDSCon);
        //                           lSuccess = false;
        //                           lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
        //                           return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //                       }

        //                       //for userid recording purpose in trigger
        //                       lSQL = "UPDATE dbo.OESOrderDetails " +
        //                       "SET PartGUID = '" + User.Identity.GetUserName() + "' " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND JobID = " + JobID.ToString() + " " +
        //                       "AND BBSID = " + BBSID.ToString() + " " +
        //                       "AND BarID = " + BarID.ToString() + " ";

        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandText = lSQL;
        //                       lCmd.CommandTimeout = 1200;
        //                       lCmd.ExecuteNonQuery();

        //                       var oldBar = db.OrderDetails.Find(CustomerCode, ProjectCode, JobID, BBSID, BarID);
        //                       if (oldBar != null)
        //                       {
        //                           db.OrderDetails.Remove(oldBar);
        //                           var lRtn = db.SaveChanges();
        //                       }
        //                   }
        //                   lProcessObj.CloseNDSConnection(ref lNDSCon);
        //               }
        //               lProcessObj = null;
        //           }
        //           catch (Exception e)
        //           {
        //               lSuccess = false;
        //               lErrorMsg = e.Message;
        //           }
        //           return Json(new { success = lSuccess, ErrorMessage = lErrorMsg }, JsonRequestBehavior.AllowGet);
        //           //return RedirectToAction("Index");
        //       }

        //       //getShapeImagesByCat
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getShapeImagesByCat(string CustomerCode, string ProjectCode, string ShapeCategory, string CouplerType)
        //       {
        //           var lUserName = User.Identity.GetUserName();
        //           //if (ShapeCategory != null)
        //           //{
        //           //    var lCoupler = ShapeCategory.Trim();
        //           //    if (lCoupler == "E-Splice")
        //           //    {
        //           //        lCoupler = "E";
        //           //    }
        //           //    if (lCoupler == "N-Splice")
        //           //    {
        //           //        lCoupler = "N";
        //           //    }

        //           //    var content = (from p in db.Shape
        //           //                   where p.shapeCategory == lCoupler 
        //           //                   orderby p.shapeCode
        //           //                   select new {p.shapeCode, p.shapeImage }
        //           //                   ).ToList();
        //           //    return Json(content, JsonRequestBehavior.AllowGet);
        //           //}
        //           //else
        //           //{
        //           //    return Json("", JsonRequestBehavior.AllowGet);
        //           //}
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lReturn = (new[]{ new
        //           {
        //               shapeCode = "",
        //               shapeImage = new byte[]{ }
        //           }}).ToList();

        //           var lShapes = (new[]{ new
        //           {
        //               shapeCode = "",
        //               shapeImage = new byte[]{ }
        //           }}).ToList();

        //           var lCoupler = "ZZZNO";
        //           if (CouplerType == "N-Splice")
        //           {
        //               lCoupler = "N";
        //           }
        //           if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
        //           {
        //               lCoupler = "E";
        //           }
        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {

        //               if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
        //               {
        //                   if (ShapeCategory == "N-Splice Coupler")
        //                   {
        //                       lCmd.CommandText =
        //                       "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                       "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                       "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                       "AND CSM_ACT_INACTIVE = 1 " +
        //                       "AND (CSM_SHAPE_ID LIKE 'H%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'I%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'J%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'K%') " +
        //                       "ORDER BY CSM_SHAPE_ID ";
        //                   }
        //                   else if (ShapeCategory == "E-Splice Coupler")
        //                   {
        //                       lCmd.CommandText =
        //                       "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                       "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                       "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                       "AND CSM_ACT_INACTIVE = 1 " +
        //                       "AND (CSM_SHAPE_ID LIKE 'C%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'P%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'N%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'S%') " +
        //                       "ORDER BY CSM_SHAPE_ID ";
        //                   }
        //                   else if (ShapeCategory == "Most Common Shapes")
        //                   {
        //                       var lProject = "0000000000";
        //                       var lCount = 0;
        //                       lCmd.CommandText =
        //                       "SELECT COUNT(*) FROM OESTopShape WHERE ProjectCode = '" + ProjectCode + "' ";
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           if (lRst.Read())
        //                           {
        //                               lCount = lRst.GetInt32(0);
        //                           }
        //                       }
        //                       lRst.Close();

        //                       if (lCount > 0)
        //                       {
        //                           lProject = ProjectCode;
        //                       }

        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                   }
        //                   else
        //                   {
        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                   }
        //               }
        //               else
        //               {
        //                   if (ShapeCategory == "N-Splice Coupler")
        //                   {
        //                       lCmd.CommandText =
        //                       "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                       "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                       "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                       "AND CSM_ACT_INACTIVE = 1 " +
        //                       "AND (CSM_SHAPE_ID LIKE 'H%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'I%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'J%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'K%') " +
        //                       "ORDER BY CSM_SHAPE_ID ";
        //                   }
        //                   else if (ShapeCategory == "E-Splice Coupler")
        //                   {
        //                       lCmd.CommandText =
        //                       "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                       "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                       "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                       "AND CSM_ACT_INACTIVE = 1 " +
        //                       "AND (CSM_SHAPE_ID LIKE 'C%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'P%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'N%' " +
        //                       "OR CSM_SHAPE_ID LIKE 'S%') " +
        //                       "ORDER BY CSM_SHAPE_ID ";
        //                   }
        //                   else if (ShapeCategory == "Most Common Shapes")
        //                   {
        //                       var lProject = "0000000000";
        //                       var lCount = 0;
        //                       lCmd.CommandText =
        //                       "SELECT COUNT(*) FROM OESTopShape WHERE ProjectCode = '" + ProjectCode + "' ";
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           if (lRst.Read())
        //                           {
        //                               lCount = lRst.GetInt32(0);
        //                           }
        //                       }
        //                       lRst.Close();

        //                       if (lCount > 0)
        //                       {
        //                           lProject = ProjectCode;
        //                       }

        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
        //                           "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
        //                           "AND ProjectCode = '" + lProject + "' " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                   }
        //                   else
        //                   {
        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
        //                           "OR 'All Shapes' = '" + ShapeCategory + "') " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                   }

        //               }
        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       string lShapeCode = lRst.GetString(0);
        //                       if (lShapeCode == null)
        //                       {
        //                           lShapeCode = "";
        //                       }
        //                       if (lShapeCode.Length > 0)
        //                       {
        //                           lShapeCode = lShapeCode.StartsWith("0") == true ? lShapeCode.Substring(1) : lShapeCode;
        //                       }

        //                       byte[] lShapeImage = (byte[])lRst.GetValue(1);

        //                       lShapes.Add(new
        //                       {
        //                           shapeCode = lShapeCode,
        //                           shapeImage = lShapeImage

        //                       });
        //                   }
        //               }
        //               lRst.Close();

        //               if (lShapes.Count > 1)
        //               {
        //                   for (int i = 1; i < lShapes.Count; i++)
        //                   {
        //                       System.Drawing.Image image = System.Drawing.Image.FromStream(new MemoryStream(lShapes[i].shapeImage));
        //                       System.Drawing.Bitmap bmp = ConvertToRGB((System.Drawing.Bitmap)image);

        //                       lCmd.CommandText =
        //                       "SELECT INTPARAMSEQ, " +
        //                       "LTRIM(RTRIM(CHRPARAMNAME)), " +
        //                       "CASE " +
        //                       "WHEN INTXCOORD IS NULL THEN 0 " +
        //                       "ELSE INTXCOORD " +
        //                       "END AS INTXCOORD, " +
        //                       "CASE " +
        //                       "WHEN INTYCOORD IS NULL THEN 0 " +
        //                       "ELSE INTYCOORD " +
        //                       "END AS INTYCOORD, " +
        //                       "CASE " +
        //                       "WHEN INTZCOORD IS NULL THEN 0 " +
        //                       "ELSE INTZCOORD " +
        //                       "END AS INTZCOORD " +
        //                       "FROM dbo.T_CAB_SHAPE_DTLS C, " +
        //                       "dbo.shapeparamdetails_cube P, " +
        //                       "dbo.shapemaster_cube M " +
        //                       "WHERE C.CSD_SHAPE_ID = M.chrShapeCode " +
        //                       "AND M.intShapeID = P.intShapeID " +
        //                       "AND C.CSD_SEQ_NO = P.intParamSeq " +
        //                       "AND CSD_SHAPE_ID = '" + lShapes[i].shapeCode + "' " +
        //                       "AND bitVISIBLE = 1 " +
        //                       "AND chrAngleType <> 'E' " +
        //                       "AND chrAngleType <> 'N' " +
        //                       "AND chrAngleType <> 'EL' " +
        //                       "ORDER BY CHRPARAMNAME ";
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           while (lRst.Read())
        //                           {
        //                               int lSeq = lRst.GetInt32(0);
        //                               string lParam = lRst.GetString(1).Trim();
        //                               int lTextX = lRst.GetInt32(2);
        //                               int lTextY = lRst.GetInt32(3);

        //                               System.Drawing.Graphics g = System.Drawing.Graphics.FromImage(bmp);
        //                               g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
        //                               g.DrawString(lParam, new System.Drawing.Font("Areal Black", 12f, System.Drawing.FontStyle.Bold), System.Drawing.Brushes.Black, new System.Drawing.Point(lTextX + 4, lTextY + 4));
        //                               g.Save();
        //                               g.Dispose();
        //                           }
        //                       }
        //                       lRst.Close();

        //                       System.Drawing.Image lThumbnail = bmp.GetThumbnailImage(100, 100, new System.Drawing.Image.GetThumbnailImageAbort(ThumbnailCallback), IntPtr.Zero);

        //                       MemoryStream lMS = new MemoryStream();
        //                       lThumbnail.Save(lMS, System.Drawing.Imaging.ImageFormat.Png);
        //                       byte[] byteArr = lMS.ToArray();

        //                       lReturn.Add(new
        //                       {
        //                           shapeCode = lShapes[i].shapeCode,
        //                           shapeImage = byteArr

        //                       });

        //                       //lReturn.Add(new
        //                       //{
        //                       //    shapeCode = lShapes[i].shapeCode,
        //                       //    shapeImage = lShapes[i].shapeImage

        //                       //});

        //                   }

        //               }


        //               lShapes = null;

        //               if (lReturn.Count == 1)
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT shapeCode, shapeImage " +
        //                   "FROM dbo.OESCustomShapes " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' " +
        //                   "AND shapeCategory = '" + ShapeCategory + "' " +
        //                   "ORDER BY shapeCode ";

        //                   lCmd.Connection = lNDSCon;
        //                   lCmd.CommandTimeout = 300;
        //                   lRst = lCmd.ExecuteReader();
        //                   if (lRst.HasRows)
        //                   {
        //                       while (lRst.Read())
        //                       {
        //                           lReturn.Add(new
        //                           {
        //                               shapeCode = lRst.GetString(0),
        //                               shapeImage = (byte[])lRst.GetValue(1)
        //                           });
        //                       }
        //                   }
        //                   lRst.Close();
        //               }

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;

        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           //lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

        //           return new JsonResult() { Data = lReturn, MaxJsonLength = 20480000, JsonRequestBehavior = JsonRequestBehavior.AllowGet };
        //           //return Ok(lReturn);

        //       }

        public bool ThumbnailCallback()
        {
            return false;
        }

        private System.Drawing.Bitmap ConvertToRGB(System.Drawing.Bitmap original)
        {
            System.Drawing.Bitmap newImage = new System.Drawing.Bitmap(original.Width, original.Height, System.Drawing.Imaging.PixelFormat.Format32bppArgb);
            newImage.SetResolution(original.HorizontalResolution, original.VerticalResolution);
            System.Drawing.Graphics g = System.Drawing.Graphics.FromImage(newImage);
            g.DrawImageUnscaled(original, 0, 0);
            g.Dispose();
            return newImage;
        }

        //       //get Bars List 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public async Task<ActionResult> getAllShapeInfo()
        //       {
        //           var lReturn = new List<ShapeConfViewModels>();
        //           var lNDSCon = new SqlConnection();
        //           var lProcessObj = new ProcessController();

        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               var lUserName = User.Identity.GetUserName();
        //               var lCmd = new SqlCommand();
        //               SqlDataReader lRst;

        //               var lShapeCodeList = (new[]{ new
        //               {
        //                   shapeCode = "",
        //                   shapeCategory = ""
        //               }}).ToList();
        //               lShapeCodeList.RemoveAt(0);

        //               if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                   "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                   "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                   "AND CSM_ACT_INACTIVE = 1 " +
        //                   "AND CSM_SHAPE_ID IS NOT NULL " +
        //                   "AND CSM_SHAPE_ID <> '' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                   "ORDER BY CSM_SHAPE_ID ";
        //               }
        //               else
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                   "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                   "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                   "AND CSM_ACT_INACTIVE = 1 " +
        //                   "AND CSM_SHAPE_ID IS NOT NULL " +
        //                   "AND CSM_SHAPE_ID <> '' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                   "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                   "ORDER BY CSM_SHAPE_ID ";
        //               }
        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       string lShapeCode = lRst.GetString(0);
        //                       if (lShapeCode == null)
        //                       {
        //                           lShapeCode = "";
        //                       }
        //                       lShapeCode = lShapeCode.Trim();
        //                       if (lShapeCode != "")
        //                       {
        //                           lShapeCodeList.Add(new
        //                           {
        //                               shapeCode = lShapeCode,
        //                               shapeCategory = lRst.GetString(1)
        //                           });
        //                       }
        //                   }
        //               }
        //               lRst.Close();
        //               if (lShapeCodeList.Count > 0)
        //               {
        //                   for (int i = 0; i < lShapeCodeList.Count; i++)
        //                   {
        //                       lReturn.Add(await getShapeInfoFunAsync("", "", 0, lShapeCodeList[i].shapeCode, lNDSCon, 1));
        //                   }
        //               }

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }

        //           lProcessObj = null;
        //           lNDSCon = null;

        //           lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

        //           return new JsonResult() { Data = lReturn, MaxJsonLength = 20480000, JsonRequestBehavior = JsonRequestBehavior.AllowGet };

        //       }

        //get Bars List 
        [HttpGet]
        [Route("/getShapeInfo/{CustomerCode}/{ProjectCode}/{JobID}/{ShapeCode}")]
        public async Task<ActionResult> getShapeInfo(string CustomerCode, string ProjectCode, int JobID, string ShapeCode)
        {
            var lReturn = new ShapeConfViewModels();
            var lNDSCon = new SqlConnection();
            var lProcessObj = new ProcessController();
            var lShapeCode = ShapeCode;

            if (lShapeCode != null)
            {
                while (lShapeCode.Length < 3)
                {
                    lShapeCode = "0" + lShapeCode;
                }
            }

            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                lReturn = await getShapeInfoFunAsync(CustomerCode, ProjectCode, JobID, lShapeCode, lNDSCon, 1);

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }

            lProcessObj = null;
            lNDSCon = null;

            return Ok(lReturn);

        }

        [HttpGet]
        [Route("/getShapeInfoFunDB/{CustomerCode}/{ProjectCode}/{JobID}/{ShapeCode}/{ImageInd}")]
        public async Task<ShapeConfViewModels> getShapeInfoFunDB(string CustomerCode, string ProjectCode, int JobID, string ShapeCode, int ImageInd)
        {
            var lReturn = new ShapeConfViewModels();
            var lNDSCon = new SqlConnection();
            var lProcessObj = new ProcessController();
            var lShapeCode = ShapeCode;

            if (lShapeCode != null)
            {
                while (lShapeCode.Length < 3)
                {
                    lShapeCode = "0" + lShapeCode;
                }
            }

            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                lReturn = await getShapeInfoFunAsync(CustomerCode, ProjectCode, JobID, lShapeCode, lNDSCon, ImageInd);

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }

            lProcessObj = null;
            lNDSCon = null;

            return lReturn;
        }


        [HttpGet]
        [Route("/getShapeInfoFunAsync/{CustomerCode}/{ProjectCode}/{JobID}/{ShapeCode}/{ImageInd}")]
        public async Task<ShapeConfViewModels> getShapeInfoFunAsync(string CustomerCode, string ProjectCode, int JobID, string ShapeCode, SqlConnection pNDSCon, int ImageInd)
        {
            var lReturn = new ShapeConfViewModels();
            if (ShapeCode != null)
            {
                //var content = db.Shape.Find(ShapeCode);
                //if (content == null)
                //{
                //    var content1 = db.CustomerShape.Find(CustomerCode, ProjectCode, ShapeCode);
                //    if (content1 != null)
                //    {
                //        content = new ShapeModels
                //        {
                //            shapeCode = content1.shapeCode,
                //            shapeCategory = content1.shapeCategory,
                //            shapeParameters = content1.shapeParameters,
                //            shapeLengthFormula = content1.shapeLengthFormula,
                //            shapeParaValidator = "",
                //            shapeTransportValidator = "",
                //            shapeImage = content1.shapeImage,
                //            shapeCreated = content1.shapeCreated
                //        };
                //    }
                //}
                //return Json(content, JsonRequestBehavior.AllowGet);

                var lCmd = new SqlCommand();
                SqlDataReader lRst;

                var lSeqL = new List<int>();
                var lParNameL = new List<string>();
                var lAngleTypeL = new List<string>();
                var lVisibleL = new List<string>();
                var lHtAngleL = new List<string>();
                var lCustomL = new List<string>();
                var lOffsetAngleL = new List<string>();
                var lHtSuAngleL = new List<string>();
                var lOffsetSuAngleL = new List<string>();

                var lShapeCategory = "";
                Byte[] lImageBytes = new byte[0];
                DateTime lUpdateDate = DateTime.Now;
                var lVisible = "";
                var lPar1 = "";
                var lPar2 = "";
                var lType = "";
                var lTextX = 0;
                var lTextY = 0;
                var lInputType = "";
                var lView = "";
                var lProdlength = "";
                var lLenCABFormula = "";
                var lEnvLength = "";
                var lEnvWidth = "";
                var lEnvHeight = "";
                var lSymmetry = "";
                var lCFormula = "";
                var lFormula1 = "";
                var lFormula2 = "";
                var lFormula3 = "";
                var lSeq = 0;
                var lChangeType = "";
                var lChangeTypeOrg = "";
                var lHeightCheckPar = "";
                var lDefValue = 0;

                var lParameters = "";

                var lLengthFormula = "";
                var lParaX = "";
                var lParaY = "";
                var lCalcFormula1 = "";
                var lCalcFormula2 = "";
                var lCalcFormula3 = "";
                var lParsType = "";
                var lHeightCheck = "";
                var lDefaultValue = "";



                lCmd.Connection = pNDSCon;
                lCmd.CommandTimeout = 300;

                if (ImageInd > 0)
                {
                    lCmd.CommandText =
                    "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, CSM_SHAPE_IMAGE, CSM_CRT_ON " +
                    "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                    "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                    "AND CSM_SHAPE_ID = '" + ShapeCode + "' " +
                    "AND CSM_ACT_INACTIVE = 1 ";
                }
                else
                {
                    lCmd.CommandText =
                    "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, CAST(0 as varBinary(1) ), CSM_CRT_ON " +
                    "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                    "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                    "AND CSM_SHAPE_ID = '" + ShapeCode + "' " +
                    "AND CSM_ACT_INACTIVE = 1 ";
                }


                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    if (lRst.Read())
                    {
                        lShapeCategory = lRst.GetString(1);
                        lImageBytes = (byte[])lRst.GetValue(2);
                        lUpdateDate = lRst.GetDateTime(3);
                    }
                }
                lRst.Close();

                lCmd.CommandText =
                "SELECT INTPARAMSEQ, " +
                "LTRIM(RTRIM(isnull(CHRPARAMNAME,''))), " +
                "CASE " +
                "WHEN CHRANGLETYPE IS NULL THEN '' " +
                "ELSE CHRANGLETYPE " +
                "END AS ANGLETYPE, " +
                "CASE " +
                "WHEN BITVISIBLE = 1 THEN 'VISIBLE' " +
                "ELSE 'INVISIBLE' " +
                "END AS VISIBLE, " +
                "CASE " +
                "WHEN VCHCUSTOMFORMULA IS NULL THEN '' " +
                "ELSE VCHCUSTOMFORMULA " +
                "END AS FORMULA, " +
                //-- ****************************************************
                //--START: Added for CAB Shape Param Validation
                "CASE " +
                "WHEN vchHeightAngleFormula IS NULL THEN '' " +
                "ELSE vchHeightAngleFormula " +
                "END AS HEIGHTANGLEFORMULA, " +
                "CASE " +
                "WHEN vchOffsetAngleFormula IS NULL THEN '' " +
                "ELSE vchOffsetAngleFormula " +
                "END AS OffsetAngleFormula, " +
                "CASE " +
                "WHEN vchHeightSuceedAngleFormula IS NULL THEN  '' " +
                "ELSE vchHeightSuceedAngleFormula " +
                "END AS HeightSuceedAngleFormula, " +
                "CASE " +
                "WHEN vchOffsetSuceedAngleFormula IS NULL THEN  '' " +
                "ELSE vchOffsetSuceedAngleFormula " +
                "END AS OffsetSuceedAngleFormula " +
                "FROM   SHAPEPARAMDETAILS_CUBE " +
                "WHERE  INTSHAPEID = (SELECT INTSHAPEID " +
                "FROM   SHAPEMASTER_CUBE " +
                "WHERE  CHRSHAPECODE = '" + ShapeCode + "') " +
                "ORDER BY INTPARAMSEQ ";
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        lSeqL.Add(lRst.GetInt32(0));
                        lParNameL.Add(lRst.GetString(1).Trim());
                        lAngleTypeL.Add(lRst.GetString(2).Trim());
                        lVisibleL.Add(lRst.GetString(3).Trim());
                        lCustomL.Add(lRst.GetString(4).Trim());
                        lHtAngleL.Add(lRst.GetString(5).Trim());
                        lOffsetAngleL.Add(lRst.GetString(6).Trim());
                        lHtSuAngleL.Add(lRst.GetString(7).Trim());
                        lOffsetSuAngleL.Add(lRst.GetString(8).Trim());
                    }
                }
                lRst.Close();


                lCmd.CommandText =
                "SELECT INTPARAMSEQ, " +
                "LTRIM(RTRIM(CHRPARAMNAME)), " +
                "CASE " +
                "WHEN INTXCOORD IS NULL THEN 0 " +
                "ELSE INTXCOORD " +
                "END AS INTXCOORD, " +
                "CASE " +
                "WHEN INTYCOORD IS NULL THEN 0 " +
                "ELSE INTYCOORD " +
                "END AS INTYCOORD, " +
                "CASE " +
                "WHEN INTZCOORD IS NULL THEN 0 " +
                "ELSE INTZCOORD " +
                "END AS INTZCOORD, " +
                "CASE " +
                "WHEN BITVISIBLE = 1 THEN 'VISIBLE' " +
                "ELSE 'INVISIBLE' " +
                "END AS VISIBLE, " +
                "CASE LTRIM(RTRIM(P.CHRANGLETYPE)) " +
                "WHEN 'HK' THEN 'LENGTH' " +
                "WHEN 'S' THEN 'LENGTH' " +
                "WHEN 'V' THEN 'ANGLE' " +
                "WHEN 'R' THEN 'RADIUS' " +
                "WHEN 'H' THEN 'HEIGHT' " +
                "WHEN 'D' THEN 'DIAMETER' " +
                "WHEN 'E' THEN 'ESPLICE' " +
                "WHEN 'D' THEN 'DEXTRA' " +
                "WHEN 'N' THEN 'NSPLICE' " +
                "WHEN 'EL' THEN 'COUPLER_LENGTH' " +
                "WHEN 'RL' THEN 'ARC_RADIUS' " +
                "WHEN 'RH' THEN 'ARC_HEIGHT' " +
                "WHEN 'SN' THEN 'ARC_SPAN' " +
                "WHEN 'O' THEN 'OFFSET' " +
                "WHEN 'OH' THEN 'OFF-NOR-HEIGHT' " +
                "WHEN 'OO' THEN 'OFF-NOR-OFFSET' " +
                "WHEN 'RO' THEN 'ROUND' " +
                "END AS CHRANGLETYPE, " +
                "CASE " +
                "WHEN VCHSYMMETRYINDEX IS NULL THEN '' " +
                "ELSE VCHSYMMETRYINDEX " +
                "END AS SYMMETRICTO, " +
                "CASE " +
                "WHEN VCHCUSTOMFORMULA IS NULL THEN '' " +
                "ELSE VCHCUSTOMFORMULA " +
                "END AS FORMULA, " +
                //-- ****************************************************
                //--START: Added for CAB Shape Param Validation
                "CASE " +
                "WHEN vchHeightAngleFormula IS NULL THEN '' " +
                "ELSE vchHeightAngleFormula " +
                "END AS HEIGHTANGLEFORMULA, " +
                "CASE " +
                "WHEN intConstValue IS NULL THEN 0 " +
                "ELSE intConstValue " +
                "END AS RoundOffRANGE, " +
                //--END: Added for CAB Shape Param Validation
                //-- * ***************************************************
                "CASE " +
                "WHEN DEFAULTPARAMVALUE IS NULL THEN 500 " +
                "WHEN DEFAULTPARAMVALUE = 0 THEN 500 " +
                "ELSE DEFAULTPARAMVALUE " +
                "END AS DEFAULTPARAMVALUE, " +
                "P.CHRANGLETYPE, " +
                "CSD_MATCH_PAR2, " +
                "CASE WHEN P.CHRANGLETYPE = 'S' AND " +
                "(SELECT count(intParamSeq) FROM dbo.shapeparamdetails_cube " +
                "WHERE intShapeID = P.intShapeID AND CHRANGLETYPE = 'S' " +
                "AND chrAngleType <> 'E' " +
                "AND chrAngleType <> 'N' " +
                "AND chrAngleType <> 'El' " +
                "AND intParamSeq < P.intParamSeq) = 0 " +
                "THEN 1 " +
                "WHEN P.CHRANGLETYPE = 'S' AND " +
                "(SELECT count(intParamSeq) FROM dbo.shapeparamdetails_cube " +
                "WHERE intShapeID = P.intShapeID AND CHRANGLETYPE = 'S' " +
                "AND chrAngleType <> 'E' " +
                "AND chrAngleType <> 'N' " +
                "AND chrAngleType <> 'El' " +
                "AND intParamSeq > P.intParamSeq) = 0 " +
                "THEN 3 " +
                "WHEN P.CHRANGLETYPE = 'S' AND " +
                "(select isNull(Max(DefaultParamValue), 0) from dbo.shapeparamdetails_cube " +
                "where intShapeID = P.intShapeID " +
                "AND chrAngleType<> 'E' " +
                "AND chrAngleType<> 'N' " +
                "AND chrAngleType<> 'EL' " +
                "AND intParamSeq = P.intParamSeq - 1 ) = 90 " +
                "AND (select isNull(Max(DefaultParamValue), 0) from dbo.shapeparamdetails_cube " +
                "where intShapeID = P.intShapeID " +
                "AND chrAngleType <> 'E' " +
                "AND chrAngleType <> 'N' " +
                "AND chrAngleType <> 'EL' " +
                "AND intParamSeq = P.intParamSeq + 1) = 90 " +
                "THEN 2 " +
                "ELSE DefaultParamValue END " +
                "AS DefaultParamValue " +
                "FROM dbo.T_CAB_SHAPE_DTLS C, " +
                "dbo.shapeparamdetails_cube P, " +
                "dbo.shapemaster_cube M " +
                "WHERE C.CSD_SHAPE_ID = M.chrShapeCode " +
                "AND M.intShapeID = P.intShapeID " +
                "AND C.CSD_SEQ_NO = P.intParamSeq " +
                "AND CSD_SHAPE_ID = '" + ShapeCode + "' " +
                "AND bitVISIBLE = 1 " +
                "AND chrAngleType <> 'E' " +
                "AND chrAngleType <> 'N' " +
                "AND chrAngleType <> 'EL' " +
                "ORDER BY CHRPARAMNAME ";
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        lSeq = lRst.GetInt32(0);
                        lPar1 = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim();
                        lTextX = lRst.GetValue(2) == DBNull.Value ? 0 : lRst.GetInt32(2);
                        lTextY = lRst.GetValue(3) == DBNull.Value ? 0 : lRst.GetInt32(3);
                        lChangeType = lRst.GetValue(6) == DBNull.Value ? "" : lRst.GetString(6).Trim();
                        lCFormula = lRst.GetValue(8) == DBNull.Value ? "" : lRst.GetString(8).Trim();
                        lChangeTypeOrg = lRst.GetValue(12) == DBNull.Value ? "" : lRst.GetString(12).Trim();
                        lHeightCheckPar = lRst.GetValue(13) == DBNull.Value ? "" : lRst.GetString(13).Trim();
                        lDefValue = lRst.GetValue(14) == DBNull.Value ? 0 : lRst.GetInt32(14);

                        lFormula1 = lCFormula;
                        lFormula2 = "";
                        lFormula3 = "";

                        //Height to check its hypo
                        if (lSeq > 1)
                        {
                            if (lChangeType == "HEIGHT" && lParNameL[lSeq - 2] != lHeightCheckPar && lAngleTypeL[lSeq - 2] == "S")
                            {
                                lHeightCheckPar = lParNameL[lSeq - 2];
                            }
                        }

                        //Check and take formula from HeightAngle field
                        #region HeightAngle
                        if (lChangeType == "ANGLE")
                        {
                            //Height and angle
                            if (lSeqL.Count > lSeq + 1)
                            {
                                if (lVisibleL[lSeq + 1] == "VISIBLE" && lAngleTypeL[lSeq + 1] == "H" && lHtAngleL[lSeq + 1].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtAngleL[lSeq + 1];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtAngleL[lSeq + 1];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtAngleL[lSeq + 1];
                                    }
                                }
                            }
                        }

                        if (lChangeType == "HEIGHT")
                        {
                            //Height and angle
                            if (lSeq > 2)
                            {
                                if (lVisibleL[lSeq - 3] == "VISIBLE" && lAngleTypeL[lSeq - 3] == "V" && lHtAngleL[lSeq - 3].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtAngleL[lSeq - 3];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtAngleL[lSeq - 3];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtAngleL[lSeq - 3];
                                    }
                                }
                            }
                        }

                        //Offset height such as shape 5E2
                        if (lChangeType == "OFF-NOR-HEIGHT")
                        {
                            if (lSeqL.Count > lSeq + 1)
                            {
                                if (lVisibleL[lSeq + 1] == "VISIBLE" && lAngleTypeL[lSeq + 1] == "OO" && lHtAngleL[lSeq + 1].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtAngleL[lSeq + 1];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtAngleL[lSeq + 1];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtAngleL[lSeq + 1];
                                    }
                                }
                            }
                        }

                        if (lChangeType == "OFF-NOR-OFFSET")
                        {
                            if (lSeq > 0)
                            {
                                if (lVisibleL[lSeq - 1] == "VISIBLE" && lAngleTypeL[lSeq - 1] == "OH" && lHtAngleL[lSeq - 1].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtAngleL[lSeq - 1];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtAngleL[lSeq - 1];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtAngleL[lSeq - 1];
                                    }
                                }
                            }
                        }
                        #endregion HeightAngle

                        //Check and take formula from HeightSuAngle field
                        #region HeightSuAngle
                        if (lChangeType == "ANGLE")
                        {
                            //Height and angle
                            if (lSeq > 1)
                            {
                                if (lVisibleL[lSeq - 2] == "VISIBLE" && lAngleTypeL[lSeq - 2] == "H" && lHtSuAngleL[lSeq - 2].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtSuAngleL[lSeq - 2];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtSuAngleL[lSeq - 2];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtSuAngleL[lSeq - 2];
                                    }
                                }
                            }

                            if (lSeq > 2)
                            {
                                if (lVisibleL[lSeq - 3] == "VISIBLE" && lAngleTypeL[lSeq - 3] == "OH" && lHtSuAngleL[lSeq - 3].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtSuAngleL[lSeq - 3];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtSuAngleL[lSeq - 3];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtSuAngleL[lSeq - 3];
                                    }
                                }
                            }
                        }

                        if (lChangeType == "HEIGHT")
                        {
                            //Height and angle
                            if (lSeqL.Count > lSeq)
                            {
                                if (lVisibleL[lSeq] == "VISIBLE" && lAngleTypeL[lSeq] == "V" && lHtSuAngleL[lSeq].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtSuAngleL[lSeq];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtSuAngleL[lSeq];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtSuAngleL[lSeq];
                                    }
                                }
                            }
                        }

                        //Offset height such as shape 5E2
                        if (lChangeType == "OFF-NOR-HEIGHT")
                        {
                            if (lSeqL.Count > lSeq + 1)
                            {
                                if (lVisibleL[lSeq + 1] == "VISIBLE" && lAngleTypeL[lSeq + 1] == "V" && lHtSuAngleL[lSeq + 1].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lHtSuAngleL[lSeq + 1];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lHtSuAngleL[lSeq + 1];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lHtSuAngleL[lSeq + 1];
                                    }
                                }
                            }
                        }
                        #endregion HeightSuAngle

                        //angle and offset in offset angle such as 307 
                        #region OffsetAngle
                        if (lChangeType == "ANGLE")
                        {
                            //Height and angle -- + 2
                            if (lSeqL.Count > lSeq + 1)
                            {
                                if (lVisibleL[lSeq + 1] == "VISIBLE" && lAngleTypeL[lSeq + 1] == "O" && lOffsetAngleL[lSeq + 1].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetAngleL[lSeq + 1];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetAngleL[lSeq + 1];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetAngleL[lSeq + 1];
                                    }
                                }
                            }

                            // offset angle shape 307 -- +3
                            if (lSeqL.Count > lSeq + 2)
                            {
                                if (lVisibleL[lSeq + 2] == "VISIBLE" && lAngleTypeL[lSeq + 2] == "V" && lOffsetAngleL[lSeq + 2].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetAngleL[lSeq + 2];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetAngleL[lSeq + 2];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetAngleL[lSeq + 2];
                                    }
                                }
                            }
                        }

                        if (lChangeType == "HEIGHT")
                        {
                            //Height and angle -- -2
                            if (lSeq > 2)
                            {
                                if (lVisibleL[lSeq - 3] == "VISIBLE" && lAngleTypeL[lSeq - 3] == "V" && lOffsetAngleL[lSeq - 3].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetAngleL[lSeq - 3];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetAngleL[lSeq - 3];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetAngleL[lSeq - 3];
                                    }
                                }
                            }
                        }
                        #endregion OffsetAngle

                        //angle and offset in offset succeed angle such as 307 
                        //lOffsetSuAngleL
                        #region OffsetSuAngle
                        if (lChangeType == "ANGLE")
                        {
                            //Height(offset) and angle -- -1
                            if (lSeq > 1)
                            {
                                if (lVisibleL[lSeq - 2] == "VISIBLE" && lAngleTypeL[lSeq - 2] == "O" && lOffsetSuAngleL[lSeq - 2].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetSuAngleL[lSeq - 2];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetSuAngleL[lSeq - 2];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetSuAngleL[lSeq - 2];
                                    }
                                }
                            }

                            // offset angle shape 307 -- -3
                            if (lSeq > 3)
                            {
                                if (lVisibleL[lSeq - 4] == "VISIBLE" && lAngleTypeL[lSeq - 4] == "V" && lOffsetSuAngleL[lSeq - 4].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetSuAngleL[lSeq - 4];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetSuAngleL[lSeq - 4];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetSuAngleL[lSeq - 4];
                                    }
                                }
                            }
                        }

                        //Height
                        if (lChangeType == "OFFSET")
                        {
                            //Height and angle -- +1
                            if (lSeqL.Count > lSeq)
                            {
                                if (lVisibleL[lSeq] == "VISIBLE" && lAngleTypeL[lSeq] == "V" && lOffsetSuAngleL[lSeq].Length > 0)
                                {
                                    if (lFormula1.Length == 0)
                                    {
                                        lFormula1 = lOffsetSuAngleL[lSeq];
                                    }
                                    else if (lFormula2.Length == 0)
                                    {
                                        lFormula2 = lOffsetSuAngleL[lSeq];
                                    }
                                    else if (lFormula3.Length == 0)
                                    {
                                        lFormula3 = lOffsetSuAngleL[lSeq];
                                    }
                                }
                            }
                        }
                        #endregion OffsetSuAngle

                        //get parameters
                        if (lParameters == "")
                        {
                            lParameters = lPar1;
                            lParaX = lTextX.ToString();
                            lParaY = lTextY.ToString();
                            lParsType = lChangeTypeOrg;
                            lHeightCheck = lHeightCheckPar;
                            lDefaultValue = lDefValue.ToString();
                            lCalcFormula1 = lFormula1;
                            lCalcFormula2 = lFormula2;
                            lCalcFormula3 = lFormula3;
                        }
                        else
                        {
                            lParameters = lParameters + "," + lPar1;
                            lParaX = lParaX + "," + lTextX.ToString();
                            lParaY = lParaY + "," + lTextY.ToString();
                            lParsType = lParsType + "," + lChangeTypeOrg;
                            lHeightCheck = lHeightCheck + "," + lHeightCheckPar;
                            lDefaultValue = lDefaultValue + "," + lDefValue.ToString();
                            lCalcFormula1 = lCalcFormula1 + "," + lFormula1;
                            lCalcFormula2 = lCalcFormula2 + "," + lFormula2;
                            lCalcFormula3 = lCalcFormula3 + "," + lFormula3;
                        }

                    }
                }
                lRst.Close();
                //if (lFormula1.Length > 0)
                if (lCalcFormula1.Length > 0)
                {
                    lCalcFormula1 = lCalcFormula1.ToUpper();
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "ASIN", "(180/pi)*math.as~in", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "ACOS", "(180/pi)*math.ac~os", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "ATAN", "(180/pi)*math.at~an", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "ATAN2", "math.at~an2", RegexOptions.IgnoreCase);

                    var lIndx = 0;
                    while (lCalcFormula1.ToUpper().IndexOf("SIN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula1.ToUpper().IndexOf("SIN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula1.ToUpper().IndexOf("COS(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula1.ToUpper().IndexOf("COS(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula1.ToUpper().IndexOf("TAN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula1.ToUpper().IndexOf("TAN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula1.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula1.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula1.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula1.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx1, ")");
                            lCalcFormula1 = lCalcFormula1.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "PI", "math.pi", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\[", "(", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\]", ")", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\{", "(", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "\\}", ")", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "SIN\\(", "math.sin(math.pi/180*");
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "COS\\(", "math.cos(math.pi/180*");
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "TAN\\(", "math.tan(math.pi/180*");
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "SQRT", "math.sqrt", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "MAX", "math.max", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "MIN", "math.min", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "POW", "math.pow", RegexOptions.IgnoreCase);
                    lCalcFormula1 = Regex.Replace(lCalcFormula1, "~", "", RegexOptions.IgnoreCase);
                }
                //if (lFormula2.Length > 0)
                if (lCalcFormula2.Length > 0)
                {
                    lCalcFormula2 = lCalcFormula2.ToUpper();

                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "ASIN", "(180/pi)*math.as~in", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "ACOS", "(180/pi)*math.ac~os", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "ATAN", "(180/pi)*math.at~an", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "ATAN2", "math.at~an2", RegexOptions.IgnoreCase);

                    var lIndx = 0;
                    while (lCalcFormula2.ToUpper().IndexOf("SIN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula2.ToUpper().IndexOf("SIN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula2.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula2.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula2.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula2.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx1, ")");
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula2.ToUpper().IndexOf("COS(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula2.ToUpper().IndexOf("COS(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula2.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula2.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula2.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula2.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx1, ")");
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula2.ToUpper().IndexOf("TAN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula2.ToUpper().IndexOf("TAN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula2.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula2.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula2.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula2.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx1, ")");
                            lCalcFormula2 = lCalcFormula2.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "PI", "math.pi", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "\\[", "(", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "\\]", ")", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "\\{", "(", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "\\}", ")", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "SIN\\(", "math.sin(math.pi/180*");
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "COS\\(", "math.cos(math.pi/180*");
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "TAN\\(", "math.tan(math.pi/180*");
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "SQRT", "math.sqrt", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "MAX", "math.max", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "MIN", "math.min", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "POW", "math.pow", RegexOptions.IgnoreCase);
                    lCalcFormula2 = Regex.Replace(lCalcFormula2, "~", "", RegexOptions.IgnoreCase);
                }
                //if (lFormula3.Length > 0)
                if (lCalcFormula3.Length > 0)
                {
                    lCalcFormula3 = lCalcFormula3.ToUpper();
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "ASIN", "(180/pi)*math.as~in", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "ACOS", "(180/pi)*math.ac~os", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "ATAN", "(180/pi)*math.at~an", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "ATAN2", "math.at~an2", RegexOptions.IgnoreCase);

                    var lIndx = 0;
                    while (lCalcFormula3.ToUpper().IndexOf("SIN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula3.ToUpper().IndexOf("SIN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula3.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula3.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula3.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula3.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx1, ")");
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula3.ToUpper().IndexOf("COS(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula3.ToUpper().IndexOf("COS(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula3.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula3.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula3.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula3.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx1, ")");
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lIndx = 0;
                    while (lCalcFormula3.ToUpper().IndexOf("TAN(", lIndx) >= 0)
                    {
                        lIndx = lCalcFormula3.ToUpper().IndexOf("TAN(", lIndx);

                        //find the closing bracket
                        var lIndx1 = lCalcFormula3.IndexOf(")", lIndx + 4);
                        var lIndx2 = lCalcFormula3.IndexOf("(", lIndx + 4);
                        while (lIndx1 > 0 && lIndx2 > 0 && lIndx2 < lIndx1)
                        {
                            lIndx1 = lCalcFormula3.IndexOf(")", lIndx1 + 1);
                            lIndx2 = lCalcFormula3.IndexOf("(", lIndx2 + 1);
                        }

                        if (lIndx1 > 0)
                        {
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx1, ")");
                            lCalcFormula3 = lCalcFormula3.Insert(lIndx + 4, "(");
                        }
                        lIndx = lIndx + 4;
                    }

                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "PI", "math.pi", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "\\[", "(", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "\\]", ")", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "\\{", "(", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "\\}", ")", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "SIN\\(", "math.sin(math.pi/180*");
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "COS\\(", "math.cos(math.pi/180*");
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "TAN\\(", "math.tan(math.pi/180*");
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "SQRT", "math.sqrt", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "MAX", "math.max", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "MIN", "math.min", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "POW", "math.pow", RegexOptions.IgnoreCase);
                    lCalcFormula3 = Regex.Replace(lCalcFormula3, "~", "", RegexOptions.IgnoreCase);
                }

                lCmd.CommandText =
                "SELECT isNull(vchInvLengthFormula,''), isNull(vchEnvLengthFormula,''), " +
                "isNull(vchEnvWidthFormula,''), isNull(vchEnvHeightFormula,'') " +
                "FROM dbo.ShapeMaster_cube " +
                "WHERE chrShapeCode = '" + ShapeCode + "' ";

                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    if (lRst.Read())
                    {
                        lLenCABFormula = lRst.GetString(0);
                        lEnvLength = lRst.GetString(1);
                        lEnvWidth = lRst.GetString(2);
                        lEnvHeight = lRst.GetString(3);
                    }
                }
                lRst.Close();

                //get invoice length formula
                if (lLenCABFormula.Trim().Length > 0)
                {
                    lLengthFormula = lLenCABFormula.ToUpper();
                    lLengthFormula = Regex.Replace(lLengthFormula, "PI", "math.pi", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "ASIN", "math.as~in", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "ACOS", "math.ac~os", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "ATAN2", "math.at~an2", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "ATAN", "math.at~an", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "SIN", "math.sin", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "COS", "math.cos", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "TAN", "math.tan", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "SQRT", "math.sqrt", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "MAX", "math.max", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "MIN", "math.min", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "POW", "math.pow", RegexOptions.IgnoreCase);
                    lLengthFormula = Regex.Replace(lLengthFormula, "~", "", RegexOptions.IgnoreCase);
                }
                else
                {
                    //calculate invoice length 
                    lCmd.CommandText =
                    "SELECT RTRIM(CSD_VISIBLE), RTRIM(CSD_TYPE), CSD_TXT_X, CSD_TXT_Y, " +
                    "RTRIM(isNull(CSD_INPUT_TYPE,'')), RTRIM(isNull(CSD_VIEW,'')), " +
                    "RTRIM(CSD_MATCH_PAR1), RTRIM(CSD_MATCH_PAR2), " +
                    "isNull(CSD_PRODLENGTH, ''), " +
                    "CASE WHEN BITVISIBLE = 1 THEN 'Visible' " +
                    "ELSE 'Invisible' END, " +
                    "isNull(P.vchSymmetryIndex, ''), " +
                    "isNull(P.vchCustomFormula, ''), " +
                    "isNull(P.chrParamName, '') " +
                    "FROM dbo.T_CAB_SHAPE_DTLS C, " +
                    "dbo.shapeparamdetails_cube P, " +
                    "dbo.shapemaster_cube M " +
                    "WHERE C.CSD_SHAPE_ID = M.chrShapeCode " +
                    "AND M.intShapeID = P.intShapeID " +
                    "AND C.CSD_SEQ_NO = P.intParamSeq " +
                    "AND CSD_SHAPE_ID = '" + ShapeCode + "' " +
                    "ORDER BY P.chrParamName ";

                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            lVisible = lRst.GetString(9);
                            lType = lRst.GetString(1);
                            lTextX = (int)lRst.GetDecimal(2);
                            lTextY = (int)lRst.GetDecimal(3);
                            lInputType = lRst.GetString(4);
                            lView = lRst.GetString(5);

                            lPar1 = lRst.GetString(12).ToUpper().Trim();
                            lPar2 = lRst.GetString(7).ToUpper().Trim();

                            lProdlength = lRst.GetString(8);

                            lSymmetry = lRst.GetString(10).ToUpper().Trim();
                            lCFormula = lRst.GetString(11).ToUpper().Trim();


                            if ((!(lShapeCategory.ToUpper().Equals("3-D") && lView.ToUpper().Equals("PLAN"))
                                && !(lShapeCategory.ToUpper().Equals("3-D") && lView.ToUpper().Equals("ELEV"))
                                && !(lShapeCategory.ToUpper().Equals("SPECIAL") && lView.ToUpper().Equals("PLAN"))
                                && !(lShapeCategory.ToUpper().Equals("SPECIAL") && lView.ToUpper().Equals("ELEV")))
                                || (lShapeCategory.ToUpper().Equals("3-D") && lProdlength.ToUpper().Equals("Y"))
                                || (lShapeCategory.ToUpper().Equals("SPECIAL") && lProdlength.ToUpper().Equals("Y")))
                            {
                                if (lType.ToUpper().Equals("LENGTH")
                                    || lType.ToUpper().Equals("UPDOT")
                                    || lType.ToUpper().Equals("UPARROW")
                                    || lType.ToUpper().Equals("UPRIGHT")
                                    || lType.ToUpper().Equals("UPLEFT")
                                    || lType.ToUpper().Equals("DNDOT")
                                    || lType.ToUpper().Equals("DNARROW")
                                    || lType.ToUpper().Equals("DNRIGHT")
                                    || lType.ToUpper().Equals("DNLEFT"))
                                {
                                    if (lVisible == "Invisible" && lPar2.Length == 0)
                                    {
                                        if (lSymmetry.Length > 0 && lParameters.IndexOf(lSymmetry) >= 0)
                                        {
                                            lPar2 = lSymmetry;
                                        }
                                        else if (lCFormula.Length > 0 && lParameters.IndexOf(lCFormula) >= 0)
                                        {
                                            lPar2 = lCFormula;
                                        }
                                    }
                                    lLengthFormula = AddFormula(lVisible, lPar1, lPar2, lLengthFormula);
                                }
                                else if (lType.ToUpper().Equals("ARC"))
                                {
                                    if (lInputType.ToUpper().Equals("RAD+ARCLENGTH"))
                                    {
                                        if (lVisible == "Invisible" && lPar2.Length == 0)
                                        {
                                            if (lSymmetry.Length > 0 && lParameters.IndexOf(lSymmetry) >= 0)
                                            {
                                                lPar2 = lSymmetry;
                                            }
                                            else if (lCFormula.Length > 0 && lParameters.IndexOf(lCFormula) >= 0)
                                            {
                                                lPar2 = lCFormula;
                                            }
                                        }
                                        lLengthFormula = AddFormula(lVisible, lPar1, lPar2, lLengthFormula);
                                    }
                                    else if (lInputType.ToUpper().Equals("DIA+SW_ANGLE"))
                                    {
                                        if (lVisible == "Visible")
                                        {
                                            lLengthFormula = AddFormula(lVisible, lPar1 + "*" + lPar2 + "*" + "math.pi/360", "", lLengthFormula);
                                        }
                                    }
                                    else if (lInputType.ToUpper().Equals("RAD+SW_ANGLE"))
                                    {
                                        if (lVisible == "Visible")
                                        {
                                            lLengthFormula = AddFormula(lVisible, lPar1, lPar2, lLengthFormula);
                                        }
                                    }
                                    else if (lInputType.ToUpper().Equals("CHORD+NORMAL"))
                                    {
                                    }
                                    else
                                    {
                                        if (lVisible == "Visible")
                                        {
                                            lLengthFormula = AddFormula(lVisible, lPar1, lPar2, lLengthFormula);
                                        }
                                    }
                                }
                                else if (lType.ToUpper().Equals("ARC LENGTH"))
                                {
                                    if (lInputType.ToUpper().Equals("RAD+SW_ANGLE"))
                                    {
                                        //AddFormula(lVisible, lPar1, lPar2, lLengthFormula);
                                    }
                                }
                            }

                        }
                    }
                    lRst.Close();
                }

                var lOESShape = db.Shape.Find(ShapeCode);
                string lTransPValidator = "";
                if (lOESShape != null)
                {
                    lTransPValidator = lOESShape.shapeTransportValidator;
                }

                lCmd = null;
                lRst = null;

                if (ShapeCode == "R7A")
                {
                    lParameters = "A,B,C,D";
                }

                lReturn = new ShapeConfViewModels
                {
                    shapeCode = ShapeCode,
                    shapeCategory = lShapeCategory,
                    shapeParameters = lParameters,
                    shapeLengthFormula = lLengthFormula,
                    shapeParaX = lParaX,
                    shapeParaY = lParaY,
                    shapeParaValidator = "",
                    shapeTransportValidator = lTransPValidator,
                    shapeParType = lParsType,
                    shapeDefaultValue = lDefaultValue,  // Param Type = S then 1-first seg, 2-inner seg, 3-last seg
                    shapeHeightCheck = lHeightCheck,
                    shapeAutoCalcFormula1 = lCalcFormula1,
                    shapeAutoCalcFormula2 = lCalcFormula2,
                    shapeAutoCalcFormula3 = lCalcFormula3,
                    shapeImage = lImageBytes,
                    shapeCreated = lUpdateDate
                };

                if (lReturn.shapeParameters == "")
                {
                    var lCustomerShape = db.CustomerShape.Find(CustomerCode, ProjectCode, ShapeCode);
                    if (lCustomerShape != null)
                    {
                        lReturn.shapeParameters = lCustomerShape.shapeParameters; ;
                        lReturn.shapeLengthFormula = lCustomerShape.shapeLengthFormula; ;
                        lReturn.shapeImage = lCustomerShape.shapeImage;
                    }

                }
            }

            return lReturn;
        }


        string AddFormula(string pVisible, string pPar1, string pPar2, string pFormula)
        {
            string lReturn = pFormula;
            if (pVisible.Trim() == "Visible")
            {
                if (lReturn == "")
                {
                    lReturn = pPar1;
                }
                else
                {
                    lReturn = lReturn + "+" + pPar1;
                }
            }
            else
            {
                if (pPar2.Length > 0)
                {
                    if (lReturn == "")
                    {
                        lReturn = pPar2;
                    }
                    else
                    {
                        lReturn = lReturn + "+" + pPar2;
                    }
                }
            }
            return lReturn;

        }

        [HttpPost]
        [Route("/getCreepDeduction/{InvLength}")]
        public ActionResult getCreepDeduction(int InvLength, [FromBody] OrderDetailsRetModels OrderItem)
        {
            int lReturn = 0;

            var lSharedAPI = new SharedAPIController();


            lReturn = lSharedAPI.getDeduction(InvLength, OrderItem);

            lSharedAPI = null;


            return Ok(lReturn);
        }

        //       //get shape List 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getShapeCodeList(string CustomerCode, string ProjectCode, string CouplerType)
        //       {
        //           var lUserName = User.Identity.GetUserName();
        //           //var lCoupler = "ZZZNO";
        //           //    if (CouplerType == "N-Splice")
        //           //    {
        //           //        lCoupler = "N";
        //           //    }
        //           //    if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
        //           //    {
        //           //        lCoupler = "E";
        //           //    } 
        //           //var content = (from p in db.Shape
        //           //               where p.shapeStatus == "Active" &&
        //           //               ((p.shapeCategory != "E" &&
        //           //               p.shapeCategory != "N") ||
        //           //               p.shapeCategory == lCoupler )
        //           //               orderby p.shapeCode 
        //           //               select new {p.shapeCode, p.shapeCategory }).ToList();

        //           //return Json(content, JsonRequestBehavior.AllowGet);

        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lReturn = (new[]{ new
        //           {
        //               shapeCode = "",
        //               shapeCategory = ""
        //           }}).ToList();

        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               int lFound = 0;
        //               lCmd.CommandText = "SELECT ShapeCode FROM OESShapeCTL " +
        //                   "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                   "AND ProjectCode = '" + ProjectCode + "' ";

        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   if (lRst.Read())
        //                   {
        //                       lFound = 1;
        //                   }
        //               }
        //               lRst.Close();

        //               if (lFound == 1)
        //               {
        //                   lCmd.CommandText =
        //                   "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                   "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C, dbo.OESShapeCTL T " +
        //                   "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                   "AND S.CSM_SHAPE_ID = T.ShapeCode " +
        //                   "AND T.CustomerCode = '" + CustomerCode + "' " +
        //                   "AND T.ProjectCode = '" + ProjectCode + "' " +
        //                   "AND CSM_ACT_INACTIVE = 1 ";
        //               }
        //               else
        //               {
        //                   var lCoupler = "ZZZNO";
        //                   if (CouplerType == "N-Splice")
        //                   {
        //                       lCoupler = "N";
        //                   }
        //                   if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
        //                   {
        //                       lCoupler = "E";
        //                   }

        //                   if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
        //                   {
        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                   }
        //                   else
        //                   {
        //                       if (lCoupler == "N")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else if (lCoupler == "E")
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }
        //                       else
        //                       {
        //                           lCmd.CommandText =
        //                           "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
        //                           "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
        //                           "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
        //                           "AND CSM_ACT_INACTIVE = 1 " +
        //                           "AND CSM_SHAPE_ID NOT LIKE '$%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
        //                           "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
        //                           "ORDER BY CSM_SHAPE_ID ";
        //                       }

        //                   }
        //               }

        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       string lShapeCode = lRst.GetString(0);
        //                       if (lShapeCode == null)
        //                       {
        //                           lShapeCode = "";
        //                       }
        //                       if (lShapeCode.Length > 0)
        //                       {
        //                           lShapeCode = lShapeCode.StartsWith("0") == true ? lShapeCode.Substring(1) : lShapeCode;
        //                       }
        //                       lReturn.Add(new
        //                       {
        //                           shapeCode = lShapeCode,
        //                           shapeCategory = lRst.GetString(1)
        //                       });
        //                   }
        //               }
        //               lRst.Close();

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;

        //           lCmd = null;
        //           lNDSCon = null;
        //           lRst = null;

        //           if (lReturn.Count > 1)
        //           {
        //               lReturn.RemoveAt(0);
        //           }

        //           lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

        //           return Ok(lReturn);
        //       }

        //       //get shape List 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getCustomerShapeCodeList(string CustomerCode, string ProjectCode)
        //       {
        //           var content = (from p in db.CustomerShape
        //                          where p.CustomerCode == CustomerCode &&
        //                          p.ProjectCode == ProjectCode &&
        //                          p.ShapeStatus == "Active"
        //                          orderby p.shapeCode
        //                          select new { p.shapeCode, p.shapeCategory }).ToList();
        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getAllCustomShapes(string CustomerCode, string ProjectCode)
        //       {
        //           var content = (from p in db.CustomerShape
        //                          where p.CustomerCode == CustomerCode &&
        //                          p.ProjectCode == ProjectCode
        //                          orderby p.shapeCode
        //                          select p).ToList();
        //           return Json(content, JsonRequestBehavior.AllowGet);
        //       }

        //       //get Bars List 
        //       [HttpPost]

        [HttpGet]
        [Route("/printShapes/{CustomerCode}/{ProjectCode}/{UserName}")]
        public ActionResult printShapes(string CustomerCode, string ProjectCode, string UserName)
        {
            //var lUserName = User.Identity.GetUserName();
            string lUserName = UserName;//"jagdishH_ttl@natsteel.com.sg";
            Reports service = new Reports();
            var bPDF = service.rptShapes(CustomerCode, ProjectCode, lUserName);
            string fileName = "abc.pdf";

            // Create a MemoryStream from the byte array
            using (MemoryStream memoryStream = new MemoryStream(bPDF))
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName;
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

                return File(response.Content.ReadAsByteArrayAsync().Result, "application/pdf");
            }
        }

        //get Bars List 
        [HttpGet]
        [Route("/printOrderDetail_PrintBBS/{CustomerCode}/{ProjectCode}/{JobID}/{formatId}")]
        public ActionResult printOrderDetail(string CustomerCode, string ProjectCode, int JobID, int formatID)
        {
            Reports service = new Reports();
            int lPage = 0;
            var bPDF = service.rptOrderDetails(CustomerCode, ProjectCode, JobID, "N", ref lPage, formatID);
            bPDF = service.rptOrderDetails(CustomerCode, ProjectCode, JobID, "N", ref lPage, formatID);

            //var bPDF = service.rptOrderDetailsImage(CustomerCode, ProjectCode, JobID, "N", ref lPage);
            //bPDF = service.rptOrderDetailsImage(CustomerCode, ProjectCode, JobID, "N", ref lPage);
            //var lReturn = Json(bPDF, System.Web.Mvc.JsonRequestBehavior.AllowGet);
            ////lReturn.MaxJsonLength = 50000000;  //COMMENTED BY ME
            //return lReturn;

            string fileName = "abc.pdf";

            // Create a MemoryStream from the byte array
            using (MemoryStream memoryStream = new MemoryStream(bPDF))
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName;
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

                return File(response.Content.ReadAsByteArrayAsync().Result, "application/pdf");
            }
        }



        [HttpGet]
        [Route("/printOrderDetailShape/{CustomerCode}/{ProjectCode}/{JobID}")]
        public ActionResult printOrderDetailShape(string CustomerCode, string ProjectCode, int JobID)
        {
            Reports service = new Reports();
            int lPage = 0;
            var bPDF = service.rptOrderDetailsShape(CustomerCode, ProjectCode, JobID, "N", ref lPage);
            bPDF = service.rptOrderDetailsShape(CustomerCode, ProjectCode, JobID, "N", ref lPage);

            string fileName = "abc.pdf";

            // Create a MemoryStream from the byte array
            using (MemoryStream memoryStream = new MemoryStream(bPDF))
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName;
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

                return File(response.Content.ReadAsByteArrayAsync().Result, "application/pdf");
            }
        }

        //       //find the discrepancy report 
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult printDiscrepancy(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        //       {
        //           Reports service = new Reports();
        //           int lPage = 0;
        //           var bPDF = service.rptDiscrepancy(CustomerCode, ProjectCode, JobID, BBSID, ref lPage);
        //           bPDF = service.rptDiscrepancy(CustomerCode, ProjectCode, JobID, BBSID, ref lPage);

        //           //var bPDF = service.rptOrderDetailsImage(CustomerCode, ProjectCode, JobID, "N", ref lPage);
        //           //bPDF = service.rptOrderDetailsImage(CustomerCode, ProjectCode, JobID, "N", ref lPage);

        //           return Json(bPDF, JsonRequestBehavior.AllowGet);
        //       }

        //       public byte[] GetPDF(string pHTML)
        //       {
        //           byte[] bPDF = null;

        //           MemoryStream ms = new MemoryStream();
        //           TextReader txtReader = new StringReader(pHTML);

        //           // 1: create object of a itextsharp document class  
        //           Document doc = new Document(PageSize.A4, 25, 25, 25, 25);

        //           // 2: we create a itextsharp pdfwriter that listens to the document and directs a XML-stream to a file  
        //           PdfWriter oPdfWriter = PdfWriter.GetInstance(doc, ms);

        //           // 3: we create a worker parse the document  
        //           HTMLWorker htmlWorker = new HTMLWorker(doc);

        //           // 4: we open document and start the worker on the document  
        //           doc.Open();
        //           htmlWorker.StartDocument();


        //           // 5: parse the html into the document  
        //           htmlWorker.Parse(txtReader);

        //           // 6: close the document and the worker  
        //           htmlWorker.EndDocument();
        //           htmlWorker.Close();
        //           doc.Close();

        //           bPDF = ms.ToArray();

        //           return bPDF;
        //       }

        //       //get IFC BBS
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getIFCBBS(string CustomerCode, string ProjectCode, int DrawingID, int Revision, string FileName, bool MergeBarMark)
        //       {
        //           var lReturn = (new[]
        //           { new {
        //                   BBSID = 0,
        //                   BBSNo = "",
        //                   BBSTotalWT = (decimal)0,
        //                   BBSTotalPCs = (int)0
        //               }
        //           }).ToList();

        //           lReturn.RemoveAt(0);

        //           //take from cash

        //           int lSNo = 0;
        //           var lSQL = "";
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               //lSQL = "SELECT ElementMark, SUM(BarWeight), SUM(BarTotalQty) " +
        //               //"FROM dbo.OESIFCExtract " +
        //               //"WHERE CustomerCode = '" + CustomerCode + "' " +
        //               //"AND ProjectCode = '" + ProjectCode + "' " +
        //               //"AND DrawingID = " + DrawingID.ToString() + " " +
        //               //"AND Rev = " + Revision.ToString() + " " +
        //               //"AND CreateBy = '" + User.Identity.GetUserName() + "' " +
        //               //"GROUP BY ElementMark " +
        //               //"ORDER BY ElementMark ";

        //               //lCmd.CommandText = lSQL;
        //               //lCmd.Connection = lNDSCon;
        //               //lCmd.CommandTimeout = 300;
        //               //lRst = lCmd.ExecuteReader();
        //               //if (lRst.HasRows)
        //               //{
        //               //    while (lRst.Read())
        //               //    {
        //               //        var lBBSNo = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
        //               //        decimal lTotalWT = lRst.GetValue(1) == DBNull.Value ? 0 : lRst.GetDecimal(1);
        //               //        int lTotalPCs = lRst.GetValue(2) == DBNull.Value ? 0 : lRst.GetInt32(2);

        //               //        if (lTotalWT > 0 || lTotalPCs > 0)
        //               //        {
        //               //            lReturn.Add(
        //               //                new
        //               //                {
        //               //                    BBSID = lSNo + 1,
        //               //                    BBSNo = lBBSNo,
        //               //                    BBSTotalWT = lTotalWT,
        //               //                    BBSTotalPCs = lTotalPCs
        //               //                }
        //               //                );
        //               //            lSNo = lSNo + 1;
        //               //        }
        //               //    }
        //               //}
        //               //lRst.Close();

        //               if (lReturn.Count == 0)
        //               {
        //                   var lIFCExtObj = new IFCExtraction();

        //                   var lRebars = lIFCExtObj.ListAllRebarsFromIFCFile(CustomerCode, ProjectCode, FileName, Revision, User.Identity.GetUserName());

        //                   if (lRebars.Count > 0)
        //                   {
        //                       // Housekeeping
        //                       lSQL = "DELETE " +
        //                       "FROM dbo.OESIFCExtract " +
        //                       "WHERE CreateBy = '" + User.Identity.GetUserName() + "' ";

        //                       lCmd = new SqlCommand();
        //                       lCmd.CommandText = lSQL;
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lCmd.ExecuteNonQuery();

        //                       // Merge BarMark if user selected
        //                       if (MergeBarMark == true)
        //                       {
        //                           for (int i = 0; i < lRebars.Count; i++)
        //                           {
        //                               if (lRebars[i] == null)
        //                               {
        //                                   continue;
        //                               }

        //                               int lMembQty = lRebars[i].BarMemberQty == null ? 0 : (int)lRebars[i].BarMemberQty;
        //                               int lEachQty = lRebars[i].BarEachQty == null ? 0 : (int)lRebars[i].BarEachQty;
        //                               string lEleMark = lRebars[i].ElementMark == null ? "" : ((string)lRebars[i].ElementMark).Trim();
        //                               string lBarMark = lRebars[i].BarMark == null ? "" : ((string)lRebars[i].BarMark).Trim();
        //                               string lBarType = lRebars[i].BarType == null ? "" : ((string)lRebars[i].BarType).Trim();
        //                               int lBarSize = lRebars[i].BarSize == null ? 0 : (int)lRebars[i].BarSize;
        //                               string lBarShape = lRebars[i].BarShapeCode == null ? "" : ((string)lRebars[i].BarShapeCode).Trim();
        //                               string lPa = lRebars[i].A == null ? "" : ((string)lRebars[i].A).Trim();
        //                               int lBarLen = 0;
        //                               int.TryParse(lRebars[i].BarLength, out lBarLen);

        //                               for (int j = lRebars.Count - 1; j > i; j--)
        //                               {
        //                                   if (lRebars[j] == null)
        //                                   {
        //                                       continue;
        //                                   }
        //                                   int lBarLenM = 0;
        //                                   int.TryParse(lRebars[j].BarLength, out lBarLenM);

        //                                   if (lEleMark == (lRebars[j].ElementMark == null ? "" : ((string)lRebars[j].ElementMark).Trim()) &&
        //                                       lBarMark == (lRebars[j].BarMark == null ? "" : ((string)lRebars[j].BarMark).Trim()) &&
        //                                       lBarType == (lRebars[j].BarType == null ? "" : ((string)lRebars[j].BarType).Trim()) &&
        //                                       lBarSize == (lRebars[j].BarSize == null ? 0 : (int)lRebars[j].BarSize) &&
        //                                       lBarShape == (lRebars[j].BarShapeCode == null ? "" : ((string)lRebars[j].BarShapeCode).Trim()) &&
        //                                       lPa == (lRebars[j].A == null ? "" : ((string)lRebars[j].A).Trim()) &&
        //                                       (lRebars[i].B == null ? "" : ((string)lRebars[i].B).Trim()) == (lRebars[j].B == null ? "" : ((string)lRebars[j].B).Trim()) &&
        //                                       (lRebars[i].C == null ? "" : ((string)lRebars[i].C).Trim()) == (lRebars[j].C == null ? "" : ((string)lRebars[j].C).Trim()) &&
        //                                       (lRebars[i].D == null ? "" : ((string)lRebars[i].D).Trim()) == (lRebars[j].D == null ? "" : ((string)lRebars[j].D).Trim()) &&
        //                                       (lRebars[i].E == null ? "" : ((string)lRebars[i].E).Trim()) == (lRebars[j].E == null ? "" : ((string)lRebars[j].E).Trim()) &&
        //                                       (lRebars[i].F == null ? "" : ((string)lRebars[i].F).Trim()) == (lRebars[j].F == null ? "" : ((string)lRebars[j].F).Trim()) &&
        //                                       (lRebars[i].G == null ? "" : ((string)lRebars[i].G).Trim()) == (lRebars[j].G == null ? "" : ((string)lRebars[j].G).Trim()) &&
        //                                       (lRebars[i].H == null ? "" : ((string)lRebars[i].H).Trim()) == (lRebars[j].H == null ? "" : ((string)lRebars[j].H).Trim()) &&
        //                                       (lRebars[i].I == null ? "" : ((string)lRebars[i].I).Trim()) == (lRebars[j].I == null ? "" : ((string)lRebars[j].I).Trim()) &&
        //                                       (lRebars[i].J == null ? "" : ((string)lRebars[i].J).Trim()) == (lRebars[j].J == null ? "" : ((string)lRebars[j].J).Trim()) &&
        //                                       (lRebars[i].K == null ? "" : ((string)lRebars[i].K).Trim()) == (lRebars[j].K == null ? "" : ((string)lRebars[j].K).Trim()) &&
        //                                       lBarLen == lBarLenM)
        //                                   {
        //                                       if (lMembQty == (lRebars[j].BarMemberQty == null ? 0 : (int)lRebars[j].BarMemberQty))
        //                                       {
        //                                           lRebars[i].BarEachQty = lEachQty + (lRebars[j].BarEachQty == null ? 0 : lRebars[j].BarEachQty);
        //                                           lEachQty = lEachQty + (lRebars[j].BarEachQty == null ? 0 : (int)lRebars[j].BarEachQty);
        //                                       }
        //                                       else
        //                                       {
        //                                           lRebars[i].BarEachQty = ((lEachQty == 0 ? 0 : lEachQty) * (lMembQty == 0 ? 1 : lMembQty))
        //                                               + (((lRebars[j].BarEachQty == null || lRebars[j].BarEachQty == 0) ? 0 : lRebars[j].BarEachQty)
        //                                               * ((lRebars[j].BarMemberQty == null || lRebars[j].BarMemberQty == 0) ? 1 : lRebars[j].BarMemberQty));

        //                                           lEachQty = ((lEachQty == 0 ? 0 : lEachQty) * (lMembQty == 0 ? 1 : lMembQty))
        //                                               + (((lRebars[j].BarEachQty == null || lRebars[j].BarEachQty == 0) ? 0 : (int)lRebars[j].BarEachQty)
        //                                               * ((lRebars[j].BarMemberQty == null || lRebars[j].BarMemberQty == 0) ? 1 : (int)lRebars[j].BarMemberQty));

        //                                           lRebars[i].BarMemberQty = 1;
        //                                       }
        //                                       lRebars.RemoveAt(j);
        //                                   }

        //                               }
        //                           }
        //                       }

        //                       // insert to cash db
        //                       for (int i = 0; i < lRebars.Count; i++)
        //                       {
        //                           // insert to cash db
        //                           int lMembQty = lRebars[i].BarMemberQty == null ? 0 : (int)lRebars[i].BarMemberQty;
        //                           int lEachQty = lRebars[i].BarEachQty == null ? 0 : (int)lRebars[i].BarEachQty;
        //                           if (lMembQty == 0 && lEachQty > 0)
        //                           {
        //                               lMembQty = 1;
        //                           }
        //                           if (lEachQty == 0 && lMembQty > 0)
        //                           {
        //                               lEachQty = 1;
        //                           }
        //                           int lTotalQty = lMembQty * lEachQty;

        //                           int lBarLen = 0;
        //                           int.TryParse(lRebars[i].BarLength, out lBarLen);

        //                           double lBarWT = calWeight(lBarLen, lRebars[i].BarSize, lTotalQty);

        //                           if ((lRebars[i].BarShapeCode != null && lRebars[i].BarShapeCode.Trim().Length > 0) || lTotalQty > 0)
        //                           {
        //                               lSQL = "INSERT INTO dbo.OESIFCExtract " +
        //                              "(CustomerCode " +
        //                              ", ProjectCode " +
        //                              ", DrawingID " +
        //                              ", Rev " +
        //                              ", BarID " +
        //                              ", BarSort " +
        //                              ", Cancelled " +
        //                              ", BarCAB " +
        //                              ", BarSTD " +
        //                              ", ElementMark " +
        //                              ", BarMark " +
        //                              ", BarType " +
        //                              ", BarSize " +
        //                              ", BarMemberQty " +
        //                              ", BarEachQty " +
        //                              ", BarTotalQty " +
        //                              ", BarShapeCode " +
        //                              ", A " +
        //                              ", B " +
        //                              ", C " +
        //                              ", D " +
        //                              ", E " +
        //                              ", F " +
        //                              ", G " +
        //                              ", H " +
        //                              ", I " +
        //                              ", J " +
        //                              ", K " +
        //                              ", L " +
        //                              ", M " +
        //                              ", N " +
        //                              ", O " +
        //                              ", P " +
        //                              ", Q " +
        //                              ", R " +
        //                              ", S " +
        //                              ", T " +
        //                              ", U " +
        //                              ", V " +
        //                              ", W " +
        //                              ", X " +
        //                              ", Y " +
        //                              ", Z " +
        //                              ", BarLength " +
        //                              ", BarWeight " +
        //                              ", Remarks " +
        //                              ", PinSize " +
        //                              ", TeklaGUID " +
        //                              ", PartGUID " +
        //                              ", UpdateDate " +
        //                              ", UpdateBy " +
        //                              ", CreateDate " +
        //                              ", CreateBy) " +
        //                              "VALUES " +
        //                              "('" + CustomerCode + "' " +
        //                              ",'" + ProjectCode + "' " +
        //                              "," + DrawingID.ToString() + " " +
        //                              "," + Revision.ToString() + " " +
        //                              "," + (i + 1).ToString() + " " +
        //                              ",0 " +
        //                              ",0 " +
        //                              ",1 " +
        //                              ",0 " +
        //                              ",'" + lRebars[i].ElementMark + "' " +
        //                              ",'" + lRebars[i].BarMark + "' " +
        //                              ",'" + lRebars[i].BarType + "' " +
        //                              "," + (lRebars[i].BarSize == null ? 0 : lRebars[i].BarSize).ToString() + " " +
        //                              "," + lMembQty.ToString() + " " +
        //                              "," + lEachQty.ToString() + "" +
        //                              "," + lTotalQty.ToString() + " " +
        //                              ",'" + lRebars[i].BarShapeCode + "' " +
        //                              "," + (lRebars[i].A == null ? "0" : lRebars[i].A) + " " +
        //                              "," + (lRebars[i].B == null ? "0" : lRebars[i].B) + " " +
        //                              "," + (lRebars[i].C == null ? "0" : lRebars[i].C) + " " +
        //                              "," + (lRebars[i].D == null ? "0" : lRebars[i].D) + " " +
        //                              "," + (lRebars[i].E == null ? "0" : lRebars[i].E) + " " +
        //                              "," + (lRebars[i].F == null ? "0" : lRebars[i].F) + " " +
        //                              "," + (lRebars[i].G == null ? "0" : lRebars[i].G) + " " +
        //                              "," + (lRebars[i].H == null ? "0" : lRebars[i].H) + " " +
        //                              "," + (lRebars[i].I == null ? "0" : lRebars[i].I) + " " +
        //                              "," + (lRebars[i].J == null ? "0" : lRebars[i].J) + " " +
        //                              "," + (lRebars[i].K == null ? "0" : lRebars[i].K) + " " +
        //                              "," + (lRebars[i].L == null ? "0" : lRebars[i].L) + " " +
        //                              "," + (lRebars[i].M == null ? "0" : lRebars[i].M) + " " +
        //                              "," + (lRebars[i].N == null ? "0" : lRebars[i].N) + " " +
        //                              "," + (lRebars[i].O == null ? "0" : lRebars[i].O) + " " +
        //                              "," + (lRebars[i].P == null ? "0" : lRebars[i].P) + " " +
        //                              "," + (lRebars[i].Q == null ? "0" : lRebars[i].Q) + " " +
        //                              "," + (lRebars[i].R == null ? "0" : lRebars[i].R) + " " +
        //                              "," + (lRebars[i].S == null ? "0" : lRebars[i].S) + " " +
        //                              "," + (lRebars[i].T == null ? "0" : lRebars[i].T) + " " +
        //                              "," + (lRebars[i].U == null ? "0" : lRebars[i].U) + " " +
        //                              "," + (lRebars[i].V == null ? "0" : lRebars[i].V) + " " +
        //                              "," + (lRebars[i].W == null ? "0" : lRebars[i].W) + " " +
        //                              "," + (lRebars[i].X == null ? "0" : lRebars[i].X) + " " +
        //                              "," + (lRebars[i].Y == null ? "0" : lRebars[i].Y) + " " +
        //                              "," + (lRebars[i].Z == null ? "0" : lRebars[i].Z) + " " +
        //                              "," + (lRebars[i].BarLength == null ? "0" : lRebars[i].BarLength) + " " +
        //                              "," + lBarWT.ToString("#####0.000") + " " +
        //                              ",'' " +
        //                              "," + (lRebars[i].PinSize == null ? 0 : lRebars[i].PinSize).ToString() + " " +
        //                              ",'" + lRebars[i].TeklaGUID + "' " +
        //                              ",'" + lRebars[i].PartGUID + "' " +
        //                              ", getDate() " +
        //                              ",'" + User.Identity.GetUserName() + "' " +
        //                              ", getDate() " +
        //                              ",'" + User.Identity.GetUserName() + "') ";

        //                               lCmd = new SqlCommand();
        //                               lCmd.CommandText = lSQL;
        //                               lCmd.Connection = lNDSCon;
        //                               lCmd.CommandTimeout = 300;
        //                               lCmd.ExecuteNonQuery();
        //                           }

        //                       }

        //                       lSQL = "SELECT ElementMark, SUM(BarWeight), SUM(BarTotalQty) " +
        //                       "FROM dbo.OESIFCExtract " +
        //                       "WHERE CustomerCode = '" + CustomerCode + "' " +
        //                       "AND ProjectCode = '" + ProjectCode + "' " +
        //                       "AND DrawingID = " + DrawingID.ToString() + " " +
        //                       "AND Rev = " + Revision.ToString() + " " +
        //                       "AND CreateBy = '" + User.Identity.GetUserName() + "' " +
        //                       "GROUP BY ElementMark " +
        //                       "ORDER BY ElementMark ";

        //                       lCmd.CommandText = lSQL;
        //                       lCmd.Connection = lNDSCon;
        //                       lCmd.CommandTimeout = 300;
        //                       lRst = lCmd.ExecuteReader();
        //                       if (lRst.HasRows)
        //                       {
        //                           while (lRst.Read())
        //                           {
        //                               var lBBSNo = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
        //                               decimal lTotalWT = lRst.GetValue(1) == DBNull.Value ? 0 : lRst.GetDecimal(1);
        //                               int lTotalPCs = lRst.GetValue(2) == DBNull.Value ? 0 : lRst.GetInt32(2);

        //                               if (lTotalWT > 0 || lTotalPCs > 0)
        //                               {
        //                                   lReturn.Add(
        //                                       new
        //                                       {
        //                                           BBSID = lSNo + 1,
        //                                           BBSNo = lBBSNo,
        //                                           BBSTotalWT = lTotalWT,
        //                                           BBSTotalPCs = lTotalPCs
        //                                       }
        //                                       );
        //                                   lSNo = lSNo + 1;
        //                               }
        //                           }
        //                       }
        //                       lRst.Close();
        //                   }

        //               }

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;

        //           return Ok(lReturn);
        //       }

        //       //get IFC BBS Details
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]
        //       public ActionResult getIFCDetails(string CustomerCode, string ProjectCode, int DrawingID, int Revision, string FileName, string BBSNo)
        //       {
        //           var lReturn = new List<OrderDetailsListModels>();

        //           //take from cash

        //           int lSNo = 0;
        //           var lSQL = "";
        //           var lCmd = new SqlCommand();
        //           SqlDataReader lRst;
        //           var lNDSCon = new SqlConnection();

        //           var lProcessObj = new ProcessController();
        //           if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
        //           {
        //               lSQL = "SELECT BarID " +
        //               ",BarMark " +
        //               ",BarType " +
        //               ",BarSize " +
        //               ",BarMemberQty " +
        //               ",BarEachQty " +
        //               ",BarTotalQty " +
        //               ",BarShapeCode " +
        //               ",A " +
        //               ",B " +
        //               ",C " +
        //               ",D " +
        //               ",E " +
        //               ",F " +
        //               ",G " +
        //               ",H " +
        //               ",I " +
        //               ",J " +
        //               ",K " +
        //               ",L " +
        //               ",M " +
        //               ",N " +
        //               ",O " +
        //               ",P " +
        //               ",Q " +
        //               ",R " +
        //               ",S " +
        //               ",T " +
        //               ",U " +
        //               ",V " +
        //               ",W " +
        //               ",X " +
        //               ",Y " +
        //               ",Z " +
        //               ",BarLength " +
        //               ",BarWeight " +
        //               ",PinSize " +
        //               "FROM dbo.OESIFCExtract " +
        //               "WHERE CustomerCode = '" + CustomerCode + "' " +
        //               "AND ProjectCode = '" + ProjectCode + "' " +
        //               "AND DrawingID = " + DrawingID.ToString() + " " +
        //               "AND Rev = " + Revision.ToString() + " " +
        //               "AND CreateBy = '" + User.Identity.GetUserName() + "' " +
        //               "AND ElementMark = '" + BBSNo + "' " +
        //               "ORDER BY BarID ";

        //               lCmd.CommandText = lSQL;
        //               lCmd.Connection = lNDSCon;
        //               lCmd.CommandTimeout = 300;
        //               lRst = lCmd.ExecuteReader();
        //               if (lRst.HasRows)
        //               {
        //                   while (lRst.Read())
        //                   {
        //                       decimal lTotalWT = lRst.GetValue(35) == DBNull.Value ? 0 : lRst.GetDecimal(35);
        //                       int lTotalPCs = lRst.GetValue(6) == DBNull.Value ? 0 : lRst.GetInt32(6);

        //                       if (lTotalWT > 0 || lTotalPCs > 0)
        //                       {
        //                           lReturn.Add(
        //                               new OrderDetailsListModels
        //                               {
        //                                   CustomerCode = "1",
        //                                   ProjectCode = "2",
        //                                   JobID = 1,
        //                                   BBSID = 1,
        //                                   BarID = lRst.GetInt32(0),
        //                                   BarSort = lSNo,
        //                                   Cancelled = false,
        //                                   ElementMark = BBSNo,
        //                                   BarMark = lRst.GetString(1),
        //                                   BarType = lRst.GetString(2),
        //                                   BarSize = lRst.GetInt16(3),
        //                                   BarCAB = true,
        //                                   BarSTD = false,
        //                                   BarMemberQty = lRst.GetInt32(4),
        //                                   BarEachQty = lRst.GetInt32(5),
        //                                   BarTotalQty = lRst.GetInt32(6),
        //                                   BarShapeCode = lRst.GetString(7),
        //                                   A = (lRst.GetValue(8) == null || lRst.GetInt32(8) == 0) ? "" : lRst.GetInt32(8).ToString(),
        //                                   B = (lRst.GetValue(9) == null || lRst.GetInt32(9) == 0) ? "" : lRst.GetInt32(9).ToString(),
        //                                   C = (lRst.GetValue(10) == null || lRst.GetInt32(10) == 0) ? "" : lRst.GetInt32(10).ToString(),
        //                                   D = (lRst.GetValue(11) == null || lRst.GetInt32(11) == 0) ? "" : lRst.GetInt32(11).ToString(),
        //                                   E = (lRst.GetValue(12) == null || lRst.GetInt32(12) == 0) ? "" : lRst.GetInt32(12).ToString(),
        //                                   F = (lRst.GetValue(13) == null || lRst.GetInt32(13) == 0) ? "" : lRst.GetInt32(13).ToString(),
        //                                   G = (lRst.GetValue(14) == null || lRst.GetInt32(14) == 0) ? "" : lRst.GetInt32(14).ToString(),
        //                                   H = (lRst.GetValue(15) == null || lRst.GetInt32(15) == 0) ? "" : lRst.GetInt32(15).ToString(),
        //                                   I = (lRst.GetValue(16) == null || lRst.GetInt32(16) == 0) ? "" : lRst.GetInt32(16).ToString(),
        //                                   J = (lRst.GetValue(17) == null || lRst.GetInt32(17) == 0) ? "" : lRst.GetInt32(17).ToString(),
        //                                   K = (lRst.GetValue(18) == null || lRst.GetInt32(18) == 0) ? "" : lRst.GetInt32(18).ToString(),
        //                                   L = (lRst.GetValue(19) == null || lRst.GetInt32(19) == 0) ? "" : lRst.GetInt32(19).ToString(),
        //                                   M = (lRst.GetValue(20) == null || lRst.GetInt32(20) == 0) ? "" : lRst.GetInt32(20).ToString(),
        //                                   N = (lRst.GetValue(21) == null || lRst.GetInt32(21) == 0) ? "" : lRst.GetInt32(21).ToString(),
        //                                   O = (lRst.GetValue(22) == null || lRst.GetInt32(22) == 0) ? "" : lRst.GetInt32(22).ToString(),
        //                                   P = (lRst.GetValue(23) == null || lRst.GetInt32(23) == 0) ? "" : lRst.GetInt32(23).ToString(),
        //                                   Q = (lRst.GetValue(24) == null || lRst.GetInt32(24) == 0) ? "" : lRst.GetInt32(24).ToString(),
        //                                   R = (lRst.GetValue(25) == null || lRst.GetInt32(25) == 0) ? "" : lRst.GetInt32(25).ToString(),
        //                                   S = (lRst.GetValue(26) == null || lRst.GetInt32(26) == 0) ? "" : lRst.GetInt32(26).ToString(),
        //                                   T = (lRst.GetValue(27) == null || lRst.GetInt32(27) == 0) ? "" : lRst.GetInt32(27).ToString(),
        //                                   U = (lRst.GetValue(28) == null || lRst.GetInt32(28) == 0) ? "" : lRst.GetInt32(28).ToString(),
        //                                   V = (lRst.GetValue(29) == null || lRst.GetInt32(29) == 0) ? "" : lRst.GetInt32(29).ToString(),
        //                                   W = (lRst.GetValue(30) == null || lRst.GetInt32(30) == 0) ? "" : lRst.GetInt32(30).ToString(),
        //                                   X = (lRst.GetValue(31) == null || lRst.GetInt32(31) == 0) ? "" : lRst.GetInt32(31).ToString(),
        //                                   Y = (lRst.GetValue(32) == null || lRst.GetInt32(32) == 0) ? "" : lRst.GetInt32(32).ToString(),
        //                                   Z = (lRst.GetValue(33) == null || lRst.GetInt32(33) == 0) ? "" : lRst.GetInt32(33).ToString(),
        //                                   BarLength = (lRst.GetValue(34) == null || lRst.GetInt32(34) == 0) ? "" : lRst.GetInt32(34).ToString(),
        //                                   BarWeight = lTotalWT,
        //                                   Remarks = "",
        //                                   shapeParameters = "",
        //                                   shapeLengthFormula = "",
        //                                   shapeParaValidator = "",
        //                                   shapeTransportValidator = "",
        //                                   shapeTransport = 0,
        //                                   PinSize = lRst.GetInt32(36)
        //                               }
        //                               );
        //                           lSNo = lSNo + 1;
        //                       }
        //                   }
        //               }
        //               lRst.Close();

        //               lProcessObj.CloseNDSConnection(ref lNDSCon);
        //           }
        //           lProcessObj = null;

        //           return Ok(lReturn);
        //       }

        //       //get IFC BBS Details
        //       [HttpPost]
        //       [ValidateAntiForgeryHeader]

        [HttpGet]
        [Route("/importIFC/{CustomerCode}/{ProjectCode}/{DrawingID}/{Revision}/{MemberQty}/{JobID}/{UserName}")]
        public ActionResult importIFC(string CustomerCode, string ProjectCode, int DrawingID, int Revision, int MemberQty, int JobID, string UserName)
        {
            var lSuccess = true;
            var lErrorMsg = "";
            var lReturn = new List<OrderDetailsListModels>();
            var lBBS = (new[]
            { new {
                           BBSID = 0,
                           BBSNo = "",
                           BBSTotalWT = (decimal)0,
                           BBSTotalPCs = (int)0
                       }
                   }).ToList();

            lBBS.RemoveAt(0);

            if (MemberQty == 0)
            {
                MemberQty = 1;
            }

            //take from cash

            int lSNo = 0;
            var lSQL = "";
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            var lProcessObj = new ProcessController();
            try
            {
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    int lMaxBBSID = 0;
                    string lExBBSNo = "";
                    decimal lExBBSWT = 0;
                    string lStrEle = "";

                    lSQL = "SELECT MAX(BBSID), MAX(BBSStrucElem) FROM dbo.OESBBS " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JOBID = " + JobID + " ";

                    lCmd.CommandText = lSQL;
                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        if (lRst.Read())
                        {
                            lMaxBBSID = lRst.GetValue(0) == DBNull.Value ? 0 : lRst.GetInt32(0);
                            lStrEle = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim();
                        }
                    }
                    lRst.Close();

                    if (lMaxBBSID == 1)
                    {
                        lSQL = "SELECT BBSNo, BBSTotalWT FROM dbo.OESBBS " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID + " " +
                        "AND BBSID = 1 ";

                        lCmd.CommandText = lSQL;
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lExBBSNo = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
                                lExBBSWT = lRst.GetValue(1) == DBNull.Value ? 0 : lRst.GetDecimal(1);
                            }
                        }
                        lRst.Close();

                        if (lExBBSNo != "BBS" + JobID.ToString() || lExBBSWT > 0)
                        {
                            lMaxBBSID = lMaxBBSID + 1;
                        }
                    }
                    else
                    {
                        lMaxBBSID = lMaxBBSID + 1;
                    }

                    lSQL = "SELECT ElementMark, SUM(BarWeight), SUM(BarTotalQty) " +
                    "FROM dbo.OESIFCExtract " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND DrawingID = " + DrawingID.ToString() + " " +
                    "AND Rev = " + Revision.ToString() + " " +
                    "AND CreateBy = '" + UserName + "' " +
                    "GROUP BY ElementMark " +
                    "ORDER BY ElementMark ";

                    lCmd.CommandText = lSQL;
                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            var lBBSNo = lRst.GetValue(0) == DBNull.Value ? "" : lRst.GetString(0).Trim();
                            decimal lTotalWT = lRst.GetValue(1) == DBNull.Value ? 0 : lRst.GetDecimal(1);
                            int lTotalPCs = lRst.GetValue(2) == DBNull.Value ? 0 : lRst.GetInt32(2);

                            if (lTotalWT > 0 || lTotalPCs > 0)
                            {
                                lBBS.Add(
                                    new
                                    {
                                        BBSID = lMaxBBSID + lSNo,
                                        BBSNo = lBBSNo,
                                        BBSTotalWT = lTotalWT,
                                        BBSTotalPCs = lTotalPCs
                                    }
                                    );
                                lSNo = lSNo + 1;
                            }
                        }
                    }
                    lRst.Close();

                    //Update BBS
                    if (lBBS.Count > 0)
                    {
                        for (int i = 0; i < lBBS.Count; i++)
                        {
                            int lFound = 0;

                            lSQL = "SELECT COUNT(*) FROM dbo.OESBBS " +
                            "WHERE CustomerCode = '" + CustomerCode + "' " +
                            "AND ProjectCode = '" + ProjectCode + "' " +
                            "AND JOBID = " + JobID + " " +
                            "AND BBSID = " + lBBS[i].BBSID + " ";

                            lCmd.CommandText = lSQL;
                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                if (lRst.Read())
                                {
                                    lFound = lRst.GetValue(0) == DBNull.Value ? 0 : lRst.GetInt32(0);
                                }
                            }
                            lRst.Close();

                            if (lFound == 0)
                            {
                                lSQL = "INSERT INTO dbo.OESBBS " +
                                "(CustomerCode " +
                                ", ProjectCode " +
                                ", JobID " +
                                ", BBSID " +
                                ", BBSNo " +
                                ", BBSDesc " +
                                ", BBSCopiedFrom " +
                                ", BBSStrucElem " +
                                ", BBSOrderCABWT " +
                                ", BBSOrderSTDWT " +
                                ", BBSCancelledWT " +
                                ", BBSTotalWT " +
                                ", BBSSOR " +
                                ", BBSNoNDS " +
                                ", BBSSAPSO " +
                                ", BBSSORCoupler " +
                                ", BBSNoNDSCoupler " +
                                ", UpdateDate " +
                                ", UpdateBy) " +
                                "VALUES " +
                                "('" + CustomerCode + "' " +
                                ",'" + ProjectCode + "' " +
                                "," + JobID.ToString() + " " +
                                "," + lBBS[i].BBSID.ToString() + " " +
                                ",'" + lBBS[i].BBSNo + "' " +
                                ",'' " +
                                ",'' " +
                                ",'" + lStrEle + "' " +
                                "," + lBBS[i].BBSTotalWT * MemberQty + " " +
                                ",0 " +
                                ",0 " +
                                "," + lBBS[i].BBSTotalWT * MemberQty + " " +
                                ",'' " +
                                ",'' " +
                                ",'' " +
                                ",'' " +
                                ",'' " +
                                ",getDate() " +
                                ",'" + UserName + "') ";
                            }
                            else
                            {
                                lSQL = "UPDATE dbo.OESBBS " +
                                "SET BBSNo = '" + lBBS[i].BBSNo + "' " +
                                ",BBSOrderCABWT = " + lBBS[i].BBSTotalWT * MemberQty + " " +
                                ",BBSOrderSTDWT = 0 " +
                                ",BBSCancelledWT = 0 " +
                                ",BBSTotalWT = " + lBBS[i].BBSTotalWT * MemberQty + " " +
                                ",UpdateDate = getDate() " +
                                ",UpdateBy = '" + UserName + "' " +
                                "WHERE CustomerCode = '" + CustomerCode + "' " +
                                "AND ProjectCode = '" + ProjectCode + "' " +
                                "AND JOBID = " + JobID + " " +
                                "AND BBSID = " + lBBS[i].BBSID + " ";
                            }
                            lCmd.CommandText = lSQL;
                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lCmd.ExecuteNonQuery();

                            // get min BarID
                            int lMinBarID = 0;

                            lSQL = "SELECT MIN(BarID) " +
                            "FROM dbo.OESIFCExtract " +
                            "WHERE CustomerCode = '" + CustomerCode + "' " +
                            "AND ProjectCode = '" + ProjectCode + "' " +
                            "AND DrawingID = " + DrawingID.ToString() + " " +
                            "AND Rev = " + Revision.ToString() + " " +
                            "AND CreateBy = '" + UserName + "' " +
                            "AND ElementMark = '" + lBBS[i].BBSNo + "' ";

                            lCmd.CommandText = lSQL;
                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 300;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                if (lRst.Read())
                                {
                                    lMinBarID = lRst.GetValue(0) == DBNull.Value ? 0 : lRst.GetInt32(0);
                                }
                            }
                            lRst.Close();

                            //insert Rebar details
                            lSQL = "DELETE " +
                            "FROM dbo.OESOrderDetails " +
                            "WHERE CustomerCode = '" + CustomerCode + "' " +
                            "AND ProjectCode = '" + ProjectCode + "' " +
                            "AND JobID = " + JobID.ToString() + " " +
                            "AND BBSID = " + lBBS[i].BBSID.ToString() + " ";

                            lCmd = new SqlCommand(lSQL, lNDSCon);
                            lCmd.CommandTimeout = 600;
                            lCmd.ExecuteNonQuery();

                            lSQL = "INSERT INTO dbo.OESOrderDetails " +
                            "(CustomerCode " +
                            ", ProjectCode " +
                            ", JobID " +
                            ", BBSID " +
                            ", BarID " +
                            ", BarSort " +
                            ", Cancelled " +
                            ", BarCAB " +
                            ", BarSTD " +
                            ", ElementMark " +
                            ", BarMark " +
                            ", BarType " +
                            ", BarSize " +
                            ", BarMemberQty " +
                            ", BarEachQty " +
                            ", BarTotalQty " +
                            ", BarShapeCode " +
                            ", A " +
                            ", B " +
                            ", C " +
                            ", D " +
                            ", E " +
                            ", F " +
                            ", G " +
                            ", H " +
                            ", I " +
                            ", J " +
                            ", K " +
                            ", L " +
                            ", M " +
                            ", N " +
                            ", O " +
                            ", P " +
                            ", Q " +
                            ", R " +
                            ", S " +
                            ", T " +
                            ", U " +
                            ", V " +
                            ", W " +
                            ", X " +
                            ", Y " +
                            ", Z " +
                            ", A2 " +
                            ", B2 " +
                            ", C2 " +
                            ", D2 " +
                            ", E2 " +
                            ", F2 " +
                            ", G2 " +
                            ", H2 " +
                            ", I2 " +
                            ", J2 " +
                            ", K2 " +
                            ", L2 " +
                            ", M2 " +
                            ", N2 " +
                            ", O2 " +
                            ", P2 " +
                            ", Q2 " +
                            ", R2 " +
                            ", S2 " +
                            ", T2 " +
                            ", U2 " +
                            ", V2 " +
                            ", W2 " +
                            ", X2 " +
                            ", Y2 " +
                            ", Z2 " +
                            ", BarLength " +
                            ", BarLength2 " +
                            ", BarWeight " +
                            ", Remarks " +
                            ", shapeTransport " +
                            ", PinSize " +
                            ", TeklaGUID " +
                            ", PartGUID " +
                            ", UpdateDate " +
                            ", UpdateBy " +
                            ", CreateDate " +
                            ", CreateBy ) " +
                            "SELECT '" + CustomerCode + "' " +
                            ", '" + ProjectCode + "' " +
                            ", " + JobID.ToString() + " " +
                            ", " + lBBS[i].BBSID.ToString() + " " +
                            ", BarID + 1 - " + lMinBarID.ToString() + " " +
                            ", (BarID + 1 - " + lMinBarID.ToString() + ") * 100 " +
                            ", null " +
                            ", 1 " +
                            ", null " +
                            ", '' " +
                            ", BarMark " +
                            ", BarType " +
                            ", BarSize " +
                            ", " + MemberQty.ToString() + " " +
                            ", BarEachQty * BarMemberQty " +
                            ", BarEachQty * BarMemberQty * " + MemberQty.ToString() + " " +
                            ", BarShapeCode " +
                            ", A " +
                            ", B " +
                            ", C " +
                            ", D " +
                            ", E " +
                            ", F " +
                            ", G " +
                            ", H " +
                            ", I " +
                            ", J " +
                            ", K " +
                            ", L " +
                            ", M " +
                            ", N " +
                            ", O " +
                            ", P " +
                            ", Q " +
                            ", R " +
                            ", S " +
                            ", T " +
                            ", U " +
                            ", V " +
                            ", W " +
                            ", X " +
                            ", Y " +
                            ", Z " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", null " +
                            ", BarLength " +
                            ", null " +
                            ", BarWeight * " + MemberQty.ToString() + " " +
                            ", '' " +
                            ", 0 " +
                            ", CASE WHEN PinSize = 0 AND BarShapeCode <> '020' THEN " +
                            "(SELECT MAX(pin) FROM dbo.OESPin " +
                            "WHERE grade = C.BarType " +
                            "AND type = 'S' " +
                            "AND dia = C.BarSize )  " +
                            "ELSE PinSize END " +
                            ", TeklaGUID " +
                            ", PartGUID " +
                            ", getDate() " +
                            ", '" + UserName + "' " +
                            ", getDate() " +
                            ", '" + UserName + "' " +
                            "FROM dbo.OESIFCExtract C " +
                            "WHERE CustomerCode = '" + CustomerCode + "' " +
                            "AND ProjectCode = '" + ProjectCode + "' " +
                            "AND DrawingID = " + DrawingID.ToString() + " " +
                            "AND Rev = " + Revision.ToString() + " " +
                            "AND CreateBy = '" + UserName + "' " +
                            "AND ElementMark = '" + lBBS[i].BBSNo + "' ";

                            lCmd = new SqlCommand(lSQL, lNDSCon);
                            lCmd.CommandTimeout = 600;
                            lCmd.ExecuteNonQuery();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                lSuccess = false;
                lErrorMsg = ex.Message;
            }
            lProcessObj = null;

            return Ok(new { success = lSuccess, ErrorMessage = lErrorMsg });
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                db.Dispose();
            }
            base.Dispose(disposing);
        }


        //get BBS List at Order Summary
        [HttpPost]
        [Route("/getBBSOrder")]
        public ActionResult getBBS([FromBody] getBBSOrderDto getBBSOrderDto)
        {

            var content = (from p in db.BBS
                           where p.CustomerCode == getBBSOrderDto.CustomerCode &&
                           p.ProjectCode == getBBSOrderDto.ProjectCode &&
                           p.JobID == getBBSOrderDto.JobID
                           orderby p.BBSID
                           select p).ToList();

            return Ok(content);
        }

        [HttpGet]
        [Route("/getOrderDetailsCAB/{CustomerCode}/{ProjectCode}/{JobID}/{UserName}")]
        public async Task<ActionResult> getOrderDetails(string CustomerCode, string ProjectCode, int JobID, string UserName)
        {
            try
            {

            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lErrorMsg = "";
            string lSQL = "";

            int lPODocExists = 0;

            string lSubmission = "No";
            string lEditable = "No";

            var lJob = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

            if (lJob != null && (lJob.OrderStatus == "New" || lJob.OrderStatus == "Created"))
            {
                var lAccess = db.UserAccess.Find(User.Identity.Name, CustomerCode, ProjectCode);
                if (lAccess != null)
                {
                    lSubmission = lAccess.OrderSubmission.Trim();
                    lEditable = lAccess.OrderCreation.Trim();
                }
                lSubmission = (lSubmission == null ? "" : lSubmission);
                lEditable = (lEditable == null ? "" : lEditable);

                if (lSubmission.Trim() == "Yes" || lEditable.Trim() == "Yes")
                {
                    checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);
                }
            }

            //var content1 = db.PODoc.Find(CustomerCode, ProjectCode, JobID);
            //if (content1 != null)
            //{
            //    if (content1.FileName != null)
            //    {
            //        if (content1.FileName.Trim().Length > 0)
            //        {
            //            lPODocExists = 1;
            //        }
            //    }
            //}

            //lPODocExists = db.PODoc.Where(
            //                      p => p.CustomerCode == CustomerCode &&
            //                      p.ProjectCode == ProjectCode &&
            //                      p.JobID == JobID).Count();

            var content = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
            if (content != null)
            {
                if (content.CustomerCode == null) content.CustomerCode = "";
                else content.CustomerCode = content.CustomerCode.Trim();

                if (content.CouplerType == null) content.CouplerType = "";
                else content.CouplerType = content.CouplerType.Trim();

                if (content.OrderStatus == null) content.OrderStatus = "";
                else content.OrderStatus = content.OrderStatus.Trim();

                if (content.PONumber == null) content.PONumber = "";
                else content.PONumber = content.PONumber.Trim();

                if (content.ProjectCode == null) content.ProjectCode = "";
                else content.ProjectCode = content.ProjectCode.Trim();

                if (content.CouplerType == null) content.CouplerType = "";
                else content.CouplerType = content.CouplerType.Trim();

                if (content.ProjectStage == null) content.ProjectStage = "";
                else content.ProjectStage = content.ProjectStage.Trim();

                if (content.DeliveryAddress == null) content.DeliveryAddress = "";
                else content.DeliveryAddress = content.DeliveryAddress.Trim();

                if (content.Remarks == null) content.Remarks = "";
                else content.Remarks = content.Remarks.Trim();

                if (content.Scheduler_HP == null) content.Scheduler_HP = "";
                else content.Scheduler_HP = content.Scheduler_HP.Trim();

                if (content.Scheduler_Name == null) content.Scheduler_Name = "";
                else content.Scheduler_Name = content.Scheduler_Name.Trim();

                if (content.Scheduler_Tel == null) content.Scheduler_Tel = "";
                else content.Scheduler_Tel = content.Scheduler_Tel.Trim();

                if (content.SiteEngr_HP == null) content.SiteEngr_HP = "";
                else content.SiteEngr_HP = content.SiteEngr_HP.Trim();

                if (content.SiteEngr_Name == null) content.SiteEngr_Name = "";
                else content.SiteEngr_Name = content.SiteEngr_Name.Trim();

                if (content.SiteEngr_Tel == null) content.SiteEngr_Tel = "";
                else content.SiteEngr_Tel = content.SiteEngr_Tel.Trim();

                if (content.TransportLimit == null) content.TransportLimit = "";
                else content.TransportLimit = content.TransportLimit.Trim();

                if (content.TransportMode == null) content.TransportMode = "";
                else content.TransportMode = content.TransportMode.Trim();

                if (content.WBS1 == null) content.WBS1 = "";
                else content.WBS1 = content.WBS1.Trim();

                if (content.WBS2 == null) content.WBS2 = "";
                else content.WBS2 = content.WBS2.Trim();

                if (content.WBS3 == null) content.WBS3 = "";
                else content.WBS3 = content.WBS3.Trim();

                if (content.BBSStandard == null) content.BBSStandard = "";
                else content.BBSStandard = content.BBSStandard.Trim();

                //added data entry prompting
                content.Remarks = "";

                if (content.OrderStatus == null || content.OrderStatus == "" || content.OrderStatus == "New" || content.OrderStatus == "Created" || content.OrderStatus == "Created*" || content.OrderStatus == "Reserved" || content.OrderStatus == "Sent")
                {
                    var lProcessObj = new ProcessController();
                    if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                    {

                        string lUpdatedBy = "";
                        lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
                        "FROM dbo.OESOrderDetails " +
                        "WHERE CustomerCode = '" + content.CustomerCode + "' " +
                        "AND ProjectCode = '" + content.ProjectCode + "' " +
                        "AND JobID = " + content.JobID.ToString() + " " +
                        "AND UpdateDate >= DateAdd(ss,-300,getDate()) " +
                        "AND UpdateBy <> '" + UserName + "' ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandText = lSQL;
                        lCmd.CommandTimeout = 1200;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            lRst.Read();
                            lUpdatedBy = lRst.GetString(0).Trim();
                        }
                        lRst.Close();

                        lProcessObj.CloseNDSConnection(ref lNDSCon);

                        if (lUpdatedBy != "")
                        {
                            content.Remarks = "For your informaion, " + lUpdatedBy + " is updating the BBS details now. If you want to change the BBS data, please contact him/her for the updating status.";
                        }
                    }
                    lProcessObj = null;
                }

            }
            var lReturn = new
            {
                CustomerCode = content.CustomerCode.Trim(),
                ProjectCode = content.ProjectCode.Trim(),
                JobID = content.JobID,
                PONumber = content.PONumber.Trim(),
                PODate = content.PODate,
                RequiredDate = content.RequiredDate,
                CouplerType = content.CouplerType,
                OrderStatus = content.OrderStatus.Trim(),
                TotalCABWeight = content.TotalCABWeight,
                TotalSTDWeight = content.TotalSTDWeight,
                TotalWeight = content.TotalWeight,
                TransportLimit = content.TransportLimit.Trim(),
                TransportMode = content.TransportMode.Trim(),
                Scheduler_HP = content.Scheduler_HP.Trim(),
                Scheduler_Name = content.Scheduler_Name.Trim(),
                Scheduler_Tel = content.Scheduler_Tel.Trim(),
                SiteEngr_HP = content.SiteEngr_HP.Trim(),
                SiteEngr_Name = content.SiteEngr_Name.Trim(),
                SiteEngr_Tel = content.SiteEngr_Tel.Trim(),
                WBS1 = content.WBS1.Trim(),
                WBS2 = content.WBS2.Trim(),
                WBS3 = content.WBS3.Trim(),
                ProjectStage = content.ProjectStage.Trim(),
                DeliveryAddress = content.DeliveryAddress.Trim(),
                Remarks = content.Remarks.Trim(),
                UpdateDate = content.UpdateDate,
                OrderSource = content.OrderSource == null ? "" : content.OrderSource,
                Exists = lPODocExists,
                BBSStandard = content.BBSStandard
            };
            return Ok(lReturn);
            }
            catch (Exception ex)
            {
                var lProcessObj = new ProcessController();
                lProcessObj.SaveErrorMsg(ex.Message, ex.StackTrace);
                return Ok(false);
            }
        }

        [HttpGet]
        [Route("/checkUpdateBBSWT/{CustomerCode}/{ProjectCode}/{JobID}")]
        private int checkUpdateBBSWT(string CustomerCode, string ProjectCode, int JobID)
        {
            try
            {

            int lReturn = 0;
            decimal lTotalCABWT = 0;
            decimal lTotalSTDWT = 0;
            var lBBS = (from p in db.BBS
                        where p.CustomerCode == CustomerCode &&
                        p.ProjectCode == ProjectCode &&
                        p.JobID == JobID
                        select p).ToList();

            if (lBBS.Count > 0)
            {
                for (int i = 0; i < lBBS.Count; i++)
                {
                    int lBBSID = lBBS[i].BBSID;
                    var lBBSCABSum = (from p in db.OrderDetails
                                      where p.CustomerCode == CustomerCode &&
                                      p.ProjectCode == ProjectCode &&
                                      p.JobID == JobID &&
                                      p.BBSID == lBBSID &&
                                      p.BarSTD == null &&
                                      p.Cancelled == null
                                      select p.BarWeight).Sum();

                    lBBSCABSum = lBBSCABSum == null ? 0 : lBBSCABSum;

                    var lBBSSBSum = (from p in db.OrderDetails
                                     where p.CustomerCode == CustomerCode &&
                                     p.ProjectCode == ProjectCode &&
                                     p.JobID == JobID &&
                                     p.BBSID == lBBSID &&
                                     p.BarSTD == true &&
                                     p.Cancelled == null
                                     select p.BarWeight).Sum();

                    lBBSSBSum = lBBSSBSum == null ? 0 : lBBSSBSum;

                    lTotalCABWT = lTotalCABWT + (decimal)lBBSCABSum;
                    lTotalSTDWT = lTotalSTDWT + (decimal)lBBSSBSum;



                    if (lBBSCABSum != lBBS[i].BBSOrderCABWT || lBBSSBSum != lBBS[i].BBSOrderSTDWT)
                    {
                        var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
                        if (oldBBS != null)
                        {
                            BBSModels lUpdateBBS = oldBBS;
                            lUpdateBBS.BBSOrderCABWT = (decimal)lBBSCABSum;
                            lUpdateBBS.BBSOrderSTDWT = (decimal)lBBSSBSum;
                            lUpdateBBS.BBSTotalWT = (decimal)lBBSCABSum + (decimal)lBBSSBSum;
                            lUpdateBBS.BBSCancelledWT = 0;
                            db.Entry(oldBBS).CurrentValues.SetValues(lUpdateBBS);
                        }
                    }
                }

                var oldJob = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
                if (oldJob != null)
                {
                    if (lTotalCABWT != oldJob.TotalCABWeight || lTotalSTDWT != oldJob.TotalSTDWeight)
                    {
                        JobAdviceModels lUpdateJob = oldJob;
                        lUpdateJob.TotalCABWeight = lTotalCABWT;
                        lUpdateJob.TotalSTDWeight = lTotalSTDWT;
                        lUpdateJob.TotalWeight = lTotalCABWT + lTotalSTDWT;
                        db.Entry(oldJob).CurrentValues.SetValues(lUpdateJob);
                    }
                }

                db.SaveChanges();

            }
            return lReturn;
            }
            catch (Exception ex)
            {
                var lProcessObj = new ProcessController();
                lProcessObj.SaveErrorMsg(ex.Message, ex.StackTrace);
                return 0;
            }
        }

        //save BBS
        [HttpPost]
        [Route("/saveBarDetails")]
        public async Task<ActionResult> saveBarDetails([FromBody] OrderDetailsListModelsDto orderDetailsListModels)
        {
            bool lSuccess = true;
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lErrorMsg = "";
            string lSQL = "";
            string lOldShape = "";

            OrderDetailsModels orderDetailsModels = new OrderDetailsModels();
            try
            {
                string lShapeCode = orderDetailsListModels.BarShapeCode;
                if (lShapeCode == null)
                {
                    lShapeCode = "";
                }
                if (lShapeCode != "")
                {
                    while (lShapeCode.Length < 3)
                    {
                        lShapeCode = "0" + lShapeCode;
                    }

                    orderDetailsListModels.BarShapeCode = lShapeCode;
                }

                if (orderDetailsListModels.BarMark == null)
                {
                    orderDetailsListModels.BarMark = "";
                }
                if (orderDetailsListModels.BarMark.IndexOf(",") >= 0)
                {
                    orderDetailsListModels.BarMark = orderDetailsListModels.BarMark.Replace(",", "");
                }

                if (orderDetailsListModels.CustomerCode == null)
                {
                    orderDetailsListModels.CustomerCode = "";
                }
                if (orderDetailsListModels.CustomerCode.Length > 0)
                {


                    string lCustomerCode = orderDetailsListModels.CustomerCode;
                    string lProjectCode = orderDetailsListModels.ProjectCode;
                    int lJobID = orderDetailsListModels.JobID;
                    int lBBSID = orderDetailsListModels.BBSID;
                    int lBarID = orderDetailsListModels.BarID;

                    long lSNID = 0;

                    var lProcessObj = new ProcessController();
                    if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                    {
                        var lStatus = "";

                        lSQL = "SELECT isNull(OrderStatus,'') " +
                        "FROM dbo.OESJobAdvice WITH (NOLOCK) " +
                        "WHERE CustomerCode = '" + lCustomerCode + "' " +
                        "AND ProjectCode = '" + lProjectCode + "' " +
                        "AND JobID = " + lJobID.ToString() + " ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandText = lSQL;
                        lCmd.CommandTimeout = 1200;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            lRst.Read();
                            lStatus = lRst.GetString(0);
                        }
                        lRst.Close();

                        if (lStatus == "" || lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
                        {
                            string lUpdatedBy = "";
                            lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
                            "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
                            "WHERE CustomerCode = '" + lCustomerCode + "' " +
                            "AND ProjectCode = '" + lProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " " +
                            "AND BBSID = " + lBBSID.ToString() + " " +
                            "AND UpdateDate >= DateAdd(ss,-300,getDate()) " +
                            "AND UpdateBy <> '" + orderDetailsListModels.UpdateBy + "' ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandText = lSQL;
                            lCmd.CommandTimeout = 1200;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                lRst.Read();
                                lUpdatedBy = lRst.GetString(0).Trim();
                            }
                            lRst.Close();

                            if (lUpdatedBy != "")
                            {
                                lSuccess = false;
                                // lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
                                //return BadRequest(lUpdatedBy + " is updating the BBS. Please contact him/her for details.");
                                return Json(new { success = lSuccess, ErrorMessage = (lUpdatedBy + " is updating the BBS. Please contact him/her for details.") });
                            }

                            int lFound = 0;
                            lSQL = "SELECT BarID, BarShapeCode " +
                            "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
                            "WHERE CustomerCode = '" + lCustomerCode + "' " +
                            "AND ProjectCode = '" + lProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " " +
                            "AND BBSID = " + lBBSID.ToString() + " " +
                            "AND BarID = " + lBarID.ToString() + " ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandText = lSQL;
                            lCmd.CommandTimeout = 1200;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                lRst.Read();
                                lOldShape = lRst.GetString(1);
                                lFound = 1;
                            }
                            lRst.Close();

                            if (orderDetailsListModels.Remarks != null)
                            {
                                orderDetailsListModels.Remarks = orderDetailsListModels.Remarks.Replace("'", "''");
                            }
                            if (orderDetailsListModels.ElementMark != null)
                            {
                                orderDetailsListModels.ElementMark = orderDetailsListModels.ElementMark.Replace("'", "''");
                            }
                            if (orderDetailsListModels.BarMark != null)
                            {
                                orderDetailsListModels.BarMark = orderDetailsListModels.BarMark.Replace("'", "''");
                            }

                            if (lFound == 0)
                            {
                                lSQL = "" +
                                "INSERT INTO dbo.OESOrderDetails " +
                                "(CustomerCode " +
                                ", ProjectCode " +
                                ", JobID " +
                                ", BBSID " +
                                ", BarID " +
                                ", BarSort " +
                                ", Cancelled " +
                                ", BarCAB " +
                                ", BarSTD " +
                                ", ElementMark " +
                                ", BarMark " +
                                ", BarType " +
                                ", BarSize " +
                                ", BarMemberQty " +
                                ", BarEachQty " +
                                ", BarTotalQty " +
                                ", BarShapeCode " +
                                ", A " +
                                ", B " +
                                ", C " +
                                ", D " +
                                ", E " +
                                ", F " +
                                ", G " +
                                ", H " +
                                ", I " +
                                ", J " +
                                ", K " +
                                ", L " +
                                ", M " +
                                ", N " +
                                ", O " +
                                ", P " +
                                ", Q " +
                                ", R " +
                                ", S " +
                                ", T " +
                                ", U " +
                                ", V " +
                                ", W " +
                                ", X " +
                                ", Y " +
                                ", Z " +
                                ", A2 " +
                                ", B2 " +
                                ", C2 " +
                                ", D2 " +
                                ", E2 " +
                                ", F2 " +
                                ", G2 " +
                                ", H2 " +
                                ", I2 " +
                                ", J2 " +
                                ", K2 " +
                                ", L2 " +
                                ", M2 " +
                                ", N2 " +
                                ", O2 " +
                                ", P2 " +
                                ", Q2 " +
                                ", R2 " +
                                ", S2 " +
                                ", T2 " +
                                ", U2 " +
                                ", V2 " +
                                ", W2 " +
                                ", X2 " +
                                ", Y2 " +
                                ", Z2 " +
                                ", BarLength " +
                                ", BarLength2 " +
                                ", BarWeight " +
                                ", Remarks " +
                                ", shapeTransport " +
                                ", PinSize " +
                                ", TeklaGUID " +
                                ", PartGUID " +
                                ", UpdateDate " +
                                ", UpdateBy " +
                                ", CreateDate " +
                                ", CreateBy) " +
                                "VALUES " +
                                "( " +
                                "'" + orderDetailsListModels.CustomerCode + "' " +
                                ", '" + orderDetailsListModels.ProjectCode + "' " +
                                ", " + orderDetailsListModels.JobID + " " +
                                ", " + orderDetailsListModels.BBSID + " " +
                                ", " + orderDetailsListModels.BarID + " " +
                                ", " + orderDetailsListModels.BarSort + " " +
                                ", " + (orderDetailsListModels.Cancelled == true ? "1" : "null") + " " +
                                ", " + (orderDetailsListModels.BarSTD == true ? 0 : 1) + " " +
                                ", " + (orderDetailsListModels.BarSTD == true ? "1" : "null") + " " +
                                ", '" + orderDetailsListModels.ElementMark + "' " +
                                ", '" + orderDetailsListModels.BarMark + "' " +
                                ", '" + orderDetailsListModels.BarType + "' " +
                                ", " + (orderDetailsListModels.BarSize == 0 || orderDetailsListModels.BarSize == null ? "null" : orderDetailsListModels.BarSize.ToString()) + " " +
                                ", " + (orderDetailsListModels.BarMemberQty == 0 || orderDetailsListModels.BarMemberQty == null ? "null" : orderDetailsListModels.BarMemberQty.ToString()) + " " +
                                ", " + (orderDetailsListModels.BarEachQty == 0 || orderDetailsListModels.BarEachQty == null ? "null" : orderDetailsListModels.BarEachQty.ToString()) + " " +
                                ", " + (orderDetailsListModels.BarTotalQty == 0 || orderDetailsListModels.BarTotalQty == null ? "null" : orderDetailsListModels.BarTotalQty.ToString()) + " " +
                                ", '" + orderDetailsListModels.BarShapeCode + "' " +
                                ", " + getParaStringValue(orderDetailsListModels.A, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.B, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.C, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.D, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.E, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.F, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.G, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.H, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.I, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.J, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.K, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.L, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.M, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.N, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.O, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.P, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Q, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.R, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.S, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.T, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.U, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.V, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.W, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.X, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Y, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Z, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.A, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.B, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.C, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.D, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.E, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.F, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.G, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.H, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.I, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.J, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.K, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.L, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.M, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.N, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.O, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.P, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Q, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.R, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.S, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.T, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.U, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.V, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.W, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.X, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Y, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.Z, 2) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.BarLength, 1) + " " +
                                ", " + getParaStringValue(orderDetailsListModels.BarLength, 2) + " " +
                                ", " + (orderDetailsListModels.BarWeight == 0 || orderDetailsListModels.BarWeight == null ? "null" : orderDetailsListModels.BarWeight.ToString()) + " " +
                                ", '" + orderDetailsListModels.Remarks + "' " +
                                ", " + (orderDetailsListModels.shapeTransport == 0 || orderDetailsListModels.shapeTransport == null ? "null" : orderDetailsListModels.shapeTransport.ToString()) + " " +
                                ", " + (orderDetailsListModels.PinSize == 0 || orderDetailsListModels.PinSize == null ? "null" : orderDetailsListModels.PinSize.ToString()) + " " +
                                ", '' " +
                                ", '' " +
                                ", getDate() " +
                                ", '" + orderDetailsListModels.CreateBy + "' " +
                                ", getDate() " +
                                ", '" + orderDetailsListModels.UpdateBy + "' ) ";

                            }
                            else
                            {
                                int lOldShapeInt = 0;
                                int lNewShapeInt = 0;
                                Int32.TryParse(orderDetailsListModels.BarShapeCode, out lNewShapeInt);

                                if (Int32.TryParse(lOldShape, out lOldShapeInt))
                                {
                                    if (lOldShapeInt >= 950 && (lNewShapeInt < 950 || lNewShapeInt == 0) &&
                                        orderDetailsListModels.UpdateBy.IndexOf("@") > 0 &&
                                        orderDetailsListModels.UpdateBy.Split('@')[1].ToUpper() == "NATSTEEL.COM.SG")
                                    {
                                        lSQL = "" +
                                        "UPDATE dbo.OESCustomShapes " +
                                        "SET ShapeStatus = 'Inactive', " +
                                        "ReplacedBy = '" + orderDetailsListModels.BarShapeCode + "' " +
                                        "WHERE CustomerCode = '" + lCustomerCode + "' " +
                                        "AND ProjectCode = '" + lProjectCode + "' " +
                                        "AND shapeCode = '" + lOldShapeInt.ToString() + "' ";

                                        lCmd.Connection = lNDSCon;
                                        lCmd.CommandText = lSQL;
                                        lCmd.CommandTimeout = 1200;
                                        lCmd.ExecuteNonQuery();
                                    }
                                }

                                lSQL = "" +
                                "UPDATE dbo.OESOrderDetails SET " +
                                "BarSort = " + orderDetailsListModels.BarSort + " " +
                                ", Cancelled = " + (orderDetailsListModels.Cancelled == true ? "1" : "null") + " " +
                                ", BarCAB = " + (orderDetailsListModels.BarSTD == true ? 0 : 1) + " " +
                                ", BarSTD = " + (orderDetailsListModels.BarSTD == true ? "1" : "null") + " " +
                                ", ElementMark = '" + orderDetailsListModels.ElementMark + "' " +
                                ", BarMark = '" + orderDetailsListModels.BarMark + "' " +
                                ", BarType = '" + orderDetailsListModels.BarType + "' " +
                                ", BarSize = " + (orderDetailsListModels.BarSize == 0 || orderDetailsListModels.BarSize == null ? "null" : orderDetailsListModels.BarSize.ToString()) + " " +
                                ", BarMemberQty = " + (orderDetailsListModels.BarMemberQty == 0 || orderDetailsListModels.BarMemberQty == null ? "null" : orderDetailsListModels.BarMemberQty.ToString()) + " " +
                                ", BarEachQty = " + (orderDetailsListModels.BarEachQty == 0 || orderDetailsListModels.BarEachQty == null ? "null" : orderDetailsListModels.BarEachQty.ToString()) + " " +
                                ", BarTotalQty = " + (orderDetailsListModels.BarTotalQty == 0 || orderDetailsListModels.BarTotalQty == null ? "null" : orderDetailsListModels.BarTotalQty.ToString()) + " " +
                                ", BarShapeCode = '" + orderDetailsListModels.BarShapeCode + "' " +
                                ", A = " + getParaStringValue(orderDetailsListModels.A, 1) + " " +
                                ", B = " + getParaStringValue(orderDetailsListModels.B, 1) + " " +
                                ", C = " + getParaStringValue(orderDetailsListModels.C, 1) + " " +
                                ", D = " + getParaStringValue(orderDetailsListModels.D, 1) + " " +
                                ", E = " + getParaStringValue(orderDetailsListModels.E, 1) + " " +
                                ", F = " + getParaStringValue(orderDetailsListModels.F, 1) + " " +
                                ", G = " + getParaStringValue(orderDetailsListModels.G, 1) + " " +
                                ", H = " + getParaStringValue(orderDetailsListModels.H, 1) + " " +
                                ", I = " + getParaStringValue(orderDetailsListModels.I, 1) + " " +
                                ", J = " + getParaStringValue(orderDetailsListModels.J, 1) + " " +
                                ", K = " + getParaStringValue(orderDetailsListModels.K, 1) + " " +
                                ", L = " + getParaStringValue(orderDetailsListModels.L, 1) + " " +
                                ", M = " + getParaStringValue(orderDetailsListModels.M, 1) + " " +
                                ", N = " + getParaStringValue(orderDetailsListModels.N, 1) + " " +
                                ", O = " + getParaStringValue(orderDetailsListModels.O, 1) + " " +
                                ", P = " + getParaStringValue(orderDetailsListModels.P, 1) + " " +
                                ", Q = " + getParaStringValue(orderDetailsListModels.Q, 1) + " " +
                                ", R = " + getParaStringValue(orderDetailsListModels.R, 1) + " " +
                                ", S = " + getParaStringValue(orderDetailsListModels.S, 1) + " " +
                                ", T = " + getParaStringValue(orderDetailsListModels.T, 1) + " " +
                                ", U = " + getParaStringValue(orderDetailsListModels.U, 1) + " " +
                                ", V = " + getParaStringValue(orderDetailsListModels.V, 1) + " " +
                                ", W = " + getParaStringValue(orderDetailsListModels.W, 1) + " " +
                                ", X = " + getParaStringValue(orderDetailsListModels.X, 1) + " " +
                                ", Y = " + getParaStringValue(orderDetailsListModels.Y, 1) + " " +
                                ", Z = " + getParaStringValue(orderDetailsListModels.Z, 1) + " " +
                                ", A2 = " + getParaStringValue(orderDetailsListModels.A, 2) + " " +
                                ", B2 = " + getParaStringValue(orderDetailsListModels.B, 2) + " " +
                                ", C2 = " + getParaStringValue(orderDetailsListModels.C, 2) + " " +
                                ", D2 = " + getParaStringValue(orderDetailsListModels.D, 2) + " " +
                                ", E2 = " + getParaStringValue(orderDetailsListModels.E, 2) + " " +
                                ", F2 = " + getParaStringValue(orderDetailsListModels.F, 2) + " " +
                                ", G2 = " + getParaStringValue(orderDetailsListModels.G, 2) + " " +
                                ", H2 = " + getParaStringValue(orderDetailsListModels.H, 2) + " " +
                                ", I2 = " + getParaStringValue(orderDetailsListModels.I, 2) + " " +
                                ", J2 = " + getParaStringValue(orderDetailsListModels.J, 2) + " " +
                                ", K2 = " + getParaStringValue(orderDetailsListModels.K, 2) + " " +
                                ", L2 = " + getParaStringValue(orderDetailsListModels.L, 2) + " " +
                                ", M2 = " + getParaStringValue(orderDetailsListModels.M, 2) + " " +
                                ", N2 = " + getParaStringValue(orderDetailsListModels.N, 2) + " " +
                                ", O2 = " + getParaStringValue(orderDetailsListModels.O, 2) + " " +
                                ", P2 = " + getParaStringValue(orderDetailsListModels.P, 2) + " " +
                                ", Q2 = " + getParaStringValue(orderDetailsListModels.Q, 2) + " " +
                                ", R2 = " + getParaStringValue(orderDetailsListModels.R, 2) + " " +
                                ", S2 = " + getParaStringValue(orderDetailsListModels.S, 2) + " " +
                                ", T2 = " + getParaStringValue(orderDetailsListModels.T, 2) + " " +
                                ", U2 = " + getParaStringValue(orderDetailsListModels.U, 2) + " " +
                                ", V2 = " + getParaStringValue(orderDetailsListModels.V, 2) + " " +
                                ", W2 = " + getParaStringValue(orderDetailsListModels.W, 2) + " " +
                                ", X2 = " + getParaStringValue(orderDetailsListModels.X, 2) + " " +
                                ", Y2 = " + getParaStringValue(orderDetailsListModels.Y, 2) + " " +
                                ", Z2 = " + getParaStringValue(orderDetailsListModels.Z, 2) + " " +
                                ", BarLength = " + getParaStringValue(orderDetailsListModels.BarLength, 1) + " " +
                                ", BarLength2 = " + getParaStringValue(orderDetailsListModels.BarLength, 2) + " " +
                                ", BarWeight = " + (orderDetailsListModels.BarWeight == 0 || orderDetailsListModels.BarWeight == null ? "null" : orderDetailsListModels.BarWeight.ToString()) + " " +
                                ", Remarks = '" + orderDetailsListModels.Remarks + "' " +
                                ", shapeTransport = " + (orderDetailsListModels.shapeTransport == 0 || orderDetailsListModels.shapeTransport == null ? "null" : orderDetailsListModels.shapeTransport.ToString()) + " " +
                                ", PinSize = " + (orderDetailsListModels.PinSize == 0 || orderDetailsListModels.PinSize == null ? "null" : orderDetailsListModels.PinSize.ToString()) + " " +
                                ", UpdateDate = getDate() " +
                                ", UpdateBy = '" + orderDetailsListModels.UpdateBy + "' " +
                                "WHERE CustomerCode = '" + lCustomerCode + "' " +
                                "AND ProjectCode = '" + lProjectCode + "' " +
                                "AND JobID = " + lJobID.ToString() + " " +
                                "AND BBSID = " + lBBSID.ToString() + " " +
                                "AND BarID = " + lBarID.ToString() + " ";

                            }

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandText = lSQL;
                            lCmd.CommandTimeout = 1200;
                            lCmd.ExecuteNonQuery();

                            lCmd.CommandText =
                            "SELECT RowNum FROM ( " +
                            "SELECT Row_Number() over(order by BarSort) as RowNum, barID " +
                            "FROM dbo.OESOrderDetails WITH (NOLOCK) " +
                            "WHERE CustomerCode = '" + lCustomerCode + "' " +
                            "AND ProjectCode = '" + lProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " " +
                            "AND BBSID = " + lBBSID.ToString() + " " +
                            ") t2 " +
                            "WHERE barID = " + lBarID.ToString() + " ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 1200;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                lRst.Read();
                                lSNID = lRst.GetInt64(0);
                            }
                            lRst.Close();

                            lCmd.CommandText =
                            "SELECT barID FROM ( " +
                            "SELECT Row_Number() over (order by BarSort) as RowNum, barID " +
                            "FROM dbo.OESOrderDetailsDouble WITH (NOLOCK) " +
                            "WHERE CustomerCode = '" + lCustomerCode + "' " +
                            "AND ProjectCode = '" + lProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " " +
                            "AND BBSID = " + lBBSID.ToString() + " " +
                            ") t2 " +
                            "WHERE RowNum = " + lSNID.ToString() + " ";

                            lCmd.Connection = lNDSCon;
                            lCmd.CommandTimeout = 1200;
                            lRst = lCmd.ExecuteReader();
                            if (lRst.HasRows)
                            {
                                lRst.Read();
                                lBarID = lRst.GetInt32(0);
                            }
                            lRst.Close();
                        }
                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);

                    var lOrderDetailsDBL = (from p in db.OrderDetailsDouble
                                            where p.CustomerCode == lCustomerCode &&
                                            p.ProjectCode == lProjectCode &&
                                            p.JobID == lJobID &&
                                            p.BBSID == lBBSID &&
                                            p.BarID == lBarID
                                            select p).ToList();
                    //return Json(true);
                    var lDBLReturn = new OrderDetailsListModels();

                    var lBarsDetailsDBLList = new List<OrderDetailsListModels>();
                    if (lOrderDetailsDBL != null && lOrderDetailsDBL.Count > 0)
                    {
                        lBarsDetailsDBLList = new List<OrderDetailsListModels>(
                            lOrderDetailsDBL.Select(h => new OrderDetailsListModels
                            {
                                CustomerCode = h.CustomerCode,
                                ProjectCode = h.ProjectCode,
                                JobID = h.JobID,
                                BBSID = h.BBSID,
                                BarID = h.BarID,
                                BarSort = h.BarSort,
                                Cancelled = h.Cancelled,
                                ElementMark = h.ElementMark,
                                BarMark = h.BarMark,
                                BarType = h.BarType,
                                BarSize = h.BarSize,
                                BarCAB = h.BarCAB,
                                BarSTD = h.BarSTD == false ? null : h.BarSTD,
                                BarMemberQty = h.BarMemberQty,
                                BarEachQty = h.BarEachQty,
                                BarTotalQty = h.BarTotalQty,
                                BarShapeCode = h.BarShapeCode,
                                A = ((h.A == null) ? null : (h.A > 0 && h.A2 > 0) ? h.A.ToString() + '-' + h.A2.ToString() : h.A.ToString()),
                                B = ((h.B == null) ? null : (h.B > 0 && h.B2 > 0) ? h.B.ToString() + '-' + h.B2.ToString() : h.B.ToString()),
                                C = ((h.C == null) ? null : (h.C > 0 && h.C2 > 0) ? h.C.ToString() + '-' + h.C2.ToString() : h.C.ToString()),
                                D = ((h.D == null) ? null : (h.D > 0 && h.D2 > 0) ? h.D.ToString() + '-' + h.D2.ToString() : h.D.ToString()),
                                E = ((h.E == null) ? null : (h.E > 0 && h.E2 > 0) ? h.E.ToString() + '-' + h.E2.ToString() : h.E.ToString()),
                                F = ((h.F == null) ? null : (h.F > 0 && h.F2 > 0) ? h.F.ToString() + '-' + h.F2.ToString() : h.F.ToString()),
                                G = ((h.G == null) ? null : (h.G > 0 && h.G2 > 0) ? h.G.ToString() + '-' + h.G2.ToString() : h.G.ToString()),
                                H = ((h.H == null) ? null : (h.H > 0 && h.H2 > 0) ? h.H.ToString() + '-' + h.H2.ToString() : h.H.ToString()),
                                I = ((h.I == null) ? null : (h.I > 0 && h.I2 > 0) ? h.I.ToString() + '-' + h.I2.ToString() : h.I.ToString()),
                                J = ((h.J == null) ? null : (h.J > 0 && h.J2 > 0) ? h.J.ToString() + '-' + h.J2.ToString() : h.J.ToString()),
                                K = ((h.K == null) ? null : (h.K > 0 && h.K2 > 0) ? h.K.ToString() + '-' + h.K2.ToString() : h.K.ToString()),
                                L = ((h.L == null) ? null : (h.L > 0 && h.L2 > 0) ? h.L.ToString() + '-' + h.L2.ToString() : h.L.ToString()),
                                M = ((h.M == null) ? null : (h.M > 0 && h.M2 > 0) ? h.M.ToString() + '-' + h.M2.ToString() : h.M.ToString()),
                                N = ((h.N == null) ? null : (h.N > 0 && h.N2 > 0) ? h.N.ToString() + '-' + h.N2.ToString() : h.N.ToString()),
                                O = ((h.O == null) ? null : (h.O > 0 && h.O2 > 0) ? h.O.ToString() + '-' + h.O2.ToString() : h.O.ToString()),
                                P = ((h.P == null) ? null : (h.P > 0 && h.P2 > 0) ? h.P.ToString() + '-' + h.P2.ToString() : h.P.ToString()),
                                Q = ((h.Q == null) ? null : (h.Q > 0 && h.Q2 > 0) ? h.Q.ToString() + '-' + h.Q2.ToString() : h.Q.ToString()),
                                R = ((h.R == null) ? null : (h.R > 0 && h.R2 > 0) ? h.R.ToString() + '-' + h.R2.ToString() : h.R.ToString()),
                                S = ((h.S == null) ? null : (h.S > 0 && h.S2 > 0) ? h.S.ToString() + '-' + h.S2.ToString() : h.S.ToString()),
                                T = ((h.T == null) ? null : (h.T > 0 && h.T2 > 0) ? h.T.ToString() + '-' + h.T2.ToString() : h.T.ToString()),
                                U = ((h.U == null) ? null : (h.U > 0 && h.U2 > 0) ? h.U.ToString() + '-' + h.U2.ToString() : h.U.ToString()),
                                V = ((h.V == null) ? null : (h.V > 0 && h.V2 > 0) ? h.V.ToString() + '-' + h.V2.ToString() : h.V.ToString()),
                                W = ((h.W == null) ? null : (h.W > 0 && h.W2 > 0) ? h.W.ToString() + '-' + h.W2.ToString() : h.W.ToString()),
                                X = ((h.X == null) ? null : (h.X > 0 && h.X2 > 0) ? h.X.ToString() + '-' + h.X2.ToString() : h.X.ToString()),
                                Y = ((h.Y == null) ? null : (h.Y > 0 && h.Y2 > 0) ? h.Y.ToString() + '-' + h.Y2.ToString() : h.Y.ToString()),
                                Z = ((h.Z == null) ? null : (h.Z > 0 && h.Z2 > 0) ? h.Z.ToString() + '-' + h.Z2.ToString() : h.Z.ToString()),
                                BarLength = ((h.BarLength == null) ? null : (h.BarLength > 0 && h.BarLength2 > 0) ? h.BarLength.ToString() + '-' + h.BarLength2.ToString() : h.BarLength.ToString()),
                                BarWeight = h.BarWeight,
                                Remarks = h.Remarks,
                                shapeTransport = h.shapeTransport,
                                PinSize = h.PinSize,
                                UpdateDate = h.UpdateDate
                            })
                        );

                    }

                    if (lBarsDetailsDBLList != null && lBarsDetailsDBLList.Count > 0)
                    {
                        if (orderDetailsListModels.BarType == lBarsDetailsDBLList[0].BarType) lDBLReturn.BarType = "1"; else lDBLReturn.BarType = "0";
                        if (orderDetailsListModels.BarSize == lBarsDetailsDBLList[0].BarSize) lDBLReturn.BarSize = 1; else lDBLReturn.BarSize = 0;
                        if (orderDetailsListModels.BarMemberQty == lBarsDetailsDBLList[0].BarMemberQty) lDBLReturn.BarMemberQty = 1; else lDBLReturn.BarMemberQty = 0;
                        if (orderDetailsListModels.BarEachQty == lBarsDetailsDBLList[0].BarEachQty) lDBLReturn.BarEachQty = 1; else lDBLReturn.BarEachQty = 0;
                        if (orderDetailsListModels.BarShapeCode == lBarsDetailsDBLList[0].BarShapeCode) lDBLReturn.BarShapeCode = "1"; else lDBLReturn.BarShapeCode = "0";
                        if (orderDetailsListModels.A != null && lBarsDetailsDBLList[0].A != null) { if (orderDetailsListModels.A == lBarsDetailsDBLList[0].A) lDBLReturn.A = "1"; else lDBLReturn.A = "0"; }
                        if (orderDetailsListModels.B != null && lBarsDetailsDBLList[0].B != null) { if (orderDetailsListModels.B == lBarsDetailsDBLList[0].B) lDBLReturn.B = "1"; else lDBLReturn.B = "0"; }
                        if (orderDetailsListModels.C != null && lBarsDetailsDBLList[0].C != null) { if (orderDetailsListModels.C == lBarsDetailsDBLList[0].C) lDBLReturn.C = "1"; else lDBLReturn.C = "0"; }
                        if (orderDetailsListModels.D != null && lBarsDetailsDBLList[0].D != null) { if (orderDetailsListModels.D == lBarsDetailsDBLList[0].D) lDBLReturn.D = "1"; else lDBLReturn.D = "0"; }
                        if (orderDetailsListModels.E != null && lBarsDetailsDBLList[0].E != null) { if (orderDetailsListModels.E == lBarsDetailsDBLList[0].E) lDBLReturn.E = "1"; else lDBLReturn.E = "0"; }
                        if (orderDetailsListModels.F != null && lBarsDetailsDBLList[0].F != null) { if (orderDetailsListModels.F == lBarsDetailsDBLList[0].F) lDBLReturn.F = "1"; else lDBLReturn.F = "0"; }
                        if (orderDetailsListModels.G != null && lBarsDetailsDBLList[0].G != null) { if (orderDetailsListModels.G == lBarsDetailsDBLList[0].G) lDBLReturn.G = "1"; else lDBLReturn.G = "0"; }
                        if (orderDetailsListModels.H != null && lBarsDetailsDBLList[0].H != null) { if (orderDetailsListModels.H == lBarsDetailsDBLList[0].H) lDBLReturn.H = "1"; else lDBLReturn.H = "0"; }
                        if (orderDetailsListModels.I != null && lBarsDetailsDBLList[0].I != null) { if (orderDetailsListModels.I == lBarsDetailsDBLList[0].I) lDBLReturn.I = "1"; else lDBLReturn.I = "0"; }
                        if (orderDetailsListModels.J != null && lBarsDetailsDBLList[0].J != null) { if (orderDetailsListModels.J == lBarsDetailsDBLList[0].J) lDBLReturn.J = "1"; else lDBLReturn.J = "0"; }
                        if (orderDetailsListModels.K != null && lBarsDetailsDBLList[0].K != null) { if (orderDetailsListModels.K == lBarsDetailsDBLList[0].K) lDBLReturn.K = "1"; else lDBLReturn.K = "0"; }
                        if (orderDetailsListModels.L != null && lBarsDetailsDBLList[0].L != null) { if (orderDetailsListModels.L == lBarsDetailsDBLList[0].L) lDBLReturn.L = "1"; else lDBLReturn.L = "0"; }
                        if (orderDetailsListModels.M != null && lBarsDetailsDBLList[0].M != null) { if (orderDetailsListModels.M == lBarsDetailsDBLList[0].M) lDBLReturn.M = "1"; else lDBLReturn.M = "0"; }
                        if (orderDetailsListModels.N != null && lBarsDetailsDBLList[0].N != null) { if (orderDetailsListModels.N == lBarsDetailsDBLList[0].N) lDBLReturn.N = "1"; else lDBLReturn.N = "0"; }
                        if (orderDetailsListModels.O != null && lBarsDetailsDBLList[0].O != null) { if (orderDetailsListModels.O == lBarsDetailsDBLList[0].O) lDBLReturn.O = "1"; else lDBLReturn.O = "0"; }
                        if (orderDetailsListModels.P != null && lBarsDetailsDBLList[0].P != null) { if (orderDetailsListModels.P == lBarsDetailsDBLList[0].P) lDBLReturn.P = "1"; else lDBLReturn.P = "0"; }
                        if (orderDetailsListModels.Q != null && lBarsDetailsDBLList[0].Q != null) { if (orderDetailsListModels.Q == lBarsDetailsDBLList[0].Q) lDBLReturn.Q = "1"; else lDBLReturn.Q = "0"; }
                        if (orderDetailsListModels.R != null && lBarsDetailsDBLList[0].R != null) { if (orderDetailsListModels.R == lBarsDetailsDBLList[0].R) lDBLReturn.R = "1"; else lDBLReturn.R = "0"; }
                        if (orderDetailsListModels.S != null && lBarsDetailsDBLList[0].S != null) { if (orderDetailsListModels.S == lBarsDetailsDBLList[0].S) lDBLReturn.S = "1"; else lDBLReturn.S = "0"; }
                        if (orderDetailsListModels.T != null && lBarsDetailsDBLList[0].T != null) { if (orderDetailsListModels.T == lBarsDetailsDBLList[0].T) lDBLReturn.T = "1"; else lDBLReturn.T = "0"; }
                        if (orderDetailsListModels.U != null && lBarsDetailsDBLList[0].U != null) { if (orderDetailsListModels.U == lBarsDetailsDBLList[0].U) lDBLReturn.U = "1"; else lDBLReturn.U = "0"; }
                        if (orderDetailsListModels.V != null && lBarsDetailsDBLList[0].V != null) { if (orderDetailsListModels.V == lBarsDetailsDBLList[0].V) lDBLReturn.V = "1"; else lDBLReturn.V = "0"; }
                        if (orderDetailsListModels.W != null && lBarsDetailsDBLList[0].W != null) { if (orderDetailsListModels.W == lBarsDetailsDBLList[0].W) lDBLReturn.W = "1"; else lDBLReturn.W = "0"; }
                        if (orderDetailsListModels.X != null && lBarsDetailsDBLList[0].X != null) { if (orderDetailsListModels.X == lBarsDetailsDBLList[0].X) lDBLReturn.X = "1"; else lDBLReturn.X = "0"; }
                        if (orderDetailsListModels.Y != null && lBarsDetailsDBLList[0].Y != null) { if (orderDetailsListModels.Y == lBarsDetailsDBLList[0].Y) lDBLReturn.Y = "1"; else lDBLReturn.Y = "0"; }
                        if (orderDetailsListModels.Z != null && lBarsDetailsDBLList[0].Z != null) { if (orderDetailsListModels.Z == lBarsDetailsDBLList[0].Z) lDBLReturn.Z = "1"; else lDBLReturn.Z = "0"; }
                    }

                    return Json(new { success = lSuccess, respDoubleCapture = lDBLReturn });
                    //return Ok(lDBLReturn);
                }
                else
                {
                    lErrorMsg = "Invalid Customer Code";
                    lSuccess = false;
                }

            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
                lSuccess = false;
            }
            //return Ok();
            return Json(new { success = lSuccess, ErrorMessage = lErrorMsg });
        }

        private string getParaStringValue(string pParameter, byte pPos)
        {
            string lReturn = "null";
            if (pParameter != null)
            {
                if (pParameter.Trim().Length > 0)
                {
                    int lVar = 0;
                    if (int.TryParse(pParameter, out lVar) == true && pPos == 1)
                    {
                        if (lVar > 0) lReturn = lVar.ToString();
                    }
                    else
                    {
                        var lArray = pParameter.Split(new[] { '-', '~' });
                        if (lArray != null)
                        {
                            if (lArray.Length >= 2)
                            {
                                lVar = 0;
                                if (pPos == 1)
                                {
                                    if (int.TryParse(lArray[0], out lVar) == true)
                                    {
                                        if (lVar > 0) lReturn = lVar.ToString();
                                    }
                                }
                                if (pPos == 2)
                                {
                                    if (int.TryParse(lArray[1], out lVar) == true)
                                    {
                                        if (lVar > 0) lReturn = lVar.ToString();
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return lReturn;
        }

        //get Bars List 
        [HttpGet]
        [Route("/getBarDetails/{CustomerCode}/{ProjectCode}/{JobID}/{BBSID}")]
        public async Task<ActionResult> getBarDetails(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        {
            var lNDSCon = new SqlConnection();

            var content = await (from p in db.OrderDetails
                                 join s in db.Shape
                                 on p.BarShapeCode equals s.shapeCode into Shape1
                                 from s1 in Shape1.DefaultIfEmpty()
                                 where p.CustomerCode == CustomerCode &&
                                 p.ProjectCode == ProjectCode &&
                                 p.JobID == JobID && p.BBSID == BBSID
                                 orderby p.BarSort, p.BarID
                                 select new
                                 {
                                     p.CustomerCode,
                                     p.ProjectCode,
                                     p.JobID,
                                     p.BBSID,
                                     p.BarID,
                                     p.BarSort,
                                     p.Cancelled,
                                     p.ElementMark,
                                     p.BarMark,
                                     p.BarType,
                                     p.BarSize,
                                     p.BarCAB,
                                     p.BarSTD,
                                     p.BarMemberQty,
                                     p.BarEachQty,
                                     p.BarTotalQty,
                                     p.BarShapeCode,
                                     p.A,
                                     p.B,
                                     p.C,
                                     p.D,
                                     p.E,
                                     p.F,
                                     p.G,
                                     p.H,
                                     p.I,
                                     p.J,
                                     p.K,
                                     p.L,
                                     p.M,
                                     p.N,
                                     p.O,
                                     p.P,
                                     p.Q,
                                     p.R,
                                     p.S,
                                     p.T,
                                     p.U,
                                     p.V,
                                     p.W,
                                     p.X,
                                     p.Y,
                                     p.Z,
                                     p.A2,
                                     p.B2,
                                     p.C2,
                                     p.D2,
                                     p.E2,
                                     p.F2,
                                     p.G2,
                                     p.H2,
                                     p.I2,
                                     p.J2,
                                     p.K2,
                                     p.L2,
                                     p.M2,
                                     p.N2,
                                     p.O2,
                                     p.P2,
                                     p.Q2,
                                     p.R2,
                                     p.S2,
                                     p.T2,
                                     p.U2,
                                     p.V2,
                                     p.W2,
                                     p.X2,
                                     p.Y2,
                                     p.Z2,
                                     p.BarLength,
                                     p.BarLength2,
                                     p.BarWeight,
                                     p.Remarks,
                                     s1.shapeParameters,
                                     s1.shapeLengthFormula,
                                     s1.shapeParaValidator,
                                     s1.shapeTransportValidator,
                                     p.shapeTransport,
                                     p.PinSize,
                                     p.UpdateDate,
                                     p.UpdateBy,
                                     p.CreateBy
                                 }).ToListAsync();

            var lBarsDetailsList = new List<OrderDetailsListModels>();
            if (content.Count > 0)
            {
                lBarsDetailsList = new List<OrderDetailsListModels>(
                    content.Select(h => new OrderDetailsListModels
                    {
                        CustomerCode = h.CustomerCode,
                        ProjectCode = h.ProjectCode,
                        JobID = h.JobID,
                        BBSID = h.BBSID,
                        BarID = h.BarID,
                        BarSort = h.BarSort,
                        Cancelled = h.Cancelled,
                        ElementMark = h.ElementMark,
                        BarMark = h.BarMark,
                        BarType = h.BarType,
                        BarSize = h.BarSize,
                        BarCAB = h.BarCAB,
                        BarSTD = h.BarSTD == false ? null : h.BarSTD,
                        BarMemberQty = h.BarMemberQty,
                        BarEachQty = h.BarEachQty,
                        BarTotalQty = h.BarTotalQty,
                        BarShapeCode = h.BarShapeCode,
                        A = ((h.A == null) ? null : (h.A > 0 && h.A2 > 0) ? h.A.ToString() + '-' + h.A2.ToString() : h.A.ToString()),
                        B = ((h.B == null) ? null : (h.B > 0 && h.B2 > 0) ? h.B.ToString() + '-' + h.B2.ToString() : h.B.ToString()),
                        C = ((h.C == null) ? null : (h.C > 0 && h.C2 > 0) ? h.C.ToString() + '-' + h.C2.ToString() : h.C.ToString()),
                        D = ((h.D == null) ? null : (h.D > 0 && h.D2 > 0) ? h.D.ToString() + '-' + h.D2.ToString() : h.D.ToString()),
                        E = ((h.E == null) ? null : (h.E > 0 && h.E2 > 0) ? h.E.ToString() + '-' + h.E2.ToString() : h.E.ToString()),
                        F = ((h.F == null) ? null : (h.F > 0 && h.F2 > 0) ? h.F.ToString() + '-' + h.F2.ToString() : h.F.ToString()),
                        G = ((h.G == null) ? null : (h.G > 0 && h.G2 > 0) ? h.G.ToString() + '-' + h.G2.ToString() : h.G.ToString()),
                        H = ((h.H == null) ? null : (h.H > 0 && h.H2 > 0) ? h.H.ToString() + '-' + h.H2.ToString() : h.H.ToString()),
                        I = ((h.I == null) ? null : (h.I > 0 && h.I2 > 0) ? h.I.ToString() + '-' + h.I2.ToString() : h.I.ToString()),
                        J = ((h.J == null) ? null : (h.J > 0 && h.J2 > 0) ? h.J.ToString() + '-' + h.J2.ToString() : h.J.ToString()),
                        K = ((h.K == null) ? null : (h.K > 0 && h.K2 > 0) ? h.K.ToString() + '-' + h.K2.ToString() : h.K.ToString()),
                        L = ((h.L == null) ? null : (h.L > 0 && h.L2 > 0) ? h.L.ToString() + '-' + h.L2.ToString() : h.L.ToString()),
                        M = ((h.M == null) ? null : (h.M > 0 && h.M2 > 0) ? h.M.ToString() + '-' + h.M2.ToString() : h.M.ToString()),
                        N = ((h.N == null) ? null : (h.N > 0 && h.N2 > 0) ? h.N.ToString() + '-' + h.N2.ToString() : h.N.ToString()),
                        O = ((h.O == null) ? null : (h.O > 0 && h.O2 > 0) ? h.O.ToString() + '-' + h.O2.ToString() : h.O.ToString()),
                        P = ((h.P == null) ? null : (h.P > 0 && h.P2 > 0) ? h.P.ToString() + '-' + h.P2.ToString() : h.P.ToString()),
                        Q = ((h.Q == null) ? null : (h.Q > 0 && h.Q2 > 0) ? h.Q.ToString() + '-' + h.Q2.ToString() : h.Q.ToString()),
                        R = ((h.R == null) ? null : (h.R > 0 && h.R2 > 0) ? h.R.ToString() + '-' + h.R2.ToString() : h.R.ToString()),
                        S = ((h.S == null) ? null : (h.S > 0 && h.S2 > 0) ? h.S.ToString() + '-' + h.S2.ToString() : h.S.ToString()),
                        T = ((h.T == null) ? null : (h.T > 0 && h.T2 > 0) ? h.T.ToString() + '-' + h.T2.ToString() : h.T.ToString()),
                        U = ((h.U == null) ? null : (h.U > 0 && h.U2 > 0) ? h.U.ToString() + '-' + h.U2.ToString() : h.U.ToString()),
                        V = ((h.V == null) ? null : (h.V > 0 && h.V2 > 0) ? h.V.ToString() + '-' + h.V2.ToString() : h.V.ToString()),
                        W = ((h.W == null) ? null : (h.W > 0 && h.W2 > 0) ? h.W.ToString() + '-' + h.W2.ToString() : h.W.ToString()),
                        X = ((h.X == null) ? null : (h.X > 0 && h.X2 > 0) ? h.X.ToString() + '-' + h.X2.ToString() : h.X.ToString()),
                        Y = ((h.Y == null) ? null : (h.Y > 0 && h.Y2 > 0) ? h.Y.ToString() + '-' + h.Y2.ToString() : h.Y.ToString()),
                        Z = ((h.Z == null) ? null : (h.Z > 0 && h.Z2 > 0) ? h.Z.ToString() + '-' + h.Z2.ToString() : h.Z.ToString()),
                        BarLength = ((h.BarLength == null) ? null : (h.BarLength > 0 && h.BarLength2 > 0) ? h.BarLength.ToString() + '-' + h.BarLength2.ToString() : h.BarLength.ToString()),
                        BarWeight = h.BarWeight,
                        Remarks = h.Remarks,
                        shapeParameters = h.shapeParameters,
                        shapeLengthFormula = h.shapeLengthFormula,
                        shapeParaValidator = h.shapeParaValidator,
                        shapeTransportValidator = h.shapeTransportValidator,
                        shapeTransport = h.shapeTransport,
                        PinSize = h.PinSize,
                        UpdateDate = h.UpdateDate,
                        UpdateBy = h.UpdateBy,
                        CreateBy = h.CreateBy
                    })
                );

            }

            if (lBarsDetailsList.Count > 0)
            {
                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {

                    for (int i = 0; i < lBarsDetailsList.Count; i++)
                    {
                        if (lBarsDetailsList[i].BarShapeCode == "020")
                        {
                            lBarsDetailsList[i].shapeParameters = "A";
                            lBarsDetailsList[i].shapeLengthFormula = "A";
                            lBarsDetailsList[i].shapeParType = "S";
                            lBarsDetailsList[i].shapeDefaultValue = "";
                            lBarsDetailsList[i].shapeHeightCheck = "";
                            lBarsDetailsList[i].shapeAutoCalcFormula1 = "";
                            lBarsDetailsList[i].shapeAutoCalcFormula2 = "";
                            lBarsDetailsList[i].shapeAutoCalcFormula3 = "";
                        }
                        else
                        {
                            //Check same shape processed
                            var lFound = -1;
                            if (i > 0)
                            {
                                for (int j = 0; j < i; j++)
                                {
                                    if (lBarsDetailsList[j].BarShapeCode == lBarsDetailsList[i].BarShapeCode)
                                    {
                                        lFound = j;
                                        break;
                                    }
                                }
                            }
                            if (lFound >= 0)
                            {
                                lBarsDetailsList[i].shapeParameters = lBarsDetailsList[lFound].shapeParameters;
                                lBarsDetailsList[i].shapeLengthFormula = lBarsDetailsList[lFound].shapeLengthFormula;
                                lBarsDetailsList[i].shapeParType = lBarsDetailsList[lFound].shapeParType;
                                lBarsDetailsList[i].shapeDefaultValue = lBarsDetailsList[lFound].shapeDefaultValue;
                                lBarsDetailsList[i].shapeHeightCheck = lBarsDetailsList[lFound].shapeHeightCheck;
                                lBarsDetailsList[i].shapeAutoCalcFormula1 = lBarsDetailsList[lFound].shapeAutoCalcFormula1;
                                lBarsDetailsList[i].shapeAutoCalcFormula2 = lBarsDetailsList[lFound].shapeAutoCalcFormula2;
                                lBarsDetailsList[i].shapeAutoCalcFormula3 = lBarsDetailsList[lFound].shapeAutoCalcFormula3;
                            }
                            else
                            {
                                var lReturn = await getShapeInfoFunAsync(CustomerCode, ProjectCode, JobID, lBarsDetailsList[i].BarShapeCode, lNDSCon, 0);
                                if (lReturn != null)
                                {
                                    lBarsDetailsList[i].shapeParameters = lReturn.shapeParameters;
                                    lBarsDetailsList[i].shapeLengthFormula = lReturn.shapeLengthFormula;
                                    lBarsDetailsList[i].shapeParType = lReturn.shapeParType;
                                    lBarsDetailsList[i].shapeDefaultValue = lReturn.shapeDefaultValue;
                                    lBarsDetailsList[i].shapeHeightCheck = lReturn.shapeHeightCheck;
                                    lBarsDetailsList[i].shapeAutoCalcFormula1 = lReturn.shapeAutoCalcFormula1;
                                    lBarsDetailsList[i].shapeAutoCalcFormula2 = lReturn.shapeAutoCalcFormula2;
                                    lBarsDetailsList[i].shapeAutoCalcFormula3 = lReturn.shapeAutoCalcFormula3;
                                }
                            }
                        }

                        if (lBarsDetailsList[i].shapeParameters == null || lBarsDetailsList[i].shapeParameters == "")
                        {
                            var lCustomerShape = db.CustomerShape.Find(CustomerCode, ProjectCode, lBarsDetailsList[i].BarShapeCode);
                            if (lCustomerShape != null)
                            {
                                lBarsDetailsList[i].shapeParameters = lCustomerShape.shapeParameters;
                                lBarsDetailsList[i].shapeLengthFormula = lCustomerShape.shapeLengthFormula;
                                lBarsDetailsList[i].shapeParType = "";
                                lBarsDetailsList[i].shapeDefaultValue = "";
                                lBarsDetailsList[i].shapeHeightCheck = "";
                                lBarsDetailsList[i].shapeAutoCalcFormula1 = "";
                                lBarsDetailsList[i].shapeAutoCalcFormula2 = "";
                                lBarsDetailsList[i].shapeAutoCalcFormula3 = "";
                            }
                        }
                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                    lProcessObj = null;
                    lNDSCon = null;
                }
            }

            if (lBarsDetailsList.Count > 0)
            {
                for (int i = 0; i < lBarsDetailsList.Count; i++)
                {
                    lBarsDetailsList[i].BarShapeCode = lBarsDetailsList[i].BarShapeCode == null ? null : (lBarsDetailsList[i].BarShapeCode.StartsWith("0") == true ? lBarsDetailsList[i].BarShapeCode.Substring(1) : lBarsDetailsList[i].BarShapeCode);
                }
            }

            return Ok(lBarsDetailsList);
        }


        [HttpGet]
        [Route("/getShapeCodeList/{CustomerCode}/{ProjectCode}/{CouplerType}/{UserName}")]
        public ActionResult getShapeCodeList(string CustomerCode, string ProjectCode, string CouplerType, string UserName)
        {
            var lUserName = UserName;//"Vishal.Wani@natsteel.com.sg";//User.Identity.GetUserName();
            //var lCoupler = "ZZZNO";
            //    if (CouplerType == "N-Splice")
            //    {
            //        lCoupler = "N";
            //    }
            //    if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
            //    {
            //        lCoupler = "E";
            //    } 
            //var content = (from p in db.Shape
            //               where p.shapeStatus == "Active" &&
            //               ((p.shapeCategory != "E" &&
            //               p.shapeCategory != "N") ||
            //               p.shapeCategory == lCoupler )
            //               orderby p.shapeCode 
            //               select new {p.shapeCode, p.shapeCategory }).ToList();

            //return Json(content, JsonRequestBehavior.AllowGet);

            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            var lReturn = (new[]{ new
            {
                shapeCode = "",
                shapeCategory = ""
            }}).ToList();

            var lProcessObj = new ProcessController();
            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                int lFound = 0;
                lCmd.CommandText = "SELECT ShapeCode FROM OESShapeCTL " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' ";

                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    if (lRst.Read())
                    {
                        lFound = 1;
                    }
                }
                lRst.Close();

                if (lFound == 1)
                {
                    lCmd.CommandText =
                    "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                    "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C, dbo.OESShapeCTL T " +
                    "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                    "AND S.CSM_SHAPE_ID = T.ShapeCode " +
                    "AND T.CustomerCode = '" + CustomerCode + "' " +
                    "AND T.ProjectCode = '" + ProjectCode + "' " +
                    "AND CSM_ACT_INACTIVE = 1 ";
                }
                else
                {
                    var lCoupler = "ZZZNO";
                    if (CouplerType == "N-Splice")
                    {
                        lCoupler = "N";
                    }
                    if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
                    {
                        lCoupler = "E";
                    }

                    if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
                    {
                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                    }
                    else
                    {
                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSC_CAT_DESC " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }

                    }
                }

                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        string lShapeCode = lRst.GetString(0);
                        if (lShapeCode == null)
                        {
                            lShapeCode = "";
                        }
                        if (lShapeCode.Length > 0)
                        {
                            lShapeCode = lShapeCode.StartsWith("0") == true ? lShapeCode.Substring(1) : lShapeCode;
                        }
                        lReturn.Add(new
                        {
                            shapeCode = lShapeCode,
                            shapeCategory = lRst.GetString(1)
                        });
                    }
                }
                lRst.Close();

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }
            lProcessObj = null;

            lCmd = null;
            lNDSCon = null;
            lRst = null;

            if (lReturn.Count > 1)
            {
                lReturn.RemoveAt(0);
            }

            lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

            return Ok(lReturn);
        }

        [HttpGet]
        [Route("/getFormerLimitation")]
        public ActionResult getFormerLimitation()
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            var lReturn = (new[]{ new
            {
                grade = "",
                type = "",
                dia = 0,
                pin = 0,
                bend_len_min = 0,
                hook_len_min = 0,
                hook_height_min = 0
            }}).ToList();

            lCmd.CommandText =
            "SELECT grade, type, dia, pin, bend_len_min, hook_len_min, hook_height_min " +
            "FROM dbo.OESPin " +
            "WHERE grade = 'H' " +
            "ORDER BY grade, type desc, dia ";



            var lProcessObj = new ProcessController();
            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {
                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        lReturn.Add(new
                        {
                            grade = lRst.GetString(0).Trim(),
                            type = lRst.GetString(1).Trim() == "S" ? "Standard" : "Non-Standard",
                            dia = lRst.GetInt32(2),
                            pin = lRst.GetInt32(3),
                            bend_len_min = lRst.GetInt32(4),
                            hook_len_min = lRst.GetInt32(5),
                            hook_height_min = lRst.GetInt32(6)
                        });
                    }
                }
                lRst.Close();

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }
            lProcessObj = null;
            lCmd = null;
            lNDSCon = null;
            lRst = null;

            if (lReturn.Count > 1)
            {
                lReturn.RemoveAt(0);
            }

            return Json(lReturn);
        }

        //getShapeImagesByCat
        [HttpGet]
        [Route("/getShapeImagesByCat/{CustomerCode}/{ProjectCode}/{ShapeCategory}/{CouplerType}/{UserName}")]
        public ActionResult getShapeImagesByCat(string CustomerCode, string ProjectCode, string ShapeCategory, string CouplerType, string UserName)
        {
            var lUserName = UserName;//"Vishal.Wani@natsteel.com.sg";
            //if (ShapeCategory != null)
            //{
            //    var lCoupler = ShapeCategory.Trim();
            //    if (lCoupler == "E-Splice")
            //    {
            //        lCoupler = "E";
            //    }
            //    if (lCoupler == "N-Splice")
            //    {
            //        lCoupler = "N";
            //    }

            //    var content = (from p in db.Shape
            //                   where p.shapeCategory == lCoupler 
            //                   orderby p.shapeCode
            //                   select new {p.shapeCode, p.shapeImage }
            //                   ).ToList();
            //    return Json(content, JsonRequestBehavior.AllowGet);
            //}
            //else
            //{
            //    return Json("", JsonRequestBehavior.AllowGet);
            //}
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            var lReturn = (new[]{ new
            {
                shapeCode = "",
                shapeImage = new byte[]{ }
            }}).ToList();

            var lShapes = (new[]{ new
            {
                shapeCode = "",
                shapeImage = new byte[]{ }
            }}).ToList();

            var lCoupler = "ZZZNO";
            if (CouplerType == "N-Splice")
            {
                lCoupler = "N";
            }
            if (CouplerType == "E-Splice(N)" || CouplerType == "E-Splice(S)")
            {
                lCoupler = "E";
            }
            var lProcessObj = new ProcessController();
            if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
            {

                if (lUserName.Split('@').Length == 2 && lUserName.Split('@')[1].ToLower().Trim() == "natsteel.com.sg")
                {
                    if (ShapeCategory == "N-Splice Coupler")
                    {
                        lCmd.CommandText =
                        "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                        "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                        "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                        "AND CSM_ACT_INACTIVE = 1 " +
                        "AND (CSM_SHAPE_ID LIKE 'H%' " +
                        "OR CSM_SHAPE_ID LIKE 'I%' " +
                        "OR CSM_SHAPE_ID LIKE 'J%' " +
                        "OR CSM_SHAPE_ID LIKE 'K%') " +
                        "ORDER BY CSM_SHAPE_ID ";
                    }
                    else if (ShapeCategory == "E-Splice Coupler")
                    {
                        lCmd.CommandText =
                        "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                        "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                        "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                        "AND CSM_ACT_INACTIVE = 1 " +
                        "AND (CSM_SHAPE_ID LIKE 'C%' " +
                        "OR CSM_SHAPE_ID LIKE 'P%' " +
                        "OR CSM_SHAPE_ID LIKE 'N%' " +
                        "OR CSM_SHAPE_ID LIKE 'S%') " +
                        "ORDER BY CSM_SHAPE_ID ";
                    }
                    else if (ShapeCategory == "Most Common Shapes")
                    {
                        var lProject = "0000000000";
                        var lCount = 0;
                        lCmd.CommandText =
                        "SELECT COUNT(*) FROM OESTopShape WHERE ProjectCode = '" + ProjectCode + "' ";
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lCount = lRst.GetInt32(0);
                            }
                        }
                        lRst.Close();

                        if (lCount > 0)
                        {
                            lProject = ProjectCode;
                        }

                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                    }
                    else
                    {
                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                    }
                }
                else
                {
                    if (ShapeCategory == "N-Splice Coupler")
                    {
                        lCmd.CommandText =
                        "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                        "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                        "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                        "AND CSM_ACT_INACTIVE = 1 " +
                        "AND (CSM_SHAPE_ID LIKE 'H%' " +
                        "OR CSM_SHAPE_ID LIKE 'I%' " +
                        "OR CSM_SHAPE_ID LIKE 'J%' " +
                        "OR CSM_SHAPE_ID LIKE 'K%') " +
                        "ORDER BY CSM_SHAPE_ID ";
                    }
                    else if (ShapeCategory == "E-Splice Coupler")
                    {
                        lCmd.CommandText =
                        "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                        "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                        "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                        "AND CSM_ACT_INACTIVE = 1 " +
                        "AND (CSM_SHAPE_ID LIKE 'C%' " +
                        "OR CSM_SHAPE_ID LIKE 'P%' " +
                        "OR CSM_SHAPE_ID LIKE 'N%' " +
                        "OR CSM_SHAPE_ID LIKE 'S%') " +
                        "ORDER BY CSM_SHAPE_ID ";
                    }
                    else if (ShapeCategory == "Most Common Shapes")
                    {
                        var lProject = "0000000000";
                        var lCount = 0;
                        lCmd.CommandText =
                        "SELECT COUNT(*) FROM OESTopShape WHERE ProjectCode = '" + ProjectCode + "' ";
                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lCount = lRst.GetInt32(0);
                            }
                        }
                        lRst.Close();

                        if (lCount > 0)
                        {
                            lProject = ProjectCode;
                        }

                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.OESTopShape C " +
                            "WHERE C.ShapeCode = S.CSM_SHAPE_ID " +
                            "AND ProjectCode = '" + lProject + "' " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                    }
                    else
                    {
                        if (lCoupler == "N")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else if (lCoupler == "E")
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                        else
                        {
                            lCmd.CommandText =
                            "SELECT CSM_SHAPE_ID, CSM_SHAPE_IMAGE " +
                            "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                            "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                            "AND CSM_ACT_INACTIVE = 1 " +
                            "AND CSM_SHAPE_ID NOT LIKE '$%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'H%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'I%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'J%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'K%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L1%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L2%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L5%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L6%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L7%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'C%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'P%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'N%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'S%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L3%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'L4%' " +
                            "AND CSM_SHAPE_ID NOT LIKE 'Y%' " +
                            "AND (CSC_CAT_DESC = '" + ShapeCategory + "' " +
                            "OR 'All Shapes' = '" + ShapeCategory + "') " +
                            "ORDER BY CSM_SHAPE_ID ";
                        }
                    }

                }
                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    while (lRst.Read())
                    {
                        string lShapeCode = lRst.GetString(0);
                        if (lShapeCode == null)
                        {
                            lShapeCode = "";
                        }
                        if (lShapeCode.Length > 0)
                        {
                            lShapeCode = lShapeCode.StartsWith("0") == true ? lShapeCode.Substring(1) : lShapeCode;
                        }

                        byte[] lShapeImage = (byte[])lRst.GetValue(1);

                        lShapes.Add(new
                        {
                            shapeCode = lShapeCode,
                            shapeImage = lShapeImage

                        });
                    }
                }
                lRst.Close();

                if (lShapes.Count > 1)
                {
                    for (int i = 1; i < lShapes.Count; i++)
                    {
                        System.Drawing.Image image = System.Drawing.Image.FromStream(new MemoryStream(lShapes[i].shapeImage));
                        System.Drawing.Bitmap bmp = ConvertToRGB((System.Drawing.Bitmap)image);

                        lCmd.CommandText =
                        "SELECT INTPARAMSEQ, " +
                        "LTRIM(RTRIM(CHRPARAMNAME)), " +
                        "CASE " +
                        "WHEN INTXCOORD IS NULL THEN 0 " +
                        "ELSE INTXCOORD " +
                        "END AS INTXCOORD, " +
                        "CASE " +
                        "WHEN INTYCOORD IS NULL THEN 0 " +
                        "ELSE INTYCOORD " +
                        "END AS INTYCOORD, " +
                        "CASE " +
                        "WHEN INTZCOORD IS NULL THEN 0 " +
                        "ELSE INTZCOORD " +
                        "END AS INTZCOORD " +
                        "FROM dbo.T_CAB_SHAPE_DTLS C, " +
                        "dbo.shapeparamdetails_cube P, " +
                        "dbo.shapemaster_cube M " +
                        "WHERE C.CSD_SHAPE_ID = M.chrShapeCode " +
                        "AND M.intShapeID = P.intShapeID " +
                        "AND C.CSD_SEQ_NO = P.intParamSeq " +
                        "AND CSD_SHAPE_ID = '" + lShapes[i].shapeCode + "' " +
                        "AND bitVISIBLE = 1 " +
                        "AND chrAngleType <> 'E' " +
                        "AND chrAngleType <> 'N' " +
                        "AND chrAngleType <> 'EL' " +
                        "ORDER BY CHRPARAMNAME ";
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            while (lRst.Read())
                            {
                                int lSeq = lRst.GetInt32(0);
                                string lParam = lRst.GetString(1).Trim();
                                int lTextX = lRst.GetInt32(2);
                                int lTextY = lRst.GetInt32(3);

                                System.Drawing.Graphics g = System.Drawing.Graphics.FromImage(bmp);
                                g.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
                                g.DrawString(lParam, new System.Drawing.Font("Areal Black", 12f, System.Drawing.FontStyle.Bold), System.Drawing.Brushes.Black, new System.Drawing.Point(lTextX + 4, lTextY + 4));
                                g.Save();
                                g.Dispose();
                            }
                        }
                        lRst.Close();

                        System.Drawing.Image lThumbnail = bmp.GetThumbnailImage(100, 100, new System.Drawing.Image.GetThumbnailImageAbort(ThumbnailCallback), IntPtr.Zero);

                        MemoryStream lMS = new MemoryStream();
                        lThumbnail.Save(lMS, System.Drawing.Imaging.ImageFormat.Png);
                        byte[] byteArr = lMS.ToArray();

                        lReturn.Add(new
                        {
                            shapeCode = lShapes[i].shapeCode,
                            shapeImage = byteArr

                        });

                        //lReturn.Add(new
                        //{
                        //    shapeCode = lShapes[i].shapeCode,
                        //    shapeImage = lShapes[i].shapeImage

                        //});

                    }

                }


                lShapes = null;

                if (lReturn.Count == 1)
                {
                    lCmd.CommandText =
                    "SELECT shapeCode, shapeImage " +
                    "FROM dbo.OESCustomShapes " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND shapeCategory = '" + ShapeCategory + "' " +
                    "ORDER BY shapeCode ";

                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            lReturn.Add(new
                            {
                                shapeCode = lRst.GetString(0),
                                shapeImage = (byte[])lRst.GetValue(1)
                            });
                        }
                    }
                    lRst.Close();
                }

                lProcessObj.CloseNDSConnection(ref lNDSCon);
            }
            lProcessObj = null;

            lCmd = null;
            lNDSCon = null;
            lRst = null;

            if (lReturn.Count > 1)
            {
                lReturn.RemoveAt(0);
            }

            //lReturn = lReturn.OrderBy(o => o.shapeCode).ToList();

            return Ok(lReturn);
            //return Json(lReturn, JsonRequestBehavior.AllowGet);

        }


        [HttpPost]
        [Route("/DeleteOrderPE/{pCustomerCode}/{pProjectCode}/{pOrderNo}/{pStructureElement}/{pProductType}/{pScheduledProd}")]
        public ActionResult DeleteOrderPE(string pCustomerCode, string pProjectCode, int pOrderNo, string pStructureElement, string pProductType, string pScheduledProd)
        {
            bool lReturn = true;
            string lResponseText = "";
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lSQL = "";

            try
            {
                //string lUserID = User.Identity.GetUserName();
                //UserAccessController lUa = new UserAccessController();
                //var lUserType = lUa.getUserType(lUserID);
                //var lGroupName = lUa.getGroupName(lUserID);

                //var lSubmission = "No";
                //var lEditable = "No";

                ////string lUserName = lUserID;
                ////if (lUserName.IndexOf("@") > 0)
                ////{
                ////    lUserName = lUserName.Substring(0, lUserName.IndexOf("@"));
                ////}


                //string lUserName = "Vishal.Wani@natsteel.com.sg"

                //lUa = null;

                ////get Access right;
                //if (lUserType == "CU" || lUserType == "CA" || lUserType == "CM")
                //{
                //    var lAccess = db.UserAccess.Find(lUserID, pCustomerCode, pProjectCode);
                //    if (lAccess != null)
                //    {
                //        lSubmission = lAccess.OrderSubmission.Trim();
                //        lEditable = lAccess.OrderCreation.Trim();
                //    }
                //}
                //else
                //{
                //    if (lUserType == "TE" || lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU")
                //    {
                //        lSubmission = "Yes";
                //        lEditable = "Yes";
                //    }
                //}

                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) != true)
                {
                    lReturn = false;
                }

                if (lReturn == true)
                {
                    var lSE = db.OrderProjectSE.Find(pOrderNo, pStructureElement, pProductType, pScheduledProd);

                    if (lSE.OrderStatus != "Created" && lSE.OrderStatus != "New")
                    {
                        lResponseText = "You cannot delete the order item as its status is not <Created>";
                        lReturn = false;
                    }

                    if (lSE.CABJobID > 0)
                    {
                        int lJobID = lSE.CABJobID;

                        lSQL = "DELETE FROM dbo.OESOrderDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESBBS " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESJobAdvice " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();
                    }
                    if (lSE.MESHJobID > 0)
                    {
                        int lJobID = lSE.MESHJobID;

                        lSQL = "DELETE FROM dbo.OESCTSMESHBeamDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESCTSMESHColumnDetails" +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESCTSMESHOthersDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESCTSMESHBBS " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESCTSMESHJobAdvice " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();
                    }
                    if (lSE.BPCJobID > 0)
                    {
                        int lJobID = lSE.BPCJobID;

                        lSQL = "DELETE FROM dbo.OESBPCLoad " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESBPCCageBars " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESBPCDetailsProc " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESBPCDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESBPCJobAdvice " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();
                    }
                    if (lSE.CageJobID > 0)
                    {
                        int lJobID = lSE.CageJobID;

                        lSQL = "DELETE FROM dbo.OESPRCBeamMESHDetails " +
                        "WHERE CustomerCode = '" + pCustomerCode + "' " +
                        "AND ProjectCode = '" + pProjectCode + "' " +
                        "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESPRCColumnMESHDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESPRCCTSMESHDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESPRCCABDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESPRCBBS " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESPRCJobAdvice " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                    }

                    if (lSE.StdBarsJobID > 0 || lSE.StdMESHJobID > 0 || lSE.CoilProdJobID > 0)
                    {
                        int lJobID = 0;
                        if (lSE.StdBarsJobID > 0)
                        {
                            lJobID = lSE.StdBarsJobID;
                        }
                        if (lSE.StdMESHJobID > 0)
                        {
                            lJobID = lSE.StdMESHJobID;
                        }
                        if (lSE.CoilProdJobID > 0)
                        {
                            lJobID = lSE.CoilProdJobID;
                        }

                        lSQL = "DELETE FROM dbo.OESStdProdDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESStdSheetDetails " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "'" +
                            "AND Template = 0 " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE FROM dbo.OESStdSheetJobAdvice " +
                            "WHERE CustomerCode = '" + pCustomerCode + "' " +
                            "AND ProjectCode = '" + pProjectCode + "' " +
                            "AND JobID = " + lJobID.ToString() + " ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();


                    }

                    db.OrderProjectSE.Remove(lSE);
                    db.SaveChanges();

                    decimal lWT = (decimal)(from p in db.OrderProjectSE
                                            where p.OrderNumber == pOrderNo &&
                                            p.OrderStatus != "Cancelled"
                                            select p.TotalWeight)
                               .DefaultIfEmpty(0)
                               .Sum();

                    var lHeader = db.OrderProject.Find(pOrderNo);
                    if (lHeader != null && lHeader.OrderNumber > 0)
                    {
                        var lHeaderNew = lHeader;
                        lHeaderNew.TotalWeight = lWT;
                        db.Entry(lHeader).CurrentValues.SetValues(lHeaderNew);
                        db.SaveChanges();
                    }

                }

                lProcessObj.CloseNDSConnection(ref lNDSCon);

                lProcessObj = null;
            }
            catch (Exception ex)
            {
                lReturn = false;
                lResponseText = "Error:" + ex.Message;
            }

            return Ok(lReturn);

        }

        // POST: Customer/deleteBBS/
        [HttpGet]
        [Route("/deleteBBS/{CustomerCode}/{ProjectCode}/{JobID}/{BBSID}/{BarsCount}/{UpdateBy}")]
        public ActionResult deleteBBS(string CustomerCode, string ProjectCode, int JobID, int BBSID, int BarsCount, string UpdateBy)
        {
            bool lSuccess = true;
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lErrorMsg = "";
            string lSQL = "";

            try
            {
                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    var lStatus = "";

                    lSQL = "SELECT isNull(OrderStatus,'') " +
                    "FROM dbo.OESJobAdvice " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID = " + JobID.ToString() + " ";

                    lCmd.Connection = lNDSCon;
                    lCmd.CommandText = lSQL;
                    lCmd.CommandTimeout = 1200;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        lRst.Read();
                        lStatus = lRst.GetString(0);
                    }
                    lRst.Close();

                    if (lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
                    {
                        string lUpdatedBy = "";
                        lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
                        "FROM dbo.OESOrderDetails " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " " +
                        "AND UpdateDate >= DateAdd(ss,-60,getDate()) " +
                        "AND UpdateBy <> '" + UpdateBy + "' ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandText = lSQL;
                        lCmd.CommandTimeout = 1200;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            lRst.Read();
                            lUpdatedBy = lRst.GetString(0).Trim();
                        }
                        lRst.Close();

                        if (lUpdatedBy != "")
                        {
                            lSuccess = false;
                            lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
                            return Ok(new { success = lSuccess, ErrorMessage = lErrorMsg });
                        }

                        var oldOrderDetails = from p in db.OrderDetails
                                              where p.CustomerCode == CustomerCode &&
                                              p.ProjectCode == ProjectCode &&
                                              p.JobID == JobID &&
                                              p.BBSID == BBSID
                                              select p;

                        if (oldOrderDetails != null)
                        {
                            db.OrderDetails.RemoveRange(oldOrderDetails);
                        }
                        var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
                        if (oldBBS != null)
                        {
                            db.BBS.Remove(oldBBS);
                        }
                        db.SaveChanges();

                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }
                lProcessObj = null;

            }
            catch (Exception ex)
            {
                lSuccess = false;
                lErrorMsg = ex.Message;
            }
            return Ok(new { success = lSuccess, ErrorMessage = lErrorMsg });

        }


        //[HttpGet]
        //[Route("/getProject_Orders/{CustomerCode}")]
        //public ActionResult getProject(string CustomerCode, string UserName)
        //{
        //    string lUserType = "";
        //    string lGroupName = "";

        //    OracleDataReader lRst;
        //    var lCmd = new OracleCommand();
        //    var lcisCon = new OracleConnection();



        //    if (gUserType != null && gUserType != "" && gGroupName != null && gGroupName != "")
        //    {
        //        lUserType = gUserType;
        //        lGroupName = gGroupName;
        //    }
        //    else
        //    {
        //        UserAccessController lUa = new UserAccessController();
        //        lUserType = lUa.getUserType(UserName);//"AD";
        //        lGroupName = lUa.getGroupName(UserName);// "jagdishh_ttl@natsteel.com.sg";//
        //        gUserType = lUserType;
        //        gGroupName = lGroupName;
        //        lUa = null;
        //    }

        //    List<ProjectListModels> content = new List<ProjectListModels> {
        //        new ProjectListModels
        //        {
        //            CustomerCode = "",
        //            ProjectCode = "",
        //            ProjectTitle = ""
        //        } };

        //    if (lUserType == "PL" || lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU" || lUserType == "TE")
        //    {
        //        //content = (from p in db.ProjectList
        //        //           where p.CustomerCode == CustomerCode &&
        //        //           (from m in db.Project
        //        //            where m.CustomerCode == CustomerCode
        //        //            select m.ProjectCode).Contains(p.ProjectCode)
        //        //           orderby p.ProjectTitle
        //        //           select p).ToList();

        //        // try the sql.
        //        //content = db.Database.SqlQuery<ProjectListModels>(
        //        //    "SELECT * FROM OESProjectList P " +
        //        //    "WHERE P.CustomerCode = @cust " +
        //        //    "ORDER BY ProjectTitle ", new SqlParameter("cust", CustomerCode)).ToList();

        //        //if (content.Count() > 0)
        //        //{
        //        //    content = RemoveNonCABProject_Oracle(content);
        //        //}

        //        content = new List<ProjectListModels>();

        //        if (lUserType == "AD" || lUserType == "PM" || lUserType == "PA" || lUserType == "P1" || lUserType == "P2" || lUserType == "PU" || lUserType == "TE")
        //        {
        //            #region Get from SAP
        //            var lDa = new OracleDataAdapter();
        //            var lOCmd = new OracleCommand();
        //            var lDs = new DataSet();
        //            var lDStatus = new DataSet();
        //            var lOcisCon = new OracleConnection();
        //            var lProcess = new ProcessController();

        //            lOCmd.CommandText = "SELECT (NAME1 || NAME2) AS SHIP_TO_NAME,KUNNR AS SHIP_TO_PARTY FROM SAPSR3.KNA1 " +
        //            "WHERE KTOKD = 'Y001' AND MANDT ='" + lProcess.strClient + "' " +
        //            "AND KUNNR IN (SELECT KUNNR FROM SAPSR3.VBPA WHERE MANDT='" + lProcess.strClient + "' " +
        //            "AND VBELN IN (SELECT VBELN FROM SAPSR3.VBAK WHERE MANDT ='" + lProcess.strClient + "' " +
        //            "AND (VBELN like '102%' OR VBELN like '_102%') " +
        //            "AND (ytot_cab > 0 " +
        //            "OR ytot_rebar > 0) " +
        //            "AND KUNNR ='" + CustomerCode + "' AND TRVOG ='4' " +
        //            "AND to_date(GUEEN, 'yyyymmdd') >=  (SYSDATE - 180) )) " +
        //            "ORDER BY 1 ";

        //            if (lProcess.OpenCISConnection(ref lOcisCon) == true)
        //            {
        //                lOCmd.Connection = lOcisCon;
        //                lDa.SelectCommand = lOCmd;
        //                lDs.Clear();
        //                lDa.Fill(lDs);
        //                if (lDs.Tables[0].Rows.Count > 0)
        //                    for (int i = 0; i < lDs.Tables[0].Rows.Count; i++)
        //                    {
        //                        string lName = ((string)lDs.Tables[0].Rows[i].ItemArray[0]).Trim();
        //                        string lCode = ((string)lDs.Tables[0].Rows[i].ItemArray[1]).Trim();
        //                        content.Add(new ProjectListModels
        //                        {
        //                            CustomerCode = CustomerCode,
        //                            ProjectCode = lCode,
        //                            ProjectTitle = lName
        //                        });
        //                    }
        //                lProcess.CloseCISConnection(ref lOcisCon);
        //            }
        //            lDa = null;
        //            lOCmd = null;
        //            lDs = null;
        //            lDStatus = null;
        //            lOcisCon = null;
        //            lProcess = null;
        //            #endregion
        //        }
        //        else
        //        {
        //            #region Get from NDS
        //            var lDa = new SqlDataAdapter();
        //            var lOCmd = new SqlCommand();
        //            var lDs = new DataSet();
        //            var lDStatus = new DataSet();
        //            var lOcisCon = new SqlConnection();
        //            var lProcess = new ProcessController();

        //            lOCmd.CommandText = "SELECT P.vchProjectCode, P.vchProjectName " +
        //            "FROM dbo.ProjectMaster P, " +
        //            "dbo.ContractMaster C, " +
        //            "dbo.CustomerMaster A, " +
        //            "dbo.ContractProductMapping M " +
        //            "WHERE P.intContractID = C.intContractID " +
        //            "AND A.intCustomerCode = C.intCustomerCode " +
        //            "AND C.vchContractNumber = M.VBELN " +
        //            "AND M.mandt = '" + lProcess.strClient + "' " +
        //            "AND(ytot_cab > 0 " +
        //            "OR ytot_rebar > 0) " +
        //            "AND datEndDate > DATEADD(dd, -180, getDate()) " +
        //            "AND vchCustomerNo = '" + CustomerCode + "' " +
        //            "GROUP BY P.vchProjectCode, P.vchProjectName " +
        //            "ORDER BY P.vchProjectName ";

        //            if (lProcess.OpenNDSConnection(ref lOcisCon) == true)
        //            {
        //                lOCmd.Connection = lOcisCon;
        //                lDa.SelectCommand = lOCmd;
        //                lDs.Clear();
        //                lDa.Fill(lDs);
        //                if (lDs.Tables[0].Rows.Count > 0)
        //                    for (int i = 0; i < lDs.Tables[0].Rows.Count; i++)
        //                    {
        //                        string lCode = ((string)lDs.Tables[0].Rows[i].ItemArray[0]).Trim();
        //                        string lName = ((string)lDs.Tables[0].Rows[i].ItemArray[1]).Trim();
        //                        content.Add(new ProjectListModels
        //                        {
        //                            CustomerCode = CustomerCode,
        //                            ProjectCode = lCode,
        //                            ProjectTitle = lName
        //                        });
        //                    }
        //                lProcess.CloseNDSConnection(ref lOcisCon);
        //            }
        //            lDa = null;
        //            lOCmd = null;
        //            lDs = null;
        //            lDStatus = null;
        //            lOcisCon = null;
        //            lProcess = null;
        //            #endregion
        //        }
        //    }
        //    else
        //    {
        //        content = (from p in db.ProjectList
        //                   where p.CustomerCode == CustomerCode &&
        //                   (from u in db.UserAccess
        //                    where u.UserName == lGroupName &&
        //                    u.CustomerCode == CustomerCode
        //                    select u.ProjectCode).Contains(p.ProjectCode)
        //                   orderby p.ProjectTitle
        //                   select p).ToList();

        //        if (content.Count() > 0)
        //        {
        //            content = RemoveNonCABProject(content);
        //        }

        //    }


        //    if (content.Count() == 0)
        //    {
        //        content = new List<ProjectListModels> {
        //                new ProjectListModels
        //                {
        //                    CustomerCode = "",
        //                    ProjectCode = "",
        //                    ProjectTitle = ""
        //                }
        //            };
        //    }

        //    return Ok(content);
        //}


        List<ProjectListModels> RemoveNonCABProject(List<ProjectListModels> pInputProj)
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            if (pInputProj.Count() > 0)
            {
                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    for (int i = pInputProj.Count() - 1; i >= 0; i--)
                    {
                        lCmd.CommandText =
                        "SELECT isNull(ProjectCAB,0) " +
                        "from dbo.OESProject " +
                        "WHERE CustomerCode = '" + pInputProj[i].CustomerCode + "' " +
                        "AND ProjectCode = '" + pInputProj[i].ProjectCode + "' " +
                        "AND ProjectCAB = 1 ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 1200;
                        lRst = lCmd.ExecuteReader();
                        if (!lRst.HasRows)
                        {
                            pInputProj.RemoveAt(i);
                        }
                        lRst.Close();
                    }
                }

                lProcessObj.CloseNDSConnection(ref lNDSCon);
                lCmd = null;
                lRst = null;
                lProcessObj = null;
            }

            return pInputProj;
        }

        [HttpPost]
        [Route("/copyBBS")]
        public ActionResult copyBBS([FromBody] CopyBBSDtocs copyBBSDtocs)
        {
            try
            {
                //Delete destination record
                for (var i = 1; i <= copyBBSDtocs.DesBarCount; i++)
                {
                    var oldOrderDetails = db.OrderDetails.Find(copyBBSDtocs.DesCustomerCode, copyBBSDtocs.DesProjectCode, copyBBSDtocs.DesOrderNo, copyBBSDtocs.DesBBSID, i);
                    if (oldOrderDetails != null)
                    {
                        db.OrderDetails.Remove(oldOrderDetails);
                    }
                }
                db.SaveChanges();

                // update BBS
                var lBBSSource = db.BBS.Find(copyBBSDtocs.SourceCustomerCode, copyBBSDtocs.SourceProjectCode, copyBBSDtocs.SourceOrderNo, copyBBSDtocs.SourceBBSID);

                var lBBSContent = db.BBS.Find(copyBBSDtocs.DesCustomerCode, copyBBSDtocs.DesProjectCode, copyBBSDtocs.DesOrderNo, copyBBSDtocs.DesBBSID);
                var BBSContentNew = lBBSContent;
                BBSContentNew.BBSCopiedFrom = copyBBSDtocs.SourceCustomerCode + "," + copyBBSDtocs.SourceProjectCode + "," + copyBBSDtocs.SourceOrderNo + "," + lBBSSource.BBSNo;
                BBSContentNew.BBSOrderCABWT = lBBSSource.BBSOrderCABWT;
                BBSContentNew.BBSOrderSTDWT = lBBSSource.BBSOrderSTDWT;
                BBSContentNew.BBSCancelledWT = lBBSSource.BBSCancelledWT;
                BBSContentNew.BBSTotalWT = lBBSSource.BBSTotalWT;
                BBSContentNew.UpdateDate = DateTime.Now;
                BBSContentNew.UpdateBy = copyBBSDtocs.UpdateBy;//User.Identity.GetUserName();

                db.Entry(lBBSContent).CurrentValues.SetValues(BBSContentNew);

                //copy bars details;
                var lBarsSource = (from p in db.OrderDetails
                                   where p.CustomerCode == copyBBSDtocs.SourceCustomerCode &&
                                   p.ProjectCode == copyBBSDtocs.SourceProjectCode &&
                                   p.JobID == copyBBSDtocs.SourceOrderNo &&
                                   p.BBSID == copyBBSDtocs.SourceBBSID
                                   select p).ToList();

                lBarsSource = new List<OrderDetailsModels>
                    (lBarsSource.Select(h => new OrderDetailsModels
                    {
                        CustomerCode = copyBBSDtocs.DesCustomerCode,
                        ProjectCode = copyBBSDtocs.DesProjectCode,
                        JobID = copyBBSDtocs.DesOrderNo,
                        BBSID = copyBBSDtocs.DesBBSID,
                        BarID = h.BarID,
                        BarSort = h.BarSort,
                        Cancelled = h.Cancelled,
                        BarCAB = h.BarCAB,
                        BarSTD = h.BarSTD,
                        ElementMark = h.ElementMark,
                        BarMark = h.BarMark,
                        BarType = h.BarType,
                        BarSize = h.BarSize,
                        BarMemberQty = h.BarMemberQty,
                        BarEachQty = h.BarEachQty,
                        BarTotalQty = h.BarTotalQty,
                        BarShapeCode = h.BarShapeCode,
                        A = h.A,
                        B = h.B,
                        C = h.C,
                        D = h.D,
                        E = h.E,
                        F = h.F,
                        G = h.G,
                        H = h.H,
                        I = h.I,
                        J = h.J,
                        K = h.K,
                        L = h.L,
                        M = h.M,
                        N = h.N,
                        O = h.O,
                        P = h.P,
                        Q = h.Q,
                        R = h.R,
                        S = h.S,
                        T = h.T,
                        U = h.U,
                        V = h.V,
                        W = h.W,
                        X = h.X,
                        Y = h.Y,
                        Z = h.Z,
                        A2 = h.A2,
                        B2 = h.B2,
                        C2 = h.C2,
                        D2 = h.D2,
                        E2 = h.E2,
                        F2 = h.F2,
                        G2 = h.G2,
                        H2 = h.H2,
                        I2 = h.I2,
                        J2 = h.J2,
                        K2 = h.K2,
                        L2 = h.L2,
                        M2 = h.M2,
                        N2 = h.N2,
                        O2 = h.O2,
                        P2 = h.P2,
                        Q2 = h.Q2,
                        R2 = h.R2,
                        S2 = h.S2,
                        T2 = h.T2,
                        U2 = h.U2,
                        V2 = h.V2,
                        W2 = h.W2,
                        X2 = h.X2,
                        Y2 = h.Y2,
                        Z2 = h.Z2,
                        BarLength = h.BarLength,
                        BarLength2 = h.BarLength2,
                        BarWeight = h.BarWeight,
                        Remarks = h.Remarks,
                        shapeTransport = h.shapeTransport,
                        PinSize = h.PinSize,
                        UpdateDate = DateTime.Now,
                        UpdateBy = copyBBSDtocs.UpdateBy,//User.Identity.GetUserName(),
                        CreateDate = DateTime.Now,
                        CreateBy = copyBBSDtocs.UpdateBy//User.Identity.GetUserName()
                    })).ToList();

                if (lBarsSource.Count() > 0)
                {
                    foreach (OrderDetailsModels fNewItem in lBarsSource)
                    {
                        db.OrderDetails.Add(fNewItem);
                    }
                }
                db.SaveChanges();
            }
            catch (Exception e)
            {
                var lError = e.Message;
                return Json(false);
            }
            return Json(true);
        }

        [HttpGet]
        [Route("/ORderDetailCustomer/{appCustomerCode}/{UserName}")]
        public ActionResult ORderDetailCustomer(string appCustomerCode, string UserName)
        {
            UserAccessController lUa = new UserAccessController();
            var lUserType = lUa.getUserType(UserName);
            var lGroupName = lUa.getGroupName(UserName);

            ViewBag.UserType = lUserType;

            string lUserName = UserName;

            //if (lUserName.IndexOf("@") > 0)
            //{
            //    lUserName = lUserName.Substring(0, lUserName.IndexOf("@"));
            //}

            ViewBag.UserName = lUserName;

            lUa = null;

            var lStransportMode = "";

            CustomerModels lCustomerModel = db.Customer.Find(appCustomerCode);

            var CustomerSelection = new SelectList(new List<SelectListItem>
            { new SelectListItem
            {
                Value = appCustomerCode,
                Text = lCustomerModel == null? "":lCustomerModel.CustomerName
            }
            }, "Value", "Text");



            return Ok(CustomerSelection);
        }

        //[HttpPost]
        //[Route("/ExcelImport/{appCustomerCode}")]
        //public async Task<ActionResult> ExcelImport(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        //{
        //    try
        //    {
        //        string lUserType = "";
        //        if (gUserType != null && gUserType != "")
        //        {
        //            lUserType = gUserType;
        //        }
        //        else
        //        {
        //            UserAccessController lUa = new UserAccessController();
        //            lUserType = lUa.getUserType(User.Identity.GetUserName());
        //            ViewBag.UserType = lUserType;
        //            lUa = null;
        //        }

        //        HttpPostedFileBase file = Request.Files["ExcelImport"];

        //        if (file.ContentLength > 0 && (Path.GetExtension(file.FileName) == ".xlsx" || Path.GetExtension(file.FileName) == ".xlsm"))
        //        {
        //            MemoryStream lStream = new MemoryStream();
        //            file.InputStream.CopyTo(lStream);
        //            ExcelPackage package = new ExcelPackage(lStream);

        //            ExcelWorksheet workSheet = package.Workbook.Worksheets.FirstOrDefault(f => f.View.TabSelected);
        //            DataTable lDataTable = new DataTable();

        //            if (Path.GetExtension(file.FileName) == ".xlsx" || Path.GetExtension(file.FileName) == ".xlsm")
        //            {
        //                if (package.Workbook.Worksheets.Count > 1)
        //                {
        //                    int lFound = 0;
        //                    int lCount = 0;

        //                    for (int i = 1; i <= package.Workbook.Worksheets.Count; i++)
        //                    {
        //                        if (package.Workbook.Worksheets[i].Name == "OrderSummary")
        //                        {
        //                            for (int j = 1; j < package.Workbook.Worksheets.Count; j++)
        //                            {
        //                                string lBBS = "";
        //                                if (package.Workbook.Worksheets[i].Dimension.End.Row >= 18 + j
        //                                    && package.Workbook.Worksheets[i].Dimension.End.Column >= 2
        //                                    && package.Workbook.Worksheets[i].Cells[18 + j, 2].Value != null)
        //                                {
        //                                    lBBS = package.Workbook.Worksheets[i].Cells[18 + j, 2].Value.ToString();
        //                                }
        //                                if (lBBS != null && lBBS != "" && package.Workbook.Worksheets["OrderDetail-" + lBBS] != null)
        //                                {
        //                                    workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBS];
        //                                    lCount = lCount + 1;
        //                                    lFound = 1;
        //                                }

        //                            }
        //                            break;
        //                        }

        //                    }
        //                    if (lCount > 1)
        //                    {
        //                        lFound = 0;
        //                        var lBBSCon = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
        //                        if (lBBSCon != null)
        //                        {
        //                            if (package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()] != null)
        //                            {
        //                                workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()];
        //                                lFound = 1;
        //                            }
        //                        }

        //                        if (lFound == 0)
        //                        {
        //                            return Ok(new { success = false, error = true, message = "Cannot find the BBS " + lBBSCon.BBSNo.Trim() });
        //                        }
        //                    }
        //                    if (lFound == 1)
        //                    {
        //                        workSheet.DeleteRow(1, 6);
        //                        if (workSheet.Dimension.End.Column >= 27)
        //                        {
        //                            workSheet.DeleteColumn(27, 1);
        //                        }
        //                    }
        //                }
        //            }

        //            var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, BBSID, workSheet);

        //            if (lRtn == true)
        //            {
        //                var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
        //                if (oldBBS != null)
        //                {
        //                    var lNewBBS = oldBBS;

        //                    lNewBBS.BBSCopiedFrom = "IMPORTED";

        //                    db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
        //                    db.SaveChanges();

        //                    checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);
        //                }
        //            }
        //            return Ok(new { success = true });
        //        }
        //        else
        //        {
        //            return Ok(new { success = false, error = true, message = "Invalid Excel file." });
        //        }
        //    }
        //    catch (Exception ex)
        //    {
        //        ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
        //        return Ok(new { success = false, error = true, message = "Import Error: " + ex.Message });
        //    }
        //}


        [HttpPost("ExcelImport")]
        public async Task<ActionResult> ExcelImport([FromForm] IFormFile excelImport, string CustomerCode, string ProjectCode, int JobID, int BBSID, string UserName)
        {
            try
            {
                string lUserType = "";

                if (gUserType != null && gUserType != "")
                {
                    lUserType = gUserType;
                }
                else
                {
                    UserAccessController lUa = new UserAccessController();
                    lUserType = lUa.getUserType(UserName);
                    ViewBag.UserType = lUserType;
                    lUa = null;
                }

                if (excelImport != null && (Path.GetExtension(excelImport.FileName) == ".xlsx" || Path.GetExtension(excelImport.FileName) == ".xlsm"))
                {
                    using (MemoryStream lStream = new MemoryStream())
                    {
                        await excelImport.CopyToAsync(lStream);
                        ExcelPackage package = new ExcelPackage(lStream);

                        ExcelWorksheet workSheet = package.Workbook.Worksheets.FirstOrDefault(f => f.View.TabSelected);
                        DataTable lDataTable = new DataTable();

                        if (Path.GetExtension(excelImport.FileName) == ".xlsx" || Path.GetExtension(excelImport.FileName) == ".xlsm")
                        {
                            if (package.Workbook.Worksheets.Count > 1)
                            {
                                int lFound = 0;
                                int lCount = 0;

                                for (int i = 1; i <= package.Workbook.Worksheets.Count; i++)
                                {
                                    if (package.Workbook.Worksheets[i].Name == "OrderSummary")
                                    {
                                        for (int j = 1; j < package.Workbook.Worksheets.Count; j++)
                                        {
                                            string lBBS = "";
                                            if (package.Workbook.Worksheets[i].Dimension.End.Row >= 18 + j
                                                && package.Workbook.Worksheets[i].Dimension.End.Column >= 2
                                                && package.Workbook.Worksheets[i].Cells[18 + j, 2].Value != null)
                                            {
                                                lBBS = package.Workbook.Worksheets[i].Cells[18 + j, 2].Value.ToString();
                                            }
                                            if (lBBS != null && lBBS != "" && package.Workbook.Worksheets["OrderDetail-" + lBBS] != null)
                                            {
                                                workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBS];
                                                lCount = lCount + 1;
                                                lFound = 1;
                                            }
                                        }
                                        break;
                                    }
                                }
                                if (lCount > 1)
                                {
                                    lFound = 0;
                                    var lBBSCon = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
                                    if (lBBSCon != null)
                                    {
                                        if (package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()] != null)
                                        {
                                            workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBSCon.BBSNo.Trim()];
                                            lFound = 1;
                                        }
                                    }

                                    if (lFound == 0)
                                    {
                                        return Ok(new { success = false, error = true, message = "Cannot find the BBS " + lBBSCon.BBSNo.Trim() });
                                    }
                                }
                                if (lFound == 1)
                                {
                                    workSheet.DeleteRow(1, 6);
                                    if (workSheet.Dimension.End.Column >= 27)
                                    {
                                        workSheet.DeleteColumn(27, 1);
                                    }
                                }
                            }
                        }

                        var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, BBSID, UserName, workSheet);

                        if (lRtn == true)
                        {
                            var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, BBSID);
                            if (oldBBS != null)
                            {
                                var lNewBBS = oldBBS;

                                lNewBBS.BBSCopiedFrom = "IMPORTED";

                                db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
                                db.SaveChanges();

                                checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);
                            }
                        }
                        return Ok(new { success = true });
                    }
                }
                else
                {
                    return Ok(new { success = false, error = true, message = "Invalid Excel file." });
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, "Server Error: " + ex.Message);
                return Ok(new { success = false, error = true, message = "Import Error: " + ex.Message });
            }
        }

        [HttpPost("upload")]
        public async Task<IActionResult> UploadExcel([FromForm] IFormFile file)
        {
            // TODO: Implement code to save the file to the database using a service

            return Ok(new { message = "File uploaded successfully" });
        }

        async Task<bool> ImportOrderBBS(string CustomerCode, string ProjectCode, int JobID, int BBSID, string UserName, ExcelWorksheet workSheet)
        {

            bool lReturn = true;
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            var lProcessObj = new ProcessController();
            int lFound = 0;
            string lSQL = "";
            string lCustomerBar = "";
            int lMaxLen = 12000;
            string lSkipCheck = "";
            DataTable lDataTable = new DataTable();

            //create columns
            var lColNo = 1;
            try
            {
                lProcessObj.OpenNDSConnection(ref lNDSCon);

                lSQL = "SELECT " +
            "MaxBarLength, " +
            "CustomerBar, " +
            "SkipBendCheck " +
            "FROM dbo.OESProject P " +
            "WHERE P.CustomerCode = '" + CustomerCode + "' " +
            "AND P.ProjectCode = '" + ProjectCode + "' ";

                lCmd.CommandText = lSQL;
                lCmd.Connection = lNDSCon;
                lCmd.CommandTimeout = 300;
                lRst = lCmd.ExecuteReader();
                if (lRst.HasRows)
                {
                    if (lRst.Read())
                    {
                        lMaxLen = lRst.GetValue(0) == DBNull.Value ? 12000 : lRst.GetInt32(0);
                        lCustomerBar = lRst.GetValue(1) == DBNull.Value ? "" : lRst.GetString(1).Trim();
                        lSkipCheck = lRst.GetValue(2) == DBNull.Value ? "N" : (lRst.GetBoolean(2) == true ? "Y" : "N");
                    }
                }
                lRst.Close();
                foreach (var firstRowCell in workSheet.Cells[1, 1, 1, workSheet.Dimension.End.Column])
                {
                    var lTitle = lColNo.ToString() + firstRowCell.Text;
                    if (lTitle == null) { lTitle = lColNo.ToString() + "(No Title)"; }
                    lDataTable.Columns.Add(lTitle, typeof(string));
                    lColNo++;
                }

                //extend column
                lColNo = 1;

                int lRowCount = workSheet.Dimension.End.Row;
                if (lRowCount > 500)
                {
                    lRowCount = 500;
                }

                for (var rowNumber = 1; rowNumber <= lRowCount; rowNumber++)
                {
                    int lColumnCount = workSheet.Dimension.End.Column;
                    if (lColumnCount > 26)
                    {
                        lColumnCount = 26;
                    }
                    var row = workSheet.Cells[rowNumber, 1, rowNumber, lColumnCount];
                    while (row.Count() > lDataTable.Columns.Count)
                    {
                        lDataTable.Columns.Add(lColNo.ToString() + "(No Title)", typeof(string));
                        lColNo++;
                    }
                    var newRow = lDataTable.NewRow();
                    foreach (var cell in row)
                    {
                        try
                        {
                            newRow[cell.Start.Column - 1] = cell.Text;
                        }
                        catch (Exception lE)
                        {
                            //                            newRow[cell.Start.Column - 1] = cell.Text;
                        }

                    }
                    lDataTable.Rows.Add(newRow);
                }

                // Delete last white rows
                if (lDataTable.Rows.Count > 0)
                {
                    for (int i = lDataTable.Rows.Count - 1; i >= 0; i--)
                    {
                        lFound = 0;
                        var lColumnCT = lDataTable.Columns.Count;
                        if (lColumnCT > 36)
                        {
                            lColumnCT = 36;
                        }
                        for (int j = 0; j < lColumnCT; j++)
                        {
                            if (lDataTable.Rows[i].ItemArray[j] != null)
                            {
                                if (lDataTable.Rows[i].ItemArray[j].ToString().Trim() != "" && lDataTable.Rows[i].ItemArray[j].ToString().Trim() != "0")
                                {
                                    lFound = 1;
                                    break;
                                }
                            }
                        }
                        if (lFound == 0)
                        {
                            lDataTable.Rows.RemoveAt(i);
                        }
                        else
                        {
                            break;
                        }
                    }
                }


                if (lDataTable.Rows.Count > 0)
                {
                    // clear null
                    for (int i = 0; i < lDataTable.Rows.Count; i++)
                    {
                        for (int j = 0; j < lDataTable.Columns.Count; j++)
                        {
                            if (lDataTable.Rows[i].ItemArray[j] == null)
                            {
                                lDataTable.Rows[i].ItemArray[j] = "";
                            }
                        }
                    }
                    //find the header row if it has
                    var lColStart = 0;
                    var lRowStart = 0;
                    var lHeaderRows = 0;
                    if (lDataTable.Rows.Count >= 2 && lDataTable.Columns.Count > 7)
                    {
                        for (int i = 0; i < lDataTable.Rows.Count; i++)
                        {
                            for (int j = 0; j < lDataTable.Columns.Count - 1; j++)
                            {
                                if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().ToUpper() == "A" && lDataTable.Rows[i].ItemArray[j + 1].ToString().Trim().ToUpper() == "B")
                                {
                                    lRowStart = i + 1;
                                    lColStart = j;
                                    lHeaderRows = i;
                                    break;
                                }
                            }

                            if (lHeaderRows == 0)
                            {
                                for (int j = 0; j < lDataTable.Columns.Count - 1; j++)
                                {
                                    if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().ToUpper() == "A" && lDataTable.Rows[i].ItemArray[j + 1].ToString().Trim().ToUpper() == "BAR LENGTH")
                                    {
                                        lRowStart = i + 1;
                                        lColStart = j;
                                        lHeaderRows = i;
                                        break;
                                    }
                                }
                            }
                            if (lHeaderRows > 0)
                            {
                                break;
                            }
                        }
                    }

                    // Checking the Imgage and taken out 
                    if (lDataTable.Columns.Count > 9)
                    {
                        lFound = 0;
                        for (int i = lRowStart; i < lDataTable.Rows.Count; i++)
                        {
                            var liVar = 0;
                            if (lDataTable.Rows[i].ItemArray[8] != null &&
                            lDataTable.Rows[i].ItemArray[8].ToString().Trim() != "" &&
                            int.TryParse(lDataTable.Rows[i].ItemArray[8].ToString(), out liVar))
                            {
                                lFound = 1;
                                break;
                            }
                        }

                        if (lFound == 0)
                        {
                            lDataTable.Columns.RemoveAt(8);
                            if (lColStart > 8)
                            {
                                lColStart = lColStart - 1;
                            }
                        }
                    }

                    //check barmark

                    //prepare to insert record
                    //1. get barID
                    int? lBarID = 0;
                    lBarID = await db.OrderDetails.Where(z => z.CustomerCode == CustomerCode &&
                        z.ProjectCode == ProjectCode && z.JobID == JobID &&
                        z.BBSID == BBSID).MaxAsync(z => (int?)z.BarID);
                    if (lBarID == null)
                    {
                        lBarID = 0;
                    }

                    if (lDataTable.Rows.Count > 1)
                    {
                        lDataTable = checkBarMark(lRowStart, lDataTable);
                    }

                    //2. get count of rows in the BBS
                    int lRows = 0;
                    lRows = await db.OrderDetails.CountAsync(z => z.CustomerCode == CustomerCode &&
                        z.ProjectCode == ProjectCode && z.JobID == JobID &&
                        z.BBSID == BBSID);

                    //3. get Jobadvice
                    var lJobAdv = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

                    for (int i = lRowStart; i < lDataTable.Rows.Count; i++)
                    {
                        var lDia = ",8,10,12,13,16,20,24,25,28,32,36,40,50";
                        var lRDia = ",6,8,10,13,16,20";

                        lBarID = lBarID + 1;
                        lRows = lRows + 1;
                        int lSort = lRows * 1000;
                        string lBarType = lDataTable.Rows[i].ItemArray[2].ToString();
                        if (lBarType != null)
                        {
                            lBarType = lBarType.Trim();
                            if (lBarType != "" && lBarType != "T" && lBarType != "R" && lBarType != "H" && lBarType != "X" && lBarType != "E" && lBarType != "N" && lBarType != "C") lBarType = "H";
                        }
                        else
                        {
                            lBarType = "";
                        }
                        var lBarDia = lDataTable.Rows[i].ItemArray[3].ToString();
                        lBarDia = lBarDia.Trim();

                        if (lBarType == "R")
                        {
                            if (lRDia.IndexOf(lBarDia) < 0) lBarDia = null;
                        }
                        else
                        {
                            if (lDia.IndexOf(lBarDia) < 0) lBarDia = null;
                        }

                        short lBarDiaInt = 0;
                        short.TryParse(lBarDia, out lBarDiaInt);

                        if (lBarDiaInt > 50)
                        {
                            lBarDiaInt = 0;
                        }
                        int lMQty = 0;
                        int.TryParse(lDataTable.Rows[i].ItemArray[4].ToString(), out lMQty);

                        if (lMQty > 15000)
                        {
                            lMQty = 1;
                        }

                        int lEQty = 0;
                        int.TryParse(lDataTable.Rows[i].ItemArray[5].ToString(), out lEQty);

                        if (lEQty > 15000)
                        {
                            lEQty = 1;
                        }
                        int lTQty = lMQty * lEQty;

                        var lBarTypePin = lBarType;
                        //if (lBarType == "E" || lBarType == "N")
                        //{
                        //    lBarTypePin = "T";
                        //}
                        if (lBarType == "C")
                        {
                            lBarTypePin = "H";
                        }

                        var lStandardPin = db.PinMaster.Find(lBarTypePin, "S", lBarDiaInt);
                        var lNonStandardPin = db.PinMaster.Find(lBarTypePin, "N", lBarDiaInt);

                        //Check Standard and take other standard
                        if (lJobAdv != null)
                        {
                            var lBBSStd = lJobAdv.BBSStandard;
                            if (lBBSStd != null && lBBSStd.Trim() != "" && lBBSStd.Trim() != "BS-8666")
                            {
                                var lS = db.PinAdd.Find(lBBSStd, lBarTypePin, "S", lBarDiaInt);

                                if (lS != null && lS.dia > 0)
                                {
                                    lStandardPin = new PinModels
                                    {
                                        grade = lS.grade,
                                        type = lS.type,
                                        dia = lS.dia,
                                        pin = lS.pin,
                                        bend_len_min = lS.bend_len_min,
                                        hook_len_min = lS.hook_len_min,
                                        hook_height_min = lS.hook_height_min
                                    };
                                }

                                var lN = db.PinAdd.Find(lBBSStd, lBarTypePin, "N", lBarDiaInt);

                                if (lN != null && lN.dia > 0)
                                {
                                    lNonStandardPin = new PinModels
                                    {
                                        grade = lN.grade,
                                        type = lN.type,
                                        dia = lN.dia,
                                        pin = lN.pin,
                                        bend_len_min = lN.bend_len_min,
                                        hook_len_min = lN.hook_len_min,
                                        hook_height_min = lN.hook_height_min
                                    };
                                }
                            }
                        }

                        var lShapeCode = lDataTable.Rows[i].ItemArray[7].ToString();
                        if (lShapeCode == null)
                        {
                            lShapeCode = "";
                        }
                        lShapeCode = lShapeCode.Trim();

                        if (lShapeCode.Length > 3)
                        {
                            lShapeCode = lShapeCode.Substring(0, 3);
                        }

                        var lShapeCheck = lShapeCode;
                        while (lShapeCheck.Length < 3)
                        {
                            lShapeCheck = "0" + lShapeCheck;
                        }

                        lFound = 0;
                        lCmd = new SqlCommand();
                        lCmd.CommandText =
                        "SELECT CSM_SHAPE_ID, CSC_CAT_DESC, CSM_CRT_ON " +
                        "FROM dbo.T_CAB_SHAPE_MAST S, dbo.T_CM_SHAPE_CAT C " +
                        "WHERE S.CSM_CAT_ID = C.CSC_CAT_ID " +
                        "AND CSM_SHAPE_ID = '" + lShapeCheck + "' " +
                        "AND CSM_ACT_INACTIVE = 1 ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandTimeout = 300;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            if (lRst.Read())
                            {
                                lFound = 1;
                            }
                        }
                        lRst.Close();

                        if (lFound == 0)
                        {
                            lShapeCode = "";
                        }

                        var lshapeParameters = "";
                        var lshapeLengthFormula = "";
                        var lshapeParaValidator = "";
                        var lshapeTransportValidator = "";
                        ShapeConfViewModels lFormulas = new ShapeConfViewModels();

                        int? lPinSize = 0;
                        bool lBarSTD = false;

                        int lVal_A = 0;
                        int.TryParse(lDataTable.Rows[i].ItemArray[8].ToString(), out lVal_A);

                        int lWeight = 0;
                        int.TryParse(lDataTable.Rows[i].ItemArray[lDataTable.Columns.Count - 2].ToString(), out lWeight);

                        int lBarLength = 0;
                        int.TryParse(lDataTable.Rows[i].ItemArray[lDataTable.Columns.Count - 3].ToString(), out lBarLength);

                        if (lShapeCode != null && lShapeCode.Trim() != "" && lBarDiaInt != 0)
                        {
                            // Add code to check BarSTD
                            
                            if (lShapeCode == "020" && (lVal_A == 12000 || lVal_A == 14000) && lVal_A == lBarLength && (lWeight % 2000 == 0))
                            {
                                lBarSTD = true;
                            }


                            lShapeCode = lShapeCode.Trim();
                            lShapeCode = lShapeCode.ToUpper();
                            if (lShapeCode.Length == 2) lShapeCode = "0" + lShapeCode;
                            if (lShapeCode == "083") lShapeCode = "D83";
                            if (lShapeCode == "065") lShapeCode = "R65";

                            var lShapes = (from p in db.Shape where p.shapeCode == lShapeCode select p).ToList();
                            if (lShapes.Count == 0)
                            {
                                //lShapeCode = "";
                            }
                            else
                            {
                                lshapeParameters = lShapes[0].shapeParameters;
                                lshapeLengthFormula = lShapes[0].shapeLengthFormula;
                                lshapeParaValidator = lShapes[0].shapeParaValidator;
                                lshapeTransportValidator = lShapes[0].shapeTransportValidator;
                            }

                            if (lStandardPin != null && lShapeCode != "020" && lShapeCode != "20" & lshapeParameters != "A")
                            {
                                lPinSize = lStandardPin.pin;
                            }

                            lFormulas = await getShapeInfoFunDB(CustomerCode, ProjectCode, JobID, lShapeCode, 0);
                            lshapeParameters = lFormulas.shapeParameters;
                            lshapeLengthFormula = lFormulas.shapeLengthFormula;
                        }


                        var orderDetailsModels = new OrderDetailsModels
                        {
                            CustomerCode = CustomerCode,
                            ProjectCode = ProjectCode,
                            JobID = JobID,
                            BBSID = BBSID,
                            BarID = (int)lBarID,
                            BarSort = lSort,
                            Cancelled = null,
                            BarCAB = lBarSTD ? false : true,
                            BarSTD = lBarSTD,
                            ElementMark = lDataTable.Rows[i].ItemArray[0].ToString().Trim().Length > 20 ? lDataTable.Rows[i].ItemArray[0].ToString().Trim().Substring(0, 19) : lDataTable.Rows[i].ItemArray[0].ToString().Trim(),
                            BarMark = lDataTable.Rows[i].ItemArray[1].ToString().Trim().Length > 8 ? lDataTable.Rows[i].ItemArray[1].ToString().Trim().Substring(0, 8) : lDataTable.Rows[i].ItemArray[1].ToString().Trim(),
                            BarType = lBarType,
                            BarSize = lBarDiaInt == 0 ? (short?)null : lBarDiaInt,
                            BarMemberQty = lMQty == 0 ? (int?)null : lMQty,
                            BarEachQty = lEQty == 0 ? (int?)null : lEQty,
                            BarTotalQty = lTQty == 0 ? (int?)null : lTQty,
                            BarShapeCode = lShapeCode,
                            A = lBarSTD ? lVal_A : null,
                            B = null,
                            C = null,
                            D = null,
                            E = null,
                            F = null,
                            G = null,
                            H = null,
                            I = null,
                            J = null,
                            K = null,
                            L = null,
                            M = null,
                            N = null,
                            O = null,
                            P = null,
                            Q = null,
                            R = null,
                            S = null,
                            T = null,
                            U = null,
                            V = null,
                            W = null,
                            X = null,
                            Y = null,
                            Z = null,
                            A2 = null,
                            B2 = null,
                            C2 = null,
                            D2 = null,
                            E2 = null,
                            F2 = null,
                            G2 = null,
                            H2 = null,
                            I2 = null,
                            J2 = null,
                            K2 = null,
                            L2 = null,
                            M2 = null,
                            N2 = null,
                            O2 = null,
                            P2 = null,
                            Q2 = null,
                            R2 = null,
                            S2 = null,
                            T2 = null,
                            U2 = null,
                            V2 = null,
                            W2 = null,
                            X2 = null,
                            Y2 = null,
                            Z2 = null,
                            BarLength = lBarSTD ? lBarLength : null,
                            BarLength2 = null,
                            BarWeight = lBarSTD ? lWeight : null,
                            Remarks = "",
                            shapeTransport = 0,
                            PinSize = lPinSize == 0 ? (int?)null : lPinSize,
                            TeklaGUID = "",
                            UpdateDate = DateTime.Now,
                            UpdateBy = UserName,//User.Identity.GetUserName(),
                            CreateDate = DateTime.Now,
                            CreateBy = UserName//User.Identity.GetUserName()
                        };

                        if (lShapeCode.Trim() != "" || lBarDiaInt != 0 || lTQty > 0)
                        {
                            if (lRowStart > 0 && lColStart > 0)
                            {
                                //HAVE HEADER ROW
                                for (int j = lColStart; j < lDataTable.Columns.Count; j++)
                                {
                                    string lValue = lDataTable.Rows[i].ItemArray[j].ToString();

                                    if (isInvalidParameterCell(lShapeCode,
                                        lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().Trim(),
                                        lshapeParameters) == true)
                                    {
                                        lValue = null;
                                    }

                                    //var lErrorMsg = "";
                                    //if (isValidValue(lDataTable.Rows[lHeaderRows].ItemArray[j].ToString(),
                                    //lshapeParameters,
                                    //lshapeParaValidator,
                                    //lBarDiaInt,
                                    //lValue,
                                    //orderDetailsModels,
                                    //out lErrorMsg) == false)
                                    //{
                                    //    lValue = null;
                                    //}

                                    //var lTotalLength = calTotalLen(
                                    //    orderDetailsModels,
                                    //    lshapeLengthFormula,
                                    //    lValue);

                                    // validate the Total Length

                                    //var lMaxLength = getVarMaxValue(lTotalLength);
                                    //if (lMaxLength > 12000)
                                    //{
                                    //    lValue = null;
                                    //}
                                    //else
                                    //{
                                    //orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
                                    //orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);
                                    //}

                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "A") orderDetailsModels.A = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "B") orderDetailsModels.B = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "C") orderDetailsModels.C = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "D") orderDetailsModels.D = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "E") orderDetailsModels.E = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "F") orderDetailsModels.F = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "G") orderDetailsModels.G = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "H") orderDetailsModels.H = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "I") orderDetailsModels.I = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "J") orderDetailsModels.J = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "K") orderDetailsModels.K = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "L") orderDetailsModels.L = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "M") orderDetailsModels.M = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "N") orderDetailsModels.N = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "O") orderDetailsModels.O = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "P") orderDetailsModels.P = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Q") orderDetailsModels.Q = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "R") orderDetailsModels.R = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "S") orderDetailsModels.S = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "T") orderDetailsModels.T = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "U") orderDetailsModels.U = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "V") orderDetailsModels.V = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "W") orderDetailsModels.W = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "X") orderDetailsModels.X = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Y") orderDetailsModels.Y = getParaValue(lValue, 1);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Z") orderDetailsModels.Z = getParaValue(lValue, 1);

                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "A") orderDetailsModels.A2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "B") orderDetailsModels.B2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "C") orderDetailsModels.C2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "D") orderDetailsModels.D2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "E") orderDetailsModels.E2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "F") orderDetailsModels.F2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "G") orderDetailsModels.G2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "H") orderDetailsModels.H2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "I") orderDetailsModels.I2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "J") orderDetailsModels.J2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "K") orderDetailsModels.K2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "L") orderDetailsModels.L2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "M") orderDetailsModels.M2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "N") orderDetailsModels.N2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "O") orderDetailsModels.O2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "P") orderDetailsModels.P2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Q") orderDetailsModels.Q2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "R") orderDetailsModels.R2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "S") orderDetailsModels.S2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "T") orderDetailsModels.T2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "U") orderDetailsModels.U2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "V") orderDetailsModels.V2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "W") orderDetailsModels.W2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "X") orderDetailsModels.X2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Y") orderDetailsModels.Y2 = getParaValue(lValue, 2);
                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "Z") orderDetailsModels.Z2 = getParaValue(lValue, 2);

                                    if (lDataTable.Rows[lHeaderRows].ItemArray[j].ToString().ToUpper().Trim() == "GUID")
                                    {
                                        if (lValue != null && lValue.Length > 1000)
                                        {
                                            lValue = lValue.Substring(0, 1000);
                                        }
                                        orderDetailsModels.TeklaGUID = lValue;
                                    }
                                }
                            }
                            else
                            {
                                //WITHOUT HEADER ROW PARAMETER a STARTFROM 8
                                for (int j = 8; j < lDataTable.Columns.Count; j++)
                                {
                                    var lValue = lDataTable.Rows[i].ItemArray[j].ToString();

                                    if (isInvalidParameterCell(lShapeCode,
                                        ((char)(Encoding.ASCII.GetBytes("A")[0] + j - 8)).ToString(),
                                        lshapeParameters) == true)
                                    {
                                        lValue = null;
                                    }

                                    //var lErrorMsg = "";
                                    //if (isValidValue(
                                    //    ((char)(Encoding.ASCII.GetBytes("A")[0] + j - 8)).ToString(),
                                    //    lshapeParameters,
                                    //    lshapeParaValidator,
                                    //    lBarDiaInt,
                                    //    lValue,
                                    //    orderDetailsModels,
                                    //    out lErrorMsg) == false)
                                    //{
                                    //    lValue = null;
                                    //}

                                    //var lTotalLength = calTotalLen(
                                    //    orderDetailsModels,
                                    //    lshapeLengthFormula,
                                    //    lValue);

                                    // validate the Total Length

                                    //var lMaxLength = getVarMaxValue(lTotalLength);

                                    //if (lMaxLength > 12000)
                                    //{
                                    //    lValue = null;
                                    //}
                                    //else
                                    //{
                                    //orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
                                    //orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);
                                    //}

                                    if (j == 8 && lshapeParameters.IndexOf("A") >= 0) orderDetailsModels.A = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 9 && lshapeParameters.IndexOf("B") >= 0) orderDetailsModels.B = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 10 && lshapeParameters.IndexOf("C") >= 0) orderDetailsModels.C = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 11 && lshapeParameters.IndexOf("D") >= 0) orderDetailsModels.D = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 12 && lshapeParameters.IndexOf("E") >= 0) orderDetailsModels.E = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 13 && lshapeParameters.IndexOf("F") >= 0) orderDetailsModels.F = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 14 && lshapeParameters.IndexOf("G") >= 0) orderDetailsModels.G = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 15 && lshapeParameters.IndexOf("H") >= 0) orderDetailsModels.H = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 16 && lshapeParameters.IndexOf("I") >= 0) orderDetailsModels.I = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 17 && lshapeParameters.IndexOf("J") >= 0) orderDetailsModels.J = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 18 && lshapeParameters.IndexOf("K") >= 0) orderDetailsModels.K = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 19 && lshapeParameters.IndexOf("L") >= 0) orderDetailsModels.L = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 20 && lshapeParameters.IndexOf("M") >= 0) orderDetailsModels.M = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 21 && lshapeParameters.IndexOf("N") >= 0) orderDetailsModels.N = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 22 && lshapeParameters.IndexOf("O") >= 0) orderDetailsModels.O = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 23 && lshapeParameters.IndexOf("P") >= 0) orderDetailsModels.P = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 24 && lshapeParameters.IndexOf("Q") >= 0) orderDetailsModels.Q = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 25 && lshapeParameters.IndexOf("R") >= 0) orderDetailsModels.R = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 26 && lshapeParameters.IndexOf("S") >= 0) orderDetailsModels.S = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 27 && lshapeParameters.IndexOf("T") >= 0) orderDetailsModels.T = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 28 && lshapeParameters.IndexOf("U") >= 0) orderDetailsModels.U = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 29 && lshapeParameters.IndexOf("V") >= 0) orderDetailsModels.V = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 30 && lshapeParameters.IndexOf("W") >= 0) orderDetailsModels.W = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 31 && lshapeParameters.IndexOf("X") >= 0) orderDetailsModels.X = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 32 && lshapeParameters.IndexOf("Y") >= 0) orderDetailsModels.Y = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);
                                    if (j == 33 && lshapeParameters.IndexOf("Z") >= 0) orderDetailsModels.Z = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 1);

                                    if (j == 8 && lshapeParameters.IndexOf("A") >= 0) orderDetailsModels.A2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 9 && lshapeParameters.IndexOf("B") >= 0) orderDetailsModels.B2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 10 && lshapeParameters.IndexOf("C") >= 0) orderDetailsModels.C2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 11 && lshapeParameters.IndexOf("D") >= 0) orderDetailsModels.D2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 12 && lshapeParameters.IndexOf("E") >= 0) orderDetailsModels.E2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 13 && lshapeParameters.IndexOf("F") >= 0) orderDetailsModels.F2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 14 && lshapeParameters.IndexOf("G") >= 0) orderDetailsModels.G2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 15 && lshapeParameters.IndexOf("H") >= 0) orderDetailsModels.H2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 16 && lshapeParameters.IndexOf("I") >= 0) orderDetailsModels.I2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 17 && lshapeParameters.IndexOf("J") >= 0) orderDetailsModels.J2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 18 && lshapeParameters.IndexOf("K") >= 0) orderDetailsModels.K2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 19 && lshapeParameters.IndexOf("L") >= 0) orderDetailsModels.L2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 20 && lshapeParameters.IndexOf("M") >= 0) orderDetailsModels.M2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 21 && lshapeParameters.IndexOf("N") >= 0) orderDetailsModels.N2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 22 && lshapeParameters.IndexOf("O") >= 0) orderDetailsModels.O2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 23 && lshapeParameters.IndexOf("P") >= 0) orderDetailsModels.P2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 24 && lshapeParameters.IndexOf("Q") >= 0) orderDetailsModels.Q2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 25 && lshapeParameters.IndexOf("R") >= 0) orderDetailsModels.R2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 26 && lshapeParameters.IndexOf("S") >= 0) orderDetailsModels.S2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 27 && lshapeParameters.IndexOf("T") >= 0) orderDetailsModels.T2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 28 && lshapeParameters.IndexOf("U") >= 0) orderDetailsModels.U2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 29 && lshapeParameters.IndexOf("V") >= 0) orderDetailsModels.V2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 30 && lshapeParameters.IndexOf("W") >= 0) orderDetailsModels.W2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 31 && lshapeParameters.IndexOf("X") >= 0) orderDetailsModels.X2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 32 && lshapeParameters.IndexOf("Y") >= 0) orderDetailsModels.Y2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);
                                    if (j == 33 && lshapeParameters.IndexOf("Z") >= 0) orderDetailsModels.Z2 = getParaValue(lDataTable.Rows[i].ItemArray[j].ToString(), 2);

                                    if (lDataTable.Rows[i].ItemArray[j].ToString().Trim().Length >= 36 && lDataTable.Rows[i].ItemArray[j].ToString().Split('-').Length >= 5)
                                    {
                                        lValue = lDataTable.Rows[i].ItemArray[j].ToString().Trim();
                                        if (lValue != null && lValue.Length > 1000)
                                        {
                                            lValue = lValue.Substring(0, 1000);
                                        }

                                        orderDetailsModels.TeklaGUID = lValue;
                                    }
                                }
                            }

                            if (orderDetailsModels.A != null && orderDetailsModels.A > 50000)
                            {
                                orderDetailsModels.A = null;
                            }
                            if (orderDetailsModels.B != null && orderDetailsModels.B > 50000)
                            {
                                orderDetailsModels.B = null;
                            }
                            if (orderDetailsModels.C != null && orderDetailsModels.C > 50000)
                            {
                                orderDetailsModels.C = null;
                            }
                            if (orderDetailsModels.D != null && orderDetailsModels.D > 50000)
                            {
                                orderDetailsModels.D = null;
                            }
                            if (orderDetailsModels.E != null && orderDetailsModels.E > 50000)
                            {
                                orderDetailsModels.E = null;
                            }
                            if (orderDetailsModels.F != null && orderDetailsModels.F > 50000)
                            {
                                orderDetailsModels.F = null;
                            }
                            if (orderDetailsModels.G != null && orderDetailsModels.G > 50000)
                            {
                                orderDetailsModels.G = null;
                            }
                            if (orderDetailsModels.H != null && orderDetailsModels.H > 50000)
                            {
                                orderDetailsModels.H = null;
                            }
                            if (orderDetailsModels.I != null && orderDetailsModels.I > 50000)
                            {
                                orderDetailsModels.I = null;
                            }
                            if (orderDetailsModels.J != null && orderDetailsModels.J > 50000)
                            {
                                orderDetailsModels.J = null;
                            }
                            if (orderDetailsModels.K != null && orderDetailsModels.K > 50000)
                            {
                                orderDetailsModels.K = null;
                            }
                            if (orderDetailsModels.L != null && orderDetailsModels.L > 50000)
                            {
                                orderDetailsModels.L = null;
                            }
                            if (orderDetailsModels.M != null && orderDetailsModels.M > 50000)
                            {
                                orderDetailsModels.M = null;
                            }
                            if (orderDetailsModels.N != null && orderDetailsModels.N > 50000)
                            {
                                orderDetailsModels.N = null;
                            }
                            if (orderDetailsModels.O != null && orderDetailsModels.O > 50000)
                            {
                                orderDetailsModels.O = null;
                            }
                            if (orderDetailsModels.P != null && orderDetailsModels.P > 50000)
                            {
                                orderDetailsModels.P = null;
                            }
                            if (orderDetailsModels.Q != null && orderDetailsModels.Q > 50000)
                            {
                                orderDetailsModels.Q = null;
                            }
                            if (orderDetailsModels.R != null && orderDetailsModels.R > 50000)
                            {
                                orderDetailsModels.R = null;
                            }
                            if (orderDetailsModels.S != null && orderDetailsModels.S > 50000)
                            {
                                orderDetailsModels.S = null;
                            }
                            if (orderDetailsModels.T != null && orderDetailsModels.T > 50000)
                            {
                                orderDetailsModels.T = null;
                            }
                            if (orderDetailsModels.U != null && orderDetailsModels.U > 50000)
                            {
                                orderDetailsModels.U = null;
                            }
                            if (orderDetailsModels.V != null && orderDetailsModels.V > 50000)
                            {
                                orderDetailsModels.V = null;
                            }
                            if (orderDetailsModels.W != null && orderDetailsModels.W > 50000)
                            {
                                orderDetailsModels.W = null;
                            }
                            if (orderDetailsModels.X != null && orderDetailsModels.X > 50000)
                            {
                                orderDetailsModels.X = null;
                            }
                            if (orderDetailsModels.Y != null && orderDetailsModels.Y > 50000)
                            {
                                orderDetailsModels.Y = null;
                            }
                            if (orderDetailsModels.Z != null && orderDetailsModels.Z > 50000)
                            {
                                orderDetailsModels.Z = null;
                            }

                            if (lShapeCode.Trim() != "" && lBarDiaInt != 0)
                            {
                                if (lShapeCode != "020" && lStandardPin != null && lNonStandardPin != null)
                                {
                                    //Calculate depend
                                    calDependValue(ref orderDetailsModels, lFormulas, lPinSize.ToString(), lBarDiaInt.ToString());

                                    //Calculate depend
                                    CheckPinSize(ref orderDetailsModels, lFormulas, lStandardPin, lNonStandardPin, lBarDiaInt);
                                }

                                var lTotalLength = calTotalLen(orderDetailsModels, lshapeLengthFormula);

                                orderDetailsModels.BarLength = getParaValue(lTotalLength, 1);
                                orderDetailsModels.BarLength2 = getParaValue(lTotalLength, 2);

                                if (orderDetailsModels.BarSTD == false) { 
                                    double lWT = calWeight(orderDetailsModels);
                                    if (lWT > 0)
                                    {
                                        orderDetailsModels.BarWeight = (decimal?)lWT;
                                    }
                                }

                                orderDetailsModels.shapeTransport = (byte)ValidTransport(orderDetailsModels, lshapeTransportValidator);

                                if (orderDetailsModels.shapeTransport == 1)
                                {
                                    orderDetailsModels.Remarks = "Low Bed";
                                }
                                if (orderDetailsModels.shapeTransport == 2)
                                {
                                    orderDetailsModels.Remarks = "Escort";
                                }

                                //Assign default paremeter value fro some shape
                                if (lShapeCode == "061" || lShapeCode == "079")
                                {
                                    if (lBarDiaInt > 0 && (orderDetailsModels.C == null || orderDetailsModels.C == 0))
                                    {
                                        if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
                                        {
                                            orderDetailsModels.C = 13 * lBarDiaInt;
                                        }
                                        else
                                        {
                                            orderDetailsModels.C = 12 * lBarDiaInt;
                                        }
                                    }
                                    if (lBarDiaInt > 0 && (orderDetailsModels.D == null || orderDetailsModels.D == 0))
                                    {
                                        if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
                                        {
                                            orderDetailsModels.D = 13 * lBarDiaInt;
                                        }
                                        else
                                        {
                                            orderDetailsModels.D = 12 * lBarDiaInt;
                                        }
                                    }
                                }
                                if (lShapeCode == "79A" && lBarDiaInt > 0)
                                {
                                    if (orderDetailsModels.C == null || orderDetailsModels.C == 0)
                                    {
                                        if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
                                        {
                                            orderDetailsModels.C = 13 * lBarDiaInt;
                                        }
                                        else
                                        {
                                            orderDetailsModels.C = 12 * lBarDiaInt;
                                        }
                                    }
                                }
                                if (lShapeCode == "61C")
                                {
                                    if (lBarDiaInt > 0 && (orderDetailsModels.A == null || orderDetailsModels.A == 0))
                                    {
                                        if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
                                        {
                                            orderDetailsModels.A = 13 * lBarDiaInt;
                                        }
                                        else
                                        {
                                            orderDetailsModels.A = 12 * lBarDiaInt;
                                        }
                                    }
                                    if (lBarDiaInt > 0 && (orderDetailsModels.D == null || orderDetailsModels.D == 0))
                                    {
                                        if (lBarType == "H" || lBarType == "C" || lBarType == "E" || lBarType == "N")
                                        {
                                            orderDetailsModels.D = 13 * lBarDiaInt;
                                        }
                                        else
                                        {
                                            orderDetailsModels.D = 12 * lBarDiaInt;
                                        }
                                    }
                                    if (orderDetailsModels.E == null || orderDetailsModels.E == 0)
                                    {
                                        orderDetailsModels.E = 135;
                                    }
                                }


                            }

                        }

                        //change bar type to C if it is cusomer bar project
                        if (lCustomerBar.IndexOf("C") >= 0 && (orderDetailsModels.BarType == "H" || orderDetailsModels.BarType == "X" || orderDetailsModels.BarType == "R"))
                        {
                            orderDetailsModels.BarType = "C";
                        }
                        db.OrderDetails.Add(orderDetailsModels);

                    }
                    int lRtn = await db.SaveChangesAsync();
                }

            }
            catch (Exception e)
            {
                var lErrorMsg = e.Message;
                lReturn = false;
            }
            lProcessObj.CloseNDSConnection(ref lNDSCon);

            //2. get count of rows in the BBS
            if (lReturn == true)
            {
                int lCount = 0;
                lCount = db.OrderDetails.Count(z => z.CustomerCode == CustomerCode &&
                    z.ProjectCode == ProjectCode && z.JobID == JobID &&
                    z.BBSID == BBSID);
                if (lCount == 0)
                {
                    lReturn = false;
                }
            }

            return lReturn;
        }

        public DataTable checkBarMark(int pRowStart, DataTable pDataTable)
        {
            int lNumber = 1;
            int lFound = 0;

            DataTable lRetTable = pDataTable;

            if (lRetTable.Rows.Count >= pRowStart)
            {
                // check null marking
                for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
                {
                    //check Shape Code
                    var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
                    if (lShapeCode == null) lShapeCode = "";
                    if (lShapeCode.Length > 0)
                    {
                        if (lRetTable.Rows[i].ItemArray[1] == null)
                        {
                            lRetTable.Rows[i][1] = "";
                        }

                        lRetTable.Rows[i].ItemArray[1] = lRetTable.Rows[i].ItemArray[1].ToString().Trim();
                        if (lRetTable.Rows[i].ItemArray[1].ToString().IndexOf(",") >= 0)
                        {
                            lRetTable.Rows[i][1] = lRetTable.Rows[i].ItemArray[1].ToString().Replace(",", "");
                        }

                        if (lRetTable.Rows[i].ItemArray[1].ToString().Length > 8)
                        {
                            lRetTable.Rows[i][1] = lRetTable.Rows[i].ItemArray[1].ToString().Substring(0, 8);
                        }
                    }
                }

                //check duplicated mark
                if (lRetTable.Rows.Count > pRowStart)
                {
                    for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
                    {
                        //check Shape Code
                        var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
                        if (lShapeCode == null) lShapeCode = "";
                        if (lShapeCode.Length > 0)
                        {
                            var lMark = lRetTable.Rows[i].ItemArray[1].ToString();

                            if (lMark.Length > 0)
                            {
                                for (int j = pRowStart; j < i; j++)
                                {
                                    if (lMark == lRetTable.Rows[j].ItemArray[1].ToString())
                                    {
                                        lNumber = 1;
                                        //verify lNumber if existing in list
                                        lFound = 1;
                                        if (lMark.Length > 4)
                                        {
                                            lMark = lMark.Substring(0, 4);
                                        }
                                        while (lFound == 1)
                                        {
                                            lFound = 0;
                                            for (int k = pRowStart; k < i; k++)
                                            {
                                                if (lRetTable.Rows[k].ItemArray[1].ToString() == lMark + "-" + lNumber.ToString())
                                                {
                                                    lFound = 1;
                                                    break;
                                                }
                                            }
                                            if (lFound == 1)
                                            {
                                                lNumber++;
                                            }
                                            if (lNumber > 9 && lMark.Length > 3)
                                            {
                                                lMark = lMark.Substring(0, 3);
                                            }
                                        }
                                        lRetTable.Rows[i][1] = lMark + "-" + lNumber.ToString();
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Check non-marking
                lNumber = 1;
                for (int i = pRowStart; i < lRetTable.Rows.Count; i++)
                {
                    //check Shape Code
                    var lShapeCode = lRetTable.Rows[i].ItemArray[7].ToString();
                    if (lShapeCode == null) lShapeCode = "";
                    if (lShapeCode.Length > 0)
                    {
                        if (lRetTable.Rows[i].ItemArray[1].ToString().Length == 0)
                        {
                            //verify lNumber if existing in list
                            lFound = 1;
                            while (lFound == 1)
                            {
                                lFound = 0;
                                for (int j = pRowStart; j < lRetTable.Rows.Count; j++)
                                {
                                    if (lRetTable.Rows[j].ItemArray[1].ToString() == lNumber.ToString())
                                    {
                                        lFound = 1;
                                        break;
                                    }
                                }
                                if (lFound == 1)
                                {
                                    lNumber++;
                                }
                            }

                            lRetTable.Rows[i][1] = lNumber.ToString();
                            lNumber++;
                        }
                    }
                }
            }

            return lRetTable;
        }

        bool isInvalidParameterCell(string pShapeCode, string pColumnName, string pParameters)
        {
            var lReturn = false;
            if (pShapeCode != null && pShapeCode != "" && pParameters != null)
            {
                if ((pColumnName == "A" && pParameters.IndexOf("A") < 0) ||
                (pColumnName == "B" && pParameters.IndexOf("B") < 0) ||
                (pColumnName == "C" && pParameters.IndexOf("C") < 0) ||
                (pColumnName == "D" && pParameters.IndexOf("D") < 0) ||
                (pColumnName == "E" && pParameters.IndexOf("E") < 0) ||
                (pColumnName == "F" && pParameters.IndexOf("F") < 0) ||
                (pColumnName == "G" && pParameters.IndexOf("G") < 0) ||
                (pColumnName == "H" && pParameters.IndexOf("H") < 0) ||
                (pColumnName == "I" && pParameters.IndexOf("I") < 0) ||
                (pColumnName == "J" && pParameters.IndexOf("J") < 0) ||
                (pColumnName == "K" && pParameters.IndexOf("K") < 0) ||
                (pColumnName == "L" && pParameters.IndexOf("L") < 0) ||
                (pColumnName == "M" && pParameters.IndexOf("M") < 0) ||
                (pColumnName == "N" && pParameters.IndexOf("N") < 0) ||
                (pColumnName == "O" && pParameters.IndexOf("O") < 0) ||
                (pColumnName == "P" && pParameters.IndexOf("P") < 0) ||
                (pColumnName == "Q" && pParameters.IndexOf("Q") < 0) ||
                (pColumnName == "R" && pParameters.IndexOf("R") < 0) ||
                (pColumnName == "S" && pParameters.IndexOf("S") < 0) ||
                (pColumnName == "T" && pParameters.IndexOf("T") < 0) ||
                (pColumnName == "U" && pParameters.IndexOf("U") < 0) ||
                (pColumnName == "V" && pParameters.IndexOf("V") < 0) ||
                (pColumnName == "W" && pParameters.IndexOf("W") < 0) ||
                (pColumnName == "X" && pParameters.IndexOf("X") < 0) ||
                (pColumnName == "Y" && pParameters.IndexOf("Y") < 0) ||
                (pColumnName == "Z" && pParameters.IndexOf("Z") < 0))
                {
                    lReturn = true;
                }
            }
            return lReturn;
        }

        public void calDependValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pPinSize, string pDia)
        {
            var lReturn = "";

            string[] lParameters = new string[] { };
            if (pShapeParam.shapeParameters != null)
            {
                lParameters = pShapeParam.shapeParameters.Split(',');
            }

            string[] lParType = new string[] { };
            if (pShapeParam.shapeParType != null)
            {
                lParType = pShapeParam.shapeParType.Split(',');
            }

            string[] lPardefvalue = new string[] { };
            if (pShapeParam.shapeDefaultValue != null)
            {
                lPardefvalue = pShapeParam.shapeDefaultValue.Split(',');
            }

            string[] lFormula1 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula1 != null)
            {
                lFormula1 = pShapeParam.shapeAutoCalcFormula1.Split(',');
            }

            string[] lFormula2 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula2 != null)
            {
                lFormula2 = pShapeParam.shapeAutoCalcFormula2.Split(',');
            }

            string[] lFormula3 = new string[] { };
            if (pShapeParam.shapeAutoCalcFormula3 != null)
            {
                lFormula3 = pShapeParam.shapeAutoCalcFormula3.Split(',');
            }

            if (lParameters.Length > 0)
            {
                for (int i = 0; i < lParameters.Length; i++)
                {
                    if (lParameters[i] == "A" && (pItem.A == null || pItem.A <= 0)
                        || lParameters[i] == "B" && (pItem.B == null || pItem.B <= 0)
                        || lParameters[i] == "C" && (pItem.C == null || pItem.C <= 0)
                        || lParameters[i] == "D" && (pItem.D == null || pItem.D <= 0)
                        || lParameters[i] == "E" && (pItem.E == null || pItem.E <= 0)
                        || lParameters[i] == "F" && (pItem.F == null || pItem.F <= 0)
                        || lParameters[i] == "G" && (pItem.G == null || pItem.G <= 0)
                        || lParameters[i] == "H" && (pItem.H == null || pItem.H <= 0)
                        || lParameters[i] == "I" && (pItem.I == null || pItem.I <= 0)
                        || lParameters[i] == "J" && (pItem.J == null || pItem.J <= 0)
                        || lParameters[i] == "K" && (pItem.K == null || pItem.K <= 0)
                        || lParameters[i] == "L" && (pItem.L == null || pItem.L <= 0)
                        || lParameters[i] == "M" && (pItem.M == null || pItem.M <= 0)
                        || lParameters[i] == "N" && (pItem.N == null || pItem.N <= 0)
                        || lParameters[i] == "O" && (pItem.O == null || pItem.O <= 0)
                        || lParameters[i] == "P" && (pItem.P == null || pItem.P <= 0)
                        || lParameters[i] == "Q" && (pItem.Q == null || pItem.Q <= 0)
                        || lParameters[i] == "R" && (pItem.R == null || pItem.R <= 0)
                        || lParameters[i] == "S" && (pItem.S == null || pItem.S <= 0)
                        || lParameters[i] == "T" && (pItem.T == null || pItem.T <= 0)
                        || lParameters[i] == "U" && (pItem.U == null || pItem.U <= 0)
                        || lParameters[i] == "V" && (pItem.V == null || pItem.V <= 0)
                        || lParameters[i] == "X" && (pItem.W == null || pItem.W <= 0)
                        || lParameters[i] == "X" && (pItem.X == null || pItem.X <= 0)
                        || lParameters[i] == "Y" && (pItem.Y == null || pItem.Y <= 0)
                        || lParameters[i] == "Z" && (pItem.Z == null || pItem.Z <= 0)
                        )
                    {
                        lReturn = calParamValue(ref pItem, pShapeParam, lParType[i], lPardefvalue[i], pPinSize, pDia, lFormula1[i], lFormula2[i], lFormula3[i], lParameters[i]);
                    }
                }
            }

        }

        void CheckPinSize(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, PinModels pStandardPin, PinModels pNonStandardPin, int pBarDia)
        {
            var lParameters = new string[] { };
            if (pShapeParam.shapeParameters != null)
            {
                lParameters = pShapeParam.shapeParameters.Split(',');
            }

            var lParType = new string[] { };
            if (pShapeParam.shapeParameters != null)
            {
                lParType = pShapeParam.shapeParameters.Split(',');
            }

            if (lParameters.Length > 0 && pShapeParam.shapeParameters != "A")
            {
                for (int i = 0; i < lParameters.Length; i++)
                {
                    if (lParameters[i] == "A" && lParType[i] == "S" && pItem.A != null && pItem.A < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "B" && lParType[i] == "S" && pItem.B != null && pItem.B < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "C" && lParType[i] == "S" && pItem.C != null && pItem.C < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "D" && lParType[i] == "S" && pItem.D != null && pItem.D < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "E" && lParType[i] == "S" && pItem.E != null && pItem.E < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "F" && lParType[i] == "S" && pItem.F != null && pItem.F < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "G" && lParType[i] == "S" && pItem.G != null && pItem.G < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "H" && lParType[i] == "S" && pItem.H != null && pItem.H < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "I" && lParType[i] == "S" && pItem.I != null && pItem.I < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "J" && lParType[i] == "S" && pItem.J != null && pItem.J < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "K" && lParType[i] == "S" && pItem.K != null && pItem.K < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "L" && lParType[i] == "S" && pItem.L != null && pItem.L < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "M" && lParType[i] == "S" && pItem.M != null && pItem.M < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "N" && lParType[i] == "S" && pItem.N != null && pItem.N < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "O" && lParType[i] == "S" && pItem.O != null && pItem.O < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "P" && lParType[i] == "S" && pItem.P != null && pItem.P < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Q" && lParType[i] == "S" && pItem.Q != null && pItem.Q < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "R" && lParType[i] == "S" && pItem.R != null && pItem.R < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "S" && lParType[i] == "S" && pItem.S != null && pItem.S < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "T" && lParType[i] == "S" && pItem.T != null && pItem.T < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "U" && lParType[i] == "S" && pItem.U != null && pItem.U < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "V" && lParType[i] == "S" && pItem.V != null && pItem.V < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "W" && lParType[i] == "S" && pItem.W != null && pItem.W < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "X" && lParType[i] == "S" && pItem.X != null && pItem.X < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Y" && lParType[i] == "S" && pItem.Y != null && pItem.Y < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Z" && lParType[i] == "S" && pItem.Z != null && pItem.Z < pStandardPin.bend_len_min) pItem.PinSize = pNonStandardPin.pin;

                    if (lParameters[i] == "A" && lParType[i] == "R" && pItem.A != null && pItem.A < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "B" && lParType[i] == "R" && pItem.B != null && pItem.B < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "C" && lParType[i] == "R" && pItem.C != null && pItem.C < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "D" && lParType[i] == "R" && pItem.D != null && pItem.D < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "E" && lParType[i] == "R" && pItem.E != null && pItem.E < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "F" && lParType[i] == "R" && pItem.F != null && pItem.F < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "G" && lParType[i] == "R" && pItem.G != null && pItem.G < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "H" && lParType[i] == "R" && pItem.H != null && pItem.H < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "I" && lParType[i] == "R" && pItem.I != null && pItem.I < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "J" && lParType[i] == "R" && pItem.J != null && pItem.J < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "K" && lParType[i] == "R" && pItem.K != null && pItem.K < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "L" && lParType[i] == "R" && pItem.L != null && pItem.L < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "M" && lParType[i] == "R" && pItem.M != null && pItem.M < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "N" && lParType[i] == "R" && pItem.N != null && pItem.N < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "O" && lParType[i] == "R" && pItem.O != null && pItem.O < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "P" && lParType[i] == "R" && pItem.P != null && pItem.P < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Q" && lParType[i] == "R" && pItem.Q != null && pItem.Q < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "R" && lParType[i] == "R" && pItem.R != null && pItem.R < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "S" && lParType[i] == "R" && pItem.S != null && pItem.S < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "T" && lParType[i] == "R" && pItem.T != null && pItem.T < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "U" && lParType[i] == "R" && pItem.U != null && pItem.U < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "V" && lParType[i] == "R" && pItem.V != null && pItem.V < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "W" && lParType[i] == "R" && pItem.W != null && pItem.W < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "X" && lParType[i] == "R" && pItem.X != null && pItem.X < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Y" && lParType[i] == "R" && pItem.Y != null && pItem.Y < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;
                    if (lParameters[i] == "Z" && lParType[i] == "R" && pItem.Z != null && pItem.Z < pStandardPin.hook_height_min) pItem.PinSize = pNonStandardPin.pin;

                    //Check first hook length
                    if (i == 0 && lParameters.Length > 1)
                    {
                        if (lParameters[i] == "A" && lParType[i] == "S" && lParType[i + 1] == "R" && pItem.A != null && pItem.A < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                    }

                    //Check last hook length
                    if (lParType[i] == "S" && i > 0 && lParType[i - 1] == "R")
                    {
                        var lFound = 0;
                        if (i + 1 < lParameters.Length)
                        {
                            for (int j = i + 1; j < lParameters.Length; j++)
                            {
                                if (lParType[j] == "S")
                                {
                                    lFound = 1;
                                    break;
                                }
                            }
                        }
                        if (lFound == 0 && lParameters[i] == "A" && pItem.A != null && pItem.A < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "B" && pItem.B != null && pItem.B < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "C" && pItem.C != null && pItem.C < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "D" && pItem.D != null && pItem.D < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "E" && pItem.E != null && pItem.E < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "F" && pItem.F != null && pItem.F < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "G" && pItem.G != null && pItem.G < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "H" && pItem.H != null && pItem.H < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "I" && pItem.I != null && pItem.I < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "J" && pItem.J != null && pItem.J < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "K" && pItem.K != null && pItem.K < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "L" && pItem.L != null && pItem.L < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "M" && pItem.M != null && pItem.M < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "N" && pItem.N != null && pItem.N < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "O" && pItem.O != null && pItem.O < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "P" && pItem.P != null && pItem.P < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "Q" && pItem.Q != null && pItem.Q < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "R" && pItem.R != null && pItem.R < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "S" && pItem.S != null && pItem.S < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "T" && pItem.T != null && pItem.T < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "U" && pItem.U != null && pItem.U < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "V" && pItem.V != null && pItem.V < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "W" && pItem.W != null && pItem.W < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "X" && pItem.X != null && pItem.X < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "Y" && pItem.Y != null && pItem.Y < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                        if (lFound == 0 && lParameters[i] == "Z" && pItem.Z != null && pItem.Z < pStandardPin.hook_len_min) pItem.PinSize = pNonStandardPin.pin;
                    }
                }
            }
        }

        string calTotalLen(OrderDetailsModels pItem, string pshapeLengthFormula)
        {
            var lItem = pItem;
            var lF = pshapeLengthFormula;
            var lResult = "0";
            var lVarMax = 0;
            var lVarMin = 0;
            if (lF != "")
            {
                if (lF.IndexOf("A") >= 0) if (lItem.A != null) lF = lF.Replace("A", getVarMaxValue(lItem.A.ToString()).ToString()); else lF = lF.Replace("A", "0");
                if (lF.IndexOf("B") >= 0) if (lItem.B != null) lF = lF.Replace("B", getVarMaxValue(lItem.B.ToString()).ToString()); else lF = lF.Replace("B", "0");
                if (lF.IndexOf("C") >= 0) if (lItem.C != null) lF = lF.Replace("C", getVarMaxValue(lItem.C.ToString()).ToString()); else lF = lF.Replace("C", "0");
                if (lF.IndexOf("D") >= 0) if (lItem.D != null) lF = lF.Replace("D", getVarMaxValue(lItem.D.ToString()).ToString()); else lF = lF.Replace("D", "0");
                if (lF.IndexOf("E") >= 0) if (lItem.E != null) lF = lF.Replace("E", getVarMaxValue(lItem.E.ToString()).ToString()); else lF = lF.Replace("E", "0");
                if (lF.IndexOf("F") >= 0) if (lItem.F != null) lF = lF.Replace("F", getVarMaxValue(lItem.F.ToString()).ToString()); else lF = lF.Replace("F", "0");
                if (lF.IndexOf("G") >= 0) if (lItem.G != null) lF = lF.Replace("G", getVarMaxValue(lItem.G.ToString()).ToString()); else lF = lF.Replace("G", "0");
                if (lF.IndexOf("H") >= 0) if (lItem.H != null) lF = lF.Replace("H", getVarMaxValue(lItem.H.ToString()).ToString()); else lF = lF.Replace("H", "0");
                if (lF.IndexOf("I") >= 0) if (lItem.I != null) lF = lF.Replace("I", getVarMaxValue(lItem.I.ToString()).ToString()); else lF = lF.Replace("I", "0");
                if (lF.IndexOf("J") >= 0) if (lItem.J != null) lF = lF.Replace("J", getVarMaxValue(lItem.J.ToString()).ToString()); else lF = lF.Replace("J", "0");
                if (lF.IndexOf("K") >= 0) if (lItem.K != null) lF = lF.Replace("K", getVarMaxValue(lItem.K.ToString()).ToString()); else lF = lF.Replace("K", "0");
                if (lF.IndexOf("L") >= 0) if (lItem.L != null) lF = lF.Replace("L", getVarMaxValue(lItem.L.ToString()).ToString()); else lF = lF.Replace("L", "0");
                if (lF.IndexOf("M") >= 0) if (lItem.M != null) lF = lF.Replace("M", getVarMaxValue(lItem.M.ToString()).ToString()); else lF = lF.Replace("M", "0");
                if (lF.IndexOf("N") >= 0) if (lItem.N != null) lF = lF.Replace("N", getVarMaxValue(lItem.N.ToString()).ToString()); else lF = lF.Replace("N", "0");
                if (lF.IndexOf("O") >= 0) if (lItem.O != null) lF = lF.Replace("O", getVarMaxValue(lItem.O.ToString()).ToString()); else lF = lF.Replace("O", "0");
                if (lF.IndexOf("P") >= 0) if (lItem.P != null) lF = lF.Replace("P", getVarMaxValue(lItem.P.ToString()).ToString()); else lF = lF.Replace("P", "0");
                if (lF.IndexOf("Q") >= 0) if (lItem.Q != null) lF = lF.Replace("Q", getVarMaxValue(lItem.Q.ToString()).ToString()); else lF = lF.Replace("Q", "0");
                if (lF.IndexOf("R") >= 0) if (lItem.R != null) lF = lF.Replace("R", getVarMaxValue(lItem.R.ToString()).ToString()); else lF = lF.Replace("R", "0");
                if (lF.IndexOf("S") >= 0) if (lItem.S != null) lF = lF.Replace("S", getVarMaxValue(lItem.S.ToString()).ToString()); else lF = lF.Replace("S", "0");
                if (lF.IndexOf("T") >= 0) if (lItem.T != null) lF = lF.Replace("T", getVarMaxValue(lItem.T.ToString()).ToString()); else lF = lF.Replace("T", "0");
                if (lF.IndexOf("U") >= 0) if (lItem.U != null) lF = lF.Replace("U", getVarMaxValue(lItem.U.ToString()).ToString()); else lF = lF.Replace("U", "0");
                if (lF.IndexOf("V") >= 0) if (lItem.V != null) lF = lF.Replace("V", getVarMaxValue(lItem.V.ToString()).ToString()); else lF = lF.Replace("V", "0");
                if (lF.IndexOf("W") >= 0) if (lItem.W != null) lF = lF.Replace("W", getVarMaxValue(lItem.W.ToString()).ToString()); else lF = lF.Replace("W", "0");
                if (lF.IndexOf("X") >= 0) if (lItem.X != null) lF = lF.Replace("X", getVarMaxValue(lItem.X.ToString()).ToString()); else lF = lF.Replace("X", "0");
                if (lF.IndexOf("Y") >= 0) if (lItem.Y != null) lF = lF.Replace("Y", getVarMaxValue(lItem.Y.ToString()).ToString()); else lF = lF.Replace("Y", "0");
                if (lF.IndexOf("Z") >= 0) if (lItem.Z != null) lF = lF.Replace("Z", getVarMaxValue(lItem.Z.ToString()).ToString()); else lF = lF.Replace("Z", "0");
                if (lF.IndexOf("math") >= 0)
                {
                    lF = lF.Replace("math.", "");
                }
                if (lF.IndexOf("PI") >= 0)
                {
                    lF = lF.Replace("PI", "3.14159");
                }
                if (lF.IndexOf("Pi") >= 0)
                {
                    lF = lF.Replace("Pi", "3.14159");
                }
                if (lF.IndexOf("pI") >= 0)
                {
                    lF = lF.Replace("pI", "3.14159");
                }
                if (lF.IndexOf("pi") >= 0)
                {
                    lF = lF.Replace("pi", "3.14159");
                }
                if (lF.IndexOf("sqrt") >= 0)
                {
                    lF = lF.Replace("sqrt", "Sqrt");
                }

                if (lF.IndexOf("sin") >= 0)
                {
                    lF = lF.Replace("sin", "Sin");
                }

                if (lF.IndexOf("cos") >= 0)
                {
                    lF = lF.Replace("cos", "Cos");
                }

                if (lF.IndexOf("max") >= 0)
                {
                    lF = lF.Replace("max", "Max");
                }

                if (lF.IndexOf("min") >= 0)
                {
                    lF = lF.Replace("min", "Min");
                }
                Expression lExp = new Expression(lF);

                if (!lExp.HasErrors())
                {
                    var lSResult = lExp.Evaluate().ToString();
                    if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                    int.TryParse(lSResult, out lVarMax);
                }

                lF = pshapeLengthFormula;
                if (lF.IndexOf("A") >= 0) if (lItem.A2 != null && lItem.A2 > 0) lF = lF.Replace("A", getVarMinValue(lItem.A2.ToString()).ToString()); else if (lItem.A != null) lF = lF.Replace("A", getVarMinValue(lItem.A.ToString()).ToString()); else lF = lF.Replace("A", "0");
                if (lF.IndexOf("B") >= 0) if (lItem.B2 != null && lItem.B2 > 0) lF = lF.Replace("B", getVarMinValue(lItem.B2.ToString()).ToString()); else if (lItem.B != null) lF = lF.Replace("B", getVarMinValue(lItem.B.ToString()).ToString()); else lF = lF.Replace("B", "0");
                if (lF.IndexOf("C") >= 0) if (lItem.C2 != null && lItem.C2 > 0) lF = lF.Replace("C", getVarMinValue(lItem.C2.ToString()).ToString()); else if (lItem.C != null) lF = lF.Replace("C", getVarMinValue(lItem.C.ToString()).ToString()); else lF = lF.Replace("C", "0");
                if (lF.IndexOf("D") >= 0) if (lItem.D2 != null && lItem.D2 > 0) lF = lF.Replace("D", getVarMinValue(lItem.D2.ToString()).ToString()); else if (lItem.D != null) lF = lF.Replace("D", getVarMinValue(lItem.D.ToString()).ToString()); else lF = lF.Replace("D", "0");
                if (lF.IndexOf("E") >= 0) if (lItem.E2 != null && lItem.E2 > 0) lF = lF.Replace("E", getVarMinValue(lItem.E2.ToString()).ToString()); else if (lItem.E != null) lF = lF.Replace("E", getVarMinValue(lItem.E.ToString()).ToString()); else lF = lF.Replace("E", "0");
                if (lF.IndexOf("F") >= 0) if (lItem.F2 != null && lItem.F2 > 0) lF = lF.Replace("F", getVarMinValue(lItem.F2.ToString()).ToString()); else if (lItem.F != null) lF = lF.Replace("F", getVarMinValue(lItem.F.ToString()).ToString()); else lF = lF.Replace("F", "0");
                if (lF.IndexOf("G") >= 0) if (lItem.G2 != null && lItem.G2 > 0) lF = lF.Replace("G", getVarMinValue(lItem.G2.ToString()).ToString()); else if (lItem.G != null) lF = lF.Replace("G", getVarMinValue(lItem.G.ToString()).ToString()); else lF = lF.Replace("G", "0");
                if (lF.IndexOf("H") >= 0) if (lItem.H2 != null && lItem.H2 > 0) lF = lF.Replace("H", getVarMinValue(lItem.H2.ToString()).ToString()); else if (lItem.H != null) lF = lF.Replace("H", getVarMinValue(lItem.H.ToString()).ToString()); else lF = lF.Replace("H", "0");
                if (lF.IndexOf("I") >= 0) if (lItem.I2 != null && lItem.I2 > 0) lF = lF.Replace("I", getVarMinValue(lItem.I2.ToString()).ToString()); else if (lItem.I != null) lF = lF.Replace("I", getVarMinValue(lItem.I.ToString()).ToString()); else lF = lF.Replace("I", "0");
                if (lF.IndexOf("J") >= 0) if (lItem.J2 != null && lItem.J2 > 0) lF = lF.Replace("J", getVarMinValue(lItem.J2.ToString()).ToString()); else if (lItem.J != null) lF = lF.Replace("J", getVarMinValue(lItem.J.ToString()).ToString()); else lF = lF.Replace("J", "0");
                if (lF.IndexOf("K") >= 0) if (lItem.K2 != null && lItem.K2 > 0) lF = lF.Replace("K", getVarMinValue(lItem.K2.ToString()).ToString()); else if (lItem.K != null) lF = lF.Replace("K", getVarMinValue(lItem.K.ToString()).ToString()); else lF = lF.Replace("K", "0");
                if (lF.IndexOf("L") >= 0) if (lItem.L2 != null && lItem.L2 > 0) lF = lF.Replace("L", getVarMinValue(lItem.L2.ToString()).ToString()); else if (lItem.L != null) lF = lF.Replace("L", getVarMinValue(lItem.L.ToString()).ToString()); else lF = lF.Replace("L", "0");
                if (lF.IndexOf("M") >= 0) if (lItem.M2 != null && lItem.M2 > 0) lF = lF.Replace("M", getVarMinValue(lItem.M2.ToString()).ToString()); else if (lItem.M != null) lF = lF.Replace("M", getVarMinValue(lItem.M.ToString()).ToString()); else lF = lF.Replace("M", "0");
                if (lF.IndexOf("N") >= 0) if (lItem.N2 != null && lItem.N2 > 0) lF = lF.Replace("N", getVarMinValue(lItem.N2.ToString()).ToString()); else if (lItem.N != null) lF = lF.Replace("N", getVarMinValue(lItem.N.ToString()).ToString()); else lF = lF.Replace("N", "0");
                if (lF.IndexOf("O") >= 0) if (lItem.O2 != null && lItem.O2 > 0) lF = lF.Replace("O", getVarMinValue(lItem.O2.ToString()).ToString()); else if (lItem.O != null) lF = lF.Replace("O", getVarMinValue(lItem.O.ToString()).ToString()); else lF = lF.Replace("O", "0");
                if (lF.IndexOf("P") >= 0) if (lItem.P2 != null && lItem.P2 > 0) lF = lF.Replace("P", getVarMinValue(lItem.P2.ToString()).ToString()); else if (lItem.P != null) lF = lF.Replace("P", getVarMinValue(lItem.P.ToString()).ToString()); else lF = lF.Replace("P", "0");
                if (lF.IndexOf("Q") >= 0) if (lItem.Q2 != null && lItem.Q2 > 0) lF = lF.Replace("Q", getVarMinValue(lItem.Q2.ToString()).ToString()); else if (lItem.Q != null) lF = lF.Replace("Q", getVarMinValue(lItem.Q.ToString()).ToString()); else lF = lF.Replace("Q", "0");
                if (lF.IndexOf("R") >= 0) if (lItem.R2 != null && lItem.R2 > 0) lF = lF.Replace("R", getVarMinValue(lItem.R2.ToString()).ToString()); else if (lItem.R != null) lF = lF.Replace("R", getVarMinValue(lItem.R.ToString()).ToString()); else lF = lF.Replace("R", "0");
                if (lF.IndexOf("S") >= 0) if (lItem.S2 != null && lItem.S2 > 0) lF = lF.Replace("S", getVarMinValue(lItem.S2.ToString()).ToString()); else if (lItem.S != null) lF = lF.Replace("S", getVarMinValue(lItem.S.ToString()).ToString()); else lF = lF.Replace("S", "0");
                if (lF.IndexOf("T") >= 0) if (lItem.T2 != null && lItem.T2 > 0) lF = lF.Replace("T", getVarMinValue(lItem.T2.ToString()).ToString()); else if (lItem.T != null) lF = lF.Replace("T", getVarMinValue(lItem.T.ToString()).ToString()); else lF = lF.Replace("T", "0");
                if (lF.IndexOf("U") >= 0) if (lItem.U2 != null && lItem.U2 > 0) lF = lF.Replace("U", getVarMinValue(lItem.U2.ToString()).ToString()); else if (lItem.U != null) lF = lF.Replace("U", getVarMinValue(lItem.U.ToString()).ToString()); else lF = lF.Replace("U", "0");
                if (lF.IndexOf("V") >= 0) if (lItem.V2 != null && lItem.V2 > 0) lF = lF.Replace("V", getVarMinValue(lItem.V2.ToString()).ToString()); else if (lItem.V != null) lF = lF.Replace("V", getVarMinValue(lItem.V.ToString()).ToString()); else lF = lF.Replace("V", "0");
                if (lF.IndexOf("W") >= 0) if (lItem.W2 != null && lItem.W2 > 0) lF = lF.Replace("W", getVarMinValue(lItem.W2.ToString()).ToString()); else if (lItem.W != null) lF = lF.Replace("W", getVarMinValue(lItem.W.ToString()).ToString()); else lF = lF.Replace("W", "0");
                if (lF.IndexOf("X") >= 0) if (lItem.X2 != null && lItem.X2 > 0) lF = lF.Replace("X", getVarMinValue(lItem.X2.ToString()).ToString()); else if (lItem.X != null) lF = lF.Replace("X", getVarMinValue(lItem.X.ToString()).ToString()); else lF = lF.Replace("X", "0");
                if (lF.IndexOf("Y") >= 0) if (lItem.Y2 != null && lItem.Y2 > 0) lF = lF.Replace("Y", getVarMinValue(lItem.Y2.ToString()).ToString()); else if (lItem.Y != null) lF = lF.Replace("Y", getVarMinValue(lItem.Y.ToString()).ToString()); else lF = lF.Replace("Y", "0");
                if (lF.IndexOf("Z") >= 0) if (lItem.Z2 != null && lItem.Z2 > 0) lF = lF.Replace("Z", getVarMinValue(lItem.Z2.ToString()).ToString()); else if (lItem.Z != null) lF = lF.Replace("Z", getVarMinValue(lItem.Z.ToString()).ToString()); else lF = lF.Replace("Z", "0");

                if (lF.IndexOf("math") >= 0)
                {
                    lF = lF.Replace("math.", "");
                }
                if (lF.IndexOf("PI") >= 0)
                {
                    lF = lF.Replace("PI", "3.14159");
                }
                if (lF.IndexOf("Pi") >= 0)
                {
                    lF = lF.Replace("Pi", "3.14159");
                }
                if (lF.IndexOf("pI") >= 0)
                {
                    lF = lF.Replace("pI", "3.14159");
                }
                if (lF.IndexOf("pi") >= 0)
                {
                    lF = lF.Replace("pi", "3.14159");
                }
                if (lF.IndexOf("sqrt") >= 0)
                {
                    lF = lF.Replace("sqrt", "Sqrt");
                }

                if (lF.IndexOf("sin") >= 0)
                {
                    lF = lF.Replace("sin", "Sin");
                }

                if (lF.IndexOf("cos") >= 0)
                {
                    lF = lF.Replace("cos", "Cos");
                }

                if (lF.IndexOf("max") >= 0)
                {
                    lF = lF.Replace("max", "Max");
                }

                if (lF.IndexOf("min") >= 0)
                {
                    lF = lF.Replace("min", "Min");
                }

                lExp = new Expression(lF);
                if (!lExp.HasErrors())
                {
                    var lSResult = lExp.Evaluate().ToString();
                    if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                    int.TryParse(lSResult, out lVarMin);
                }

                if (lVarMin == lVarMax)
                {
                    lResult = lVarMax.ToString();
                }
                else
                {
                    if (lVarMin == 0 && lVarMax > 0)
                    {
                        lResult = lVarMax.ToString();
                    }
                    else if (lVarMin > 0 && lVarMax == 0)
                    {
                        lResult = lVarMin.ToString();
                    }
                    else
                    {
                        if (lVarMin > lVarMax)
                        {
                            lResult = lVarMax.ToString() + "-" + lVarMin.ToString();
                        }
                        else
                        {
                            lResult = lVarMin.ToString() + "-" + lVarMax.ToString();
                        }
                    }
                }
            }
            return lResult;
        }

        double calWeight(OrderDetailsModels pItem)
        {
            int[] lDia = { 6, 8, 10, 12, 13, 16, 20, 24, 25, 28, 32, 36, 40, 50 };
            double[] lUnitWT = { 0.222, 0.395, 0.617, 0.888, 1.042, 1.579, 2.466, 3.699, 3.854, 4.834, 6.313, 7.769, 9.864, 15.413 };
            double lWeight = 0;
            double lKGM = 0;
            var lBarLength = pItem.BarLength;
            var lBarLength2 = pItem.BarLength2;

            if (pItem.BarTotalQty != null && pItem.BarSize != null && lBarLength != null)
            {
                for (var i = 0; i < lDia.Length; i++)
                {
                    if (pItem.BarSize == lDia[i])
                    {
                        lKGM = lUnitWT[i];
                        break;
                    }
                }
                if (lKGM > 0)
                {
                    if (lBarLength2 != null && lBarLength2 > 0 && lBarLength > 0)
                    {
                        lWeight = Math.Round(lKGM * (double)pItem.BarTotalQty * ((int)lBarLength + (int)lBarLength2) / 2) / 1000;
                    }
                    else
                    {
                        lWeight = Math.Round(lKGM * (int)pItem.BarTotalQty * (int)lBarLength) / 1000;
                    }
                }
            }

            return lWeight;
        }

        double calWeight(int? pBarLength, int? pBarSize, int? pBarTotalQty)
        {
            int[] lDia = { 6, 8, 10, 12, 13, 16, 20, 24, 25, 28, 32, 36, 40, 50 };
            double[] lUnitWT = { 0.222, 0.395, 0.617, 0.888, 1.042, 1.579, 2.466, 3.699, 3.854, 4.834, 6.313, 7.769, 9.864, 15.413 };
            double lWeight = 0;
            double lKGM = 0;

            if (pBarTotalQty != null && pBarSize != null && pBarLength != null && pBarTotalQty > 0 && pBarSize > 0 && pBarLength > 0)
            {
                for (var i = 0; i < lDia.Length; i++)
                {
                    if (pBarSize == lDia[i])
                    {
                        lKGM = lUnitWT[i];
                        break;
                    }
                }
                if (lKGM > 0)
                {
                    lWeight = Math.Round(lKGM * (int)pBarTotalQty * (int)pBarLength) / 1000;
                }
            }

            return lWeight;
        }

        public int ValidTransport(OrderDetailsModels pItem, string pshapeTransportValidator)
        {
            // return 0 -- OK, 1 -- Low Bed, 2 -- Low Bed need police escort
            var lLowBedLimit = 2400;
            var lLowBedEscLimit = 3300;
            var lLowBed = 0;
            var lEscort = 0;
            var lLowBedAnd = 0;
            var lEscortAnd = 0;
            var lItem = pItem;
            var lF = pshapeTransportValidator;
            var lResult = 0;
            if (lF != null && lF != "")
            {
                var lOr = lF.Split(new string[] { "||" }, StringSplitOptions.None);
                for (var i = 0; i < lOr.Length; i++)
                {
                    var lAnd = lOr[i].Split(new string[] { "&&" }, StringSplitOptions.None);
                    lLowBedAnd = 1;
                    lEscortAnd = 1;
                    for (var j = 0; j < lAnd.Length; j++)
                    {
                        if (lAnd[j].IndexOf("A") >= 0) if (lItem.A != null) lAnd[j] = lAnd[j].Replace("A", getVarMaxValue(lItem.A.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("A", "0");
                        if (lAnd[j].IndexOf("B") >= 0) if (lItem.B != null) lAnd[j] = lAnd[j].Replace("B", getVarMaxValue(lItem.B.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("B", "0");
                        if (lAnd[j].IndexOf("C") >= 0) if (lItem.C != null) lAnd[j] = lAnd[j].Replace("C", getVarMaxValue(lItem.C.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("C", "0");
                        if (lAnd[j].IndexOf("D") >= 0) if (lItem.D != null) lAnd[j] = lAnd[j].Replace("D", getVarMaxValue(lItem.D.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("D", "0");
                        if (lAnd[j].IndexOf("E") >= 0) if (lItem.E != null) lAnd[j] = lAnd[j].Replace("E", getVarMaxValue(lItem.E.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("E", "0");
                        if (lAnd[j].IndexOf("F") >= 0) if (lItem.F != null) lAnd[j] = lAnd[j].Replace("F", getVarMaxValue(lItem.F.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("F", "0");
                        if (lAnd[j].IndexOf("G") >= 0) if (lItem.G != null) lAnd[j] = lAnd[j].Replace("G", getVarMaxValue(lItem.G.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("G", "0");
                        if (lAnd[j].IndexOf("H") >= 0) if (lItem.H != null) lAnd[j] = lAnd[j].Replace("H", getVarMaxValue(lItem.H.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("H", "0");
                        if (lAnd[j].IndexOf("I") >= 0) if (lItem.I != null) lAnd[j] = lAnd[j].Replace("I", getVarMaxValue(lItem.I.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("I", "0");
                        if (lAnd[j].IndexOf("J") >= 0) if (lItem.J != null) lAnd[j] = lAnd[j].Replace("J", getVarMaxValue(lItem.J.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("J", "0");
                        if (lAnd[j].IndexOf("K") >= 0) if (lItem.K != null) lAnd[j] = lAnd[j].Replace("K", getVarMaxValue(lItem.K.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("K", "0");
                        if (lAnd[j].IndexOf("L") >= 0) if (lItem.L != null) lAnd[j] = lAnd[j].Replace("L", getVarMaxValue(lItem.L.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("L", "0");
                        if (lAnd[j].IndexOf("M") >= 0) if (lItem.M != null) lAnd[j] = lAnd[j].Replace("M", getVarMaxValue(lItem.M.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("M", "0");
                        if (lAnd[j].IndexOf("N") >= 0) if (lItem.N != null) lAnd[j] = lAnd[j].Replace("N", getVarMaxValue(lItem.N.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("N", "0");
                        if (lAnd[j].IndexOf("O") >= 0) if (lItem.O != null) lAnd[j] = lAnd[j].Replace("O", getVarMaxValue(lItem.O.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("O", "0");
                        if (lAnd[j].IndexOf("P") >= 0) if (lItem.P != null) lAnd[j] = lAnd[j].Replace("P", getVarMaxValue(lItem.P.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("P", "0");
                        if (lAnd[j].IndexOf("Q") >= 0) if (lItem.Q != null) lAnd[j] = lAnd[j].Replace("Q", getVarMaxValue(lItem.Q.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Q", "0");
                        if (lAnd[j].IndexOf("R") >= 0) if (lItem.R != null) lAnd[j] = lAnd[j].Replace("R", getVarMaxValue(lItem.R.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("R", "0");
                        if (lAnd[j].IndexOf("S") >= 0) if (lItem.S != null) lAnd[j] = lAnd[j].Replace("S", getVarMaxValue(lItem.S.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("S", "0");
                        if (lAnd[j].IndexOf("T") >= 0) if (lItem.T != null) lAnd[j] = lAnd[j].Replace("T", getVarMaxValue(lItem.T.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("T", "0");
                        if (lAnd[j].IndexOf("U") >= 0) if (lItem.U != null) lAnd[j] = lAnd[j].Replace("U", getVarMaxValue(lItem.U.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("U", "0");
                        if (lAnd[j].IndexOf("V") >= 0) if (lItem.V != null) lAnd[j] = lAnd[j].Replace("V", getVarMaxValue(lItem.V.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("V", "0");
                        if (lAnd[j].IndexOf("W") >= 0) if (lItem.W != null) lAnd[j] = lAnd[j].Replace("W", getVarMaxValue(lItem.W.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("W", "0");
                        if (lAnd[j].IndexOf("X") >= 0) if (lItem.X != null) lAnd[j] = lAnd[j].Replace("X", getVarMaxValue(lItem.X.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("X", "0");
                        if (lAnd[j].IndexOf("Y") >= 0) if (lItem.Y != null) lAnd[j] = lAnd[j].Replace("Y", getVarMaxValue(lItem.Y.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Y", "0");
                        if (lAnd[j].IndexOf("Z") >= 0) if (lItem.Z != null) lAnd[j] = lAnd[j].Replace("Z", getVarMaxValue(lItem.Z.ToString()).ToString()); else lAnd[j] = lAnd[j].Replace("Z", "0");

                        if (lAnd[j].IndexOf("math.") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("math.", "");
                        }
                        if (lAnd[j].IndexOf("pi") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("pi", "3.14159");
                        }
                        if (lAnd[j].IndexOf("PI") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("PI", "3.14159");
                        }
                        if (lAnd[j].IndexOf("Pi") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("Pi", "3.14159");
                        }
                        if (lAnd[j].IndexOf("pI") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("pI", "3.14159");
                        }

                        if (lAnd[j].IndexOf("sqrt") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("sqrt", "Sqrt");
                        }

                        if (lAnd[j].IndexOf("sin") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("sin", "Sin");
                        }

                        if (lAnd[j].IndexOf("cos") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("cos", "Cos");
                        }

                        if (lAnd[j].IndexOf("max") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("max", "Max");
                        }

                        if (lAnd[j].IndexOf("min") >= 0)
                        {
                            lAnd[j] = lAnd[j].Replace("min", "Min");
                        }

                        Expression lExp = new Expression(lAnd[j]);
                        //lExp.Parameters["A"] = (int)(lItem.A == null ? 0 : lItem.A);
                        //lExp.Parameters["B"] = (int)(lItem.B == null ? 0 : lItem.B);
                        //lExp.Parameters["C"] = (int)(lItem.C == null ? 0 : lItem.C);
                        //lExp.Parameters["D"] = (int)(lItem.D == null ? 0 : lItem.D);
                        //lExp.Parameters["E"] = (int)(lItem.E == null ? 0 : lItem.E);
                        //lExp.Parameters["F"] = (int)(lItem.F == null ? 0 : lItem.F);
                        //lExp.Parameters["G"] = (int)(lItem.G == null ? 0 : lItem.G);
                        //lExp.Parameters["H"] = (int)(lItem.H == null ? 0 : lItem.H);
                        //lExp.Parameters["I"] = (int)(lItem.I == null ? 0 : lItem.I);
                        //lExp.Parameters["J"] = (int)(lItem.J == null ? 0 : lItem.J);
                        //lExp.Parameters["K"] = (int)(lItem.K == null ? 0 : lItem.K);
                        //lExp.Parameters["L"] = (int)(lItem.L == null ? 0 : lItem.L);
                        //lExp.Parameters["M"] = (int)(lItem.M == null ? 0 : lItem.M);
                        //lExp.Parameters["N"] = (int)(lItem.N == null ? 0 : lItem.N);
                        //lExp.Parameters["O"] = (int)(lItem.O == null ? 0 : lItem.O);
                        //lExp.Parameters["P"] = (int)(lItem.P == null ? 0 : lItem.P);
                        //lExp.Parameters["Q"] = (int)(lItem.Q == null ? 0 : lItem.Q);
                        //lExp.Parameters["R"] = (int)(lItem.R == null ? 0 : lItem.R);
                        //lExp.Parameters["S"] = (int)(lItem.S == null ? 0 : lItem.S);
                        //lExp.Parameters["T"] = (int)(lItem.T == null ? 0 : lItem.T);
                        //lExp.Parameters["U"] = (int)(lItem.U == null ? 0 : lItem.U);
                        //lExp.Parameters["V"] = (int)(lItem.V == null ? 0 : lItem.V);
                        //lExp.Parameters["W"] = (int)(lItem.W == null ? 0 : lItem.W);
                        //lExp.Parameters["X"] = (int)(lItem.X == null ? 0 : lItem.X);
                        //lExp.Parameters["Y"] = (int)(lItem.Y == null ? 0 : lItem.Y);
                        //lExp.Parameters["Z"] = (int)(lItem.Z == null ? 0 : lItem.Z);

                        try
                        {
                            if (!lExp.HasErrors())
                            {
                                var lSResult = lExp.Evaluate().ToString();
                                if (lSResult.IndexOf('.') > 0) lSResult = lSResult.Substring(0, lSResult.IndexOf('.'));
                                int.TryParse(lSResult, out lResult);
                            }

                            if (lResult == 0)
                            {
                                lLowBedAnd = 0;
                                lEscortAnd = 0;
                            }
                            else
                            {
                                if (lResult <= lLowBedLimit)
                                {
                                    lLowBedAnd = 0;
                                }
                                if (lResult <= lLowBedEscLimit)
                                {
                                    lEscortAnd = 0;
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            lLowBedAnd = 0;
                            lEscortAnd = 0;
                        }
                    }
                    if (lLowBedAnd == 1)
                    {
                        lLowBed = 1;
                    }
                    if (lEscortAnd == 1)
                    {
                        lEscort = 1;
                    }
                }
            }
            lResult = 0;
            if (lLowBed == 1) lResult = 1;
            if (lEscort == 1) lResult = 2;
            return lResult;
        }

        int getVarMaxValue(string pValue)
        {
            var rValue = 0;
            if (pValue != null)
            {
                if (!int.TryParse(pValue, out rValue))
                {
                    var lVarLen = pValue.Split('-');
                    if (lVarLen.Length == 2)
                    {
                        var lVar1 = 0;
                        var lVar2 = 0;
                        int.TryParse(lVarLen[0], out lVar1);
                        int.TryParse(lVarLen[1], out lVar2);
                        if (lVar1 > lVar2)
                        {
                            rValue = lVar1;
                        }
                        else
                        {
                            rValue = lVar2;
                        }
                    }
                    else
                    {
                        rValue = 0;
                    }
                }
            }
            return rValue;
        }

        int getVarMinValue(string pValue)
        {
            var rValue = 0;
            if (pValue != null)
            {
                if (!int.TryParse(pValue, out rValue))
                {
                    var lVarLen = pValue.Split('-');
                    if (lVarLen.Length == 2)
                    {
                        var lVar1 = 0;
                        var lVar2 = 0;
                        int.TryParse(lVarLen[0], out lVar1);
                        int.TryParse(lVarLen[1], out lVar2);
                        if (lVar1 > lVar2)
                        {
                            rValue = lVar2;
                        }
                        else
                        {
                            rValue = lVar1;
                        }
                    }
                    else
                    {
                        rValue = 0;
                    }
                }
            }
            return rValue;
        }

        string calParamValue(ref OrderDetailsModels pItem, ShapeConfViewModels pShapeParam, string pParamType, string pDefaultValue, string pPinSize, string pDia, string pFormula1, string pFormula2, string pFormula3, string pParameter)
        {
            string lReturn = "";
            if (pFormula1.Length > 0)
            {
                lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula1);
            }
            if (lReturn.Length == 0)
            {
                if (pFormula2.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula2);
                }

            }
            if (lReturn.Length == 0)
            {
                if (pFormula3.Length > 0)
                {
                    lReturn = calFormula(pItem, pShapeParam, pParamType, pDefaultValue, pPinSize, pDia, pFormula3);
                }

            }
            if (lReturn.Length > 0)
            {
                int? lMinVal = getParaValue(lReturn, 1);
                int? lMaxVal = getParaValue(lReturn, 2);
                if (lMinVal > 0)
                {
                    if (pParameter == "A") pItem.A = lMinVal;
                    if (pParameter == "B") pItem.B = lMinVal;
                    if (pParameter == "C") pItem.C = lMinVal;
                    if (pParameter == "D") pItem.D = lMinVal;
                    if (pParameter == "E") pItem.E = lMinVal;
                    if (pParameter == "F") pItem.F = lMinVal;
                    if (pParameter == "G") pItem.G = lMinVal;
                    if (pParameter == "H") pItem.H = lMinVal;
                    if (pParameter == "I") pItem.I = lMinVal;
                    if (pParameter == "J") pItem.J = lMinVal;
                    if (pParameter == "K") pItem.K = lMinVal;
                    if (pParameter == "L") pItem.L = lMinVal;
                    if (pParameter == "M") pItem.M = lMinVal;
                    if (pParameter == "N") pItem.N = lMinVal;
                    if (pParameter == "O") pItem.O = lMinVal;
                    if (pParameter == "P") pItem.P = lMinVal;
                    if (pParameter == "Q") pItem.Q = lMinVal;
                    if (pParameter == "R") pItem.R = lMinVal;
                    if (pParameter == "S") pItem.S = lMinVal;
                    if (pParameter == "T") pItem.T = lMinVal;
                    if (pParameter == "U") pItem.U = lMinVal;
                    if (pParameter == "V") pItem.V = lMinVal;
                    if (pParameter == "W") pItem.W = lMinVal;
                    if (pParameter == "X") pItem.X = lMinVal;
                    if (pParameter == "Y") pItem.Y = lMinVal;
                    if (pParameter == "Z") pItem.Z = lMinVal;
                }
                if (lMaxVal > 0)
                {
                    if (pParameter == "A") pItem.A2 = lMaxVal;
                    if (pParameter == "B") pItem.B2 = lMaxVal;
                    if (pParameter == "C") pItem.C2 = lMaxVal;
                    if (pParameter == "D") pItem.D2 = lMaxVal;
                    if (pParameter == "E") pItem.E2 = lMaxVal;
                    if (pParameter == "F") pItem.F2 = lMaxVal;
                    if (pParameter == "G") pItem.G2 = lMaxVal;
                    if (pParameter == "H") pItem.H2 = lMaxVal;
                    if (pParameter == "I") pItem.I2 = lMaxVal;
                    if (pParameter == "J") pItem.J2 = lMaxVal;
                    if (pParameter == "K") pItem.K2 = lMaxVal;
                    if (pParameter == "L") pItem.L2 = lMaxVal;
                    if (pParameter == "M") pItem.M2 = lMaxVal;
                    if (pParameter == "N") pItem.N2 = lMaxVal;
                    if (pParameter == "O") pItem.O2 = lMaxVal;
                    if (pParameter == "P") pItem.P2 = lMaxVal;
                    if (pParameter == "Q") pItem.Q2 = lMaxVal;
                    if (pParameter == "R") pItem.R2 = lMaxVal;
                    if (pParameter == "S") pItem.S2 = lMaxVal;
                    if (pParameter == "T") pItem.T2 = lMaxVal;
                    if (pParameter == "U") pItem.U2 = lMaxVal;
                    if (pParameter == "V") pItem.V2 = lMaxVal;
                    if (pParameter == "W") pItem.W2 = lMaxVal;
                    if (pParameter == "X") pItem.X2 = lMaxVal;
                    if (pParameter == "Y") pItem.Y2 = lMaxVal;
                    if (pParameter == "Z") pItem.Z2 = lMaxVal;
                }
            }

            return lReturn;
        }


        [HttpPost]
        [Route("/getVarBarDetails")]
        public ActionResult getVarBarDetails([FromBody] VarBarDetailDto orderDetailsListModels)
        {
            var lBarsDetailsList = new List<VarBarDetailDto>();
            OrderDetailsModels orderDetailsModels = new OrderDetailsModels();
            //if (ModelState.IsValid)
            //{
            string lShapeCode = orderDetailsListModels.BarShapeCode;
            if (lShapeCode == null)
            {
                lShapeCode = "";
            }
            if (lShapeCode != "")
            {
                while (lShapeCode.Length < 3)
                {
                    lShapeCode = "0" + lShapeCode;
                }

                orderDetailsListModels.BarShapeCode = lShapeCode;
            }

            if (orderDetailsListModels.CustomerCode == null)
            {
                orderDetailsListModels.CustomerCode = "";
            }
            if (orderDetailsListModels.CustomerCode.Length > 0)
            {
                orderDetailsModels = new OrderDetailsModels
                {
                    CustomerCode = orderDetailsListModels.CustomerCode,
                    ProjectCode = orderDetailsListModels.ProjectCode,
                    JobID = orderDetailsListModels.JobID,
                    BBSID = orderDetailsListModels.BBSID,
                    BarID = orderDetailsListModels.BarID,
                    BarSort = orderDetailsListModels.BarSort,
                    Cancelled = orderDetailsListModels.Cancelled,
                    BarCAB = orderDetailsListModels.BarSTD == true ? false : true,
                    BarSTD = orderDetailsListModels.BarSTD,
                    ElementMark = orderDetailsListModels.ElementMark,
                    BarMark = orderDetailsListModels.BarMark == null ? "" : orderDetailsListModels.BarMark,
                    BarType = orderDetailsListModels.BarType,
                    BarSize = orderDetailsListModels.BarSize == 0 ? null : orderDetailsListModels.BarSize,
                    BarMemberQty = orderDetailsListModels.BarMemberQty == 0 ? null : orderDetailsListModels.BarMemberQty,
                    BarEachQty = orderDetailsListModels.BarEachQty == 0 ? null : orderDetailsListModels.BarEachQty,
                    BarTotalQty = orderDetailsListModels.BarTotalQty == 0 ? null : orderDetailsListModels.BarTotalQty,
                    BarShapeCode = orderDetailsListModels.BarShapeCode,
                    A = getParaValue(orderDetailsListModels.A, 1),
                    B = getParaValue(orderDetailsListModels.B, 1),
                    C = getParaValue(orderDetailsListModels.C, 1),
                    D = getParaValue(orderDetailsListModels.D, 1),
                    E = getParaValue(orderDetailsListModels.E, 1),
                    F = getParaValue(orderDetailsListModels.F, 1),
                    G = getParaValue(orderDetailsListModels.G, 1),
                    H = getParaValue(orderDetailsListModels.H, 1),
                    I = getParaValue(orderDetailsListModels.I, 1),
                    J = getParaValue(orderDetailsListModels.J, 1),
                    K = getParaValue(orderDetailsListModels.K, 1),
                    L = getParaValue(orderDetailsListModels.L, 1),
                    M = getParaValue(orderDetailsListModels.M, 1),
                    N = getParaValue(orderDetailsListModels.N, 1),
                    O = getParaValue(orderDetailsListModels.O, 1),
                    P = getParaValue(orderDetailsListModels.P, 1),
                    Q = getParaValue(orderDetailsListModels.Q, 1),
                    R = getParaValue(orderDetailsListModels.R, 1),
                    S = getParaValue(orderDetailsListModels.S, 1),
                    T = getParaValue(orderDetailsListModels.T, 1),
                    U = getParaValue(orderDetailsListModels.U, 1),
                    V = getParaValue(orderDetailsListModels.V, 1),
                    W = getParaValue(orderDetailsListModels.W, 1),
                    X = getParaValue(orderDetailsListModels.X, 1),
                    Y = getParaValue(orderDetailsListModels.Y, 1),
                    Z = getParaValue(orderDetailsListModels.Z, 1),
                    A2 = getParaValue(orderDetailsListModels.A, 2),
                    B2 = getParaValue(orderDetailsListModels.B, 2),
                    C2 = getParaValue(orderDetailsListModels.C, 2),
                    D2 = getParaValue(orderDetailsListModels.D, 2),
                    E2 = getParaValue(orderDetailsListModels.E, 2),
                    F2 = getParaValue(orderDetailsListModels.F, 2),
                    G2 = getParaValue(orderDetailsListModels.G, 2),
                    H2 = getParaValue(orderDetailsListModels.H, 2),
                    I2 = getParaValue(orderDetailsListModels.I, 2),
                    J2 = getParaValue(orderDetailsListModels.J, 2),
                    K2 = getParaValue(orderDetailsListModels.K, 2),
                    L2 = getParaValue(orderDetailsListModels.L, 2),
                    M2 = getParaValue(orderDetailsListModels.M, 2),
                    N2 = getParaValue(orderDetailsListModels.N, 2),
                    O2 = getParaValue(orderDetailsListModels.O, 2),
                    P2 = getParaValue(orderDetailsListModels.P, 2),
                    Q2 = getParaValue(orderDetailsListModels.Q, 2),
                    R2 = getParaValue(orderDetailsListModels.R, 2),
                    S2 = getParaValue(orderDetailsListModels.S, 2),
                    T2 = getParaValue(orderDetailsListModels.T, 2),
                    U2 = getParaValue(orderDetailsListModels.U, 2),
                    V2 = getParaValue(orderDetailsListModels.V, 2),
                    W2 = getParaValue(orderDetailsListModels.W, 2),
                    X2 = getParaValue(orderDetailsListModels.X, 2),
                    Y2 = getParaValue(orderDetailsListModels.Y, 2),
                    Z2 = getParaValue(orderDetailsListModels.Z, 2),
                    BarLength = getParaValue(orderDetailsListModels.BarLength, 1),
                    BarLength2 = getParaValue(orderDetailsListModels.BarLength, 2),
                    BarWeight = orderDetailsListModels.BarWeight == 0 ? null : orderDetailsListModels.BarWeight,
                    Remarks = orderDetailsListModels.Remarks,
                    shapeTransport = orderDetailsListModels.shapeTransport == 0 ? null : orderDetailsListModels.shapeTransport,
                    PinSize = orderDetailsListModels.PinSize == 0 ? null : orderDetailsListModels.PinSize,
                    UpdateDate = DateTime.Now,
                    UpdateBy = orderDetailsListModels.UpdateBy//User.Identity.GetUserName()
                };

                var lBarIn = new List<OrderDetailsModels>();
                lBarIn.Add(orderDetailsModels);

                var lProcessObj = new ProcessController();
                var lVariantLenBars = lProcessObj.VariantLenProcess(lBarIn);
                lProcessObj = null;

                lBarsDetailsList = new List<VarBarDetailDto>(
                    lVariantLenBars.Select(h => new VarBarDetailDto
                    {
                        CustomerCode = h.CustomerCode,
                        ProjectCode = h.ProjectCode,
                        JobID = h.JobID,
                        BBSID = h.BBSID,
                        BarID = h.BarID,
                        BarSort = h.BarSort,
                        Cancelled = h.Cancelled,
                        ElementMark = h.ElementMark,
                        BarMark = h.BarMark,
                        BarType = h.BarType,
                        BarSize = h.BarSize,
                        BarCAB = h.BarCAB,
                        BarSTD = h.BarSTD == false ? null : h.BarSTD,
                        BarMemberQty = h.BarMemberQty,
                        BarEachQty = h.BarEachQty,
                        BarTotalQty = h.BarTotalQty,
                        BarShapeCode = h.BarShapeCode,
                        A = ((h.A == null) ? null : (h.A > 0 && h.A2 > 0) ? h.A.ToString() + '-' + h.A2.ToString() : h.A.ToString()),
                        B = ((h.B == null) ? null : (h.B > 0 && h.B2 > 0) ? h.B.ToString() + '-' + h.B2.ToString() : h.B.ToString()),
                        C = ((h.C == null) ? null : (h.C > 0 && h.C2 > 0) ? h.C.ToString() + '-' + h.C2.ToString() : h.C.ToString()),
                        D = ((h.D == null) ? null : (h.D > 0 && h.D2 > 0) ? h.D.ToString() + '-' + h.D2.ToString() : h.D.ToString()),
                        E = ((h.E == null) ? null : (h.E > 0 && h.E2 > 0) ? h.E.ToString() + '-' + h.E2.ToString() : h.E.ToString()),
                        F = ((h.F == null) ? null : (h.F > 0 && h.F2 > 0) ? h.F.ToString() + '-' + h.F2.ToString() : h.F.ToString()),
                        G = ((h.G == null) ? null : (h.G > 0 && h.G2 > 0) ? h.G.ToString() + '-' + h.G2.ToString() : h.G.ToString()),
                        H = ((h.H == null) ? null : (h.H > 0 && h.H2 > 0) ? h.H.ToString() + '-' + h.H2.ToString() : h.H.ToString()),
                        I = ((h.I == null) ? null : (h.I > 0 && h.I2 > 0) ? h.I.ToString() + '-' + h.I2.ToString() : h.I.ToString()),
                        J = ((h.J == null) ? null : (h.J > 0 && h.J2 > 0) ? h.J.ToString() + '-' + h.J2.ToString() : h.J.ToString()),
                        K = ((h.K == null) ? null : (h.K > 0 && h.K2 > 0) ? h.K.ToString() + '-' + h.K2.ToString() : h.K.ToString()),
                        L = ((h.L == null) ? null : (h.L > 0 && h.L2 > 0) ? h.L.ToString() + '-' + h.L2.ToString() : h.L.ToString()),
                        M = ((h.M == null) ? null : (h.M > 0 && h.M2 > 0) ? h.M.ToString() + '-' + h.M2.ToString() : h.M.ToString()),
                        N = ((h.N == null) ? null : (h.N > 0 && h.N2 > 0) ? h.N.ToString() + '-' + h.N2.ToString() : h.N.ToString()),
                        O = ((h.O == null) ? null : (h.O > 0 && h.O2 > 0) ? h.O.ToString() + '-' + h.O2.ToString() : h.O.ToString()),
                        P = ((h.P == null) ? null : (h.P > 0 && h.P2 > 0) ? h.P.ToString() + '-' + h.P2.ToString() : h.P.ToString()),
                        Q = ((h.Q == null) ? null : (h.Q > 0 && h.Q2 > 0) ? h.Q.ToString() + '-' + h.Q2.ToString() : h.Q.ToString()),
                        R = ((h.R == null) ? null : (h.R > 0 && h.R2 > 0) ? h.R.ToString() + '-' + h.R2.ToString() : h.R.ToString()),
                        S = ((h.S == null) ? null : (h.S > 0 && h.S2 > 0) ? h.S.ToString() + '-' + h.S2.ToString() : h.S.ToString()),
                        T = ((h.T == null) ? null : (h.T > 0 && h.T2 > 0) ? h.T.ToString() + '-' + h.T2.ToString() : h.T.ToString()),
                        U = ((h.U == null) ? null : (h.U > 0 && h.U2 > 0) ? h.U.ToString() + '-' + h.U2.ToString() : h.U.ToString()),
                        V = ((h.V == null) ? null : (h.V > 0 && h.V2 > 0) ? h.V.ToString() + '-' + h.V2.ToString() : h.V.ToString()),
                        W = ((h.W == null) ? null : (h.W > 0 && h.W2 > 0) ? h.W.ToString() + '-' + h.W2.ToString() : h.W.ToString()),
                        X = ((h.X == null) ? null : (h.X > 0 && h.X2 > 0) ? h.X.ToString() + '-' + h.X2.ToString() : h.X.ToString()),
                        Y = ((h.Y == null) ? null : (h.Y > 0 && h.Y2 > 0) ? h.Y.ToString() + '-' + h.Y2.ToString() : h.Y.ToString()),
                        Z = ((h.Z == null) ? null : (h.Z > 0 && h.Z2 > 0) ? h.Z.ToString() + '-' + h.Z2.ToString() : h.Z.ToString()),
                        BarLength = ((h.BarLength == null) ? null : (h.BarLength > 0 && h.BarLength2 > 0) ? h.BarLength.ToString() + '-' + h.BarLength2.ToString() : h.BarLength.ToString()),
                        BarWeight = h.BarWeight,
                        Remarks = h.Remarks,
                        shapeTransport = h.shapeTransport,
                        PinSize = h.PinSize,
                        UpdateDate = h.UpdateDate
                    })
                    );
                //}
            }
            return Ok(lBarsDetailsList);
        }


        //find the discrepancy report 
        [HttpGet]
        [Route("/printDiscrepancy/{CustomerCode}/{ProjectCode}/{JobID}/{BBSID}")]
        public ActionResult printDiscrepancy(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        {
            Reports service = new Reports();
            int lPage = 0;
            var bPDF = service.rptDiscrepancy(CustomerCode, ProjectCode, JobID, BBSID, ref lPage);
            bPDF = service.rptDiscrepancy(CustomerCode, ProjectCode, JobID, BBSID, ref lPage);
            string fileName = "abc.pdf";

            // Create a MemoryStream from the byte array
            using (MemoryStream memoryStream = new MemoryStream(bPDF))
            {
                HttpResponseMessage response = new HttpResponseMessage(HttpStatusCode.OK);
                response.Content = new StreamContent(memoryStream);
                response.Content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("attachment");
                response.Content.Headers.ContentDisposition.FileName = fileName;
                response.Content.Headers.ContentType = new MediaTypeHeaderValue("application/pdf");

                return File(response.Content.ReadAsByteArrayAsync().Result, "application/pdf");
            }
        }

        [HttpPost]
        [Route("OrderExcelImport")]
        public async Task<ActionResult> OrderExcelImport([FromForm] IFormFile excelImport, string CustomerCode, string ProjectCode, int JobID, string UserName)
        {
            try
            {
                string[] lStruEleList = { "BEAM", "COLUMN", "SLAB", "DWALL", "DRAIN", "PILE", "WALL", "MISC", "SLAB-B", "SLAB-T", "FDN1" };
                string lUserType = "";
                string lTotalWt = "0";

                string lDigiOSPONo = "";
                string lExcelPONo = "";
                string lRetPONo = "";

                var lDigiOSBBSNos = new List<string>();
                var lExcelBBSNos = new List<string>();
                var lRetBBSNo = "";

                if (gUserType != null && gUserType != "")
                {
                    lUserType = gUserType;
                }
                else
                {
                    UserAccessController lUa = new UserAccessController();
                    lUserType = lUa.getUserType(UserName);
                    ViewBag.UserType = lUserType;
                    lUa = null;
                }


                if (excelImport != null && (Path.GetExtension(excelImport.FileName).ToLower() == ".xlsx" || Path.GetExtension(excelImport.FileName).ToLower() == ".xlsm"))
                {
                    MemoryStream lStream = new MemoryStream();
                    await excelImport.CopyToAsync(lStream);
                    ExcelPackage package = new ExcelPackage(lStream);

                    ExcelWorksheet workSheet;
                    // = package.Workbook.Worksheets.FirstOrDefault(f => f.View.TabSelected);
                    DataTable lDataTable = new DataTable();

                    if (Path.GetExtension(excelImport.FileName).ToLower() == ".xlsx" || Path.GetExtension(excelImport.FileName).ToLower() == ".xlsm")
                    {
                        if (package.Workbook.Worksheets.Count > 1)
                        {

                            for (int i = 0; i < package.Workbook.Worksheets.Count; i++)
                            {
                                if (package.Workbook.Worksheets[i].Name == "OrderSummary")
                                {

                                    //delete order
                                    var lOrderDet = (from p in db.OrderDetails
                                                     where p.CustomerCode == CustomerCode &&
                                                     p.ProjectCode == ProjectCode &&
                                                     p.JobID == JobID
                                                     select p);
                                    db.OrderDetails.RemoveRange(lOrderDet);

                                    var lBBSDet = (from p in db.BBS
                                                   where p.CustomerCode == CustomerCode &&
                                                   p.ProjectCode == ProjectCode &&
                                                   p.JobID == JobID
                                                   select p);
                                    if (lBBSDet != null)
                                    {
                                        foreach (var lBBSRec in lBBSDet)
                                        {
                                            if (lBBSRec.BBSNo != null)
                                            {
                                                lDigiOSBBSNos.Add(lBBSRec.BBSNo);
                                            }
                                        }
                                    }
                                    db.BBS.RemoveRange(lBBSDet);
                                    db.SaveChanges();

                                    string lPONo = package.Workbook.Worksheets[i].Cells[8, 3].Text == null ? "" : package.Workbook.Worksheets[i].Cells[8, 3].Text.ToString();
                                    if (lPONo == null)
                                    {
                                        lPONo = "";
                                    }
                                    lExcelPONo = lPONo;
                                    if (lPONo.Length > 35)
                                    {
                                        lPONo = lPONo.Substring(0, 35);
                                    }

                                    string lPODate = package.Workbook.Worksheets[i].Cells[9, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[9, 3].Value.ToString();
                                    string lReqDate = package.Workbook.Worksheets[i].Cells[10, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[10, 3].Value.ToString();
                                    DateTime lPODateDT = DateTime.Now;
                                    DateTime lReqDateDT = DateTime.Now;

                                    DateTime.TryParse(lPODate, out lPODateDT);
                                    DateTime.TryParse(lReqDate, out lReqDateDT);

                                    DateTime? lReqDateDTLast = lReqDateDT;

                                    if (lPODateDT < new DateTime(2000, 1, 1))
                                    {
                                        lPODateDT = DateTime.Now;
                                    }

                                    if (lReqDateDT < new DateTime(2000, 1, 1))
                                    {
                                        lReqDateDTLast = null;
                                    }

                                    lTotalWt = package.Workbook.Worksheets[i].Cells[8, 10].Value == null ? "0" : package.Workbook.Worksheets[i].Cells[8, 10].Value.ToString();

                                    //string lWBS1 = package.Workbook.Worksheets[i].Cells[15, 2].Text.ToString();
                                    //string lWBS2 = package.Workbook.Worksheets[i].Cells[15, 3].Text.ToString();
                                    //string lWBS3 = package.Workbook.Worksheets[i].Cells[15, 4].Text.ToString();

                                    string lWBS1 = "";
                                    string lWBS2 = "";
                                    string lWBS3 = "";

                                    //string lStage = package.Workbook.Worksheets[i].Cells[15, 6].Value.ToString();
                                    string lStage = "TYP";

                                    var oldJobAdvice = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);
                                    if (oldJobAdvice != null)
                                    {
                                        var lNewJob = oldJobAdvice;
                                        //lNewJob.PONumber = lPONo;
                                        //lNewJob.PODate = lPODateDT;
                                        //lNewJob.RequiredDate = lReqDateDTLast;
                                        //lNewJob.WBS1 = lWBS1;
                                        //lNewJob.WBS2 = lWBS2;
                                        //lNewJob.WBS3 = lWBS3;
                                        lNewJob.ProjectStage = lStage;
                                        //lNewJob.Scheduler_Name = package.Workbook.Worksheets[i].Cells[6, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString();
                                        //lNewJob.Scheduler_HP = package.Workbook.Worksheets[i].Cells[6, 5].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString();
                                        //lNewJob.Scheduler_Tel = package.Workbook.Worksheets[i].Cells[6, 8].Value == null ? "" : package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString();
                                        //lNewJob.SiteEngr_Name = package.Workbook.Worksheets[i].Cells[5, 3].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString();
                                        //lNewJob.SiteEngr_HP = package.Workbook.Worksheets[i].Cells[5, 5].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString();
                                        //lNewJob.SiteEngr_Tel = package.Workbook.Worksheets[i].Cells[5, 8].Value == null ? "" : package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString();
                                        lNewJob.UpdateDate = DateTime.Now;
                                        lNewJob.UpdateBy = UserName;//User.Identity.GetUserName();
                                        lNewJob.OrderSource = "UXE";

                                        db.Entry(oldJobAdvice).CurrentValues.SetValues(lNewJob);

                                        db.SaveChanges();
                                    }

                                    //update header and SE
                                    var lOrderSE = (from p in db.OrderProjectSE
                                                    join m in db.OrderProject
                                                   on p.OrderNumber equals m.OrderNumber
                                                    where m.CustomerCode == CustomerCode &&
                                                    m.ProjectCode == ProjectCode &&
                                                    p.CABJobID == JobID
                                                    select new
                                                    {
                                                        p.OrderNumber,
                                                        p.StructureElement,
                                                        p.ProductType,
                                                        p.PONumber,
                                                        p.RequiredDate,
                                                        p.ScheduledProd
                                                    }
                                                    ).ToList();

                                    if (lOrderSE == null || lOrderSE.Count == 0)
                                    {
                                        return Ok(new
                                        {
                                            success = false,
                                            error = true,
                                            message = "Import Error: Cannot find order number"
                                        });

                                    }

                                    var lOrderno = lOrderSE[0].OrderNumber;
                                    var lStrucEle = lOrderSE[0].StructureElement;
                                    var lProdType = lOrderSE[0].ProductType;
                                    string lScheduled = lOrderSE[0].ScheduledProd;

                                    if (lScheduled == null || lScheduled == "")
                                    {
                                        lScheduled = "N";
                                    }

                                    lDigiOSPONo = lOrderSE[0].PONumber;

                                    if (lDigiOSPONo == null || lDigiOSPONo == "")
                                    {
                                        lDigiOSPONo = "";
                                    }

                                    var lOrderHeader = db.OrderProject.Find(lOrderno);
                                    var lNewHeader = lOrderHeader;

                                    //var lOrderHeaderSE = db.OrderProjectSE.Find(lOrderno, lStrucEle, lProdType, lScheduled);
                                    //var lNewSE = lOrderHeaderSE;

                                    lNewHeader.OrderSource = "UXE";
                                    lNewHeader.UpdateDate = DateTime.Now;
                                    lNewHeader.UpdateBy = UserName;//User.Identity.GetUserName();

                                    //if ((lNewHeader.PONumber == null || lNewHeader.PONumber == "")
                                    //    && lPONo != null && lPONo != "")
                                    //{
                                    //    lNewHeader.PONumber = lPONo;
                                    //    lNewSE.PONumber = lPONo;
                                    //}

                                    //if (lNewHeader.PODate == null && lPONo != null)
                                    //{
                                    //    lNewHeader.PODate = lPODateDT;
                                    //    lNewSE.PODate = lPODateDT;
                                    //}

                                    //if (lNewHeader.RequiredDate == null && lReqDateDT != null)
                                    //{
                                    //    lNewHeader.RequiredDate = lReqDateDTLast;
                                    //    lNewSE.RequiredDate = lReqDateDTLast;
                                    //}

                                    //if ((lNewHeader.Scheduler_Name == null || lNewHeader.Scheduler_Name == "")
                                    //    && package.Workbook.Worksheets[i].Cells[6, 3].Text != null 
                                    //    && package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString() != "")
                                    //{
                                    //    lNewHeader.Scheduler_Name = package.Workbook.Worksheets[i].Cells[6, 3].Text.ToString();
                                    //}
                                    //if ((lNewHeader.Scheduler_HP == null || lNewHeader.Scheduler_HP == "")
                                    //    && package.Workbook.Worksheets[i].Cells[6, 5].Text != null
                                    //    && package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString() != "")
                                    //{
                                    //    lNewHeader.Scheduler_HP = package.Workbook.Worksheets[i].Cells[6, 5].Text.ToString();
                                    //}
                                    //if ((lNewHeader.Scheduler_Email == null || lNewHeader.Scheduler_Email == "")
                                    //    && package.Workbook.Worksheets[i].Cells[6, 8].Text != null
                                    //    && package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString() != ""
                                    //    && package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString().IndexOf("@") > 0)
                                    //{
                                    //    lNewHeader.Scheduler_Email = package.Workbook.Worksheets[i].Cells[6, 8].Text.ToString();
                                    //}
                                    //if ((lNewHeader.SiteEngr_Name == null || lNewHeader.SiteEngr_Name == "")
                                    //    && package.Workbook.Worksheets[i].Cells[5, 3].Text != null
                                    //    && package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString() != "")
                                    //{
                                    //    lNewHeader.SiteEngr_Name = package.Workbook.Worksheets[i].Cells[5, 3].Text.ToString();
                                    //}
                                    //if ((lNewHeader.SiteEngr_HP == null || lNewHeader.SiteEngr_HP == "")
                                    //    && package.Workbook.Worksheets[i].Cells[5, 5].Text != null
                                    //    && package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString() != "")
                                    //{
                                    //    lNewHeader.SiteEngr_HP = package.Workbook.Worksheets[i].Cells[5, 5].Text.ToString();
                                    //}
                                    //if ((lNewHeader.SiteEngr_Email == null || lNewHeader.SiteEngr_Email == "")
                                    //    && package.Workbook.Worksheets[i].Cells[5, 8].Text != null
                                    //    && package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString() != "" 
                                    //    && package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString().IndexOf("@") > 0)
                                    //{
                                    //    lNewHeader.SiteEngr_Email = package.Workbook.Worksheets[i].Cells[5, 8].Text.ToString();
                                    //}

                                    db.Entry(lOrderHeader).CurrentValues.SetValues(lNewHeader);

                                    //db.Entry(lOrderHeaderSE).CurrentValues.SetValues(lNewSE);

                                    db.SaveChanges();

                                    int lBBSID = 1;
                                    int lSpace = 0;

                                    for (int j = 1; j < package.Workbook.Worksheets.Count; j++)
                                    {
                                        string lBBS = "";
                                        string lBBSOri = "";
                                        if (package.Workbook.Worksheets[i].Dimension.End.Row >= 18 + j
                                            && package.Workbook.Worksheets[i].Dimension.End.Column >= 2
                                            && package.Workbook.Worksheets[i].Cells[18 + j, 2].Value != null)
                                        {
                                            lBBS = package.Workbook.Worksheets[i].Cells[18 + j, 2].Value.ToString();
                                            if (lBBS == null)
                                            {
                                                lBBS = "";
                                            }
                                            lBBSOri = lBBS;

                                            lBBS = lBBS.Replace(";", "");
                                            lBBS = lBBS.Replace("~", "");
                                            lBBS = lBBS.Replace("!", "");
                                            lBBS = lBBS.Replace("@", "");
                                            lBBS = lBBS.Replace("?", "");
                                            lBBS = lBBS.Replace("'", "");
                                            lBBS = lBBS.Replace("^", "");
                                            lBBS = lBBS.Replace("\\", "");
                                            lBBS = lBBS.Replace("\"", "");
                                            lBBS = lBBS.Replace("|", "");
                                            lBBS = lBBS.Replace(":", "");
                                            lBBS = lBBS.Replace(">", "");
                                            lBBS = lBBS.Replace("<", "");
                                            lBBS = lBBS.Replace("=", "");
                                            lBBS = lBBS.Replace("#", "");
                                            lBBS = lBBS.Replace("+", "");
                                            lBBS = lBBS.Replace("$", "");
                                            lBBS = lBBS.Replace("`", "");
                                            lBBS = lBBS.Replace("%", "");

                                            if (lBBS.Length > 14)
                                            {
                                                lBBS = lBBS.Substring(0, 14);
                                            }
                                            var lBBSDesc = "";
                                            if (package.Workbook.Worksheets[i].Cells[18 + j, 3].Value != null)
                                            {
                                                lBBSDesc = package.Workbook.Worksheets[i].Cells[18 + j, 3].Value.ToString();
                                            }

                                            if (lBBSDesc == null)
                                            {
                                                lBBSDesc = "";
                                            }
                                            lBBSDesc = lBBSDesc.Replace(";", "");
                                            lBBSDesc = lBBSDesc.Replace("~", "");
                                            lBBSDesc = lBBSDesc.Replace("!", "");
                                            lBBSDesc = lBBSDesc.Replace("@", "");
                                            lBBSDesc = lBBSDesc.Replace("?", "");
                                            lBBSDesc = lBBSDesc.Replace("'", "");
                                            lBBSDesc = lBBSDesc.Replace("^", "");
                                            lBBSDesc = lBBSDesc.Replace("\\", "");
                                            lBBSDesc = lBBSDesc.Replace("\"", "");
                                            lBBSDesc = lBBSDesc.Replace("|", "");
                                            lBBSDesc = lBBSDesc.Replace(":", "");
                                            lBBSDesc = lBBSDesc.Replace(">", "");
                                            lBBSDesc = lBBSDesc.Replace("<", "");
                                            lBBSDesc = lBBSDesc.Replace("=", "");
                                            lBBSDesc = lBBSDesc.Replace("#", "");
                                            lBBSDesc = lBBSDesc.Replace("+", "");
                                            lBBSDesc = lBBSDesc.Replace("$", "");
                                            lBBSDesc = lBBSDesc.Replace("`", "");
                                            lBBSDesc = lBBSDesc.Replace("%", "");

                                            if (lBBSDesc.Length > 30)
                                            {
                                                lBBSDesc = lBBSDesc.Substring(0, 30);
                                            }

                                            var lStrEle = lStrucEle;

                                            //if (package.Workbook.Worksheets[i].Cells[18 + j, 8].Value != null)
                                            //{
                                            //    lStrEle = package.Workbook.Worksheets[i].Cells[18 + j, 8].Value.ToString();
                                            //}

                                            //if (!lStruEleList.Contains(lStrEle))
                                            //{
                                            //    lStrEle = "BEAM";
                                            //}

                                            if (lBBSOri != null && lBBSOri != "" && package.Workbook.Worksheets["OrderDetail-" + lBBSOri] != null)
                                            {
                                                workSheet = package.Workbook.Worksheets["OrderDetail-" + lBBSOri];

                                                var lNewBBS = new BBSModels();

                                                var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
                                                if (oldBBS == null)
                                                {
                                                    lNewBBS.CustomerCode = CustomerCode;
                                                    lNewBBS.ProjectCode = ProjectCode;
                                                    lNewBBS.JobID = JobID;
                                                    lNewBBS.BBSID = lBBSID;
                                                    lNewBBS.BBSNo = lBBS;
                                                    lNewBBS.BBSDesc = lBBSDesc;
                                                    lNewBBS.BBSStrucElem = lStrEle;
                                                    lNewBBS.UpdateDate = DateTime.Now;
                                                    lNewBBS.UpdateBy = UserName;//User.Identity.GetUserName();

                                                    db.BBS.Add(lNewBBS);
                                                }
                                                else
                                                {
                                                    lNewBBS = oldBBS;
                                                    lNewBBS.BBSNo = lBBS;
                                                    lNewBBS.BBSDesc = lBBSDesc;
                                                    lNewBBS.BBSStrucElem = lStrEle;
                                                    lNewBBS.UpdateDate = DateTime.Now;
                                                    lNewBBS.UpdateBy = UserName;//User.Identity.GetUserName();

                                                    db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
                                                }
                                                db.SaveChanges();

                                                lExcelBBSNos.Add(lBBSOri);

                                                var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, lBBSID, UserName, workSheet);
                                                lBBSID = lBBSID + 1;

                                            }
                                        }
                                        else
                                        {
                                            lSpace = lSpace + 1;
                                            if (lSpace > 5)
                                            {
                                                break;
                                            }
                                        }
                                        if (j >= 100)
                                        {
                                            break;
                                        }
                                    }

                                    if (lBBSID <= 1)
                                    {
                                        lBBSID = 1;
                                        lSpace = 0;

                                        //for (int j = 1; j <= package.Workbook.Worksheets.Count; j++)
                                        //{
                                        //    string lBBS = "";
                                        //    string lBBSOri = "";
                                        //    if (package.Workbook.Worksheets[j].Name != null
                                        //        && package.Workbook.Worksheets[j].Name.Length >= 12
                                        //        && package.Workbook.Worksheets[j].Name.ToUpper().Trim().Substring(0, 11) == "ORDERDETAIL")
                                        //    {
                                        //        lBBS = package.Workbook.Worksheets[j].Name.ToUpper().Substring(12);
                                        //        if (lBBS == null)
                                        //        {
                                        //            lBBS = "";
                                        //        }
                                        //        lBBSOri = lBBS;
                                        //        if (lBBS.Length > 14)
                                        //        {
                                        //            lBBS = lBBS.Substring(0, 14);
                                        //        }
                                        //        var lBBSDesc = "";

                                        //        var lStrEle = lStrucEle;

                                        //        //if (package.Workbook.Worksheets[i].Cells[18 + j, 8].Value != null)
                                        //        //{
                                        //        //    lStrEle = package.Workbook.Worksheets[i].Cells[18 + j, 8].Value.ToString();
                                        //        //}

                                        //        //if (!lStruEleList.Contains(lStrEle))
                                        //        //{
                                        //        //    lStrEle = "BEAM";
                                        //        //}

                                        //        workSheet = package.Workbook.Worksheets[j];

                                        //        var lNewBBS = new BBSModels();

                                        //        var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);
                                        //        if (oldBBS == null)
                                        //        {
                                        //            lNewBBS.CustomerCode = CustomerCode;
                                        //            lNewBBS.ProjectCode = ProjectCode;
                                        //            lNewBBS.JobID = JobID;
                                        //            lNewBBS.BBSID = lBBSID;
                                        //            lNewBBS.BBSNo = lBBS;
                                        //            lNewBBS.BBSDesc = lBBSDesc;
                                        //            lNewBBS.BBSStrucElem = lStrEle;
                                        //            lNewBBS.UpdateDate = DateTime.Now;
                                        //            lNewBBS.UpdateBy = UserName;//User.Identity.GetUserName();

                                        //            db.BBS.Add(lNewBBS);
                                        //        }
                                        //        else
                                        //        {
                                        //            lNewBBS = oldBBS;
                                        //            lNewBBS.BBSNo = lBBS;
                                        //            lNewBBS.BBSDesc = lBBSDesc;
                                        //            lNewBBS.BBSStrucElem = lStrEle;
                                        //            lNewBBS.UpdateDate = DateTime.Now;
                                        //            lNewBBS.UpdateBy = UserName;//User.Identity.GetUserName();

                                        //            db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
                                        //        }
                                        //        db.SaveChanges();

                                        //        lExcelBBSNos.Add(lBBSOri);

                                        //        var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, lBBSID, UserName, workSheet);
                                        //        lBBSID = lBBSID + 1;

                                        //    }
                                        //    else
                                        //    {
                                        //        lSpace = lSpace + 1;
                                        //        if (lSpace > 30)
                                        //        {
                                        //            break;
                                        //        }
                                        //    }
                                        //    if (j >= 100)
                                        //    {
                                        //        break;
                                        //    }
                                        //}
                                        for (int j = 0; j < package.Workbook.Worksheets.Count; j++)
                                        {
                                            string lBBS = "";
                                            string lBBSOri = "";

                                            if (package.Workbook.Worksheets[j].Name != null
                                                && package.Workbook.Worksheets[j].Name.Length >= 12
                                                && package.Workbook.Worksheets[j].Name.ToUpper().Trim().Substring(0, 11) == "ORDERDETAIL")
                                            {
                                                lBBS = package.Workbook.Worksheets[j].Name.ToUpper().Substring(12) ?? "";
                                                lBBSOri = lBBS;
                                                if (lBBS.Length > 14)
                                                {
                                                    lBBS = lBBS.Substring(0, 14);
                                                }
                                                var lBBSDesc = "";
                                                var lStrEle = lStrucEle;

                                                // Access the worksheet safely
                                                workSheet = package.Workbook.Worksheets[j];

                                                var lNewBBS = new BBSModels();
                                                var oldBBS = db.BBS.Find(CustomerCode, ProjectCode, JobID, lBBSID);

                                                if (oldBBS == null)
                                                {
                                                    lNewBBS.CustomerCode = CustomerCode;
                                                    lNewBBS.ProjectCode = ProjectCode;
                                                    lNewBBS.JobID = JobID;
                                                    lNewBBS.BBSID = lBBSID;
                                                    lNewBBS.BBSNo = lBBS;
                                                    lNewBBS.BBSDesc = lBBSDesc;
                                                    lNewBBS.BBSStrucElem = lStrEle;
                                                    lNewBBS.UpdateDate = DateTime.Now;
                                                    lNewBBS.UpdateBy = UserName;

                                                    db.BBS.Add(lNewBBS);
                                                }
                                                else
                                                {
                                                    lNewBBS = oldBBS;
                                                    lNewBBS.BBSNo = lBBS;
                                                    lNewBBS.BBSDesc = lBBSDesc;
                                                    lNewBBS.BBSStrucElem = lStrEle;
                                                    lNewBBS.UpdateDate = DateTime.Now;
                                                    lNewBBS.UpdateBy = UserName;

                                                    db.Entry(oldBBS).CurrentValues.SetValues(lNewBBS);
                                                }

                                                db.SaveChanges();
                                                lExcelBBSNos.Add(lBBSOri);

                                                var lRtn = await ImportOrderBBS(CustomerCode, ProjectCode, JobID, lBBSID, UserName, workSheet);
                                                lBBSID++;
                                            }
                                            else
                                            {
                                                lSpace++;
                                                if (lSpace > 30) break;
                                            }

                                            if (j >= 100) break;
                                        }


                                    }

                                    checkUpdateBBSWT(CustomerCode, ProjectCode, JobID);

                                    break;
                                }

                            }
                        }
                    }
                }

                if (lDigiOSPONo != "" && lExcelPONo != "" && lDigiOSPONo.ToUpper().Trim() != lExcelPONo.ToUpper().Trim())
                {
                    lRetPONo = lDigiOSPONo + ", " + lExcelPONo;
                }

                if (lDigiOSBBSNos.Count > 0 && lExcelBBSNos.Count > 0)
                {
                    for (int i = 0; i < lExcelBBSNos.Count; i++)
                    {
                        if (i < lDigiOSBBSNos.Count)
                        {
                            if (lDigiOSBBSNos[i] != "" && lExcelBBSNos[i] != "")
                            {
                                if (lDigiOSBBSNos[i].ToUpper().Trim() != lExcelBBSNos[i].ToUpper().Trim() && lDigiOSBBSNos[i] != ("BBS" + JobID.ToString()))
                                {
                                    if (lRetBBSNo == "")
                                    {
                                        lRetBBSNo = "(" + lDigiOSBBSNos[i].ToUpper().Trim() + "," + lExcelBBSNos[i].ToUpper().Trim() + ")";
                                    }
                                    else
                                    {
                                        lRetBBSNo = lRetBBSNo + "<br> (" + lDigiOSBBSNos[i].ToUpper().Trim() + "," + lExcelBBSNos[i].ToUpper().Trim() + ")";
                                    }
                                }
                            }
                        }
                    }
                }

                return Json(new
                {
                    success = true,
                    error = true,
                    message = lTotalWt,
                    pono = lRetPONo,
                    bbsno = lRetBBSNo
                });
            }
            catch (Exception ex)
            {
                return Json(new
                {
                    success = false,
                    error = true,
                    message = "Import Error: " + ex.Message + ex.StackTrace,
                    pono = "",
                    bbsno = ""
                });
            }
        }

        //generate BBS ID
        [HttpGet]
        [Route("setDoubleCapture/{CustomerCode}/{ProjectCode}/{JobID}/{BBSID}")]
        public ActionResult setDoubleCapture(string CustomerCode, string ProjectCode, int JobID, int BBSID)
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            int lSeccess = 0;
            var lErrorMsg = "";
            var lSQL = "";

            lSeccess = 1;

            try
            {

                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    int lFound = 0;
                    lSQL = "SELECT COUNT(*) " +
                    "FROM dbo.OESOrderDetailsDouble " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID = " + JobID.ToString() + " " +
                    "AND BBSID = " + BBSID.ToString() + " ";

                    lCmd = new SqlCommand(lSQL, lNDSCon);
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            lFound = lRst.GetInt32(0);
                        }
                    }
                    lRst.Close();

                    if (lFound > 0)
                    {
                        lSQL = "SELECT * INTO #OESOrderTemp " +
                        "FROM dbo.OESOrderDetailsDouble " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                        lSQL = "DELETE " +
                        "FROM dbo.OESOrderDetailsDouble " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 300;
                        lCmd.ExecuteNonQuery();

                    }

                    lSQL = "INSERT INTO dbo.OESOrderDetailsDouble " +
                    "(CustomerCode " +
                    ", ProjectCode " +
                    ", JobID " +
                    ", BBSID " +
                    ", BarID " +
                    ", BarSort " +
                    ", Cancelled " +
                    ", BarCAB " +
                    ", BarSTD " +
                    ", ElementMark " +
                    ", BarMark " +
                    ", BarType " +
                    ", BarSize " +
                    ", BarMemberQty " +
                    ", BarEachQty " +
                    ", BarTotalQty " +
                    ", BarShapeCode " +
                    ", A " +
                    ", B " +
                    ", C " +
                    ", D " +
                    ", E " +
                    ", F " +
                    ", G " +
                    ", H " +
                    ", I " +
                    ", J " +
                    ", K " +
                    ", L " +
                    ", M " +
                    ", N " +
                    ", O " +
                    ", P " +
                    ", Q " +
                    ", R " +
                    ", S " +
                    ", T " +
                    ", U " +
                    ", V " +
                    ", W " +
                    ", X " +
                    ", Y " +
                    ", Z " +
                    ", A2 " +
                    ", B2 " +
                    ", C2 " +
                    ", D2 " +
                    ", E2 " +
                    ", F2 " +
                    ", G2 " +
                    ", H2 " +
                    ", I2 " +
                    ", J2 " +
                    ", K2 " +
                    ", L2 " +
                    ", M2 " +
                    ", N2 " +
                    ", O2 " +
                    ", P2 " +
                    ", Q2 " +
                    ", R2 " +
                    ", S2 " +
                    ", T2 " +
                    ", U2 " +
                    ", V2 " +
                    ", W2 " +
                    ", X2 " +
                    ", Y2 " +
                    ", Z2 " +
                    ", BarLength " +
                    ", BarLength2 " +
                    ", BarWeight " +
                    ", Remarks " +
                    ", shapeTransport " +
                    ", PinSize " +
                    ", TeklaGUID " +
                    ", PartGUID " +
                    ", UpdateDate " +
                    ", UpdateBy " +
                    ", CreateDate " +
                    ", CreateBy ) " +
                    "SELECT CustomerCode " +
                    ", ProjectCode " +
                    ", JobID " +
                    ", BBSID " +
                    ", BarID " +
                    ", BarSort " +
                    ", Cancelled " +
                    ", BarCAB " +
                    ", BarSTD " +
                    ", ElementMark " +
                    ", BarMark " +
                    ", BarType " +
                    ", BarSize " +
                    ", BarMemberQty " +
                    ", BarEachQty " +
                    ", BarTotalQty " +
                    ", BarShapeCode " +
                    ", A " +
                    ", B " +
                    ", C " +
                    ", D " +
                    ", E " +
                    ", F " +
                    ", G " +
                    ", H " +
                    ", I " +
                    ", J " +
                    ", K " +
                    ", L " +
                    ", M " +
                    ", N " +
                    ", O " +
                    ", P " +
                    ", Q " +
                    ", R " +
                    ", S " +
                    ", T " +
                    ", U " +
                    ", V " +
                    ", W " +
                    ", X " +
                    ", Y " +
                    ", Z " +
                    ", A2 " +
                    ", B2 " +
                    ", C2 " +
                    ", D2 " +
                    ", E2 " +
                    ", F2 " +
                    ", G2 " +
                    ", H2 " +
                    ", I2 " +
                    ", J2 " +
                    ", K2 " +
                    ", L2 " +
                    ", M2 " +
                    ", N2 " +
                    ", O2 " +
                    ", P2 " +
                    ", Q2 " +
                    ", R2 " +
                    ", S2 " +
                    ", T2 " +
                    ", U2 " +
                    ", V2 " +
                    ", W2 " +
                    ", X2 " +
                    ", Y2 " +
                    ", Z2 " +
                    ", BarLength " +
                    ", BarLength2 " +
                    ", BarWeight " +
                    ", Remarks " +
                    ", shapeTransport " +
                    ", PinSize " +
                    ", TeklaGUID " +
                    ", PartGUID " +
                    ", UpdateDate " +
                    ", UpdateBy " +
                    ", CreateDate " +
                    ", CreateBy " +
                    "FROM dbo.OESOrderDetails " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID = " + JobID.ToString() + " " +
                    "AND BBSID = " + BBSID.ToString() + " ";

                    lCmd = new SqlCommand(lSQL, lNDSCon);
                    lCmd.CommandTimeout = 600;
                    lCmd.ExecuteNonQuery();

                    lSQL = "DELETE " +
                    "FROM dbo.OESOrderDetails " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID = " + JobID.ToString() + " " +
                    "AND BBSID = " + BBSID.ToString() + " ";

                    lCmd = new SqlCommand(lSQL, lNDSCon);
                    lCmd.CommandTimeout = 600;
                    lCmd.ExecuteNonQuery();

                    if (lFound > 0)
                    {
                        lSQL = "INSERT INTO dbo.OESOrderDetails " +
                        "(CustomerCode " +
                        ", ProjectCode " +
                        ", JobID " +
                        ", BBSID " +
                        ", BarID " +
                        ", BarSort " +
                        ", Cancelled " +
                        ", BarCAB " +
                        ", BarSTD " +
                        ", ElementMark " +
                        ", BarMark " +
                        ", BarType " +
                        ", BarSize " +
                        ", BarMemberQty " +
                        ", BarEachQty " +
                        ", BarTotalQty " +
                        ", BarShapeCode " +
                        ", A " +
                        ", B " +
                        ", C " +
                        ", D " +
                        ", E " +
                        ", F " +
                        ", G " +
                        ", H " +
                        ", I " +
                        ", J " +
                        ", K " +
                        ", L " +
                        ", M " +
                        ", N " +
                        ", O " +
                        ", P " +
                        ", Q " +
                        ", R " +
                        ", S " +
                        ", T " +
                        ", U " +
                        ", V " +
                        ", W " +
                        ", X " +
                        ", Y " +
                        ", Z " +
                        ", A2 " +
                        ", B2 " +
                        ", C2 " +
                        ", D2 " +
                        ", E2 " +
                        ", F2 " +
                        ", G2 " +
                        ", H2 " +
                        ", I2 " +
                        ", J2 " +
                        ", K2 " +
                        ", L2 " +
                        ", M2 " +
                        ", N2 " +
                        ", O2 " +
                        ", P2 " +
                        ", Q2 " +
                        ", R2 " +
                        ", S2 " +
                        ", T2 " +
                        ", U2 " +
                        ", V2 " +
                        ", W2 " +
                        ", X2 " +
                        ", Y2 " +
                        ", Z2 " +
                        ", BarLength " +
                        ", BarLength2 " +
                        ", BarWeight " +
                        ", Remarks " +
                        ", shapeTransport " +
                        ", PinSize " +
                        ", TeklaGUID " +
                        ", PartGUID " +
                        ", UpdateDate " +
                        ", UpdateBy " +
                        ", CreateDate " +
                        ", CreateBy ) " +
                        "SELECT CustomerCode " +
                        ", ProjectCode " +
                        ", JobID " +
                        ", BBSID " +
                        ", BarID " +
                        ", BarSort " +
                        ", Cancelled " +
                        ", BarCAB " +
                        ", BarSTD " +
                        ", ElementMark " +
                        ", BarMark " +
                        ", BarType " +
                        ", BarSize " +
                        ", BarMemberQty " +
                        ", BarEachQty " +
                        ", BarTotalQty " +
                        ", BarShapeCode " +
                        ", A " +
                        ", B " +
                        ", C " +
                        ", D " +
                        ", E " +
                        ", F " +
                        ", G " +
                        ", H " +
                        ", I " +
                        ", J " +
                        ", K " +
                        ", L " +
                        ", M " +
                        ", N " +
                        ", O " +
                        ", P " +
                        ", Q " +
                        ", R " +
                        ", S " +
                        ", T " +
                        ", U " +
                        ", V " +
                        ", W " +
                        ", X " +
                        ", Y " +
                        ", Z " +
                        ", A2 " +
                        ", B2 " +
                        ", C2 " +
                        ", D2 " +
                        ", E2 " +
                        ", F2 " +
                        ", G2 " +
                        ", H2 " +
                        ", I2 " +
                        ", J2 " +
                        ", K2 " +
                        ", L2 " +
                        ", M2 " +
                        ", N2 " +
                        ", O2 " +
                        ", P2 " +
                        ", Q2 " +
                        ", R2 " +
                        ", S2 " +
                        ", T2 " +
                        ", U2 " +
                        ", V2 " +
                        ", W2 " +
                        ", X2 " +
                        ", Y2 " +
                        ", Z2 " +
                        ", BarLength " +
                        ", BarLength2 " +
                        ", BarWeight " +
                        ", Remarks " +
                        ", shapeTransport " +
                        ", PinSize " +
                        ", TeklaGUID " +
                        ", PartGUID " +
                        ", UpdateDate " +
                        ", UpdateBy " +
                        ", CreateDate " +
                        ", CreateBy " +
                        "FROM #OESOrderTemp " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " ";

                        lCmd = new SqlCommand(lSQL, lNDSCon);
                        lCmd.CommandTimeout = 600;
                        lCmd.ExecuteNonQuery();
                    }

                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }


            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
                lSeccess = -1;
            }
            return Json(lSeccess);
        }


        [HttpGet]
        //[ValidateAntiForgeryHeader]
        [Route("/deleteBarDetails/{CustomerCode}/{ProjectCode}/{JobID}/{BBSID}/{BarID}/{UserName}")]
        public ActionResult deleteBarDetails(string CustomerCode, string ProjectCode, int JobID, int BBSID, int BarID, string UserName)
        {
            bool lSuccess = true;
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            string lErrorMsg = "";
            string lSQL = "";

            try
            {
                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon) == true)
                {
                    var lStatus = "";

                    lSQL = "SELECT isNull(OrderStatus,'') " +
                    "FROM dbo.OESJobAdvice " +
                    "WHERE CustomerCode = '" + CustomerCode + "' " +
                    "AND ProjectCode = '" + ProjectCode + "' " +
                    "AND JobID = " + JobID.ToString() + " ";

                    lCmd.Connection = lNDSCon;
                    lCmd.CommandText = lSQL;
                    lCmd.CommandTimeout = 1200;
                    lRst = lCmd.ExecuteReader();
                    if (lRst.HasRows)
                    {
                        lRst.Read();
                        lStatus = lRst.GetString(0);
                    }
                    lRst.Close();

                    if (lStatus == "Created" || lStatus == "Created*" || lStatus == "Reserved" || lStatus == "Sent" || lStatus == "New" || lStatus == "")
                    {
                        string lUpdatedBy = "";
                        lSQL = "SELECT isnull(MIN(UpdateBy), '') " +
                        "FROM dbo.OESOrderDetails " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " " +
                        "AND UpdateDate >= DateAdd(ss,-60,getDate()) " +
                        "AND UpdateBy <> '" + UserName + "' ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandText = lSQL;
                        lCmd.CommandTimeout = 1200;
                        lRst = lCmd.ExecuteReader();
                        if (lRst.HasRows)
                        {
                            lRst.Read();
                            lUpdatedBy = lRst.GetString(0).Trim();
                        }
                        lRst.Close();

                        if (lUpdatedBy != "")
                        {
                            lProcessObj.CloseNDSConnection(ref lNDSCon);
                            lSuccess = false;
                            lErrorMsg = " " + lUpdatedBy + " is updating the BBS. Please contact him/her for details. ";
                            return Json(new { success = lSuccess, ErrorMessage = lErrorMsg });
                        }

                        //for userid recording purpose in trigger
                        lSQL = "UPDATE dbo.OESOrderDetails " +
                        "SET PartGUID = '" + UserName + "' " +
                        "WHERE CustomerCode = '" + CustomerCode + "' " +
                        "AND ProjectCode = '" + ProjectCode + "' " +
                        "AND JobID = " + JobID.ToString() + " " +
                        "AND BBSID = " + BBSID.ToString() + " " +
                        "AND BarID = " + BarID.ToString() + " ";

                        lCmd.Connection = lNDSCon;
                        lCmd.CommandText = lSQL;
                        lCmd.CommandTimeout = 1200;
                        lCmd.ExecuteNonQuery();

                        var oldBar = db.OrderDetails.Find(CustomerCode, ProjectCode, JobID, BBSID, BarID);
                        if (oldBar != null)
                        {
                            db.OrderDetails.Remove(oldBar);
                            var lRtn = db.SaveChanges();
                        }
                    }
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }
                lProcessObj = null;
            }
            catch (Exception e)
            {
                lSuccess = false;
                lErrorMsg = e.Message;
            }
            return Json(new { success = lSuccess, ErrorMessage = lErrorMsg });
            //return RedirectToAction("Index");
        }

        [HttpGet]
        [Route("/checkDoubleEntry/{CustomerCode}/{ProjectCode}/{JobID}/{UserName}")]
        public ActionResult checkDoubleEntry(string CustomerCode, string ProjectCode, int JobID, string UserName)
        {
            var lErrorMsg = "";
            bool lReturn = true;
            try
            {
                var lUserName = UserName;
                UserAccessController lUa = new UserAccessController();
                var lUserType = lUa.getUserType(lUserName);
                int lPMDOnly = 1;
                var lUserEnterType = "";

                var lJobAdv = db.JobAdvice.Find(CustomerCode, ProjectCode, JobID);

                var lBBS = (from p in db.BBS
                            where p.CustomerCode == CustomerCode &&
                            p.ProjectCode == ProjectCode &&
                            p.JobID == JobID
                            orderby p.BBSID
                            select p).ToList();
                if (lBBS != null && lBBS.Count > 0)
                {
                    for (int j = 0; j < lBBS.Count; j++)
                    {
                        int BBSID = lBBS[j].BBSID;
                        var lUpdatedBy = (from p in db.OrderDetails
                                          where p.CustomerCode == CustomerCode &&
                                          p.ProjectCode == ProjectCode &&
                                          p.JobID == JobID &&
                                          p.BBSID == BBSID &&
                                          p.Cancelled == null &&
                                          ((p.BarShapeCode != null &&
                                          p.BarShapeCode != "") ||
                                          (p.BarSize != null &&
                                          p.BarSize > 0) ||
                                          (p.BarEachQty != null &&
                                          p.BarEachQty > 0) ||
                                          (p.BarMemberQty != null &&
                                          p.BarMemberQty > 0))
                                          select p.UpdateBy).Distinct().ToList();

                        if (lUpdatedBy.Count > 0)
                        {
                            for (int k = 0; k < lUpdatedBy.Count; k++)
                            {
                                lUserEnterType = lUa.getUserType(lUpdatedBy[k]);

                                if (lUserEnterType != "AD" && lUserEnterType != "PM"
                                && lUserEnterType != "PA" && lUserEnterType != "P1"
                                && lUserEnterType != "P2" && lUserEnterType != "PU"
                                && lUserEnterType != "CU" && lUserEnterType != "TE")
                                {
                                    lPMDOnly = 0;
                                    break;
                                }

                            }
                        }

                        if (lPMDOnly == 0)
                        {
                            break;
                        }
                    }

                    if (lUserName != null && lUserName.IndexOf("@") > 0
                    && lUserName.Split('@')[1].ToUpper() == "NATSTEEL.COM.SG"
                    && lJobAdv != null && lJobAdv.OrderSource != "UXE"
                    && lPMDOnly == 0)
                    {
                        for (int j = 0; j < lBBS.Count; j++)
                        {
                            int lBBSID = lBBS[j].BBSID;
                            var lOrderDetails = (from p in db.OrderDetails
                                                 where p.CustomerCode == CustomerCode &&
                                                 p.ProjectCode == ProjectCode &&
                                                 p.JobID == JobID &&
                                                 p.BBSID == lBBSID &&
                                                 p.Cancelled == null &&
                                                 ((p.BarShapeCode != null &&
                                                 p.BarShapeCode != "") ||
                                                 (p.BarType != null &&
                                                 p.BarType != "") ||
                                                 (p.BarSize != null &&
                                                 p.BarSize > 0) ||
                                                 (p.BarEachQty != null &&
                                                 p.BarEachQty > 0) ||
                                                 (p.BarMemberQty != null &&
                                                 p.BarMemberQty > 0))
                                                 orderby p.BarShapeCode, p.A, p.B, p.C, p.D, p.E, p.F, p.G, p.H, p.I, p.J, p.K, p.L, p.M, p.N, p.O, p.P, p.Q, p.R, p.S, p.T, p.U, p.V, p.W, p.X, p.Y, p.Z, p.BarLength, p.BarType, p.BarSize, p.BarMemberQty, p.BarEachQty, p.BarWeight
                                                 select p).ToList();

                            var lOrderDetailsDBL = (from p in db.OrderDetailsDouble
                                                    where p.CustomerCode == CustomerCode &&
                                                    p.ProjectCode == ProjectCode &&
                                                    p.JobID == JobID &&
                                                    p.BBSID == lBBSID &&
                                                    p.Cancelled == null &&
                                                    ((p.BarShapeCode != null &&
                                                    p.BarShapeCode != "") ||
                                                    (p.BarType != null &&
                                                    p.BarType != "") ||
                                                    (p.BarSize != null &&
                                                    p.BarSize > 0) ||
                                                    (p.BarEachQty != null &&
                                                    p.BarEachQty > 0) ||
                                                    (p.BarMemberQty != null &&
                                                    p.BarMemberQty > 0))
                                                    orderby p.BarShapeCode, p.A, p.B, p.C, p.D, p.E, p.F, p.G, p.H, p.I, p.J, p.K, p.L, p.M, p.N, p.O, p.P, p.Q, p.R, p.S, p.T, p.U, p.V, p.W, p.X, p.Y, p.Z, p.BarLength, p.BarType, p.BarSize, p.BarMemberQty, p.BarEachQty, p.BarWeight
                                                    select p).ToList();

                            if (lOrderDetails.Count > 0 && lOrderDetailsDBL.Count > 0 && lOrderDetails.Count == lOrderDetailsDBL.Count)
                            {
                                var lReport = new Reports();
                                // check if the double capture empty 
                                int lFound = 0;

                                for (int i = 0; i < lOrderDetailsDBL.Count; i++)
                                {
                                    if ((lOrderDetailsDBL[i].BarEachQty != null && lOrderDetailsDBL[i].BarEachQty > 0) ||
                                        (lOrderDetailsDBL[i].BarMemberQty != null && lOrderDetailsDBL[i].BarMemberQty > 0) ||
                                        (lOrderDetailsDBL[i].BarShapeCode != null && lOrderDetailsDBL[i].BarShapeCode != "") ||
                                        (lOrderDetailsDBL[i].BarType != null && lOrderDetailsDBL[i].BarType != "") ||
                                        (lOrderDetailsDBL[i].BarSize != null && lOrderDetailsDBL[i].BarSize > 0))
                                    {
                                        lFound = 1;
                                        break;
                                    }

                                }

                                var lPara = new System.Collections.Generic.List<string>();
                                lPara.Add("A");
                                lPara.Add("B");
                                lPara.Add("C");
                                lPara.Add("D");
                                for (int i = 0; i < lOrderDetails.Count; i++)
                                {
                                    AddParamaters("E", lOrderDetails[i].E, ref lPara);
                                    AddParamaters("F", lOrderDetails[i].F, ref lPara);
                                    AddParamaters("G", lOrderDetails[i].G, ref lPara);
                                    AddParamaters("H", lOrderDetails[i].H, ref lPara);
                                    AddParamaters("I", lOrderDetails[i].I, ref lPara);
                                    AddParamaters("J", lOrderDetails[i].J, ref lPara);
                                    AddParamaters("K", lOrderDetails[i].K, ref lPara);
                                    AddParamaters("L", lOrderDetails[i].L, ref lPara);
                                    AddParamaters("M", lOrderDetails[i].M, ref lPara);
                                    AddParamaters("N", lOrderDetails[i].N, ref lPara);
                                    AddParamaters("O", lOrderDetails[i].O, ref lPara);
                                    AddParamaters("P", lOrderDetails[i].P, ref lPara);
                                    AddParamaters("Q", lOrderDetails[i].Q, ref lPara);
                                    AddParamaters("R", lOrderDetails[i].R, ref lPara);
                                    AddParamaters("S", lOrderDetails[i].S, ref lPara);
                                    AddParamaters("T", lOrderDetails[i].T, ref lPara);
                                    AddParamaters("U", lOrderDetails[i].U, ref lPara);
                                    AddParamaters("V", lOrderDetails[i].V, ref lPara);
                                    AddParamaters("W", lOrderDetails[i].W, ref lPara);
                                    AddParamaters("X", lOrderDetails[i].X, ref lPara);
                                    AddParamaters("Y", lOrderDetails[i].Y, ref lPara);
                                    AddParamaters("Z", lOrderDetails[i].Z, ref lPara);
                                }
                                lPara.Sort();

                                var lParaDBL = new System.Collections.Generic.List<string>();
                                lParaDBL.Add("A");
                                lParaDBL.Add("B");
                                lParaDBL.Add("C");
                                lParaDBL.Add("D");
                                for (int i = 0; i < lOrderDetailsDBL.Count; i++)
                                {
                                    AddParamaters("E", lOrderDetailsDBL[i].E, ref lParaDBL);
                                    AddParamaters("F", lOrderDetailsDBL[i].F, ref lParaDBL);
                                    AddParamaters("G", lOrderDetailsDBL[i].G, ref lParaDBL);
                                    AddParamaters("H", lOrderDetailsDBL[i].H, ref lParaDBL);
                                    AddParamaters("I", lOrderDetailsDBL[i].I, ref lParaDBL);
                                    AddParamaters("J", lOrderDetailsDBL[i].J, ref lParaDBL);
                                    AddParamaters("K", lOrderDetailsDBL[i].K, ref lParaDBL);
                                    AddParamaters("L", lOrderDetailsDBL[i].L, ref lParaDBL);
                                    AddParamaters("M", lOrderDetailsDBL[i].M, ref lParaDBL);
                                    AddParamaters("N", lOrderDetailsDBL[i].N, ref lParaDBL);
                                    AddParamaters("O", lOrderDetailsDBL[i].O, ref lParaDBL);
                                    AddParamaters("P", lOrderDetailsDBL[i].P, ref lParaDBL);
                                    AddParamaters("Q", lOrderDetailsDBL[i].Q, ref lParaDBL);
                                    AddParamaters("R", lOrderDetailsDBL[i].R, ref lParaDBL);
                                    AddParamaters("S", lOrderDetailsDBL[i].S, ref lParaDBL);
                                    AddParamaters("T", lOrderDetailsDBL[i].T, ref lParaDBL);
                                    AddParamaters("U", lOrderDetailsDBL[i].U, ref lParaDBL);
                                    AddParamaters("V", lOrderDetailsDBL[i].V, ref lParaDBL);
                                    AddParamaters("W", lOrderDetailsDBL[i].W, ref lParaDBL);
                                    AddParamaters("X", lOrderDetailsDBL[i].X, ref lParaDBL);
                                    AddParamaters("Y", lOrderDetailsDBL[i].Y, ref lParaDBL);
                                    AddParamaters("Z", lOrderDetailsDBL[i].Z, ref lParaDBL);
                                }
                                lParaDBL.Sort();

                                for (int i = 0; i < lOrderDetails.Count; i++)
                                {
                                    lFound = lReport.checkDiscrepancy(lPara, lOrderDetails[i], lParaDBL, lOrderDetailsDBL[i]);
                                    if (lFound > 0)
                                    {
                                        lReturn = false;
                                        break;
                                    }
                                }
                                lReport = null;
                            }
                            else if (lOrderDetails.Count > 0 && lOrderDetailsDBL.Count > 0 && lOrderDetails.Count != lOrderDetailsDBL.Count)
                            {
                                lReturn = false;
                                lErrorMsg = "Found double capture discrepancy. Please correct the error before Submission. \n\n" +
                                    "(发现双重输入的数据差异, 请更正此错误再提交此订单.)";
                                break;
                            }
                            else if ((lOrderDetails.Count > 0 && lOrderDetailsDBL.Count == 0) || (lOrderDetails.Count == 0 && lOrderDetailsDBL.Count > 0))
                            {
                                lReturn = false;
                                lErrorMsg = "Double capture is compulsory for natSteel users. Please complete the double capture validation. \n\n" +
                                    "(对大众钢铁的用户,双重输入验证是强制的, 请完成双重输入验证再提交此订单.)";
                                break;
                            }

                            if (lReturn == false)
                            {
                                break;
                            }
                        }
                    }
                }
                lUa = null;
            }
            catch (Exception ex)
            {
                lErrorMsg = ex.Message;
                return Json(new { success = lReturn, error = true, message = lErrorMsg });
            }
            return Json(new { success = lReturn, error = false, message = "" });
        }


        [HttpGet]
        [Route("/SBDetails")]
        public ActionResult SBDetails()
        {
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();
            var resultList = new List<Dictionary<string, object>>(); // To store results

            try
            {
                lCmd.CommandText = "select BarType, BarSize, BundlePcs_fr from OESProdCode pc inner join " +
                                   "OESStdProdCode spc on pc.ProdCodeSAP = spc.ProdCode " +
                                   "where prodtype like 'BAR12%' ORDER BY BarType";

                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon))
                {
                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();

                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            var item = new Dictionary<string, object>();
                            item["BarType"] = lRst.IsDBNull(0) ? null : lRst.GetString(0);
                            item["BarSize"] = lRst.IsDBNull(1) ? null : lRst.GetValue(1);
                            item["BundlePcs"] = lRst.IsDBNull(2) ? null : lRst.GetValue(2);

                            resultList.Add(item);
                        }
                    }
                    lRst.Close();
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }

                return Ok(resultList); // Return the collected results
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }

        }

        [HttpGet]
        [Route("/getCouplerTypeHMI/{ContractNo}")]
        public List<string> getCouplerTypeHMI(string ContractNo)
        {
            var CouplerType = "";
            List<string> lReturn = new List<string>();
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            try
            {
                lCmd.CommandText = "SELECT COU_TYPE FROM HMIContractItem WHERE PROD_CLASS_CODE='COU' and CONTRACT_NO='"+ ContractNo + "'";

                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon))
                {
                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();

                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            CouplerType = lRst.IsDBNull(0) ? null : lRst.GetString(0);
                         
                        }
                    }
                    lRst.Close();
                    lProcessObj.CloseNDSConnection(ref lNDSCon);
                }
                if (CouplerType.Contains("03"))
                {
                    lReturn.Add("NSPLICE");
                    lReturn.Add("ESPLICE(S)");
                }
                else
                {
                    if (CouplerType != "" || CouplerType == null)
                    {
                        if (CouplerType.Contains("01"))
                        {
                            lReturn.Add("NSPLICE");
                        }
                        if (CouplerType.Contains("02"))
                        {
                            lReturn.Add("ESPLICE(S)");
                        }
                    }
                }
                return lReturn; // Return the collected results
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

           [HttpGet]
        [Route("/GetSb_Conversion_Status/{CustomerCode}/{ProjectCode}/{JobId}")]
        public IActionResult GetSb_Conversion_Status(string CustomerCode, string ProjectCode, string JobId)
        {
            var CouplerType = "";
            List<string> lReturn = new List<string>();
            var lCmd = new SqlCommand();
            SqlDataReader lRst;
            var lNDSCon = new SqlConnection();

            try
            {

                lCmd.CommandText = @"
SELECT 
    ISNULL(
        STRING_AGG(
            'BarType- ' + Res.BarType + '-' + CAST(Res.BarSize AS VARCHAR),
            '; '
        ),
        'SBConverted'
    ) AS IsSBConverted
FROM (
    SELECT 
        OD.BarType,
        OD.BarSize
    FROM 
        OESOrderDetails OD
    WHERE  
        OD.CustomerCode = @CustomerCode AND  
        OD.ProjectCode = @ProjectCode AND 
        OD.JobID = @JobID AND
        OD.BarShapeCode = '020' AND 
        OD.A = 12000 AND   
        OD.BarSTD IS NULL AND  
        OD.Cancelled IS NULL
    GROUP BY 
        OD.BarType, 
        OD.BarSize
    HAVING 
        SUM(OD.BarWeight) >= 2000 OR  
        SUM(OD.BarTotalQty) >= (
            SELECT 
                BundlePcs_fr 
            FROM 
                OESProdCode  
            WHERE  
                OESProdCode.BarType = OD.BarType AND  
                OESProdCode.BarSize = OD.BarSize AND 
                OESProdCode.BarLength = 12000
        )
) AS Res;
";

                // Add parameters safely
                lCmd.Parameters.AddWithValue("@CustomerCode", CustomerCode);
                lCmd.Parameters.AddWithValue("@ProjectCode", ProjectCode);
                lCmd.Parameters.AddWithValue("@JobID", JobId);
                var result = "";

                var lProcessObj = new ProcessController();
                if (lProcessObj.OpenNDSConnection(ref lNDSCon))
                {
                    lCmd.Connection = lNDSCon;
                    lCmd.CommandTimeout = 300;
                    lRst = lCmd.ExecuteReader();
                   

                    if (lRst.HasRows)
                    {
                        while (lRst.Read())
                        {
                            result = lRst.IsDBNull(0) ? null : lRst.GetString(0);

                        }
                    }
                    lRst.Close();
                    lProcessObj.CloseNDSConnection(ref lNDSCon);

                }


                return Ok(new { status = result });
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }


    }
}
